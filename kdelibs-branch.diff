Index: kate/tests/highlight.ly
===================================================================
--- kate/tests/highlight.ly	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kate/tests/highlight.ly	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -1,333 +1,114 @@
-% lily was here -- automatically converted by etf2ly from entertainer.etf
+% This is a file to test the Lilypond highlighting features of Katepart.
+% This is NOT a valid lilypond file, because it also shows the
+% highlighting of some invalid lilypond constructs!
+% This is a line comment.
 
+%{
+this is a block comment, that can occur inside a line, or across
+multiple lines.
+%}
+
 \header {
-title = "The Entertainer"
-subtitle = "A Rag Tmie Two Step by Scott Joplin" 
-composer = "Scott Joplin"
-year = "1902"
-tagline = "Public domain---converted from freenote ETF  source."
+  title = "Katepart Lilypond syntax highlighting test file"
+  composer = %{"Wilbert Berendsen"%} "Anonymus"
+  poet = "The KDE team"
+  opus = "1"
+  copyright = "Share and enjoy!"
 }
 
-staffAlayerA =  \notes { {
-\voiceOne
-d'''16 e'''16 c'''16 a''16 ~  a''16 b''16 g''8   |
-\oneVoice
-d''16 e''16 c''16 a'16 ~  a'16 b'16 g'8   | 
-d'16 e'16 c'16 a16 ~  a16 b16 a16 aes16   | 
-r4 <f'8 b'8 d''8\> g''8> d'16 \! dis'16   |
-\repeat  "volta" 2 {
-	e'16-\p c''8 e'16 c''8 e'16 c''16 ~    | 
-	c''4 \< ~  c''16 <c''16 e''16 c'''16> <d''16 f''16 d'''16> 
-	<dis''16 fis''16 dis'''16>   |
-	< \! e''16 g''16 e'''16> <c''16 e''16 c'''16> <d''16 f''16 d'''16> 
-	<e''16 g''16 e'''16> ~  <e''16 g''16 e'''16> <b'16 d''16 b''16> 
-	<d''8 f''8 d'''8>   | 
-	<c''4 e''4 c'''4> ~  <c''8 e''8 c'''8> d'16( )dis'16   | 
-	e'16 c''8 e'16 c''8 e'16 c''16 ~    | 
-	c''4 ~  c''8 <a'16 c''16 a''16> <g'16 c''16 g''16>   | 
-	<fis'16 c''16 fis''16> <a'16 a''16> <c''16 c'''16> <e''16 e'''16> ~  
-	<e''16 e'''16> <d''16 d'''16> <c''16 c'''16> <a'16 a''16>   | 
-	<d''4 f''4 d'''4> ~  <d''8 f''8 d'''8> d'16( )dis'16   | 
-	e'16 c''8 e'16 c''8 e'16 c''16 ~    | 
-	c''4 ~  c''16 <c''16 e''16 c'''16> <d''16 f''16 d'''16> 
-	<dis''16 fis''16 dis'''16>   | 
-	<e''16 g''16 e'''16> <c''16 e''16 c'''16> <d''16 f''16 d'''16> 
-	<e''16 g''16 e'''16> ~  <e''16 g''16 e'''16> <b'16 d''16 b''16> 
-	<d''8 f''8 d'''8>   | 
-	<c''4 e''4 c'''4> ~  <c''8 e''8 c'''8> <c''16 c'''16> <d''16 d'''16>   | 
-	<e''16 e'''16> <c''16 c'''16> <d''16 d'''16> <e''16 e'''16> ~  
-	<e''16 e'''16> <c''16 c'''16> <d''16 d'''16> <c''16 c'''16>   | 
-	<e''16 e'''16> <c''16 c'''16> <d''16 d'''16> <e''16 e'''16> ~  
-	<e''16 e'''16> <c''16 c'''16> <d''16 d'''16> <c''16 c'''16>   | 
-	<e''16 g''16 e'''16> <c''16 e''16 c'''16> <d''16 f''16 d'''16> 
-	<e''16 g''16 e'''16> ~  <e''16 g''16 e'''16> <c''16 e''16 c'''16> 
-	<d''8 f''8 d'''8>   |
-}\alternative {
-
-	{ <c''4 e''4 c'''4> ~  <c''8 e''8 \> c'''8> d'16 \! dis'16  } 
-	{ <c''4 e''4 c'''4> ~  <c''16 e''16 c'''16> <e'16 c''16 e''16> 
-	<f'16 d''16 f''16> <fis'16 dis''16 fis''16>    \bar "||:" \break
-	}
+\paper {
+  #(set-paper-size "a4")  % a hash introduces scheme
+  indent = 0              % recognize variable names inside \paper, \layout etc.
+  between-system-space = 3\mm
 }
 
- |
- \repeat "volta" 2 { 
-	<g'8^"Repeat 8va"-\f
-	   e''8 g''8> <a'16 e''16 a''16> <g'16 e''16 g''16> ~  
-	<g'16 e''16 g''16> <e'16 c''16 e''16> <f'16 d''16 f''16> 
-	<fis'16 dis''16 fis''16>   | 
-	<g'8 e''8 g''8> <a'16 e''16 a''16> <g'16 e''16 g''16> ~  
-	<g'16 e''16 g''16> e''16 c''16 g'16   | 
-	a'16 b'16 c''16 d''16 e''16 d''16 c''16 d''16   | 
-	g'16 e''16 f''16 g''16 a''16 g''16 e''16 f''16   | 
-	<g'8 e''8 g''8> <a'16 e''16 a''16> <g'16 e''16 g''16> ~  
-	<g'16 e''16 g''16> <e'16 c''16 e''16> <f'16 d''16 f''16> 
-	<fis'16 dis''16 fis''16>   | 
-	<g'8 e''8 g''8> <a'16 e''16 a''16> <g'16 e''16 g''16> ~  
-	<g'16 e''16 g''16> g''16 a''16 ais''16   | 
-	<d''16 g''16 b''16> <d''8 g''8 b''8> <c''16 fis''16 b''16> ~  
-	<c''16 fis''16 b''16> a''16 <c''16 fis''16> d''16   | 
-	<b'4 g''4> ~  <b'16 g''16> <e'16 c''16 e''16> <f'16 d''16 f''16> 
-	<fis'16 d''16 fis''16>   | 
-	<g'8 e''8 g''8> <a'16 e''16 a''16> <g'16 e''16 g''16> ~  
-	<g'16 e''16 g''16> <e'16 c''16 e''16> <f'16 d''16 f''16> 
-	<fis'16 dis''16 fis''16>   | 
-	<g'8 e''8 g''8> <a'16 e''16 a''16> <g'16 e''16 g''16> ~  
-	<g'16 e''16 g''16> e''16 c''16 g'16   | 
-	a'16 b'16 c''16 d''16 e''16 d''16 c''16 d''16   | 
-	c''4 ~  c''16 g'16 fis'16 g'16   | 
-	c''8 a'16 c''16 ~  c''16 a'16 c''16 a'16   | 
-	g'16 c''16 e''16 g''16 ~  g''16 e''16 c''16 g'16   | 
-	<fis'8 a'8> <fis'8 d''8> <f'16 e''16> <f'8 d''8> <e'16 c''16> ~    | 
-	<e'4 c''4> <e'16 c''16> <e'16 c''16 e''16> <f'16 d''16 f''16> }
-\alternative {
-  {<fis'16 dis''16 fis''16>   |}
-  { <e'4 c''4> ~  <e'8 c''8 \> > d'16(  \! )dis'16
-  \bar "||:" \break
+\layout {
+  \context {
+    \Score
+    \remove Bar_number_engraver   % recognize engraver names
+    \remove "Bar_number_engraver" % also when quoted!
   }
 }
 
-e'16 -\p c''8 e'16 c''8 e'16 c''16 ~    | 
-c''4 ~  c''16 \<  <c''16 e''16 c'''16> <d''16 f''16 d'''16> 
-<\! dis''16 fis''16 dis'''16>   | 
-<e''16-\f g''16 e'''16> <c''16 e''16 c'''16> <d''16 f''16 d'''16> 
-<e''16 g''16 e'''16> ~  <e''16 g''16 e'''16> <b'16 d''16 b''16> 
-<d''8 f''8 d'''8>   | 
-<c''4 e''4 c'''4> ~  <c''8 e''8 c'''8 \> > d'16( \! )dis'16   | 
-e'16 c''8 e'16 c''8 e'16 c''16 ~    | 
-c''4 ~  c''8 <a'16 c''16 a''16> <g'16 c''16 g''16>   | 
-<fis'16 c''16 fis''16> <a'16 a''16> <c''16 c'''16> <e''16 e'''16> ~  
-<e''16 e'''16> <d''16 d'''16> <c''16 c'''16> <a'16 a''16>   | 
-<d''4 f''4 d'''4> ~  <d''8 f''8 d'''8> d'16( )dis'16   | 
-e'16 c''8 e'16 c''8 e'16 c''16 ~    | 
-c''4 ~  c''16 <c''16 e''16 c'''16> <d''16 f''16 d'''16> 
-<dis''16 fis''16 dis'''16>   | 
-<e''16 g''16 e'''16> <c''16 e''16 c'''16> <d''16 f''16 d'''16> 
-<e''16 g''16 e'''16> ~  <e''16 g''16 e'''16> <b'16 d''16 b''16> 
-<d''8 f''8 d'''8>   | 
-<c''4 e''4 c'''4> ~  <c''8 e''8 c'''8> <c''16 c'''16> <d''16 d'''16>   | 
-<e''16 e'''16> <c''16 c'''16> <d''16 d'''16> <e''16 e'''16> ~  
-<e''16 e'''16> <c''16 c'''16> <d''16 d'''16> <c''16 c'''16>   | 
-<e''16 e'''16> <c''16 c'''16> <d''16 d'''16> <e''16 e'''16> ~  
-<e''16 e'''16> <c''16 c'''16> <d''16 d'''16> <c''16 c'''16>   | 
-<e''16 g''16 e'''16> <c''16 e''16 c'''16> <d''16 f''16 d'''16> 
-<e''16 g''16 e'''16> ~  <e''16 g''16 e'''16> <c''16 e''16 c'''16> 
-<d''8 f''8 d'''8>   | 
-<c''4 e''4 c'''4> <c''8 e''8 c'''8> r8   |
-
-\repeat volta 2 {
-	<f''16 a''16> gis''16 <f''8 a''8> ~  <f''8 a''8> <f''8 a''8 c'''8>   |
-	\voiceOne
-	<f''2 bes''2 d'''2>   |
-	\oneVoice
-	<d''16 f''16> e''16 <d''8 f''8> ~  <d''8 f''8> <d''8 f''8 a''8>   |
-		\voiceOne
-	<d''4 g''4 bes''4> ~  <d''8. g''8. bes''8.> g''16   |
-	\oneVoice
-	d''8 g''16 d''16 ~  d''16 g''16 d''8   | 
-	c''4 f''4   | 
-	e''16 gis''16 b''16 e'''16 ~  e'''16 d'''16 b''16 c'''16   | 
-	a''4 bes''4   | 
-	<f''16 a''16> gis''16 <f''8 a''8> ~  <f''8 a''8> <f''8 a''8 c'''8>   |
-	\voiceOne
-	<f''2 bes''2 d'''2>   |
-	\oneVoice
-	<d''16 f''16> e''16 <d''8 f''8> ~  <d''8 f''8> <d''8 f''8 a''8>   |
-	\voiceOne
-	<d''4 g''4 bes''4> ~  <d''8. g''8. bes''8.> g''16   |
-	\oneVoice
-	d''8 g''16 d''16 ~  d''16 g''16 d''8   | 
-	c''4 \<  <gis'8. b'8. \! f''8.-\sfz \> > \! f''16   | 
-	<a'16-\f c''16 a''16> <c''8 c'''8> <bes'16 g''16> ~
-	% ugh. tieing wrong?
-	\voiceOne
-	 g''16 c''16 d''16 
-	e''16
-	\oneVoice
-	|
-} \alternative {
-	 { <a'8 f''8> b'16( c''16 d''16 e''16 f''16 )g''16   |  }
-	 { <a'8 f''8> r8 <f''8 a''8 c'''8 f'''8> r8   |
-\bar "||:"
-	 }
+% { and << block are folded
+\score {
+  \new StaffGroup <<
+    \new ChordNames \chordmode { c2sus4/f g2/d c1 }
+    \new Staff \new Voice ="mel" {
+      \key f \major
+      \time 4/4
+      \partial 4
+      \set Staff.instrumentName = "Bla."
+      \once \override Staff.NoteHead #'color = #red
+      % dynamics, articulations and markup
+      c8\p d\< e-. f-> g a\f c-5\markup {Hoi}
+      \notemode { c d e f }
+      \repeat volta 2 {
+        % complex durations are highlighted:
+        g4*2/3
+      }
+      \times 2/3 {e8 f g}
+      % there is some error checking:
+      % often made mistake to have octavemarks after the duration:
+      c2'
+      % invalid durations are caught:
+      g3
+    }
+    \context Lyrics \lyricsto "mel" {
+      \set fontSize = #1
+      this is a line of ly -- rics.
+      with4 dur -- a -- tions.2.
+      % errors like forgetting spaces are found:
+      space-- flight %{i.s.o.%} space -- flight
+      space at end for -- got -- ten as well.}
+    
+    \new DrumStaff \drummode { hihat4 bassdrum8 }
+    \new FiguredBass \figuremode {
+      <5 4>8 <6->
+    }
+  >>
+  \midi {
+    \context {
+      \Score
+      tempoWholesPerMinute = #(ly:make-moment 60 2)
+    }
+  }
 }
-\repeat volta 2 {
-c''8 a'16 c''16 ~  c''16 a'16 c''16 a'16   | 
-g'16 c''16 e''16 g''16 ~  g''16 e''16 c''16 g'16   | 
-<fis'8 a'8> <fis'8 c''8> <f'16 e''16> <f'8 d''8> <e'16 c''16> ~    | 
-<e'4 c''4> <c''8 e''8 g''8 c'''8> r8   | 
-<d'8 f'8> <cis'16 e'16> <d'16 f'16> ~  <d'16 f'16> <cis'16 e'16> 
-<d'8 f'8>   | 
-r16 a'16 <f'16 d''16> a'16 c''16 d''16 c''16 a'16   | 
-<e'8 g'8> <dis'16 fis'16> <e'16 g'16> ~  <e'16 g'16> <dis'16 fis'16> 
-<e'8 g'8>   | 
-r16 c''16 <g'16 e''16> c''16 d''16 e''16 d''16 c''16   | 
-<b'8 d''8> <ais'16 cis''16> <b'16 d''16> ~  <b'16 d''16> 
-<ais'16 cis''16> <b'8 d''8>   | 
-r16 f''16 <b'16 a''16> f''16 g''16 a''16 g''16 f''16   | 
-<c''16 c'''16> <c''16 c'''16> <c''4 c'''4> <c''8 a''8>   | 
-<c''8 g''8> <e'16 g'16> <e'16 g'16> <e'8 g'8> <e'8 g'8>   | 
-<d'8 f'8> <cis'16 e'16> <d'16 f'16> ~  <d'16 f'16> <cis'16 e'16> 
-<d'8 f'8>   | 
-r16 a'16 <f'16 d''16> a'16 c''16 d''16 c''16 a'16   | 
-<e'8 g'8> <dis'16 fis'16> <e'16 g'16> ~  <e'16 g'16> <dis'16 fis'16> 
-<e'8 g'8>   | 
-r16 c''16 <g'16 e''16> c''16 d''16 e''16 d''16 c''16   | 
-a'16 gis'16 a'16 <a'16 g''16> ~  <a'16 g''16> <a'8 f''8> <a'16 c''16>   | 
-<g'16 e''16> dis''16 e''16 a''16 ~  a''16 c'''16 g''16 e''16   | 
-<fis'8 c''8> <fis'8 c''8> <f'16 b'16 e''16> <f'8 b'8 d''8> 
-<e'16 g'16 c''16> ~    | }
-\alternative {
-{ <e'8 g'8 c''8> <e'16 g'16> <e'16 g'16> <e'8 g'8> <e'8 g'8>   |  }
-{ <e'4 g'4 c''4> <c''8 e''8 g''8 c'''8> r8   | }
-}
 
- } }
+av = #(define-music-function (parser location voice)
+(string?)
+; scheme comments are recognized in scheme
+; Lilypond inside scheme works as well:
+#{
+  \set associatedVoice = $voice
+#})
 
-staffAlayerB =  \notes { {
-\voiceTwo
-d''16 e''16 c''16 a'16 ~  a'16 b'16 g'8   | 
-} s1*27 {
 
-r8 bes'16 a'16 bes'16 c''16 d''8   | 
-} s2 {
-r8 g'16 fis'16 g'16 a'16 bes'8   | 
-} s2*5 {
-r8 bes'16 a'16 bes'16 c''16 d''8   | 
-} s2 {
-r8 g'16 fis'16 g'16 a'16 bes'8   | 
-} s1 {
-s4 bes'8 bes'8   | 
- } }
 
-staffAglobal = \notes  { \key c \major \time 2/4 \clef "treble" s1*2
-  s2*17
-  s2*33
-  \bar "||"
-\key f \major s2*17
-\key c \major }
+      
+% inside scheme some elements are highlighted:    
+#(define  (naturalise-pitch p)
+  (let* ((o (ly:pitch-octave p))
+         (a (* 4 (ly:pitch-alteration p))) 
+         (n (ly:pitch-notename p)))
+         (bla 'ArticulationEvent 'ChoirStaff)
+    (cond
+     ((> a 2) (set! a (- a 4)) (set! n (+ n 1)))
+     ((< a -2) (set! a (+ a 4)) (set! n (- n 1))))
 
-staffA = \context Staff = staffA <
- \staffAglobal
- \context Voice = VA \staffAlayerA
- \context Voice = VB \staffAlayerB
->
+    (if (< n 0) (begin (set!  o (- o 1)) (set! n (+ n 7))))
+    (if (> n 6) (begin (set!  o (+ o 1)) (set! n (- n 7))))
 
+    (ly:make-pitch o n (/ a 4))))
 
-staffBlayerA =  \notes { { } s2 {
- % FR(6)
-d'16 e'16 c'16 a16 ~  a16 b16 g8   | 
-d16 e16 c16 a,16 ~  a,16 b,16 a,16 aes,16   | 
-<g,8 g8> r8 <g,,8 g,8> <g8 b8>   | 
-c8 <e8 g8 c'8> <g,8 g8> <g8 bes8 c'8>   | 
-<f,8 f8> <a8 c'8> <e,8 e8> <g8 c'8>   | 
-g,8 <e8 g8 c'8> g,8 <f8 g8 b8>   | 
-c8 <e8 g8 c'8> <e8 g8 c'8> <g8 b8>   | 
-c8 <e8 g8 c'8> <g,8 g8> <g8 bes8 c'8>   | 
-<f,8 f8> <a8 c'8> <e,8 e8> <ees,8 ees8>   | 
-<d,8 d8> <d8 fis8 a8 c'8> d8 <fis8 a8 c'8>   | 
-<g8 b8> <g,8 g8> <a,8 a8> <b,8 b8>   | 
-c8 <e8 g8 c'8> <g,8 g8> <g8 bes8 c'8>   | 
-<f,8 f8> <a8 c'8> <e,8 e8> <g8 c'8>   | 
-g,8 <e8 g8 c'8> g,8 <f8 g8 b8>   | 
-c8 <e8 g8 c'8> <g8 c'8 e'8> r8   | 
-<c8 c'8> <g8 c'8 e'8> <bes,8 bes8> <g8 c'8 e'8>   | 
-<a,8 a8> <a8 c'8 f'8> <aes,8 aes8> <aes8 c'8 f'8>   | 
-<g,8 g8> <g8 c'8 e'8> g,8 <g8 b8>   | 
-<c8 g8 c'8> <g,8 g8> <a,8 a8> <b,8 b8>   | 
-<c8 g8 c'8> <g,8 g8> <c,8 c8> s8  | 
-<c,8 c8> <g8 c'8 e'8> g,8 <g8 c'8 e'8>   | 
-c8 <g8 c'8 e'8> g,8 <g8 c'8 e'8>   | 
-f,8 <a8 c'8 f'8> f8 <aes8 c'8 f'8>   | 
-e8 <g8 c'8 e'8> g,8 <g8 c'8 e'8>   | 
-c8 <g8 c'8 e'8> g,8 <g8 c'8 e'8>   | 
-c8 <g8 c'8 e'8> e8 ees8   | 
-d8 <g8 b8 d'8> d8 <a8 c'8 d'8>   | 
-<g8 b8 d'8> <f,8 f8-^> <e,8 e8-^> <d,8 d8-^>   | 
-<c,8 c8> <g8 c'8 e'8> g,8 <g8 c'8 e'8>   | 
-c8 <g8 c'8 e'8> g,8 <g8 c'8 e'8>   | 
-f,8 <a8 c'8 f'8> f8 <aes8 c'8 f'8>   | 
-e8 <g8 c'8 e'8> c8 <bes8 c'8 e'8>   | 
-<f8 a8 c'8 f'8> <f8 a8 c'8 f'8> <fis8 a8 c'8 dis'8> <fis8 a8 c'8 dis'8>   | 
-<g8 c'8 e'8> <g8 c'8 e'8> <g8 c'8 e'8> <g8 c'8 e'8>   | 
-c'8 a8 <g8 b8> <g8 b8>   | 
-<c8 c'8> <g,8 g8> <e,8 e8-^> <d,8 d8-^>   | 
-<c8 c'8> <g,8 g8> <c,8 c8> r8   | 
-c8 <e8 g8 c'8> <g,8 g8> <g8 bes8 c'8>   | 
-<f,8 f8> <a8 c'8> <e,8 e8> <g8 c'8>   | 
-g,8 <e8 g8 c'8> g,8 <f8 g8 b8>   | 
-c8 <e8 g8 c'8> <e8 g8 c'8> <g8 b8>   | 
-c8 <e8 g8 c'8> <g,8 g8> <g8 bes8 c'8>   | 
-<f,8 f8> <a8 c'8> <e,8 e8> <ees,8 ees8>   | 
-<d,8 d8> <d8 fis8 a8 c'8> d8 <fis8 a8 c'8>   | 
-<g8 b8> <g,8 g8> <a,8 a8> <b,8 b8>   | 
-c8 <e8 g8 c'8> <g,8 g8> <g8 bes8 c'8>   | 
-<f,8 f8> <a8 c'8> <e,8 e8> <g8 c'8>   | 
-g,8 <e8 g8 c'8> g,8 <f8 g8 b8>   | 
-c8 <e8 g8 c'8> <g8 c'8 e'8> r8   | 
-<c8 c'8> <g8 c'8 e'8> <bes,8 bes8> <g8 c'8 e'8>   | 
-<a,8 a8> <a8 c'8 f'8> <aes,8 aes8> <aes8 c'8 f'8>   | 
-<g,8 g8> <g8 c'8 e'8> g,8 <g8 b8>   | 
-<c8 g8 c'8> <g,8 g8> <c,8 c8> r8   | 
-f,8 <a8 c'8 f'8> c8 <a8 c'8 f'8>   | 
-bes,8 <bes8 d'8 f'8> f8 <bes8 d'8 f'8>   | 
-d,8 <a8 d'8 f'8> a,8 <a8 d'8 f'8>   | 
-g,8 <bes8 d'8> d8 <bes8 d'8>   | 
-<bes,8 bes8> <bes8 d'8> <g,8 g8> <gis,8 gis8>   | 
-<a,8 a8> <a8 c'8 f'8> d8 <a8 d'8 f'8>   | 
-e8 <b8 d'8 e'8> gis8 <b8 d'8 e'8>   | 
-<a4 c'4 e'4> <g4 c'4 e'4>   | 
-f,8 <a8 c'8 f'8> c8 <a8 c'8 f'8>   | 
-bes,8 <bes8 d'8 f'8> f8 <bes8 d'8 f'8>   | 
-d,8 <a8 d'8 f'8> a,8 <a8 d'8 f'8>   | 
-g,8 <bes8 d'8> d8 <bes8 d'8>   | 
-<bes,8 bes8> <bes8 d'8> <g,8 g8> <gis,8 gis8>   | 
-<a,16 a16> <f,16 f16> <e,16 e16> <d,16 d16> <des,4 des4>   | 
-<c,8 c8> <a8 c'8 f'8> <c8 c'8> <c,8 c8>   | 
-<f,8 f8> r8 r4   | 
-<f,8 f8> r8 <f,,8 f,8> r8   | 
-<f8 a8 c'8 f'8> <f8 a8 c'8 f'8> <fis8 a8 c'8 dis'8> <fis8 a8 c'8 dis'8>   | 
-<g8 c'8 e'8> <g8 c'8 e'8> <g8 c'8 e'8> <g8 c'8 e'8>   | 
-<d8 c'8> <d8 a8> <g8 b8> <g8 b8>   | 
-<c4 c'4> <c,8 c8> r8   | 
-f,8 <f8 a8> a,8 <f8 a8>   | 
-f,8 <f8 a8> a,8 <f8 a8>   | 
-c8 <e8 g8 c'8> g,8 <e8 g8 c'8>   | 
-c8 <e8 g8 c'8> g,8 <e8 g8 c'8>   | 
-g,8 <f8 g8 b8> b,8 <f8 g8 b8>   | 
-g,8 <f8 g8 b8> d8 <f8 g8 b8>   | 
-<dis8 fis8 c'8> <dis4 fis4 c'4> <dis8 fis8 c'8>   | 
-<e8 g8 c'8> r8 r4   | 
-f,8 <f8 a8> a,8 <f8 a8>   | 
-f,8 <f8 a8> a,8 <f8 a8>   | 
-c8 <e8 g8 c'8> g,8 <e8 g8 c'8>   | 
-c8 <e8 g8 c'8> g,8 <e8 g8 c'8>   | 
-<f,8 f8> <d,8 d8> <e,8 e8> <f,8 f8>   | 
-<g,8 g8> <g8 c'8 e'8> <fis8 c'8 dis'8> <g8 c'8 e'8>   | 
-<a,8 a8> <d,8 d8> <g,8 g8> <b,8 b8>   | 
-<c8 c'8> r8 r4   | 
-<c8 c'8> <g,8 g8> <c,8 c8> r8   | 
- } }
-
-staffBlayerB =  \notes { { } s2*61 {
-
-r4 g8 c8   | 
- } }
-
-staffBglobal = \notes  { \key c \major \time 2/4
- \clef bass }
-
-staffB = \context Staff = staffB <
- \staffBglobal
- \context Voice = VA \staffBlayerA
- \context Voice = VB \staffBlayerB
->
-
-\score { < \staffA \staffB >
-  \paper{
-  \translator { \ScoreContext
-  \consists "Regular_spacing_engraver"
-  regularSpacingDelta = #(make-moment 1 8 )
+% markup is also highlighted
+\markup {
+  \line {
+    text test Voice Staff % note Lilypond keywords are not highlighted here
   }
-} 
+  \score { \relative c' { <ceg>2( d) } }
+  \italic bla
+  \override #'(baseline-skip . 2) {
+    \underline blu
+  }
 }
Index: kate/data/lilypond.xml
===================================================================
--- kate/data/lilypond.xml	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kate/data/lilypond.xml	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -1,373 +1,1095 @@
 <?xml version="1.0" encoding="UTF-8"?>
-<!DOCTYPE language SYSTEM "language.dtd">
-<!-- Andrea Primiani - primiani at dag dot it
- 	version1.0 - 14 august 2004 -->
-<language name="LilyPond" section="Other" extensions="*.ly;*.LY" mimetype="" casesensitive="true" author="Andrea Primiani (primiani@dag.it)" license="LGPL" version="1.01" kateversion="2.3">
-    <highlighting>
-<!-- repeat keywords -->
-    <list name="repeats">
-      <item> \repeat </item>
-      <item> volta </item>
-      <item> unfold </item>
-      <item> "tremolo" </item>
-      <item> "percent" </item>
-      <item> \alternative </item>
+<!DOCTYPE language SYSTEM "language.dtd" [
+  <!ENTITY b "(?![A-Za-z])">
+  <!ENTITY rest "\b[srR]&b;">
+  <!ENTITY pitch "\b([a-h]((iss){1,2}|(ess){1,2}|(is){1,2}|(es){1,2}|(sharp){1,2}|(flat){1,2}|ss?|ff?)?|(do|re|mi|fa|sol|la|si)(dd?|bb?|ss?|kk?)?)('+|,+|&b;)">
+  <!ENTITY duration "(\\(longa|breve)\b|(1|2|4|8|16|32|64|128|256|512|1024|2048)(?!\d))(\s*\.+)?(\s*\*\s*\d+(/\d+)?)*">
+  <!ENTITY dynamics "p{1,5}|mp|mf|f{1,4}|s?fp|sff?|spp?|[sr]?fz">
+  <!ENTITY scripts "\d+|accent|marcato|staccat(issim)?o|espressivo|tenuto|portato|(up|down)(bow|mordent|prall)|flageolet|thumb|[lr](heel|toe)|open|stopped|turn|reverseturn|trill|mordent|prall(prall|mordent|down|up)?|lineprall|signumcongruentiae|(short|long|verylong)?fermata|segno|(var)?coda">
+  <!ENTITY keywords "accepts|alias|consists|defaultchild|denies|description|grobdescriptions|include|invalid|name|objectid|once|remove|sequential|simultaneous|type|version|score|book">
+  <!ENTITY deprecatedkeywords "consistsend">
+  <!ENTITY commands "acciaccatura|addQuote|afterGrace|aikenHeads|allowPageTurn|alternative|apply(Context|Music|Output)|appoggiatura|arpeggio(Bracket|Down|Neutral|Up)?|(a|de)scendens|auctum|augmentum|autoBeamO(ff|n)|autochange|balloon(Grob)?Text|bar|barNumberCheck|bendAfter|breathe|break|cadenzaO(ff|n)|caesura|cavum|clef(\s+(treble|violin|G|alto|C|(sub)?bass|F|french|(mezzo)?soprano|(var)?baritone|percussion|tab))?|compressMusic|(end)?(de)?cr|(cue|transposedCue)During|default|deminutum|display(Lily)?Music|divisio(Maior|Maxima|Minima)|(dynamic|dots|phrasingSlur|slur|stem|tie|tuplet)(Down|Neutral|Up)|textLengthO(ff|n)|featherDurations|figure(mode|s)|finalis|flexa|(french|german|italian|semiGerman)Chords|glissando|grace|harmonic|(unH|h)ideNotes|(hide|show)StaffSwitch|inclinatum|(keep|remove)WithTag|key(\s+&pitch;)?|killCues|label|laissezVibrer|linea|mark|maxima|melisma(End)?|newSpacingSection|no(Beam|Break|PageBreak|PageTurn)|normalsize|octave|oneVoice|oriscus|page(-ref|Break|Turn)|parallelMusic|parenthesize|partcombine|partial(\s*&duration;)?|pes|pitchedTrill|quilisma|quoteDuring|relative(\s+&pitch;)?|RemoveEmptyStaffContext|repeat(\s+(unfold|volta|tremolo|percent)(\s+\d+)?)?|repeatTie|resetRelativeOctave|rest|sacredHarpHeads|scoreTweak|easyHeadsO(ff|n)|set(Hairpin|Text)(Cresc|Decresc|Dim)|setTextDecr|shift(Durations|Off|On{1,3})|(slur|tie)(Both|Dashed|Dotted|Solid)|small|spacingTweaks|(start|stop)(Group|(Text|Trill)Span|Staff)|stemBoth|stropha|super|(sustain|sostenuto)(Down|Up)|table-of-contents|tag|tempo(\s*\d+\.*\s*=\s*\d+)?|times?(\s*\d+/\d+)?|tiny|tocItem|transpose(\s+&pitch;\s*&pitch;)?|transposition(\s+&pitch;)|tweak|unfoldRepeats|virg(ul)?a|voice(One|Two|Three|Four)|withMusicProperty|cm|mm|in|pt|major|minor|ionian|locrian|aeolian|mixolydian|lydian|phrygian|dorian">
+  <!ENTITY deprecatedcommands "newpage|script(Up|Down|Both)|(empty|fat)Text|setEasyHeads|(default|voice|modernVoice|piano|forget)Accidentals|(modern(Voice)?|piano)Cautionaries|noResetKey">
+  <!ENTITY markupnotextargs "arrow-head|beam|char|double(flat|sharp)|draw-(circle|line)|epsfile|filled-box|flat|fret-diagram(-terse|-verbose)?|fromproperty|justify-(field|string)|lookup|markalphabet|markletter|musicglyph|natural|note-by-number|note|null|semi(flat|sharp)|sesqui(flat|sharp)|sharp|simple|slashed-digit|stencil|strut|tied-lyric|triangle|verbatim-file|wordwrap-field">
+  <!ENTITY markupwithtextargs "markup|bigger|bold|box|bracket|caps|(center|general|left|right)-align|circle|column|combine|concat|dir-column|dynamic|fill-line|finger|fontCaps|fontsize|fraction|halign|hbracket|hcenter-in|hcenter|hspace|huge|italic|justify|larger?|line|lower|magnify|medium|normal-size-(sub|super)|normal-text|normalsize|number|on-the-fly|override|pad-(around|markup|to-box|x)|page-ref|postscript|put-adjacent|raise|roman|rotate|sans|small(er)?|smallCaps|sub|super|teeny|text|tiny|translate(-scaled)?|transparent|typewriter|underline|upright|vcenter|whiteout|with-(color|dimensions|url)|wordwrap(-string)?|(markup|column-|justified-|override-|wordwrap-)lines">
+  <!ENTITY deprecatedmarkup "center">
+  <!ENTITY headervars "dedication|(sub){,2}title|poet|composer|meter|opus|arranger|instrument|piece|breakbefore|copyright|tagline|mutopia(title|composer|poet|opus|instrument)|date|enteredby|source|style|maintainer(Email|Web)?|moreInfo|lastupdated|texidoc">
+  <!ENTITY papervars "annotate-spacing|(print-)?first-page-number|print-page-number|paper-(width|height)|(top|bottom|left|right)-margin|line-width|(head|foot)-separation|page-top-space|ragged-(bottom|last-bottom|right)|page-count|between-system-(space|padding)|page-breaking-between-system-padding|horizontal-shift|(before|after|between)-title-space|printallheaders|indent|force-assignment|input-encoding|output-scale|blank(-after-score|-last)?-page-force|page-limit-inter-system-space(-factor)?|(systemSeparator|(even|odd)(Footer|Header)|(book|score|toc)Title|tocItem)Markup">
+  <!ENTITY layoutvars "system-count|indent">
+  <!ENTITY toplevelvars "dash(Hat|Plus|Dash|Bar|Larger|Dot|Underscore)|fermataMarkup|pipeSymbol|slashSeparator">
+  <!ENTITY performer "Beam|Control_track|Drum_note|Dynamic|Key|Lyric|Note|Piano_pedal|Slur|Staff|Swallow|Tempo|Tie|Time_signature">
+  <!ENTITY translator "Note_swallow|Rest_swallow|Skip_event_swallow|Timing">
+  <!ENTITY engraver "Accidental|Ambitus|Arpeggio|Auto_beam|Axis_group|Balloon|Bar|Bar_number|Beam|Bend|Break_align|Breathing_sign|Chord_name|Chord_tremolo|Clef|Cluster_spanner|Collision|Completion_heads|Custos|Default_bar_line|Dot_column|Dots|Drum_notes|Dynamic|Engraver|Extender|Figured_bass|Figured_bass_position|Fingering|Font_size|Forbid_line_break|Fretboard|Glissando|Grace_beam|Grace|Grace_spacing|Grid_line_span|Grid_point|Grob_pq|Hara_kiri|Horizontal_bracket|Hyphen|Instrument_name|Instrument_switch|Key|Laissez_vibrer|Ledger_line|Ligature_bracket|Lyric|Mark|Measure_grouping|Melody|Mensural_ligature|Metronome_mark|Multi_measure_rest|New_fingering|Note_head_line|Note_heads|Note_name|Note_spacing|Ottava_spanner|Output_property|Page_turn|Paper_column|Parenthesis|Part_combine|Percent_repeat|Phrasing_slur|Piano_pedal_align|Piano_pedal|Pitch_squash|Pitched_trill|Repeat_acknowledge|Repeat_tie|Rest_collision|Rest|Rhythmic_column|Script_column|Script|Script_row|Separating_line_group|Slash_repeat|Slur|Spacing|Span_arpeggio|Span_bar|Spanner_break_forbid|Staff_collecting|Staff_symbol|Stanza_number_align|Stanza_number|Stem|String_number|Swallow|System_start_delimiter|Tab_harmonic|Tab_note_heads|Tab_staff_symbol|Text|Text_spanner|Tie|Time_signature|Translator|Trill_spanner|Tuplet|Tweak|Vaticana_ligature|Vertical_align|Vertically_spaced_contexts|Volta">
+  <!ENTITY engravers "(&engraver;)_engraver|(&performer;)_performer|(&translator;)_translator">
+  <!ENTITY schemename "[a-zA-Z#][^\s(){}[\];$&quot;]*">
+  <!ENTITY schemefunc "\b(define|defined\?|define\*(-public)?|define-(\*|builtin-markup-(list-)?command|class|(extra-)?display-method|fonts?|grob-property|ly-syntax(-loc|-simple)?|macro(-public)?|markup-(list-)command|method|module|music-function|post-event-display-method|public(-macro|-toplevel)?|safe-public|span-event-display-method)|defmacro(\*(-public)?)?|lambda\*?|and|or|if|cond|case|let\*?|letrec|begin|do|delay|set!|else|(quasi)?quote|unquote(-splicing)?|(define|let|letrec)-syntax|syntax-rules|not|boolean\?|eq\?|eqv\?|equal\?|pair\?|cons|set-c[ad]r!|c[ad]{1,4}r|null\?|list\?|list|length|append|reverse|list-ref|mem[qv]|member|ass[qv]|assoc|symbol\?|symbol-&gt;string|string-&gt;symbol|number\?|complex\?|real\?|rational\?|integer\?|exact\?|inexact\?|zero\?|positive\?|negative\?|odd\?|even\?|max|min|abs|quotient|remainder|modulo|gcd|lcm|numerator|denominator|floor|ceiling|truncate|round|rationalize|exp|log|sin|cos|tan|asin|acos|atan|sqrt|expt|make-rectangular|make-polar|real-part|imag-part|magnitude|angle|exact-&gt;inexact|inexact-&gt;exact|number-&gt;string|string-&gt;number|char((-ci)?(=\?|&lt;\?|&gt;\?|&lt;=\?|&gt;=\?)|-alphabetic\?|\?|-numeric\?|-whitespace\?|-upper-case\?|-lower-case\?|-&gt;integer|-upcase|-downcase|-ready\?)|integer-&gt;char|make-string|string(\?|-copy|-fill!|-length|-ref|-set!|(-ci)?(=\?|&lt;\?|&gt;\?|&lt;=\?|&gt;=\?)|-append)|substring|make-vector|vector(\?|-length|-ref|-set!|-fill!)?|procedure\?|apply|map|for-each|force|call-with-(current-continuation|(in|out)put-file)|(in|out)put-port\?|current-(in|out)put-port|open-(in|out)put-file|close-(in|out)put-port|eof-object\?|read|(read|peek)-char|write(-char)?|display|newline|call/cc|list-tail|string-&gt;list|list-&gt;string|vector-&gt;list|list-&gt;vector|with-input-from-file|with-output-to-file|load|transcript-(on|off)|eval|dynamic-wind|port\?|values|call-with-values|(scheme-report-|null-|interaction-)environment)(?=($|\s|\)))">
+]>
+<language name="LilyPond" section="Other" version="2.20" kateversion="2.4" extensions="*.ly;*.LY;*.ily;*.ILY;*.lyi;*.LYI" mimetype="text/x-lilypond" author="Wilbert Berendsen (info@wilbertberendsen.nl)" license="LGPL">
+
+  <!--
+    
+    January, 2008
+    Fully rewritten by Wilbert Berendsen (info@wilbertberendsen.nl)
+    
+    Changes:
+    
+    - correctly parse pitches, chords, durations, etc. marking often made mistakes as invalid
+    - speed up by shortening contexts, e.g. branch out on a \, instead of RegExpr'ing all \commands
+    - recognize some contexts like \layout, \with, \header to colorcode variables, engravers, etc. only there
+    - recognize lilypond words like ChoirStaff etc. only in sections and after \set, \override etc.
+    - highlight some standard Scheme function names
+    - add \figuremode recognition
+    - all Scheme stuff has a nice, very light background, to show where Lilypond is in Scheme mode.
+    - mark some deprecated (pre 2.12) LilyPond commands and properties
+    
+    October, 2007
+    New version by Wilbert Berendsen (info@wilbertberendsen.nl)
+    
+    Changes:
+    
+    - better recognition of being inside lyrics, drums, notes, chords and markup sections
+    - detect block comments %{  %}
+    - links to ##Alerts in comments (e.g. TODO, FIXME)
+    - detect lilypond inside scheme #{ #}
+    - detect \score inside \markup, etc.
+    - helps with some often made errors like forgetting spaces around lyric extenders and hyphens
+    - more scheme improvements: strings, numbers, $substitutions, lilypond objects
+    - highlights many variables, commands, lilypond objects, properties, engravers, etc.
+    - by using entities for many regexps the main syntax checking parts remain legible, and the file more maintainable.
+    
+    I borrowed some colors and the drum names from Andrea Primiani's first version (August, 2004).
+    
+  -->
+
+  <highlighting>
+    <list name="contexts">
+      <item> ChoirStaff </item> 
+      <item> ChordNames </item> 
+      <item> CueVoice </item> 
+      <item> Devnull </item> 
+      <item> DrumStaff </item> 
+      <item> DrumVoice </item> 
+      <item> FiguredBass </item> 
+      <item> FretBoards </item> 
+      <item> Global </item> 
+      <item> GrandStaff </item> 
+      <item> GregorianTranscriptionStaff </item> 
+      <item> GregorianTranscriptionVoice </item> 
+      <item> InnerChoirStaff </item> 
+      <item> InnerStaffGroup </item> 
+      <item> Lyrics </item> 
+      <item> MensuralStaff </item> 
+      <item> MensuralVoice </item> 
+      <item> NoteNames </item> 
+      <item> PianoStaff </item> 
+      <item> RhythmicStaff </item> 
+      <item> Score </item> 
+      <item> Staff </item> 
+      <item> StaffGroup </item> 
+      <item> TabStaff </item> 
+      <item> TabVoice </item> 
+      <item> VaticanaStaff </item> 
+      <item> VaticanaVoice </item> 
+      <item> Voice </item>
     </list>
-<!-- header keywords -->
-        <list name="commands">
-	    <item> \clef </item>
-	    <item> \key </item>
-	    <item> \tempo </item>
-	    <item> \time </item>
-	</list>
-	<contexts>
-           <context name="Normal" attribute="Normal Text" lineEndContext="#stay">
-		<keyword attribute="Repeat" context="#stay" String="repeats" />
-		<keyword attribute="Keyword" context="Keyword" String="commands" />
-<!-- detects all keywords and pre-defined variables -->
-		<StringDetect attribute="Keyword" context="#stay" String="\addquote" />
-		<StringDetect attribute="Keyword" context="#stay" String="\aeolian" />
-		<StringDetect attribute="Keyword" context="#stay" String="\applymusic" />
-		<StringDetect attribute="Keyword" context="#stay" String="\applyoutput" />
-		<StringDetect attribute="Keyword" context="#stay" String="\autochange" />
-		<StringDetect attribute="Keyword" context="#stay" String="\bar" />
-		<StringDetect attribute="Keyword" context="#stay" String="\bold" />
-		<StringDetect attribute="Keyword" context="#stay" String="\bookpaper" />
-		<StringDetect attribute="Keyword" context="#stay" String="\book" />
-		<StringDetect attribute="Keyword" context="#stay" String="\breathe" />
-		<StringDetect attribute="Keyword" context="#stay" String="\breve " />
-		<StringDetect attribute="Keyword" context="#stay" String="\cadenzaOff" />
-		<StringDetect attribute="Keyword" context="#stay" String="\cadenzaOn" />
-		<StringDetect attribute="Keyword" context="#stay" String="\change" />
-		<StringDetect attribute="Keyword" context="#stay" String="\chords" />
-		<StringDetect attribute="Keyword" context="#stay" String="\column" />
-		<StringDetect attribute="Keyword" context="#stay" String="\consists" />
-		<StringDetect attribute="Keyword" context="#stay" String="\context" />
-		<StringDetect attribute="Keyword" context="#stay" String="\default" />
-		<StringDetect attribute="Keyword" context="#stay" String="\dorian" />
-		<StringDetect attribute="Keyword" context="#stay" String="\dotsBoth" />
-		<StringDetect attribute="Keyword" context="#stay" String="\dotsDown" />
-		<StringDetect attribute="Keyword" context="#stay" String="\dotsUp" />
-		<StringDetect attribute="Keyword" context="#stay" String="\drums"/>
-		<StringDetect attribute="Keyword" context="#stay" String="\dynamicBoth" />
-		<StringDetect attribute="Keyword" context="#stay" String="\dynamicDown" />
-		<StringDetect attribute="Keyword" context="#stay" String="\dynamicUp" />
-		<StringDetect attribute="Keyword" context="#stay" String="\emptyText" />
-		<StringDetect attribute="Keyword" context="#stay" String="\fatText" />
-		<StringDetect attribute="Keyword" context="#stay" String="\figures" />
-		<StringDetect attribute="Keyword" context="#stay" String="\finger" />
-		<StringDetect attribute="Keyword" context="#stay" String="\flat" />
-		<StringDetect attribute="Keyword" context="#stay" String="\germanChords" />
-		<StringDetect attribute="Keyword" context="#stay" String="\include" />
-		<StringDetect attribute="Keyword" context="#stay" String="\input" />
-		<StringDetect attribute="Keyword" context="#stay" String="\italic" />
-		<StringDetect attribute="Keyword" context="#stay" String="\ionian" />
-		<StringDetect attribute="Keyword" context="#stay" String="\locrian" />
-		<StringDetect attribute="Keyword" context="#stay" String="\longa" />
-		<StringDetect attribute="Keyword" context="#stay" String="\lydian" />
-		<StringDetect attribute="Keyword" context="#stay" String="\lyricsto" />
-		<StringDetect attribute="Keyword" context="#stay" String="\major" />
-		<StringDetect attribute="Keyword" context="#stay" String="\mark" />
-		<StringDetect attribute="Keyword" context="#stay" String="\markup" />
-		<StringDetect attribute="Keyword" context="#stay" String="\midi" />
-		<StringDetect attribute="Keyword" context="#stay" String="\minor" />
-		<StringDetect attribute="Keyword" context="#stay" String="\mixolydian" />
-		<StringDetect attribute="Keyword" context="#stay" String="\musicglyph" />
-		<StringDetect attribute="Keyword" context="#stay" String="\newlyrics" />
-		<StringDetect attribute="Keyword" context="#stay" String="\new" />
-		<StringDetect attribute="Keyword" context="#stay" String="\noBeam" />
-		<StringDetect attribute="Keyword" context="#stay" String="\notes"/>
-		<StringDetect attribute="Keyword" context="#stay" String="\octave" />
-		<StringDetect attribute="Keyword" context="#stay" String="\once" />
-		<StringDetect attribute="Keyword" context="#stay" String="\oneVoice" />
-		<StringDetect attribute="Keyword" context="#stay" String="\override" />
-		<StringDetect attribute="Keyword" context="#stay" String="\pageBreak" />
-		<StringDetect attribute="Keyword" context="#stay" String="\paper" />
-		<StringDetect attribute="Keyword" context="#stay" String="\partcombine" />
-		<StringDetect attribute="Keyword" context="#stay" String="\partial" />
-		<StringDetect attribute="Keyword" context="#stay" String="\phrasingSlurBoth" />
-		<StringDetect attribute="Keyword" context="#stay" String="\phrasingSlurDown" />
-		<StringDetect attribute="Keyword" context="#stay" String="\phrasingSlurUp" />
-		<StringDetect attribute="Keyword" context="#stay" String="\phrigian" />
-		<StringDetect attribute="Keyword" context="#stay" String="\property" />
-		<StringDetect attribute="Keyword" context="#stay" String="\quote" />
-		<StringDetect attribute="Keyword" context="#stay" String="\raise" />
-		<StringDetect attribute="Keyword" context="#stay" String="\relative" />
-		<StringDetect attribute="Keyword" context="#stay" String="\remove" />
-		<StringDetect attribute="Keyword" context="#stay" String="\renameinput" />
-		<StringDetect attribute="Keyword" context="#stay" String="\rest" />
-		<StringDetect attribute="Keyword" context="#stay" String="\revert" />
-		<StringDetect attribute="Keyword" context="#stay" String="\score" />
-		<StringDetect attribute="Keyword" context="#stay" String="\scriptBoth" />
-		<StringDetect attribute="Keyword" context="#stay" String="\scriptDown" />
-		<StringDetect attribute="Keyword" context="#stay" String="\scriptUp" />
-		<StringDetect attribute="Keyword" context="#stay" String="\semiGermanChords" />
-		<StringDetect attribute="Keyword" context="#stay" String="\setEasyHeads" />
-		<StringDetect attribute="Keyword" context="#stay" String="\setHairpinCresc" />
-		<StringDetect attribute="Keyword" context="#stay" String="\setTextCresc" />
-		<StringDetect attribute="Keyword" context="#stay" String="\set" />
-		<StringDetect attribute="Keyword" context="#stay" String="\shiftOff" />
-		<StringDetect attribute="Keyword" context="#stay" String="\shiftOnnn" />
-		<StringDetect attribute="Keyword" context="#stay" String="\shiftOnn" />
-		<StringDetect attribute="Keyword" context="#stay" String="\shiftOn" />
-		<StringDetect attribute="Keyword" context="#stay" String="\simultaneous" />
-		<StringDetect attribute="Keyword" context="#stay" String="\skip " />
-		<StringDetect attribute="Keyword" context="#stay" String="\slurBoth" />
-		<StringDetect attribute="Keyword" context="#stay" String="\slurDotted" />
-		<StringDetect attribute="Keyword" context="#stay" String="\slurDown" />
-		<StringDetect attribute="Keyword" context="#stay" String="\slurSolid" />
-		<StringDetect attribute="Keyword" context="#stay" String="\slurUp" />
-		<StringDetect attribute="Keyword" context="#stay" String="\smaller" />
-		<StringDetect attribute="Keyword" context="#stay" String="\startGroup" />
-		<StringDetect attribute="Keyword" context="#stay" String="\startTextSpan" />
-		<StringDetect attribute="Keyword" context="#stay" String="\stemBoth" />
-		<StringDetect attribute="Keyword" context="#stay" String="\stemDown" />
-		<StringDetect attribute="Keyword" context="#stay" String="\stemUp" />
-		<StringDetect attribute="Keyword" context="#stay" String="\stopGroup" />
-		<StringDetect attribute="Keyword" context="#stay" String="\stopTextSpan" />
-		<StringDetect attribute="Keyword" context="#stay" String="\tag" />
-		<StringDetect attribute="Keyword" context="#stay" String="\tempo" />
-		<StringDetect attribute="Keyword" context="#stay" String="\thumb" />
-		<StringDetect attribute="Keyword" context="#stay" String="\tieBoth" />
-		<StringDetect attribute="Keyword" context="#stay" String="\tieDotted" />
-		<StringDetect attribute="Keyword" context="#stay" String="\tieDown" />
-		<StringDetect attribute="Keyword" context="#stay" String="\tieSolid" />
-		<StringDetect attribute="Keyword" context="#stay" String="\tieUp" />
-		<StringDetect attribute="Keyword" context="#stay" String="\transpose" />
-		<StringDetect attribute="Keyword" context="#stay" String="\transposition" />
-		<StringDetect attribute="Keyword" context="#stay" String="\tupletBoth" />
-		<StringDetect attribute="Keyword" context="#stay" String="\tupletDown" />
-		<StringDetect attribute="Keyword" context="#stay" String="\tupletUp" />
-		<StringDetect attribute="Keyword" context="#stay" String="\typewriter" />
-		<StringDetect attribute="Keyword" context="#stay" String="\voiceFour" />
-		<StringDetect attribute="Keyword" context="#stay" String="\unset" />
-		<StringDetect attribute="Keyword" context="#stay" String="\voiceOne" />
-		<StringDetect attribute="Keyword" context="#stay" String="\voiceThree" />
-		<StringDetect attribute="Keyword" context="#stay" String="\voiceTwo" />
-		<StringDetect attribute="Keyword" context="#stay" String="\with" />
-<!-- decoration keywords -->
-		<StringDetect attribute="Decoration" context="#stay" String="\accento" />
-		<StringDetect attribute="Decoration" context="#stay" String="\acciaccatura" />
-		<StringDetect attribute="Decoration" context="#stay" String="\appoggiatura" />
-		<StringDetect attribute="Decoration" context="#stay" String="\arpeggioBoth" />
-		<StringDetect attribute="Decoration" context="#stay" String="\arpeggioBracket" />
-		<StringDetect attribute="Decoration" context="#stay" String="\arpeggioDown" />
-		<StringDetect attribute="Decoration" context="#stay" String="\arpeggioUp" />
-		<StringDetect attribute="Decoration" context="#stay" String="\arpeggio" />
-		<StringDetect attribute="Decoration" context="#stay" String="\coda" />
-		<StringDetect attribute="Decoration" context="#stay" String="\downbow" />
-		<StringDetect attribute="Decoration" context="#stay" String="\downmordent" />
-		<StringDetect attribute="Decoration" context="#stay" String="\downprall" />
-		<StringDetect attribute="Decoration" context="#stay" String="\fermataMarkup" />
-		<StringDetect attribute="Decoration" context="#stay" String="\fermata" />
-		<StringDetect attribute="Decoration" context="#stay" String="\flageolet" />
-		<StringDetect attribute="Decoration" context="#stay" String="\glissando" />
-		<StringDetect attribute="Decoration" context="#stay" String="\grace" />
-		<StringDetect attribute="Decoration" context="#stay" String="\harmonic" />
-		<StringDetect attribute="Decoration" context="#stay" String="\lheel" />
-		<StringDetect attribute="Decoration" context="#stay" String="\lineprall" />
-		<StringDetect attribute="Decoration" context="#stay" String="\longfermata" />
-		<StringDetect attribute="Decoration" context="#stay" String="\ltoe" />
-		<StringDetect attribute="Decoration" context="#stay" String="\melismaEnd" />
-		<StringDetect attribute="Decoration" context="#stay" String="\melisma" />
-		<StringDetect attribute="Decoration" context="#stay" String="\mordent" />
-		<StringDetect attribute="Decoration" context="#stay" String="\open" />
-		<StringDetect attribute="Decoration" context="#stay" String="\portato" />
-		<StringDetect attribute="Decoration" context="#stay" String="\prall" />
-		<StringDetect attribute="Decoration" context="#stay" String="\pralldown" />
-		<StringDetect attribute="Decoration" context="#stay" String="\prallmordent" />
-		<StringDetect attribute="Decoration" context="#stay" String="\prallprall" />
-		<StringDetect attribute="Decoration" context="#stay" String="\prallup" />
-		<StringDetect attribute="Decoration" context="#stay" String="\reverseturn" />
-		<StringDetect attribute="Decoration" context="#stay" String="\rheel" />
-		<StringDetect attribute="Decoration" context="#stay" String="\rtoe" />
-		<StringDetect attribute="Decoration" context="#stay" String="\segno" />
-		<StringDetect attribute="Decoration" context="#stay" String="\shortfermata" />
-		<StringDetect attribute="Decoration" context="#stay" String="\signumcongruentiae" />
-		<StringDetect attribute="Decoration" context="#stay" String="\sostenutoDown" />
-		<StringDetect attribute="Decoration" context="#stay" String="\sostenutoUp" />
-		<StringDetect attribute="Decoration" context="#stay" String="\staccatissimo" />
-		<StringDetect attribute="Decoration" context="#stay" String="\staccato" />
-		<StringDetect attribute="Decoration" context="#stay" String="\stopped" />
-		<StringDetect attribute="Decoration" context="#stay" String="\sustainDown" />
-		<StringDetect attribute="Decoration" context="#stay" String="\sustainUp" />
-		<StringDetect attribute="Decoration" context="#stay" String="\tenuto" />
-		<StringDetect attribute="Decoration" context="#stay" String="\thumb" />
-		<StringDetect attribute="Decoration" context="#stay" String="\trill" />
-		<StringDetect attribute="Decoration" context="#stay" String="\turn" />
-		<StringDetect attribute="Decoration" context="#stay" String="\upbow" />
-		<StringDetect attribute="Decoration" context="#stay" String="\upmordent" />
-		<StringDetect attribute="Decoration" context="#stay" String="\upprall" />
-		<StringDetect attribute="Decoration" context="#stay" String="\varcoda" />
-		<StringDetect attribute="Decoration" context="#stay" String="\verylongfermata" />
-<!-- drum note keywords -->
-		<StringDetect attribute="Drums" context="#stay" String=" hihat" />
-		<StringDetect attribute="Drums" context="#stay" String=" snaredrum" />
-		<StringDetect attribute="Drums" context="#stay" String=" crashcymbal" />
-		<StringDetect attribute="Drums" context="#stay" String=" openhihat" />
-		<StringDetect attribute="Drums" context="#stay" String=" halfopenhihat" />
-		<StringDetect attribute="Drums" context="#stay" String=" closedhihat" />
-		<StringDetect attribute="Drums" context="#stay" String=" bassdrum" />
-		<StringDetect attribute="Drums" context="#stay" String=" snare" />
-		<StringDetect attribute="Drums" context="#stay" String=" bd" />
-		<StringDetect attribute="Drums" context="#stay" String=" sn" />
-		<StringDetect attribute="Drums" context="#stay" String=" cymc" />
-		<StringDetect attribute="Drums" context="#stay" String=" cyms" />
-		<StringDetect attribute="Drums" context="#stay" String=" cymr" />
-		<StringDetect attribute="Drums" context="#stay" String=" hhho" />
-		<StringDetect attribute="Drums" context="#stay" String=" hhc" />
-		<StringDetect attribute="Drums" context="#stay" String=" hho" />
-		<StringDetect attribute="Drums" context="#stay" String=" hhp" />
-		<StringDetect attribute="Drums" context="#stay" String=" hh" />
-		<StringDetect attribute="Drums" context="#stay" String=" cb" />
-		<StringDetect attribute="Drums" context="#stay" String=" hc" />
-		<StringDetect attribute="Drums" context="#stay" String=" ssl" />
-		<StringDetect attribute="Drums" context="#stay" String=" ssh" />
-		<StringDetect attribute="Drums" context="#stay" String=" ss" />
-		<StringDetect attribute="Drums" context="#stay" String=" tommmh" />
-		<StringDetect attribute="Drums" context="#stay" String=" tommh" />
-		<StringDetect attribute="Drums" context="#stay" String=" tomh" />
-		<StringDetect attribute="Drums" context="#stay" String=" toml" />
-		<StringDetect attribute="Drums" context="#stay" String=" tomfh" />
-		<StringDetect attribute="Drums" context="#stay" String=" tomfl" />
-		<StringDetect attribute="Drums" context="#stay" String=" timh" />
-		<StringDetect attribute="Drums" context="#stay" String=" timl" />
-		<StringDetect attribute="Drums" context="#stay" String=" cgho" />
-		<StringDetect attribute="Drums" context="#stay" String=" cghm" />
-		<StringDetect attribute="Drums" context="#stay" String=" cgh" />
-		<StringDetect attribute="Drums" context="#stay" String=" cglo" />
-		<StringDetect attribute="Drums" context="#stay" String=" cglm" />
-		<StringDetect attribute="Drums" context="#stay" String=" cgl" />
-		<StringDetect attribute="Drums" context="#stay" String=" boho" />
-		<StringDetect attribute="Drums" context="#stay" String=" bohm" />
-		<StringDetect attribute="Drums" context="#stay" String=" boh" />
-		<StringDetect attribute="Drums" context="#stay" String=" bolo" />
-		<StringDetect attribute="Drums" context="#stay" String=" bolm" />
-		<StringDetect attribute="Drums" context="#stay" String=" bol" />
-		<StringDetect attribute="Drums" context="#stay" String=" trio" />
-		<StringDetect attribute="Drums" context="#stay" String=" trim" />
-		<StringDetect attribute="Drums" context="#stay" String=" tri" />
-		<StringDetect attribute="Drums" context="#stay" String=" guis" />
-		<StringDetect attribute="Drums" context="#stay" String=" guil" />
-		<StringDetect attribute="Drums" context="#stay" String=" gui" />
-		<StringDetect attribute="Drums" context="#stay" String=" cl" />
-		<StringDetect attribute="Drums" context="#stay" String=" tamb" />
-		<StringDetect attribute="Drums" context="#stay" String=" cab" />
-		<StringDetect attribute="Drums" context="#stay" String=" mar" />
-<!-- detects tuplets -->
-	    <RegExpr attribute="Tuplet" context="#pop" String="\\times [1-9]?/[1-9]?" />
-<!-- detects lyrics expression -->	    
-	    <StringDetect attribute="Lyrics" context="Lyrics" String="\lyrics {" beginRegion="lyrics" />
-	    <StringDetect attribute="Lyrics" context="Lyrics" String="\newlyrics {" beginRegion="lyrics" />
-<!-- detects \header {   } zone -->
-	    <RegExpr attribute="Keyword" context="Header" String="\\header\s*{" beginRegion="header" />
-<!-- detects quoted strings -->
-	    <RangeDetect attribute="String" context="#stay" char="&quot;" char1="&quot;"/>
-<!-- detects other { } ranges -->
-	    <DetectChar attribute="Chord" context="#stay" char="{" />
-	    <DetectChar attribute="Chord" context="#stay" char="}" />
-<!-- in old Lilypond the same was for [ ] -->
-	    <DetectChar attribute="Chord" context="#stay" char="[" />
-	    <DetectChar attribute="Chord" context="#stay" char="]" />
-<!-- detects <> for chords -->
-	    <DetectChar attribute="Chord" context="#stay" char="&lt;" />
-	    <DetectChar attribute="Chord" context="#stay" char="&gt;" />
-<!-- detects #( ) command lines	-->
-	    <Detect2Chars attribute="Header" context="Command" char="#" char1="(" beginRegion="command" />
-<!-- detects context delimiter << (was <) -->
-	    <Detect2Chars attribute="Context" context="#stay" char="&lt;" char1="&lt;" beginRegion="context"/>
-	    <Detect2Chars attribute="Context" context="#stay" char="&gt;" char1="&gt;" endRegion="context"/>
-<!-- detects ~ for ties -->
-	    <DetectChar attribute="Chord" context="#stay" char="~" />
-<!-- detects bar beginning (or chord) symbols and sends to Bar context -->
-	    <DetectChar attribute="Bar" context="#stay" char="|" />
-<!-- detects n:m note repeat marks -->
-	    <RegExpr attribute="Repeat" context="#stay" String="[1-9]+:[1-9]+\b" />
-<!-- detects ( for slur beginning  -->
-	    <RegExpr attribute="Slur" context="#stay" String="\\?\(" />
-	    <RegExpr attribute="Slur" context="#stay" String="\\?\)" />
-<!-- detects dynamic marks -->
-	    <RegExpr attribute="Dynamics" context="#stay" String="\\fff\b" />
-	    <RegExpr attribute="Dynamics" context="#stay" String="\\ff\b" /> 
-	    <RegExpr attribute="Dynamics" context="#stay" String="\\ppp\b" />
-	    <RegExpr attribute="Dynamics" context="#stay" String="\\pp\b" />
-	    <RegExpr attribute="Dynamics" context="#stay" String="\\m?[f|p]\b" />
-	    <RegExpr attribute="Dynamics" context="#stay" String="\\[s|r]fz?\b" />
-<!-- detects articulation marks -->
-	    <RegExpr attribute="Dynamics" context="#stay" String="_[_.\|+&gt;^-]\b?" />
-	    <RegExpr attribute="Dynamics" context="#stay" String="\^[_.\|+&gt;^-]\b?" />
-	    <RegExpr attribute="Dynamics" context="#stay" String="-[_.\|+&gt;^-]\b?" />
-<!-- detects \< for crescendo and \> for diminuendo - both end with \! -->
-	    <Detect2Chars attribute="Dynamics" context="#stay" char="\" char1="&lt;" />
-	    <Detect2Chars attribute="Dynamics" context="#stay" char="\" char1="&gt;" />
-	    <Detect2Chars attribute="Dynamics" context="#stay" char="\" char1="!" />
-<!-- detects fingering marks -->
-	    <RegExpr attribute="Dynamics" context="#stay" String="-[0-5]\b" />
-<!-- detects % comment lines  -->	
-	    <DetectChar attribute="Comment" context="Comment" char="%" />
-	   </context>
-<!-- returns to Normal context at the end of line -->	   
-	   <context name="Preprocessor" attribute="Preprocessor" lineEndContext="#pop" />
-	   <context name="Comment" attribute="Comment" lineEndContext="#pop" />
-	   <context name="Slur" attribute="Normal" lineEndContext="#stay" >
-	   	<RegExpr attribute="Slur" context="Slur" String="\\?\(" />
-		<RegExpr attribute="Slur" context="#pop" String="\\?\)" />
-	   </context>
-<!-- detects >> as end of Context region -->
-	   <context name="Context" attribute="Normal Text" lineEndContext="#stay" >
-	   	<Detect2Chars attribute="Context" context="#pop" char="&gt;" char1="&gt;" endRegion="context"/>
-	   </context>
-	   <context name="Command" attribute="Header" lineEndContext="#stay" >
-	   	<DetectChar attribute="Header" context="Command" char="(" />
-	   	<DetectChar attribute="Header" context="#pop" char=")" endRegion="command" />
-	   </context>
-<!-- returns to Normal context at the end of header -->
-	   <context name="Header" attribute="Header" lineEndContext="#stay">
-<!-- the header ends at the } char -->
-		<DetectChar attribute="Keyword" context="#pop" char="}" endRegion="header"/>
-	   </context>
-<!-- returns to Normal context at the end of lyrics -->
-	   <context name="Lyrics" attribute="Lyrics" lineEndContext="#stay">
-<!-- detects % comment lines  -->	
-	    <DetectChar attribute="Comment" context="Comment" char="%" />
-<!-- the region ends at the } char -->
-		<DetectChar attribute="Lyrics" context="#pop" char="}" endRegion="lyrics"/>
-	   </context>
-<!-- repeat region: detects other keywords and } as repeat end -->
-	   <context name="Repeat" attribute="Normal Text" lineEndContext="#stay">
-<!-- the repeat region ends at the } char -->
-	   <DetectChar attribute="Normal Text" context="#pop" char="}" />
-	   <StringDetect attribute="Repeat" context="#pop" String="&quot;tremolo&quot;"  />
-	   <StringDetect attribute="Repeat" context="#pop" String="&quot;percent&quot;"  />
-	   <RegExpr attribute="Repeat" context="#pop" String="volta\b+[1-9]\b+" />
-	   </context>
-<!-- detects keywords after the \ char  -->
-	   <context name="Keyword" attribute="Keyword" lineEndContext="#pop"/>
-       </contexts>
-        <itemDatas>
-          <itemData name="Normal Text" defStyleNum="dsNormal"/>
-	  <itemData name="Keyword" defStyleNum="dsKeyword" bold="true" />
-          <itemData name="Decoration" defStyleNum="dsKeyword" bold="true" color="#3300bb"/>
-	  <itemData name="Comment" defStyleNum="dsComment"/>
-	  <itemData name="Tuplet" defStyleNum="dsFloat" color="#00bbaa" />
-	  <itemData name="String" defStyleNum="dsString" bold="true"/>
-	  <itemData name="Preprocessor" defStyleNum="dsString" italic="true"/>
-	  <itemData name="Dynamics" defStyleNum="dsString" color="#ee5000"/>
-	  <itemData name="Header" defStyleNum="dsFloat"/>
-	  <itemData name="Chord" defStyleNum="dsDataType" bold="true"/>
-	  <itemData name="Context" defStyleNum="dsDataType"/>
-	  <itemData name="Lyrics" defStyleNum="dsDataType" color="#00bb00"/>
-	  <itemData name="Bar" defStyleNum="dsChar" color="#0000ff"/>
-	  <itemData name="Sharp" defStyleNum="dsNormal" bold="true"/>
-	  <itemData name="Slur" defStyleNum="dsChar" bold="true"/>
-	  <itemData name="Repeat" defStyleNum="dsDataType" italic="true"/>
-	  <itemData name="Drums" defStyleNum="dsKeyword" color="#003333"/>
-	</itemDatas>
- </highlighting>
+    <list name="layoutobjects">
+      <item> Accidental </item> 
+      <item> AccidentalCautionary </item> 
+      <item> AccidentalPlacement </item> 
+      <item> AccidentalSuggestion </item> 
+      <item> Ambitus </item> 
+      <item> AmbitusAccidental </item> 
+      <item> AmbitusLine </item> 
+      <item> AmbitusNoteHead </item> 
+      <item> Arpeggio </item> 
+      <item> BalloonTextItem </item> 
+      <item> BarLine </item> 
+      <item> BarNumber </item> 
+      <item> BassFigure </item> 
+      <item> BassFigureAlignment </item> 
+      <item> BassFigureAlignmentPositioning </item> 
+      <item> BassFigureBracket </item> 
+      <item> BassFigureContinuation </item> 
+      <item> BassFigureLine </item> 
+      <item> Beam </item> 
+      <item> BendAfter </item> 
+      <item> BreakAlignGroup </item> 
+      <item> BreakAlignment </item> 
+      <item> BreathingSign </item> 
+      <item> ChordName </item> 
+      <item> Clef </item> 
+      <item> ClusterSpanner </item> 
+      <item> ClusterSpannerBeacon </item> 
+      <item> CombineTextScript </item> 
+      <item> Custos </item> 
+      <item> DotColumn </item> 
+      <item> Dots </item> 
+      <item> DoublePercentRepeat </item> 
+      <item> DoublePercentRepeatCounter </item> 
+      <item> DynamicLineSpanner </item> 
+      <item> DynamicText </item> 
+      <item> DynamicTextSpanner </item> 
+      <item> Fingering </item> 
+      <item> FretBoard </item> 
+      <item> Glissando </item> 
+      <item> GraceSpacing </item> 
+      <item> GridLine </item> 
+      <item> GridPoint </item> 
+      <item> Hairpin </item> 
+      <item> HarmonicParenthesesItem </item> 
+      <item> HorizontalBracket </item> 
+      <item> InstrumentName </item> 
+      <item> InstrumentSwitch </item> 
+      <item> KeyCancellation </item> 
+      <item> KeySignature </item> 
+      <item> LaissezVibrerTie </item> 
+      <item> LaissezVibrerTieColumn </item> 
+      <item> LedgerLineSpanner </item> 
+      <item> LeftEdge </item> 
+      <item> LigatureBracket </item> 
+      <item> LyricExtender </item> 
+      <item> LyricHyphen </item> 
+      <item> LyricSpace </item> 
+      <item> LyricText </item> 
+      <item> MeasureGrouping </item> 
+      <item> MelodyItem </item> 
+      <item> MensuralLigature </item> 
+      <item> MetronomeMark </item> 
+      <item> MultiMeasureRest </item> 
+      <item> MultiMeasureRestNumber </item> 
+      <item> MultiMeasureRestText </item> 
+      <item> NonMusicalPaperColumn </item> 
+      <item> NoteCollision </item> 
+      <item> NoteColumn </item> 
+      <item> NoteHead </item> 
+      <item> NoteName </item> 
+      <item> NoteSpacing </item> 
+      <item> OctavateEight </item> 
+      <item> OttavaBracket </item> 
+      <item> PaperColumn </item> 
+      <item> ParenthesesItem </item> 
+      <item> PercentRepeat </item> 
+      <item> PercentRepeatCounter </item> 
+      <item> PhrasingSlur </item> 
+      <item> PianoPedalBracket </item> 
+      <item> RehearsalMark </item> 
+      <item> RepeatSlash </item> 
+      <item> RepeatTie </item> 
+      <item> RepeatTieColumn </item> 
+      <item> Rest </item> 
+      <item> RestCollision </item> 
+      <item> Script </item> 
+      <item> ScriptColumn </item> 
+      <item> ScriptRow </item> 
+      <item> SeparationItem </item> 
+      <item> Slur </item> 
+      <item> SostenutoPedal </item> 
+      <item> SostenutoPedalLineSpanner </item> 
+      <item> SpacingSpanner </item> 
+      <item> SpanBar </item> 
+      <item> StaffSpacing </item> 
+      <item> StaffSymbol </item> 
+      <item> StanzaNumber </item> 
+      <item> Stem </item> 
+      <item> StemTremolo </item> 
+      <item> StringNumber </item> 
+      <item> StrokeFinger </item> 
+      <item> SustainPedal </item> 
+      <item> SustainPedalLineSpanner </item> 
+      <item> System </item> 
+      <item> SystemStartBar </item> 
+      <item> SystemStartBrace </item> 
+      <item> SystemStartBracket </item> 
+      <item> SystemStartSquare </item> 
+      <item> TabNoteHead </item> 
+      <item> TextScript </item> 
+      <item> TextSpanner </item> 
+      <item> Tie </item> 
+      <item> TieColumn </item> 
+      <item> TimeSignature </item> 
+      <item> TrillPitchAccidental </item> 
+      <item> TrillPitchGroup </item> 
+      <item> TrillPitchHead </item> 
+      <item> TrillSpanner </item> 
+      <item> TupletBracket </item> 
+      <item> TupletNumber </item> 
+      <item> UnaCordaPedal </item> 
+      <item> UnaCordaPedalLineSpanner </item> 
+      <item> VaticanaLigature </item> 
+      <item> VerticalAlignment </item> 
+      <item> VerticalAxisGroup </item> 
+      <item> VoiceFollower </item> 
+      <item> VoltaBracket </item> 
+      <item> VoltaBracketSpanner </item> 
+    </list>
+    <list name="properties">
+      <item> aDueText </item>
+      <item> alignAboveContext </item>
+      <item> alignBassFigureAccidentals </item>
+      <item> alignBelowContext </item>
+      <item> allowBeamBreak </item>
+      <item> associatedVoice </item>
+      <item> autoAccidentals </item>
+      <item> autoBeamCheck </item>
+      <item> autoBeamSettings </item>
+      <item> autoBeaming </item>
+      <item> autoCautionaries </item>
+      <item> automaticBars </item>
+      <item> barAlways </item>
+      <item> barCheckSynchronize </item>
+      <item> barNumberVisibility </item>
+      <item> bassFigureFormatFunction </item>
+      <item> bassStaffProperties </item>
+      <item> beatGrouping </item>
+      <item> beatLength </item>
+      <item> chordChanges </item>
+      <item> chordNameExceptions </item>
+      <item> chordNameExceptionsFull </item>
+      <item> chordNameExceptionsPartial </item>
+      <item> chordNameFunction </item>
+      <item> chordNameSeparator </item>
+      <item> chordNoteNamer </item>
+      <item> chordPrefixSpacer </item>
+      <item> chordRootNamer </item>
+      <item> clefGlyph </item>
+      <item> clefOctavation </item>
+      <item> clefPosition </item>
+      <item> connectArpeggios </item>
+      <item> countPercentRepeats </item>
+      <item> createKeyOnClefChange </item>
+      <item> createSpacing </item>
+      <item> crescendoSpanner </item>
+      <item> crescendoText </item>
+      <item> currentBarNumber </item>
+      <item> decrescendoSpanner </item>
+      <item> decrescendoText </item>
+      <item> defaultBarType </item>
+      <item> doubleSlurs </item>
+      <item> drumPitchTable </item>
+      <item> drumStyleTable </item>
+      <item> dynamicAbsoluteVolumeFunction </item>
+      <item> explicitClefVisibility </item>
+      <item> explicitKeySignatureVisibility </item>
+      <item> extendersOverRests </item>
+      <item> extraNatural </item>
+      <item> figuredBassAlterationDirection </item>
+      <item> figuredBassCenterContinuations </item>
+      <item> figuredBassFormatter </item>
+      <item> figuredBassPlusDirection </item>
+      <item> fingeringOrientations </item>
+      <item> firstClef </item>
+      <item> followVoice </item>
+      <item> fontSize </item>
+      <item> forbidBreak </item>
+      <item> forceClef </item>
+      <item> gridInterval </item>
+      <item> hairpinToBarline </item>
+      <item> harmonicAccidentals </item>
+      <item> highStringOne </item>
+      <item> ignoreBarChecks </item>
+      <item> ignoreFiguredBassRest </item>
+      <item> ignoreMelismata </item>
+      <item> implicitBassFigures </item>
+      <item> implicitTimeSignatureVisibility </item>
+      <item> instrumentCueName </item>
+      <item> instrumentEqualizer </item>
+      <item> instrumentName </item>
+      <item> instrumentTransposition </item>
+      <item> internalBarNumber </item>
+      <item> keepAliveInterfaces </item>
+      <item> keyAlterationOrder </item>
+      <item> keySignature </item>
+      <item> lyricMelismaAlignment </item>
+      <item> majorSevenSymbol </item>
+      <item> markFormatter </item>
+      <item> maximumFretStretch </item>
+      <item> measureLength </item>
+      <item> measurePosition </item>
+      <item> melismaBusyProperties </item>
+      <item> metronomeMarkFormatter </item>
+      <item> middleCClefPosition </item>
+      <item> middleCOffset </item>
+      <item> middleCPosition </item>
+      <item> midiInstrument </item>
+      <item> midiMaximumVolume </item>
+      <item> midiMinimumVolume </item>
+      <item> minimumFret </item>
+      <item> minimumPageTurnLength </item>
+      <item> minimumRepeatLengthForPageTurn </item>
+      <item> noteToFretFunction </item>
+      <item> ottavation </item>
+      <item> output </item>
+      <item> pedalSostenutoStrings </item>
+      <item> pedalSostenutoStyle </item>
+      <item> pedalSustainStrings </item>
+      <item> pedalSustainStyle </item>
+      <item> pedalUnaCordaStrings </item>
+      <item> pedalUnaCordaStyle </item>
+      <item> printKeyCancellation </item>
+      <item> printOctaveNames </item>
+      <item> printPartCombineTexts </item>
+      <item> proportionalNotationDuration </item>
+      <item> recordEventSequence </item>
+      <item> rehearsalMark </item>
+      <item> repeatCommands </item>
+      <item> restNumberThreshold </item>
+      <item> scriptDefinitions </item>
+      <item> shapeNoteStyles </item>
+      <item> shortInstrumentName </item>
+      <item> shortVocalName </item>
+      <item> skipBars </item>
+      <item> skipTypesetting </item>
+      <item> soloIIText </item>
+      <item> soloText </item>
+      <item> squashedPosition </item>
+      <item> staffLineLayoutFunction </item>
+      <item> stanza </item>
+      <item> stemLeftBeamCount </item>
+      <item> stemRightBeamCount </item>
+      <item> stringNumberOrientations </item>
+      <item> stringOneTopmost </item>
+      <item> stringTunings </item>
+      <item> strokeFingerOrientations </item>
+      <item> subdivideBeams </item>
+      <item> suggestAccidentals </item>
+      <item> systemStartDelimiter </item>
+      <item> systemStartDelimiterHierarchy </item>
+      <item> tablatureFormat </item>
+      <item> tempoUnitCount </item>
+      <item> tempoUnitDuration </item>
+      <item> tempoWholesPerMinute </item>
+      <item> tieWaitForNote </item>
+      <item> timeSignatureFraction </item>
+      <item> timing </item>
+      <item> tonic </item>
+      <item> trebleStaffProperties </item>
+      <item> tremoloFlags </item>
+      <item> tupletFullLength </item>
+      <item> tupletFullLengthNote </item>
+      <item> tupletSpannerDuration </item>
+      <item> useBassFigureExtenders </item>
+      <item> verticallySpacedContexts </item>
+      <item> vocalName </item>
+      <item> voltaOnThisStaff </item>
+      <item> voltaSpannerDuration </item>
+      <item> whichBar </item>
+    </list>
+    <list name="deprecatedproperties">
+      <item> barNumberAlignSymbol </item>
+      <item> centralCPosition </item>
+      <item> extraVerticalExtent </item>
+      <item> fingerHorizontalDirection </item>
+      <item> instr </item>
+      <item> instrument </item>
+      <item> keyAccidentalOrder </item>
+      <item> minimumVerticalExtent </item>
+      <item> rehearsalMarkAlignSymbol </item>
+      <item> soloADue </item>
+      <item> tupletNumberFormatFunction </item>
+      <item> vocNam </item>
+    </list>
+    <list name="musicexpressions">
+      <item> AbsoluteDynamicEvent </item> 
+      <item> AnnotateOutputEvent </item> 
+      <item> ApplyContext </item> 
+      <item> ApplyOutputEvent </item> 
+      <item> ArpeggioEvent </item> 
+      <item> ArticulationEvent </item> 
+      <item> AutoChangeMusic </item> 
+      <item> BarCheck </item> 
+      <item> BassFigureEvent </item> 
+      <item> BeamEvent </item> 
+      <item> BeamForbidEvent </item> 
+      <item> BendAfterEvent </item> 
+      <item> BreathingEvent </item> 
+      <item> ClusterNoteEvent </item> 
+      <item> ContextChange </item> 
+      <item> ContextSpeccedMusic </item> 
+      <item> CrescendoEvent </item> 
+      <item> DecrescendoEvent </item> 
+      <item> Event </item> 
+      <item> EventChord </item> 
+      <item> ExtenderEvent </item> 
+      <item> FingeringEvent </item> 
+      <item> GlissandoEvent </item> 
+      <item> GraceMusic </item> 
+      <item> HarmonicEvent </item> 
+      <item> HyphenEvent </item> 
+      <item> KeyChangeEvent </item> 
+      <item> LabelEvent </item> 
+      <item> LaissezVibrerEvent </item> 
+      <item> LigatureEvent </item> 
+      <item> LineBreakEvent </item> 
+      <item> LyricCombineMusic </item> 
+      <item> LyricEvent </item> 
+      <item> MarkEvent </item> 
+      <item> MultiMeasureRestEvent </item> 
+      <item> MultiMeasureRestMusic </item> 
+      <item> MultiMeasureTextEvent </item> 
+      <item> Music </item> 
+      <item> NoteEvent </item> 
+      <item> NoteGroupingEvent </item> 
+      <item> OverrideProperty </item> 
+      <item> PageBreakEvent </item> 
+      <item> PageTurnEvent </item> 
+      <item> PartCombineMusic </item> 
+      <item> PercentEvent </item> 
+      <item> PercentRepeatedMusic </item> 
+      <item> PesOrFlexaEvent </item> 
+      <item> PhrasingSlurEvent </item> 
+      <item> PropertySet </item> 
+      <item> PropertyUnset </item> 
+      <item> QuoteMusic </item> 
+      <item> RelativeOctaveCheck </item> 
+      <item> RelativeOctaveMusic </item> 
+      <item> RepeatTieEvent </item> 
+      <item> RepeatedMusic </item> 
+      <item> RestEvent </item> 
+      <item> RevertProperty </item> 
+      <item> ScriptEvent </item> 
+      <item> SequentialMusic </item> 
+      <item> SimultaneousMusic </item> 
+      <item> SkipEvent </item> 
+      <item> SkipMusic </item> 
+      <item> SlurEvent </item> 
+      <item> SoloOneEvent </item> 
+      <item> SoloTwoEvent </item> 
+      <item> SostenutoEvent </item> 
+      <item> SpacingSectionEvent </item> 
+      <item> SpanEvent </item> 
+      <item> StaffSpanEvent </item> 
+      <item> StringNumberEvent </item> 
+      <item> StrokeFingerEvent </item> 
+      <item> SustainEvent </item> 
+      <item> TextScriptEvent </item> 
+      <item> TextSpanEvent </item> 
+      <item> TieEvent </item> 
+      <item> TimeScaledMusic </item> 
+      <item> TransposedMusic </item> 
+      <item> TremoloEvent </item> 
+      <item> TremoloRepeatedMusic </item> 
+      <item> TremoloSpanEvent </item> 
+      <item> TrillSpanEvent </item> 
+      <item> TupletSpanEvent </item> 
+      <item> UnaCordaEvent </item> 
+      <item> UnfoldedRepeatedMusic </item> 
+      <item> UnisonoEvent </item> 
+      <item> UnrelativableMusic </item> 
+      <item> VoiceSeparator </item> 
+      <item> VoltaRepeatedMusic </item> 
+    </list>
+    <list name="drumpitchnames">
+      <item> acousticbassdrum </item>
+      <item> acousticsnare </item>
+      <item> agh </item>
+      <item> agl </item>
+      <item> bassdrum </item>
+      <item> bd </item>
+      <item> bda </item>
+      <item> boh </item>
+      <item> bohm </item>
+      <item> boho </item>
+      <item> bol </item>
+      <item> bolm </item>
+      <item> bolo </item>
+      <item> cab </item>
+      <item> cabasa </item>
+      <item> cb </item>
+      <item> cgh </item>
+      <item> cghm </item>
+      <item> cgho </item>
+      <item> cgl </item>
+      <item> cglm </item>
+      <item> cglo </item>
+      <item> chinesecymbal </item>
+      <item> cl </item>
+      <item> claves </item>
+      <item> closedhihat </item>
+      <item> cowbell </item>
+      <item> crashcymbal </item>
+      <item> crashcymbala </item>
+      <item> crashcymbalb </item>
+      <item> cuim </item>
+      <item> cuio </item>
+      <item> cymc </item>
+      <item> cymca </item>
+      <item> cymcb </item>
+      <item> cymch </item>
+      <item> cymr </item>
+      <item> cymra </item>
+      <item> cymrb </item>
+      <item> cyms </item>
+      <item> da </item>
+      <item> db </item>
+      <item> dc </item>
+      <item> dd </item>
+      <item> de </item>
+      <item> electricsnare </item>
+      <item> fivedown </item>
+      <item> fiveup </item>
+      <item> fourdown </item>
+      <item> fourup </item>
+      <item> gui </item>
+      <item> guil </item>
+      <item> guiro </item>
+      <item> guis </item>
+      <item> halfopenhihat </item>
+      <item> handclap </item>
+      <item> hc </item>
+      <item> hh </item>
+      <item> hhc </item>
+      <item> hhho </item>
+      <item> hho </item>
+      <item> hhp </item>
+      <item> hiagogo </item>
+      <item> hibongo </item>
+      <item> hiconga </item>
+      <item> highfloortom </item>
+      <item> hightom </item>
+      <item> hihat </item>
+      <item> himidtom </item>
+      <item> hisidestick </item>
+      <item> hitimbale </item>
+      <item> hiwoodblock </item>
+      <item> loagogo </item>
+      <item> lobongo </item>
+      <item> loconga </item>
+      <item> longguiro </item>
+      <item> longwhistle </item>
+      <item> losidestick </item>
+      <item> lotimbale </item>
+      <item> lowfloortom </item>
+      <item> lowmidtom </item>
+      <item> lowoodblock </item>
+      <item> lowtom </item>
+      <item> mar </item>
+      <item> maracas </item>
+      <item> mutecuica </item>
+      <item> mutehibongo </item>
+      <item> mutehiconga </item>
+      <item> mutelobongo </item>
+      <item> muteloconga </item>
+      <item> mutetriangle </item>
+      <item> onedown </item>
+      <item> oneup </item>
+      <item> opencuica </item>
+      <item> openhibongo </item>
+      <item> openhiconga </item>
+      <item> openhihat </item>
+      <item> openlobongo </item>
+      <item> openloconga </item>
+      <item> opentriangle </item>
+      <item> pedalhihat </item>
+      <item> rb </item>
+      <item> ridebell </item>
+      <item> ridecymbal </item>
+      <item> ridecymbala </item>
+      <item> ridecymbalb </item>
+      <item> shortguiro </item>
+      <item> shortwhistle </item>
+      <item> sidestick </item>
+      <item> sn </item>
+      <item> sna </item>
+      <item> snare </item>
+      <item> sne </item>
+      <item> splashcymbal </item>
+      <item> ss </item>
+      <item> ssh </item>
+      <item> ssl </item>
+      <item> tamb </item>
+      <item> tambourine </item>
+      <item> tamtam </item>
+      <item> threedown </item>
+      <item> threeup </item>
+      <item> timh </item>
+      <item> timl </item>
+      <item> tomfh </item>
+      <item> tomfl </item>
+      <item> tomh </item>
+      <item> toml </item>
+      <item> tommh </item>
+      <item> tomml </item>
+      <item> tri </item>
+      <item> triangle </item>
+      <item> trim </item>
+      <item> trio </item>
+      <item> tt </item>
+      <item> twodown </item>
+      <item> twoup </item>
+      <item> ua </item>
+      <item> ub </item>
+      <item> uc </item>
+      <item> ud </item>
+      <item> ue </item>
+      <item> vibraslap </item>
+      <item> vibs </item>
+      <item> wbh </item>
+      <item> wbl </item>
+      <item> whl </item>
+      <item> whs </item>
+    </list>
+    <contexts>
+      <!-- Entry point -->
+      <context name="lilypond" attribute="Normal Text" lineEndContext="#stay">
+        <IncludeRules context="music"/>
+        <RegExpr String="\b[a-z]+\s*=" insensitive="true" lookAhead="true" context="assignment"/>
+      </context>
+      
+      <!-- Music expressions -->
+      <context name="music" attribute="Normal Text" lineEndContext="#stay">
+        <AnyChar String="()~" attribute="Slur"/>
+        <AnyChar String="[]" attribute="Beam"/>
+        <AnyChar String="-_^" context="connect"/>
+        <DetectChar char="\" context="musiccommand" lookAhead="true"/>
+        <IncludeRules context="default"/>
+        <DetectChar char="&lt;" attribute="Chord" context="chord"/>
+        <DetectChar char="&gt;" attribute="Invalid"/><!-- chord terminator outsite chord -->
+        <RegExpr String="[a-z]+\d+\.*[,']+" attribute="Invalid"/><!-- pitch-dur-octave i.s.o. pitch-oct-dur -->
+        <RegExpr String="(&rest;|&pitch;)" context="pitch"/>
+        <RegExpr String=":\d*" attribute="Tremolo"/>
+      </context>
+      
+      <!-- Default Lilypond code to be recognized e.g. also inside lyrics -->
+      <context name="default" attribute="Normal Text" lineEndContext="#stay">
+        <Detect2Chars char="&lt;" char1="&lt;" attribute="Keyword" beginRegion="simultaneous"/>
+        <Detect2Chars char="&gt;" char1="&gt;" attribute="Keyword" endRegion="simultaneous"/>
+        <DetectChar char="{" attribute="Keyword" beginRegion="sequential"/>
+        <DetectChar char="}" attribute="Keyword" endRegion="sequential"/>
+        <DetectChar char="|" attribute="Check"/>
+        <DetectChar char="\" context="command" lookAhead="true"/>
+        <IncludeRules context="basic"/>
+      </context>
+      
+      <!-- Basic Lilypond syntax that also works inside markup -->
+      <context name="basic" attribute="Normal Text" lineEndContext="#stay">
+        <Detect2Chars char="%" char1="{" context="commentblock" beginRegion="comment"/>
+        <DetectChar char="%" context="commentline"/>
+        <DetectChar char="&quot;" context="string"/>
+        <DetectChar char="#" context="scheme"/>
+        <DetectChar char="$" context="schemesub"/>
+      </context>
+      
+      <context name="musiccommand" attribute="Normal Text" lineEndContext="#pop"
+               fallthrough="true" fallthroughContext="#pop">
+        <RegExpr String="\\(&dynamics;)&b;" attribute="Dynamic"/>
+        <RegExpr String="\\[&lt;!&gt;]" attribute="Dynamic"/>
+        <RegExpr String="\\(&scripts;)&b;" attribute="Articulation"/>
+        <RegExpr String="\\[()]" attribute="Slur"/>
+        <RegExpr String="\\[][]" attribute="Beam"/>
+        <IncludeRules context="command"/>
+      </context>
+
+      <context name="command" attribute="Normal Text" lineEndContext="#pop"
+               fallthrough="true" fallthroughContext="#pop">
+        <Detect2Chars char="\" char1="\" attribute="Keyword"/>
+        <RegExpr String="\\note(mode|s)&b;" context="notemode"/>
+        <RegExpr String="\\drum(mode|s)&b;" context="drummode"/>
+        <RegExpr String="\\chord(mode|s)&b;" context="chordmode"/>
+        <RegExpr String="\\figure(mode|s)&b;" context="figuremode"/>
+        <RegExpr String="\\(lyric(mode|s)|addlyrics)&b;" context="lyricmode"/>
+        <RegExpr String="\\lyricsto&b;" context="lyricsto"/>
+        <RegExpr String="\\markup(lines)?&b;" attribute="Markup" context="markup"/>
+        <RegExpr String="\\(header|paper|layout|midi|with)\b" context="section"/>
+        <RegExpr String="\\(new|context|change)\b" attribute="Keyword" context="context"/>
+        <RegExpr String="\\(un)?set\b" attribute="Keyword" context="set"/>
+        <RegExpr String="\\(override(Property)?|revert)&b;" attribute="Keyword" context="override"/>
+        <RegExpr String="\\skip&b;" attribute="Command" context="duration"/>
+        <RegExpr String="\\(&keywords;)&b;" attribute="Keyword"/>
+        <RegExpr String="\\(&commands;)&b;" attribute="Command"/>
+        <RegExpr String="\\(&toplevelvars;)&b;" attribute="Variable"/>
+        <RegExpr String="\\(&deprecatedkeywords;)&b;" attribute="Deprecated Keyword"/>
+        <RegExpr String="\\(&deprecatedcommands;)&b;" attribute="Deprecated Command"/>
+        <RegExpr String="\\(translator|newcontext)\b" attribute="Deprecated Keyword" context="context"/>
+        <RegExpr String="\\property&b;" attribute="Deprecated Keyword" context="override"/>
+        <RegExpr String="\\[A-Za-z]+" attribute="User Command"/>
+        <DetectChar char="\" attribute="Invalid"/>
+      </context>
+        
+      <context name="assignment" attribute="Normal Text" lineEndContext="#pop">
+        <RegExpr String="\b(&toplevelvars;)\b" attribute="Variable" context="#pop"/>
+        <RegExpr String="[a-z]+" insensitive="true" attribute="User Command" context="#pop"/>
+      </context>
+        
+      <context name="pitch" attribute="Pitch" lineEndContext="#stay"
+               fallthrough="true" fallthroughContext="#pop">
+        <RegExpr String="=\s*('+|,+)?" attribute="Check"/>
+        <IncludeRules context="duration"/>
+      </context>
+      
+      <context name="duration" attribute="Normal Text" lineEndContext="#stay"
+               fallthrough="true" fallthroughContext="#pop">
+        <DetectSpaces attribute="Normal Text"/>
+        <RegExpr String="&duration;" attribute="Duration" context="#pop"/>
+        <RegExpr String="\d+" attribute="Invalid" context="#pop"/><!-- uncaught (wrong) durations -->
+      </context>
+      
+      <context name="chord" attribute="Normal Text" lineEndContext="#stay">
+        <DetectChar char="&gt;" context="chordend"/>
+        <RegExpr String="&pitch;" context="chordpitch"/>
+        <AnyChar String="&lt;{}srR" attribute="Invalid"/><!-- no rests in chord allowed -->
+        <IncludeRules context="music"/>
+      </context>
+      
+      <context name="chordpitch" attribute="Pitch" lineEndContext="#stay"
+               fallthrough="true" fallthroughContext="#pop">
+        <DetectSpaces attribute="Normal Text"/>
+        <RegExpr String="=\s*('+|,+)?" attribute="Check"/>
+        <RegExpr String="&duration;" attribute="Invalid" context="#pop"/><!-- no duration in chord allowed -->
+        <RegExpr String="\d+" attribute="Invalid" context="#pop"/><!-- catch other (wrong) durations as well -->
+      </context>
+      
+      <context name="chordend" attribute="Chord" lineEndContext="#stay"
+               fallthrough="true" fallthroughContext="#pop#pop">
+        <DetectSpaces attribute="Normal Text"/>
+        <RegExpr String="&duration;" attribute="Duration" context="#pop#pop"/>
+      </context>
+      
+      <context name="commentline" attribute="Comment" lineEndContext="#pop">
+        <IncludeRules context="##Alerts"/>
+      </context>
+      
+      <context name="commentblock" attribute="Comment" lineEndContext="#stay">
+        <Detect2Chars char="%" char1="}" attribute="Comment" context="#pop" endRegion="comment"/>
+        <IncludeRules context="##Alerts"/>
+      </context>
+      
+      <context name="string" attribute="Quoted Text" lineEndContext="#stay">
+        <DetectChar char="&quot;" attribute="Quoted Text" context="#pop"/>
+        <Detect2Chars char="\" char1="\"/>
+        <Detect2Chars char="\" char1="&quot;"/>
+      </context>
+      
+      <context name="connect" attribute="Articulation" lineEndContext="#stay"
+               fallthrough="true" fallthroughContext="#pop">
+        <AnyChar String=".-+|&gt;^_12345" attribute="Articulation" context="#pop"/>
+      </context>
+      
+      <!-- Scheme -->
+      <context name="scheme" attribute="Scheme" lineEndContext="#stay"
+               fallthrough="true" fallthroughContext="scheme2">
+        <DetectSpaces/>
+      </context>
+      
+      <context name="scheme2" attribute="Scheme" lineEndContext="#pop#pop">
+        <DetectChar char="(" attribute="Scheme Keyword" context="scheme3" beginRegion="scheme"/>
+        <IncludeRules context="schemerules"/>
+        <DetectSpaces lookAhead="true" context="#pop#pop"/>
+      </context>
+      
+      <context name="scheme3" attribute="Scheme" lineEndContext="#stay">
+        <DetectChar char=")" attribute="Scheme Keyword" context="#pop#pop#pop" endRegion="scheme"/>
+        <IncludeRules context="schemerules"/>
+      </context>
+      
+      <context name="schemerules" attribute="Scheme" lineEndContext="#stay">
+        <DetectChar char="(" context="schemerules" beginRegion="scheme"/>
+        <DetectChar char=")" context="#pop" endRegion="scheme"/>
+        <DetectChar char="&quot;" context="schemestring"/>
+        <DetectChar char=";" context="schemecommentline"/>
+        <DetectChar char="$" context="schemesub"/>
+        <DetectChar char="'" context="schemequote"/>
+        <Detect2Chars char="#" char1="!" context="schemecommentblock" beginRegion="schemecomment"/>
+        <Detect2Chars char="#" char1="{" attribute="Scheme Keyword" context="schemelily" beginRegion="schemelily"/>
+        <keyword String="musicexpressions" attribute="Scheme Keyword"/>
+        <keyword String="contexts" attribute="Scheme Keyword"/>
+        <keyword String="layoutobjects" attribute="Scheme Keyword"/>
+        <RegExpr String="[-+]?(\d+(\.\d+)?|\.\d+)" attribute="Scheme Value"/>
+        <RegExpr String="#(t|f|b[-+]?[01.]+|o[-+]?[0-7.]+|d[-+]?[0-9.]+|x[-+]?[0-9a-f.]+)"
+                 insensitive="true" attribute="Scheme Value"/>
+        <RegExpr String="[+-](inf|nan)\.0" attribute="Scheme Value"/>
+        <RegExpr String="&schemefunc;" attribute="Scheme Keyword"/>
+        <RegExpr String="&schemename;"/>
+      </context>
+      
+      <context name="schemequote" attribute="Scheme" lineEndContext="#pop"
+               fallthrough="true" fallthroughContext="#pop">
+        <RegExpr String="&schemefunc;"/>
+      </context>
+      
+      <context name="schemelily" attribute="Normal Text" lineEndContext="#stay">
+        <Detect2Chars char="#" char1="}" attribute="Scheme Keyword" context="#pop" endRegion="schemelily"/>
+        <IncludeRules context="lilypond"/>
+      </context>
+      
+      <context name="schemecommentline" attribute="Scheme Comment" lineEndContext="#pop">
+        <IncludeRules context="##Alerts"/>
+      </context>
+      
+      <context name="schemecommentblock" attribute="Scheme Comment" lineEndContext="#stay">
+        <Detect2Chars char="!" char1="#" attribute="Scheme Comment" context="#pop" endRegion="schemecomment"/>
+        <IncludeRules context="##Alerts"/>
+      </context>
+      
+      <context name="schemesub" attribute="Scheme Subst" lineEndContext="#pop"
+                fallthrough="true" fallthroughContext="#pop">
+        <RegExpr String="&schemename;" attribute="Scheme Subst" context="#pop"/>
+      </context>
+      
+      <context name="schemestring" attribute="Scheme String" lineEndContext="#stay">
+        <DetectChar char="&quot;" attribute="Scheme String" context="#pop"/>
+        <RegExpr String="\\[0fnrtav\\&quot;]"/>
+      </context>
+      
+      <!-- NoteMode -->
+      <context name="notemode" attribute="Other Mode" lineEndContext="#stay"
+               fallthrough="true" fallthroughContext="#pop">
+        <DetectChar char="{" attribute="Keyword" context="notemode2" beginRegion="sequential"/>
+        <DetectSpaces/>
+      </context>
+      
+      <context name="notemode2" attribute="Normal Text" lineEndContext="#stay">
+        <DetectChar char="}" attribute="Keyword" context="#pop#pop" endRegion="sequential"/>
+        <IncludeRules context="noterules"/>
+      </context>
+      
+      <context name="noterules" attribute="Normal Text" lineEndContext="#stay">
+        <DetectChar char="{" attribute="Keyword" context="noterules" beginRegion="sequential"/>
+        <DetectChar char="}" attribute="Keyword" context="#pop" endRegion="sequential"/>
+        <IncludeRules context="music"/>
+      </context>
+      
+      <!-- Drummode -->
+      <context name="drummode" attribute="Other Mode" lineEndContext="#stay"
+               fallthrough="true" fallthroughContext="#pop">
+        <DetectChar char="{" attribute="Keyword" context="drummode2" beginRegion="sequential"/>
+        <DetectSpaces/>
+      </context>
+      
+      <context name="drummode2" attribute="Normal Text" lineEndContext="#stay">
+        <DetectChar char="}" attribute="Keyword" context="#pop#pop" endRegion="sequential"/>
+        <IncludeRules context="drumrules"/>
+      </context>
+      
+      <context name="drumrules" attribute="Normal Text" lineEndContext="#stay">
+        <DetectChar char="{" attribute="Keyword" context="drumrules" beginRegion="sequential"/>
+        <DetectChar char="}" attribute="Keyword" context="#pop" endRegion="sequential"/>
+        <keyword attribute="Other Text" String="drumpitchnames" context="duration"/>
+        <IncludeRules context="music"/>
+      </context>
+  
+      <!-- Chordmode -->
+      <context name="chordmode" attribute="Other Mode" lineEndContext="#stay"
+               fallthrough="true" fallthroughContext="#pop">
+        <DetectChar char="{" attribute="Keyword" context="chordmode2" beginRegion="sequential"/>
+        <DetectSpaces/>
+      </context>
+      
+      <context name="chordmode2" attribute="Normal Text" lineEndContext="#stay">
+        <DetectChar char="}" attribute="Keyword" context="#pop#pop" endRegion="sequential"/>
+        <IncludeRules context="chordrules"/>
+      </context>
+      
+      <context name="chordrules" attribute="Normal Text" lineEndContext="#stay">
+        <DetectChar char="{" attribute="Keyword" context="chordrules" beginRegion="sequential"/>
+        <DetectChar char="}" attribute="Keyword" context="#pop" endRegion="sequential"/>
+        <RegExpr attribute="Other Text" String=":?([\.^]?\d+[-+]?|(m|dim|aug|maj|sus)&b;)*(/\+?&pitch;)?"/>
+        <IncludeRules context="music"/>
+      </context>
+
+      <!-- Figuremode -->
+      <context name="figuremode" attribute="Other Mode" lineEndContext="#stay"
+               fallthrough="true" fallthroughContext="#pop">
+        <DetectChar char="{" attribute="Keyword" context="figuremode2" beginRegion="sequential"/>
+        <DetectSpaces/>
+      </context>
+      
+      <context name="figuremode2" attribute="Normal Text" lineEndContext="#stay">
+        <DetectChar char="}" attribute="Keyword" context="#pop#pop" endRegion="sequential"/>
+        <IncludeRules context="figurerules"/>
+      </context>
+      
+      <context name="figurerules" attribute="Normal Text" lineEndContext="#stay">
+        <DetectChar char="{" attribute="Keyword" context="figurerules" beginRegion="sequential"/>
+        <DetectChar char="}" attribute="Keyword" context="#pop" endRegion="sequential"/>
+        <DetectChar char="&lt;" attribute="Chord" context="figure"/>
+        <RegExpr String="&rest;" attribute="Pitch" context="duration"/>
+        <IncludeRules context="default"/>
+      </context>
+      
+      <context name="figure" attribute="Normal Text" lineEndContext="#stay">
+        <DetectChar char="&gt;" attribute="Chord" context="chordend"/>
+        <IncludeRules context="basic"/>
+        <RegExpr String="\\markup(lines)?&b;" attribute="Markup" context="markup"/>
+        <RegExpr String="\\skip&b;" attribute="Command" context="duration"/>
+      </context>
+
+      <!-- Lyrics -->
+      <context name="lyricmode" attribute="Lyricmode" lineEndContext="#stay"
+               fallthrough="true" fallthroughContext="#pop">
+        <DetectChar char="{" attribute="Keyword" context="lyricmode2" beginRegion="sequential"/>
+        <DetectSpaces/>
+      </context>
+      
+      <context name="lyricmode2" attribute="Lyric Text" lineEndContext="#stay">
+        <DetectChar char="}" attribute="Keyword" context="#pop#pop" endRegion="sequential"/>
+        <IncludeRules context="lyricrules"/>
+      </context>
+      
+      <!-- LyricsTo has extra parameter -->
+      <context name="lyricsto" attribute="Lyricmode" lineEndContext="#stay"
+               fallthrough="true" fallthroughContext="#pop">
+        <RegExpr String="&quot;(\\[&quot;\\]|[^&quot;\\])+&quot;" attribute="Quoted Text" context="lyricsto2"/>
+        <RegExpr String="[A-Za-z]+" attribute="Normal Text" context="lyricsto2"/>
+        <DetectSpaces/>
+      </context>
+      
+      <context name="lyricsto2" attribute="Normal Text" lineEndContext="#stay"
+               fallthrough="true" fallthroughContext="#pop#pop">
+        <DetectChar char="{" attribute="Keyword" context="lyricsto3" beginRegion="sequential"/>
+        <DetectSpaces/>
+      </context>
+
+      <context name="lyricsto3" attribute="Lyric Text" lineEndContext="#stay">
+        <DetectChar char="}" attribute="Keyword" context="#pop#pop#pop" endRegion="sequential"/>
+        <IncludeRules context="lyricrules"/>
+      </context>
+ 
+      <context name="lyricrules" attribute="Lyric Text" lineEndContext="#stay">
+        <DetectChar char="{" attribute="Keyword" context="lyricrules" beginRegion="sequential"/>
+        <DetectChar char="}" attribute="Keyword" context="#pop" endRegion="sequential"/>
+        <RegExpr String="(\w+-{2,}|\w+_{2,}|-{2,}\w+|_{2,}\w+)" attribute="Invalid"/><!-- two hyphens or underscores run together with a word -->
+        <RegExpr String="&duration;" attribute="Duration"/>
+        <RegExpr String="(--|__|_)" attribute="Lyricmode"/>
+        <IncludeRules context="default"/>
+        <RegExpr String="\S+\}" attribute="Invalid" context="#pop" endRegion="sequential"/>
+      </context>
+      
+      <!-- Markup -->
+      <context name="markup" attribute="Normal Text" lineEndContext="#stay"
+               fallthrough="true" fallthroughContext="#pop">
+        <DetectChar char="{" attribute="Keyword" context="markup2" beginRegion="markup"/>
+        <DetectSpaces/>
+        <RegExpr String="\\score\b" attribute="Markup" context="notemode"/>
+        <RegExpr String="\\(&markupwithtextargs;)&b;" attribute="Markup"/>
+        <RegExpr String="\\(&markupnotextargs;)&b;" attribute="Markup" context="#pop"/>
+        <DetectChar char="#" context="scheme"/>
+        <RegExpr String="[^&quot;\s\\#%{}$]+" attribute="Normal Text" context="#pop"/>
+      </context>
+      
+      <context name="markup2" attribute="Normal Text" lineEndContext="#stay">
+        <DetectChar char="}" attribute="Keyword" context="#pop#pop" endRegion="markup"/>
+        <IncludeRules context="markuprules"/>
+      </context>
+      
+      <context name="markuprules" attribute="Normal Text" lineEndContext="#stay">
+        <DetectChar char="}" attribute="Keyword" context="#pop" endRegion="markup"/>
+        <DetectChar char="{" attribute="Keyword" context="markuprules" beginRegion="markup"/>
+        <RegExpr String="\\score\b" attribute="Markup" context="notemode"/>
+        <RegExpr String="\\(&markupnotextargs;|&markupwithtextargs;)&b;" attribute="Markup"/>
+        <RegExpr String="\\(&deprecatedmarkup;)&b;" attribute="Deprecated Markup"/>
+        <RegExpr String="\\[A-Za-z]+(-[A-Za-z]+)*" attribute="User Command"/>
+        <IncludeRules context="basic"/>
+      </context>
+      
+      <!-- \paper, \layout, \midi, \header, \with -->
+      <context name="section" attribute="Keyword" lineEndContext="#stay"
+               fallthrough="true" fallthroughContext="#pop">
+        <DetectChar char="{" attribute="Keyword" context="section2" beginRegion="section"/>
+        <DetectSpaces/>
+      </context>
+      
+      <context name="section2" attribute="Normal Text" lineEndContext="#stay">
+        <DetectChar char="}" attribute="Keyword" context="#pop#pop" endRegion="section"/>
+        <IncludeRules context="sectionrules"/>
+      </context>
+      
+      <context name="sectionrules" attribute="Normal Text" lineEndContext="#stay">
+        <DetectChar char="}" attribute="Keyword" context="#pop" endRegion="section"/>
+        <DetectChar char="{" attribute="Keyword" context="sectionrules" beginRegion="section"/>
+        <keyword String="contexts" attribute="Context"/>
+        <keyword String="layoutobjects" attribute="Layout Object"/>
+        <keyword String="properties" attribute="Property"/>
+        <keyword String="deprecatedproperties" attribute="Deprecated Property"/>
+        <RegExpr String="\b(&headervars;|&papervars;|&layoutvars;)\b" attribute="Variable"/>
+        <RegExpr String="(&quot;?)\b(&engravers;)\b\1" attribute="Engraver"/>
+        <IncludeRules context="default"/>
+      </context>
+      
+      <!-- \new, \context, \change -->
+      <context name="context" attribute="Normal Text" lineEndContext="#stay"
+               fallthrough="true" fallthroughContext="#pop">
+        <DetectSpaces/>
+        <keyword String="contexts" attribute="Context" context="context2"/>
+        <RegExpr String="[A-Za-z]+" attribute="User Command" context="context2"/>
+        <DetectChar char="{" attribute="Keyword" context="section2" beginRegion="section"/>
+      </context>
+      
+      <context name="context2" attribute="Normal Text" lineEndContext="#stay"
+               fallthrough="true" fallthroughContext="#pop#pop">
+        <DetectSpaces/>
+        <RegExpr String="=(\s*[A-Za-z]+)?" attribute="Normal Text" context="#pop#pop"/>
+      </context>
+      
+      <!-- \set, \unset -->
+      <context name="set" attribute="Normal Text" lineEndContext="#stay"
+               fallthrough="true" fallthroughContext="#pop">
+        <DetectSpaces/>
+        <keyword String="contexts" attribute="Context"/>
+        <DetectChar char="."/>
+        <keyword String="properties" attribute="Property" context="#pop"/>
+        <keyword String="deprecatedproperties" attribute="Deprecated Property" context="#pop"/>
+        <RegExpr String="[A-Za-z]+" attribute="User Command" context="#pop"/>
+      </context>
+      
+      <!-- \override, \overrideProperty, \revert -->
+      <context name="override" attribute="Normal Text" lineEndContext="#stay"
+               fallthrough="true" fallthroughContext="#pop">
+        <DetectSpaces/>
+        <keyword String="contexts" attribute="Context"/>
+        <DetectChar char="."/>
+        <keyword String="layoutobjects" attribute="Layout Object" context="#pop"/>
+        <RegExpr String="[A-Za-z]+(?=\s*\.)" attribute="User Command"/>
+        <RegExpr String="[A-Za-z]+" attribute="User Command" context="#pop"/>
+      </context>
+    </contexts>
+    <itemDatas>
+      <itemData name="Pitch" defStyleNum="dsNormal"/>
+      <itemData name="Duration" defStyleNum="dsDataType"/>
+      <itemData name="Slur" defStyleNum="dsChar" bold="true"/>
+      <itemData name="Dynamic" defStyleNum="dsString" color="#ee5000" bold="true"/>
+      <itemData name="Articulation" defStyleNum="dsString" color="#ee5000" bold="true"/>
+      <itemData name="Chord" defStyleNum="dsDataType" bold="true"/>
+      <itemData name="Beam" defStyleNum="dsDataType" bold="true"/>
+      <itemData name="Check" defStyleNum="dsDecVal"/>
+      <itemData name="Repeat" defStyleNum="dsDataType" italic="true"/>
+      <itemData name="Keyword" defStyleNum="dsKeyword"/>
+      <itemData name="Command" defStyleNum="dsFunction" bold="true"/>
+      <itemData name="User Command" defStyleNum="dsFunction"/>
+      <itemData name="Context" defStyleNum="dsDataType" bold="true"/>
+      <itemData name="Layout Object" defStyleNum="dsDataType"/>
+      <itemData name="Property" defStyleNum="dsDataType"/>
+      <itemData name="Variable" defStyleNum="dsDataType"/>
+      <itemData name="Engraver" defStyleNum="dsDataType"/>
+      <itemData name="Markup" defStyleNum="dsBaseN" color="#009817"/>
+      <itemData name="Lyricmode" defStyleNum="dsKeyword" color="#007010"/>
+      <itemData name="Lyric Text" defStyleNum="dsNormal" color="#007010"/>
+      <itemData name="Other Mode" defStyleNum="dsKeyword" color="#0094e4"/>
+      <itemData name="Other Text" defStyleNum="dsNormal" color="#0094e4"/>
+      <itemData name="Normal Text" defStyleNum="dsNormal"/>
+      <itemData name="Quoted Text" defStyleNum="dsString"/>
+      <itemData name="Comment" defStyleNum="dsComment"/>
+      <itemData name="Scheme" defStyleNum="dsFloat" backgroundColor="#fff6ff"/>
+      <itemData name="Scheme Keyword" defStyleNum="dsFloat" bold="true" backgroundColor="#fff6ff"/>
+      <itemData name="Scheme Subst" defStyleNum="dsDecVal" bold="true" backgroundColor="#fff6ff"/>
+      <itemData name="Scheme Value" defStyleNum="dsDecVal" backgroundColor="#fff6ff"/>
+      <itemData name="Scheme String" defStyleNum="dsString" backgroundColor="#fff6ff"/>
+      <itemData name="Scheme Comment" defStyleNum="dsComment" backgroundColor="#fff6ff"/>
+      <itemData name="Deprecated Keyword" defStyleNum="dsKeyword" backgroundColor="#fcc"/>
+      <itemData name="Deprecated Command" defStyleNum="dsFunction" backgroundColor="#fcc"/>
+      <itemData name="Deprecated Property" defStyleNum="dsDataType" backgroundColor="#fcc"/>
+      <itemData name="Deprecated Markup" defStyleNum="dsBaseN" color="#009817" backgroundColor="#fcc"/>
+      <itemData name="Invalid" defStyleNum="dsError"/>
+    </itemDatas>
+  </highlighting>
   <general>
     <comments>
-      <comment name="singleLine" start="%" />
+      <comment name="singleLine" start="%"/>
+      <comment name="multiLine" start="%{" end="%}" region="comment"/>
     </comments>
-    <keywords casesensitive="true" weakDeliminator="\" />
+    <keywords casesensitive="true" additionalDeliminator="'_0123456789"/>
   </general>
+  
 </language>
+<!--
+    // kate: space-indent on; indent-width 2; replace-tabs on; dynamic-word-wrap off;
+    -->
Index: kate/data/language.dtd
===================================================================
--- kate/data/language.dtd	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kate/data/language.dtd	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -450,6 +450,8 @@
   bold          CDATA   #IMPLIED        Whether this attribute should be renederd using a bold typeface [optional, boolean, default=false]
   underline     CDATA   #IMPLIED        Whether this attribute should be underlined [optional, boolean, default=false]
   strikeout     CDATA   #IMPLIED        Whether this attribute should be striked out [optional, boolean, default=false]
+  backgroundColor    CDATA #IMPLIED     The background color for this style [optional]
+  selBackgroundColor CDATA #IMPLIED     The background color for this style when text is selected [optional]
 -->
 <!ELEMENT itemData EMPTY>
 <!ATTLIST itemData
@@ -461,4 +463,6 @@
   bold          (%boolean;) #IMPLIED
   underline     (%boolean;) #IMPLIED
   strikeout     (%boolean;) #IMPLIED
+  backgroundColor    CDATA  #IMPLIED
+  selBackgroundColor CDATA  #IMPLIED
 >
Index: mimetypes/multipart/x-mixed-replace.desktop
===================================================================
--- mimetypes/multipart/x-mixed-replace.desktop	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ mimetypes/multipart/x-mixed-replace.desktop	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -18,7 +18,7 @@
 Comment[de]=Datenstrom (Server Push)
 Comment[el]=   ( )
 Comment[eo]=Datumfluo (servosendata)
-Comment[es]=Flujo de datos (envio del servidor)
+Comment[es]=Flujo de datos (envo del servidor)
 Comment[et]=Andmevoog (server push)
 Comment[eu]=Datu korrontea (Server push)
 Comment[fa]= (  )
Index: mimetypes/application/x-tex-pk.desktop
===================================================================
--- mimetypes/application/x-tex-pk.desktop	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ mimetypes/application/x-tex-pk.desktop	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -17,7 +17,7 @@
 Comment[de]=Schriftpaket
 Comment[el]=Packed 
 Comment[eo]=Pakita tipardosiero
-Comment[es]=Fuente empaquetada
+Comment[es]=Tipo de letra empaquetado
 Comment[et]=Pakitud fondifail
 Comment[eu]=Letra-tipo paketatua
 Comment[fa]= 
Index: mimetypes/application/x-font-speedo.desktop
===================================================================
--- mimetypes/application/x-font-speedo.desktop	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ mimetypes/application/x-font-speedo.desktop	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -21,7 +21,7 @@
 Comment[de]=Speedo-Schriftart
 Comment[el]= Speedo
 Comment[eo]=Speedo-Tiparo
-Comment[es]=Fuente Speedo
+Comment[es]=Tipo de letra Speedo
 Comment[et]=Speedo font
 Comment[eu]=Speedo-ren letra-tipoa
 Comment[fa]= Speedo
Index: mimetypes/application/x-font-ghostscript.desktop
===================================================================
--- mimetypes/application/x-font-ghostscript.desktop	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ mimetypes/application/x-font-ghostscript.desktop	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -21,7 +21,7 @@
 Comment[de]=Ghostscript-Schrift
 Comment[el]= Ghostscript
 Comment[eo]=Postskripta tiparo
-Comment[es]=Fuente Ghostscript
+Comment[es]=Tipo de letra Ghostscript
 Comment[et]=Ghostscripti font
 Comment[eu]=Ghostscript-en letra-tipoa
 Comment[fa]= Ghostscript
Index: mimetypes/application/x-font-otf.desktop
===================================================================
--- mimetypes/application/x-font-otf.desktop	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ mimetypes/application/x-font-otf.desktop	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -17,7 +17,7 @@
 Comment[de]=OpenType-Schrift
 Comment[el]= OpenType
 Comment[eo]=OpenType-Tiparo
-Comment[es]=Fuente OpenType
+Comment[es]=Tipo de letra OpenType
 Comment[et]=OpenType'i font
 Comment[eu]=OpenType-en letra-tipoa
 Comment[fa]=  
Index: mimetypes/application/x-font-pcf.desktop
===================================================================
--- mimetypes/application/x-font-pcf.desktop	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ mimetypes/application/x-font-pcf.desktop	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -21,7 +21,7 @@
 Comment[de]=PCF-Bitmap-Schrift
 Comment[el]= PCF bitmap
 Comment[eo]=PCF-bitmapa tiparo
-Comment[es]=Fuente bitmap PCF
+Comment[es]=Tipo de letra bitmap PCF
 Comment[et]=PCF bittrasterfont
 Comment[eu]=PCF bitmap-en letra-tipoa
 Comment[fa]=   PCF
Index: mimetypes/application/x-designer.desktop
===================================================================
--- mimetypes/application/x-designer.desktop	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ mimetypes/application/x-designer.desktop	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -44,7 +44,7 @@
 Comment[mn]=Qt-Designer-
 Comment[ms]=Fail Qt Designer
 Comment[mt]=Fajl Qt Designer
-Comment[nb]=QT-designer fil
+Comment[nb]=Qt-designer-fil
 Comment[nds]="Qt Designer"-Datei
 Comment[ne]=Qt  
 Comment[nl]=Qt Designer-bestand
Index: mimetypes/application/x-java-applet.desktop
===================================================================
--- mimetypes/application/x-java-applet.desktop	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ mimetypes/application/x-java-applet.desktop	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -15,7 +15,7 @@
 Comment[cy]=Rhaglennig Java
 Comment[da]=Java-applet
 Comment[de]=Java-Programm
-Comment[el]= Java
+Comment[el]= Java
 Comment[eo]=Javaplikao
 Comment[es]=Applet de Java
 Comment[et]=Java aplett
Index: mimetypes/application/x-font-snf.desktop
===================================================================
--- mimetypes/application/x-font-snf.desktop	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ mimetypes/application/x-font-snf.desktop	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -21,7 +21,7 @@
 Comment[de]=SNF-Bitmap-Schrift
 Comment[el]= SNF bitmap
 Comment[eo]=SNF-bitmapa tiparo
-Comment[es]=Fuente bitmap SNF
+Comment[es]=Tipo de letra bitmap SNF
 Comment[et]=SNF bittrasterfont
 Comment[eu]=SNF bitmap-en letra-tipoa
 Comment[fa]=   SNF
Index: mimetypes/application/x-font-ttc.desktop
===================================================================
--- mimetypes/application/x-font-ttc.desktop	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ mimetypes/application/x-font-ttc.desktop	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -17,7 +17,7 @@
 Comment[de]=TrueType-Schriftensammlung
 Comment[el]=  TrueType
 Comment[eo]=TrueType-Tiparkolekto
-Comment[es]=Coleccin de fuentes TrueType
+Comment[es]=Coleccin de tipos de letra TrueType
 Comment[et]=TrueType fondikogu
 Comment[eu]=TrueType letra-tipoen bilduma
 Comment[fa]=  
Index: mimetypes/application/x-font-ttf.desktop
===================================================================
--- mimetypes/application/x-font-ttf.desktop	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ mimetypes/application/x-font-ttf.desktop	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -17,7 +17,7 @@
 Comment[de]=TrueType-Schrift
 Comment[el]= TrueType
 Comment[eo]=TrueType-Tiparo
-Comment[es]=Fuente TrueType
+Comment[es]=Tipo de letra TrueType
 Comment[et]=TrueType font
 Comment[eu]=TrueType letra-tipoa
 Comment[fa]= 
Index: mimetypes/application/x-afm.desktop
===================================================================
--- mimetypes/application/x-afm.desktop	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ mimetypes/application/x-afm.desktop	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -16,7 +16,7 @@
 Comment[de]=Metrische Informationen fr PostScript-Schrift
 Comment[el]=  PostScript
 Comment[eo]=Postskripto-1-Tiparo
-Comment[es]=Mtrica de fuentes Postscript.
+Comment[es]=Mtrica de tipo de letra Postscript.
 Comment[et]=PostScript fondimeetrika (PFM)
 Comment[eu]=PostScript letra-tipoen metrika
 Comment[fa]=  
Index: mimetypes/application/x-javascript.desktop
===================================================================
--- mimetypes/application/x-javascript.desktop	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ mimetypes/application/x-javascript.desktop	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -17,7 +17,7 @@
 Comment[de]=JavaScript-Datei
 Comment[el]=  JavaScript
 Comment[eo]=Javskripta dosiero
-Comment[es]=Archivo JavaScipt
+Comment[es]=Archivo JavaScript
 Comment[et]=JavaScripti fail
 Comment[eu]=JavaScript fitxategia
 Comment[fa]= 
Index: mimetypes/application/x-tex-gf.desktop
===================================================================
--- mimetypes/application/x-tex-gf.desktop	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ mimetypes/application/x-tex-gf.desktop	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -17,7 +17,7 @@
 Comment[de]=Generische Schrift
 Comment[el]= 
 Comment[eo]=Genera tipardosiero
-Comment[es]=Fuente genrica
+Comment[es]=Tipo de letra genrico
 Comment[et]=ldine fondifail
 Comment[eu]=Letra-tipo generikoa
 Comment[fa]= 
Index: mimetypes/application/x-font-bdf.desktop
===================================================================
--- mimetypes/application/x-font-bdf.desktop	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ mimetypes/application/x-font-bdf.desktop	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -21,7 +21,7 @@
 Comment[de]=BDF-Bitmap-Schrift
 Comment[el]= BDF bitmap
 Comment[eo]=BDF-bitmapa tiparo
-Comment[es]=Fuente bitmap BDF
+Comment[es]=Tipo de letra bitmap BDF
 Comment[et]=BDF bittrasterfont
 Comment[eu]=BDF bitmap letra-tipoa
 Comment[fa]=   BDF
Index: mimetypes/application/x-font-type1.desktop
===================================================================
--- mimetypes/application/x-font-type1.desktop	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ mimetypes/application/x-font-type1.desktop	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -21,7 +21,7 @@
 Comment[de]=Type1-Schrift
 Comment[el]= PostScript Type1
 Comment[eo]=Postskripto-1-Tiparo
-Comment[es]=Fuente Postscript Tipo1
+Comment[es]=Tipo de letra Postscript tipo 1
 Comment[et]=PostScript Type1 font
 Comment[eu]=PostScript Type1 letra-tipoa
 Comment[fa]=   
Index: mimetypes/text/javascript.desktop
===================================================================
--- mimetypes/text/javascript.desktop	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ mimetypes/text/javascript.desktop	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -16,7 +16,7 @@
 Comment[de]=JavaScript-Datei
 Comment[el]=  JavaScript
 Comment[eo]=Javskripta dosiero
-Comment[es]=Archivo JavaScipt
+Comment[es]=Archivo JavaScript
 Comment[et]=JavaScripti fail
 Comment[eu]=JavaScript fitxategia
 Comment[fa]= 
Index: kioslave/http/kcookiejar/kcookiejar.cpp
===================================================================
--- kioslave/http/kcookiejar/kcookiejar.cpp	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kioslave/http/kcookiejar/kcookiejar.cpp	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -340,7 +340,7 @@
     bool secureRequest = (_url.find( L1("https://"), 0, false) == 0 ||
                           _url.find( L1("webdavs://"), 0, false) == 0);
 
-    kdDebug(7104) << "findCookies: URL= " << _url << ", secure = " << secureRequest << endl;
+    // kdDebug(7104) << "findCookies: URL= " << _url << ", secure = " << secureRequest << endl;
 
     extractDomains(fqdn, domains);
 
@@ -991,7 +991,7 @@
 #ifdef MAX_COOKIE_LIMIT
         if (cookieList->count() >= MAX_COOKIES_PER_HOST)
            makeRoom(cookieList, cookiePtr); // Delete a cookie
-#endif           
+#endif
         cookieList->inSort( cookiePtr );
         m_cookiesChanged = true;
     }
@@ -1016,7 +1016,7 @@
     extractDomains(cookiePtr->host(), domains);
 
     // If the cookie specifies a domain, check whether it is valid. Otherwise,
-    // accept the cookie anyways but removes the domain="" value to prevent
+    // accept the cookie anyways but remove the domain="" value to prevent
     // cross-site cookie injection.
     if (!cookiePtr->domain().isEmpty())
     {
Index: kioslave/http/http.cc
===================================================================
--- kioslave/http/http.cc	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kioslave/http/http.cc	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -3409,10 +3409,6 @@
 
   } while (!m_bEOF && (len || noHeader) && (headerSize < maxHeaderSize) && (gets(buffer, sizeof(buffer)-1)));
 
-  // Send the current response before processing starts or it
-  // might never get sent...
-  forwardHttpResponseHeader();
-
   // Now process the HTTP/1.1 upgrade
   QStringList::Iterator opt = upgradeOffers.begin();
   for( ; opt != upgradeOffers.end(); ++opt) {
@@ -3818,6 +3814,10 @@
     mimeType( m_strMimeType );
   }
 
+  // Do not move send response header before any redirection as it seems
+  // to screw up some sites. See BR# 150904.
+  forwardHttpResponseHeader();
+
   if (m_request.method == HTTP_HEAD)
      return true;
 
@@ -3830,10 +3830,10 @@
         // Check...
         createCacheEntry(m_strMimeType, expireDate); // Create a cache entry
         if (!m_request.fcache)
-	    {
-		m_request.bCachedWrite = false; // Error creating cache entry.
-		kdDebug(7113) << "(" << m_pid << ") Error creating cache entry for " << m_request.url.url()<<"!\n";
-	    }
+        {
+          m_request.bCachedWrite = false; // Error creating cache entry.
+          kdDebug(7113) << "(" << m_pid << ") Error creating cache entry for " << m_request.url.url()<<"!\n";
+        }
         m_request.expireDate = expireDate;
         m_maxCacheSize = config()->readNumEntry("MaxCacheSize", DEFAULT_MAX_CACHE_SIZE) / 2;
      }
Index: kinit/start_kdeinit_wrapper.c
===================================================================
--- kinit/start_kdeinit_wrapper.c	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kinit/start_kdeinit_wrapper.c	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -85,7 +85,7 @@
    if(argc == 0)
       return 1;
    argv[0] = "start_kdeinit";
-   execv("start_kdeinit",argv);
+   execvp("start_kdeinit",argv);
    perror("start_kdeinit");
    return 1;
 }
Index: kio/kio/karchive.cpp
===================================================================
--- kio/kio/karchive.cpp	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kio/kio/karchive.cpp	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -204,6 +204,7 @@
     QDir dir( path );
     if ( !dir.exists() )
         return false;
+    dir.setFilter(dir.filter() | QDir::Hidden);
     QStringList files = dir.entryList();
     for ( QStringList::Iterator it = files.begin(); it != files.end(); ++it )
     {
Index: kio/kio/krun.cpp
===================================================================
--- kio/kio/krun.cpp	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kio/kio/krun.cpp	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -615,11 +615,17 @@
               return false; // no startup notification at all
       }
       else
-      { // Create startup notification even for apps for which there shouldn't be any,
+      {
+#if 0
+        // Create startup notification even for apps for which there shouldn't be any,
         // just without any visual feedback. This will ensure they'll be positioned on the proper
         // virtual desktop, and will get user timestamp from the ASN ID.
           wmclass = "0";
           silent = true;
+#else   // That unfortunately doesn't work, when the launched non-compliant application
+        // launches another one that is compliant and there is any delay inbetween (bnc:#343359)
+          return false;
+#endif
       }
   }
   if( silent_arg != NULL )
Index: kio/kio/kservice.cpp
===================================================================
--- kio/kio/kservice.cpp	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kio/kio/kservice.cpp	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -109,6 +109,7 @@
   entryMap.remove("Hidden");
   if (m_bDeleted)
   {
+    //kdDebug() << "Hidden=true for " << entryPath() << endl;
     m_bValid = false;
     return;
   }
@@ -119,6 +120,8 @@
   {
     if (config->readEntry( "Exec" ).isEmpty())
     {
+      //kdWarning(7012) << "The desktop entry file " << entryPath()
+      //              << " has no Name and no Exec" << endl;
       m_bValid = false;
       return;
     }
@@ -152,6 +155,7 @@
 
   // In case Try Exec is set, check if the application is available
   if (!config->tryExec()) {
+      //kdDebug(7012) << "tryExec said false for " << entryPath() << endl;
       m_bDeleted = true;
       m_bValid = false;
       return;
@@ -207,7 +211,8 @@
   m_strGenName = config->readEntry( "GenericName" );
   entryMap.remove("GenericName");
   QString untranslatedGenericName = config->readEntryUntranslated( "GenericName" );
-  entryMap.insert("UntranslatedGenericName", untranslatedGenericName);
+  if (!untranslatedGenericName.isEmpty())
+    entryMap.insert("UntranslatedGenericName", untranslatedGenericName);
 
   m_lstKeywords = config->readListEntry("Keywords");
   entryMap.remove("Keywords");
@@ -254,7 +259,7 @@
   QMap<QString,QString>::ConstIterator it = entryMap.begin();
   for( ; it != entryMap.end();++it)
   {
-//     qWarning("   Key = %s Data = %s", it.key().latin1(), it.data().latin1());
+     //qDebug("   Key = %s Data = %s", it.key().latin1(), it.data().latin1());
      m_mapProps.insert( it.key(), QVariant( it.data()));
   }
 }
Index: kio/misc/kpac/script.cpp
===================================================================
--- kio/misc/kpac/script.cpp	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kio/misc/kpac/script.cpp	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -64,7 +64,7 @@
         static Address parse( const UString& ip )
             { return Address( ip.qstring(), true ); }
 
-        operator const in_addr_t() const {
+        operator in_addr_t() const {
           const sockaddr_in* sin = m_address;
           return sin->sin_addr.s_addr;
         }
@@ -167,7 +167,7 @@
         virtual Value call( ExecState* exec, Object&, const List& args )
         {
             if ( args.size() != 1 ) return Undefined();
-            try { Address::resolve( args[ 0 ].toString( exec ) ); }
+            try { ::Address::resolve( args[ 0 ].toString( exec ) ); }
             catch ( const Address::Error& ) { return Boolean( false ); }
             return Boolean( true );
         }
@@ -202,7 +202,7 @@
         virtual Value call( ExecState* exec, Object&, const List& args )
         {
             if ( args.size() != 1 ) return Undefined();
-            try { return Address::resolve( args[ 0 ].toString( exec ) ); }
+            try { return String(Address::resolve( args[ 0 ].toString( exec ))); }
             catch ( const Address::Error& ) { return Undefined(); }
         }
     };
@@ -217,7 +217,7 @@
             char hostname[ 256 ];
             gethostname( hostname, 255 );
             hostname[ 255 ] = 0;
-            try { return Address::resolve( hostname ); }
+            try { return String(Address::resolve( hostname )); }
             catch ( const Address::Error& ) { return Undefined(); }
         }
     };
Index: kio/misc/kpac/eventsrc
===================================================================
--- kio/misc/kpac/eventsrc	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kio/misc/kpac/eventsrc	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -41,7 +41,7 @@
 Comment[mk]=   
 Comment[mn]=  
 Comment[ms]=Penyelarasan Proksi Automatik
-Comment[nb]=Automatisk mellomtjenerinstilling
+Comment[nb]=Automatisk mellomtjenerinnstilling
 Comment[nds]=Proxy automaatsch instellen
 Comment[ne]=  
 Comment[nl]=Automatische proxyconfiguratie
Index: kio/misc/kio_uiserver.desktop
===================================================================
--- kio/misc/kio_uiserver.desktop	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kio/misc/kio_uiserver.desktop	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -23,7 +23,7 @@
 Comment[bn]=...   UI 
 Comment[br]=Servijer stlenn EA Progress KDE
 Comment[bs]=KDEov Progess Info UI server
-Comment[ca]=Servidor de l'informaci de progrs del KDE
+Comment[ca]=Servidor d'informaci de progrs del KDE
 Comment[cs]=UI server zobrazujc informace o prbhu
 Comment[csb]=Serwer wdowidz  pkrk proces
 Comment[cy]=Gweinydd UI KDE i Ddangos Cynnydd
Index: kabc/scripts/addressee.src.cpp
===================================================================
--- kabc/scripts/addressee.src.cpp	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kabc/scripts/addressee.src.cpp	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -379,9 +379,11 @@
     text = e;
   else {
     QRegExp needQuotes( "[^ 0-9A-Za-z\\x0080-\\xFFFF]" );
-    if ( realName().find( needQuotes ) != -1 )
-      text = "\"" + realName() + "\" <" + e + ">";
-    else
+    if ( realName().find( needQuotes ) != -1 ) {
+      QString name = realName();
+      name.replace( "\"", "\\\"" );
+      text = "\"" + name + "\" <" + e + ">";
+    } else
       text = realName() + " <" + e + ">";
   }
 
Index: kabc/vcardformatplugin.cpp
===================================================================
--- kabc/vcardformatplugin.cpp	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kabc/vcardformatplugin.cpp	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -41,7 +41,7 @@
   QString data;
 
   QTextStream t( file );
-  t.setEncoding( QTextStream::UnicodeUTF8 );
+  t.setEncoding( QTextStream::Latin1 );
   data = t.read();
 
   VCardConverter converter;
@@ -60,7 +60,7 @@
   QString data;
 
   QTextStream t( file );
-  t.setEncoding( QTextStream::UnicodeUTF8 );
+  t.setEncoding( QTextStream::Latin1 );
   data = t.read();
 
   VCardConverter converter;
Index: kabc/vcardconverter.h
===================================================================
--- kabc/vcardconverter.h	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kabc/vcardconverter.h	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -40,11 +40,8 @@
   QFile file( "myfile.vcf" );
   file.open( IO_ReadOnly );
   
-  QTextStream s( &file );
-  s.setEncoding( QTextStream::UnicodeUTF8 );
+  QString data = file.readAll();
 
-  QString data = s.read();
-
   VCardConverter converter;
   Addressee::List list = converter.parseVCards( data );
 
Index: kabc/plugins/net/net.desktop
===================================================================
--- kabc/plugins/net/net.desktop	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kabc/plugins/net/net.desktop	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -37,6 +37,7 @@
 Name[kk]=
 Name[km]=
 Name[ko]=
+Name[ku]=Tor
 Name[lb]=Netzwierk
 Name[lt]=Tinklas
 Name[lv]=Tkls
Index: kabc/plugins/dir/dir.desktop
===================================================================
--- kabc/plugins/dir/dir.desktop	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kabc/plugins/dir/dir.desktop	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -38,6 +38,7 @@
 Name[kk]=
 Name[km]=
 Name[ko]=
+Name[ku]=Peldank
 Name[lb]=Verzeechnis
 Name[lt]=Aplankas
 Name[lv]=Direktorija
Index: kabc/kabc_manager.desktop
===================================================================
--- kabc/kabc_manager.desktop	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kabc/kabc_manager.desktop	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -34,6 +34,7 @@
 Name[ja]=
 Name[kk]=
 Name[km]=
+Name[ku]=Tekil
 Name[lb]=Kontakter
 Name[lt]=Kontaktai
 Name[lv]=Kontakti
Index: kabc/vcardparser/testread.cpp
===================================================================
--- kabc/vcardparser/testread.cpp	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kabc/vcardparser/testread.cpp	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -70,7 +70,7 @@
   QString text;
 
   QTextStream s( &file );
-  s.setEncoding( QTextStream::UnicodeUTF8 );
+  s.setEncoding( QTextStream::Latin1 );
   text = s.read();
   file.close();
 
Index: kabc/vcardparser/vcardparser.cpp
===================================================================
--- kabc/vcardparser/vcardparser.cpp	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kabc/vcardparser/vcardparser.cpp	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -19,6 +19,7 @@
 */
 
 #include <qregexp.h>
+#include <qtextcodec.h>
 
 #include <kmdcodec.h>
 
@@ -129,31 +130,44 @@
 
         removeEscapes( value );
 
+        QByteArray output;
+        bool wasBase64Encoded = false;
+
         params = vCardLine.parameterList();
         if ( params.findIndex( "encoding" ) != -1 ) { // have to decode the data
-          QByteArray input, output;
-          input = value.local8Bit();
+          QByteArray input;
+          input = QCString(value.latin1());
           if ( vCardLine.parameter( "encoding" ).lower() == "b" ||
-               vCardLine.parameter( "encoding" ).lower() == "base64" )
+               vCardLine.parameter( "encoding" ).lower() == "base64" ) {
             KCodecs::base64Decode( input, output );
+            wasBase64Encoded = true;
+          }
           else if ( vCardLine.parameter( "encoding" ).lower() == "quoted-printable" ) {
             // join any qp-folded lines
             while ( value.at( value.length() - 1 ) == '=' && it != linesEnd ) {
               value = value.remove( value.length() - 1, 1 ) + (*it);
               ++it;
             }
-            input = value.local8Bit();
+            input = QCString(value.latin1());
             KCodecs::quotedPrintableDecode( input, output );
           }
-          if ( vCardLine.parameter( "charset" ).lower() == "utf-8" ) {
-            vCardLine.setValue( QString::fromUtf8( output.data(), output.size() ) );
+        } else {
+          output = QCString(value.latin1());
+        }
+
+        if ( params.findIndex( "charset" ) != -1 ) { // have to convert the data
+          QTextCodec *codec =
+            QTextCodec::codecForName( vCardLine.parameter( "charset" ).latin1() );
+          if ( codec ) {
+            vCardLine.setValue( codec->toUnicode( output ) );
           } else {
+            vCardLine.setValue( QString::fromUtf8( output ) );
+          }
+        } else if ( wasBase64Encoded ) {
             vCardLine.setValue( output );
-          }
-        } else if ( vCardLine.parameter( "charset" ).lower() == "utf-8" ) {
-          vCardLine.setValue( QString::fromUtf8( value.ascii() ) );
-        } else
-          vCardLine.setValue( value );
+        } else {  // if charset not given, assume it's in UTF-8 (as used in previous KDE versions)
+            vCardLine.setValue( QString::fromUtf8( output ) );
+        }
 
         currentVCard.addLine( vCardLine );
       }
Index: kdecore/kstandarddirs.cpp
===================================================================
--- kdecore/kstandarddirs.cpp	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kdecore/kstandarddirs.cpp	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -923,13 +923,13 @@
 #endif
     QFileInfo info;
 
-    // absolute path ?
-    if (!QDir::isRelativePath(real_appname))
+    // absolute or relative path given
+    if (real_appname.find(QDir::separator()) >= 0)
     {
         info.setFile( real_appname );
         if( info.exists() && ( ignore || info.isExecutable() )
             && info.isFile() ) {
-            return real_appname;
+            return info.absFilePath();
         }
         return QString::null;
     }
Index: kdecore/kcmdlineargs.cpp
===================================================================
--- kdecore/kcmdlineargs.cpp	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kdecore/kcmdlineargs.cpp	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -396,6 +396,8 @@
                int p = nextOption.find(' ');
                if (p > 0)
                   nextOption = nextOption.left(p);
+               if (nextOption[0] == '!')
+                  nextOption = nextOption.mid(1);
                if (strncmp(nextOption.data(), "no", 2) == 0)
                {
                   nextOption = nextOption.mid(2);
Index: kdecore/eventsrc
===================================================================
--- kdecore/eventsrc	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kdecore/eventsrc	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -614,7 +614,7 @@
 Comment=There is more than one possible match
 Comment[af]=Daar is meer as een moontlik ooreenkoms
 Comment[be]=   
-Comment[bg]=     
+Comment[bg]=     
 Comment[bn]=   
 Comment[br]=Tremen ur c'hendoare a zo
 Comment[bs]=Postoji vie od jednog mogueg pogotka
@@ -937,7 +937,7 @@
 Comment=There was a serious error causing the program to exit
 Comment[af]=Daar was 'n ernstige fout wat veroorsaak het dat die program beendig is.
 Comment[be]= ' ,      
-Comment[bg]=   ,     
+Comment[bg]=   ,     
 Comment[bn]=      
 Comment[br]=Ur fazi grevus a voe pennabeg mont er-maez ar goulev.
 Comment[bs]=Program je morao zavriti zbog ozbiljne greke
@@ -1404,7 +1404,7 @@
 Comment[ar]=        
 Comment[az]=ox ciddi bir xta yarand v proqram xmaa mcbur etdi
 Comment[be]=  ' ,      
-Comment[bg]=   ,     
+Comment[bg]=   ,     
 Comment[bn]=      
 Comment[br]=Ur fazi grevus-tre a c'hoarvezas, a lakas d'an nebeuta ar goulev da vont er-maez
 Comment[bs]=Dolo je do vrlo ozbiljne greke koja je uzrokovala najmanje prekid programa
@@ -1514,6 +1514,7 @@
 Name[kk]=
 Name[km]=
 Name[ko]=
+Name[ku]=Tketin
 Name[lb]=Umellen
 Name[lt]=Registracija
 Name[lv]=Pieteikties
@@ -1592,6 +1593,7 @@
 Comment[ja]=KDE 
 Comment[kk]=KDE  
 Comment[km]=KDE 
+Comment[ku]=KDE dest p dike
 Comment[lb]=KDE gtt gestart
 Comment[lt]=KDE pradeda darb
 Comment[lv]=Tiek startts KDE
@@ -1668,6 +1670,7 @@
 Name[kk]=
 Name[km]=
 Name[ko]=
+Name[ku]=Derketin
 Name[lb]=Ofmellen
 Name[lt]=Isiregistravimas
 Name[lv]=Atteikties
@@ -2544,6 +2547,7 @@
 Name[kk]=
 Name[km]=
 Name[ko]=
+Name[ku]=Pirs
 Name[lb]=Fro
 Name[lt]=Klausimas
 Name[lv]=Jautjums
Index: kdecore/kconfigbase.h
===================================================================
--- kdecore/kconfigbase.h	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kdecore/kconfigbase.h	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -2008,6 +2008,12 @@
 private:
   class KConfigBasePrivate;
   KConfigBasePrivate *d;
+
+  void writeEntry( const char *pKey, const QString &rValue,
+    bool bPersistent, bool bGlobal, bool bNLS, bool bExpand );
+  void writeEntry( const char *pKey, const QStringList &rValue,
+    char sep, bool bPersistent, bool bGlobal, bool bNLS, bool bExpand );
+
 };
 
 class KConfigGroupSaverPrivate;
Index: kdecore/all_languages.desktop
===================================================================
--- kdecore/all_languages.desktop	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kdecore/all_languages.desktop	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -1568,7 +1568,7 @@
 Name[da]=Kirkeslavisk
 Name[de]=Kirchenslawisch
 Name[eo]=Eklezia Slava
-Name[es]=Eslvo eclesistico
+Name[es]=Eslavo eclesistico
 Name[et]=Kirikuslaavi
 Name[eu]=Church Eslaviera
 Name[fa]=
@@ -5097,6 +5097,7 @@
 Name[kk]=
 Name[km]=
 Name[ko]=
+Name[ku]=Kurd
 Name[lb]=Kurdesch
 Name[lt]=Kurd
 Name[lv]=Kurdu
@@ -6165,6 +6166,7 @@
 Name[kk]=
 Name[km]=
 Name[ko]=
+Name[ku]=Mongol
 Name[lb]=Mongolesch
 Name[lt]=Mongol
 Name[lv]=Mongou
@@ -6371,6 +6373,7 @@
 Name[kk]=
 Name[km]=
 Name[ko]=
+Name[ku]=Malay
 Name[lb]=Malaiesch
 Name[lt]=Malaj
 Name[lv]=Malajieu
@@ -6446,6 +6449,7 @@
 Name[kk]=
 Name[km]=
 Name[ko]=
+Name[ku]=Maltay
 Name[lb]=Maltesesch
 Name[lt]=Maltiei
 Name[lv]=Maltieu
@@ -6797,6 +6801,7 @@
 Name[ja]=
 Name[kk]= 
 Name[km]=
+Name[ku]=Sakson ya Jrn
 Name[lb]=Nidderschsesch
 Name[lt]=emutini sakson
 Name[lv]=Lejas saku
@@ -6863,6 +6868,7 @@
 Name[kk]=
 Name[km]=
 Name[ko]=
+Name[ku]=Nepal
 Name[lb]=Nepalesesch
 Name[lt]=Nepaliei
 Name[lv]=Neplieu
@@ -6977,6 +6983,7 @@
 Name[kk]=
 Name[km]=
 Name[ko]=
+Name[ku]=Holend
 Name[lb]=Hollnnesch
 Name[lt]=Dan
 Name[lv]=Holandieu
@@ -7061,6 +7068,7 @@
 Name[kk]= 
 Name[km]= 
 Name[ko]= (Nynorsk)
+Name[ku]=Norwc Nynorsk
 Name[lb]=Norwegesch (Nynorsk)
 Name[lt]=Norveg Nynorsk
 Name[lv]=Norvu (norskas)
@@ -7379,6 +7387,7 @@
 Name[kk]=
 Name[km]=
 Name[ko]=
+Name[ku]=Okstan
 Name[lb]=Okzitanesch
 Name[lv]=Okitu
 Name[mk]=
@@ -7608,6 +7617,7 @@
 Name[kk]=
 Name[km]=
 Name[ko]=
+Name[ku]=Pncab
 Name[lb]=Panjabi-Sprooch
 Name[lt]=Pendabo
 Name[lv]=Pandabu
@@ -7724,6 +7734,7 @@
 Name[kk]=
 Name[km]=
 Name[ko]=
+Name[ku]=Pol
 Name[lb]=Polnesch
 Name[lt]=Lenk
 Name[lv]=Pou
@@ -7863,6 +7874,7 @@
 Name[kk]=
 Name[km]=
 Name[ko]=
+Name[ku]=Portgal
 Name[lb]=Portugisesch
 Name[lt]=Portugal
 Name[lv]=Portugu
@@ -7945,6 +7957,7 @@
 Name[kk]= 
 Name[km]= 
 Name[ko]= 
+Name[ku]=Portgal ya Brazl
 Name[lb]=Brazilianescht Portugisesch
 Name[lt]=Brazilijos portugal
 Name[lv]=Brazlijas portugu
@@ -8114,6 +8127,7 @@
 Name[kk]=
 Name[km]=
 Name[ko]=
+Name[ku]=Roman
 Name[lb]=Rumnesch
 Name[lt]=Rumun
 Name[lv]=Rumu
@@ -8252,6 +8266,7 @@
 Name[kk]=
 Name[km]=
 Name[ko]=
+Name[ku]=Rs
 Name[lb]=Russesch
 Name[lt]=Rus
 Name[lv]=Krievu
@@ -8753,6 +8768,7 @@
 Name[kk]=
 Name[km]=
 Name[ko]=
+Name[ku]=Slovak
 Name[lb]=Slowakesch
 Name[lt]=Slovak
 Name[lv]=Slovku
@@ -8834,6 +8850,7 @@
 Name[kk]=
 Name[km]=
 Name[ko]=
+Name[ku]=Sloven
 Name[lb]=Slowenesch
 Name[lt]=Slovn
 Name[lv]=Slovu
@@ -9099,6 +9116,7 @@
 Name[kk]=
 Name[km]=
 Name[ko]=
+Name[ku]=Alban
 Name[lb]=Albanesch
 Name[lt]=Alban
 Name[lv]=Albu
@@ -9178,6 +9196,7 @@
 Name[kk]=
 Name[km]=
 Name[ko]=
+Name[ku]=Sirb
 Name[lb]=Serbesch
 Name[lt]=Serb
 Name[lv]=Serbu
@@ -9251,6 +9270,7 @@
 Name[ja]= ()
 Name[kk]= ()
 Name[km]= ()
+Name[ku]=Sirbiya Latn
 Name[lb]=Latinescht Serbesch
 Name[lt]=Serb lotyn
 Name[lv]=Serbu latu
@@ -9521,6 +9541,7 @@
 Name[kk]=
 Name[km]=
 Name[ko]=
+Name[ku]=Swd
 Name[lb]=Schwedesch
 Name[lt]=ved
 Name[lv]=Zviedru
@@ -9835,6 +9856,7 @@
 Name[kk]=
 Name[km]=
 Name[ko]=
+Name[ku]=Tay
 Name[lt]=Tailandiei
 Name[lv]=Taizemieu
 Name[mk]=
@@ -10132,6 +10154,7 @@
 Name[kk]=
 Name[km]=
 Name[ko]=
+Name[ku]=Tirk
 Name[lb]=Trkesch
 Name[lt]=Turk
 Name[lv]=Turku
@@ -10729,6 +10752,7 @@
 Name[kk]=
 Name[km]=
 Name[ko]=
+Name[ku]=Viyetnam
 Name[lb]=Vietnamesesch
 Name[lt]=Vietnamiei
 Name[lv]=Vjetnamieu
@@ -10848,6 +10872,7 @@
 Name[kk]=
 Name[km]=
 Name[ko]=
+Name[ku]=Waln
 Name[lb]=Wallounesch
 Name[lt]=Valon
 Name[lv]=Valou
@@ -11175,6 +11200,7 @@
 Name[kk]=
 Name[km]=
 Name[ko]=
+Name[ku]=n
 Name[lb]=Chinesesch
 Name[lt]=Kiniei
 Name[lv]=nieu
@@ -11256,6 +11282,7 @@
 Name[ja]= 
 Name[kk]= 
 Name[km]=
+Name[ku]=niya Hesankir
 Name[lb]=Einfacht Chinesesch
 Name[lt]=Kin supaprastinta
 Name[lv]=nieu vienkrot
@@ -11321,6 +11348,7 @@
 Name[ja]= ()
 Name[kk]= ()
 Name[km]= ()
+Name[ku]=n (Hong Kong)
 Name[lb]=Chinesesch (Hong Kong)
 Name[lt]=Kiniei (Honkongo)
 Name[lv]=nieu (Honkongas)
@@ -11387,6 +11415,7 @@
 Name[ja]= 
 Name[kk]= 
 Name[km]=
+Name[ku]=niya Kevneop
 Name[lb]=Traditionellt Chinesesch
 Name[lt]=Kin tradicin
 Name[lv]=nieu tradicionl
Index: kdecore/kconfigbase.cpp
===================================================================
--- kdecore/kconfigbase.cpp	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kdecore/kconfigbase.cpp	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -1022,6 +1022,15 @@
                                  bool bGlobal,
                                  bool bNLS )
 {
+   writeEntry(pKey, value, bPersistent,  bGlobal, bNLS, false);
+}
+
+void KConfigBase::writeEntry( const char *pKey, const QString& value,
+                                 bool bPersistent,
+                                 bool bGlobal,
+                                 bool bNLS,
+                                 bool bExpand )
+{
   // the KConfig object is dirty now
   // set this before any IO takes place so that if any derivative
   // classes do caching, they won't try and flush the cache out
@@ -1040,6 +1049,7 @@
   aEntryData.mValue = value.utf8();  // set new value
   aEntryData.bGlobal = bGlobal;
   aEntryData.bNLS = bNLS;
+  aEntryData.bExpand = bExpand;
 
   if (bPersistent)
     aEntryData.bDirty = true;
@@ -1121,7 +1131,7 @@
                                   bool bPersistent, bool bGlobal,
                                   bool bNLS)
 {
-   writeEntry(pKey, translatePath(path), bPersistent, bGlobal, bNLS);
+   writeEntry(pKey, translatePath(path), bPersistent, bGlobal, bNLS, true);
 }
 
 void KConfigBase::writePathEntry ( const QString& pKey, const QStringList &list,
@@ -1147,7 +1157,7 @@
       QString value = *it;
       new_list.append( translatePath(value) );
     }
-  writeEntry( pKey, new_list, sep, bPersistent, bGlobal, bNLS );
+  writeEntry( pKey, new_list, sep, bPersistent, bGlobal, bNLS, true );
 }
 
 void KConfigBase::deleteEntry( const QString& pKey,
@@ -1364,6 +1374,13 @@
                                char sep , bool bPersistent,
                                bool bGlobal, bool bNLS )
 {
+  writeEntry(pKey, list, sep, bPersistent, bGlobal, bNLS, false);
+}
+
+void KConfigBase::writeEntry ( const char *pKey, const QStringList &list,
+                               char sep, bool bPersistent,
+                               bool bGlobal, bool bNLS, bool bExpand )
+{
   if( list.isEmpty() )
     {
       writeEntry( pKey, QString::fromLatin1(""), bPersistent );
@@ -1387,7 +1404,7 @@
     }
   if( str_list.at(str_list.length() - 1) == sep )
     str_list.truncate( str_list.length() -1 );
-  writeEntry( pKey, str_list, bPersistent, bGlobal, bNLS );
+  writeEntry( pKey, str_list, bPersistent, bGlobal, bNLS, bExpand );
 }
 
 void KConfigBase::writeEntry ( const QString& pKey, const QValueList<int> &list,
Index: kdecore/tests/kurltest.cpp
===================================================================
--- kdecore/tests/kurltest.cpp	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kdecore/tests/kurltest.cpp	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -92,6 +92,7 @@
   check( "KURL::isValid()", emptyURL.isValid() ? "TRUE":"FALSE", "FALSE");
   check( "KURL::isEmpty()", emptyURL.isEmpty() ? "TRUE":"FALSE", "TRUE");
   check( "prettyURL()", emptyURL.prettyURL(), "");
+  check( "isLocalFile()", emptyURL.isLocalFile()?"TRUE":"FALSE", "FALSE" );
 
   emptyURL = "";
   check( "KURL::isMalformed()", emptyURL.isMalformed() ? "TRUE":"FALSE", "TRUE");
@@ -159,6 +160,15 @@
   check("KURL::encodedHtmlRef()", url1.ref(), "%6a");
   check("KURL::htmlRef()", url1.htmlRef(), "j");
 
+  KURL dxOffEagle( KURL("http://something/other.html"), "newpage.html?[{\"foo: bar\"}]" );
+  check("isValid", dxOffEagle.isValid() ? "OK" : "KO", "OK");
+  check("url", dxOffEagle.url(), QString("http://something/newpage.html?[{\"foo:%20bar\"}]") );
+
+  KURL javascript( KURL("javascript:window.location+\"__flashplugin_unique__\"") );
+  check("isValid", javascript.isValid() ? "OK" : "KO", "OK");
+  check("url", javascript.url(), QString("javascript:window.location+\"__flashplugin_unique__\"") );
+
+
   u1 = "file:///home/dfaure/my#myref";
   url1 = u1;
   check("KURL::url()", url1.url(), "file:///home/dfaure/my#myref");
@@ -288,6 +298,10 @@
   check("KURL::prettyURL()", url15582.prettyURL(), "http://alain.knaff.linux.lu/bug-reports/kde/percentage%in%url.html");
   check("KURL::url()", url15582.url(), "http://alain.knaff.linux.lu/bug-reports/kde/percentage%25in%25url.html");
 
+  KURL longUserName("http://thisisaverylongusername@foobar.com/");
+  check("KURL::prettyURL()", longUserName.prettyURL(), "http://thisisaverylongusername@foobar.com/");
+  check("KURL(KURL::prettyURL())", KURL(longUserName.prettyURL()).url(), "http://thisisaverylongusername@foobar.com/");
+
   KURL whitespaceInUser("http://google.com%20%20%20@foobar.com/");
   check("KURL::prettyURL()", whitespaceInUser.prettyURL(), "http://google.com%20%20%20@foobar.com/");
 
@@ -609,7 +623,7 @@
          "www.meinestadt.de&url_plain=http");
   check("http: URL with empty path string", waba1.htmlURL(),
          "http://www.meinestadt.de&amp;url_plain=http");
- 
+
   check("http: URL with empty path string", waba1.path(),
          "");
 
Index: kdecore/kstartupinfo.cpp
===================================================================
--- kdecore/kstartupinfo.cpp	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kdecore/kstartupinfo.cpp	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -545,7 +545,7 @@
 
 void KStartupInfo::setNewStartupId( QWidget* window, const QCString& startup_id )
     {
-    long activate = true;
+    bool activate = true;
     kapp->setStartupId( startup_id );
     if( window != NULL )
         {
@@ -937,7 +937,7 @@
 #ifdef Q_WS_X11
     extern Time qt_x_user_time;
 #else
-    long qt_x_user_time = 0;
+    unsigned long qt_x_user_time = 0;
 #endif
     QCString id = QString( "%1;%2;%3;%4_TIME%5" ).arg( hostname ).arg( tm.tv_sec )
         .arg( tm.tv_usec ).arg( getpid()).arg( qt_x_user_time ).utf8();
@@ -1078,7 +1078,9 @@
     if( pos >= 0 )
         {
         bool ok;
-        long time = d->id.mid( pos + 5 ).toLong( &ok );
+        unsigned long time = d->id.mid( pos + 5 ).toULong( &ok );
+        if( !ok && d->id[ pos + 5 ] == '-' ) // try if it's as a negative signed number perhaps
+            time = d->id.mid( pos + 5 ).toLong( &ok );
         if( ok )
             return time;
         }
@@ -1093,7 +1095,9 @@
         if( pos2 >= 0 )
             {
             bool ok;
-            long time = d->id.mid( pos2 + 1, pos1 - pos2 - 1 ).toLong( &ok );
+            unsigned long time = d->id.mid( pos2 + 1, pos1 - pos2 - 1 ).toULong( &ok );
+            if( !ok && d->id[ pos2 + 1 ] == '-' ) // try if it's as a negative signed number perhaps
+                time = d->id.mid( pos2 + 1, pos1 - pos2 - 1 ).toLong( &ok );
             if( ok )
                 return time;
             }
Index: kdecore/kurl.cpp
===================================================================
--- kdecore/kurl.cpp	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kdecore/kurl.cpp	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -30,7 +30,6 @@
 #include <kglobal.h>
 #include <kidna.h>
 #include <kprotocolinfo.h>
-#include <kstringhandler.h>
 #endif
 
 #include <stdio.h>
@@ -1541,13 +1540,7 @@
     u += "//";
     if ( hasUser() )
     {
-      QString s = m_strUser;
-#ifndef KDE_QT_ONLY
-      // shorten the username, its unlikely to be valid without password anyway
-      if (!hasPass())
-          s = KStringHandler::csqueeze(s, 16);
-#endif
-      u += encode(s, 0, 0);
+      u += encode(m_strUser, 0, 0);
       // Don't show password!
       u += "@";
     }
Index: khtml/khtml_part.cpp
===================================================================
--- khtml/khtml_part.cpp	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ khtml/khtml_part.cpp	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -3272,6 +3272,7 @@
     {
       //kdDebug(6050) << "Restarting" << endl;
       initFindNode( false, options & KFindDialog::FindBackwards, false );
+      d->m_find->resetCounts();
       findTextNext( reverse );
     }
     else // really done
Index: khtml/html/html_formimpl.cpp
===================================================================
--- khtml/html/html_formimpl.cpp	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ khtml/html/html_formimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -963,7 +963,7 @@
     if (id() == ID_BUTTON)
 	return true;
 
-    if (!m_render)
+    if (!m_render || !m_render->isWidget())
 	return false;
 
     QWidget* widget = static_cast<RenderWidget*>(m_render)->widget();
Index: khtml/ecma/kjs_navigator.cpp
===================================================================
--- khtml/ecma/kjs_navigator.cpp	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ khtml/ecma/kjs_navigator.cpp	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -625,7 +625,7 @@
 
 /*****************************************************************************/
 
-const ClassInfo MimeType::info = { "MimeType", 0, &MimeTypesTable, 0 };
+const ClassInfo MimeType::info = { "MimeType", 0, &MimeTypeTable, 0 };
 /*
 @begin MimeTypeTable 4
   description  	MimeType_Description    	DontDelete|ReadOnly
Index: khtml/ecma/kjs_html.h
===================================================================
--- khtml/ecma/kjs_html.h	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ khtml/ecma/kjs_html.h	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -84,7 +84,7 @@
            LinkSheet, TitleText, MetaName, MetaHttpEquiv, MetaContent, MetaScheme,
            BaseHref, BaseTarget, IsIndexForm, IsIndexPrompt, StyleDisabled,
            StyleSheet, StyleType, StyleMedia, BodyBackground, BodyVLink, BodyText,
-           BodyLink, BodyALink, BodyBgColor,  BodyOnLoad,
+           BodyLink, BodyALink, BodyBgColor,  BodyOnLoad, BodyFocus, 
            FormAction, FormEncType, FormElements, FormLength, FormAcceptCharset,
            FormReset, FormTarget, FormName, FormMethod, FormSubmit, SelectAdd,
            SelectTabIndex, SelectValue, SelectSelectedIndex, SelectLength,
Index: khtml/ecma/kjs_traversal.cpp
===================================================================
--- khtml/ecma/kjs_traversal.cpp	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ khtml/ecma/kjs_traversal.cpp	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -311,7 +311,7 @@
   if (proxy) {
     ExecState *exec = proxy->interpreter()->globalExec();
     Object acceptNodeFunc = Object::dynamicCast( filter.get(exec, "acceptNode") );
-    if (acceptNodeFunc.implementsCall()) {
+    if (!acceptNodeFunc.isNull() && acceptNodeFunc.implementsCall()) {
       List args;
       args.append(getDOMNode(exec,n));
       Value result = acceptNodeFunc.call(exec,filter,args);
Index: khtml/ecma/kjs_html.cpp
===================================================================
--- khtml/ecma/kjs_html.cpp	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ khtml/ecma/kjs_html.cpp	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -683,6 +683,11 @@
 # IE extension
   onload        KJS::HTMLElement::BodyOnLoad     DontDelete
 @end
+@begin HTMLBodyElementProtoTable 2
+# Mozilla'ish extension. Ideally we would want to support this on all elements.
+# Not hard, but not an immediate need.
+  focus         KJS::HTMLElement::BodyFocus      DontDelete|Function 0
+@end
 @begin HTMLFormElementTable 11
 # Also supported, by name/index
   elements	KJS::HTMLElement::FormElements	DontDelete|ReadOnly
@@ -2181,6 +2186,15 @@
       }
     }
     break;
+    case ID_BODY: {
+      if (id == KJS::HTMLElement::BodyFocus) {
+        // Just blur everything. Not perfect, but good enough for now
+        if (DOM::NodeImpl* impl = element.handle()) {
+          impl->getDocument()->setFocusNode(0);
+        }
+      }
+    }
+    break;
     case ID_SELECT: {
       DOM::HTMLSelectElement select = element;
       if (id == KJS::HTMLElement::SelectAdd) {
@@ -3138,7 +3152,8 @@
 KJS_EMPTY_PROTOTYPE_WITH_PROTOTYPE("HTMLStyleElement", HTMLStyleElementProto, HTMLElementProto)
 IMPLEMENT_PSEUDO_CONSTRUCTOR(HTMLStyleElementPseudoCtor, "HTMLStyleElement", HTMLStyleElementProto)
 
-KJS_EMPTY_PROTOTYPE_WITH_PROTOTYPE("HTMLBodyElement", HTMLBodyElementProto, HTMLElementProto)
+KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(HTMLBodyElementProto, HTMLElementProto)
+KJS_IMPLEMENT_PROTOTYPE("HTMLBodyElement", HTMLBodyElementProto, HTMLElementFunction)
 IMPLEMENT_PSEUDO_CONSTRUCTOR(HTMLBodyElementPseudoCtor, "HTMLBodyElement", HTMLBodyElementProto)
 
 KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(HTMLFormElementProto, HTMLElementProto)
Index: khtml/java/org/kde/kjas/server/KJASProtocolHandler.java
===================================================================
--- khtml/java/org/kde/kjas/server/KJASProtocolHandler.java	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ khtml/java/org/kde/kjas/server/KJASProtocolHandler.java	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -279,10 +279,13 @@
             String appletID  = getArg( command );
             int objid  = Integer.parseInt( getArg( command ) );
             String name  = getArg( command );
+            int arg_count  = Integer.parseInt( getArg( command ) );
             java.util.List args = new java.util.Vector();
             try { // fix getArg
                 String param = getArg(command);
-                while (param != null) {
+                while (arg_count-- > 0) {
+                    if (param == null)
+                        param = new String();
                     args.add(param);
                     param = getArg(command);
                 }
Index: khtml/java/kjavaappletviewer.cpp
===================================================================
--- khtml/java/kjavaappletviewer.cpp	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ khtml/java/kjavaappletviewer.cpp	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -570,6 +570,7 @@
     args.append (QString::number (applet->appletId ()));
     args.append (QString::number ((int) objid));
     args.append (func);
+    args.append (QString::number ((int) fargs.size ()));
     {
         QStringList::const_iterator it = fargs.begin();
         const QStringList::const_iterator itEnd = fargs.end();
Index: khtml/java/kjava.jar
===================================================================
Nie mona wywietli: plik binarny.
svn:mime-type = application/x-jar
Index: khtml/java/kjavaappletviewer.desktop
===================================================================
--- khtml/java/kjavaappletviewer.desktop	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ khtml/java/kjavaappletviewer.desktop	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -13,7 +13,7 @@
 Name[cy]=Gwelydd Rhaglennig Java Mewnadeiladedig
 Name[da]=Indlejret Java-applet fremviser
 Name[de]=Eingebetteter Betrachter fr Java-Programme
-Name[el]=   Java
+Name[el]=   Java
 Name[eo]=Enkonstruita javaplikarigardilo
 Name[es]=Visor de applets de Java empotrables
 Name[et]=Pimitav Java apleti nitaja
Index: kdoctools/customization/ja/entities/underGPL.docbook
===================================================================
--- kdoctools/customization/ja/entities/underGPL.docbook	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kdoctools/customization/ja/entities/underGPL.docbook	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -1,2 +1,2 @@
-<para>This program is licensed under the terms of the <ulink
-url="common/gpl-translated.html">GNU General Public License</ulink>.</para>
+<para> <ulink
+url="common/gpl-translated.html">GNU General Public License </ulink> </para>
Index: kdoctools/customization/ja/entities/underArtisticLicense.docbook
===================================================================
--- kdoctools/customization/ja/entities/underArtisticLicense.docbook	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kdoctools/customization/ja/entities/underArtisticLicense.docbook	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -1,2 +1 @@
-<para>This program is licensed under the terms of the <ulink
-url="common/artistic-license.html">Artistic License</ulink>.</para>
+<para> <ulink url="common/artistic-license.html">Artistic License</ulink> </para>
Index: kdoctools/customization/ja/entities/underFDL.docbook
===================================================================
--- kdoctools/customization/ja/entities/underFDL.docbook	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kdoctools/customization/ja/entities/underFDL.docbook	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -1,3 +1,3 @@
-<para id="gnu-fdl" xreflabel="the section entitled &quot;GNU Free Documentation License&quot;">This documentation is licensed under the terms of the <ulink
+<para id="gnu-fdl" xreflabel="the section entitled &quot;GNU Free Documentation License&quot;"> <ulink
 url="common/fdl-license.html">GNU Free Documentation
-License</ulink>.</para>
+License</ulink> </para>
Index: kdoctools/customization/ja/entities/underBSDLicense.docbook
===================================================================
--- kdoctools/customization/ja/entities/underBSDLicense.docbook	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kdoctools/customization/ja/entities/underBSDLicense.docbook	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -1,2 +1 @@
-<para>This program is licensed under the terms of the <ulink
-url="common/bsd-license.html">BSD License</ulink>.</para>
+<para> <ulink url="common/bsd-license.html">BSD License</ulink> </para>
Index: kdoctools/customization/ja/entities/help-menu.docbook
===================================================================
--- kdoctools/customization/ja/entities/help-menu.docbook	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kdoctools/customization/ja/entities/help-menu.docbook	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -1,58 +1,93 @@
 <variablelist>
 <varlistentry>
 <term>
-<menuchoice>
-<shortcut>
-<keycombo action="simul"><keycap>F1</keycap></keycombo>
-</shortcut>
-<guimenu>Help</guimenu>
-<guimenuitem>Contents...</guimenuitem>
-</menuchoice>
+<menuchoice
+><shortcut
+> <keycombo action="simul"
+><keycap
+>F1</keycap
+></keycombo
+> </shortcut
+> <guimenu
+></guimenu
+> <guimenuitem
+>&kappname; </guimenuitem
+> </menuchoice>
 </term>
-<listitem><para><action>Invokes the KDE Help system</action> starting at the
-&kappname; help pages. (this document).</para></listitem>
+<listitem
+><para
+>KDE  &kappname;  () </para
+></listitem>
 </varlistentry>
 
 <varlistentry>
-<term><menuchoice>
-<shortcut>
-<keycombo action="simul">&Shift;<keycap>F1</keycap></keycombo>
-</shortcut>
-<guimenu>Help</guimenu>
-<guimenuitem>What's This?</guimenuitem>
-</menuchoice>
+<term
+><menuchoice
+><shortcut
+> <keycombo action="simul"
+>&Shift;<keycap
+>F1</keycap
+></keycombo
+> </shortcut
+> <guimenu
+></guimenu
+> <guimenuitem
+></guimenuitem
+> </menuchoice>
 </term>
-<listitem><para><action>Changes the mouse cursor to a combination arrow and
-question mark.</action>  Clicking on items within &kappname; will open a help
-window (if one exists for the particular item) explaining the item's
-function.</para></listitem>
+<listitem
+><para
+> &kappname;  ()</para
+></listitem>
 </varlistentry>
 
 
 <varlistentry>
-<term><menuchoice>
-<guimenu>Help</guimenu>
-<guimenuitem>Report Bug...</guimenuitem>
-</menuchoice></term>
-<listitem><para><action>Opens the Bug report dialog</action> where you can
-report a bug or request a <quote>wishlist</quote> feature.</para></listitem>
+<term
+><menuchoice
+><guimenu
+></guimenu
+> <guimenuitem
+>...</guimenuitem
+> </menuchoice
+></term>
+<listitem
+><para
+></para
+></listitem>
 </varlistentry>
 
 <varlistentry>
-<term><menuchoice>
-<guimenu>Help</guimenu>
-<guimenuitem>About &kappname;</guimenuitem>
-</menuchoice></term>
-<listitem><para><action>This will display version and author
-information.</action></para></listitem>
+<term
+><menuchoice
+><guimenu
+></guimenu
+> <guimenuitem
+>&kappname; </guimenuitem
+> </menuchoice
+></term>
+<listitem
+><para
+><action
+></action
+></para
+></listitem>
 </varlistentry>
 
 <varlistentry>
-<term><menuchoice>
-<guimenu>Help</guimenu>
-<guimenuitem>About KDE</guimenuitem>
-</menuchoice></term>
-<listitem><para><action>This displays the KDE version and other basic
-information.</action></para></listitem>
+<term
+><menuchoice
+><guimenu
+></guimenu
+> <guimenuitem
+>KDE </guimenuitem
+> </menuchoice
+></term>
+<listitem
+><para
+><action
+>KDE </action
+></para
+></listitem>
 </varlistentry>
 </variablelist>
Index: kdoctools/customization/ja/entities/underX11License.docbook
===================================================================
--- kdoctools/customization/ja/entities/underX11License.docbook	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kdoctools/customization/ja/entities/underX11License.docbook	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -1,2 +1 @@
-<para>This program is licensed under the terms of the <ulink
-url="common/x11-license.html">X11 License</ulink>.</para>
+<para> <ulink url="common/x11-license.html">X11 License</ulink> </para>
Index: kdoctools/customization/ja/entities/install-compile.docbook
===================================================================
--- kdoctools/customization/ja/entities/install-compile.docbook	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kdoctools/customization/ja/entities/install-compile.docbook	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -1,12 +1,8 @@
-<para>In order to compile and install &kappname; on your system, type the
-following in the base directory of the &kappname; distribution:</para>
+<para>&kappname; &kappname; </para>
 
 <screen><prompt>%</prompt> <userinput><command>./configure</command></userinput>
 <prompt>%</prompt> <userinput><command>make</command></userinput>
 <prompt>%</prompt> <userinput><command>make</command> install</userinput>
 </screen>
 
-<para>Since &kappname; uses <command>autoconf</command> and
-<command>automake</command> you should have no trouble compiling it. Should you
-run into problems please report them to the &kde; mailing lists.</para>
-
+<para>&kappname;  <command>autoconf</command>  <command>automake</command> &kde; </para>
Index: kdoctools/customization/ja/entities/install-intro.docbook
===================================================================
--- kdoctools/customization/ja/entities/install-intro.docbook	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kdoctools/customization/ja/entities/install-intro.docbook	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -1,6 +1,4 @@
 <!-- requires that packagename is defined in the documentation prologue -->
-<para>&kappname; is part of the &kde; project &kde-http;.</para>
+<para>&kappname;  &kde;  &kde-http; </para>
 
-<para>&kappname; can be found in the &package; package on 
-&kde-ftp;, the main &FTP; site of the &kde;
-project.</para>
+<para>&kappname;  &kde;  &FTP;  &kde-ftp;  &package; </para>
Index: kdoctools/customization/fr/user.entities
===================================================================
--- kdoctools/customization/fr/user.entities	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kdoctools/customization/fr/user.entities	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -12,7 +12,7 @@
 <!ENTITY relecteurDavidAmmouial        '<othercredit role="reviewer"><firstname>David</firstname><surname>Ammouial</surname><affiliation><address><email></email></address></affiliation><contrib>Relecture de la documentation franaise&nbsp;</contrib></othercredit>'>
 
 <!ENTITY traducteurPierreAuckenthaler      '<othercredit role="translator"><firstname>Pierre</firstname><surname>Auckenthaler</surname><affiliation><address><email>pierre.auckenthaler@polytechnique.org</email></address></affiliation><contrib>Traduction franaise&nbsp;</contrib></othercredit>'>
-<!ENTITY relecteurPierreAuckenthaler        '<othercredit role="reviewer"><firstname>Pierre</firstname><surname>Auckenthaler</surname><affiliation><address><email>pierre.auckenthaler@polytechnique.org</email></address></affiliation><contrib>Relecture de la documentation franaise&nbsp;</contrib></othercredit>'>
+<!ENTITY relecteurPierreAuckenthaler         '<othercredit role="reviewer"><firstname>Pierre</firstname><surname>Auckenthaler</surname><affiliation><address><email>pierre.auckenthaler@polytechnique.org</email></address></affiliation><contrib>Relecture de la documentation franaise&nbsp;</contrib></othercredit>'>
 
 <!ENTITY traducteurEricBischoff       '<othercredit role="translator"><firstname>ric</firstname><surname>Bischoff</surname><affiliation><address><email>e.bischoff@noos.fr</email></address></affiliation><contrib>Traduction franaise&nbsp;</contrib></othercredit>'>
 <!ENTITY relecteurEricBischoff        '<othercredit role="reviewer"><firstname>ric</firstname><surname>Bischoff</surname><affiliation><address><email>e.bischoff@noos.fr</email></address></affiliation><contrib>Relecture de la documentation franaise&nbsp;</contrib></othercredit>'>
@@ -86,6 +86,9 @@
 <!ENTITY traducteurGuillaumeDuweltzRebert     '<othercredit role="translator"><firstname>Guillaume</firstname><surname>Duweltz</surname><affiliation><address><email>gduwelz-rebert.cs@clearstream.com</email></address></affiliation><contrib>Traduction franaise&nbsp;</contrib></othercredit>'>
 <!ENTITY relecteurGuillaumeDuweltzRebert      '<othercredit role="relecteur"><firstname>Guillaume</firstname><surname>Duweltz</surname><affiliation><address><email>gduwelz-rebert.cs@clearstream.com</email></address></affiliation><contrib>Relecture de la documentation franaise&nbsp;</contrib></othercredit>'>
 
+<!ENTITY traducteurGuillaumeFahrner     '<othercredit role="translator"><firstname>Guillaume</firstname><surname>Fahrner</surname><affiliation><address><email>Admin@SecurityHack.Org</email></address></affiliation><contrib>Traduction franaise&nbsp;</contrib></othercredit>'>
+<!ENTITY relecteurGuillaumeFahrner      '<othercredit role="relecteur"><firstname>Guillaume</firstname><surname>Fahrner</surname><affiliation><address><email>Admin@SecurityHack.Org</email></address></affiliation><contrib>Relecture de la documentation franaise&nbsp;</contrib></othercredit>'>
+
 <!ENTITY traducteurSamiFantar    '<othercredit role="translator"><firstname>Sami</firstname><surname>Fantar</surname><affiliation><address><email>sami.fantar@laposte.net</email></address></affiliation><contrib>Traduction franaise&nbsp;</contrib></othercredit>'>
 <!ENTITY relecteurSamiFantar     '<othercredit role="reviewer"><firstname>Sami</firstname><surname>Fantar</surname><affiliation><address><email>sami.fantar@laposte.net</email></address></affiliation><contrib>Relecture de la documentation franaise&nbsp;</contrib></othercredit>'>
 
@@ -243,6 +246,7 @@
 <!ENTITY NicolasDupuis     'Nicolas Dupuis <email>ndupuis@tiscali.be</email>'>
 <!ENTITY HeleneDuwelzRebert 'Hlne Duwelz-Rebert <email>helened@herbalife.com</email>'>
 <!ENTITY GuillaumeDuwelzRebert 'Guillaume Duwelz-Rebert <email>gduwelz-rebert.cs@clearstream.com</email>'>
+<!ENTITY GuillaumeFahrner 'Guillaume Fahrner <email>Admin@SecurityHack.Org</email>'>
 <!ENTITY SamiFantar          'Sami Fantar <email>sami.fantar@laposte.net</email>'>
 <!ENTITY NilsSergioFernandez 'Nils Sergio Fernandez Rnningen <email>nilsfernandez@yahoo.fr</email>'>
 <!ENTITY JeanJacquesFinazzi 'Jean-Jacques Finazzi <email>jj.finazzi@club.fr</email>'>
Index: kdoctools/customization/entities/contributor.entities
===================================================================
--- kdoctools/customization/entities/contributor.entities	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kdoctools/customization/entities/contributor.entities	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -194,7 +194,7 @@
 <!ENTITY Geert.Jansen '<personname><firstname>Geert</firstname><surname>Jansen</surname></personname>'>
 <!ENTITY Geert.Jansen.mail '<email>g.t.jansen@stud.tue.nl</email>'>
 <!ENTITY David.Jarvie '<personname><firstname>David</firstname><surname>Jarvie</surname></personname>'>
-<!ENTITY David.Jarvie.mail '<email>software@astrojar.org.uk</email>'>
+<!ENTITY David.Jarvie.mail '<email>djarvie@kde.org</email>'>
 <!ENTITY Stephan.Johach '<personname><firstname>Stephan</firstname><surname>Johach</surname></personname>'>
 <!ENTITY Stephan.Johach.mail '<email>hunsum@gmx.de</email>'>
 <!ENTITY Antonio.Larrosa.Jimenez '<personname><firstname>Antonio</firstname><othername>Larrosa</othername><surname>Jim&eacute;nez</surname></personname>'>
Index: kdeprint/filters/pdfwrite.desktop
===================================================================
--- kdeprint/filters/pdfwrite.desktop	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kdeprint/filters/pdfwrite.desktop	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -67,7 +67,7 @@
 Comment[nso]=Mongwadi wa PDF (o hloka tshwaelo yaGhost)
 Comment[pa]=PDF  ( )
 Comment[pl]=Zapisywacz PDF (wymaga GhostScripta)
-Comment[pt]=Visualizador de PDF (necessita do GhostScript)
+Comment[pt]=Gravador de PDF (necessita do Ghostscript)
 Comment[pt_BR]= Editor PDF  (necessita do GhostScript)
 Comment[ro]=Generator de PDF (are nevoie de Ghostscript)
 Comment[ru]=  PDF (   GhostScript)
Index: kdeprint/filters/pdf2ps.desktop
===================================================================
--- kdeprint/filters/pdf2ps.desktop	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kdeprint/filters/pdf2ps.desktop	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -5,11 +5,14 @@
 Comment=PDF to PostScript Converter
 Comment[bg]=  PDF  PostScript 
 Comment[ca]=Convertidor de PDF a PostScript
+Comment[da]=PDF-til-PostScript-konvertering
 Comment[de]=Umwandlung von PDF in PostScript
 Comment[el]=  PostScript  PDF
 Comment[eo]=Konvertilo de la dokumenttipo PDF al PS
 Comment[es]=Conversor de PDF a PostScript
 Comment[et]=PDF->PostScript teisendamine
+Comment[hr]=Pretvaranje iz PDF-a u PostScript
+Comment[hu]=PDF -> PostScript konvertlprogram
 Comment[it]=Convertitore da PDF a PostScript
 Comment[ja]=PDF  PostScript 
 Comment[km]= PDF  PostScript
@@ -17,6 +20,7 @@
 Comment[nl]=Conversie van PDF naar PostScript
 Comment[pt]=Conversor de PDF para PostScript
 Comment[pt_BR]=Conversor de PDF para PostScript
+Comment[ru]= PDF  PostScript
 Comment[sk]=Prevod sborov z PDF do PostScript
 Comment[sl]=Pretvornik datotek PDF v PostScript
 Comment[sr]=  PDF-  PostScript
Index: kdeprint/filters/psresize.desktop
===================================================================
--- kdeprint/filters/psresize.desktop	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kdeprint/filters/psresize.desktop	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -56,7 +56,7 @@
 Comment[mn]=     
 Comment[ms]=Skala Cetak Kandungan untuk menepati Saiz Kertas Lain
 Comment[mt]=Kabbar/ekken id-daqs ta'l-print biex joqgod fuq karta ta' daqs differenti
-Comment[nb]=Tilpass utskriften til en annen papirstrrelse
+Comment[nb]=Tilpass utskrifta til en annen papirstrrelse
 Comment[nds]=Utdruck en anner Papeergrtt topassen
 Comment[ne]=       
 Comment[nl]=Schaal de afdrukinhoud zodat deze past op een andere papierformaat
Index: kdeprint/specials.desktop
===================================================================
--- kdeprint/specials.desktop	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kdeprint/specials.desktop	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -1101,7 +1101,7 @@
 Name[de]=Erweitertes Faxprogramm (ksendfax)
 Name[el]=    (ksendfax)
 Name[eo]=Pliluksa Faksilo (ksendfax)
-Name[es]=Herramienta avanzada de envio de faxes (ksendfax)
+Name[es]=Herramienta avanzada de envo de faxes (ksendfax)
 Name[et]=Vimas faksimise rakendus (ksendfax)
 Name[eu]=Faxaren tresna aurreratua (ksendfax)
 Name[fa]=  )KSendFax(
Index: kdeui/qxembed.h
===================================================================
--- kdeui/qxembed.h	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kdeui/qxembed.h	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -226,6 +226,7 @@
     QXEmbedData* d;
     void checkGrab();
     void sendSyntheticConfigureNotifyEvent();
+    void handleEmbed();
 };
 
 
Index: kdeui/kactionclasses.cpp
===================================================================
--- kdeui/kactionclasses.cpp	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kdeui/kactionclasses.cpp	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -667,8 +667,8 @@
     KToolBar* bar = static_cast<KToolBar*>( widget );
     int id_ = KAction::getToolButtonID();
     bar->insertCombo( comboItems(), id_, isEditable(),
-                      SIGNAL( activated( int ) ), this,
-                      SLOT( slotActivated( int ) ), isEnabled(),
+                      SIGNAL( activated( const QString & ) ), this,
+                      SLOT( slotActivated( const QString & ) ), isEnabled(),
                       toolTip(), -1, index );
 
     QComboBox *cb = bar->getCombo( id_ );
Index: kdeui/qxembed.cpp
===================================================================
--- kdeui/qxembed.cpp	(.../tags/KDE/3.5.8/kdelibs)	(wersja 770668)
+++ kdeui/qxembed.cpp	(.../branches/KDE/3.5/kdelibs)	(wersja 770668)
@@ -1013,6 +1013,44 @@
     }
 }
 
+// When a window is reparented into QXEmbed (or created inside of it), this function
+// sets up the actual embedding.
+void QXEmbed::handleEmbed()
+{
+    // only XEMBED apps can survive crash,
+    // see http://lists.kde.org/?l=kfm-devel&m=106752026501968&w=2
+    if( !d->xplain )
+        XAddToSaveSet( qt_xdisplay(), window );
+    XResizeWindow(qt_xdisplay(), window, width(), height());
+    XMapRaised(qt_xdisplay(), window);
+    // L2024: see L2900.
+    sendSyntheticConfigureNotifyEvent();
+    // L2025: ??? [any idea about drag&drop?] 
+    extraData()->xDndProxy = window;
+    if ( parent() ) {
+        // L2030: embedded window might have new size requirements.
+        //        see L2500, L2520, L2550.
+        QEvent * layoutHint = new QEvent( QEvent::LayoutHint );
+        QApplication::postEvent( parent(), layoutHint );
+    }
+    windowChanged( window );
+    if (d->xplain) {
+        // L2040: Activation has changed. Grab state might change. See L2800.
+        checkGrab();
+        if ( hasFocus() )
+            // L2041: Send fake focus message to inform the client. See L1521.
+            sendFocusMessage(window, XFocusIn, NotifyNormal, NotifyPointer );
+    } else {
+        // L2050: Send XEMBED messages (see L0670, L1312, L1322, L1530)
+        sendXEmbedMessage( window, XEMBED_EMBEDDED_NOTIFY, 0, (long) winId() );
+        if (isActiveWindow())
+            sendXEmbedMessage( window, XEMBED_WINDOW_ACTIVATE);
+        else
+            sendXEmbedMessage( window, XEMBED_WINDOW_DEACTIVATE);
+        if ( hasFocus() )
+            sendXEmbedMessage( window, XEMBED_FOCUS_IN, XEMBED_FOCUS_CURRENT );
+    }
+}
 
 // L1800: Returns the window identifier of the embedded window
 WId QXEmbed::embeddedWinId() const
@@ -1051,6 +1089,13 @@
             emit embeddedWindowDestroyed();
         }
         break;
+    case CreateNotify:
+        // A window was created inside of QXEmbed, handle it as embedded
+        if( window == 0 ) { // only one window
+            window = e->xcreatewindow.window;
+            handleEmbed();
+        }
+        break;
     case ReparentNotify:
         if ( e->xreparent.window == d->focusProxy->winId() )
             break; // ignore proxy
@@ -1066,41 +1111,11 @@
             if( !d->xplain )
                 XRemoveFromSaveSet( qt_xdisplay(), window );
         } else if ( e->xreparent.parent == winId()){
+            if( window == 0 ) // something started embedding from the outside
+                window = e->xreparent.window;
             // L2020: We got a window. Complete the embedding process.
-            window = e->xreparent.window;
-            // only XEMBED apps can survive crash,
-            // see http://lists.kde.org/?l=kfm-devel&m=106752026501968&w=2
-            if( !d->xplain )
-                XAddToSaveSet( qt_xdisplay(), window );
-            XResizeWindow(qt_xdisplay(), window, width(), height());
-            XMapRaised(qt_xdisplay(), window);
-            // L2024: see L2900.
-            sendSyntheticConfigureNotifyEvent();
-            // L2025: ??? [any idea about drag&drop?] 
-            extraData()->xDndProxy = window;
-            if ( parent() ) {
-                // L2030: embedded window might have new size requirements.
-                //        see L2500, L2520, L2550.
-                QEvent * layoutHint = new QEvent( QEvent::LayoutHint );
-                QApplication::postEvent( parent(), layoutHint );
-            }
-            windowChanged( window );
-            if (d->xplain) {
-                // L2040: Activation has changed. Grab state might change. See L2800.
-                checkGrab();
-                if ( hasFocus() )
-                    // L2041: Send fake focus message to inform the client. See L1521.
-                    sendFocusMessage(window, XFocusIn, NotifyNormal, NotifyPointer );
-            } else {
-                // L2050: Send XEMBED messages (see L0670, L1312, L1322, L1530)
-                sendXEmbedMessage( window, XEMBED_EMBEDDED_NOTIFY, 0, (long) winId() );
-                if (isActiveWindow())
-                    sendXEmbedMessage( window, XEMBED_WINDOW_ACTIVATE);
-                else
-                    sendXEmbedMessage( window, XEMBED_WINDOW_DEACTIVATE);
-                if ( hasFocus() )
-                    sendXEmbedMessage( window, XEMBED_FOCUS_IN, XEMBED_FOCUS_CURRENT );
-            }
+            if( e->xreparent.window == window )
+                handleEmbed();
         }
         break;
     case ButtonPress:

Zmiany atrybutw dla: .
___________________________________________________________________
Nazwa: svn:externals
   + admin https://svn.kde.org/home/kde/branches/KDE/3.5/kde-common/admin


