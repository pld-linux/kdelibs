diff -urN -x CVS kdelibs.orig/README kdelibs/README
--- kdelibs.orig/README	Sun Oct  3 10:03:55 2004
+++ kdelibs/README	Sun Nov 28 14:35:51 2004
@@ -10,7 +10,7 @@
 
 About kdelibs
 -------------
-This is version 3.3.1 of the KDE libraries.
+This is version 3.3.2 of the KDE libraries.
 
 This package includes libraries that are central to the development and 
 execution of a KDE program, as well as internationalization files for these 
diff -urN -x CVS kdelibs.orig/admin/acinclude.m4.in kdelibs/admin/acinclude.m4.in
--- kdelibs.orig/admin/acinclude.m4.in	Wed Aug 25 23:21:05 2004
+++ kdelibs/admin/acinclude.m4.in	Fri Nov 12 23:48:09 2004
@@ -3983,14 +3983,49 @@
 
 AC_DEFUN([KDE_CHECK_LIBPTHREAD],
 [
-  AC_MSG_CHECKING([for pthread_create in -lpthread])
-  kde_safe_libs=$LIBS
-  LIBS="$LIBS -lpthread"
-  AC_TRY_LINK([#include <pthread.h>],[(void)pthread_create(0,0,0,0);],[
-      AC_MSG_RESULT(yes)
-      LIBPTHREAD="-lpthread"],[
-      AC_MSG_RESULT(no)])
-  LIBS=$kde_safe_libs
+  dnl This code is here specifically to handle the
+  dnl various flavors of threading library on FreeBSD
+  dnl 4-, 5-, and 6-, and the (weird) rules around it.
+  dnl There may be an environment PTHREAD_LIBS that 
+  dnl specifies what to use; otherwise, search for it.
+  dnl -pthread is special cased and unsets LIBPTHREAD
+  dnl below if found.
+  LIBPTHREAD=""
+
+  if test -n "$PTHREAD_LIBS"; then
+    if test "x$PTHREAD_LIBS" = "x-pthread" ; then
+      LIBPTHREAD="PTHREAD"
+    else
+      PTHREAD_LIBS_save="$PTHREAD_LIBS"
+      PTHREAD_LIBS=`echo "$PTHREAD_LIBS_save" | sed -e 's,^-l,,g'`
+      AC_MSG_CHECKING([for pthread_create in $PTHREAD_LIBS])
+      KDE_CHECK_LIB($PTHREAD_LIBS, pthread_create, [
+          LIBPTHREAD="$PTHREAD_LIBS_save"])
+      PTHREAD_LIBS="$PTHREAD_LIBS_save"
+    fi
+  fi
+
+  dnl Is this test really needed, in the face of the Tru64 test below?
+  if test -z "$LIBPTHREAD"; then
+    AC_CHECK_LIB(pthread, pthread_create, [LIBPTHREAD="-lpthread"])
+  fi
+
+  dnl This is a special Tru64 check, see BR 76171 issue #18.
+  if test -z "$LIBPTHREAD" ; then
+    AC_MSG_CHECKING([for pthread_create in -lpthread])
+    kde_safe_libs=$LIBS
+    LIBS="$LIBS -lpthread"
+    AC_TRY_LINK([#include <pthread.h>],[(void)pthread_create(0,0,0,0);],[
+        AC_MSG_RESULT(yes)
+        LIBPTHREAD="-lpthread"],[
+	AC_MSG_RESULT(no)])
+    LIBS=$kde_safe_libs
+  fi
+
+  dnl Un-special-case for FreeBSD.
+  if test "x$LIBPTHREAD" = "xPTHREAD" ; then
+    LIBPTHREAD=""
+  fi
 
   AC_SUBST(LIBPTHREAD)
 ])
diff -urN -x CVS kdelibs.orig/admin/cvs.sh kdelibs/admin/cvs.sh
--- kdelibs.orig/admin/cvs.sh	Sun Oct  3 09:11:51 2004
+++ kdelibs/admin/cvs.sh	Sun Nov 28 14:34:13 2004
@@ -309,7 +309,7 @@
    fi
 fi
 if test -z "$VERSION" || test "$VERSION" = "@VERSION@"; then
-     VERSION="\"3.3.1\""
+     VERSION="\"3.3.2\""
 fi
 if test -z "$modulename" || test "$modulename" = "@MODULENAME@"; then
    modulename=`pwd`; 
diff -urN -x CVS kdelibs.orig/arts/kde/mcop-dcop/kmcop.desktop kdelibs/arts/kde/mcop-dcop/kmcop.desktop
--- kdelibs.orig/arts/kde/mcop-dcop/kmcop.desktop	Tue Aug 31 09:21:02 2004
+++ kdelibs/arts/kde/mcop-dcop/kmcop.desktop	Sat Oct 30 08:38:03 2004
@@ -2,15 +2,15 @@
 Encoding=UTF-8
 Type=Service
 Name=KMCOP
-Name[af]=Kmcop
 Name[hi]=के-एमकॉप 
 Exec=kmcop
 Comment=KDE MCOP-DCOP Bridge
-Comment[af]=Kde MCOP-DCOP Brug
+Comment[af]=KDE MCOP-DCOP Brug
 Comment[ar]=جسر KDE MCOP-DCOP
 Comment[az]=KDE MCOP-DCOP Körpüsü
 Comment[be]=Мост KDE MCOP-DCOP
 Comment[bn]=কে.ডি.ই MCOP-DCOP ব্রিজ
+Comment[br]=Pont KDE MCOP-DCOP
 Comment[bs]=KDE MCOP-DCOP prelaz
 Comment[ca]=Connector MCOP-DCOP per al KDE
 Comment[cs]=KDE MCOP-DCOP můstek
@@ -39,6 +39,7 @@
 Comment[ko]=KDE MCOP-DCOP 브릿지
 Comment[lt]=KDE MCOP-DCOP tiltas
 Comment[lv]=KDE MCOP-DCOP Tilts
+Comment[mk]=KDE MCOP-DCOP Мост
 Comment[mn]=KDE-н MCOP ба DCOP хоорондын гүүр
 Comment[ms]=Jambatan KDE MCOP-DCOP
 Comment[mt]=Pont bejn MCOP u DCOP
diff -urN -x CVS kdelibs.orig/arts/knotify/knotify.desktop kdelibs/arts/knotify/knotify.desktop
--- kdelibs.orig/arts/knotify/knotify.desktop	Wed Sep 29 16:06:09 2004
+++ kdelibs/arts/knotify/knotify.desktop	Mon Nov 22 09:34:03 2004
@@ -60,12 +60,12 @@
 Comment[lt]=KDE pranešimų tarnyba
 Comment[lv]=KDE Apziņošanas Dēmons
 Comment[mi]=Kaikorero KDE
-Comment[mk]=KDE демон за системски известувања
+Comment[mk]=Даемон за известувања на KDE 
 Comment[mn]=KDE-Сонордуулга программ
 Comment[ms]=Daemon Pemberitahuan KDE
 Comment[mt]=Daemon tan-notifika KDE
 Comment[nb]=KDE Varslings-nisse
-Comment[nds]=KDE Dämon för dat Bescheed geven
+Comment[nds]=KDE-Dämoon för't Bescheed geven
 Comment[nl]=KDE's systeemnotificatieprogramma
 Comment[nn]=KDE-varselnisse
 Comment[nso]=Daemon ya Tsebiso ya KDE
diff -urN -x CVS kdelibs.orig/dcop/client/dcop.cpp kdelibs/dcop/client/dcop.cpp
--- kdelibs.orig/dcop/client/dcop.cpp	Mon Jul  5 10:46:40 2004
+++ kdelibs/dcop/client/dcop.cpp	Fri Nov  5 17:18:03 2004
@@ -190,8 +190,11 @@
 
 	    if ( l > 0 && (*it).mid( s, l - s ) == func ) {
 		realfunc = (*it).mid( s );
-		uint a = (*it).contains(',');
-		if ( ( a == 0 && args.isEmpty() ) || ( a > 0 && a + 1 == args.count() ) )
+		const QString arguments = (*it).mid(l+1,(*it).find( ')' )-l-1);
+		uint a = arguments.contains(',');
+		if ( (a==0 && !arguments.isEmpty()) || a>0)
+		    a++;
+		if ( a == args.count()  )
 		    break;
 	    }
 	}
diff -urN -x CVS kdelibs.orig/interfaces/kimproxy/interface/dcopinstantmessenger.desktop kdelibs/interfaces/kimproxy/interface/dcopinstantmessenger.desktop
--- kdelibs.orig/interfaces/kimproxy/interface/dcopinstantmessenger.desktop	Mon Sep 20 15:53:09 2004
+++ kdelibs/interfaces/kimproxy/interface/dcopinstantmessenger.desktop	Mon Nov 22 09:34:03 2004
@@ -3,15 +3,18 @@
 Type=ServiceType
 X-KDE-ServiceType=DCOP/InstantMessenger
 Comment=Instant Messenger with a DCOP interface
+Comment[af]=Oombliklike Boodskapper met DCOP intervlak
 Comment[bg]=Програма за съобщения в реално време с интерфейс DCOP
 Comment[bn]=ডিকপ (DCOP) ইন্টারফেস সহ ইনস্ট্যান্ট মেসেঞ্জার
 Comment[bs]=Instant poruke sa DCOP interfejsom
 Comment[ca]=Missatgeria instantània amb una interfície DCOP
+Comment[cs]=Komunikátor s DCOP rozhraním
 Comment[da]=Instant Messenger med en DCOP-græbseflade
 Comment[de]=Instant Messenger mit DCOP-Schnittstelle
 Comment[eo]=Tujmesaĝilo kun DCOP-interfaco
 Comment[es]=Instant Messenger con un interfaz DCOP
 Comment[et]=Kiirsuhtlemisrakendus DCOP liidesega
+Comment[eu]=Berealako mezularitza DCOP interfazearekin
 Comment[fi]=Pikaviestiohjelma, jossa on DCOP-rajapinta
 Comment[fr]=Messagerie instantanée munie d'une interface DCOP
 Comment[he]=תכנת מסרים מידיים עם ממשק DCOP
@@ -19,7 +22,10 @@
 Comment[is]=Spjallforrit með DCOP viðmóti
 Comment[it]=Messaggistica istantanea con un'interfaccia DCOP
 Comment[ja]=DCOP インターフェースをもつインスタントメッセンジャー
+Comment[lt]=Momentinių žinučių klientas su DCOP sąsaja
+Comment[mk]=Инстант Гласник (Messenger) со DCOP-интерфејс
 Comment[nb]=Lynmeldingsprogram med DCOP-grensesnitt
+Comment[nds]=Kortnarichten-Maker mit en Verbinnen to dat DCOP
 Comment[nl]=Instant messenger met een DCOP interface
 Comment[nn]=Lynmeldingsprogram med DCOP-grensesnitt
 Comment[pa]=ਇੱਕ DCOP ਇੰਟਰਫੇਸ ਲਈ ਇੱਕ ਮੌਕਾ ਸੁਨੇਹਾਕਾਰ
@@ -32,7 +38,7 @@
 Comment[sk]=Instant Messanger s rozhraním DCOP
 Comment[sl]=Takojšni sporočilnik z vmesnikom DCOP
 Comment[sr]=Брзи гласник са DCOP интерфејсом
-Comment[sr@Latn]=Брзи гласник са DCOP интерфејсом
+Comment[sr@Latn]=Brzi glasnik sa DCOP interfejsom
 Comment[sv]=Direktmeddelanden med ett DCOP-gränssnitt
 Comment[ta]=உடனடி செய்தியாளர் DCOP இடைமுகத்தோடு
 Comment[tg]=Коргири хизматгоҳи AOL пайғоми ахборот
diff -urN -x CVS kdelibs.orig/interfaces/kimproxy/interface/kcm_instantmessenger.desktop kdelibs/interfaces/kimproxy/interface/kcm_instantmessenger.desktop
--- kdelibs.orig/interfaces/kimproxy/interface/kcm_instantmessenger.desktop	Mon Sep 20 15:53:09 2004
+++ kdelibs/interfaces/kimproxy/interface/kcm_instantmessenger.desktop	Sat Nov 13 08:20:18 2004
@@ -1,8 +1,10 @@
 Name=Instant Messenger
+Name[af]=Oombliklike Boodskapper
 Name[bg]=Съобщения в реално време
 Name[bn]=ইনস্ট্যান্ট মেসেঞ্জার
 Name[bs]=Instant poruke
 Name[ca]=Missatgeria instantània
+Name[cs]=Komunikátor
 Name[eo]=Tujmesaĝilo
 Name[et]=Kiirsuhtlus
 Name[fi]=Pikaviestiohjelma
@@ -12,7 +14,10 @@
 Name[is]=Spjallforrit
 Name[it]=Messaggistica istantanea
 Name[ja]=インスタントメッセンジャー
+Name[lt]=Momentinių žinučių klientas
+Name[mk]=Инстант Гласник (Messenger)
 Name[nb]=Lynmelding
+Name[nds]=Kortnarichten-Maker
 Name[nl]=Instant messenger
 Name[nn]=Lynmelding
 Name[pa]=ਮੌਕਾ ਸੁਨੇਹਾਕਾਰ
@@ -24,7 +29,7 @@
 Name[se]=Šleađgadieđut
 Name[sl]=Takojšni sporočilnik
 Name[sr]=Брзи гласник
-Name[sr@Latn]=Брзи гласник
+Name[sr@Latn]=Brzi glasnik
 Name[sv]=Direktmeddelanden
 Name[ta]=உடனடி செய்தியாளர்
 Name[tg]=Пайғоми ахборот
@@ -32,10 +37,12 @@
 Name[uz]=Хабар алмашиш воситаси
 Name[zh_CN]=即时通讯程序
 Comment=The instant messenger allows two-way chat between individuals and groups.
+Comment[af]=Die oombliklike boodskappe laat twee rigting kommunikasie tussen individue en groepe toe.
 Comment[bg]=Разговор между различни хора в реално време.
 Comment[bn]=ইনস্ট্যান্ট মেসেঞ্জার একাধিক ব্যক্তি বা গোষ্ঠীকে দ্বিমুখী বার্তালাপ বা আড্ডার সুযোগ দেয়। 
 Comment[bs]=Program za instant poruke omogućuje dvosmjernu komunikaciju između pojedinaca i grupa.
 Comment[ca]=La missatgeria instantània permet converses en dos sentits entre individus i grups.
+Comment[cs]=Komunikátor vám umožňuje obousměrný rozhovor s jednotlivci nebo skupinami.
 Comment[da]=Instant messenger tillader tovejs chat mellem individer og grupper.
 Comment[de]=Der Instant Messenger ermöglicht Chats zwischen Personen und Gruppen in jede Richtung.
 Comment[eo]=La tujmesaĝilo ebligas ambaŭdirekta parolado inter homoj kaj grupoj
@@ -48,7 +55,9 @@
 Comment[is]=Spjallforritið gerir einstaklingum og hópum kleyft að spjalla saman á einfaldan máta.
 Comment[it]=La messaggistica istantanea permette di chiacchierare tra due persone o in gruppo.
 Comment[ja]=インスタントメッセンジャーは個人とグループとの双方向チャットを可能にします。
+Comment[lt]=Momentinių žinučių klientas kalbėtis individams ir grupėms.
 Comment[nb]=Et lynmeldingsprogram som tallater toveis samtale mellom enkeltpersoner og grupper.
+Comment[nds]=Mit den Kortnarichten-Maker köönt enkelte Minschen oder Gruppen ünnerenanner snacken.
 Comment[nl]=De instant messenger maakt directe communicatie tussen personen of groepen mogelijk.
 Comment[nn]=Eit lynmeldingsprogram som tillèt tovegsprat mellom enkeltpersonar og grupper.
 Comment[pa]=ਇਹ ਮੌਕਾ ਸੁਨੇਹਾਕਾਰ ਇੱਕਲੇ ਤੇ ਸਮੂਹ ਵਿਚਕਾਰ ਦੋ ਪਾਸੀ ਗਲਬਾਤ ਲਈ ਸਹਾਇਕ ਹੈ
@@ -61,7 +70,7 @@
 Comment[sk]=Instant messenger umožňuje rozhovor medzi rôznymi osobami a skupinami.
 Comment[sl]=Takojšni sporočilnik omogoča dvosmeren klepet med posamezniki in skupinami.
 Comment[sr]=Брзи гласник вам омогућава двосмерно ћаскање између индивидуа и група.
-Comment[sr@Latn]=Брзи гласник вам омогућава двосмерно ћаскање између индивидуа и група.
+Comment[sr@Latn]=Brzi glasnik vam omogućava dvosmerno ćaskanje između individua i grupa.
 Comment[sv]=Direktmeddelanden möjliggör tvåvägschatt mellan individer och grupper.
 Comment[ta]=உடனடி தகவல் உங்களை இரண்டு வழியில் தனிநபர் மற்றும் குழுக்கள் இடையே அனுமதிக்கும்.
 Comment[tg]=Пайғоми ахборот ба шумо иҷозат медиҳад, ки ду роҳигуфтугӯиро байни шахсҳо ва гурӯҳҳоро ба истифода баред.
diff -urN -x CVS kdelibs.orig/interfaces/kscript/sample/shellscript.desktop kdelibs/interfaces/kscript/sample/shellscript.desktop
--- kdelibs.orig/interfaces/kscript/sample/shellscript.desktop	Tue Aug 31 09:21:05 2004
+++ kdelibs/interfaces/kscript/sample/shellscript.desktop	Sat Oct 30 08:38:04 2004
@@ -1,6 +1,7 @@
 [Desktop Entry]
 Encoding=UTF-8
 Name=Bash Shell Script Runner
+Name[af]=Bash Tolk Skrip Hardloper
 Name[az]=Bash Qabıq Skripti İcraçısı
 Name[bn]=ব্যাশ শেল স্ক্রিপ্ট চালক
 Name[bs]=Izvršavanje Bash shell skripti
@@ -17,6 +18,7 @@
 Name[fa]=مجری نویسه‌ی پوسته‌ی بش
 Name[fi]=Komentotulkkiohjelmien käynnistäjä
 Name[fr]=Lanceur de scripts shell Bash
+Name[ga]=Reathaí Script Bhlaoisce bash
 Name[gl]=Guión Executábel da Shell Bash
 Name[hi]=बैश शेल स्क्रिप्ट चालक
 Name[hr]=Izvršivač skripti Bash shella
@@ -26,6 +28,7 @@
 Name[ja]=Bash シェルスクリプト 実行
 Name[ko]=배쉬 쉘 스크립트 실행기
 Name[lt]=Bash apvalkalo skriptų paleidėjas
+Name[mk]=Стартувач на скрипти за школката Bash Shell 
 Name[mn]=Bash-Shell-Скрипт ажиллуулагч
 Name[ms]=Pelaksana Skrip Cengkerang Bash
 Name[nb]=Bash skallskriptkjører
@@ -56,6 +59,7 @@
 X-KDE-Script-Runner=ShellScript/bash
 ServiceTypes=KScriptRunner/KScriptRunner
 Comment=Runs bash shell scripts from inside the application.
+Comment[af]=Laai bash tolk skripte vanuit die program.
 Comment[ar]=يشغَل bash shell scripts من داخل التطبيق
 Comment[az]=Proqramın içindən bash qabıq skriptlərini icra edin
 Comment[bg]=Изпълнение на скриптове на bash от друга програма.
@@ -73,6 +77,7 @@
 Comment[fa]=نویسه‌‌های پوسته‌ی بش را از داخل یک برنامه اجرا می‌کند.
 Comment[fi]=Suorittaa Bash-komentotulkkiohjelmia ohjelman sisästä
 Comment[fr]=Exécute des scripts shell Bash depuis l'intérieur de l'application.
+Comment[ga]=Ritheann seo scripteanna blaoisce bash ó thaobh istigh an fheidhmchlair.
 Comment[gl]=Executa guións da shell bash dende dentro da aplicación.
 Comment[he]=מריץ תסריטי Bash מתוך היישום
 Comment[hi]=अनुप्रयोगों के भीतर से ही बैश शेल स्क्रिप्ट चलाता है.
@@ -84,10 +89,11 @@
 Comment[ja]=アプリケーション内部からの Bash シェルスクリプトを実行します
 Comment[ko]=응용 프로그램에서 배쉬 쉘 스크립트를 실행합니다.
 Comment[lt]=Paleidžia bash apvalkalo skriptus iš taikomosios programos
+Comment[mk]=Ги стартува bash shell скриптите од апликацијата.
 Comment[mn]=Програм дотроос Bash-Shell-Скрипт ажиллуулах.
 Comment[ms]=Laksanakan skrip cengkerang bash di dalam aplikasi.
 Comment[nb]=Kjører bash skallskript fra innsiden av programmet.
-Comment[nds]=Dormit kunn'n Programm ok'n Bash-Shellskript utföhren
+Comment[nds]=Dormit köönt Programmen ok Bash-Shellskripten utföhren.
 Comment[nl]=Voert Bash-shellscripts uit binnen de toepassing.
 Comment[nn]=Køyrer Bash-skalskript innanfrå programmet.
 Comment[pa]=ਇੱਕ ਕਾਰਜ ਵਿੱਚ ਬਾਸ਼ ਸ਼ੈਲ ਸਕ੍ਰਿਪਟਾਂ ਚਲਾਉਣ ਲਈ ਸਹਾਇਕ ਹੈ
diff -urN -x CVS kdelibs.orig/interfaces/kscript/scriptinterface.desktop kdelibs/interfaces/kscript/scriptinterface.desktop
--- kdelibs.orig/interfaces/kscript/scriptinterface.desktop	Tue Aug 31 09:21:05 2004
+++ kdelibs/interfaces/kscript/scriptinterface.desktop	Mon Nov 15 08:54:56 2004
@@ -22,13 +22,14 @@
 Comment[fi]=Tämä on yleinen skriptitestimoottori skriptin käyttöliittymän testaamiseen
 Comment[fo]=Hetta er ein almen royndarforritsskipan til at nároyna fjølvisforritsmarkamótið.
 Comment[fr]=Ceci est un moteur de script de test générique pour expérimenter l'interface de script.
+Comment[ga]=Is inneall tastála cineálach scripteanna é seo a úsáidtear chun an comhéadan scripte a thástáil.
 Comment[gl]=Ésta é unha ferramenta para proba-la interface dos guións.
 Comment[he]=זהו מנוע תסריטים כללי לבדיקת ממשק התסריטים
 Comment[hi]= स्क्रिप्ट इंटरफेस जांचने के लिए यह एक जेनरिक टेस्ट स्क्रिप्ट इंजन है.
 Comment[hu]=Ez egy tesztszkript a szkript-felület kipróbálásához.
 Comment[is]=Þetta er almennur þýðandi til að prófa skriftuviðmótið.
 Comment[it]=Questo è un motore di script generico per provare l'interfaccia di script.
-Comment[ja]=これはスクリプトインターフェースをテストする一般的なテストスクリプトです。
+Comment[ja]=これはスクリプトインターフェイスをテストする一般的なテストスクリプトです。
 Comment[ko]=스크립트 인터페이스를 시험하는데 쓰이는 일반 시험 스크립트 엔진입니다.
 Comment[lt]=Tai yra bendras testavimo skriptų variklis skirtas  skriptų sąsajos testavimui.
 Comment[lv]=Šis ir vispārējs skriptu testa dzinējs skriptu saskarsmes virsmas testēšanai.
@@ -36,7 +37,7 @@
 Comment[ms]=Ini ialah enjin skrip uji generik untuk mencuba antaramuka skrip.
 Comment[mt]=Magna ġenerika biex tittestja l-interfaċċja tal-iskritti
 Comment[nb]=Dette er et generisk testskript for å teste skriptgrensesnitt.
-Comment[nds]=Dit is een allgemeene Koppel vun Testroutinen för dat Pröven vun den Skript-Verbinnen
+Comment[nds]=Dit is en allgemeen Koppel vun Testroutinen för dat Pröven vun de Skript-Verbinnen.
 Comment[nl]= Dit is een algemene verzameling van testroutines voor het testen dan de script-interface.
 Comment[nn]=Dette er ein generell testskriptmotor for å prøva ut skriptgrensesnittet.
 Comment[nso]=Ye ke engine ya thswaelo ya teko ya kakaretso yeo e somiswago go leka sefahlego sa tshwaelo.
diff -urN -x CVS kdelibs.orig/interfaces/ktexteditor/kcm_ktexteditor.desktop kdelibs/interfaces/ktexteditor/kcm_ktexteditor.desktop
--- kdelibs.orig/interfaces/ktexteditor/kcm_ktexteditor.desktop	Tue Aug 31 09:21:05 2004
+++ kdelibs/interfaces/ktexteditor/kcm_ktexteditor.desktop	Mon Nov 22 09:34:03 2004
@@ -30,9 +30,11 @@
 Name[ja]=埋め込みテキストエディタ
 Name[ko]=끼워넣은 글월 편집기
 Name[lt]=Įdėtas tekstų redaktorius
+Name[mk]=Вгнезден текст уредувач
 Name[mn]=Холбоост текст боловсруулагч
 Name[ms]=Editor Teks Terimplan
 Name[nb]=Innebygget skriveprogram
+Name[nds]=Inbett Text-Editor
 Name[nl]=Ingebedde tekst-editor
 Name[nn]=Inkluderbart skriveprogram
 Name[nso]=Mofetosi wa Sengwalwana yo a Robaditswego
@@ -63,7 +65,7 @@
 Name[zu]=Umlungisi Wombhalo Oshuthekiwe
 Comment=The text editor service provides applications with a text viewer and editor. KDE applications that provide text editing facilities should use this service.
 Comment[af]=Die teks redigeerder diens verskaf programme met 'n teks aansig en redigeerder. Kde programme wat verskaf teks redigering fasiliteite moet gebruik hierdie diens.
-Comment[ar]=تقوم خدمة محرر النصوص بتزويد التطبيقات بمعاين نصوص محرر. يجب أن تستخدم تطبيقات كيدي التي تزود بتسهيلات تحرير النصوص هذه الخدمة.
+Comment[ar]=تقوم خدمة محرر النصوص بتزويد التطبيقات بمعاين نصوص ومحرر. يجب أن تستخدم تطبيقات كيدي التي تزود بتسهيلات تحرير النصوص هذه الخدمة.
 Comment[az]=Mətn redaktə xidməti proqramları mətn nümayişçisi və editoru ilə tə'min edir. Mətn redaktə bacarıqları olan proqramlar bu xidməti işlətməlidir.
 Comment[bg]=Текстовия редактор, представлява компонент за вграждане в другите програми, който предоставя функционалност за разглеждане и редактиране на текстови файлове.
 Comment[bn]=টেক্সট সম্পাদক সার্ভিসটি বিভিন্ন অ্যাপলিকেশন-কে একটি টেক্সট প্রদর্শক এবং সম্পাদক ব্যবহার করার সুযোগ দেয়। কোন কে.ডি.ই. অ্যাপলিকেশন টেক্সট সম্পাদনা করার সুবিধা দিতে চাইলে তার এই সার্ভিসটি ব্যবহার করা উচিত্‍।
@@ -92,11 +94,12 @@
 Comment[ja]=テキストビューアやテキスト編集の機能をアプリケーションに 提供するテキストエディタサービスです。テキスト編集の機能を持つ KDEアプリケーションはこれを使用するべきです。
 Comment[ko]=이 글월 편집기 서비스는 응용 프로그램이 글월을 보거나 고칠 수 있는 기능을 제공합니다. 글월을 고칠 수 있는 KDE 응용 프로그램은 이 서비스를 써야 합니다.
 Comment[lt]=Teksto redaktoriaus tarnyba pateikia programoms teksto žiūriklį ir redaktorių.  KDE programos, leidžiančios redaguoti tekstą, turėtų naudoti šią tarnybą.
+Comment[mk]=Сервисот за текст уредувач ги снабдува апликациите со текст прегледник и уредувач. KDE апликациите што овозможуваат уредување текст би требало да го користат овој сервис.
 Comment[mn]=Текст засварлагч үйлчилгээ нь текст харах болон засварлах прогрммуудаар хангадаг. KDE программууд энэ үйлчилгээний хэрэглэх хэрэгтэй текст засварлах нэмэлт боломжуудаар хангадаг.
 Comment[ms]= Servis penyunting teks yang menyediakan aplikasi dengan pelihat teks dan editor. Aplikasi KDE yang menyediakan kemudahan penyuntingan teks patut menggunakan servis ini.
 Comment[mt]=Is-servizz ta' editur ta' test jipprovdi l-programmi b'werrej u editur ta' test. Programmi tal-KDE li jipprovdu servizzi ta' editjar ta' test għandhom jużaw dan is-servizz.
 Comment[nb]=Skriveprogrammet gir kan vise og redigere teks. KDE-programmer som kan redigere tekst bør bruke denne tjenesten.
-Comment[nds]=För Programmen gifft dat den Texteditor-Service, de een Text-Wieser und een Editor tofögt. KDE Programmen mit den Texten bewerkt warrn, schull dat bruken.
+Comment[nds]=För Programmen gifft dat den Texteditor-Deenst, de en Text-Wieser un en Editor toföögt. KDE-Programmen, mit de Texten bewerkt warrn, schullen dat bruken.
 Comment[nl]=Dit component stelt programma's een tekstviewer en -editor tot hun beschikking. KDE-toepassingen die te maken hebben met het bewerken van tekst kunnen gebruik maken van deze aangeboden dienst.
 Comment[nn]=Skriveprogramtenesta tilbyr vising og redigering av tekst. KDE-program som skal visa eller redigera tekst bør bruka denne tenesta.
 Comment[nso]=Tirelo ya phetoso ya sengwalwana e aba ditshumiso le molebeledi lemofetosi  wa sengwalwana. Ditshumiso tsa KDE tseo di abago ditirelo tsaphetoso ya sengwalwana di swanetse go somisa tirelo ye.
@@ -115,7 +118,7 @@
 Comment[ss]=Lusito lwekuhleal umbhalo luniketa ticelo letinesibuki sembhalo kanye nesihleli. Ticelo te KDe letiniketa tinsita tekuhlelwa kwembhalo kufanele tisebentise lolusito.
 Comment[sv]=Texteditortjänsten ger program en textvisare och editor. KDE-program som tillhandahåller textredigeringsfunktioner bör använda denna tjänst.
 Comment[ta]=உரை மற்றும் தொகுப்பாளருடனான பயன்பாடுகளை உரை தொகுப்பாளர் சேவை வழங்குகிறது. உரை தொகுக்கும் வசதிகளை வழங்கும் கேடிஇ பயன்பாடுகள் இச்சேவையைப் பயன்படுத்த வேண்டும்.
-Comment[tg]=Хизмати муҳаррири матн гузоришҳои хамроҳи намоишгари матн ва муҳаррир пешкаш менамояд. Гузоришҳои KDE ки имконоти муҳаррири матнрои пешкаш менамояд ин хизматро бояд истифода кунад. 
+Comment[tg]=Хизмати муҳаррири матн барномаҳои бо матни намоишгар ва муҳаррирро пешкаш менамояд. Барномаҳои KDE  имконоти муҳаррири матнро пешкаш менамояд, ки ин хизматро бояд истифода бурд. 
 Comment[uk]=Служба "Текстовий редактор" постачає програми з переглядачем та редактором тексту. Програми KDE, які надають можливість редагування тексту, повинні користуватись цією службою.
 Comment[uz]=Матн тарҳрирчи хизмати дастурларни матн кўрувчи ва таҳрирчи билан таъминлайди. Матн таҳрирлаш имкониятини яратувчи KDE дастурлари шу хизматни ишлатиши керак.
 Comment[ven]=Tshumelo ya musengulusi wa manwalwa i diswa apulifikhesheni dzirena na vhavhoni vha manwalwa na musengulusi. Apulifikhesheni ya KDE ine ya disa zwishumiswa zwa u sengulusa manwalwa i fanela u shumisa tshumelo ino.
diff -urN -x CVS kdelibs.orig/interfaces/ktexteditor/ktexteditor.desktop kdelibs/interfaces/ktexteditor/ktexteditor.desktop
--- kdelibs.orig/interfaces/ktexteditor/ktexteditor.desktop	Tue Aug 31 09:21:05 2004
+++ kdelibs/interfaces/ktexteditor/ktexteditor.desktop	Sat Oct 30 08:38:04 2004
@@ -35,10 +35,12 @@
 Comment[ko]=끼워넣는 글월 편집기 구성 요소 (Doc/View 나눔)
 Comment[lt]=Įdedamas tekstų redaktoriaus komponentas (su Doc/View atskyrimu)
 Comment[lv]=Iegulstama Tekstu Redaktora Komponente (ar Doc/Skatīt Atdalīšanu)
+Comment[mk]=Вгнездлива компонента за уредување на текст (со Док/Приказ раздвојување)
 Comment[mn]=Суулгах боломж бүхий засварлагчийн бүрдэл хэсэг(Teкст/Харах-тусгаарлалттай)
 Comment[ms]=Komponen Penyunting Teks Boleh Selit (Dokumentasi/Pelihat berasingan)
 Comment[mt]=Komponent integrat editur tat-test (b'separazzjoni dokument/wiri)
 Comment[nb]=Innebyggbar tekstredigeringskomponent (med Doc/View-skille)
+Comment[nds]=Inbettbor Texteditor-Komponent (mit Dokment/Ansicht-Trennen)
 Comment[nl]=Ingebed teksteditorcomponent (met scheiding van tekst/weergave)
 Comment[nn]=Inkluderbart komponent for tekstvising (med Doc/View-deling)
 Comment[nso]=Seripa seo se Robatsegago sa Mofetosi wa Sengwalwana (le Karogano ya Doc/Bona)
diff -urN -x CVS kdelibs.orig/interfaces/ktexteditor/ktexteditoreditor.desktop kdelibs/interfaces/ktexteditor/ktexteditoreditor.desktop
--- kdelibs.orig/interfaces/ktexteditor/ktexteditoreditor.desktop	Tue Aug 31 09:21:05 2004
+++ kdelibs/interfaces/ktexteditor/ktexteditoreditor.desktop	Sat Oct 30 08:38:04 2004
@@ -35,10 +35,12 @@
 Comment[ko]=끼워넣는 글월 편집기 구성 요소 (Doc/View 나누지 않음)
 Comment[lt]=Įdedamas tekstų redaktoriaus komponentas (be Doc/View atskyrimo)
 Comment[lv]=Iegulstama Tekstu Redaktora Komponente (bez Doc/Skatīt Atdalīšanas)
+Comment[mk]=Вгнездлива компонента за уредување на текст (без Док/Приказ раздвојување)
 Comment[mn]=Суулгах боломж бүхий засварлагчийн бүрдэл хэсэг(Teкст/Харах-тусгаарлалтгүй)
 Comment[ms]=Komponen Penyunting Teks Boleh Selit (Dokumentasi/Pelihat tidak berasingan)
 Comment[mt]=Komponent integrat editur tat-test (mingħajr separazzjoni dokument/wiri)
 Comment[nb]=Innebyggbar tekstredigeringskomponent (uten Doc/View skille)
+Comment[nds]=Inbettbor Texteditor-Komponent (ahn Dokment/Ansicht-Trennen)
 Comment[nl]=Ingebed teksteditorcomponent (zonder scheiding van tekst/weergave)
 Comment[nn]=Inkluderbart komponent for tekstvising (utan Doc/View-deling)
 Comment[nso]=Seripa seo se Robatsegago sa Mofetosi wa Sengwalwana (kantle le Karogano ya Doc/Bona)
diff -urN -x CVS kdelibs.orig/interfaces/ktexteditor/ktexteditorplugin.desktop kdelibs/interfaces/ktexteditor/ktexteditorplugin.desktop
--- kdelibs.orig/interfaces/ktexteditor/ktexteditorplugin.desktop	Tue Aug 24 08:28:52 2004
+++ kdelibs/interfaces/ktexteditor/ktexteditorplugin.desktop	Sat Oct 30 08:38:04 2004
@@ -4,6 +4,7 @@
 X-KDE-ServiceType=KTextEditor/Plugin
 X-KDE-Derived=
 Comment=KTextEditor Plugin
+Comment[af]=KTextEditor Inprop Module
 Comment[ar]=مساعد برنامج KTextEditor
 Comment[az]=KTextEditor Əlavəsi
 Comment[be]=Дапаўненьне K Тэкставага рэдактара
@@ -36,6 +37,7 @@
 Comment[ja]=KTextEditorプラグイン
 Comment[ko]=K글월편집기 플러그인
 Comment[lt]=KTextEditor priedas
+Comment[mk]=KTextEditor приклучок
 Comment[mn]=Текст засварлагч
 Comment[ms]=Plugmasuk KTextEditor
 Comment[mt]=Plagin KTextEditor 
@@ -55,7 +57,7 @@
 Comment[sl]=Vstavek KTextEditor
 Comment[sq]=Shtojca KTextEditor
 Comment[sr]=KTextEditor прикључак
-Comment[sr@Latn]=KTextEditor dodatak
+Comment[sr@Latn]=KTextEditor priključak
 Comment[ss]=I-plugini ye KTextEditor 
 Comment[sv]=Insticksprogram för texteditor
 Comment[ta]=கேஉரைதொகுப்பி சொருகுப்பொருள்
diff -urN -x CVS kdelibs.orig/kabc/formats/binary.desktop kdelibs/kabc/formats/binary.desktop
--- kdelibs.orig/kabc/formats/binary.desktop	Tue Aug 24 08:28:54 2004
+++ kdelibs/kabc/formats/binary.desktop	Sat Oct 30 08:38:05 2004
@@ -6,6 +6,7 @@
 Name[az]=İcraçı
 Name[bg]=Двоичен
 Name[bn]=বাইনারি
+Name[br]=Binarel
 Name[bs]=Binarno
 Name[ca]=Binari
 Name[cs]=Binární
@@ -31,6 +32,7 @@
 Name[ja]=バイナリ
 Name[ko]=바이너리
 Name[lt]=Dvejetainis
+Name[mk]=Бинарен
 Name[mn]=Бинар
 Name[ms]=Binari
 Name[mt]=Binarju
diff -urN -x CVS kdelibs.orig/kabc/kab2kabc.desktop kdelibs/kabc/kab2kabc.desktop
--- kdelibs.orig/kabc/kab2kabc.desktop	Tue Aug 24 08:28:54 2004
+++ kdelibs/kabc/kab2kabc.desktop	Sun Nov 28 09:33:01 2004
@@ -49,11 +49,12 @@
 Comment[ko]=libkab을 libkabc로 바꿔주는 연장.
 Comment[lt]=libkab į libkabc konvertavimo įrankis.
 Comment[lv]=libkab uz libkabc kovertēšanas rīks.
+Comment[mk]=алатка за претворање од libkab во libkabc.
 Comment[mn]=libkab-аас libkabc-руу хөрвүүлэгч
 Comment[ms]=perkakasan penukaran libkab to libkabc.
 Comment[mt]=Għodda għall-konverżjoni libkab għal libkabc
 Comment[nb]=libkab til libkabc konverteringsverktøy.
-Comment[nds]=Warktüüg för't konverteern vun libkab na libkabc
+Comment[nds]=Warktüüch för't Konverteren vun libkab na libkabc.
 Comment[nl]=Conversieprogramma van libkab naar libkabc.
 Comment[nn]=Konverterer libkab til libkabc
 Comment[nso]=Sebereka sa phetosetso ya libkab go libkabc
@@ -63,7 +64,7 @@
 Comment[pt_BR]=Ferramenta de conversão de libkab para libkabc.
 Comment[ro]=Utilitar de conversie de la "libkab" la "libkabc".
 Comment[ru]=утилита преобразования libkab в libkabc.
-Comment[se]=konverterenneavvu libkab:as libkabc:ai
+Comment[se]=konverterenreaidu libkab:as libkabc:ai
 Comment[sk]=Prevod dát z libkab do libkabc.
 Comment[sl]=Orodje za pretvorbo iz libkab v libkabc
 Comment[sq]=Vegla për shëndrimin e libkab në libkabc.
diff -urN -x CVS kdelibs.orig/kabc/ldif.cpp kdelibs/kabc/ldif.cpp
--- kdelibs.orig/kabc/ldif.cpp	Tue Oct  5 18:50:42 2004
+++ kdelibs/kabc/ldif.cpp	Tue Oct 12 22:29:16 2004
@@ -25,8 +25,6 @@
 
 using namespace KABC;
 
-static const char delimiter[ 3 ] = { '\n', '\n', '\n' };
-
 LDIF::LDIF()
 {
   startParsing();
@@ -90,9 +88,11 @@
   QCString ret;
   QByteArray tmp;
   uint valuelen = value.length();
-  tmp.setRawData( value, valuelen );
+  const char *data = value.data();
+
+  tmp.setRawData( data, valuelen );
   ret = assembleLine( fieldname, tmp, linelen, url );
-  tmp.resetRawData( value, valuelen );
+  tmp.resetRawData( data, valuelen );
   return ret;
 
 }
@@ -108,6 +108,7 @@
   int position;
   QByteArray tmp;
   int linelen;
+  const char *data;
 
 //  kdDebug(5700) << "splitLine line: " << QString::fromUtf8(line) << endl;
 
@@ -118,9 +119,10 @@
     QCString str;
     str = line.stripWhiteSpace();
     linelen = str.length();
-    tmp.setRawData( str.data(), linelen );
+    data = str.data();
+    tmp.setRawData( data, linelen );
     value = tmp.copy();
-    tmp.resetRawData( str.data(), linelen );
+    tmp.resetRawData( data, linelen );
 //    kdDebug(5700) << "value : " << value[0] << endl;
     return false;
   }
@@ -135,9 +137,10 @@
       value.resize( 0 );
       return false;
     }
-    tmp.setRawData( &line.data()[ position + 3 ], linelen - position - 3 );
+    data = &line.data()[ position + 3 ];
+    tmp.setRawData( data, linelen - position - 3 );
     KCodecs::base64Decode( tmp, value );
-    tmp.resetRawData( &line.data()[ position + 3 ], linelen - position - 3 );
+    tmp.resetRawData( data, linelen - position - 3 );
     return false;
   }
 
@@ -149,9 +152,10 @@
       value.resize( 0 );
       return false;
     }
-    tmp.setRawData( &line.data()[ position + 3 ], linelen - position - 3 );
+    data = &line.data()[ position + 3];
+    tmp.setRawData( data, linelen - position - 3 );
     value = tmp.copy();
-    tmp.resetRawData( &line.data()[ position + 3 ], linelen - position - 3 );
+    tmp.resetRawData( data, linelen - position - 3 );
     return true;
   }
 
@@ -160,9 +164,10 @@
     value.resize( 0 );
     return false;
   }
-  tmp.setRawData( &line.data()[ position + 2 ], linelen - position - 2 );
+  data = &line.data()[ position + 2 ];
+  tmp.setRawData( data, linelen - position - 2 );
   value = tmp.copy();
-  tmp.resetRawData( &line.data()[ position + 2 ], linelen - position - 2 );
+  tmp.resetRawData( data, linelen - position - 2 );
   return false;
 }
 
@@ -338,7 +343,11 @@
 
 void LDIF::endLDIF()
 {
-  mLdif.resetRawData( delimiter, 3 );  
+  QByteArray tmp( 3 );
+  tmp[ 0 ] = '\n';
+  tmp[ 1 ] = '\n';
+  tmp[ 2 ] = '\n';
+  mLdif = tmp;
   mPos = 0;
 }
 
diff -urN -x CVS kdelibs.orig/kabc/plugins/dir/dir.desktop kdelibs/kabc/plugins/dir/dir.desktop
--- kdelibs.orig/kabc/plugins/dir/dir.desktop	Tue Aug 24 08:28:55 2004
+++ kdelibs/kabc/plugins/dir/dir.desktop	Sat Oct 30 08:38:05 2004
@@ -35,12 +35,11 @@
 Name[ko]=자료방
 Name[lt]=Aplankas
 Name[lv]=Direktorijs
-Name[mk]=Папка
 Name[mn]=Лавлах
 Name[ms]=Direktori
 Name[mt]=Direttorju
 Name[nb]=Katalog
-Name[nds]=Ordner
+Name[nds]=Orner
 Name[nl]=Map
 Name[nn]=Katalog
 Name[nso]=Tshupetso
diff -urN -x CVS kdelibs.orig/kabc/plugins/file/file.desktop kdelibs/kabc/plugins/file/file.desktop
--- kdelibs.orig/kabc/plugins/file/file.desktop	Tue Aug 24 08:28:55 2004
+++ kdelibs/kabc/plugins/file/file.desktop	Sat Oct 30 08:38:05 2004
@@ -1,6 +1,7 @@
 [Desktop Entry]
 Encoding=UTF-8
 Name=File
+Name[af]=Lêer
 Name[ar]=ملفّ
 Name[az]=Fayl
 Name[be]=Файл
@@ -31,6 +32,7 @@
 Name[ja]=ファイル
 Name[ko]=파일
 Name[lt]=Byla
+Name[mk]=Датотека
 Name[mn]=Файл
 Name[ms]=Fail
 Name[nb]=Fil
diff -urN -x CVS kdelibs.orig/kabc/plugins/ldapkio/resourceldapkio.cpp kdelibs/kabc/plugins/ldapkio/resourceldapkio.cpp
--- kdelibs.orig/kabc/plugins/ldapkio/resourceldapkio.cpp	Sat Jul  3 23:46:10 2004
+++ kdelibs/kabc/plugins/ldapkio/resourceldapkio.cpp	Sun Nov 14 18:23:56 2004
@@ -375,6 +375,7 @@
   if ( !mAttributes.contains("jpegPhoto") )
     mAttributes.insert( "jpegPhoto", "jpegPhoto" );
 
+  d->mLDAPUrl = KURL();
   if ( !mAnonymous ) {
     d->mLDAPUrl.setUser( mUser );
     d->mLDAPUrl.setPass( mPassword );
@@ -522,6 +523,8 @@
 {
   kdDebug(7125) << "ResourceLDAPKIO::load()" << endl;
   KIO::Job *job;
+
+  clear();
   //clear the addressee
   d->mAddr = Addressee();
   d->mAd = Address( Address::Home );
@@ -557,6 +560,7 @@
 
 bool ResourceLDAPKIO::asyncLoad()
 {
+  clear();
   //clear the addressee
   d->mAddr = Addressee();
   d->mAd = Address( Address::Home );
@@ -668,6 +672,7 @@
       case LDIF::EndEntry: {
         d->mAddr.setResource( this );
         d->mAddr.insertAddress( d->mAd );
+        d->mAddr.setChanged( false );
         insertAddressee( d->mAddr );
         //clear the addressee
         d->mAddr = Addressee();
diff -urN -x CVS kdelibs.orig/kabc/plugins/net/net.desktop kdelibs/kabc/plugins/net/net.desktop
--- kdelibs.orig/kabc/plugins/net/net.desktop	Tue Aug 24 08:28:56 2004
+++ kdelibs/kabc/plugins/net/net.desktop	Sun Oct 24 09:01:46 2004
@@ -1,6 +1,7 @@
 [Desktop Entry]
 Encoding=UTF-8
 Name=Network
+Name[af]=Netwerk
 Name[ar]=الشبكة
 Name[az]=Şəbəkə
 Name[be]=Сетка
@@ -37,7 +38,7 @@
 Name[mk]=Мрежа
 Name[mn]=Сүлжээ
 Name[ms]=Jaringan
-Name[nds]=Netwark
+Name[nds]=Nettwark
 Name[nl]=Netwerk
 Name[nn]=Nettverk
 Name[nso]=Kgokagano
diff -urN -x CVS kdelibs.orig/kabc/plugins/sql/sql.desktop kdelibs/kabc/plugins/sql/sql.desktop
--- kdelibs.orig/kabc/plugins/sql/sql.desktop	Tue Aug 24 08:28:56 2004
+++ kdelibs/kabc/plugins/sql/sql.desktop	Sun Oct 24 09:01:47 2004
@@ -1,7 +1,6 @@
 [Misc]
 Encoding=UTF-8
 Name=SQL
-Name[af]=Sql
 Name[bn]=এস-কিউ-এল (SQL)
 Name[hi]=एसक्यूएल (SQL)
 Name[ss]=I-SQL
diff -urN -x CVS kdelibs.orig/kate/data/bash.xml kdelibs/kate/data/bash.xml
--- kdelibs.orig/kate/data/bash.xml	Wed Sep 29 10:02:40 2004
+++ kdelibs/kate/data/bash.xml	Wed Oct 13 08:40:49 2004
@@ -3,10 +3,11 @@
 [
 	<!ENTITY funcname "[A-Za-z_:][A-Za-z0-9_:#&#37;@-]*">
 	<!ENTITY varname  "[A-Za-z_][A-Za-z0-9_]*">
+	<!ENTITY word     "[^|&amp;;()&lt;&gt;\s]+">	<!-- see man bash -->
 	<!ENTITY eos      "(?=($|\s))">			<!-- eol or space following -->
 	<!ENTITY noword   "(?![\w$+-])">		<!-- no word, $, + or - following -->
 ]>
-<language name="Bash" version="2.02" kateversion="2.3" section="Scripts" extensions="*.sh;*.bash;*.ebuild;*.eclass" mimetype="application/x-shellscript" casesensitive="1" author="Wilbert Berendsen (wilbert@kde.nl)" license="LGPL">
+<language name="Bash" version="2.04" kateversion="2.3" section="Scripts" extensions="*.sh;*.bash;*.ebuild;*.eclass" mimetype="application/x-shellscript" casesensitive="1" author="Wilbert Berendsen (wilbert@kde.nl)" license="LGPL">
 
 <!-- (c) 2004 by Wilbert Berendsen, wilbert@kde.nl
     Released under the LGPL, part of kdelibs/kate -->
@@ -514,8 +515,6 @@
         <keyword attribute="Command" context="#stay" String="unixcommands" />
 	<!-- handle commands that have variable names as argument -->
 	<keyword attribute="Builtin" context="VarName" String="builtins_var" />
-	<!-- handle &, &&, | and || -->
-	<RegExpr attribute="Control" context="#stay" String="([|&amp;])\1?" />
         <!-- handle here-string -->
 	<StringDetect attribute="Redirection" context="#stay" String="&lt;&lt;&lt;" />
 	<!-- handle here document -->
@@ -524,6 +523,8 @@
         <RegExpr attribute="Redirection" context="ProcessSubst" String="[&lt;&gt;]\(" />
         <!-- handle redirection -->
         <RegExpr attribute="Redirection" context="#stay" String="([0-9]*(&gt;{1,2}|&lt;)(&amp;[0-9]+-?)?|&amp;&gt;|&gt;&amp;|[0-9]*&lt;&gt;)" />
+	<!-- handle &, &&, | and || -->
+	<RegExpr attribute="Control" context="#stay" String="([|&amp;])\1?" />
 	<!-- mark function definitions without function keyword -->
         <RegExpr attribute="Function" context="#stay" String="&funcname;\s*\(\)" />
       </context>
@@ -759,14 +760,14 @@
 
       <!-- HereDoc consumes Here-documents. It is called at the beginning of the "<<" construct. -->
       <context attribute="Normal Text" lineEndContext="#stay" name="HereDoc">
-	<RegExpr attribute="Redirection" context="HereDocQ"   String="(&lt;&lt;\s*&quot;(&varname;)&quot;)" lookAhead="true" />
-	<RegExpr attribute="Redirection" context="HereDocQ"   String="(&lt;&lt;\s*'(&varname;)')" lookAhead="true" />
-	<RegExpr attribute="Redirection" context="HereDocQ"   String="(&lt;&lt;\s*\\(&varname;))" lookAhead="true" />
-	<RegExpr attribute="Redirection" context="HereDocNQ"  String="(&lt;&lt;\s*(&varname;))" lookAhead="true" />
-	<RegExpr attribute="Redirection" context="HereDocIQ"  String="(&lt;&lt;-\s*&quot;(&varname;)&quot;)" lookAhead="true" />
-	<RegExpr attribute="Redirection" context="HereDocIQ"  String="(&lt;&lt;-\s*'(&varname;)')" lookAhead="true" />
-	<RegExpr attribute="Redirection" context="HereDocIQ"  String="(&lt;&lt;-\s*\\(&varname;))" lookAhead="true" />
-	<RegExpr attribute="Redirection" context="HereDocINQ" String="(&lt;&lt;-\s*(&varname;))" lookAhead="true" />
+	<RegExpr attribute="Redirection" context="HereDocQ"   String="(&lt;&lt;\s*&quot;(&word;)&quot;)" lookAhead="true" />
+	<RegExpr attribute="Redirection" context="HereDocQ"   String="(&lt;&lt;\s*'(&word;)')" lookAhead="true" />
+	<RegExpr attribute="Redirection" context="HereDocQ"   String="(&lt;&lt;\s*\\(&word;))" lookAhead="true" />
+	<RegExpr attribute="Redirection" context="HereDocNQ"  String="(&lt;&lt;\s*(&word;))" lookAhead="true" />
+	<RegExpr attribute="Redirection" context="HereDocIQ"  String="(&lt;&lt;-\s*&quot;(&word;)&quot;)" lookAhead="true" />
+	<RegExpr attribute="Redirection" context="HereDocIQ"  String="(&lt;&lt;-\s*'(&word;)')" lookAhead="true" />
+	<RegExpr attribute="Redirection" context="HereDocIQ"  String="(&lt;&lt;-\s*\\(&word;))" lookAhead="true" />
+	<RegExpr attribute="Redirection" context="HereDocINQ" String="(&lt;&lt;-\s*(&word;))" lookAhead="true" />
 	<StringDetect attribute="Redirection" context="#pop"  String="&lt;&lt;" /><!-- always met -->
       </context>
 
diff -urN -x CVS kdelibs.orig/kate/data/cpp.xml kdelibs/kate/data/cpp.xml
--- kdelibs.orig/kate/data/cpp.xml	Thu May 27 23:48:31 2004
+++ kdelibs/kate/data/cpp.xml	Sat Oct 16 20:20:36 2004
@@ -1,6 +1,6 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <!DOCTYPE language SYSTEM "language.dtd">
-<language name="C++" version="1.23" kateversion="2.3" section="Sources" extensions="*.cxx;*.cpp;*.cc;*.C;*.h;*.hxx;*.hpp;*.hcc;*.moc" mimetype="text/x-c++src;text/x-c++hdr;text/x-chdr" priority="9">
+<language name="C++" version="1.24" kateversion="2.3" section="Sources" extensions="*.cxx;*.cpp;*.cc;*.C;*.h;*.hxx;*.hpp;*.hcc;*.moc" mimetype="text/x-c++src;text/x-c++hdr;text/x-chdr" priority="9">
   <highlighting>
     <list name="keywords">
       <item> asm </item>
@@ -116,11 +116,6 @@
       <item> uint64_t </item>
       <item> wchar_t </item>
     </list>
-    <list name="attention">
-      <item> FIXME </item>
-      <item> TODO </item>
-      <item> ### </item>
-    </list>
     <contexts>
       <context attribute="Normal Text" lineEndContext="#stay" name="Normal">
         <RegExpr attribute="Region Marker" context="#stay" String="//\s*BEGIN.*$" beginRegion="Region1"/>
@@ -168,7 +163,7 @@
         <IncludeRules context="##Alerts" />
       </context>
       <context attribute="Comment" lineEndContext="#stay" name="Commentar 2">
-        <keyword attribute="Alert" context="#stay" String="attention" />
+        <IncludeRules context="##Alerts" />
         <Detect2Chars attribute="Comment" context="#pop" char="*" char1="/" endRegion="Comment"/>
       </context>
       <context attribute="Preprocessor" lineEndContext="#pop" name="Preprocessor">
@@ -216,7 +211,6 @@
       <itemData name="Symbol"       defStyleNum="dsNormal"/>
       <itemData name="Preprocessor" defStyleNum="dsOthers"/>
       <itemData name="Prep. Lib"    defStyleNum="dsOthers"/>
-      <itemData name="Alert"        defStyleNum="dsAlert" />
       <itemData name="Region Marker" defStyleNum="dsRegionMarker" />
     </itemDatas>
   </highlighting>
diff -urN -x CVS kdelibs.orig/kate/data/katepart.desktop kdelibs/kate/data/katepart.desktop
--- kdelibs.orig/kate/data/katepart.desktop	Tue Aug 31 09:21:08 2004
+++ kdelibs/kate/data/katepart.desktop	Sat Oct 30 08:38:05 2004
@@ -32,10 +32,12 @@
 Name[ja]=埋め込み高機能テキストエディタ
 Name[ko]=끼워넣은 고급 글월 편집기
 Name[lt]=Įdėtas sudėtingesnis tekstų redaktorius
+Name[mk]=Вгнезден напреден текст уредувач
 Name[mn]=Kate-хэрэгсэл
 Name[ms]=Penyunting Teks Termaju Terimplan
 Name[mt]=Editur ta' test integrat avvanzat
 Name[nb]=Innebyggbart, avansert tekstredigerings-program
+Name[nds]=Inbett verwiedert Texteditor
 Name[nl]=Ingebed tekstinvoercomponent
 Name[nn]=Inkluderbart avansert skriveprogram
 Name[nso]=Mofetosi yo a Robaditswego wa Sengwalwana seo se Beetswegopele
diff -urN -x CVS kdelibs.orig/kate/data/perl.xml kdelibs/kate/data/perl.xml
--- kdelibs.orig/kate/data/perl.xml	Sun Jun 20 21:56:41 2004
+++ kdelibs/kate/data/perl.xml	Mon Nov  8 17:54:50 2004
@@ -23,16 +23,21 @@
    Please do not commit changes without checking with me.
 
    *** TODO ***
-   s/// - Either make a special case, or better, enable saving data in contexts,
-      so any delimiter can be handled correctly!
 
-   The variable detection is not entirely left if there is a variable in a key.
-      Samples:
-      $hask{ $key }{ value }; ## comments are not detected
+   Work on the comment support in the REPLACEMENT part of s/// - we may support
+   the comment, if the line remainder does not contain the delimiter char.
 
-   HERE document delimiters - requires support for saving data in contexts.
+   Try to support ?PATTERN? (at least in one line, like if "\?(?=.*\?)" matches).
+
+   parse code behind '<<HEREDELIMITER' as code, or at least ignore it, to eol.
+   Requires the ability to pass the delimiter through a context level.
+
+   find a here delimiter like '*END*' (Shell.pm). Requires that when a regex is
+   inserting a dynamic string, it escapes [*(){}$[]
+
+   Enhance tr/// and y/// support.
 -->
-<language name="Perl" version="1.12" kateversion="2.3" section="Scripts" extensions="*.pl;*.pm" mimetype="application/x-perl;text/x-perl" author="Anders Lund (anders@alweb.dk)" license="LGPL">
+<language name="Perl" version="1.15" kateversion="2.3" section="Scripts" extensions="*.pl;*.pm" mimetype="application/x-perl;text/x-perl" author="Anders Lund (anders@alweb.dk)" license="LGPL">
   <highlighting>
     <list name="keywords">
       <item> if </item>
@@ -324,351 +329,442 @@
         <RegExpr attribute="Keyword" context="#stay" String="^#!\/.*" />
         <RegExpr attribute="Keyword" context="data_handle" String="^__DATA__" />
         <RegExpr attribute="Keyword" context="#stay" String="^__END__" />
+        <RegExpr attribute="Keyword" context="sub_name_def" String="\bsub\s+" />
         <keyword attribute="Keyword" context="#stay" String="keywords" />
         <keyword attribute="Operator" context="#stay" String="operators" />
         <keyword attribute="Function" context="#stay" String="functions" />
         <keyword attribute="Pragma" context="#stay" String="pragmas" />
-        <RegExpr attribute="Comment" context="comment" String="#" />
-        <RegExpr attribute="Pod" context="pod" String="^\=(?:head[1-6]|over|back|item|for|begin|end|pod)\s*.*" beginRegion="POD"/>
-        <RegExpr attribute="Keyword" context="sub_name_def" String="\s*sub\s+" />
+        <DetectChar attribute="Comment" context="comment" char="#" />
+        <RegExpr attribute="Pod" context="pod" String="^\=(?:head[1-6]|over|back|item|for|begin|end|pod)(\s|$)" beginRegion="POD"/>
 
         <HlCOct attribute="Octal" context="slash_safe_escape" />
         <HlCHex attribute="Hex" context="slash_safe_escape" />
         <Float attribute="Float" context="slash_safe_escape" />
         <Int attribute="Decimal" context="slash_safe_escape" />
 
-        <RegExpr attribute="Normal Text" context="#stay" String="\\[&quot;']" />
-        <Detect2Chars attribute="Normal Text" context="#stay" char="&amp;" char1="'" />
-        <DetectChar attribute="String (interpolated)" context="ip_string" char="&quot;"/>
-        <DetectChar attribute="String" context="string" char="'"/>
+        <RegExpr attribute="Normal Text" context="#stay" String="\\([&quot;'])[^\1]" />
+        <Detect2Chars attribute="Normal Text" context="#stay" char="&amp;" char1="'" /><!-- ??? -->
+        <DetectChar attribute="Operator" context="ip_string" char="&quot;" beginRegion="String" />
+        <DetectChar attribute="Operator" context="string" char="'"  beginRegion="String"/>
         <DetectChar attribute="Operator" context="Backticked" char="`" />
-        <AnyChar attribute="Operator" context="#stay" String="&amp;\" />
 
-        <RegExpr attribute="Special Variable" context="var_detect" String="\$[0-9]+" />
-        <RegExpr attribute="Special Variable" context="var_detect" String="[@\$](?:[\+\-_]\B|ARGV\b|INC\b)" />
-        <RegExpr attribute="Special Variable" context="var_detect" String="[%\$](?:INC\b|ENV\b|SIG\b)" />
-        <RegExpr attribute="Data Type" context="var_detect" String="\$\$[\$\w_]" />
-        <RegExpr attribute="Data Type" context="var_detect" String="\$[#_][\w_]" />
-        <RegExpr attribute="Special Variable" context="slash_safe_escape" String="\$[^a-zA-Z0-9\s{][A-Z]?" />
-        <RegExpr attribute="Data Type" context="var_detect" String="[\$@%]\{[\w_]+\}" />
-        <RegExpr attribute="Data Type" context="var_detect" String="[\$@%]" />
-        <RegExpr attribute="Data Type" context="var_detect" String="\*[a-zA-Z_]+" />
+        <RegExpr attribute="Normal Text" context="find_variable" String="(?:[$@]\S|%[\w{]|\*[^\d\*{\$@%=(])" lookAhead="true" />
 
         <RegExpr attribute="Keyword" context="#stay" String="&lt;[A-Z0-9_]+&gt;" />
-        <RegExpr attribute="Keyword" context="#stay" String="\s*&lt;&lt;\s*[&quot;']?[A-Z0-9_\-]+[&quot;']?" />
-        <RegExpr attribute="Normal Text" context="#stay" String="\s*[)}]\s*/" />
-        <RegExpr attribute="Normal Text" context="sub_name_def" String="\w+::" />
+
+        <RegExpr attribute="Operator" context="find_here_document" String="\s*&lt;&lt;(?=\w+|\s*[&quot;'])" beginRegion="HereDocument" />
+
+        <RegExpr attribute="Normal Text" context="#stay" String="\s*\}\s*/" endRegion="Block"/>
+        <RegExpr attribute="Normal Text" context="#stay" String="\s*[)]\s*/" />
+        <RegExpr attribute="Function" context="sub_name_def" String="\w+::" />
         <RegExpr attribute="Normal Text" context="#stay" String="\w+[=]" />
 
-        <RegExpr attribute="String (interpolated)" context="ip_string_2" String="q[qx]\(" />
-        <RegExpr attribute="String (interpolated)" context="ip_string_3" String="q[qx]\{" />
-        <RegExpr attribute="String (interpolated)" context="ip_string_4" String="q[qx]\[" />
-        <RegExpr attribute="String (interpolated)" context="ip_string_5" String="q[qx]&lt;" />
-        <RegExpr attribute="String (interpolated)" context="#stay" String="q[qx]([^a-zA-Z0-9_\s[\]{}()]).*\1" minimal="true" />
-
-        <Detect2Chars attribute="String" context="string_2" char="q" char1="(" />
-        <Detect2Chars attribute="String" context="string_3" char="q" char1="{" />
-        <Detect2Chars attribute="String" context="string_4" char="q" char1="[" />
-        <Detect2Chars attribute="String" context="string_5" char="q" char1="&lt;" />
-        <RegExpr attribute="String" context="#stay" String="q([^a-zA-Z0-9_\s[\]{}()]).+\1" />
-
-        <StringDetect attribute="Normal Text" context="quote_word" String="qw/" />
-
-        <Detect2Chars attribute="Pattern" context="subst_curlybrace_pattern" char="s" char1="{" />
-        <Detect2Chars attribute="Pattern" context="subst_paren_pattern" char="s" char1="(" />
-        <Detect2Chars attribute="Pattern" context="subst_bracket_pattern" char="s" char1="[" />
-        <Detect2Chars attribute="Pattern" context="subst_slash_pattern" char="s" char1="/" />
-
-        <RegExpr attribute="Pattern" context="#stay" String="(?:s|tr|y)\([^)]*\)\s*\([^)]*\)" />
-        <RegExpr attribute="Pattern" context="#stay" String="(?:s|tr|y)\{[^}]*\}\s*\{[^}]*\}" />
-        <RegExpr attribute="Pattern" context="#stay" String="(?:s|tr|y)\[[^}]*\]\s*\[[^\]]*\]" />
-        <RegExpr attribute="Pattern" context="#stay" String="(?:s|tr|y)([^a-zA-Z0-9_\s[\]{}()]).*\1.*\1" minimal="true"/>
-
-        <RegExpr attribute="Normal Text" context="#stay" String="[\w_]{3,}[[{:\-.;,]" />
-        <RegExpr attribute="Normal Text" context="#stay" String="[\w_]([mqsy]|q[rx])\(" />
-
-        <RegExpr attribute="Pattern" context="pattern_slash" String="(?:m|qr)\/" />
-        <RegExpr attribute="Pattern" context="#stay" String="(?:m|q[rx])\([^)]*\)" />
-        <RegExpr attribute="Pattern" context="#stay" String="(?:m|q[rx])\{[^}]*\}" />
-        <RegExpr attribute="Pattern" context="#stay" String="(?:m|q[rx])\[[^\]]*\]" />
-        <RegExpr attribute="Pattern" context="#stay" String="(?:m|q[rx])([^a-zA-Z0-9_-\s[\]{}()/]).+\1" minimal="true"/>
+        <RegExpr attribute="Operator" context="find_quoted" String="\bq(?=[qwx]?\s*[^\w\s])" />
+        <RegExpr attribute="Operator" context="find_subst" String="\bs(?=\s*[^\w\s])" />
+        <RegExpr attribute="Operator" context="tr" String="\b(?:tr|y)\s*(?=[^\w\s])" />
+
+        <RegExpr attribute="Operator" context="find_pattern" String="\b(?:m|qr)(?=\s*[^\w\s])" />
+
         <RegExpr attribute="Normal Text" context="#stay" String="[\w_]+\s*/" />
         <RegExpr attribute="Normal Text" context="#stay" String="[&lt;&gt;&quot;':]/" />
-        <DetectChar attribute="Pattern" context="pattern_slash" char="/" />
+        <DetectChar attribute="Operator" context="pattern_slash" char="/" beginRegion="Pattern" />
         <RegExpr attribute="Operator" context="#stay" String="-[rwxoRWXOeszfdlpSbctugkTBMAC]" />
 
-        <DetectChar attribute="Normal Text" context="#stay" char="{" beginRegion="Brace1" />
-        <DetectChar attribute="Normal Text" context="#stay" char="}" endRegion="Brace1" />
-      </context>
-
-      <context name="pod" attribute="Pod" lineEndContext="#stay">
-        <LineContinue attribute="Pod" context="#stay" />
-        <RegExpr attribute="Pod" context="#stay" String="^\=(?:head[1-6]|over|back|item|for|begin|end|pod)\s*.*" beginRegion="POD" endRegion="POD"/>
-        <RegExpr attribute="Pod" context="#pop" String="^\=cut.*$" endRegion="POD"/>
+        <DetectChar attribute="Normal Text" context="#stay" char="{" beginRegion="Block" />
+        <DetectChar attribute="Normal Text" context="#stay" char="}" endRegion="Block" />
       </context>
 
-      <context name="regex_pattern_internal" attribute="Pattern" lineEndContext="#stay">
-        <RegExpr attribute="Comment" context="#stay" String="^\s*#.*$" />
-        <RegExpr attribute="Pattern Character Class" context="#stay" String="\\[anDdSsWw]" />
-        <RegExpr attribute="Pattern Internal Operator" context="#stay" String="\\[ABbEGLlNUuQdQZz]" />
-        <RegExpr attribute="Special Variable" context="#stay" String="\\[\d]+" />
-        <RegExpr attribute="Pattern" context="#stay" String="\\." />
-        <RegExpr attribute="Data Type" context="#stay" String="[\$@]#?[a-zA-Z_]+[a-zA-Z0-9_]*" />
-        <Detect2Chars attribute="Pattern Internal Operator" context="pat_ext" char="(" char1="?" />
-        <DetectChar attribute="Pattern Internal Operator" context="pat_char_class" char="[" />
-        <RegExpr attribute="Pattern Internal Operator" context="#stay" String="[()?^*+|]" />
-        <RegExpr attribute="Pattern Internal Operator" context="#stay" String="\{[\d, ]+\}" />
-        <DetectChar attribute="Pattern Internal Operator" context="#stay" char="$" />
-        <RegExpr attribute="Comment" context="#stay" String="\s{3,}#.*$" />
+      <!-- ====== quoted construct central ===== -->
+      <context name="find_quoted" attribute="Normal Text" lineEndContext="#stay" >
+        <!-- NOTE - qx'not interpolated regex' does not cover newline between "qr" and "'" -->
+        <RegExpr attribute="Operator" context="string_6" String="x\s*(')" beginRegion="String" />
+        <AnyChar attribute="Operator" context="find_qqx" String="qx" />
+        <DetectChar attribute="Operator" context="find_qw" char="w" />
+        <DetectChar attribute="Operator" context="string_2" char="(" beginRegion="String" />
+        <DetectChar attribute="Operator" context="string_3" char="{" beginRegion="String" />
+        <DetectChar attribute="Operator" context="string_4" char="[" beginRegion="String" />
+        <DetectChar attribute="Operator" context="string_5" char="&lt;" beginRegion="String" />
+        <RegExpr attribute="Operator" context="string_6" String="([^a-zA-Z0-9_\s[\]{}()])" beginRegion="String" />
+        <RegExpr attribute="Comment" context="#stay" String="\s+#.*" /><!-- q[qwx] # == comment, look for the delim on the next line -->
+      </context>
+      <context name="find_qqx" attribute="Normal Text" lineEndContext="#stay" >
+        <DetectChar attribute="Operator" context="ip_string_2" char="(" beginRegion="String" />
+        <DetectChar attribute="Operator" context="ip_string_3" char="{" beginRegion="String" />
+        <DetectChar attribute="Operator" context="ip_string_4" char="[" beginRegion="String" />
+        <DetectChar attribute="Operator" context="ip_string_5" char="&lt;" beginRegion="String" />
+        <RegExpr attribute="Operator" context="ip_string_6" String="([^a-zA-Z0-9_\s[\]{}()])" beginRegion="String" />
+        <RegExpr attribute="Comment" context="#stay" String="\s+#.*" /><!-- q[qwx] # == comment, look for the delim on the next line -->
+      </context>
+      <context name="find_qw" attribute="Normal Text" lineEndContext="#stay" >
+        <DetectChar attribute="Operator" context="quote_word_paren" char="(" beginRegion="Wordlist" />
+        <DetectChar attribute="Operator" context="quote_word_brace" char="{" beginRegion="Wordlist" />
+        <DetectChar attribute="Operator" context="quote_word_bracket" char="[" beginRegion="Wordlist" />
+        <RegExpr attribute="Operator" context="quote_word" String="([^a-zA-Z0-9_\s[\]{}()])" beginRegion="Wordlist" />
+        <RegExpr attribute="Comment" context="#stay" String="\s+#.*" /><!-- q[qwx] # == comment, look for the delim on the next line -->
       </context>
 
-<!-- ====== Contexts for strings ===== -->
+      <!-- ====== Contexts for strings ===== -->
       <context name="ipstring_internal" attribute="String (interpolated)" lineEndContext="#stay">
-        <RegExpr attribute="String (interpolated)" context="#stay" String="\\[\$@%]" />
-        <RegExpr attribute="Special Variable" context="#stay" String="\$[0-9]+" />
-        <RegExpr attribute="Data Type" context="var_detect" String="\$+#?[a-zA-Z_]+[a-zA-Z0-9_]*" />
-        <RegExpr attribute="Data Type" context="var_detect" String="[@%][\$a-zA-Z_]+[a-zA-Z0-9_]*" />
         <RegExpr attribute="String Special Character" context="#stay" String="\\[UuLlEtnaefr]" />
+        <RegExpr attribute="String (interpolated)" context="#stay" String="\\." />
+        <RegExpr attribute="Normal Text" context="find_variable_unsafe" String="(?:[\$@]\S|%[\w{])" lookAhead="true" />
       </context>
       <context name="ip_string" attribute="String (interpolated)" lineEndContext="#stay">
-        <LineContinue attribute="String (interpolated)" context="#stay"/>
-        <Detect2Chars attribute="String" context="#stay" char="\" char1="\" />
-        <Detect2Chars attribute="String (interpolated)" context="#stay" char="\" char1="&quot;" />
-        <DetectChar attribute="String (interpolated)" context="#pop" char="&quot;"/>
+        <DetectChar attribute="Operator" context="#pop" char="&quot;" endRegion="String"/>
         <IncludeRules context="ipstring_internal" />
       </context>
-      <context name="string" attribute="String" lineEndContext="#stay">
-        <LineContinue attribute="String" context="#stay"/>
-        <Detect2Chars attribute="String" context="#stay" char="\" char1="\" />
-        <Detect2Chars attribute="String" context="#stay" char="\" char1="'" />
-        <DetectChar attribute="String" context="#pop" char="'" />
-      </context>
       <context name="ip_string_2" attribute="String (interpolated)" lineEndContext="#stay">
-        <LineContinue attribute="String (interpolated)" context="#stay" />
-        <Detect2Chars attribute="String (interpolated)" context="#stay" char="\" char1="(" />
-        <Detect2Chars attribute="String (interpolated)" context="#stay" char="\" char1=")" />
         <RangeDetect attribute="String (interpolated)" context="#stay" char="(" char1=")" />
-        <DetectChar attribute="String (interpolated)" context="#pop" char=")" />
+        <DetectChar attribute="Operator" context="#pop#pop#pop" char=")" endRegion="String" />
         <IncludeRules context="ipstring_internal" />
       </context>
       <context name="ip_string_3" attribute="String (interpolated)" lineEndContext="#stay">
-        <LineContinue attribute="String (interpolated)" context="#stay" />
-        <Detect2Chars attribute="String (interpolated)" context="#stay" char="\" char1="{" />
-        <Detect2Chars attribute="String (interpolated)" context="#stay" char="\" char1="}" />
         <RangeDetect attribute="String (interpolated)" context="#stay" char="{" char1="}" />
-        <DetectChar attribute="String (interpolated)" context="#pop" char="}" />
+        <DetectChar attribute="Operator" context="#pop#pop#pop" char="}" endRegion="String" />
         <IncludeRules context="ipstring_internal" />
       </context>
       <context name="ip_string_4" attribute="String (interpolated)" lineEndContext="#stay">
-        <LineContinue attribute="String (interpolated)" context="#stay" />
-        <Detect2Chars attribute="String (interpolated)" context="#stay" char="\" char1="[" />
-        <Detect2Chars attribute="String (interpolated)" context="#stay" char="\" char1="]" />
         <RangeDetect attribute="String (interpolated)" context="#stay" char="[" char1="]" />
-        <DetectChar attribute="String (interpolated)" context="#pop" char="]" />
+        <DetectChar attribute="Operator" context="#pop#pop#pop" char="]" endRegion="String" />
         <IncludeRules context="ipstring_internal" />
       </context>
       <context name="ip_string_5" attribute="String (interpolated)" lineEndContext="#stay">
-        <LineContinue attribute="String (interpolated)" context="#stay" />
-        <Detect2Chars attribute="String (interpolated)" context="#stay" char="\" char1="&lt;" />
-        <Detect2Chars attribute="String (interpolated)" context="#stay" char="\" char1="&gt;" />
         <RangeDetect attribute="String (interpolated)" context="#stay" char="&lt;" char1="&gt;" />
-        <DetectChar attribute="String (interpolated)" context="#pop" char="&gt;" />
+        <DetectChar attribute="Operator" context="#pop#pop#pop" char="&gt;" endRegion="String" />
         <IncludeRules context="ipstring_internal" />
       </context>
+      <context name="ip_string_6" attribute="String (interpolated)" lineEndContext="#stay" dynamic="true">
+        <RegExpr attribute="String (interpolated)" context="#stay" String="\\%1" dynamic="true" />
+        <DetectChar attribute="Operator" context="#pop#pop#pop" char="1" dynamic="true"  endRegion="String"/>
+        <IncludeRules context="ipstring_internal" />
+      </context>
+
+      <context name="string" attribute="String" lineEndContext="#stay">
+        <DetectChar attribute="Operator" context="#pop" char="'" endRegion="String" />
+      </context>
       <context name="string_2" attribute="String" lineEndContext="#stay">
-        <LineContinue attribute="String" context="#stay" />
-        <Detect2Chars attribute="String" context="#stay" char="\" char1="(" />
-        <Detect2Chars attribute="String" context="#stay" char="\" char1=")" />
         <RangeDetect attribute="String" context="#stay" char="(" char1=")" />
-        <DetectChar attribute="String" context="#pop" char=")" />
+        <DetectChar attribute="Operator" context="#pop#pop" char=")" endRegion="String" />
       </context>
       <context name="string_3" attribute="String" lineEndContext="#stay">
-        <Detect2Chars attribute="String" context="#stay" char="\" char1="{" />
-        <Detect2Chars attribute="String" context="#stay" char="\" char1="}" />
         <RangeDetect attribute="String" context="#stay" char="{" char1="}" />
-        <LineContinue attribute="String" context="#stay" />
-        <DetectChar attribute="String" context="#pop" char="}" />
+        <DetectChar attribute="Operator" context="#pop#pop" char="}" endRegion="String" />
       </context>
       <context name="string_4" attribute="String" lineEndContext="#stay">
-        <LineContinue attribute="String" context="#stay" />
-        <Detect2Chars attribute="String" context="#stay" char="\" char1="[" />
-        <Detect2Chars attribute="String" context="#stay" char="\" char1="]" />
         <RangeDetect attribute="String" context="#stay" char="[" char1="]" />
-        <DetectChar attribute="String" context="#pop" char="]" />
+        <DetectChar attribute="Operator" context="#pop#pop" char="]" endRegion="String" />
       </context>
       <context name="string_5" attribute="String" lineEndContext="#stay">
-        <LineContinue attribute="String" context="#stay" />
         <Detect2Chars attribute="String" context="#stay" char="\" char1="&lt;" />
         <Detect2Chars attribute="String" context="#stay" char="\" char1="&gt;" />
         <RangeDetect attribute="String" context="#stay" char="&lt;" char1="&gt;" />
-        <DetectChar attribute="String" context="#pop" char="&gt;" />
+        <DetectChar attribute="Operator" context="#pop#pop" char="&gt;" endRegion="String" />
       </context>
-
-<!-- ====== contexts for  s/// etc ====== -->
-      <context name="subst_replace" attribute="normal text">
-        <LineContinue attribute="Normal Text" context="#stay" />
-        <RegExpr attribute="Normal Text" context="#stay" String="[&quot;'\]" />
-        <RegExpr attribute="Comment" context="#stay" String="\s*#.*$" />
-        <RegExpr attribute="Special Variable" context="#stay" String="\$[0-9]+" />
-        <RegExpr attribute="Data Type" context="#stay" String="\$+#?[a-zA-Z_]+[a-zA-Z0-9_]*" />
-        <RegExpr attribute="Data Type" context="#stay" String="[@%][\$a-zA-Z_]+[a-zA-Z0-9_]*" />
-        <keyword attribute="Keyword" context="#stay" String="keywords" />
-        <keyword attribute="Operator" context="#stay" String="operators" />
-        <keyword attribute="Function" context="#stay" String="functions" />
+      <context name="string_6" attribute="String" lineEndContext="#stay" dynamic="true">
+        <Detect2Chars attribute="String" context="#stay" char="\" char1="\" />
+        <RegExpr attribute="String" context="#stay" String="\\%1" dynamic="true"/>
+        <DetectChar attribute="Operator" context="#pop#pop" char="1" dynamic="true" endRegion="String" />
       </context>
+
+      <!-- ====== contexts for  s/// ====== -->
+      <context name="find_subst" attribute="Normal Text" lineEndContext="#stay" >
+        <RegExpr attribute="Comment" context="#stay" String="\s+#.*" /><!-- s # == comment, look for the delim on the next line -->
+        <DetectChar attribute="Operator" context="subst_curlybrace_pattern" char="{" beginRegion="Pattern" />
+        <DetectChar attribute="Operator" context="subst_paren_pattern" char="(" beginRegion="Pattern" />
+        <DetectChar attribute="Operator" context="subst_bracket_pattern" char="[" beginRegion="Pattern" />
+        <DetectChar attribute="Operator" context="subst_sq_pattern" char="'" beginRegion="Pattern" />
+        <RegExpr attribute="Operator" context="subst_slash_pattern" String="([^\w\s[\]{}()])" beginRegion="Pattern" />
+      </context>
+
+      <!-- Fully parse s {} {}.
+           This means that
+           - comments are legal between PATTERN and REPLACEMENT
+           - REPLACEMENT can contain resursive {} blocks -->
       <context name="subst_curlybrace_pattern" attribute="Pattern" lineEndContext="#stay">
-        <LineContinue attribute="Pattern" context="#stay" />
         <RegExpr attribute="Comment" context="#stay" String="\s+#.*$" />
-        <Detect2Chars attribute="Pattern" context="#stay" char="\" char1="{" />
-        <Detect2Chars attribute="Pattern" context="#stay" char="\" char1="}" />
-        <IncludeRules context="regex_pattern_internal" />
-        <DetectChar attribute="Pattern" context="subst_curlybrace_replace" char="}" />
+        <IncludeRules context="regex_pattern_internal_ip" />
+        <DetectChar attribute="Operator" context="subst_curlybrace_middle" char="}" endRegion="Pattern" />
+      </context>
+      <context name="subst_curlybrace_middle" attribute="Normal Text" lineEndContext="#stay" >
+        <RegExpr attribute="Comment" context="#stay" String="#.*$" />
+        <DetectChar attribute="Operator" context="subst_curlybrace_replace" char="{" beginRegion="Replacement" />
+      </context>
+      <context name="subst_curlybrace_replace" attribute="String (interpolated)" lineEndContext="#stay">
+        <IncludeRules context="ipstring_internal" />
+        <DetectChar attribute="Normal Text" context="subst_curlybrace_replace_recursive" char="{" beginRegion="Block" />
+        <RegExpr attribute="Operator" context="#pop#pop#pop#pop" String="\}[cegimosx]*" endRegion="Replacement" />
       </context>
-      <context name="subst_curlybrace_replace" attribute="Normal Text" lineEndContext="#stay">
-        <IncludeRules context="subst_replace" />
-        <Detect2Chars attribute="Pattern" context="#stay" char="\" char1="{" />
-        <Detect2Chars attribute="Pattern" context="#stay" char="\" char1="}" />
-        <DetectChar attribute="Pattern" context="#stay" char="{" />
-        <DetectChar attribute="Pattern" context="#pop#pop" char="}" />
+      <context name="subst_curlybrace_replace_recursive" attribute="String (interpolated)" lineEndContext="#stay" >
+        <DetectChar attribute="String (interpolated)" context="subst_curlybrace_replace_recursive" char="{" beginRegion="Block" />
+        <DetectChar attribute="Normal Text" context="#pop" char="}" endRegion="Block" />
+        <IncludeRules context="ipstring_internal" />
       </context>
+
       <context name="subst_paren_pattern" attribute="Pattern" lineEndContext="#stay">
-        <LineContinue attribute="Pattern" context="#stay" />
         <RegExpr attribute="Comment" context="#stay" String="\s+#.*$" />
-        <Detect2Chars attribute="Pattern" context="#stay" char="\" char1="(" />
-        <Detect2Chars attribute="Pattern" context="#stay" char="\" char1=")" />
-        <IncludeRules context="regex_pattern_internal" />
-        <DetectChar attribute="Pattern" context="subst_curlybrace_replace" char="}" />
+        <IncludeRules context="regex_pattern_internal_ip" />
+        <DetectChar attribute="Operator" context="subst_paren_replace" char="}" endRegion="Pattern" />
       </context>
-      <context name="subst_paren_replace" attribute="Normal Text" lineEndContext="#stay">
-        <IncludeRules context="subst_replace" />
-        <Detect2Chars attribute="Pattern" context="#stay" char="\" char1="(" />
-        <Detect2Chars attribute="Pattern" context="#stay" char="\" char1=")" />
-        <DetectChar attribute="Pattern" context="#stay" char="(" />
-        <DetectChar attribute="Pattern" context="#pop#pop" char=")" />
+      <context name="subst_paren_replace" attribute="String (interpolated)" lineEndContext="#stay">
+        <IncludeRules context="ipstring_internal" />
+        <DetectChar attribute="Operator" context="#stay" char="(" beginRegion="Replacement" />
+        <RegExpr attribute="Operator" context="#pop#pop#pop" String="\)[cegimosx]*" endRegion="Replacement" />
       </context>
+
       <context name="subst_bracket_pattern" attribute="Pattern" lineEndContext="#stay">
-        <LineContinue attribute="Pattern" context="#stay" />
         <RegExpr attribute="Comment" context="#stay" String="\s+#.*$" />
-        <Detect2Chars attribute="Pattern" context="#stay" char="\" char1="[" />
-        <Detect2Chars attribute="Pattern" context="#stay" char="\" char1="]" />
-        <IncludeRules context="regex_pattern_internal" />
-        <DetectChar attribute="Pattern" context="subst_curlybrace_replace" char="]" />
+        <IncludeRules context="regex_pattern_internal_ip" />
+        <DetectChar attribute="Operator" context="subst_bracket_replace" char="]" endRegion="Pattern" />
       </context>
-      <context name="subst_bracket_replace" attribute="Normal Text" lineEndContext="#stay">
-        <IncludeRules context="subst_replace" />
-        <Detect2Chars attribute="Pattern" context="#stay" char="\" char1="[" />
-        <Detect2Chars attribute="Pattern" context="#stay" char="\" char1="]" />
-        <DetectChar attribute="Pattern" context="#stay" char="[" />
-        <DetectChar attribute="Pattern" context="#pop#pop" char="]" />
+      <context name="subst_bracket_replace" attribute="String (interpolated)" lineEndContext="#stay">
+        <IncludeRules context="ipstring_internal" />
+        <DetectChar attribute="Operator" context="#stay" char="[" beginRegion="Replacement" />
+        <RegExpr attribute="Operator" context="#pop#pop#pop" String="\][cegimosx]*" endRegion="Replacement" />
       </context>
-      <context name="subst_slash_pattern" attribute="Pattern" lineEndContext="#stay">
-        <LineContinue attribute="Pattern" context="#stay" />
+
+      <context name="subst_slash_pattern" attribute="Pattern" lineEndContext="#stay" dynamic="true">
+        <RegExpr attribute="Pattern Internal Operator" context="#stay" String="\$(?=%1)" dynamic="true" />
+        <RegExpr attribute="Operator" context="subst_slash_replace" String="(%1)" dynamic="true" endRegion="Pattern" beginRegion="Replacement" />
+        <IncludeRules context="regex_pattern_internal_ip" />
+      </context>
+      <context name="subst_slash_replace" attribute="String (interpolated)" lineEndContext="#stay" dynamic="true">
+        <IncludeRules context="ipstring_internal" />
+        <RegExpr attribute="Operator" context="#pop#pop#pop" String="%1[cegimosx]*" dynamic="true" endRegion="Replacement" />
+      </context>
+
+      <context name="subst_sq_pattern" attribute="Pattern" lineEndContext="#stay">
         <RegExpr attribute="Comment" context="#stay" String="\s+#.*$" />
         <IncludeRules context="regex_pattern_internal" />
-        <DetectChar attribute="Pattern" context="subst_slash_replace" char="/" />
+        <DetectChar attribute="Operator" context="subst_sq_replace" char="'" endRegion="Pattern" beginRegion="Pattern" />
       </context>
-      <context name="subst_slash_replace" attribute="Normal Text" lineEndContext="#stay">
-        <IncludeRules context="subst_replace" />
-        <Detect2Chars attribute="Pattern" context="#stay" char="\" char1="/" />
-        <DetectChar attribute="Pattern" context="#pop#pop" char="/" />
+      <context name="subst_sq_replace" attribute="String" lineEndContext="#stay">
+        <RegExpr attribute="Operator" context="#pop#pop#pop" String="'[cegimosx]*" endRegion="Replacement" />
       </context>
 
-      <context name="quote_word" attribute="Normal Text" lineEndContext="#stay">
-        <LineContinue attribute="Normal Text" context="#stay" />
-        <Detect2Chars attribute="Normal Text" context="#stay" char="\" char1="/" />
-        <DetectChar attribute="Normal Text" context="#pop" char="/" />
-        <RegExpr attribute="Data Type" context="#stay" String="\$+#?[a-zA-Z_]+[a-zA-Z0-9_]*" />
-        <RegExpr attribute="Data Type" context="#stay" String="[@%][\$a-zA-Z_]+[a-zA-Z0-9_]*" />
+      <context name="tr" attribute="Pattern" lineEndContext="#pop" fallthrough="true" fallthroughContext="#pop" >
+        <RegExpr attribute="Pattern" context="#pop" String="([^)]*\)\s*\(?:[^)]*\)" />
+        <RegExpr attribute="Pattern" context="#pop" String="{[^}]*\}\s*\{[^}]*\}" />
+        <RegExpr attribute="Pattern" context="#pop" String="\[[^}]*\]\s*\[[^\]]*\]" />
+        <RegExpr attribute="Pattern" context="#pop" String="([^a-zA-Z0-9_\s[\]{}()]).*\1.*\1" minimal="true"/>
+      </context>
+
+      <!-- ====== PATTERNs ====== -->
+      <context name="find_pattern" attribute="Pattern" lineEndContext="#stay">
+        <RegExpr attribute="Comment" context="#stay" String="\s+#.*" /><!-- s # == comment, look for the delim on the next line -->
+        <DetectChar attribute="Operator" context="pattern_brace" char="{" beginRegion="Pattern" />
+        <DetectChar attribute="Operator" context="pattern_paren" char="(" beginRegion="Pattern" />
+        <DetectChar attribute="Operator" context="pattern_bracket" char="[" beginRegion="Pattern" />
+        <DetectChar attribute="Operator" context="pattern_sq" char="'" beginRegion="Pattern" />
+        <RegExpr attribute="Operator" context="pattern" String="([^\w\s])" beginRegion="Pattern" />
       </context>
       <context name="pattern_slash" attribute="Pattern" lineEndContext="#stay">
-        <RegExpr attribute="Comment" context="#stay" String="^\s*#.*$" />
-        <LineContinue attribute="Pattern" context="#stay" />
+        <RegExpr attribute="Pattern Internal Operator" context="#stay" String="\$(?=/)" />
+        <IncludeRules context="regex_pattern_internal_ip" />
+        <RegExpr attribute="Operator" context="#pop" String="/[cgimosx]*" endRegion="Pattern" />
+      </context>
+      <context name="pattern" attribute="Pattern" lineEndContext="#stay" dynamic="true">
+        <RegExpr attribute="Pattern Internal Operator" context="#stay" String="\$(?=%1)" dynamic="true" />
+        <RegExpr attribute="Operator" context="#pop#pop" String="%1[cgimosx]*" dynamic="true" endRegion="Pattern" />
+        <IncludeRules context="regex_pattern_internal_ip" />
+        <RegExpr attribute="Pattern Internal Operator" context="#stay" String="\$(?=\%1)" dynamic="true" />
+      </context>
+      <context name="pattern_brace" attribute="Pattern" lineEndContext="#stay">
+        <RegExpr attribute="Operator" context="#pop#pop" String="\}[cgimosx]*" endRegion="Pattern" />
+        <IncludeRules context="regex_pattern_internal_ip" />
+      </context>
+      <context name="pattern_bracket" attribute="Pattern" lineEndContext="#stay">
+        <RegExpr attribute="Operator" context="#pop#pop" String="\][cgimosx]*" endRegion="Pattern" />
+        <IncludeRules context="regex_pattern_internal_ip" />
+      </context>
+      <context name="pattern_paren" attribute="Pattern" lineEndContext="#stay">
+        <RegExpr attribute="Operator" context="#pop#pop" String="\)[cgimosx]*" endRegion="Pattern" />
+        <IncludeRules context="regex_pattern_internal_ip" />
+      </context>
+      <context name="pattern_sq" attribute="Pattern" lineEndContext="#stay">
+        <RegExpr attribute="Operator" context="#pop#pop" String="'[cgimosx]*" endRegion="Pattern" />
         <IncludeRules context="regex_pattern_internal" />
-        <DetectChar attribute="Pattern" context="#pop" char="/" />
       </context>
 
-<!-- ====== ====== -->
+      <!-- rules internal stuff wrt regex patterns -->
+      <context name="regex_pattern_internal_rules_1">
+        <RegExpr attribute="Comment" context="#stay" String="^\s*#.*$" />
+        <RegExpr attribute="Pattern Character Class" context="#stay" String="\\[anDdSsWw]" />
+        <RegExpr attribute="Pattern Internal Operator" context="#stay" String="\\[ABbEGLlNUuQdQZz]" />
+        <RegExpr attribute="Special Variable" context="#stay" String="\\[\d]+" />
+        <RegExpr attribute="Pattern" context="#stay" String="\\." />
+      </context>
+      <context name="regex_pattern_internal_rules_2">
+        <Detect2Chars attribute="Pattern Internal Operator" context="pat_ext" char="(" char1="?" />
+        <DetectChar attribute="Pattern Internal Operator" context="pat_char_class" char="[" />
+        <RegExpr attribute="Pattern Internal Operator" context="#stay" String="[()?^*+|]" />
+        <RegExpr attribute="Pattern Internal Operator" context="#stay" String="\{[\d, ]+\}" />
+        <DetectChar attribute="Pattern Internal Operator" context="#stay" char="$" />
+        <RegExpr attribute="Comment" context="#stay" String="\s{3,}#.*$" />
+      </context>
+      <context name="regex_pattern_internal" attribute="Pattern" lineEndContext="#stay">
+        <IncludeRules context="regex_pattern_internal_rules_1" />
+        <IncludeRules context="regex_pattern_internal_rules_2" />
+      </context>
+      <context name="regex_pattern_internal_ip" attribute="Pattern" lineEndContext="#stay" >
+        <IncludeRules context="regex_pattern_internal_rules_1" />
+        <!-- NOTE the below means that the special variables $' $], $} and $> are not supported
+             within interpolated PATTERNs (apart from $(, $) and ${ and $| not supported by perl).
+             This is because perl considers
+             s{foo$} {bar} OK as well as s{foo$}} {bar}, and detecting that is a huge work overload
+             for something that is unlikely to happen. -->
+        <RegExpr attribute="Data Type" context="find_variable_unsafe" String="[$@][^]\s{}()|&gt;']" lookAhead="true" />
+        <IncludeRules context="regex_pattern_internal_rules_2" />
+      </context>
+      <context name="pat_ext" attribute="Pattern Internal Operator" lineEndContext="#stay">
+        <RegExpr attribute="Comment" context="#pop" String="\#[^)]*" />
+        <RegExpr attribute="Pattern Internal Operator" context="#pop" String="[:=!&gt;&lt;]+" />
+        <DetectChar attribute="Pattern Internal Operator" context="#pop" char=")" />
+      </context>
+      <context name="pat_char_class" attribute="Pattern Character Class" lineEndContext="#stay">
+        <DetectChar attribute="Pattern Internal Operator" context="#stay" char="^" />
+        <Detect2Chars attribute="Pattern Character Class" context="#stay" char="\" char1="\" />
+        <Detect2Chars attribute="Pattern Character Class" context="#stay" char="\" char1="]" />
+        <RegExpr attribute="Pattern Character Class" context="#stay" String="\[:^?[a-z]+:\]" />
+        <DetectChar attribute="Pattern Internal Operator" context="#pop" char="]" />
+      </context>
+
+      <!-- ====== Variables ====== -->
+      <context name="find_variable" attribute="Data Type" lineEndContext="#pop" fallthrough="true" fallthroughContext="#pop" >
+        <RegExpr attribute="Special Variable" context="var_detect" String="\$[0-9]+" />
+        <RegExpr attribute="Special Variable" context="var_detect" String="[@\$](?:[\+\-_]\B|ARGV\b|INC\b)" />
+        <RegExpr attribute="Special Variable" context="var_detect" String="[%\$](?:INC\b|ENV\b|SIG\b)" />
+        <RegExpr attribute="Data Type" context="var_detect" String="\$\$[\$\w_]" />
+        <RegExpr attribute="Data Type" context="var_detect" String="\$[#_][\w_]" />
+        <RegExpr attribute="Data Type" context="var_detect" String="\$+::" />
+        <RegExpr attribute="Special Variable" context="#stay" String="\$[^a-zA-Z0-9\s{][A-Z]?" />
+        <RegExpr attribute="Data Type" context="var_detect" String="[\$@%]\{[\w_]+\}" />
+        <AnyChar attribute="Data Type" context="var_detect" String="$@%" />
+        <RegExpr attribute="Data Type" context="var_detect" String="\*[a-zA-Z_]+" />
+        <RegExpr attribute="Special Variable" context="#stay" String="\*[^a-zA-Z0-9\s{][A-Z]?" />
+        <!-- this should be a rare case! -->
+        <AnyChar attribute="Operator" context="#pop" String="$@%*" />
+      </context>
+      <!-- This does not check fo a trailing slash, for usage in strings. -->
+      <context name="find_variable_unsafe" attribute="Data Type" lineEndContext="#pop" fallthrough="true" fallthroughContext="#pop" >
+        <RegExpr attribute="Special Variable" context="var_detect_unsafe" String="\$[0-9]+" />
+        <RegExpr attribute="Special Variable" context="var_detect_unsafe" String="[@\$](?:[\+\-_]\B|ARGV\b|INC\b)" />
+        <RegExpr attribute="Special Variable" context="var_detect_unsafe" String="[%\$](?:INC\b|ENV\b|SIG\b)" />
+        <RegExpr attribute="Data Type" context="var_detect_unsafe" String="\$\$[\$\w_]" />
+        <RegExpr attribute="Data Type" context="var_detect_unsafe" String="\$[#_][\w_]" />
+        <RegExpr attribute="Data Type" context="var_detect_unsafe" String="\$+::" />
+        <RegExpr attribute="Special Variable" context="#stay" String="\$[^a-zA-Z0-9\s{][A-Z]?" />
+        <RegExpr attribute="Data Type" context="var_detect_unsafe" String="[\$@%]\{[\w_]+\}" />
+        <RegExpr attribute="Data Type" context="var_detect_unsafe" String="[\$@%]" />
+        <RegExpr attribute="Data Type" context="var_detect_unsafe" String="\*\w+" />
+        <AnyChar attribute="Operator" context="#pop" String="$@%*" />
+      </context>
+      <context name="var_detect"  attribute="Data Type" lineEndContext="#pop#pop" fallthrough="true" fallthroughContext="#pop#pop">
+        <IncludeRules context="var_detect_rules" />
+        <IncludeRules context="slash_safe_escape" />
+      </context>
+      <context name="var_detect_unsafe"  attribute="Data Type" lineEndContext="#pop#pop" fallthrough="true" fallthroughContext="#pop#pop">
+        <IncludeRules context="var_detect_rules" />
+      </context>
+      <context name="var_detect_rules" attribute="Data Type" lineEndContext="#pop#pop" >
+        <RegExpr attribute="Data Type" context="#stay" String="[\w_]+" />
+        <Detect2Chars attribute="Normal Text" context="#stay" char=":" char1=":" />
+        <DetectChar attribute="Operator" context="#stay" char="'" />
+        <Detect2Chars attribute="Normal Text" context="#stay" char="-" char1="&gt;" />
+        <!-- safe with operator / -->
+        <Detect2Chars attribute="Normal Text" context="#stay" char="+" char1="+" />
+        <Detect2Chars attribute="Normal Text" context="#stay" char="-" char1="-" />
+      </context>
+
+
+      <!-- ====== Word lists ====== -->
+      <context name="quote_word" attribute="Normal Text" lineEndContext="#stay" dynamic="true">
+        <RegExpr attribute="Normal Text" context="#stay" String="\\%1" dynamic="true" />
+        <DetectChar attribute="Operator" context="#pop#pop#pop" char="1" dynamic="true" endRegion="Wordlist" />
+      </context>
+      <context name="quote_word_paren" attribute="Normal Text" lineEndContext="#stay">
+        <Detect2Chars attribute="Normal Text" context="#stay" char="\" char1=")" />
+        <DetectChar attribute="Operator" context="#pop#pop#pop" char=")" endRegion="Wordlist" />
+      </context>
+      <context name="quote_word_brace" attribute="Normal Text" lineEndContext="#stay">
+        <Detect2Chars attribute="Normal Text" context="#stay" char="\" char1="}" />
+        <DetectChar attribute="Operator" context="#pop#pop#pop" char="}" endRegion="Wordlist" />
+      </context>
+      <context name="quote_word_bracket" attribute="Normal Text" lineEndContext="#stay">
+        <Detect2Chars attribute="Normal Text" context="#stay" char="\" char1="]" />
+        <DetectChar attribute="Operator" context="#pop#pop#pop" char="]" endRegion="Wordlist" />
+      </context>
+
+      <!-- ====== Here Documents ====== -->
+      <context name="find_here_document" attribute="Normal Text" lineEndContext="#pop" >
+        <RegExpr attribute="Keyword" context="here_document" String="(\w+)\s*;?" />
+        <RegExpr attribute="Keyword" context="here_document" String="\s*&quot;([^&quot;]+)&quot;\s*;?" />
+        <RegExpr attribute="Keyword" context="here_document" String="\s*`([^`]+)`\s*;?" />
+        <RegExpr attribute="Keyword" context="here_document_dumb" String="\s*'([^']+)'\s*;?" />
+      </context>
+      <context name="here_document" attribute="String (interpolated)" lineEndContext="#stay" dynamic="true">
+        <RegExpr attribute="Keyword" context="#pop#pop" String="^%1" dynamic="true" endRegion="HereDocument"/>
+        <RegExpr attribute="Keyword" context="here_document" String="\=\s*&lt;&lt;\s*[&quot;']?([A-Z0-9_\-]+)[&quot;']?" beginRegion="HEREDoc" />
+        <IncludeRules context="ipstring_internal" />
+      </context>
+      <context name="here_document_dumb" attribute="Normal Text" lineEndContext="#stay" dynamic="true">
+        <RegExpr attribute="Keyword" context="#pop#pop" String="^%1" dynamic="true" endRegion="HereDocument"/>
+      </context>
+
+      <!-- ====== Misc ====== -->
       <context name="data_handle" attribute="Data" lineEndContext="#stay">
-        <LineContinue attribute="Data" context="#stay"/>
-        <RegExpr attribute="Pod" context="pod" String="^\=(?:head[1-6]|over|back|item|for|begin|end|pod)\s*.*"/>
+        <RegExpr attribute="Pod" context="pod" String="^\=(?:head[1-6]|over|back|item|for|begin|end|pod)\s+.*" beginRegion="POD"/>
         <RegExpr attribute="Keyword" context="normal" String="^__END__" />
       </context>
       <context name="end_handle" attribute="Nothing" lineEndContext="#stay">
-        <LineContinue attribute="Nothing" context="#stay" />
         <RegExpr attribute="Pod" context="pod" String="^\=(?:head[1-6]|over|back|item|for|begin|end|pod)\s*.*"/>
         <RegExpr attribute="Keyword" context="data_handle" String="^__DATA__" />
       </context>
-      <context name="var_detect" attribute="Normal Text" lineEndContext="#stay" fallthrough="true" fallthroughContext="#pop">
-        <RegExpr attribute="Data Type" context="#stay" String="[\w_]+" />
-        <AnyChar attribute="Normal Text" context="#pop" String="[;,*=!&amp;/" />
-        <RegExpr attribute="Normal Text" context="#stay" String="\s*[})]?\s*/" />
-        <DetectChar attribute="Operator" context="#stay" char="'" />
-        <RegExpr attribute="Normal Text" context="in_hash_elem" String="\s*\{" />
-        <RegExpr attribute="Operator" context="#stay" String="(\+\+|--)" />
-        <Detect2Chars attribute="Normal Text" context="#stay" char=":" char1=":" />
-        <RegExpr attribute="Normal Text" context="#stay" String="\s*\}?\s*-&gt;\s*" />
-        <RegExpr attribute="Normal Text" context="in_hash_elem" String="\s*\}\s*\{\s*" />
-        <RegExpr attribute="Data Type" context="#stay" String="[\$@%]" />
+
+      <context name="Backticked" attribute="String (interpolated)" lineEndContext="#stay">
+        <IncludeRules context="ipstring_internal"/>
+        <DetectChar attribute="Operator" context="#pop" char="`"/>
       </context>
+
       <context name="slash_safe_escape" attribute="Normal Text" lineEndContext="#pop" fallthrough="true" fallthroughContext="#pop">
-        <RegExpr attribute="Normal Text" context="#pop" String="\s*[)}\]]?\s*/" />
+        <RegExpr attribute="Normal Text" context="#pop" String="\s*\]?\s*/" />
+        <RegExpr attribute="Normal Text" context="#pop" String="\s*\}?\s*/" endRegion="Block" />
+        <RegExpr attribute="Normal Text" context="#pop" String="\s*\)?\s*/" />
         <keyword attribute="Keyword" context="#pop" String="keywords" />
       </context>
-      <context name="sub_name_def" attribute="Normal Text" lineEndContext="#pop">
-        <RegExpr attribute="Normal Text" context="#stay" String="[\w_]+" />
-        <DetectChar attribute="Data Type" context="var_detect" char="$" />
-        <RegExpr attribute="Normal Text" context="sub_arg_definition" String="\s*\(" />
-        <DetectChar attribute="Normal Text" context="#pop" char="{" beginRegion="Brace1" />
-        <DetectChar attribute="Normal Text" context="#pop" char=";" />
-      </context>
+
       <context name="package_qualified_blank" attribute="Normal Text" lineEndContext="#stay">
         <RegExpr attribute="Normal Text" context="#pop" String="[\w_]+" />
       </context>
-      <context name="in_hash_elem" attribute="Normal Text" lineEndContext="#pop">
-        <DetectChar attribute="String (interpolated)" context="ip_string" char="&quot;" />
-        <DetectChar attribute="String" context="string" char="'" />
-        <RegExpr attribute="String" context="#stay" String="\s*[\w_]+\s*(?![\w_\(])" />
-        <RegExpr attribute="Special Variable" context="#stay" String="\$[0-9]+" />
-        <RegExpr attribute="Special Variable" context="#stay" String="[@\$](?:[\+\-_]\B|ARGV\b|INC\b)" />
-        <RegExpr attribute="Special Variable" context="#stay" String="[%\$](?:INC\b|ENV\b|SIG\b)" />
-        <RegExpr attribute="Data Type" context="var_detect" String="\$\$[\$\w_]" />
-        <RegExpr attribute="Data Type" context="var_detect" String="\$[#_][\w_]" />
-        <RegExpr attribute="Special Variable" context="#stay" String="\$[^a-zA-Z0-9\s{][A-Z]" />
-        <RegExpr attribute="Data Type" context="var_detect" String="[\$@%]" />
-        <RegExpr attribute="Normal Text" context="#pop" String="\s*[\w_]+\s*\(" />
-        <DetectChar attribute="Normal Text" context="#pop" char="}" />
+
+      <context name="sub_name_def" attribute="Normal Text" lineEndContext="#pop" fallthrough="true" fallthroughContext="#pop">
+        <RegExpr attribute="Function" context="#stay" String="\w+" />
+        <RegExpr attribute="Normal Text" context="find_variable" String="\$\S" lookAhead="true" />
+        <RegExpr attribute="Normal Text" context="sub_arg_definition" String="\s*\(" />
+        <Detect2Chars attribute="Normal Text" context="#stay" char=":" char1=":" />
       </context>
+
       <context name="sub_arg_definition" attribute="Normal Text" lineEndContext="#stay" fallthrough="true" fallthroughContext="#pop#pop">
-        <RegExpr attribute="Data Type" context="#stay" String="[\$@%]" />
+        <AnyChar attribute="Data Type" context="#stay" String="*$@%" />
+        <AnyChar attribute="Normal Text" context="#stay" String="&amp;\[];" />
         <DetectChar attribute="Normal Text" context="slash_safe_escape" char=")" />
       </context>
-      <context name="pat_ext" attribute="Pattern Internal Operator" lineEndContext="#stay">
-        <RegExpr attribute="Comment" context="#pop" String="\#[^)]*" />
-        <RegExpr attribute="Pattern Internal Operator" context="#pop" String="[:=!&gt;&lt;]+" />
-        <DetectChar attribute="Pattern Internal Operator" context="#pop" char=")" />
-      </context>
-      <context name="pat_char_class" attribute="Pattern Character Class" lineEndContext="#stay">
-        <LineContinue attribute="Pattern Character Class" context="#stay" />
-        <DetectChar attribute="Pattern Internal Operator" context="#stay" char="^" />
-        <Detect2Chars attribute="Pattern Character Class" context="#stay" char="\" char1="\" />
-        <Detect2Chars attribute="Pattern Character Class" context="#stay" char="\" char1="]" />
-        <RegExpr attribute="Pattern Character Class" context="#stay" String="\[:^?[a-z]+:\]" />
-        <DetectChar attribute="Pattern Internal Operator" context="#pop" char="]" />
+
+      <context name="pod" attribute="Pod" lineEndContext="#stay">
+        <RegExpr attribute="Pod" context="#stay" String="^\=(?:head[1-6]|over|back|item|for|begin|end|pod)\s*.*" beginRegion="POD" endRegion="POD"/>
+        <RegExpr attribute="Pod" context="#pop" String="^\=cut.*$" endRegion="POD"/>
       </context>
+
       <context name="comment" attribute="Comment" lineEndContext="#pop">
         <RegExpr attribute="Note" context="#stay" String="(?:FIXME|TODO|NOTE):?" />
       </context>
-      <context name="Backticked" attribute="String (interpolated)" lineEndContext="#stay">
-        <IncludeRules context="ipstring_internal"/>
-        <DetectChar attribute="Operator" context="#pop" char="`"/>
-      </context>
+
     </contexts>
     <itemDatas>
       <itemData name="Normal Text"               defStyleNum="dsNormal" />
       <itemData name="Keyword"                   defStyleNum="dsKeyword" />
       <itemData name="Pragma"                    defStyleNum="dsKeyword" />
       <itemData name="Function"                  defStyleNum="dsFunction" />
-      <itemData name="Operator"                  defStyleNum="dsKeyword" />
+      <itemData name="Operator"                  defStyleNum="dsKeyword" color="#008000"/>
       <itemData name="Data Type"                 defStyleNum="dsDataType" />
       <itemData name="Special Variable"          defStyleNum="dsDataType" color="#C00000" selColor="#C00000" bold="0" italic="0" />
       <itemData name="Decimal"                   defStyleNum="dsDecVal" />
@@ -685,7 +781,7 @@
       <itemData name="Comment"                   defStyleNum="dsComment" />
       <itemData name="Pod"                       defStyleNum="dsComment" />
       <itemData name="Nothing"                   defStyleNum="dsComment" />
-      <itemData name="Note"                      defStyleNum="dsAlert" selColor="#ffffff" bold="1" italic="0"/>
+      <itemData name="Note"                      defStyleNum="dsAlert" />
     </itemDatas>
   </highlighting>
   <general>
diff -urN -x CVS kdelibs.orig/kate/data/php.xml kdelibs/kate/data/php.xml
--- kdelibs.orig/kate/data/php.xml	Sun Jun 20 21:56:41 2004
+++ kdelibs/kate/data/php.xml	Mon Oct 25 10:45:08 2004
@@ -1,6 +1,6 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <!DOCTYPE language SYSTEM "language.dtd">
-<language name="PHP/PHP" version="1.17" kateversion="2.3" section="Scripts" extensions="" priority="5" mimetype="" hidden="true">
+<language name="PHP/PHP" version="1.19" kateversion="2.3" section="Scripts" extensions="" priority="5" mimetype="" hidden="true">
   <highlighting>
     <list name="control structures">
       <item>as</item>
@@ -23,13 +23,25 @@
       <item>include_once</item>
     </list>
     <list name="keywords">
-      <item> var </item>
+      <item> abstract </item>
+      <item> catch </item>
       <item> class </item>
-      <item> new </item>
-      <item> static </item>
-      <item> function </item>
       <item> default </item>
       <item> extends </item>
+      <item> final </item>
+      <item> function </item>
+      <item> implements </item>
+      <item> interface </item>
+      <item> new </item>
+      <item> self </item>
+      <item> static </item>
+      <item> parent </item>
+      <item> private </item>
+      <item> protected </item>
+      <item> public </item>
+      <item> throw </item>
+      <item> try </item>
+      <item> var </item>
       <item> E_ALL </item>
       <item> E_ERROR </item>
       <item> E_NOTICE </item>
@@ -2672,7 +2684,7 @@
         <keyword attribute="Other" context="#stay" String="Others" />
       </context>
       <context name="onelinecomment" attribute="Comment" lineEndContext="#pop">
-        <StringDetect attribute="Keyword" context="#pop#pop" String="?&gt;" />
+        <StringDetect attribute="Keyword" context="#pop" lookAhead="true" String="?&gt;" />
       </context>
       <context name="twolinecomment" attribute="Comment" lineEndContext="#stay">
         <Detect2Chars attribute="Comment" context="#pop" char="*" char1="/" endRegion="Comment" />
diff -urN -x CVS kdelibs.orig/kate/data/ruby.xml kdelibs/kate/data/ruby.xml
--- kdelibs.orig/kate/data/ruby.xml	Tue Aug  3 00:21:07 2004
+++ kdelibs/kate/data/ruby.xml	Sun Nov  7 18:04:20 2004
@@ -21,7 +21,7 @@
   Free Software Foundation, Inc., 59 Temple Place - Suite 330,
   Boston, MA  02111-1307, USA.
  -->
-<language name="Ruby" version="1.08" kateversion="2.3" section="Scripts" extensions="*.rb" mimetype="application/x-ruby" author="Sebastian Vuorinen &lt;sebastian.vuorinen@helsinki.fi&gt;" license="LGPL">
+<language name="Ruby" version="1.10" kateversion="2.3" section="Scripts" extensions="*.rb" mimetype="application/x-ruby" author="Sebastian Vuorinen &lt;sebastian.vuorinen@helsinki.fi&gt;" license="LGPL">
 	<highlighting>
 	
 		<list name = "keywords">
@@ -94,9 +94,15 @@
 		
 		<contexts>
 			<context name = "Normal" attribute = "Normal Text" lineEndContext="#stay">
+				<RegExpr attribute = "Definition" String = "(\b|^[\s]*)(case)(\s+|$)" context="#stay" beginRegion="Region1"/>
+				<RegExpr attribute = "Definition" String = "^[\s]*(begin|module|for|unless|until|while|catch|if|class|def)(\s+|$)" context="#stay" beginRegion="Region1"/>
+				<RegExpr attribute = "Definition" String = "(\b|^[\s]*)do(\s+|$)" context="#stay" beginRegion="Region1"/>
+				<RegExpr attribute = "Definition" String = "(\b|^[\s]*)(unless|if)(?=.*then)" context="#stay" beginRegion="Region1"/>
+				<RegExpr attribute = "Definition" String = "(\b|^[\s]*)(else|elsif|rescue|ensure)(\s+|$)" context="#stay" endRegion="Region1" beginRegion="Region1"/>
+				<RegExpr attribute = "Definition" String = "(\b|^[\s]*)end(\s+|$)" context="#stay" endRegion="Region1"/>
 				<keyword attribute = "Keyword" String = "keywords" context="#stay"/>
 				<keyword attribute = "Attribute Definition" String = "attribute-definitions"  context="#stay"/>
-                <keyword attribute = "Access Control" String = "access-control" context="#stay"/>
+				<keyword attribute = "Access Control" String = "access-control" context="#stay"/>
 				<keyword attribute = "Definition" String = "definitions"  context="#stay" />
 				<keyword attribute = "Pseudo variable" String = "pseudo-variables"  context="#stay"/>
 				
@@ -124,11 +130,12 @@
 				<RegExpr attribute = "Comment" String = "^#\s*BEGIN.*$"  context="#stay" beginRegion="marker"/>
 				<RegExpr attribute = "Comment" String = "^#\s*END.*$"  context="#stay" endRegion="marker"/>
 				<RegExpr attribute = "Comment" String = "^#.*$"  context="#stay"/>
-				<RegExpr attribute = "Comment" String = "\s#.*$"  context="#stay"/>				
+				<RegExpr attribute = "Comment" String = "#.*$"  context="#stay"/>
+				<RegExpr attribute = "Comment" String = "\s#.*$"  context="#stay"/>
 				<RegExpr attribute = "Blockcomment" String = "^=begin\s*.*$" context="Embedded documentation" beginRegion="block"/>
 				<RegExpr attribute = "Delimiter" String = "[\[\]]+"  context="#stay"/>
-				<DetectChar attribute = "Delimiter" char = "{" context="#stay" beginRegion="bracket"/>
-				<DetectChar attribute = "Delimiter" char = "}" context="#stay" endRegion="bracket"/>
+				<DetectChar attribute = "Delimiter" char = "{" context="#stay" beginRegion="Region1"/>
+				<DetectChar attribute = "Delimiter" char = "}" context="#stay" endRegion="Region1"/>
 				
 				<RegExpr attribute = "Global Constant" String = "\s+[A-Z_0-9]+\s+"  context="#stay"/>
 				<RegExpr attribute = "Global Variable" String = "$[a-zA-Z_0-9]+" context="#stay"/>
@@ -138,8 +145,9 @@
 				<RegExpr attribute = "Regular Expression" String = "\%r\{" context="RegEx 2"/>
 				<RegExpr attribute = "String" String = "\%[xqQw]\{" context="Flexible Literal"/>
 			</context>
-			
+
 			<context name = "Quoted String" attribute = "String" lineEndContext="#pop">
+				<LineContinue attribute = "String" context = "#stay"/>
 				<Detect2Chars attribute = "Substitution" char = "#" char1 = "{" context = "Subst"/>
 				<HlCChar attribute = "Char" context = "#pop"/>
 				<DetectChar char = "&quot;" attribute = "String" context = "#pop"/>
@@ -186,7 +194,7 @@
 			
 			<itemData name = "Keyword" defStyleNum ="dsKeyword"/>
 			<itemData name = "Attribute Definition" defStyleNum ="dsOthers"/>
-            <itemData name = "Access Control" defStyleNum ="dsKeyword" color="#0000ff"/>
+			<itemData name = "Access Control" defStyleNum ="dsKeyword" color="#0000ff"/>
 			<itemData name = "Definition" defStyleNum ="dsKeyword"/>
 			<itemData name = "Pseudo variable" defStyleNum ="dsDecVal"/>
 			
diff -urN -x CVS kdelibs.orig/kate/data/sql.xml kdelibs/kate/data/sql.xml
--- kdelibs.orig/kate/data/sql.xml	Sun Jun 20 21:56:41 2004
+++ kdelibs/kate/data/sql.xml	Tue Nov  9 22:46:22 2004
@@ -1,7 +1,7 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <!DOCTYPE language SYSTEM "language.dtd">
 <!-- Oracle9i SQL and PL/SQL syntax - ANSI SQL superset -->
-<language name="SQL" version="1.06" kateversion="2.3" section="Scripts" extensions="*.sql;*.SQL" mimetype="text/x-sql" casesensitive="0" author="Yury Lebedev (yurylebedev@mail.ru)" license="">
+<language name="SQL" version="1.08" kateversion="2.3" section="Database" extensions="*.sql;*.SQL" mimetype="text/x-sql" casesensitive="0" author="Yury Lebedev (yurylebedev@mail.ru)" license="">
   <highlighting>
     <list name="keywords">
       <item> ACCESS </item>
@@ -24,6 +24,7 @@
       <item> ARCHIVELOG </item>
       <item> AS </item>
       <item> ASC </item>
+      <item> ASSERTION </item>
       <item> ASSOCIATE </item>
       <item> AT </item>
       <item> ATTRIBUTE </item>
@@ -140,6 +141,7 @@
       <item> DISMOUNT </item>
       <item> DISTINCT </item>
       <item> DISTRIBUTED </item>
+      <item> DOMAIN </item>
       <item> DROP </item>
       <item> DYNAMIC </item>
       <item> EACH </item>
@@ -829,20 +831,20 @@
         <keyword attribute="Operator" String="operators" context="#stay"/>
         <keyword attribute="Function" String="functions" context="#stay"/>
         <keyword attribute="Data Type" String="types" context="#stay"/>
-        <RegExpr attribute="Data Type" String="%[Bb][Uu][Ll][Kk]_[Ee][Xx][Cc][Ee][Pp][Tt][Ii][Oo][Nn][Ss]\b" context="#stay"/>
-        <RegExpr attribute="Data Type" String="%[Bb][Uu][Ll][Kk]_[Rr][Oo][Ww][Cc][Oo][Uu][Nn][Tt]\b" context="#stay"/>
-        <RegExpr attribute="Data Type" String="%[Ff][Oo][Uu][Nn][Dd]\b" context="#stay"/>
-        <RegExpr attribute="Data Type" String="%[Ii][Ss][Oo][Pp][Ee][Nn]\b" context="#stay"/>
-        <RegExpr attribute="Data Type" String="%[Nn][Oo][Tt][Ff][Oo][Uu][Nn][Dd]\b" context="#stay"/>
-        <RegExpr attribute="Data Type" String="%[Rr][Oo][Ww][Cc][Oo][Uu][Nn][Tt]\b" context="#stay"/>
-        <RegExpr attribute="Data Type" String="%[Rr][Oo][Ww][Tt][Yy][Pp][Ee]\b" context="#stay"/>
-        <RegExpr attribute="Data Type" String="%[Tt][Yy][Pp][Ee]\b" context="#stay"/>
+        <RegExpr attribute="Data Type" String="%bulk_exceptions\b" insensitive="true" context="#stay"/>
+	<RegExpr attribute="Data Type" String="%bulk_rowcount\b" insensitive="true" context="#stay"/>
+	<RegExpr attribute="Data Type" String="%found\b" insensitive="true" context="#stay"/>
+	<RegExpr attribute="Data Type" String="%isopen\b" insensitive="true" context="#stay"/>
+	<RegExpr attribute="Data Type" String="%notfound\b" insensitive="true" context="#stay"/>
+	<RegExpr attribute="Data Type" String="%rowcount\b" insensitive="true" context="#stay"/>
+	<RegExpr attribute="Data Type" String="%rowtype\b" insensitive="true" context="#stay"/>
+	<RegExpr attribute="Data Type" String="%type\b" insensitive="true" context="#stay"/>
         <Float attribute="Float" context="#stay"/>
         <Int attribute="Decimal" context="#stay"/>
         <DetectChar attribute="String" context="String literal" char="'"/>
         <Detect2Chars attribute="Comment" context="Singleline PL/SQL-style comment" char="-" char1="-"/>
         <Detect2Chars attribute="Comment" context="Multiline C-style comment" char="/" char1="*"/>
-        <RegExpr attribute="Comment" context="SQL*Plus remark directive" String="^[Rr][Ee][Mm]\b"/>
+        <RegExpr attribute="Comment" context="SQL*Plus remark directive" String="^rem\b" insensitive="true"/>
         <DetectChar attribute="Identifier" context="User-defined identifier" char="&quot;"/>
         <RegExpr attribute="External Variable" context="#stay" String="(:|&amp;&amp;?)\w+"/>
         <RegExpr attribute="Symbol" context="#stay" String="^/$"/>
diff -urN -x CVS kdelibs.orig/kate/part/kateautoindent.cpp kdelibs/kate/part/kateautoindent.cpp
--- kdelibs.orig/kate/part/kateautoindent.cpp	Tue Sep 14 10:23:13 2004
+++ kdelibs/kate/part/kateautoindent.cpp	Fri Nov 19 15:59:35 2004
@@ -484,7 +484,6 @@
     else
     {
       KateAutoIndent::processNewline (begin, needContinue);
-      begin.setCol(begin.col() - 1);
     }
 
     if (begin.col() < 0)
@@ -495,7 +494,7 @@
 void KateCSmartIndent::processChar(QChar c)
 {
   static const QString triggers("}{)/:;#n");
-  if (triggers.find(c, true) == -1)
+  if (triggers.find(c) < 0)
     return;
 
   KateView *view = doc->activeView();
diff -urN -x CVS kdelibs.orig/kate/part/katebuffer.cpp kdelibs/kate/part/katebuffer.cpp
--- kdelibs.orig/kate/part/katebuffer.cpp	Sat May 22 17:21:31 2004
+++ kdelibs/kate/part/katebuffer.cpp	Tue Nov  9 09:36:01 2004
@@ -88,18 +88,18 @@
       , m_decoder (codec->makeDecoder())
       , m_position (0)
       , m_lastLineStart (0)
-      , m_eof (false) // default to not eof     
+      , m_eof (false) // default to not eof
       , lastWasEndOfLine (true) // at start of file, we had a virtual newline
       , lastWasR (false) // we have not found a \r as last char
       , m_eol (-1) // no eol type detected atm
     {
     }
-    
+
     ~KateFileLoader ()
     {
       delete m_decoder;
     }
-    
+
     /**
      * open file, read first chunk of data, detect eol
      */
@@ -108,12 +108,12 @@
       if (m_file.open (IO_ReadOnly))
       {
         int c = m_file.readBlock (m_buffer.data(), m_buffer.size());
-            
+
         if (c > 0)
           m_text = m_decoder->toUnicode (m_buffer, c);
-          
-        m_eol = m_file.atEnd();
-        
+
+        m_eof = m_file.atEnd();
+
         for (uint i=0; i < m_text.length(); i++)
         {
           if (m_text[i] == '\n')
@@ -135,23 +135,28 @@
             }
           }
         }
-      
+
         return true;
       }
-      
+
       return false;
     }
-    
+
     // no new lines around ?
     inline bool eof () const { return m_eof && !lastWasEndOfLine && (m_lastLineStart == m_text.length()); }
-    
+
     // eol mode ? autodetected on open(), -1 for no eol found in the first block!
     inline int eol () const { return m_eol; }
 
-    // read a line, return per reference, only valid until the next readLine call
-    // or until this object goes to trash !!!
-    QConstString readLine ()
-    {  
+    // internal unicode data array
+    inline const QChar *unicode () const { return m_text.unicode(); }
+
+    // read a line, return length + offset in unicode data
+    void readLine (uint &offset, uint &length)
+    {
+      length = 0;
+      offset = 0;
+
       while (m_position <= m_text.length())
       {
         if (m_position == m_text.length())
@@ -160,74 +165,81 @@
           if (!m_eof)
           {
             int c = m_file.readBlock (m_buffer.data(), m_buffer.size());
-            
+
             if (c > 0)
               m_text = m_text.mid (m_lastLineStart, m_position-m_lastLineStart)
                        + m_decoder->toUnicode (m_buffer, c);
             else
               m_text = m_text.mid (m_lastLineStart, m_position-m_lastLineStart);
-            
+
             // is file completly read ?
             m_eof = m_file.atEnd();
-            
+
             // recalc current pos and last pos
             m_position -= m_lastLineStart;
             m_lastLineStart = 0;
           }
-          
+
           // oh oh, end of file, escape !
           if (m_eof && (m_position == m_text.length()))
           {
             lastWasEndOfLine = false;
-          
-            QConstString line = QConstString (m_text.unicode()+m_lastLineStart, m_position-m_lastLineStart);
+
+            // line data
+            offset = m_lastLineStart;
+            length = m_position-m_lastLineStart;
+
             m_lastLineStart = m_position;
-            
-            return line;
+
+            return;
           }
         }
-        
+
         if (m_text[m_position] == '\n')
         {
           lastWasEndOfLine = true;
-        
+
           if (lastWasR)
           {
             m_lastLineStart++;
             lastWasR = false;
           }
           else
-          {         
-            QConstString line = QConstString (m_text.unicode()+m_lastLineStart, m_position-m_lastLineStart);
+          {
+            // line data
+            offset = m_lastLineStart;
+            length = m_position-m_lastLineStart;
+
             m_lastLineStart = m_position+1;
             m_position++;
-                  
-            return line;
+
+            return;
           }
         }
         else if (m_text[m_position] == '\r')
         {
           lastWasEndOfLine = true;
           lastWasR = true;
-          
-          QConstString line = QConstString (m_text.unicode()+m_lastLineStart, m_position-m_lastLineStart);
+
+          // line data
+          offset = m_lastLineStart;
+          length = m_position-m_lastLineStart;
+
           m_lastLineStart = m_position+1;
           m_position++;
-          
-          return line;
+
+          return;
         }
         else
         {
           lastWasEndOfLine = false;
           lastWasR = false;
         }
-        
+
         m_position++;
       }
-      
-      return QConstString (m_text.unicode(), 0);
-    } 
-    
+    }
+
   private:
     QFile m_file;
     QByteArray m_buffer;
@@ -415,11 +427,11 @@
     clear();
     return false; // Error
   }
-  
+
   // set eol mode, if a eol char was found in the first 256kb block!
   if (file.eol() != -1)
     m_doc->config()->setEol (file.eol());
-  
+
   // flush current content
   clear ();
 
@@ -463,7 +475,7 @@
     // fix region tree
     m_regionTree.fixRoot (m_lines);
   }
-  
+
   // if we have no hl or the "None" hl activated, whole file is correct highlighted
   // after loading, which wonder ;)
   if (!m_highlight || m_highlight->noHighlighting())
@@ -471,7 +483,7 @@
     m_lineHighlighted = m_lines;
     m_lineHighlightedMax = m_lines;
   }
-  
+
   return !m_loadingBorked;
 }
 
@@ -648,7 +660,7 @@
       {
         // remember this block as last found !
         m_lastFoundBlock = m_lastInSyncBlock;
-      
+
         if (index)
           (*index) = m_lastFoundBlock;
 
@@ -700,7 +712,7 @@
   // last sync block adjust
   if (m_lastInSyncBlock > index)
     m_lastInSyncBlock = index;
-    
+
   // last found
   if (m_lastInSyncBlock < m_lastFoundBlock)
     m_lastFoundBlock = m_lastInSyncBlock;
@@ -755,7 +767,7 @@
     if (m_lastInSyncBlock > index)
       m_lastInSyncBlock = index;
   }
-  
+
   // last found
   if (m_lastInSyncBlock < m_lastFoundBlock)
     m_lastFoundBlock = m_lastInSyncBlock;
@@ -1120,8 +1132,10 @@
   uint blockSize = 0;
   while (!stream->eof() && (blockSize < KATE_AVG_BLOCK_SIZE) && (m_lines < KATE_MAX_BLOCK_LINES))
   {
-    QConstString line = stream->readLine();
-    uint length = line.string().length ();
+    uint offset = 0, length = 0;
+    stream->readLine(offset, length);
+    const QChar *unicodeData = stream->unicode () + offset;
+
     blockSize += length;
 
     if (swap)
@@ -1146,13 +1160,13 @@
       memcpy(buf+pos, (char *) &length, sizeof(uint));
       pos += sizeof(uint);
 
-      memcpy(buf+pos, (char *) line.string().unicode(), sizeof(QChar)*length);
+      memcpy(buf+pos, (char *) unicodeData, sizeof(QChar)*length);
       pos += sizeof(QChar)*length;
     }
     else
     {
       KateTextLine::Ptr textLine = new KateTextLine ();
-      textLine->insertText (0, length, line.string().unicode ());
+      textLine->insertText (0, length, unicodeData);
       m_stringList.push_back (textLine);
     }
 
diff -urN -x CVS kdelibs.orig/kate/part/katecmds.h kdelibs/kate/part/katecmds.h
--- kdelibs.orig/kate/part/katecmds.h	Wed May 12 18:36:13 2004
+++ kdelibs/kate/part/katecmds.h	Mon Oct  4 23:30:48 2004
@@ -44,9 +44,9 @@
      * @return success
      */
     bool exec( class Kate::View *view, const QString &cmd, QString &errorMsg );
-  
+
     bool help( class Kate::View *, const QString &, QString & ) {return false;};
-  
+
     /**
      * supported commands as prefixes
      * @return prefix list
@@ -82,8 +82,7 @@
      * supported commands as prefixes
      * @return prefix list
      */
-    QStringList cmds () { return QStringList("s"); };
-
+    QStringList cmds () { QStringList l; l << "s"<<"%s" /*<<"$s"*/; return l; };
   private:
     static QString sedMagic(QString textLine, const QString &find, const QString &replace, bool noCase, bool repeat);
 };
diff -urN -x CVS kdelibs.orig/kate/part/katedocument.cpp kdelibs/kate/part/katedocument.cpp
--- kdelibs.orig/kate/part/katedocument.cpp	Tue Sep 28 09:34:27 2004
+++ kdelibs/kate/part/katedocument.cpp	Sun Oct 24 00:47:37 2004
@@ -2457,9 +2457,6 @@
     connect( m_job, SIGNAL( result( KIO::Job* ) ),
            SLOT( slotFinishedKate( KIO::Job* ) ) );
 
-    // set text mode
-    m_job->addMetaData ("textmode", "true");
-
     QWidget *w = widget ();
     if (!w && !m_views.isEmpty ())
       w = m_views.first();
@@ -3276,7 +3273,7 @@
   if (!(config()->configFlags() & KateDocument::cfKeepSelection))
     clearSelection ();
 
-  setSelection (cursor.line(), 0, cursor.line()/*+1, 0*/, m_buffer->plainLine(cursor.line())->length() );
+  setSelection (cursor.line(), 0, cursor.line()+1, 0 );
 }
 
 void KateDocument::selectLength( const KateTextCursor& cursor, int length )
@@ -4342,28 +4339,51 @@
   {
     m_isasking = 1;
 
-    int exitval = ( v && v->hasFocus() ? 0 : -1 );
+    if ( m_modOnHdReason == 3 ) // deleted
+    {
+      switch ( KMessageBox::warningYesNoCancel( widget(),
+               reasonedMOHString() + "\n\n" + i18n("What do you want to do?"),
+               i18n("File Was Deleted on Disk"),
+               i18n("&Save As..."), i18n("&Ignore Changes")) )
+      {
+        case KMessageBox::Yes: // "save file"
+          m_modOnHd = false; // trick save() to not ask again
+          emit modifiedOnDisc( this, false, 0 );
+          saveAs(url());
+          m_isasking = 0;
+          break;
+
+          case KMessageBox::No:  // "ignore changes"
+            m_modOnHd = false;
+            emit modifiedOnDisc( this, false, 0 );
+            m_isasking = 0;
+            break;
 
-    switch ( KMessageBox::warningYesNoCancel( widget(),
-                reasonedMOHString() + "\n\n" + i18n("What do you want to do?"),
-                i18n("File Was Modified on Disk"),
-                i18n("&Reload File"), i18n("&Ignore Changes")) )
-    {
-      case KMessageBox::Yes: // "reload file"
-        m_modOnHd = false; // trick reloadFile() to not ask again
-        emit modifiedOnDisc( this, false, 0 );
-        reloadFile();
-        m_isasking = 0;
-        break;
-
-      case KMessageBox::No:  // "ignore changes"
-        m_modOnHd = false;
-        emit modifiedOnDisc( this, false, 0 );
-        m_isasking = 0;
-        break;
+            default:               // cancel: ignore next focus event
+              m_isasking = -1;
+      }
+    } else {
+      switch ( KMessageBox::warningYesNoCancel( widget(),
+               reasonedMOHString() + "\n\n" + i18n("What do you want to do?"),
+               i18n("File Was Modified on Disk"),
+               i18n("&Reload File"), i18n("&Ignore Changes")) )
+      {
+        case KMessageBox::Yes: // "reload file"
+          m_modOnHd = false; // trick reloadFile() to not ask again
+          emit modifiedOnDisc( this, false, 0 );
+          reloadFile();
+          m_isasking = 0;
+          break;
+
+          case KMessageBox::No:  // "ignore changes"
+            m_modOnHd = false;
+            emit modifiedOnDisc( this, false, 0 );
+            m_isasking = 0;
+            break;
 
-      default:               // cancel: ignore next focus event
-        m_isasking = -1;
+            default:               // cancel: ignore next focus event
+              m_isasking = -1;
+      }
     }
   }
 }
diff -urN -x CVS kdelibs.orig/kate/part/katehighlight.cpp kdelibs/kate/part/katehighlight.cpp
--- kdelibs.orig/kate/part/katehighlight.cpp	Mon Sep 13 11:57:17 2004
+++ kdelibs/kate/part/katehighlight.cpp	Sun Oct 10 22:03:32 2004
@@ -1989,6 +1989,9 @@
 
 QString KateHighlighting::getCommentString( int which, int attrib ) const
 {
+  if ( noHl )
+    return which == 3 ? stdDeliminator : "";
+
   int k = hlKeyForAttrib( attrib );
   const QStringList& lst = m_additionalData[k];
   return lst.isEmpty() ? QString::null : lst[which];
diff -urN -x CVS kdelibs.orig/kate/part/katerenderer.cpp kdelibs/kate/part/katerenderer.cpp
--- kdelibs.orig/kate/part/katerenderer.cpp	Thu Jun 10 09:33:05 2004
+++ kdelibs/kate/part/katerenderer.cpp	Sun Oct 10 09:15:51 2004
@@ -354,8 +354,7 @@
 
       // Determine current syntax highlighting attribute
       // A bit legacy but doesn't need to change
-      KateAttribute* curAt = (!noAttribs && (*a) >= atLen) ? &at[0] : &at[*a];
-
+      KateAttribute* curAt = (noAttribs || ((*a) >= atLen)) ? &at[0] : &at[*a];
       // X position calculation. Incorrect for fonts with non-zero leftBearing() and rightBearing() results.
       // TODO: make internal charWidth() function, use QFontMetrics::charWidth().
       xPosAfter += curAt->width(*fs, curChar, m_tabWidth);
@@ -501,6 +500,12 @@
           // Here's where the money is...
           paint.drawText(oldXPos-xStart, y, textLine->string(), oldCol, curCol+1-oldCol);
 
+          // Draw preedit's underline
+          if (isIMEdit) {
+            QRect r( oldXPos - xStart, 0, xPosAfter - oldXPos, fs->fontHeight );
+            paint.drawLine( r.bottomLeft(), r.bottomRight() );
+          }
+
           // Put pen color back
           if (isIMSel) paint.restore();
 
diff -urN -x CVS kdelibs.orig/kate/part/katesearch.cpp kdelibs/kate/part/katesearch.cpp
--- kdelibs.orig/kate/part/katesearch.cpp	Wed Aug 25 03:07:38 2004
+++ kdelibs/kate/part/katesearch.cpp	Fri Oct 22 12:26:42 2004
@@ -114,7 +114,7 @@
     searchFlags.replace = false;
     searchFlags.finished = false;
     searchFlags.regExp = KateViewConfig::global()->searchFlags() & KFindDialog::RegularExpression;
-    
+
     if ( searchFlags.selected )
     {
       s.selBegin = KateTextCursor( doc()->selStartLine(), doc()->selStartCol() );
@@ -123,7 +123,7 @@
     } else {
       s.cursor = getCursor();
     }
-    
+
     s.wrappedEnd = s.cursor;
     s.wrapped = false;
 
@@ -254,7 +254,7 @@
       s.cursor.setCol(doc()->lineLength( s.cursor.line() ));
     }
   }
-  
+
   // oh, we wrapped around one time allready now !
   // only check that on replace
   s.wrapped = s.flags.replace;
@@ -364,6 +364,19 @@
   doc()->editEnd(),
 
   replaces++;
+  // if we inserted newlines, we better adjust.
+  uint newlines = replaceWith.contains('\n');
+  if ( newlines )
+  {
+    if ( ! s.flags.backward )
+    {
+      s.cursor.setLine( s.cursor.line() + newlines );
+      s.cursor.setCol( replaceWith.length() - replaceWith.findRev('\n') );
+    }
+    // selection?
+    if ( s.flags.selected )
+      s.selEnd.setLine( s.selEnd.line() + newlines );
+  }
 
   // adjust selection endcursor if needed
   if( s.flags.selected && s.cursor.line() == s.selEnd.line() )
@@ -569,7 +582,7 @@
   // save the search result
   s.cursor.setPos(foundLine, foundCol);
   s.matchedLength = matchLen;
-  
+
   // we allready wrapped around one time
   if (s.wrapped)
   {
@@ -586,9 +599,9 @@
         return false;
     }
   }
-  
+
   //kdDebug() << "Found at " << s.cursor.line() << ", " << s.cursor.col() << endl;
-  
+
 
   //m_searchResults.append(s);
 
@@ -667,7 +680,7 @@
 void KateReplacePrompt::done (int result)
 {
   setResult(result);
-  
+
   emit clicked();
 }
 //END KateReplacePrompt
diff -urN -x CVS kdelibs.orig/kate/part/katetextline.h kdelibs/kate/part/katetextline.h
--- kdelibs.orig/kate/part/katetextline.h	Wed Aug 25 04:04:50 2004
+++ kdelibs/kate/part/katetextline.h	Tue Nov  9 09:36:01 2004
@@ -160,15 +160,6 @@
     { return m_text.mid(startCol, length); }
 
     /**
-     * Gets a substring as constant string.
-     * @param startCol start column of substring
-     * @param length lenght of substring
-     * @return wanted substring
-     */
-    inline QConstString constString(uint startCol, uint length) const
-    { return QConstString(m_text.unicode() + startCol, length); }
-
-    /**
      * Gets a null terminated pointer to first non space char
      * @return array of QChars starting at first non-whitespace char
      */
diff -urN -x CVS kdelibs.orig/kate/part/kateview.cpp kdelibs/kate/part/kateview.cpp
--- kdelibs.orig/kate/part/kateview.cpp	Mon Aug 23 14:54:36 2004
+++ kdelibs/kate/part/kateview.cpp	Tue Nov  9 11:01:11 2004
@@ -879,6 +879,10 @@
 
 void KateView::gotoLineNumber( int line )
 {
+  // clear selection, unless we are in persistent selection mode
+  if ( ! (m_doc->config()->configFlags() & KateDocumentConfig::cfPersistent) )
+    m_doc->clearSelection();
+
   setCursorPositionInternal ( line, 0, 1 );
 }
 
diff -urN -x CVS kdelibs.orig/kate/part/kateviewinternal.cpp kdelibs/kate/part/kateviewinternal.cpp
--- kdelibs.orig/kate/part/kateviewinternal.cpp	Thu Aug 26 13:06:16 2004
+++ kdelibs/kate/part/kateviewinternal.cpp	Sun Oct 24 00:29:12 2004
@@ -85,6 +85,7 @@
   , m_imPreeditStartLine(0)
   , m_imPreeditStart(0)
   , m_imPreeditLength(0)
+  , m_imPreeditSelStart(0)
 {
   setMinimumSize (0,0);
 
@@ -891,6 +892,26 @@
   return QPoint(x, y);
 }
 
+
+void KateViewInternal::updateMicroFocusHint()
+{
+  int line = displayViewLine(displayCursor, true);
+  if (line == -1)
+      return;
+
+// Cursor placement code is changed for Asian input method that
+  // shows candidate window. This behavior is same as Qt/E 2.3.7
+  // which supports Asian input methods. Asian input methods need
+  // start point of IM selection text to place candidate window as
+  // adjacent to the selection text.
+  uint preeditStrLen = m_view->renderer()->textWidth(textLine(m_imPreeditStartLine), cursor.col()) - m_view->renderer()->textWidth(textLine(m_imPreeditStartLine), m_imPreeditSelStart);
+  uint x = cXPos - m_startX - lineRanges[line].startX + lineRanges[line].xOffset() - preeditStrLen;
+  uint y = line * m_view->renderer()->fontHeight();
+
+  setMicroFocusHint( x, y, 0, m_view->renderer()->fontHeight() );
+}
+
+
 void KateViewInternal::doReturn()
 {
   KateTextCursor c = cursor;
@@ -2062,8 +2083,7 @@
   tagLine(oldDisplayCursor);
   tagLine(displayCursor);
 
-  QPoint cursorP = cursorCoordinates();
-  setMicroFocusHint( cursorP.x(), cursorP.y(), 0, m_view->renderer()->fontHeight() );
+  updateMicroFocusHint();
 
   if (m_cursorTimer.isActive ())
   {
@@ -2677,7 +2697,7 @@
       }
 
       if (dragInfo.state == diPending)
-        placeCursor( e->pos() );
+        placeCursor( e->pos(), e->state() & ShiftButton );
       else if (dragInfo.state == diNone)
         m_scrollTimer.stop ();
 
@@ -2907,7 +2927,7 @@
 {
   // track the cursor to the current drop location
   placeCursor( event->pos(), true, false );
-  
+
   // important: accept action to switch between copy and move mode
   // without this, the text will always be copied.
   event->acceptAction();
@@ -2940,10 +2960,17 @@
       return;
     }
 
+    // use one transaction
+    m_doc->editStart ();
+
     // on move: remove selected text; on copy: duplicate text
     if ( event->action() != QDropEvent::Copy )
       m_doc->removeSelectedText();
+
     m_doc->insertText( cursor.line(), cursor.col(), text );
+
+    m_doc->editEnd ();
+
     placeCursor( event->pos() );
 
     event->acceptAction();
@@ -2969,6 +2996,7 @@
   m_imPreeditStartLine = cursor.line();
   m_imPreeditStart = cursor.col();
   m_imPreeditLength = 0;
+  m_imPreeditSelStart = m_imPreeditStart;
 
   m_doc->setIMSelectionValue( m_imPreeditStartLine, m_imPreeditStart, 0, 0, 0, true );
 }
@@ -2993,7 +3021,9 @@
 
   updateView( true );
   updateCursor( cursor, true );
+
   m_imPreeditLength = e->text().length();
+  m_imPreeditSelStart = m_imPreeditStart + e->cursorPos();
 }
 
 void KateViewInternal::imEndEvent( QIMEvent *e )
@@ -3023,6 +3053,7 @@
 
   m_imPreeditStart = 0;
   m_imPreeditLength = 0;
+  m_imPreeditSelStart = 0;
 }
 
 //
diff -urN -x CVS kdelibs.orig/kate/part/kateviewinternal.h kdelibs/kate/part/kateviewinternal.h
--- kdelibs.orig/kate/part/kateviewinternal.h	Sun May 23 19:00:07 2004
+++ kdelibs/kate/part/kateviewinternal.h	Sun Oct 10 09:13:08 2004
@@ -260,6 +260,8 @@
 
     void paintCursor();
 
+    void updateMicroFocusHint();
+
     void placeCursor( const QPoint& p, bool keepSelection = false, bool updateSelection = true );
     bool isTargetSelected( const QPoint& p );
 
@@ -428,6 +430,7 @@
    int m_imPreeditStartLine;
    int m_imPreeditStart;
    int m_imPreeditLength;
+   int m_imPreeditSelStart;
 };
 
 #endif
diff -urN -x CVS kdelibs.orig/kate/plugins/autobookmarker/ktexteditor_autobookmarker.desktop kdelibs/kate/plugins/autobookmarker/ktexteditor_autobookmarker.desktop
--- kdelibs.orig/kate/plugins/autobookmarker/ktexteditor_autobookmarker.desktop	Sun Sep 12 15:55:49 2004
+++ kdelibs/kate/plugins/autobookmarker/ktexteditor_autobookmarker.desktop	Fri Nov 12 08:27:48 2004
@@ -1,6 +1,7 @@
 [Desktop Entry]
 Encoding=UTF-8
 Name=KTextEditor Autobookmarker
+Name[af]=KTextEditor OutoBoekmerker
 Name[be]=Дапаўненьне "Аўтаматычныя закладкі" K Тэкставага рэдактара
 Name[bn]=কে-টেক্সট-এডিটর অটো-মুকমার্কার
 Name[bs]=KTextEditor automatske zabilješke
@@ -18,7 +19,10 @@
 Name[is]=KTextEditor sjálfvirkur bókamerkjari
 Name[it]=Segnalibri automatici di KTextEditor
 Name[ja]=KTextEditor 自動ブックマーク
+Name[lt]=KTextEditor automatinis žymelių įterpėjas
+Name[mk]=KTextEditor Автообележувач
 Name[nb]=Automatisk bokmerke for KTextEditor
+Name[nds]=Automaatsch Leesteken setten
 Name[nl]=KTextEditor Autobladwijzers
 Name[nn]=Automatisk bokmerke for KTextEditor
 Name[pa]=ਕੇਪਾਠਸੰਪਾਦਕ ਸਵੈਬੁੱਕਮਾਰਕਰ
@@ -30,14 +34,14 @@
 Name[se]=KTextEditor:a automáhtalaš girjemerkejeaddji
 Name[sk]=Automatické záložky pre KTextEditor
 Name[sr]=KTextEditor-ов аутомаркер
-Name[sr@Latn]=KTextEditor-ов аутомаркер
+Name[sr@Latn]=KTextEditor-ov automarker
 Name[sv]=Automatiska bokmärken för Ktexteditor
 Name[ta]=கேஉரைதொகுப்பாளர் தானியக்க புத்தக உருவாக்கி
 Name[tg]=Китоби худқайдкуни KTextEditor
 Name[uk]=Втулок автоматичних закладок KTextEditor
 Name[zh_CN]=KTextEditor 自动书签器
 Comment=Set bookmarks on lines matching a pattern when documents are loaded
-Comment[ar]=يقوم بوضع علامات على الأسطر المطابقة لنمط عند تحميل المستندات
+Comment[af]=Stel 'n boekmerk op lyne wat met 'n patroon ooreenstem wanneer die dokument gelaai word.
 Comment[bg]=Установяване на отметки на редовете, които отговарят на зададен шаблон по време на зареждане на файла
 Comment[bn]=ডকুমেন্ট লোড করাকালীন প্রদত্ত নকশার সাথে মেলে এমন সমস্ত লাইন বুকমার্ক করে
 Comment[bs]=Podešava zabilješke na linijama koje odgovaraju uzorku pri učitavanju dokumenta
@@ -56,7 +60,10 @@
 Comment[is]=Setur bókamerki á línur sem passa ákveðnu mynstri, þegar skjöl eru lesin
 Comment[it]=Imposta dei segnalibri sulle righe corrispondendi a uno schema quando si caricano dei documenti
 Comment[ja]=文書が読み込まれた時、パターンにマッチした行にブックマークを設定します
+Comment[lt]=Įterpia žymeles eilutėse, kurios atitinka tam tikrą derinį, dokumento įkėlimo metu
+Comment[mk]=Постава обележувачи на линиите кои се поклопуваат со шема кога документите се вчитуваат
 Comment[nb]=Bestem bokmerke på linjer som passer til et mønster når dokument blir åpnet
+Comment[nds]=Sett al bi't Laden Leestekens för Regen, de to'n Muster passt
 Comment[nl]=Plaatsen van bladwijzers op regels die voldoen aan een bepaald patroon zodra het document geopend wordt
 Comment[nn]=Set bokmerke på linjer som passar til eit mønster når dokument vert opna
 Comment[pa]=ਜਦੋਂ ਵੀ ਦਸਤਾਵੇਜ਼ ਨੂੰ ਲੋਡ ਕੀਤਾ ਜਾ ਰਿਹਾ ਹੋਵੇ ਤਾਂ ਬੁੱਕਮਾਰਕ ਨੂੰ ਸਤਰ-ਮੇਲ ਤਰਤੀਬ ਨਿਰਧਾਰਿਤ ਕਰੋ
@@ -67,7 +74,7 @@
 Comment[ru]=Установка закладок в текстовом документе по шаблону
 Comment[sk]=Nastavuje záložky pri načítaní dokumentu na riadky zodpovedajúce vzorke
 Comment[sr]=Поставља маркере на линијама које се уклапају у узорак када се учитавају документи
-Comment[sr@Latn]=Поставља маркере на линијама које се уклапају у узорак када се учитавају документи
+Comment[sr@Latn]=Postavlja markere na linijama koje se uklapaju u uzorak kada se učitavaju dokumenti
 Comment[sv]=Lägg till bokmärken på rader som motsvarar ett mönster när dokument laddas
 Comment[ta]= ஆவணங்கள் பதிவாகும் போது அமைப்பு புத்தகக்குறிப்பு கோடுகள் பொருத்தும் மாதிரி
 Comment[tg]=Вақте ки санад пурбор шудааст, монданиҳоро дар хати мутобиқат низ сабт намоед
diff -urN -x CVS kdelibs.orig/kate/plugins/insertfile/ktexteditor_insertfile.desktop kdelibs/kate/plugins/insertfile/ktexteditor_insertfile.desktop
--- kdelibs.orig/kate/plugins/insertfile/ktexteditor_insertfile.desktop	Sun Sep 12 15:55:49 2004
+++ kdelibs/kate/plugins/insertfile/ktexteditor_insertfile.desktop	Fri Nov 12 08:27:48 2004
@@ -1,6 +1,7 @@
 [Desktop Entry]
 Encoding=UTF-8
 Name=KTextEditor Insert File Plugin
+Name[af]=KTextEditor Voeg Lêer In Inprop Module
 Name[ar]=ملحق إدراج ملف لمحرر النصوص
 Name[az]=KTextEditor Fayl Əlavəsi Daxil El
 Name[be]=Дапаўненьне "Уставіць файл" K Тэкставага рэдактара
@@ -31,11 +32,12 @@
 Name[ja]=KTextEditorファイル挿入プラグイン
 Name[ko]=K글월편집기 파일 끼워넣는 플러그인
 Name[lt]=KTextEditor bylos įterpimo priedas
+Name[mk]=KTextEditor приклучок за внес на датотеки
 Name[mn]=XML-Plugin Залгаас файлуудын хувьд
 Name[ms]=Plug masuk Fail KTextEditor
 Name[mt]=Plagin ta' KTextEditor biex iddaħħal fajl
 Name[nb]=Programtillegg for 'sett inn fil' i KTextEditor
-Name[nds]=KTextEditor-Plugin för dat Infögen vun Datein
+Name[nds]=KTextEditor-Plugin för dat Infögen vun Dateien
 Name[nl]=KTextEditor-plugin voor het invoegen van bestanden
 Name[nn]=Programtillegg for innsetjing av fil i skriveprogram
 Name[nso]=Tsenyo ya Faele ya Mofetosi wa Sengwalwana sa K
@@ -50,7 +52,7 @@
 Name[sl]=Vstavek KTextEditor za vstavljanje datotek
 Name[sq]=KTextEditor Shtojca: Fute skedën
 Name[sr]=KTextEditor прикључак за уметање фајла
-Name[sr@Latn]=KTextEditor dodatak za umetanje fajla.
+Name[sr@Latn]=KTextEditor priključak za umetanje fajla
 Name[ss]=I-KTextEditor yingenisa i-plugin yelifayela
 Name[sv]=Ktexteditor-insticksprogram för att infoga filer
 Name[ta]=கேஉரைதொகுப்பாளர் கோப்பு உள்ளீட்டுச் சொருகுப்பொருள்
@@ -65,11 +67,12 @@
 Name[zh_TW]=文字編輯器插入檔案外掛程式
 Name[zu]=Faka Ifayela Lokungena ngaphakathi le-KTextEditor
 Comment=Insert any readable file at cursor position
-Comment[ar]=أدرج أي ملف قابل للقراءة عند موضع المؤشر
+Comment[af]=Voeg enige leesbare lêer in by die merker posisie
 Comment[bg]=Вмъкване на файл от мястото на курсора
 Comment[bn]=কার্সার অবস্থানে যে কোনো (পাঠযোগ্য) ফাইল অন্তর্ভুক্ত করতে পারে
 Comment[bs]=Ubacuje bilo koju čitljivu datoteku na poziciju kursora
 Comment[ca]=Inserir qualsevol fitxer llegible en la posició del cursor
+Comment[cs]=Vloží jakýkoliv čitelný soubor na místo kurzoru
 Comment[da]=Indsæt en vilkårlig læsbar fil ved markørens position
 Comment[de]=Beliebige lesbare Datei an Cursor-Position einfügen
 Comment[el]=Εισαγωγή οποιουδήποτε αναγνώσιμου αρχείου στη θέση του κέρσορα
@@ -84,7 +87,10 @@
 Comment[it]=Inserisce un qualsiasi file alla posizione del cursore
 Comment[ja]=カーソル位置に読み込み可能なファイルを挿入します
 Comment[ko]=커서가 있는 곳에 읽을 수 있는 파일을 끼워 넣습니다
+Comment[lt]=Įterpią bet kokią skaitomą bylą ties žymekliu
+Comment[mk]=Внесува било која читлива датотека на позицијата на курсорот
 Comment[nb]=Sett inn en lesbar fil ved skrivemerket
+Comment[nds]=Jichtenseen leesbore Datei bi'n Cursor infögen
 Comment[nl]=Voeg een willekeurig leesbaar bestand in op de cursorpositie
 Comment[nn]=Set inn ei lesbar fil ved skrivemerket
 Comment[pa]=ਕੋਈ ਪੜਨਯੋਗ ਫਾਇਲ ਕਰਸਰ ਸਥਿਤੀ ਤੇ ਸ਼ਾਮਿਲ ਕਰੋ
@@ -96,7 +102,7 @@
 Comment[sk]=Vloží ľubovoľný súbor na pozíciu kurzora
 Comment[sl]=Vstavi katerokoli berljivo datoteko na položaju kazalca
 Comment[sr]=Убаците било који читљиви фајл на положају курсора
-Comment[sr@Latn]=Убаците било који читљиви фајл на положају курсора
+Comment[sr@Latn]=Ubacite bilo koji čitljivi fajl na položaju kursora
 Comment[sv]=Infoga vilken läsbar fil som helst vid markörens plats
 Comment[ta]=சுட்டும் இடத்தில் படிக்கக்கூடிய கோப்பினை உள்ளிடு
 Comment[tg]=Ягон файли хонда мешударо ба ҳолати курсор низ гузоред
diff -urN -x CVS kdelibs.orig/kate/plugins/isearch/ktexteditor_isearch.desktop kdelibs/kate/plugins/isearch/ktexteditor_isearch.desktop
--- kdelibs.orig/kate/plugins/isearch/ktexteditor_isearch.desktop	Mon Sep 20 15:53:12 2004
+++ kdelibs/kate/plugins/isearch/ktexteditor_isearch.desktop	Fri Nov 12 08:27:49 2004
@@ -1,6 +1,7 @@
 [Desktop Entry]
 Encoding=UTF-8
 Name=KTextEditor Incremental Search Plugin
+Name[af]=KTextEditor Inkrementele Soektog Inprop Module
 Name[ar]=ملحق بحث تزايدي لمحرر نصوص كيدي
 Name[az]=KTextEditor Artan Axtarış Əlavəsi
 Name[bs]=KTextEditor dodatak za inkrementalnu pretragu
@@ -27,10 +28,12 @@
 Name[it]=Plugin ricerca incrementale di KTextEditor
 Name[ja]=KTextEditor インクリメンタル検索プラグイン
 Name[lt]=KTextEditor augančios paieškos priedas
+Name[mk]=KTextEditor приклучок за инкрементално пребарување
 Name[mn]=Текст боловсруулагчийн нэмэлт хайлтын плугин
 Name[ms]=Plug masuk Carian Meningkat KTextEditor
 Name[mt]=Plagin ta' KTextEditor għal tfittix inkrementali
 Name[nb]=Programtillegg for 'fortløpende søk' i KTextEditor
+Name[nds]=KTextEditor-Plugin för dat Söken "Schritt för Schritt"
 Name[nl]=KTextEditor-plugin voor incrementele zoekacties
 Name[nn]=Programtillegg for inkrementelt søk i skriveprogram
 Name[nso]=Tsenyo ya Nyako ya Koketso ya Mofetosi wa Sengwalwana sa K
@@ -45,7 +48,7 @@
 Name[sl]=Vstavek KTextEditor za postopno iskanje
 Name[sq]=KTextEditor Shtojca: Kërkim përmes Numrimit
 Name[sr]=KTextEditor прикључак за инкрементално претраживање
-Name[sr@Latn]=KTextEditor dodatak za inkrementalno pretraživanje.
+Name[sr@Latn]=KTextEditor priključak za inkrementalno pretraživanje
 Name[ss]=I-plugin yekusesha lokungetekako kwe KTextEditor 
 Name[sv]=Ktexteditor-insticksprogram för inkrementell sökning
 Name[ta]=கேஉரை தொகுப்பாளர் படிப்படியான தேடற் சொருகுப்பொருள்
@@ -59,7 +62,7 @@
 Name[zh_TW]=KTextEditor 漸進式搜尋外掛程式
 Name[zu]=I-Plugin Yosesho Lokwenyuka ngezigaba ze-KTextEditor
 Comment=Also known as "As you type search"
-Comment[ar]=معروف أيضا باسم "البحث عند الكتابة" 
+Comment[af]=Ook bekend as "Soos jy tik soektog"
 Comment[bg]=Последователно търсене, известно още като търсене по време на въвеждане на низа
 Comment[bn]="টাইপ করাকালীন সন্ধান" হিসাবেও পরিচিত
 Comment[bs]=Takođe poznat kao "Pretraga dok kucate"
@@ -78,7 +81,10 @@
 Comment[is]=Einnig þekkt sem "Leita meðan þú pikkar"
 Comment[it]=Noto anche come "Ricerca mentre scrivi"
 Comment[ja]="打ったものそのまま検索"としても知られています
+Comment[lt]=Taip pat žinomas kaip „paieška spausdinimo metu“
+Comment[mk]=Познато и како "пребарување додека куцате"
 Comment[nb]=Også kjent som søk «etterhvert som du skriver»
+Comment[nds]=Direktemang bi't Tippen söken
 Comment[nl]=Ook bekend als "Zoeken terwijl u typt"
 Comment[nn]=Òg kjend som søk «etter kvart som du skriv»
 Comment[pa]=ਇਸ ਤਰਾਂ ਵੀ ਜਾਣੋ ਕਿ "ਜਿਵੇਂ ਤੁਸੀਂ ਖੋਜ ਲਿਖੀ"
@@ -91,7 +97,7 @@
 Comment[sk]=Známe aj ako "Hľadanie podľa napísaného textu"
 Comment[sl]=Znano tudi kot »Iskanje med tipkanjem«
 Comment[sr]=Познато и као „претрага док куцате“
-Comment[sr@Latn]=Познато и као „претрага док куцате“
+Comment[sr@Latn]=Poznato i kao „pretraga dok kucate“
 Comment[sv]=Också känt som "Sök medan du skriver"
 Comment[ta]="தேடு என்று தட்டச்சிட்டவுடன்"  என்றும் அழைக்கப்படும்
 Comment[tg]=Ҳамчун "Вақти чоп кардан ба ҷустуҷ шавед" шинохта мешавад
diff -urN -x CVS kdelibs.orig/kate/plugins/kdatatool/ktexteditor_kdatatool.desktop kdelibs/kate/plugins/kdatatool/ktexteditor_kdatatool.desktop
--- kdelibs.orig/kate/plugins/kdatatool/ktexteditor_kdatatool.desktop	Sun Sep 12 15:55:49 2004
+++ kdelibs/kate/plugins/kdatatool/ktexteditor_kdatatool.desktop	Sun Nov 28 09:33:02 2004
@@ -1,6 +1,7 @@
 [Desktop Entry]
 Encoding=UTF-8
 Name=KTextEditor KDataTool Plugin
+Name[af]=KTextEditor KDataTool Inprop Module
 Name[ar]=ملحق KDataTool لـ KTextEditor
 Name[az]=KTextEditor KDataVasitəsi Əlavəsi
 Name[bn]=কে-টেক্সট-এডিটর কে-ডেটা-টুল প্লাগ-ইন
@@ -28,6 +29,7 @@
 Name[it]=Plugin KDataTool di KTextEditor
 Name[ja]=KTextEditor KDataTool プラグイン
 Name[lt]=KTextEditor KDataTool priedas
+Name[mk]=KTextEditor KDataTool приклучок
 Name[mn]=Текст боловсруулагчийн өгөгдлийн хэрэгслийн плугин
 Name[ms]=Plug masuk KDataTool KTextEditor
 Name[mt]=Name=Plagin ta' KTextEditor - KDataTool
@@ -47,7 +49,7 @@
 Name[sl]=Vstavek KTextEditor KDataTool
 Name[sq]=KTextEditor Shtojca: KDataTool
 Name[sr]=KTextEditor KDataTool прикључак
-Name[sr@Latn]=KTextEditor KDataTool dodatak
+Name[sr@Latn]=KTextEditor KDataTool priključak
 Name[ss]=I-plugin KDataTool ku KTextEditor
 Name[sv]=Ktexteditor-insticksprogram med dataverktyg
 Name[ta]=கேஉரைதொகுப்பாளர் கேதகவல் கருவி சொருகுப்பொருள்
@@ -91,12 +93,13 @@
 Comment[it]=Abilita gli strumenti per i dati come il dizionario dei sinonimi e il controllo ortografico
 Comment[ja]=同義語ツールやスペルチェックなどのデータツールを有効にします （インストールされている場合）
 Comment[ko]=(깔려 있다면) 비슷한 말 사전과 맞춤법 검사기 같은 도구를 씁니다
-Comment[lt]=Įjungia duomenų įrankius, tokius kaip tezauras ir rašybos tikrinimas (jei įdiegta)
+Comment[lt]=Įjungia duomenų įrankius, tokius kaip sinonimų žodynas ir rašybos tikrinimas (jei įdiegta)
+Comment[mk]=Овозможување на алатки како енциклопедија или проверка на правопис (ако се инсталирани)
 Comment[mn]=thesaurus and spell check (хэрвээ суусан бол) гэх мэт өгөгдлийн хэрэгслүүдийг нээнэ.
 Comment[ms]=Membolehkan alatan data seperti tesaurus dan periksa ejaan(jika dipasang)
 Comment[mt]=Ippermetti l-użu ta' għodda bħat-teżawru u spell check (jekk installati)
 Comment[nb]=Skru på dataverktøy som ordbok og stavekontroll (hvis det er installert)
-Comment[nds]=Warktüüch as Thesaurus oder Schrievwies pröven anmaken (wenn op dien Rekner)
+Comment[nds]=Warktüüch as Thesaurus oder Klookschriever anmaken (wenn op dien Reekner)
 Comment[nl]=Activering van hulpprogramma's, zoals de thesaurus en spellingcontrole (indien geïnstalleerd)
 Comment[nn]=Tilgang til dataverktøy som ordliste og stavekontroll
 Comment[nso]=Kgontsha dibereka tsa data goswana le thesaurus le tebelelo yamongwalo (ge di tsentswe)
@@ -106,7 +109,7 @@
 Comment[pt_BR]=Habilita as ferramentas de dados, como o Thesaurus e a verificação ortográfica (se instalados)
 Comment[ro]=Activează utilitare de date precum dicţionarul şi verificarea ortografică (dacă sînt instalate)
 Comment[ru]=позволяет использовать утилиты словаря и проверки орфографии (если они установлены)
-Comment[se]=Geavat diehtoneavvuid nugo synonymasátnelisttu ja čállindárkkisteami (jos leat sajáiduhttojuvvon)
+Comment[se]=Geavat diehtoreaidduid nugo synonymasátnelisttu ja čállindárkkisteami (jos leat sajáiduhttojuvvon)
 Comment[sk]=Podpora dátových nástrojov, ako je thesaurus a kontrola pravopisu (ak sú nainštalované)
 Comment[sl]=Omogoči orodja za podatke, kot so slovar sopomenk in preverjanje črkovanja (če je nameščen)
 Comment[sq]=Lejo veglat për të dhënat sikurse fjalori i sinonimeve dhe korigjuesi i fjalëve (nëse janë të instaluara)
diff -urN -x CVS kdelibs.orig/kate/plugins/wordcompletion/docwordcompletion.cpp kdelibs/kate/plugins/wordcompletion/docwordcompletion.cpp
--- kdelibs.orig/kate/plugins/wordcompletion/docwordcompletion.cpp	Fri Aug  6 19:04:44 2004
+++ kdelibs/kate/plugins/wordcompletion/docwordcompletion.cpp	Tue Nov  9 11:28:57 2004
@@ -223,7 +223,7 @@
   KTextEditor::EditInterface *ei = KTextEditor::editInterface( m_view->document() );
   // find the word we are typing
   uint cline, ccol;
-  viewCursorInterface( m_view )->cursorPosition( &cline, &ccol );
+  viewCursorInterface( m_view )->cursorPositionReal( &cline, &ccol );
   QString wrd = word();
   if ( wrd.isEmpty() ) return;
 
diff -urN -x CVS kdelibs.orig/kate/plugins/wordcompletion/ktexteditor_docwordcompletion.desktop kdelibs/kate/plugins/wordcompletion/ktexteditor_docwordcompletion.desktop
--- kdelibs.orig/kate/plugins/wordcompletion/ktexteditor_docwordcompletion.desktop	Sun Sep 12 15:55:50 2004
+++ kdelibs/kate/plugins/wordcompletion/ktexteditor_docwordcompletion.desktop	Fri Nov 12 08:27:49 2004
@@ -1,6 +1,7 @@
 [Desktop Entry]
 Encoding=UTF-8
 Name=KTextEditor Word Completion Plugin
+Name[af]=KTextEditor Woord Voltooiïng Inprop Module
 Name[bn]=কে-টেক্সট-এডিটর শব্দ পরিপূরণ প্লাগ-ইন
 Name[bs]=KTextEditor dodatak za dovršavanje riječi
 Name[ca]=Endollable de completar paraules del KTextEditor
@@ -10,6 +11,7 @@
 Name[eo]=KTextEditor Vortotutiga kromaĵo
 Name[es]=Plugin de completado de palabras de KTextEditor
 Name[et]=KTextEditori sõna lõpetamise plugin
+Name[eu]=KTextEditor hitz osatze plugina
 Name[fi]=KTextEditorin sanojen täydennyslaajennus
 Name[fr]=Module externe de complètement des mots de KTextEditor
 Name[he]=תוסף השלמה אוטומטית של מילים עבור KTextEditor
@@ -19,7 +21,10 @@
 Name[it]=Plugin completamento parole di KTextEditor
 Name[ja]=KTextEditor単語補完プラグイン
 Name[ko]=K글월편집기 낱말 완성 플러그인
+Name[lt]=KTextEditor žodžio užbaigimo priedas
+Name[mk]=KTextEditor приклучок за довршување на зборови
 Name[nb]=Programtillegg for ordfullføring i KTextEditor
+Name[nds]=KTextEditor-Plugin för dat Kumpletteren vun Wöör
 Name[nl]=KTextEditor-plugin voor het aanvullen van woorden
 Name[nn]=Programtillegg for ordfullføring i KTextEditor
 Name[pa]=KTextEditor ਪਾਠ ਪੂਰਨ ਪਲੱਗਇਨ
@@ -30,13 +35,14 @@
 Name[ru]=Модуль автодополнения слов KTextEditor
 Name[sk]=Modul pre doplnenie slov pre KTextEditor
 Name[sr]=KTextEditor прикључак за довршаванје речи
-Name[sr@Latn]=KTextEditor прикључак за довршаванје речи
+Name[sr@Latn]=KTextEditor priključak za dovršavanje reči
 Name[sv]=Ktexteditor-insticksprogram för att komplettera ord
 Name[ta]=கேஉரைதொகுப்பாளர் கோப்பு உள்ளீட்டுச் சொருகுப்பொருள்
 Name[tg]=Мутассалкунандаи файли вуруди KTextEditor
 Name[uk]=Втулок KTextEditor для завершення слів
 Name[zh_CN]=KTextEditor 单词补全插件
 Comment=Directional or popup-based completion from words in the document
+Comment[af]=Direksionele of opspring gebaseerde woord voltooiïng van woorde in die dokument
 Comment[bg]=Автоматично завършване на думи, базирано на използваните вече думи в документа
 Comment[bn]=ডকুমেন্ট-এর অন্যান্য শব্দের উপর ভিত্তি করে পরিপূরণ
 Comment[bs]=Direkcionalno ili popup-bazirano dovršavanje za riječi u dokumentu
@@ -54,7 +60,9 @@
 Comment[is]=Áttvíst forrit sem getur líka opnað glugga með orðatillögum
 Comment[it]=Completamento direzionale o con finestre a comparsa di parole nel documento
 Comment[ja]=ドキュメントで単語から指向性またはポップアップベース補完をします
+Comment[lt]=Žodžių pabaigimas rašant dokumente pasiūlymus teikiant eilutėje arba iššokančiame meniu
 Comment[nb]=Retningsbestemt eller sprettopp-basert fullføring av ord i dokumentet
+Comment[nds]=Richten- oder Popup-baseert Kumpletteren vun Wöör binnen dat Dokment
 Comment[nl]=Voor het aanvullen van woorden in het document door middel van onder meer pop-ups
 Comment[nn]=Retningsbestemt eller sprettopp-basert fullføring av ord i dokumentet
 Comment[pa]=ਦਸਤਾਵੇਜ਼ ਵਿੱਚ ਦਿਸ਼ਾਵੀ ਜਾਂ ਪੋਪਅੱਪ ਆਧਾਰਿਤ ਸ਼ਬਦ ਪੂਰਨ
@@ -62,9 +70,10 @@
 Comment[pt]=Completação direccional ou por lista de palavras no documento
 Comment[pt_BR]=Complementação direcional, ou baseada em popup, de palavras do documento
 Comment[ro]=Propune completarea cuvintelor din document dintr-o listă popup sau direcţională
+Comment[ru]=Автозавершение слов в документе (линейное или в виде выпадающего поля)
 Comment[sk]=Dopĺňanie slov v dokumente priame alebo pomocou dialógu
 Comment[sr]=Директна или искачућа допуна од речи у документу
-Comment[sr@Latn]=Директна или искачућа допуна од речи у документу
+Comment[sr@Latn]=Direktna ili iskačuća dopuna od reči u dokumentu
 Comment[sv]=Komplettering av ord i dokumentet baserad på ordlista eller dialogruta
 Comment[ta]=ஆவணத்திலுள்ள வார்த்தைகளிலிருந்து திசைகள் அல்லது மேல்விரி-சார்ந்த நிறைவு 
 Comment[tg]=Моқабл ё мобаъди ҷамъи аз калимаҳо дар санадот
diff -urN -x CVS kdelibs.orig/kcert/kcertpart.desktop kdelibs/kcert/kcertpart.desktop
--- kdelibs.orig/kcert/kcertpart.desktop	Tue Aug 31 09:21:11 2004
+++ kdelibs/kcert/kcertpart.desktop	Mon Nov 15 08:54:56 2004
@@ -29,14 +29,16 @@
 Comment[hu]=Beágyazható személyes tanúsítványkezelő
 Comment[is]=Ívefjanlegur einka-skírteina-stjóri
 Comment[it]=Gestione integrabile dei certificati personali
-Comment[ja]=埋め込み可能パーソナル証明書マネージャ
+Comment[ja]=埋め込み可能個人証明書マネージャ
 Comment[ko]=끼워넣는 개인용 인증서 관리
 Comment[lt]=Įdedama asmeninių sertifikatų tvarkyklė
 Comment[lv]=Iegulstams Personālo Sertifikātu Menedžers
+Comment[mk]=Вгнездлив менаџер на лични сертификати
 Comment[mn]=Суулгах боломж бүхий хувийн үнэмлэхийн зохион байгуулагч
 Comment[ms]=Pengurus Sijil Peribadi Boleh Serta
 Comment[mt]=Maniġer ta' ċertifikati personali integrat
 Comment[nb]=Innebyggbar personlig sertifikathåndterer
+Comment[nds]=Inbettbor Pleger för persöönliche Zertifikaten
 Comment[nl]=Ingebedde Persoonlijke Certificaat-beheerder
 Comment[nn]=Innebyggbar handsaming av personlege sertifikat
 Comment[nso]=Molaodi yo a Robatsegago wa Kgonthisiso ya Botho
@@ -51,7 +53,7 @@
 Comment[sl]=Vgradljivi osebni upravljalnik certifikatov
 Comment[sq]=Menagjer për diplomë personale
 Comment[sr]=Уградиви менаџер личних сертификата
-Comment[sr@Latn]=Ugradivi menadžer ličnih sertifikata.
+Comment[sr@Latn]=Ugradivi menadžer ličnih sertifikata
 Comment[ss]=Siphatsi sesithifikethi samuntfu sicu lesinamatselekako
 Comment[sv]=Inbäddningsbar personlig certifikatshanterare
 Comment[ta]=உட்பொதிந்த சொந்தச் சான்றிதழ் மேலாளர்
diff -urN -x CVS kdelibs.orig/kde.pot kdelibs/kde.pot
--- kdelibs.orig/kde.pot	Sun Oct  3 09:41:12 2004
+++ kdelibs/kde.pot	Thu Oct 28 00:29:10 2004
@@ -6,12 +6,12 @@
 msgid ""
 msgstr ""
 "Project-Id-Version: PACKAGE VERSION\n"
-"POT-Creation-Date: 2004-10-03 09:40+0200\n"
+"POT-Creation-Date: 2004-10-05 09:42+0200\n"
 "PO-Revision-Date: YEAR-MO-DA HO:MI+ZONE\n"
 "Last-Translator: FULL NAME <EMAIL@ADDRESS>\n"
 "Language-Team: LANGUAGE <LL@li.org>\n"
 "MIME-Version: 1.0\n"
-"Content-Type: text/plain; charset=CHARSET\n"
+"Content-Type: text/plain; charset=UTF-8\n"
 "Content-Transfer-Encoding: ENCODING\n"
 
 #: common_texts.cpp:24
diff -urN -x CVS kdelibs.orig/kdecore/README.kiosk kdelibs/kdecore/README.kiosk
--- kdelibs.orig/kdecore/README.kiosk	Fri Jul  9 17:36:42 2004
+++ kdelibs/kdecore/README.kiosk	Wed Oct  6 13:55:04 2004
@@ -558,6 +558,26 @@
 data_konsole=false
 
 
+Control module restrictions
+===========================
+
+It is possible to restrict access to particular control modules.
+Although it is possible to remove control modules from the Control
+Center by editing the menu structure, such modules will then still
+be available to applications. A better way is to use the control
+module restrictions offered by KIOSK:
+
+[KDE Control Module Restrictions][$i]
+<menu-id>=false
+
+Some example menu-ids are:
+
+kde-display.desktop
+kde-proxy.desktop
+kde-screensaver.desktop
+
+See also kcmshell --list for a list of all the base names.
+
 Expansion of environment variables in KDE config files.
 =======================================================
 
diff -urN -x CVS kdelibs.orig/kdecore/all_languages.desktop kdelibs/kdecore/all_languages.desktop
--- kdelibs.orig/kdecore/all_languages.desktop	Sat Sep 25 15:40:39 2004
+++ kdelibs/kdecore/all_languages.desktop	Sun Nov 28 09:33:02 2004
@@ -12,6 +12,7 @@
 Name[ja]=アファル語
 Name[ko]=아파르어
 Name[lt]=Afarų
+Name[mk]=Афар
 Name[mn]=Афар
 Name[nds]=Afaarsch
 Name[nso]=Kgolekgole
@@ -50,6 +51,7 @@
 Name[fa]=آبخازیان
 Name[fi]=Abhaasi
 Name[fr]=Abkhaze
+Name[ga]=Abcáisis
 Name[he]=אבחזית
 Name[hi]=अबकाजियन
 Name[hr]=Abhazijski
@@ -58,6 +60,7 @@
 Name[ja]=アブハーズ語
 Name[ko]=아브하지아어
 Name[lt]=Abhazų
+Name[mk]=Абхаски
 Name[mn]=Абкааз
 Name[ms]=Abkhazia
 Name[nb]=Abkhasisk
@@ -172,6 +175,7 @@
 Name[ja]=アルバニア語
 Name[ko]=알바니아어
 Name[lt]=Albanų
+Name[mk]=Албански
 Name[mn]=Албани
 Name[ms]=Albania
 Name[nb]=Albansk
@@ -227,6 +231,7 @@
 Name[ja]=アムハラ語
 Name[ko]=암하라어
 Name[lt]=Amhari
+Name[mk]=Амхарски
 Name[mn]=Амхар
 Name[nb]=Amharisk
 Name[nds]=Amhaarsch
@@ -256,7 +261,7 @@
 Name[zu]=isi-Amharic
 [ar]
 Name=Arabic
-Name[af]=Arabiese
+Name[af]=Arabies
 Name[ar]=العربية
 Name[az]=Ərabcə
 Name[be]=Арабская
@@ -329,7 +334,7 @@
 Name[zu]=Isi-Arabhu
 [hy]
 Name=Armenian
-Name[af]=Armeense
+Name[af]=Armeens
 Name[ar]=أرمني
 Name[az]=Ermənicə
 Name[be]=Армянская
@@ -362,6 +367,7 @@
 Name[ja]=アルメニア語
 Name[ko]=아르메니아어
 Name[lt]=Armėnų
+Name[mk]=Ерменски
 Name[mn]=Армен
 Name[ms]=Armenia
 Name[nb]=Armensk
@@ -408,6 +414,7 @@
 Name[fa]=آسامی
 Name[fi]=Assami
 Name[fr]=Assamais
+Name[ga]=Asamais
 Name[he]=אסמית
 Name[hi]=असमी
 Name[hr]=Asamski
@@ -415,6 +422,7 @@
 Name[ja]=アッサム語
 Name[ko]=아삼어
 Name[lt]=Asamesų
+Name[mk]=Асамески
 Name[mn]=Ассаме
 Name[nb]=Assamesisk
 Name[nds]=Assameessch
@@ -461,7 +469,9 @@
 Name[it]=Avestano
 Name[ja]=アヴェスター語
 Name[ko]=아베스탄어
+Name[mk]=Авестан
 Name[mn]=Авестан
+Name[nds]=Avesta
 Name[nn]=Avestisk
 Name[nso]=Se-Avestan
 Name[pa]=ਅਵਸਟਅਨ
@@ -501,6 +511,7 @@
 Name[hu]=ajmara
 Name[ja]=アイマラ語
 Name[ko]=아이마라어
+Name[mk]=Ајмара
 Name[mn]=Аямара
 Name[nso]=Se-Aymara
 Name[pa]=ਅਯਮਾਰਾ
@@ -554,6 +565,7 @@
 Name[ko]=아제르바이잔어
 Name[lt]=Azerbaidžaniečių
 Name[lv]=Azerbaidžāņu
+Name[mk]=Азербејџански
 Name[mn]=Азербажайн
 Name[ms]=Azerbaijan
 Name[mt]=Ażerbajġani
@@ -603,6 +615,7 @@
 Name[fa]=بشکیر
 Name[fi]=Baškiiri
 Name[fr]=Bachkir
+Name[ga]=Baisciris
 Name[gl]=Bashquir
 Name[he]=בשקירית
 Name[hi]=बाशकिर
@@ -611,6 +624,7 @@
 Name[ja]=バシキール語
 Name[ko]=바시킬어
 Name[lt]=Baškirų
+Name[mk]=Башкир
 Name[mn]=Башкир
 Name[nds]=Baschkiirsch
 Name[nn]=Basjkirsk
@@ -735,11 +749,12 @@
 Name[ko]=백러시아어
 Name[lt]=Baltarusių
 Name[lv]=Baltkrievu
+Name[mk]=Белоруски
 Name[mn]=Беларусс
 Name[ms]=Belarusia
 Name[mt]=Bjelorussu
 Name[nb]=Hviterussisk
-Name[nds]=Wittrussch
+Name[nds]=Wittruss'sch
 Name[nl]=Wit-Rusland
 Name[nn]=Kviterussisk
 Name[nso]=Se-Belarusian
@@ -793,6 +808,7 @@
 Name[ja]=ベンガル語
 Name[ko]=벵갈어
 Name[lt]=Bengalų
+Name[mk]=Бенгалски
 Name[mn]=Бенгали
 Name[nds]=Bengalsch
 Name[nso]=Se-Bengali
@@ -830,6 +846,7 @@
 Name[hu]=bihari
 Name[ja]=ビハール語
 Name[ko]=비하르어
+Name[mk]=Бихари
 Name[mn]=Бихари
 Name[nso]=Se-Bihari
 Name[pa]=ਬਿਹਾਰੀ
@@ -862,6 +879,7 @@
 Name[hu]=biszlama
 Name[ja]=ビスラマ語
 Name[ko]=비슬라마어
+Name[mk]=Бислама
 Name[mn]=Бислам
 Name[nso]=Se-Bislama
 Name[pa]=ਬਿਸਲਾਮਾ
@@ -881,7 +899,7 @@
 Name[zu]=Isi-Bislama
 [bs]
 Name=Bosnian
-Name[af]=Bosnise
+Name[af]=Bosnies
 Name[ar]=البوسنية
 Name[az]=Bosnakca
 Name[be]=Басьнійская
@@ -915,6 +933,7 @@
 Name[ko]=보스니아어
 Name[lt]=Bosnių
 Name[lv]=Bosniešu
+Name[mk]=Босански
 Name[mn]=Босни
 Name[ms]=Bosnia
 Name[mt]=Bożniaku
@@ -1116,6 +1135,7 @@
 Name[ja]=ビルマ語
 Name[ko]=버마어
 Name[lt]=Birmiečių
+Name[mk]=Бурмански
 Name[mn]=Бүрм
 Name[ms]=Burma
 Name[nb]=Burmesisk
@@ -1178,7 +1198,7 @@
 Name[lt]=Katalonų
 Name[lv]=Katalāņu
 Name[mi]=Reo Peina Raki Räwhiti
-Name[mk]=Каталански
+Name[mk]=Каталонски
 Name[mn]=Каталан
 Name[mt]=Katalan
 Name[nb]=Katalansk
@@ -1227,6 +1247,7 @@
 Name[hu]=chamorro
 Name[is]=Chamorró
 Name[ja]=チャモロ語
+Name[mk]=Чаморо
 Name[mn]=Чаморро
 Name[nso]=Se-Chamorro
 Name[pa]=ਚਾਮੂਰੂ
@@ -1274,6 +1295,7 @@
 Name[ja]=チェチェン語
 Name[ko]=체첸어
 Name[lt]=Čėčėnų
+Name[mk]=Чеченски
 Name[mn]=Чечен
 Name[nb]=Tsjetsjensk
 Name[nds]=Tschetscheensch
@@ -1406,9 +1428,10 @@
 Name[ja]=教会スラヴ語
 Name[ko]=교회 슬라브어
 Name[lt]=Bažnytinė slavų
+Name[mk]=Црковнословенски
 Name[mn]=Чүрч славик
 Name[nb]=Kirkeslavisk
-Name[nds]=Slaavsch as vun de Kark
+Name[nds]=Slaavsch (as vun de Kark)
 Name[nl]=Kerk Slavisch
 Name[nn]=Kyrkjeslavisk
 Name[nso]=Se-Church Slavic
@@ -1457,6 +1480,7 @@
 Name[ja]=チュヴァシ語
 Name[ko]=추바시어
 Name[lt]=Čiuvašų
+Name[mk]=Чуваш
 Name[mn]=Чуваш
 Name[nds]=Tschuvassch
 Name[nso]=Se-Chuvash
@@ -1508,9 +1532,10 @@
 Name[ja]=コーンウォール語
 Name[ko]=콘월어
 Name[lt]=Kornų
+Name[mk]=Корниш
 Name[mn]=Корни
 Name[nb]=Cornisk
-Name[nds]=Kornish
+Name[nds]=Kornisch
 Name[nn]=Kornisk
 Name[nso]=Se-Cornish
 Name[pa]=ਕੋਰਨਿਸ਼
@@ -1566,6 +1591,7 @@
 Name[it]=Corso
 Name[ja]=コルシカ方言
 Name[lt]=Korsikiečių
+Name[mk]=Корзикански
 Name[mn]=Корсикан
 Name[nb]=Korsikansk
 Name[nds]=Korssch
@@ -1809,6 +1835,7 @@
 Name[zu]=Isi-Danishi
 [dz]
 Name=Dzongkha
+Name[ar]=الجونغا
 Name[az]=Dzunqxaca
 Name[bg]=Джонга
 Name[bn]=জঙখা
@@ -1820,6 +1847,7 @@
 Name[hu]=dzongkha
 Name[ja]=ゾンカ語
 Name[ko]=부탄어
+Name[mk]=Џонгха
 Name[mn]=Жонгха
 Name[nso]=Se-Dzongkha
 Name[pa]=ਡਜ਼ੋਨਗਖਾ
@@ -1875,12 +1903,12 @@
 Name[lt]=Anglų
 Name[lv]=Angļu
 Name[mi]=Reo Päkehä
-Name[mk]=Англиска
+Name[mk]=Англиски
 Name[mn]=Англи
 Name[ms]=Inggeris
 Name[mt]=Ingliż
 Name[nb]=Engelsk
-Name[nds]=Ingelsch
+Name[nds]=Engelsch
 Name[nl]=Engels
 Name[nn]=Engelsk
 Name[nso]=Sekgowa
@@ -1987,7 +2015,7 @@
 Name[ms]=Estonia
 Name[mt]=Estonjan
 Name[nb]=Estisk
-Name[nds]=Estnisch
+Name[nds]=Estnsch
 Name[nl]=Ests
 Name[nn]=Estisk
 Name[nso]=Se-Estonian
@@ -2044,6 +2072,7 @@
 Name[is]=Færeyska
 Name[ja]=フェロー語
 Name[lt]=Farerų
+Name[mk]=Фарски
 Name[mn]=Фаро
 Name[nb]=Færøyisk
 Name[nds]=Faröösch
@@ -2099,6 +2128,7 @@
 Name[ja]=フィジー語
 Name[ko]=피지어
 Name[lt]=Fidži
+Name[mk]=Фиџиски
 Name[mn]=Фижи
 Name[nb]=Fijisk
 Name[nds]=Fidschi
@@ -2273,6 +2303,7 @@
 Name[zu]=Isi-Frentshi
 [fy]
 Name=Frisian
+Name[ar]=الفريزية
 Name[az]=Friscə
 Name[be]=Фрызская
 Name[bg]=Фарси
@@ -2300,6 +2331,7 @@
 Name[ja]=フリースランド語
 Name[ko]=프리시안어
 Name[lt]=Fryzų
+Name[mk]=Фризиски
 Name[mn]=Фрис
 Name[ms]=Frisia
 Name[nb]=Frisisk
@@ -2360,6 +2392,7 @@
 Name[ja]=グルジア語
 Name[ko]=그루지안어
 Name[lt]=Gruzinų
+Name[mk]=Грузиски
 Name[mn]=Георги
 Name[ms]=Georgia
 Name[nb]=Georgisk
@@ -2495,6 +2528,7 @@
 Name[it]=Gaelico
 Name[ja]=ゲール語
 Name[lt]=Galų
+Name[mk]=Галски
 Name[mn]=Гаели
 Name[nb]=Gælisk
 Name[nds]=Gäälsch
@@ -2525,7 +2559,7 @@
 Name[zu]=Isi-Gayelikhi
 [ga]
 Name=Irish
-Name[af]=Ierse
+Name[af]=Iers
 Name[ar]=الأيرلندية
 Name[az]=İrlandca
 Name[be]=Ірляндзкая
@@ -2564,7 +2598,7 @@
 Name[mn]=Эра
 Name[mt]=Irlandiż
 Name[nb]=Irsk
-Name[nds]=Iersch
+Name[nds]=Irsch
 Name[nl]=Iers
 Name[nn]=Irsk
 Name[nso]=Se-Irish
@@ -2596,6 +2630,7 @@
 Name[zu]=Isi-Irishi
 [gl]
 Name=Gallegan
+Name[ar]=الغاليغية
 Name[az]=Qalleqanca
 Name[bg]=Галедански
 Name[bn]=গালিগান
@@ -2619,6 +2654,7 @@
 Name[it]=Gallego
 Name[ja]=ガリシア語
 Name[ko]=갈라시아어
+Name[mk]=Галеган
 Name[mn]=Галлеган
 Name[nb]=Galisisk
 Name[nn]=Galisisk
@@ -2664,6 +2700,7 @@
 Name[it]=Man, lingua dell'isola di
 Name[ja]=マン島語
 Name[ko]=망스어
+Name[mk]=Манкс
 Name[mn]=Манкс
 Name[nso]=Se-Manx
 Name[pa]=ਮਾਲਸ
@@ -2776,6 +2813,7 @@
 Name[hu]=guarani
 Name[ja]=グアラニー語
 Name[ko]=과라니어
+Name[mk]=Гоарани
 Name[mn]=Гуарани
 Name[nso]=Se-Guarani
 Name[pa]=ਗੁਜਰਾਨੀ
@@ -2805,6 +2843,7 @@
 Name[eo]= Guĝarata
 Name[eu]=Gujeratiera
 Name[fa]=گوراجاتی
+Name[ga]=Gúisearáitis
 Name[gl]=Guxarati
 Name[he]=גוג'רטית
 Name[hi]=गुजराती
@@ -2813,6 +2852,8 @@
 Name[id]=Gujarat
 Name[ja]=グジャラート語
 Name[ko]=구자라트어
+Name[lt]=Gudžarati
+Name[mk]=Гујарати
 Name[mn]=Гуярати
 Name[nds]=Gudscharati
 Name[nso]=Se-Gujarati
@@ -2834,6 +2875,7 @@
 Name[zu]=Isi-Gujarati
 [ha]
 Name=Hausa
+Name[ar]=الهاوسا
 Name[bg]=Хауса
 Name[bn]=হাউসা
 Name[de]=Haussa-Sprache
@@ -2845,6 +2887,7 @@
 Name[hu]=hausa
 Name[ja]=ハウサ語
 Name[ko]=하우사어
+Name[mk]=Хауса
 Name[mn]=Хауса
 Name[nso]=Se-Hausa
 Name[pa]=ਹਾਉਸਾ
@@ -2864,7 +2907,7 @@
 Name[zu]=Isi-Hausa
 [he]
 Name=Hebrew
-Name[af]=Hibreüse
+Name[af]=Hibreüs
 Name[ar]=العبرية
 Name[az]=Yəhudicə
 Name[be]=Іўрыт
@@ -2936,6 +2979,7 @@
 Name[zu]=Isi-Hebheru
 [hz]
 Name=Herero
+Name[ar]=الهيريرو
 Name[bg]=Хереро
 Name[bn]=হেরেরো
 Name[cy]=Hausa
@@ -2947,6 +2991,7 @@
 Name[hu]=hereró
 Name[ja]=ヘレロ語
 Name[ko]=헤레로어
+Name[mk]=Хереро
 Name[mn]=Хереро
 Name[nso]=Se-Herero
 Name[pa]=ਹੀਰੀਰੋ
@@ -2983,6 +3028,7 @@
 Name[hu]=hindi
 Name[ja]=ヒンディー語
 Name[ko]=힌디어
+Name[mk]=Хинди
 Name[mn]=Хинди
 Name[nso]=Se-Hindi
 Name[pa]=ਹਿੰਦੀ
@@ -3005,6 +3051,7 @@
 Name[zu]=Isi-Hindi
 [ho]
 Name=Hiri Motu
+Name[ar]=الهيري-موتو
 Name[bg]=Хири Мото
 Name[bn]=হিরি মোটু
 Name[de]=Hiri-Motu
@@ -3019,6 +3066,7 @@
 Name[it]=Hiri motu
 Name[ja]=モツ語
 Name[ko]=히리 모투어
+Name[mk]=Хири Моту
 Name[mn]=Хири Моту
 Name[nn]=Hiri motu
 Name[nso]=Se-Hiri Motu
@@ -3037,9 +3085,33 @@
 Name[zh_CN]=新里木托语
 Name[zh_TW]=Hiri Motu語
 Name[zu]=Isi-Hiri Motu
+[hsb]
+Name=Upper Sorbian
+Name[bs]=Gornji lužičkosrpski
+Name[ca]=Alt sòrab
+Name[cs]=Hornolužicko srbský
+Name[cy]=Sorbieg Uchaf
+Name[da]=Øvresorbisk
+Name[es]=Sorbio alto
+Name[et]=Ülemsorbi
+Name[fr]=Haut Sorabe
+Name[ga]=Sorbais Uachtarach
+Name[hu]=felső szorb
+Name[it]=Alto sorbian
+Name[ja]=ソルブ語
+Name[nb]=Øvresorbisk
+Name[nds]=Böversorbsch
+Name[nl]=Opper Sorbian
+Name[nn]=Øvresorbisk
+Name[pl]=Górnołużycki
+Name[pt]=Sérvio de Cima
+Name[pt_BR]=Sérvio
+Name[ro]=Sîrbă de Sus
+Name[sv]=Högsorbiska
+Name[uk]=Верхньо-лужицька
 [hu]
 Name=Hungarian
-Name[af]=Hongaarse
+Name[af]=Hongaars
 Name[ar]=الهنغارية (المجرية)
 Name[az]=Macarca
 Name[be]=Вугорская
@@ -3111,7 +3183,7 @@
 Name[zu]=Isi-Hangariyani
 [is]
 Name=Icelandic
-Name[af]=Yslandiese
+Name[af]=Yslandies
 Name[ar]=الآيسلندية
 Name[az]=İslandiyaca
 Name[be]=Ісьляндзкая
@@ -3150,7 +3222,7 @@
 Name[mn]=Исланд
 Name[mt]=Islandiż
 Name[nb]=Islandsk
-Name[nds]=Ieslandsch
+Name[nds]=Islandsch
 Name[nl]=IJslands
 Name[nn]=Islandsk
 Name[nso]=Se-Icelandic
@@ -3182,6 +3254,7 @@
 Name[zu]=isi-Icelandic
 [io]
 Name=Ido
+Name[ar]=الإيدو
 Name[bg]=Идо
 Name[bn]=ইডো
 Name[fa]=ایدو
@@ -3191,6 +3264,7 @@
 Name[hu]=ido
 Name[ja]=イド語
 Name[ko]=이도어
+Name[mk]=Идо
 Name[mn]=Идо
 Name[nso]=Se-Ido
 Name[pa]=ਆਈਡੋ
@@ -3210,6 +3284,7 @@
 Name[zu]=Isi-Ido
 [iu]
 Name=Inuktitut
+Name[ar]=الإنكتيتوت
 Name[be]=Эскімоская
 Name[bg]=Иниктитут
 Name[bn]=ইনাক্টিটুট
@@ -3220,6 +3295,7 @@
 Name[hr]=Inuktitutski
 Name[hu]=inuktitut
 Name[ja]=イヌイト語
+Name[mk]=Инуктитут
 Name[mn]=Инуктитут
 Name[nn]=Inuittisk
 Name[nso]=Se-Inuktitut
@@ -3240,6 +3316,7 @@
 Name[zu]=Isi-Inuktitut
 [ie]
 Name=Interlingue
+Name[ar]=الإنترلينغوي
 Name[bg]=Интерлингуе
 Name[bn]=ইন্টারলিং
 Name[de]=Interlingua
@@ -3252,6 +3329,7 @@
 Name[hu]=interlingue
 Name[ja]=インターリング
 Name[ko]=국제어 (Interlingue)
+Name[mk]=Интерлингва
 Name[mn]=Интерлингуе
 Name[nso]=Se-Interlingue
 Name[pa]=ਇੰਟਰਈਨੂਗੂਈ
@@ -3270,6 +3348,7 @@
 Name[zu]=Izilimi ezifanayo
 [ia]
 Name=Interlingua
+Name[ar]=الإنترلينغوا
 Name[az]=İnterlinqua
 Name[bg]=Интерлингуа
 Name[bn]=ইন্টারলিঙ্গুয়া
@@ -3281,6 +3360,7 @@
 Name[hu]=interlingua
 Name[ja]=インターリングア
 Name[ko]=국제어 (Interlingua)
+Name[mk]=Интерлингва
 Name[mn]=Интерлингуа
 Name[nso]=Se-Interlingua
 Name[pa]=ਇੰਟਰਲੀਗੂਆ
@@ -3335,6 +3415,7 @@
 Name[ko]=인도네시아어
 Name[lt]=Indoneziečių
 Name[lv]=Indonēziešu
+Name[mk]=Индонезиски
 Name[mn]=Индонези
 Name[ms]=Indonesia
 Name[mt]=Indoneżjan
@@ -3369,6 +3450,7 @@
 Name[zu]=Indoneshiya
 [ik]
 Name=Inupiaq
+Name[ar]=الإنوبياك
 Name[az]=İnupiaqca
 Name[bg]=Инупия
 Name[bn]=ইনুপিয়াক
@@ -3382,6 +3464,7 @@
 Name[hu]=inupiak
 Name[it]=Inupiak
 Name[ja]=イヌピアク語
+Name[mk]=Инупиак
 Name[mn]=Инупиак
 Name[nn]=Inupiak
 Name[nso]=Se-Inupiaq
@@ -3404,7 +3487,7 @@
 Name[zu]=Isi-Inupiaq
 [it]
 Name=Italian
-Name[af]=Italiaanse
+Name[af]=Italiaans
 Name[ar]=الإيطالية
 Name[az]=İtalyanca
 Name[be]=Італьянская
@@ -3476,6 +3559,7 @@
 Name[zu]=Isi-Ntaliyane
 [jv]
 Name=Javanese
+Name[af]=Javanees
 Name[ar]=جاويه
 Name[az]=Yavonca
 Name[be]=Японская
@@ -3503,6 +3587,7 @@
 Name[ja]=ジャワ語
 Name[ko]=자바어
 Name[lt]=Javiečių
+Name[mk]=Јавански
 Name[mn]=Явон
 Name[ms]=Jawa
 Name[nb]=Javanesisk
@@ -3534,6 +3619,7 @@
 Name[zu]=Isi-Javanisi
 [ja]
 Name=Japanese
+Name[af]=Japanees
 Name[ar]=اليابانية
 Name[az]=Yaponca
 Name[be]=Японская
@@ -3607,6 +3693,7 @@
 Name[zu]=Isi-Jaliphani
 [kl]
 Name=Kalaallisut
+Name[ar]=الكالاليسوت
 Name[az]=Kalaallisutca
 Name[be]=Эскімоская
 Name[bg]=Калисути
@@ -3618,6 +3705,7 @@
 Name[hr]=Kalalisutski
 Name[hu]=kalaalliszut
 Name[ko]=그린란드어
+Name[mk]=Калалисут
 Name[mn]=Калааллисут
 Name[nn]=Grønlandsk
 Name[nso]=Se-Kalaallisut
@@ -3640,16 +3728,20 @@
 Name[zu]=Isi-Kalaallisut
 [kn]
 Name=Kannada
+Name[af]=Kanadees
+Name[ar]=الكانادا
 Name[az]=Kannadaca
 Name[be]=Каннада
 Name[bg]=Каннада
 Name[bn]=কন্নাডা
 Name[br]=Kanada
 Name[fa]=کانادا
+Name[ga]=Cannadais
 Name[he]=קנאדה
 Name[hi]=कन्नड़
 Name[hu]=kannada
 Name[ja]=カナラ語
+Name[mk]=Канада
 Name[mn]=Канад
 Name[nso]=Se-Kannada
 Name[pa]=ਕਾਨਡਾ
@@ -3693,8 +3785,9 @@
 Name[ja]=カシミール語
 Name[ko]=카슈미르어
 Name[lt]=Kašmiro
+Name[mk]=Кашмирски
 Name[mn]=Кашмири
-Name[nds]=Kashmiirsch
+Name[nds]=Kaschmiirsch
 Name[nn]=Kasjmiri
 Name[nso]=Se-Kashmiri
 Name[pa]=ਕਸ਼ਮੀਰੀ
@@ -3734,6 +3827,7 @@
 Name[et]=Kasahhi
 Name[fa]=قزاق
 Name[fi]=Kazakki
+Name[ga]=Casacais
 Name[he]=קזחית
 Name[hi]=कज़ाख
 Name[hr]=Kazački
@@ -3742,6 +3836,7 @@
 Name[ja]=カザフ語
 Name[ko]=카자크어
 Name[lt]=Kazachų
+Name[mk]=Казахстански
 Name[mn]=Казак
 Name[nds]=Kasachsch
 Name[nn]=Kasakhisk
@@ -3786,6 +3881,7 @@
 Name[ja]=クメール語
 Name[ko]=캄보디아어
 Name[lt]=Khmerų
+Name[mk]=Кмерски
 Name[mn]=Хмер
 Name[nso]=Se-Khmer
 Name[pa]=ਖਮੀਰ
@@ -3810,6 +3906,7 @@
 Name[zu]=Isi-Khmer
 [ki]
 Name=Kikuyu
+Name[ar]=الكيكويو
 Name[az]=Kikuyuca
 Name[bg]=Кикю
 Name[bn]=কিকুয়ু
@@ -3823,6 +3920,7 @@
 Name[hu]=kikuju
 Name[ja]=キクーユ語
 Name[ko]=키쿠유어
+Name[mk]=Кикују
 Name[mn]=Кикуюу
 Name[nso]=Se-Kikuyu
 Name[pa]=ਕਿਕੂਯੂ
@@ -3842,6 +3940,7 @@
 Name[zu]=Isi-Kikuyu
 [rw]
 Name=Kinyarwanda
+Name[ar]=الكينارواندا
 Name[az]=Kinyarvandaca
 Name[bg]=Кинарванда
 Name[bn]=কিন্যারওয়াণ্ডা
@@ -3854,6 +3953,7 @@
 Name[hu]=kinjarvanda
 Name[ja]=キヌヤルワンダ語
 Name[ko]=키냐르완다어
+Name[mk]=Кинјарванда
 Name[mn]=Кинярванда
 Name[nso]=Se-Kinyarwanda
 Name[pa]=ਕਿਨਯਾਰਵਾਡਾਂ
@@ -3900,6 +4000,7 @@
 Name[ja]=キルギス語
 Name[ko]=키르키즈어
 Name[lt]=Kirgizų
+Name[mk]=Киргизтански
 Name[mn]=Киргиз
 Name[nb]=Kirgisisk
 Name[nds]=Kirgiissch
@@ -3930,6 +4031,7 @@
 Name[zu]=Isi-Kirghizi
 [kv]
 Name=Komi
+Name[ar]=الكومي
 Name[az]=Komicə
 Name[be]=Комі
 Name[bg]=Коми
@@ -3943,6 +4045,7 @@
 Name[hu]=komi
 Name[ja]=コミ語
 Name[ko]=코미어
+Name[mk]=Коми
 Name[mn]=Коми
 Name[nso]=Se-Komi
 Name[pa]=ਕੋਮੀ
@@ -4067,6 +4170,7 @@
 Name[ko]=쿠르드어
 Name[lt]=Kurdų
 Name[lv]=Kurdu
+Name[mk]=Курдски
 Name[mn]=Күрд
 Name[mt]=Kurd
 Name[nb]=Kurdisk
@@ -4116,6 +4220,7 @@
 Name[ja]=ラオ語
 Name[ko]=라오어
 Name[lt]=Laosiečių
+Name[mk]=Лао
 Name[mn]=Лао
 Name[nds]=Laootsch
 Name[nso]=Se-Lao
@@ -4169,6 +4274,7 @@
 Name[ja]=ラテン語
 Name[ko]=라틴어
 Name[lt]=Lotynų
+Name[mk]=Латински
 Name[mn]=Латин
 Name[nds]=Latiensch
 Name[nl]=Latijn
@@ -4229,6 +4335,7 @@
 Name[ko]=라트비아어
 Name[lt]=Latvių
 Name[lv]=Latviešu
+Name[mk]=Латвиски
 Name[mn]=Латви
 Name[ms]=Latvia
 Name[mt]=Latvjan
@@ -4265,6 +4372,7 @@
 Name[zu]=Isi-Latvian
 [li]
 Name=Limburgan
+Name[ar]=الليمبورغية
 Name[az]=Limburqca
 Name[bg]=Лимбургански
 Name[bn]=লিমবার্গান
@@ -4286,6 +4394,7 @@
 Name[is]=Limburgian
 Name[it]=Limburghese
 Name[ja]=リンブルク語
+Name[mk]=Лимбургански
 Name[mn]=Лимбүрг
 Name[nb]=Limburgisk
 Name[nds]=Limborgsch
@@ -4314,6 +4423,7 @@
 Name[zu]=Isi-Lumburgan
 [ln]
 Name=Lingala
+Name[ar]=اللينغالا
 Name[az]=Linqalaca
 Name[bg]=Лингалски
 Name[bn]=লিঙ্গালা
@@ -4323,6 +4433,7 @@
 Name[hr]=Lingalski
 Name[hu]=lingala
 Name[ja]=リンガラ語
+Name[mk]=Лингала
 Name[mn]=Лингала
 Name[nso]=Se-Lingala
 Name[pa]=ਲੀਨਗਾਲਾ
@@ -4444,9 +4555,10 @@
 Name[it]=Lussemburghese
 Name[ja]=ルクセンブルグ語
 Name[lt]=Liuksemburgiečių
+Name[mk]=Луксембургски
 Name[mn]=Люьксембүрг
 Name[nb]=Luxemburgisk
-Name[nds]=Luxemburgsch
+Name[nds]=Luxemborgsch
 Name[nl]=Letzenburgs
 Name[nn]=Luxembourgsk
 Name[nso]=Se-Luxembourgish
@@ -4474,7 +4586,6 @@
 Name[zu]=Isi-Luxembourgish
 [mk]
 Name=Macedonian
-Name[af]=Makedoniese
 Name[ar]=المقدونية
 Name[az]=Makedonca
 Name[be]=Македонская
@@ -4545,6 +4656,7 @@
 Name[zu]=Isi-Makhedoniya
 [mh]
 Name=Marshallese
+Name[ar]=المارشالية
 Name[az]=Marşallca
 Name[be]=Маршальская
 Name[bg]=Маршалски
@@ -4569,6 +4681,7 @@
 Name[it]=Marshall, lingua delle isole
 Name[ja]=マーシャル諸島言語
 Name[lt]=Maršaliečių
+Name[mk]=Маршалски
 Name[mn]=Маршалл
 Name[nb]=Marshallesisk
 Name[nds]=Marschalleessch
@@ -4598,6 +4711,7 @@
 Name[zu]=Isi-Marshallese
 [ml]
 Name=Malayalam
+Name[ar]=المالايالام
 Name[az]=Malayamca
 Name[bg]=Малаялам
 Name[bn]=মালয়লম
@@ -4614,6 +4728,7 @@
 Name[it]=Kerala, lingua del
 Name[ja]=マラヤーラム語
 Name[lt]=Malajiečių
+Name[mk]=Малајалам
 Name[mn]=Малаялам
 Name[nso]=Se-Malayalam
 Name[pa]=ਮਲਿਆਲਮ
@@ -4636,7 +4751,6 @@
 Name[zu]=Isi-Malayalam
 [mi]
 Name=Maori
-Name[af]=Maoriese
 Name[ar]=الموري
 Name[az]=Maoricə
 Name[be]=Маоры
@@ -4690,6 +4804,7 @@
 Name[zu]=Isi-Maori
 [mr]
 Name=Marathi
+Name[ar]=الماراثي
 Name[az]=Maraticə
 Name[bg]=Маратхи
 Name[bn]=মরাঠী
@@ -4703,6 +4818,7 @@
 Name[hu]=marati
 Name[ja]=マラーティー語
 Name[ko]=마라티어
+Name[mk]=Марати
 Name[mn]=Марати
 Name[nso]=Se-Marathi
 Name[pa]=ਮਰਾਠੀ
@@ -4751,6 +4867,7 @@
 Name[ja]=マレー語
 Name[ko]=말레이어
 Name[lt]=Malajų
+Name[mk]=Малајски
 Name[mn]=Маля
 Name[nb]=Malaiisk
 Name[nds]=Malaisch
@@ -4801,6 +4918,7 @@
 Name[ja]=マダガスカル語
 Name[ko]=말라가시어
 Name[lt]=Malagasių
+Name[mk]=Малагаси
 Name[mn]=Малагасу
 Name[nn]=Gassisk
 Name[nso]=Se-Malagasy
@@ -4860,6 +4978,7 @@
 Name[ko]=몰타어
 Name[lt]=Maltiečių
 Name[lv]=Maltiešu
+Name[mk]=Малтешки
 Name[mn]=Малт
 Name[mt]=Malti
 Name[nb]=Maltesisk
@@ -4925,6 +5044,7 @@
 Name[ja]=モルダヴィア語
 Name[ko]=몰다비어
 Name[lt]=Moldavų
+Name[mk]=Молдавски
 Name[mn]=Молдав
 Name[ms]=Moldavia
 Name[nb]=Moldavisk
@@ -4990,6 +5110,7 @@
 Name[ja]=モンゴル語
 Name[ko]=몽골어
 Name[lt]=Mongolų
+Name[mk]=Монголски
 Name[mn]=Монгол
 Name[ms]=Mongolia
 Name[nb]=Mongolsk
@@ -5022,6 +5143,7 @@
 Name[zu]=Isi-Mongolian
 [na]
 Name=Nauru
+Name[ar]=الناورو
 Name[az]=Nauruca
 Name[be]=Науру
 Name[bg]=Науру
@@ -5038,6 +5160,7 @@
 Name[hu]=nauru
 Name[ja]=ナウル語
 Name[ko]=나우루
+Name[mk]=Науру
 Name[mn]=Науру
 Name[nso]=Se-Nauru
 Name[pa]=ਨਾਉਰੂ
@@ -5056,8 +5179,36 @@
 Name[zh_CN]=瑙鲁语
 Name[zh_TW]=諾魯語
 Name[zu]=Isi-Nauru
+[nds]
+Name=Low Saxon
+Name[bs]=Niži saksonski
+Name[ca]=Baix saxó
+Name[cs]=Dolnosaský
+Name[cy]=Sacsoneg Isel
+Name[da]=Nedresaksisk
+Name[es]=Bajo sajón
+Name[et]=Alamsaksi
+Name[fr]=Bas saxon (ou francique, ou plattdeutsch)
+Name[ga]=Sacsanais Íochtarach
+Name[hu]=alsószász
+Name[it]=Basso sassone
+Name[ja]=低地ドイツ語
+Name[lt]=Žemutinių saksonų
+Name[mk]=Долен Саксонски
+Name[nb]=Lavgermansk
+Name[nds]=Neddersass'sch
+Name[nl]=Nedersaksisch
+Name[nn]=Låggermansk
+Name[pl]=Dolnosaksoński
+Name[pt]=Baixo-Saxão
+Name[pt_BR]=Baixo Saxão
+Name[ro]=Saxona de Jos
+Name[sv]=Lågsachsiska
+Name[uk]=Ніжньо-Саксонська
 [nso]
 Name=Northern Sotho
+Name[af]=Noord Sotho
+Name[ar]=السوتو الشمالية
 Name[az]=Şimali Sotho
 Name[bg]=Северен Лесото
 Name[bn]=উত্তর সোথো
@@ -5074,6 +5225,7 @@
 Name[fa]=سوتوی شمالی
 Name[fi]=Pohjoissotho
 Name[fr]=Sotho du Nord
+Name[ga]=Sasótóis Thuaidh
 Name[hi]=नार्दर्न सोथो
 Name[hr]=Sjeverni Sotho
 Name[hu]=északi sotho
@@ -5082,6 +5234,7 @@
 Name[ja]=北ソト語
 Name[ko]=북부 소토어
 Name[lt]=Šiaurės Sotho
+Name[mk]=Северен Сото
 Name[mn]=Умард Сото
 Name[nb]=Nord-Sotho
 Name[nds]=Noord-Sotho
@@ -5108,6 +5261,7 @@
 Name[zh_CN]=北部梭托语
 [nv]
 Name=Navajo
+Name[ar]=النافاجو
 Name[az]=Navayoca
 Name[bg]=Наважо
 Name[bn]=নাভায়ো
@@ -5117,6 +5271,7 @@
 Name[fa]=ناواجویی
 Name[fi]=Navaho
 Name[fr]=Navaho
+Name[ga]=Navachóis
 Name[gl]=Navaxo
 Name[he]=נבאחו
 Name[hi]=नवाजो
@@ -5124,6 +5279,7 @@
 Name[hu]=navajo
 Name[ja]=ナヴァホ語
 Name[ko]=나바조어
+Name[mk]=Навахо
 Name[mn]=Наваяа
 Name[nso]=Se-Navajo
 Name[pa]=ਨਾਵਾਜੋ
@@ -5145,6 +5301,8 @@
 Name[zu]=Isi-Navajo
 [nr]
 Name=Ndebele, South
+Name[af]=Ndebele, Suid
+Name[ar]=النديبيلي الجنوبية
 Name[az]=Ndebele, Cənub
 Name[bg]=Южен Ндебеле
 Name[bn]=ন্‌দেবেলে, দক্ষিণ
@@ -5171,6 +5329,7 @@
 Name[ja]=ヌデベレ語、南
 Name[ko]=남부 은데벨레
 Name[lt]=Ndebele, Pietų
+Name[mk]=Ндебеле, јужен
 Name[mn]=Ндэбэлэ, өмнөд
 Name[nb]=Ndebele, Sør
 Name[nds]=Ndebele, Sööd
@@ -5203,6 +5362,8 @@
 Name[zu]=Isi-Ndebele, Sase-Mzansi
 [nd]
 Name=Ndebele, North
+Name[af]=Ndebele, Noord
+Name[ar]=النديبيلي الشمالية
 Name[az]=Ndebele, Şimal
 Name[bg]=Северен Ндебеле
 Name[bn]=ন্‌দেবেলে, উত্তর
@@ -5229,6 +5390,7 @@
 Name[ja]=ヌデベレ語、北
 Name[ko]=북부 은데벨레
 Name[lt]=Ndebele, Šiaurės
+Name[mk]=Ндебеле, северен
 Name[mn]=Ндэбэлэ, умард
 Name[nb]=Ndebele, Nord
 Name[nds]=Ndebele, Noord
@@ -5261,12 +5423,14 @@
 Name[zu]=Isi-Ndebele, Sase-Ntshonalanga
 [ng]
 Name=Ndonga
+Name[ar]=الندونغا
 Name[bg]=Нгонда
 Name[bn]=নডোঙ্গা
 Name[fa]=ان‌دونگایی
 Name[he]=נדונגה
 Name[hi]=नदोन्गा
 Name[hu]=ndonga
+Name[mk]=Ндонга
 Name[mn]=Ндонга
 Name[nso]=Se-Ndonga
 Name[pa]=ਨਡੋਨਗਾ
@@ -5290,6 +5454,7 @@
 Name[be]=Нэпальская
 Name[bg]=Непалски
 Name[bn]=নেপালী
+Name[br]=Nepaleg
 Name[bs]=Nepalski
 Name[ca]=Nepalí
 Name[cs]=Nepálský
@@ -5311,6 +5476,7 @@
 Name[ja]=ネパール語
 Name[ko]=네팔어
 Name[lt]=Nepaliečių
+Name[mk]=Непалски
 Name[mn]=Непал
 Name[nds]=Nepaleessch
 Name[nl]=Nepalees
@@ -5416,6 +5582,7 @@
 Name[be]=Нарвэская (Nynorsk)
 Name[bg]=Норвежки (нюнорск)
 Name[bn]=নরওয়েজীয় নাইনর্স্ক
+Name[br]=Norvegeg Nynorsk
 Name[bs]=Norveški Nynorsk
 Name[ca]=Noruec Nynorsk
 Name[cs]=Norský (Nynorsk)
@@ -5441,8 +5608,10 @@
 Name[ja]=ノルウェー語 (Nynorsk)
 Name[ko]=노르웨이어 (Nynorsk)
 Name[lt]=Norvegų Nynorsk
+Name[mk]=Норвешки Nynorsk
 Name[mn]=Норвеги Нинорск
 Name[nb]=Nynorsk
+Name[nds]=Norweegsch Nynorsk
 Name[nl]=Noors, Nynorsk
 Name[nn]=Norsk nynorsk
 Name[nso]=Se-Norwegian Nynorsk
@@ -5501,6 +5670,7 @@
 Name[ja]=ノルウェー語 (Bokmål)
 Name[ko]=노르웨이어 (Bokmaal)
 Name[lt]=Norvegų Bokmål
+Name[mk]=Норвешки Bokmål
 Name[mn]=Норвеги, Бокмал
 Name[nb]=Norsk, bokmål
 Name[nds]=Norweegsch (Bokmål)
@@ -5530,6 +5700,7 @@
 Name[zu]=Isi-Norwegian Bokmaal
 [ny]
 Name=Chichewa
+Name[ar]=التشيشيوا
 Name[az]=Çiçeva
 Name[bg]=Чичева
 Name[bn]=চিচেওয়া
@@ -5542,6 +5713,7 @@
 Name[hr]=Čičevski
 Name[hu]=csicseva
 Name[ja]=チチェワ語
+Name[mk]=Чичева
 Name[mn]=Чичева
 Name[nso]=Se-Chichewa
 Name[pa]=ਚਿਚੀਵਾ
@@ -5590,6 +5762,7 @@
 Name[ja]=プロヴァンス語
 Name[ko]=오크어
 Name[lv]=Okitāņu
+Name[mk]=Очитан
 Name[mn]=Окситан
 Name[mt]=Oċċitan
 Name[nb]=Oksitansk
@@ -5636,6 +5809,7 @@
 Name[hu]=orija
 Name[ja]=オリヤー語
 Name[ko]=오리야어
+Name[mk]=Орија
 Name[mn]=Ория
 Name[nso]=Se-Oriya
 Name[pa]=ਉੜੀਆ
@@ -5656,6 +5830,7 @@
 Name[zu]=Isi-Oriya
 [om]
 Name=Oromo
+Name[ar]=الأورومو
 Name[az]=Oromoca
 Name[bg]=Оромо
 Name[bn]=ওরোমো
@@ -5667,6 +5842,7 @@
 Name[hu]=oromo
 Name[ja]=オロモ語
 Name[ko]=오로모어
+Name[mk]=Оромо
 Name[mn]=Оромо
 Name[nso]=Se-Oromo
 Name[pa]=ਓਰੋਮੋ
@@ -5687,6 +5863,7 @@
 Name[zu]=Isi-Oromo
 [os]
 Name=Ossetian
+Name[ar]=الأوسيتية
 Name[az]=Osetiyaca
 Name[be]=Асецінская
 Name[bg]=Осетски
@@ -5710,6 +5887,7 @@
 Name[ja]=オセット語
 Name[ko]=오세티안어
 Name[lt]=Osetinų
+Name[mk]=Осетиски
 Name[mn]=Оссетан
 Name[nb]=Ossetisk
 Name[nds]=Osseetsch
@@ -5751,6 +5929,7 @@
 Name[fa]=پنجابی
 Name[fi]=Pandžabi
 Name[fr]=Pendjabi
+Name[ga]=Puinseáibis
 Name[he]=פנג'בית
 Name[hi]=पंजाबी
 Name[hr]=Pendžabski
@@ -5759,6 +5938,7 @@
 Name[ja]=バンジャブ語
 Name[ko]=펀잡어
 Name[lt]=Pendžabo
+Name[mk]=Пунџаби
 Name[mn]=Панжаби
 Name[nso]=Se-Panjabi
 Name[pa]=ਪੰਜਾਬੀ
@@ -5782,6 +5962,7 @@
 Name[zu]=Isi-Phanjabi
 [fa]
 Name=Farsi (Persian)
+Name[af]=Farsi (Persies)
 Name[ar]=فارسي
 Name[be]=Пэрсыдзкая
 Name[bg]=Фарси
@@ -5800,6 +5981,7 @@
 Name[fa]=فارسی
 Name[fi]=Farsi (Persia)
 Name[fr]=Persan
+Name[ga]=Fairsis (Peirsis)
 Name[he]=פרסית
 Name[hi]=फ़ारसी (पर्सियन)
 Name[hr]=Farsi (Perzijski)
@@ -5808,7 +5990,8 @@
 Name[it]=Farsi (Persiano)
 Name[ja]=ファルシ語(ペルシア語)
 Name[ko]=팔시 (페르시아어)
-Name[lt]=Farsi (Persų)
+Name[lt]=Farsi (persų)
+Name[mk]=Фарси (персиски)
 Name[mn]=Фарси (Перс)
 Name[nb]=Farsi (Persisk)
 Name[nds]=Farsi (Perssch)
@@ -5819,6 +6002,7 @@
 Name[pt]=Farsi (Persa)
 Name[pt_BR]=Farsi (Persa)
 Name[ro]=Farsi (Persană)
+Name[ru]=Фарси
 Name[se]=Farsigiella (Persialaš)
 Name[sk]=Farsí (Persky)
 Name[sl]=Farsi (perzijsko)
@@ -5833,6 +6017,7 @@
 Name[zh_CN]=波斯语
 [pi]
 Name=Pali
+Name[ar]=البالي
 Name[az]=Palicə
 Name[bg]=Палски
 Name[bn]=পালি
@@ -5845,6 +6030,7 @@
 Name[hr]=Palijski
 Name[hu]=pali
 Name[ja]=パーリ語
+Name[mk]=Пали
 Name[mn]=Пали
 Name[nso]=Se-Pali
 Name[pa]=ਪਾਲੀ
@@ -6013,6 +6199,7 @@
 Name[be]=Бразыльская партугальская
 Name[bg]=Бразилски португалски
 Name[bn]=ব্রাজিলীয় পর্তুগীজ
+Name[br]=Portugaleg Brazil
 Name[bs]=Brazilski portugalski
 Name[ca]=Brasiler Portuguès
 Name[cs]=Portugalský (Brazílie)
@@ -6027,6 +6214,7 @@
 Name[fa]=پرتغالی برزیلی
 Name[fi]=Brasilian Portugali
 Name[fr]=Portugais Brésilien
+Name[ga]=Portaingéilis na Brasaíle
 Name[gl]=Portugués Do Brasil
 Name[he]=פורטוגזית ברזילאית
 Name[hi]=ब्राजिलियन पुर्तगाली
@@ -6038,6 +6226,7 @@
 Name[ja]=ブラジル ポルトガル語
 Name[ko]=브라질식 포르투갈어
 Name[lt]=Brazilijos portugalų
+Name[mk]=Бразилски португалски
 Name[mn]=Бразилын португал
 Name[nb]=Brasil-portugisisk
 Name[nds]=Brasiliaansch Portugeessch
@@ -6083,6 +6272,7 @@
 Name[ja]=パシュトゥ語
 Name[ko]=푸시토어
 Name[lt]=Puštūnų
+Name[mk]=Пушто
 Name[mn]=Пушто
 Name[nso]=Se-Pushto
 Name[pa]=ਪੁਸ਼ਤੋ
@@ -6105,6 +6295,7 @@
 Name[zu]=Dudula ku
 [qu]
 Name=Quechua
+Name[ar]=الكويتشيوا
 Name[az]=Kveçcə
 Name[bg]=Ячуа
 Name[bn]=কেচুয়া
@@ -6120,6 +6311,7 @@
 Name[hu]=kecsua
 Name[ja]=ケチュア語
 Name[ko]=케추아어
+Name[mk]=Кечуа
 Name[mn]=Куечуа
 Name[nso]=Se-Quechua
 Name[pa]=ਕਿਉਚੁਆ
@@ -6140,7 +6332,7 @@
 Name[zu]=Isi-Quechua
 [ro]
 Name=Romanian
-Name[af]=Romeense
+Name[af]=Romeens
 Name[ar]=الرومانية
 Name[az]=Rumınca
 Name[be]=Румынская
@@ -6224,6 +6416,7 @@
 Name[hu]=rundi
 Name[ja]=ルンディ語
 Name[ko]=룬디어
+Name[mk]=Рунди
 Name[mn]=Рунди
 Name[nso]=Se-Rundi
 Name[pa]=ਰੂਡੀ
@@ -6243,7 +6436,7 @@
 Name[zu]=Isi-Rundi
 [ru]
 Name=Russian
-Name[af]=Russiese
+Name[af]=Russies
 Name[ar]=الروسية
 Name[az]=Rusca
 Name[be]=Расейская
@@ -6283,7 +6476,7 @@
 Name[ms]=Russia
 Name[mt]=Russu
 Name[nb]=Russisk
-Name[nds]=Russch
+Name[nds]=Russ'sch
 Name[nl]=Russisch
 Name[nn]=Russisk
 Name[nso]=Se-Russian
@@ -6316,6 +6509,7 @@
 Name[zu]=Isi-Rashiya
 [sg]
 Name=Sango
+Name[ar]=السانغو
 Name[az]=Sagno
 Name[bg]=Санго
 Name[bn]=সাংগো
@@ -6326,6 +6520,7 @@
 Name[hi]=सैन्गो
 Name[hu]=szangó
 Name[ja]=サンゴ語
+Name[mk]=Санго
 Name[mn]=Санго
 Name[nso]=Se-Sango
 Name[pa]=ਸਾਂਗੋ
@@ -6366,6 +6561,7 @@
 Name[ja]=サンスクリット
 Name[ko]=범어
 Name[lt]=Sanskritas
+Name[mk]=Санскрит
 Name[mn]=Санскрит
 Name[nso]=Se-Sanskrit
 Name[pa]=ਸੰਸਕ੍ਰਿਤ
@@ -6529,6 +6725,7 @@
 Name[zu]=Isi-Croatian
 [si]
 Name=Sinhalese
+Name[ar]=السينهالية
 Name[az]=Sinhalca
 Name[bg]=Синхалски
 Name[bn]=সিংহলী
@@ -6553,9 +6750,10 @@
 Name[ja]=シンハラ語
 Name[ko]=신할라어
 Name[lt]=Sinhalų
+Name[mk]=Синхалски
 Name[mn]=Синхал
 Name[nb]=Singalesisk
-Name[nds]=Sinhaleessch
+Name[nds]=Singaleessch
 Name[nl]=Sinhalees
 Name[nn]=Singalesisk
 Name[nso]=Se-Sinhalese
@@ -6651,6 +6849,8 @@
 Name[zu]=Isi-Slovenian
 [se]
 Name=Northern Sami
+Name[af]=Noordelike Sami
+Name[ar]=السامي الشمالية
 Name[az]=Şimali Sami
 Name[be]=Паўночная Саамская
 Name[bg]=Северен Сами
@@ -6678,10 +6878,11 @@
 Name[ja]=北サモス語
 Name[ko]=북부 사미어
 Name[lt]=Šiaurės Sami
+Name[mk]=Северен Сами
 Name[mn]=Умард Сами
 Name[ms]=Sami Utara
 Name[nb]=Nordsamisk
-Name[nds]=Noord-Samisch
+Name[nds]=Noord-Saamsch
 Name[nl]=Noord Sami
 Name[nn]=Nordsamisk
 Name[nso]=Se-Sami sa Lebowa
@@ -6711,6 +6912,7 @@
 Name[zu]=Isi-Sami Sase-Ntshonalanga
 [sk]
 Name=Slovak
+Name[af]=Slovakies
 Name[ar]=السلوفاكية
 Name[az]=Slovakca
 Name[be]=Славацкая
@@ -6731,6 +6933,7 @@
 Name[fa]=اسلواکی
 Name[fi]=Slovakki
 Name[fr]=Slovaque
+Name[ga]=Slóvaicis
 Name[gl]=Eslovaco
 Name[he]=סלובנית
 Name[hi]=स्लोवाकन
@@ -6778,6 +6981,7 @@
 Name[zu]=Isi-Silovaki
 [sm]
 Name=Samoan
+Name[ar]=الساموية
 Name[be]=Самоанская
 Name[bg]=Самоански
 Name[bn]=সামোয়ান
@@ -6804,6 +7008,7 @@
 Name[ja]=サモア語
 Name[ko]=사모아어
 Name[lt]=Samoa
+Name[mk]=Самоански
 Name[mn]=Самоан
 Name[nb]=Samoansk
 Name[nds]=Samoaansch
@@ -6834,6 +7039,7 @@
 Name[zu]=Isi-Samoan
 [sn]
 Name=Shona
+Name[ar]=الشونا
 Name[bg]=Шонски
 Name[bn]=শোনা
 Name[eo]=Ŝona
@@ -6843,6 +7049,7 @@
 Name[hu]=sona
 Name[ja]=ショナ語
 Name[ko]=쇼나어
+Name[mk]=Шона
 Name[mn]=Шона
 Name[nso]=Se-Shona
 Name[pa]=ਸ਼ੋਨਾ
@@ -6876,6 +7083,7 @@
 Name[is]=Shindi
 Name[ja]=シンド語
 Name[ko]=신디어
+Name[mk]=Синди
 Name[mn]=Синди
 Name[nso]=Se-Sindhi
 Name[pa]=ਸਿੰਧੀ
@@ -6922,6 +7130,7 @@
 Name[ja]=ソマリ語
 Name[ko]=소말리아어
 Name[lt]=Somaliečių
+Name[mk]=Сомалиски
 Name[mn]=Сомали
 Name[nl]=Somalisch
 Name[nso]=Se-Somali
@@ -6947,6 +7156,8 @@
 Name[zu]=Isi-Somali
 [st]
 Name=Sotho, Southern
+Name[af]=Sotho, Suid
+Name[ar]=السوتو الشمالية
 Name[az]=Sotho, Cənubi
 Name[bg]=Южен Лесото
 Name[bn]=সোথো, দক্ষিণ
@@ -6973,10 +7184,11 @@
 Name[ja]=ソト語、南
 Name[ko]=남부 소토어
 Name[lt]=Sotho, Pietų
+Name[mk]=Сото, јужен
 Name[mn]=Сото, Өмнөд
 Name[ms]=Sotho, Selatan
 Name[nb]=Sotho, Sørlig
-Name[nds]=Sotho, Süüd
+Name[nds]=Sotho, Sööd
 Name[nl]=Sotho, Zuid
 Name[nn]=Sotho, sør
 Name[nso]=Sesotho, sa Borwa
@@ -7005,7 +7217,7 @@
 Name[zu]=Isi-Suthu, Sase-Mzantsi
 [es]
 Name=Spanish
-Name[af]=Spaanse
+Name[af]=Spaans
 Name[ar]=الأسبانية
 Name[az]=İspanca
 Name[be]=Гішпанская
@@ -7078,6 +7290,7 @@
 Name[zu]=Isi-Penishi
 [sc]
 Name=Sardinian
+Name[ar]=الساردينية
 Name[bg]=Сардински
 Name[bn]=সার্ডিনিয়ান
 Name[bs]=Sardinijski
@@ -7104,6 +7317,7 @@
 Name[ja]=サルデーニャ語
 Name[ko]=사르디니아어
 Name[lt]=Sardinijos
+Name[mk]=Сардиниски
 Name[mn]=Сардин
 Name[nb]=Sardisk
 Name[nds]=Sardiinsch
@@ -7133,17 +7347,20 @@
 Name[zu]=Isi-Sardinian
 [ss]
 Name=Swati
+Name[ar]=السواتي
 Name[az]=Svati
 Name[bg]=Свати
 Name[bn]=সোয়াতি
 Name[de]=Swazi
 Name[fa]=سواتی
 Name[fi]=Swazi
+Name[ga]=Sasuatais
 Name[he]=סוואטי
 Name[hi]=स्वाती
 Name[hu]=szvati
 Name[ja]=スワート語
 Name[ko]=스와티어
+Name[mk]=Свати
 Name[mn]=Свати
 Name[nso]=Se-Swati
 Name[pa]=ਸਵਾਟੀ
@@ -7191,6 +7408,7 @@
 Name[ja]=スンダ語
 Name[ko]=수단어
 Name[lt]=Sudaniečių
+Name[mk]=Сундански
 Name[mn]=Сундан
 Name[nb]=Sundanesisk
 Name[nds]=Sundaneessch
@@ -7241,6 +7459,7 @@
 Name[ja]=スワヒリ語
 Name[ko]=스와힐리어
 Name[lt]=Suahili
+Name[mk]=Свахили
 Name[mn]=Свахил
 Name[nso]=Se-Swahili
 Name[pa]=ਸਵਾਹਿਲੀ
@@ -7263,7 +7482,7 @@
 Name[zu]=Isi-Swahili
 [sv]
 Name=Swedish
-Name[af]=Sweedse
+Name[af]=Sweeds
 Name[ar]=السويدية
 Name[az]=İsveçcə
 Name[be]=Швэдзкая
@@ -7361,6 +7580,7 @@
 Name[ja]=タヒティ語
 Name[ko]=타히티어
 Name[lt]=Tahiti
+Name[mk]=Тахитски
 Name[mn]=Тахит
 Name[ms]=Tahiti
 Name[nb]=Tahitisk
@@ -7392,7 +7612,7 @@
 Name[zu]=Isi-Tahitian
 [ta]
 Name=Tamil
-Name[af]=Tamiliese
+Name[af]=Tamilies
 Name[ar]=التاميلية
 Name[az]=Tamil Dili
 Name[be]=Тамільская
@@ -7468,8 +7688,9 @@
 Name[ja]=タタール語
 Name[ko]=타타르어
 Name[lt]=Totorių
+Name[mk]=Татарски
 Name[mn]=Татаар
-Name[nds]=Tataarsch
+Name[nds]=Tartaarsch
 Name[nn]=Tatarisk
 Name[nso]=Se-Tatar
 Name[pa]=ਤਾਟਾਰ
@@ -7494,6 +7715,7 @@
 Name[zu]=Isi-Tatar
 [te]
 Name=Telugu
+Name[ar]=التيلوغو
 Name[az]=Teluguca
 Name[be]=Тэлугу
 Name[bg]=Телугу
@@ -7507,6 +7729,7 @@
 Name[hu]=telugu
 Name[ja]=テルグ語
 Name[ko]=테루그어
+Name[mk]=Телугу
 Name[mn]=Тэлүгү
 Name[nso]=Se-Telugu
 Name[pa]=ਤੇਲਗੂ
@@ -7545,6 +7768,7 @@
 Name[fa]=تاجیک
 Name[fi]=Tadžikki
 Name[fr]=Tadjik
+Name[ga]=Táidsícis
 Name[he]=טג'יקית
 Name[hi]=ताजिक
 Name[hr]=Tadžikistanski
@@ -7553,6 +7777,7 @@
 Name[ja]=タジク語
 Name[ko]=타직어
 Name[lt]=Tadžikų
+Name[mk]=Таџикистански
 Name[mn]=Тажик
 Name[nb]=Tadsjikisk
 Name[nds]=Tadschiiksch
@@ -7581,7 +7806,7 @@
 Name[zu]=Isi-Tajik
 [th]
 Name=Thai
-Name[af]=Thaise
+Name[af]=Thaïs
 Name[ar]=التايلاندية
 Name[az]=Tayca
 Name[be]=Тайская
@@ -7608,7 +7833,7 @@
 Name[ko]=타이어
 Name[lt]=Tailandiečių
 Name[lv]=Taizemiešu
-Name[mk]=Таи
+Name[mk]=Тајландски
 Name[mn]=Тай
 Name[mt]=Tai
 Name[nl]=Thais
@@ -7670,6 +7895,7 @@
 Name[ja]=チベット語
 Name[ko]=티벳어
 Name[lt]=Tibetiečių
+Name[mk]=Тибетански
 Name[mn]=Төвд
 Name[ms]=Tibet
 Name[nb]=Tibetansk
@@ -7701,6 +7927,7 @@
 Name[zu]=Isi-Tibetan
 [ti]
 Name=Tigrinya
+Name[ar]=التيغرينيا
 Name[az]=Tigrinyaca
 Name[bg]=Тигрински
 Name[bn]=টিগ্রিন্যা
@@ -7716,6 +7943,7 @@
 Name[hu]=tigrinja
 Name[ja]=ティグリニャ語
 Name[ko]=티그리냐어
+Name[mk]=Тигринја
 Name[mn]=Тигрин
 Name[nn]=Tigrinja
 Name[nso]=Se-Tigrinya
@@ -7752,6 +7980,7 @@
 Name[hu]=tonga
 Name[ja]=トンガ語
 Name[ko]=통가어
+Name[mk]=Тонга
 Name[mn]=Тонга
 Name[nn]=Tongansk
 Name[nso]=Se-Tonga
@@ -7772,6 +8001,7 @@
 Name[zu]=Isi-Tonga
 [tn]
 Name=Tswana
+Name[ar]=التسوانا
 Name[az]=Tsvanaca
 Name[bg]=Тсвана
 Name[bn]=তসওয়ানা
@@ -7784,6 +8014,7 @@
 Name[hi]=तस्वाना
 Name[hu]=tszvana
 Name[ja]=ツワナ語
+Name[mk]=Цвана
 Name[mn]=Цвана
 Name[nn]=Setswana
 Name[nso]=Setswana
@@ -7806,6 +8037,7 @@
 Name[zu]=Isi-Tswana
 [ts]
 Name=Tsonga
+Name[ar]=التسونغا
 Name[az]=Tsongaca
 Name[bg]=Тсонга
 Name[bn]=তসংগা
@@ -7816,6 +8048,7 @@
 Name[hi]=त्सोन्गा
 Name[hu]=tsonga
 Name[ja]=ツォンガ語
+Name[mk]=Цонга
 Name[mn]=Цонга
 Name[nso]=Se-Tsonga
 Name[pa]=ਤਸੋਂਗਾ
@@ -7860,6 +8093,7 @@
 Name[it]=Turkmeno
 Name[ja]=トルクメン語
 Name[lt]=Turkmėnų
+Name[mk]=Туркменистански
 Name[mn]=Туркмен
 Name[nb]=Turkmensk
 Name[nds]=Turkmeensch
@@ -7892,7 +8126,7 @@
 Name[zu]=Amadoda Ase-Thekishi
 [tr]
 Name=Turkish
-Name[af]=Turkse
+Name[af]=Turks
 Name[ar]=التركية
 Name[az]=Türkcə
 Name[be]=Турэцкая
@@ -7963,6 +8197,7 @@
 Name[zu]=Isi-Thekishi
 [tw]
 Name=Twi
+Name[ar]=التوي
 Name[az]=Tvicə
 Name[bg]=Туи
 Name[bn]=টুয়ি
@@ -7972,6 +8207,7 @@
 Name[hi]=त्वी
 Name[hu]=tvi
 Name[ja]=トウィ語
+Name[mk]=Тви
 Name[mn]=Тви
 Name[nso]=Se-Twi
 Name[pa]=ਤਵੀ
@@ -7991,6 +8227,7 @@
 Name[zu]=Isi-Twi
 [ug]
 Name=Uighur
+Name[ar]=الأويغورية
 Name[az]=Uyğurca
 Name[be]=Уйгурская
 Name[bg]=Югхур
@@ -8006,6 +8243,7 @@
 Name[hr]=Ujgurski
 Name[hu]=ujgur
 Name[ja]=ウイグル語
+Name[mk]=Ујгур
 Name[mn]=Уйгур
 Name[nb]=Uigursk
 Name[nds]=Uighuursch
@@ -8033,7 +8271,7 @@
 Name[zu]=Isi-Uighur
 [uk]
 Name=Ukrainian
-Name[af]=Ukraïniese
+Name[af]=Ukraïnies
 Name[ar]=الأوكرانية
 Name[az]=Ukrayna Dili
 Name[be]=Украінская
@@ -8120,6 +8358,7 @@
 Name[hu]=urdu
 Name[ja]=ウルドゥー語
 Name[ko]=울두어
+Name[mk]=Урду
 Name[mn]=Урду
 Name[nso]=Se-Urdu
 Name[pa]=ਉਰਦੂ
@@ -8155,6 +8394,7 @@
 Name[et]=Usbeki
 Name[fa]=ازبک
 Name[fi]=Uzbekki
+Name[ga]=Úsbaecais
 Name[he]=אוזבקית
 Name[hi]=उज्ब़ेक
 Name[hr]=Uzbekistanski
@@ -8163,6 +8403,7 @@
 Name[ja]=ウズベク語
 Name[ko]=우즈베크어
 Name[lt]=Uzbekų
+Name[mk]=Узбекистански
 Name[mn]=Узбек
 Name[nb]=Usbekisk
 Name[nds]=Usbeeksch
@@ -8201,6 +8442,7 @@
 Name[hu]=venda
 Name[ja]=ヴェンダ語
 Name[ko]=벤다어
+Name[mk]=Венда
 Name[mn]=Венда
 Name[pa]=ਵਾਂਡਾ
 Name[ru]=Венда
@@ -8216,7 +8458,7 @@
 Name[zh_CN]=闻达语
 [vi]
 Name=Vietnamese
-Name[af]=Viëtnamese
+Name[af]=Viëtnamees
 Name[ar]=الفييتنامية
 Name[az]=Vyetnamca
 Name[be]=Віетнамская
@@ -8249,6 +8491,7 @@
 Name[ko]=베트남어
 Name[lt]=Vietnamiečių
 Name[lv]=Vjetnamiešu
+Name[mk]=Виетнамски
 Name[mn]=Витьнам
 Name[ms]=Vietnam
 Name[mt]=Vjetnamiż
@@ -8284,6 +8527,7 @@
 Name[zu]=Isi-Vietnamese
 [vo]
 Name=Volapük
+Name[ar]=الفولابوك
 Name[az]=Volapükcə
 Name[bg]=Воларски
 Name[bn]=ভোলাপুক
@@ -8294,6 +8538,7 @@
 Name[hi]=वोलापक
 Name[hu]=volapük
 Name[ja]=ヴォラピューク語
+Name[mk]=Волапук
 Name[mn]=Волапүк
 Name[nl]=Volapúk
 Name[nn]=Volapyk
@@ -8347,6 +8592,7 @@
 Name[ko]=웨일스어
 Name[lt]=Velsiečių
 Name[lv]=Velšu
+Name[mk]=Велшки
 Name[mn]=Вел
 Name[ms]=Wales
 Name[mt]=Welx
@@ -8379,7 +8625,6 @@
 Name[zu]=Isi-Welsh
 [wa]
 Name=Walloon
-Name[af]=Walloonse
 Name[ar]=الوالون
 Name[az]=Valonca
 Name[be]=Валонская
@@ -8443,6 +8688,7 @@
 Name[zu]=Isi-Walloon
 [wo]
 Name=Wolof
+Name[ar]=الوولوف
 Name[az]=Volofca
 Name[bg]=Воловски
 Name[bn]=ওয়োলফ
@@ -8456,6 +8702,7 @@
 Name[hr]=Volofski
 Name[hu]=volof
 Name[ja]=ウォロフ語
+Name[mk]=Волоф
 Name[mn]=Волоф
 Name[nso]=Se-Wolof
 Name[pa]=ਵੂਲੂਫ
@@ -8487,6 +8734,7 @@
 Name[hu]=xhosza
 Name[ja]=コーサ語
 Name[ko]=엑스호사어
+Name[mk]=Ксоса
 Name[mn]=Чоса
 Name[nso]=Sethosa
 Name[pa]=ਝੋਸਾ
@@ -8511,6 +8759,7 @@
 Name[zu]=Isi-Xhosa
 [yi]
 Name=Yiddish
+Name[ar]=اليديش
 Name[az]=Yiddişcə
 Name[be]=Ідыш
 Name[bg]=Идиш
@@ -8531,9 +8780,10 @@
 Name[ja]=イディッシュ語
 Name[ko]=이디시어
 Name[lt]=Jidiš
+Name[mk]=Еврејски
 Name[mn]=Юүд
 Name[nb]=Jiddisk
-Name[nds]=Jiddisch
+Name[nds]=Jiddsch
 Name[nn]=Jiddisk
 Name[nso]=Se-Yiddish
 Name[pa]=ਯੀਡਿਸ਼
@@ -8556,6 +8806,7 @@
 Name[zu]=Isi-Yidishi
 [yo]
 Name=Yoruba
+Name[ar]=اليوروبا
 Name[az]=Yorubaca
 Name[bg]=Йориба
 Name[bn]=য়োরুবা
@@ -8569,6 +8820,7 @@
 Name[hu]=joruba
 Name[ja]=ヨルバ語
 Name[ko]=요루바어
+Name[mk]=Јоруба
 Name[mn]=Ёруба
 Name[nn]=Joruba
 Name[nso]=Se-Yoruba
@@ -8591,6 +8843,7 @@
 Name[zu]=Isi-Yoruba
 [za]
 Name=Zhuang
+Name[ar]=الزهوانغ
 Name[az]=Zhuangca
 Name[bg]=Жуанг
 Name[bn]=ঝুয়াং
@@ -8600,6 +8853,7 @@
 Name[hi]=झुआंग
 Name[hu]=zhuang
 Name[ja]=荘
+Name[mk]=Жуанг
 Name[mn]=Жунгаа
 Name[nso]=Se-Zhuang
 Name[pa]=ਜ਼ੂੰਗ
@@ -8638,6 +8892,7 @@
 Name[is]=Zúlú
 Name[ja]=ズールー語
 Name[ko]=줄루어
+Name[mk]=Зулу
 Name[mn]=Зулу
 Name[mt]=Żulu
 Name[nso]=Se-Zulu
diff -urN -x CVS kdelibs.orig/kdecore/configure.in.in kdelibs/kdecore/configure.in.in
--- kdelibs.orig/kdecore/configure.in.in	Sun Aug 22 00:02:14 2004
+++ kdelibs/kdecore/configure.in.in	Fri Oct 15 14:20:29 2004
@@ -56,7 +56,7 @@
 
 kde_safe_LIBS="$LIBS"
 LIBS="$LIBS $all_libraries $X_EXTRA_LIBS"
-AC_CHECK_FUNCS([inet_ntop inet_pton getpeername getsockname getsockopt gethostbyname2_r gethostbyname_r gethostbyname2 if_nametoindex getprotobyname_r getservbyname_r])
+AC_CHECK_FUNCS([inet_ntop inet_pton getpeername getsockname getsockopt gethostbyname2_r gethostbyname_r gethostbyname2 if_nametoindex getprotobyname_r getservbyname_r getservbyport_r])
 LIBS="$kde_safe_LIBS"
 AC_CHECK_HEADERS([netinet/in.h net/if.h],,,
 [#include <sys/types.h>
diff -urN -x CVS kdelibs.orig/kdecore/eventsrc kdelibs/kdecore/eventsrc
--- kdelibs.orig/kdecore/eventsrc	Sat Oct  2 16:30:04 2004
+++ kdelibs/kdecore/eventsrc	Fri Nov 12 08:27:50 2004
@@ -2,11 +2,12 @@
 # go = The K-icon from kicker
 IconName=go
 Comment=KDE System Notifications
-Comment[af]=Kde Stelsel Inkennistelling
+Comment[af]=KDE Stelsel Inkennistelling
 Comment[ar]=تنبيهات كيدي
 Comment[az]=KDE Sistem Bildirişləri
 Comment[bg]=Системни съобщения
 Comment[bn]=কে.ডি.ই সিস্টেম বার্তাবলী
+Comment[br]=Kemennoù ar reizhiad KDE
 Comment[bs]=KDE Sistemska obavještenja
 Comment[ca]=Notificacions del sistema KDE
 Comment[cs]=Systémová hlášení prostředí KDE
@@ -34,12 +35,12 @@
 Comment[ko]=KDE 시스템 알림
 Comment[lt]=KDE Sistemos Pranešimai
 Comment[lv]=KDE Sistēmas Paziņojumi
-Comment[mk]=KDE системско известување
+Comment[mk]=KDE системски известувања
 Comment[mn]=KDE-Системийн сонордуулга
 Comment[ms]= Sistem Pemberitahuan KDE
 Comment[mt]=Notifiki tas-sistema KDE
 Comment[nb]=KDE Systemvarsler
-Comment[nds]=KDE Systeemnarichten
+Comment[nds]=KDE-Systeemnarichten
 Comment[nl]=KDE Systeemnotificaties
 Comment[nn]=KDE Systempåminningar
 Comment[nso]=Ditsebiso tsa System ya KDE
@@ -107,11 +108,12 @@
 Name[ko]=글월 완성: 맴돌이
 Name[lt]=Textcompletion: sukimas
 Name[lv]=Tekstakomplekts: rotācija
-Name[mk]=Textcompletion: ротација
+Name[mk]=Довршување текст: ротација
 Name[mn]=Текст гүйцээлт: эргүүлэлт
 Name[ms]= Penyudah teks: putaran
 Name[mt]=Kompletazzjoni tal-kliem: tidwir
 Name[nb]=Tekstfullføring: rotering
+Name[nds]=Textkumpletteren: dreihen
 Name[nl]=Tekstaanvulling: rotatie
 Name[nn]=Tekstfullføring: rotering
 Name[nso]=Phetso ya sengwalwana: tharelo
@@ -143,6 +145,7 @@
 Name[zh_TW]=文字補齊：旋轉
 Name[zu]=Ukuqedwa kombhalo:ukujikelezisa
 Comment=The end of the list of matches has been reached
+Comment[af]=Die einde van die lys van ooreenkomste is bereik
 Comment[bg]=Достигнат е края на списъка от съвпадения
 Comment[bn]=মিলের তালিকার শেষে উপস্থিত
 Comment[bs]=Došao sam do kraja liste pogodaka
@@ -159,7 +162,10 @@
 Comment[is]=Enda listans yfir atriði sem passa náð
 Comment[it]=È stata raggiunta la fine della lista delle corrispondenze
 Comment[ja]=マッチリストの終端に達しました
+Comment[lt]=Pasiektas atitikmenų sąrašo galas
+Comment[mk]=Достигнат е крајот на листата на совпаѓања
 Comment[nb]=Har kommet til slutten av lista over treff
+Comment[nds]=Dat is dat Enn vun de List mit Övereenstimmen
 Comment[nl]=Het einde van de lijst met overeenkomsten is bereikt
 Comment[nn]=Slutten av trefflista er nådd
 Comment[pa]=ਮੇਲ ਸੂਚੀ ਦਾ ਅੰਤ ਆ ਗਿਆ ਹੈ
@@ -167,15 +173,17 @@
 Comment[pt]=O fim da lista de escolhas foi atingido
 Comment[pt_BR]=O fim da lista de coincidências foi atingido
 Comment[ro]=Am ajuns la sfîrşitul listei de potriviri
+Comment[ru]=Достигнут конец списка совпадений
 Comment[se]=Ollii gávdnosiid listtu lohppii
 Comment[sk]=Bol dosiahnutý koniec zoznamu nájdených položiek
 Comment[sl]=To je konec seznama zadetkov
 Comment[sr]=Достигнут је крај листе подударања
-Comment[sr@Latn]=Достигнут је крај листе подударања
+Comment[sr@Latn]=Dostignut je kraj liste podudaranja
 Comment[sv]=Slutet på listan med träffar har nåtts
 Comment[ta]=பொருத்தப் பட்டியலின் முடிவை அடைந்தாயிற்று.
 Comment[tg]=Охири рӯйхати наздикоянда расидед
 Comment[uk]=Досягнуто кінець списку співпадань
+Comment[uz]=Мос келадиган элементлар рўйхатининг охири
 Comment[zh_CN]=已到达匹配项列表的最后
 default_presentation=1
 
@@ -214,12 +222,12 @@
 Name[ko]=글월 완성: 맞는 짝이 없음
 Name[lt]=Textcompletion: netinka
 Name[lv]=Tekstakomplekts: nav atbilstību
-Name[mk]=Textcompletion: нема совпаѓања
+Name[mk]=Довршување текст: нема совпаѓања
 Name[mn]=Текст гүйцээлт: Харьцуулалтгүй
 Name[ms]= Penyudah teks: tiada padanan
 Name[mt]=Kompletazzjoni tal-kliem: ebda qbil
 Name[nb]=Tekstfullføring: ingen treff
-Name[nds]=Text kumpletteern: dor passt nix
+Name[nds]=Textkumpletteren: nix passt
 Name[nl]=Tekstaanvulling - geen overeenkomsten
 Name[nn]=Tekstfullføring: ingen treff
 Name[nso]=Phetso ya sengwalwana: gagona tshwanelano
@@ -251,6 +259,7 @@
 Name[zh_TW]=文字補齊：沒有匹配
 Name[zu]=Ukuqedwa kokumbhalo: akukho okufanayo
 Comment=No matching completion was found
+Comment[af]=Geen ooreenstemming was gevind
 Comment[bg]=Не е намерено съвпадение
 Comment[bn]=কোনো যুতসই পরিপূরক পাওয়া যায় নি
 Comment[bs]=Nijedno dovršavanje nije pronađeno
@@ -267,7 +276,10 @@
 Comment[is]=Ekkert passar
 Comment[it]=Nessun completamento corrispondente trovato
 Comment[ja]=マッチする補完は見つかりませんでした
+Comment[lt]=Nerasta atitinkanti pabaiga
+Comment[mk]=Не е најдено совпаѓање
 Comment[nb]=Ingen passende fullføring funnet
+Comment[nds]=Dor passt nix
 Comment[nl]=Er werd geen overeenkomstige aanvulling gevonden
 Comment[nn]=Ingen passande fullføring funne
 Comment[pa]=ਸਮਾਪਤੀ ਤੱਕ ਕੋਈ ਮੇਲ ਨਹੀਂ ਲੱਭਾ
@@ -275,15 +287,17 @@
 Comment[pt]=Não foi encontrada qualquer completação
 Comment[pt_BR]=Nenhuma coincidência foi encontrada
 Comment[ro]=Nu am găsit nimic potrivit
+Comment[ru]=Не найдено совпадений
 Comment[se]=Heivvolaš ollašuhttin ii gávdnon
 Comment[sk]=Žiadna zhoda nebola nájdená
 Comment[sl]=Ni najti ujemajočih se zadetkov
 Comment[sr]=Подударна допуна није пронађена
-Comment[sr@Latn]=Подударна допуна није пронађена
+Comment[sr@Latn]=Podudarna dopuna nije pronađena
 Comment[sv]=Ingen matchande komplettering hittades
 Comment[ta]=பொருத்தமான நிறைவு ஏதுமில்லை.
 Comment[tg]=Анҷомдиҳии наздикоянда накофтан
 Comment[uk]=Відповідного завершення не знайдено
+Comment[uz]=Мос келадиган тугатиш топилмади
 Comment[zh_CN]=没有找到匹配的补全项
 default_presentation=1
 
@@ -322,12 +336,12 @@
 Name[ko]=글월 완성: 부분은 짝이 맞음
 Name[lt]=Textcompletion: tinka dalinai
 Name[lv]=Tekstakomplekts: daļēja atbilstība
-Name[mk]=Textcompletion: делумни совпаѓања
+Name[mk]=Довршување текст: делумни совпаѓања
 Name[mn]=Текст гүйцээлт: Хагас харьцуулалттай
 Name[ms]= Penyudah teks: separa padanan
 Name[mt]=Kompletazzjoni tal-kliem: qbil parzjali
 Name[nb]=Tekstfullføring: delvis treff
-Name[nds]=Text kumpletteern: passt deelwies
+Name[nds]=Textkumpletteren: passt deelwies
 Name[nl]=Tekstaanvulling - gedeeltelijke overeenkomsten
 Name[nn]=Tekstfullføring: delvis treff
 Name[nso]=Phetso ya sengwalwana: tshwanelanyo dikarolong tse rilego
@@ -359,6 +373,7 @@
 Name[zh_TW]=文字補齊︰部分匹配
 Name[zu]=Ukuqedwa kokubhaliweyo: ukufaniswa kwesikhashana
 Comment=There is more than one possible match
+Comment[af]=Daar is meer as een moontlik ooreenkoms
 Comment[bg]=Повече от едно съвпадение са намерени
 Comment[bn]=একাধিক সম্ভাব্য পরিপূরক বর্তমান
 Comment[bs]=Postoji više od jednog mogućeg pogotka
@@ -375,7 +390,10 @@
 Comment[is]=Það eru fleiri en eitt atriði sem passar
 Comment[it]=C'è più di una corrispondenza possibile
 Comment[ja]=1つ以上のマッチがあります
+Comment[lt]=Yra daugiau negu vienas galimas atitikmuo
+Comment[mk]=Постојат повеќе од едно совпаѓање
 Comment[nb]=Det er mer enn ett mulig treff
+Comment[nds]=Dor passt mehr as een
 Comment[nl]=Er is meer dan één mogelijke overeenkomst
 Comment[nn]=Det er meir enn eitt mogleg treff
 Comment[pa]=ਇੱਕ ਤੋਂ ਵਧੇਰੇ ਮੇਲ ਉਪਲੱਬਧ ਹਨ
@@ -383,15 +401,17 @@
 Comment[pt]=Há mais do que uma completação possível
 Comment[pt_BR]=Há mais de uma opção possível
 Comment[ro]=Există mai mult de o potrivire posibilă
+Comment[ru]=Найдено более чем одно совпадение
 Comment[se]=Leat eanet go ovtta vejolaš gávdnus
 Comment[sk]=Existuje viac ako jedna zhoda
 Comment[sl]=Mogoč je več kakor en zadetek
 Comment[sr]=Постоји више од једног могућег подударања
-Comment[sr@Latn]=Постоји више од једног могућег подударања
+Comment[sr@Latn]=Postoji više od jednog mogućeg podudaranja
 Comment[sv]=Det finns mer än en möjlig träff
 Comment[ta]=ஒன்றுக்கு மேற்பட்ட பொருத்தங்கள் உள்ளன.
 Comment[tg]=Ин ҷо калонтар нисбат ба як дута эҳтимолӣ
 Comment[uk]=Більше одного відповідного значення
+Comment[uz]=Биттадан кўп мослик топилди
 Comment[zh_CN]=有多于一个的可能匹配项
 default_presentation=1
 
@@ -438,7 +458,7 @@
 Name[ms]=Tidak boleh Buka Fail
 Name[mt]=Ma jistax jinfetaħ fajl
 Name[nb]=Kan ikke åpne fil
-Name[nds]=Dateii laat sik nich opmaken
+Name[nds]=Datei laat sik nich opmaken
 Name[nl]=Kan het bestand niet openen
 Name[nn]=Kan ikkje opna fil
 Name[nso]=Ekase Bule Faele
@@ -509,7 +529,7 @@
 Comment[ms]=Fail dipilih tidak boleh dibaca atau ditulis
 Comment[mt]=Il-fajl magħżul ma setax jinfetaħ għall-qari jew kitba.
 Comment[nb]=Den valgte fila kan ikke åpnes for lesing eller skriving
-Comment[nds]=De utsöökt Datei is för't Lesen oder Schrieven nich to bruken
+Comment[nds]=De utsöchte Datei laat sik nich lesen oder schrieven
 Comment[nl]=Het geselecteerde bestand kan niet worden geopend om te lezen of naar te schrijven.
 Comment[nn]=Den valte fila kan ikkje opnast for lesing eller skriving
 Comment[nso]=Faele yeo e kgethilwego ekase bulelwe go bala goba go ngwala
@@ -525,7 +545,7 @@
 Comment[sl]=Izbrane datoteke ni bilo moč odpreti za branje ali pisanje.
 Comment[sq]=Skedari i zgjedhur nuk mund të hapet për lexim apo editim
 Comment[sr]=Изабрани фајл је немогуће отворити ради читања или писања
-Comment[sr@Latn]=Izabrani fajl je nemoguće otvoriti radi čitanja ili pisanja.
+Comment[sr@Latn]=Izabrani fajl je nemoguće otvoriti radi čitanja ili pisanja
 Comment[ss]=lifayela lelikhetsiwe akukhonakali kutsi livulwe kutsi lifundvwe kumbe libhalwe
 Comment[sv]=Den valda filen kan inte öppnas för läsning eller skrivning
 Comment[ta]=தேர்வு செய்த கோப்பை வாசிக்கவோ எழுதவோ திறக்க முடியாது
@@ -616,6 +636,7 @@
 Name[zh_TW]=嚴重錯誤
 Name[zu]=Iphutha Lengozi
 Comment=There was a serious error causing the program to exit
+Comment[af]=Daar was 'n ernstige fout wat veroorsaak het dat die program beïendig is.
 Comment[bg]=Появи се сериозна грешка, която предизвика прекъсване на програмата
 Comment[bn]=একটি গুরুতর ত্রুটির দরুণ প্রোগ্রামটি থেমে গেছে
 Comment[bs]=Program je morao završiti zbog ozbiljne greške
@@ -632,8 +653,10 @@
 Comment[is]=Alvarleg villa stöðvaði keyrslu forritsins.
 Comment[it]=Si è verificato un errore grave che ha causato la fine del programma
 Comment[ja]=プログラムが終了する深刻なエラーがあります
+Comment[lt]=Įvyko rimta klaida, privertusi programą užbaigti darbą
+Comment[mk]=Се случи сериозна грешка поради која програмот заврши
 Comment[nb]=Det var en alvorlig feil som førte til at programmet avsluttet
-Comment[nds]=Dor is'n Malör passert un dat Programm warrt afbraken
+Comment[nds]=Dor is en Malöör passeert, dat Programm warrt afbraken
 Comment[nl]=Er was een ernstige fout die ervoor zorgde dat dit programma beëindigd werd
 Comment[nn]=Ein alvorleg feil førte til at programmet avslutta
 Comment[pa]= ਇੱਕ ਘਾਤਕ ਗਲਤੀ ਨੇ ਕਾਰਜ ਨੂੰ ਬੰਦ ਹੋਣ ਲਈ ਮਜਬੂਰ ਕਰ ਦਿੱਤਾ ਹੈ
@@ -641,15 +664,17 @@
 Comment[pt]=Ocorreu um erro grave que provocou o fim da execução do programa
 Comment[pt_BR]=Houve um erro sério, que fez o programa finalizar
 Comment[ro]=A apărut o eroare severă care a determinat terminarea programului
+Comment[ru]=Серьезный сбой, приведший к выходу из программы
 Comment[se]=Vearrás meattáhusa geažil prográmma heittii
 Comment[sk]=Vyskytla sa vážna chyba, ktorá spôsobila ukončenie programu
 Comment[sl]=Program se je končal zaradi resne napake
 Comment[sr]=Десила се озбиљна грешка, која је изазвала да се програм затвори
-Comment[sr@Latn]=Десила се озбиљна грешка, која је изазвала да се програм затвори
+Comment[sr@Latn]=Desila se ozbiljna greška, koja je izazvala da se program zatvori
 Comment[sv]=Ett allvarligt fel uppstod vilket fick programmet att avslutas
 Comment[ta]=நிரலை வெளியேறச் செய்கிற அளவில் ஒரு பெரிய தவறுண்டு.
 Comment[tg]=Хатои ҷиддӣ иҷозат дода шудан ба нақшаи баромадан таъсир кардан
 Comment[uk]=Серйозна помилка стала причиною виходу програми
+Comment[uz]=Дастурнинг ишини якунланишига сабабчи бўлган жиддий хато рўй берди
 Comment[zh_CN]=有一个严重的错误导致程序退出
 default_presentation=2
 level=4
@@ -727,6 +752,7 @@
 Name[zh_TW]=通知
 Name[zu]=Isaziso
 Comment=Something special happened in the program
+Comment[af]=Iets spesiaal het met die program gebeur
 Comment[bg]=В програмата се случи нещо неочаквано
 Comment[bn]=প্রোগ্রামে বিশেষ কিছু একটা ঘটেছে
 Comment[bs]=Nešto posebno se desilo u programu
@@ -743,6 +769,8 @@
 Comment[is]=Eitthvað sérstakt gerðist í forritinu
 Comment[it]=È successo qualcosa di speciale nel programma
 Comment[ja]=何か特別なことがプログラムにおこりました
+Comment[lt]=Kažkoks specialus įvykis programoje
+Comment[mk]=Нешто специјално се случило во програмот
 Comment[nb]=Noe spesielt skjedde med programmet
 Comment[nds]=In dat Programm is wat afsünnerlich passeert
 Comment[nl]=Er gebeurde iets bijzonders in het programma
@@ -752,15 +780,17 @@
 Comment[pt]=Ocorreu algo de especial no programa
 Comment[pt_BR]=Algo especial ocorreu no programa
 Comment[ro]=S-a întîmplat ceva neaşteptat în program
+Comment[ru]=В программе возникла неполадка
 Comment[se]=Juoga erenoamáš dáhpáhuvai prográmmas
 Comment[sk]=V programe sa udialo niečo neočakávané
 Comment[sl]=V programu se je zgodilo nekaj izrednega
 Comment[sr]=Нешто посебно се десило у програму
-Comment[sr@Latn]=Нешто посебно се десило у програму
+Comment[sr@Latn]=Nešto posebno se desilo u programu
 Comment[sv]=Någonting speciellt inträffade i programmet
 Comment[ta]=நிரலில் ஏதோ விசேடம் நிகழ்ந்துள்ளது
 Comment[tg]=Чизе махсус ин нақша рӯй додан
 Comment[uk]=Щось особливе сталось у програмі
+Comment[uz]=Дастурда қандайдир одатдан ташқари ҳодиса рўй берди
 Comment[zh_CN]=程序中发生了特殊情况
 default_presentation=1
 default_sound=KDE_Beep.ogg
@@ -808,7 +838,7 @@
 Name[ms]=Amaran
 Name[mt]=Twissija
 Name[nb]=Advarsel
-Name[nds]=Wohrschoen
+Name[nds]=Wohrschoon
 Name[nl]=Waarschuwing
 Name[nn]=Åtvaring
 Name[nso]=Temoso
@@ -841,6 +871,7 @@
 Name[zh_TW]=警告
 Name[zu]=Isexwayiso
 Comment=There was an error in the program which may cause problems
+Comment[af]=Daar was 'n fout in die program wat dalk probleme kan veroorsaak
 Comment[bg]=Появи се грешка, която може да предизвика проблеми
 Comment[bn]=প্রোগ্রামে একটি ত্রুটি ছিল যার ফলে সমস্যা হতে পারে
 Comment[bs]=Postoji greška u programu koja možda uzrokuje probleme.
@@ -857,8 +888,10 @@
 Comment[is]=Það kom upp villa í forritinu sem gæti valdið vandræðum
 Comment[it]=Nel programma si è verificato un errore che può causare problemi
 Comment[ja]=プログラムに問題を引き起こすエラーがあります
+Comment[lt]=Įvyko programos klaida, galinti sukelti problemų
+Comment[mk]=Се случи грешка во програмот што може да предизвика проблеми
 Comment[nb]=Det var en feil i programmet som kan føre til problemer
-Comment[nds]=Dor is'n Fehler in dat Programm, dat is villicht 'n Problem
+Comment[nds]=Dor is en Fehler in dat Programm, villicht treckt dat Problemen na sik
 Comment[nl]=Er zat een fout in het programma die voor problemen kon zorgen
 Comment[nn]=Ein feil oppstod i programmet og kan føra til problem
 Comment[pa]=ਕਾਰਜ ਵਿੱਚ ਗਲਤੀ ਆਈ ਹੈ, ਜੋ ਕਿ ਸਮੱਸਿਆ ਪੈਦਾ ਕਰ ਰਹੀ ਹੈ
@@ -866,15 +899,17 @@
 Comment[pt]=Ocorreu um erro grave no programa que pode causar problemas
 Comment[pt_BR]=Houve um erro no programa que pode ter causado problemas
 Comment[ro]=A apărut o eroare în program care ar putea cauza probleme
+Comment[ru]=Ошибка в программе, которая может вызвать проблемы
 Comment[se]=Prográmmas lei meattáhus mii sáhttá dagahit váttisvuođaid
 Comment[sk]=V programe sa vyskytla chyba, ktorá môže spôsobiť problémy
 Comment[sl]=V programu je nastala napaka, ki lahko povzroči težave
 Comment[sr]=Десила се грешка у програму која може изазвати проблеме
-Comment[sr@Latn]=Десила се грешка у програму која може изазвати проблеме
+Comment[sr@Latn]=Desila se greška u programu koja može izazvati probleme
 Comment[sv]=Det uppstod ett fel i programmet vilket kan orsaka problem
 Comment[ta]=பிரச்னைகளை ஏற்படுத்தும் அளவிற்கு நிரலில் ஒரு தவறு இருந்தது.
 Comment[tg]=Хатои иҷозат дода шудан дар нақша, кадом масъалаҳо таъсир кардан метавонед
 Comment[uk]=Сталася серйозна помилка, яка може викликати проблеми
+Comment[uz]=Дастурда муаммоларга олиб келиши мумкин бўлган хато рўй берди
 Comment[zh_CN]=程序中发生了可能导致问题的错误
 default_presentation=2
 level=2
@@ -919,7 +954,7 @@
 Name[ms]=Malapetaka
 Name[mt]=Katastrofu
 Name[nb]=Katastrofe
-Name[nds]=Katastrooph
+Name[nds]=Katastroof
 Name[nl]=Catastrofe
 Name[nn]=Katastrofe
 Name[oc]=Catastrofe
@@ -950,6 +985,7 @@
 Name[zh_TW]=嚴重問題
 Name[zu]=Inhlekelele
 Comment=A very serious error occurred, at least causing the program to exit
+Comment[af]='n baie ernstige fout het voorgekom. Dit het veroorsaak dat ten minste die program beëindig is
 Comment[ar]=حدث خطأ كبير سيؤدي على الأقل الى ايقاف البرنامج
 Comment[az]=Çox ciddi bir xəta yarandə və proqramı çıxmağa məcbur etdi
 Comment[bg]=Появи се сериозна грешка, която предизвика прекъсване на програмата
@@ -968,6 +1004,7 @@
 Comment[fa]=خطایی جدی رخ داد، که حداقل باعث خروج برنامه شد
 Comment[fi]=Tapahtui vakava virhe, jonka takia ohjelma ainakin lopetetaan.
 Comment[fr]=Une erreur très grave s'est produite, provoquant au moins l'arrêt du programme
+Comment[ga]=Tharla droch-earráid, agus ara laghad tá an clár tar éis stopadh
 Comment[gl]=Ocorreu un erro moi serio, causando polo menos o remate da execución do programa
 Comment[he]=אירעה שגיאה חמורה מאוד, שלפחות גרמה לתוכנית לצאת
 Comment[hi]=एक अति गंभीर त्रुटि हुई, जिससे प्रोग्राम बाहर हो गया
@@ -979,10 +1016,11 @@
 Comment[ja]=少なくともプログラムを終了時に、非常に重大なエラーが生じました。
 Comment[ko]=프로그램이 끝날 때 아주 심각한 오류가 생겼습니다
 Comment[lt]=Įvyko labai rimta klaida, privertusi programą bent jau baigti darbą.
+Comment[mk]=Се случи сериозна грешка, што во најмала рака предизвика програмот да се исклучи
 Comment[mn]=Дор хаяж программыг таслан гарах ноцтой алдаа гарлаа. 
 Comment[ms]=Ada ralat sangat serius di dalam program yang menyebabkan program keluar
 Comment[nb]=Det oppsto en alvorlig feil som til slutt førte til at programmet avsluttet
-Comment[nds]=Dor is'n Malör passeert un tominnst is dat Programm nu to Enn.
+Comment[nds]=Dor is en Malöör passeert, dat tominnst to't Enn vun't Programm föhrt hett
 Comment[nl]=Er deed zich een zeer ernstige fout voor, waardoor tenminste de toepassing werd afgesloten
 Comment[nn]=Ein svært alvorleg feil oppstod, som førte til at programmet avslutta
 Comment[pa]=ਇੱਕ ਘਾਤਕ ਗਲਤੀ ਆਈ ਹੈ, ਘੱਟੋ-ਘੱਟ ਇਹ ਕਾਰਜ ਨੂੰ ਬੰਦ ਹੋਣ ਲਈ ਮਜ਼ਬੂਰ ਕਰ ਰਹੀ ਹੈ
@@ -996,7 +1034,7 @@
 Comment[sl]=Nastala je tako resna napaka, da se bo končal program.
 Comment[sq]=Një gabim serioz ka ndodhur, së paku do të shkaktoj mbylljen e programit
 Comment[sr]=Десила се веома озбиљна грешка, која ће у најмању руку проузроковати затварање програма
-Comment[sr@Latn]=Desila se veoma ozbiljna greška, koja će u najmanju ruku prouzrokovati zatvaranje programa.
+Comment[sr@Latn]=Desila se veoma ozbiljna greška, koja će u najmanju ruku prouzrokovati zatvaranje programa
 Comment[sv]=Ett väldigt allvarligt fel uppstod som åtminstone fick programmet att avslutas
 Comment[ta]=நிரலை வெளியேறச் செய்யும் அளவில் ஒரு பெரிய தவறு ஏற்பட்டது
 Comment[tg]=Хатои хеле ҷиддӣ воқеъ шудан, дар охир нақшаи баромадан таъсир кардан
@@ -1075,6 +1113,7 @@
 Name[zh_TW]=登入
 Name[zu]=Ukungena ngaphakathi
 Comment=KDE is starting up
+Comment[af]=Begin KDE Laai
 Comment[bg]=Стартиране на системата
 Comment[bn]=কে.ডি.ই. চালু হচ্ছে
 Comment[bs]=KDE se pokreće
@@ -1086,11 +1125,14 @@
 Comment[et]=KDE käivitub
 Comment[fi]=KDE:tä käynnistetään
 Comment[fr]=KDE est en cours de démarrage
+Comment[ga]=Tá KDE ag tosú.
 Comment[he]=איתחול KDE בעיצומו
 Comment[hu]=A KDE elindul
 Comment[is]=KDE er að ræsa
 Comment[it]=Avvio di KDE
 Comment[ja]=KDE起動中
+Comment[lt]=KDE pradeda darbą
+Comment[mk]=KDE се вклучува
 Comment[nb]=KDE starter
 Comment[nds]=KDE warrt start
 Comment[nl]=KDE is aan het opstarten
@@ -1100,11 +1142,12 @@
 Comment[pt]=O KDE está a arrancar
 Comment[pt_BR]=KDE está iniciando
 Comment[ro]=KDE porneşte
+Comment[ru]=Запуск KDE
 Comment[se]=KDE vuolgigoahtá johtui
 Comment[sk]=KDE sa spúšťa
 Comment[sl]=KDE se zaganja
 Comment[sr]=KDE се покреће
-Comment[sr@Latn]=KDE се покреће
+Comment[sr@Latn]=KDE se pokreće
 Comment[sv]=KDE startas
 Comment[ta]=கேடிஇ ஆரம்பிக்கிறது
 Comment[tg]=KDE боркарда шуда истодааст
@@ -1121,6 +1164,7 @@
 Name[az]=Çıxış
 Name[bg]=Изход от системата
 Name[bn]=লগ-আউট
+Name[br]=Kuitaat
 Name[bs]=Odjava
 Name[ca]=Sortida
 Name[cs]=Odhlášení
@@ -1157,7 +1201,7 @@
 Name[nso]=Etswa
 Name[oc]=Desconneccion
 Name[pa]=ਲਾਗਆਉਟ
-Name[pl]=Zakończenie pracy
+Name[pl]=Wylogowanie
 Name[pt]=Fim de sessão
 Name[pt_BR]=Sair
 Name[ro]=Ieşire
@@ -1183,6 +1227,7 @@
 Name[zh_TW]=登出
 Name[zu]=Phumela ngaphandle
 Comment=KDE is exiting
+Comment[af]=KDE is besig om toe te maak
 Comment[bg]=Спиране на системата
 Comment[bn]=কে.ডি.ই. বন্ধ করা হচ্ছে
 Comment[bs]=KDE se zatvara
@@ -1194,13 +1239,16 @@
 Comment[et]=KDE lõpetab töö
 Comment[fi]=KDE:tä sammutetaan
 Comment[fr]=KDE est en cours d'arrêt
+Comment[ga]=Tá KDE ag stopadh.
 Comment[he]=היציאה מ-KDE בעיצומה
 Comment[hu]=A KDE kilép
 Comment[is]=KDE er að hætta
 Comment[it]=Uscita da KDE
 Comment[ja]=KDE終了中
+Comment[lt]=KDE baigia darbą
+Comment[mk]=KDE излегува
 Comment[nb]=KDE avslutter
-Comment[nds]=KDE warrt utmakt
+Comment[nds]=KDE warrt utmaakt
 Comment[nl]=KDE is aan het afsluiten
 Comment[nn]=KDE avsluttar
 Comment[pa]=KDE ਸਮਾਪਤ ਹੋ ਰਿਹਾ ਹੈ
@@ -1208,11 +1256,12 @@
 Comment[pt]=O KDE está a terminar
 Comment[pt_BR]=KDE está finalizando
 Comment[ro]=KDE se termină
+Comment[ru]=Выход из KDE
 Comment[se]=KDE heaitigođii
 Comment[sk]=KDE sa ukončuje
 Comment[sl]=KDE se končuje
 Comment[sr]=KDE се завршава
-Comment[sr@Latn]=KDE се завршава
+Comment[sr@Latn]=KDE se završava
 Comment[sv]=KDE avslutas
 Comment[ta]=கேடிஇ வெளிச்செல்கிறது
 Comment[tg]=KDE бароварда шуда истодааст
@@ -1230,6 +1279,7 @@
 Name[be]=Памылка друку
 Name[bg]=Грешка при печат
 Name[bn]=মুদ্রণ ত্রুটি
+Name[br]=Fazi en ur moulañ
 Name[bs]=Greška pri štampanju
 Name[ca]=Error d'impressió
 Name[cs]=Chyba tisku
@@ -1257,6 +1307,7 @@
 Name[ko]=인쇄 오류
 Name[lt]=Spausdinimo klaida
 Name[lv]=Drukas kļūda
+Name[mk]=Грешка при печатење
 Name[mn]=Хэвлэхэд алдаа
 Name[ms]= Ralat cetak
 Name[mt]=Problema fl-ipprintjar
@@ -1293,6 +1344,7 @@
 Name[zh_TW]=列印錯誤
 Name[zu]=Iphutha lokushicelela
 Comment=A print error has occurred
+Comment[af]='n Druk fout het voorgekom
 Comment[ar]=حدث خطأ في الطباعة
 Comment[az]=Çap xətası baş verdi
 Comment[bg]=Грешка при печат
@@ -1311,6 +1363,7 @@
 Comment[fa]=خطای چاپی رخ داد
 Comment[fi]=Tapahtui tulostusvirhe
 Comment[fr]=Un problème d'impression est survenu
+Comment[ga]=Tharla earráid priontála
 Comment[gl]=Ocorreu un erro de impresión
 Comment[he]=אירעה שגיאת הדפסה
 Comment[hi]=छापने में एक त्रुटि हुई
@@ -1322,10 +1375,11 @@
 Comment[ja]=印刷エラーが発生しました
 Comment[ko]=인쇄 오류가 생겼습니다
 Comment[lt]=Įvyko spausdinimo klaida
+Comment[mk]=Се случи грешка при печатење
 Comment[mn]=Хэвлэхэд алдаа гарлаа
 Comment[ms]=Ralat cetak berlaku
 Comment[nb]=En skriverfeil har oppstått
-Comment[nds]=Dor weer 'n Fehler bi't Drucken
+Comment[nds]=Bi't Drucken hett dat 'n Fehler geven
 Comment[nl]=Er deed zich een afdrukfout voor
 Comment[nn]=Feil ved utskrift
 Comment[pa]=ਇੱਕ ਪ੍ਰਿੰਟਰ ਗਲਤੀ ਹੈ
@@ -1355,6 +1409,7 @@
 
 [messageInformation]
 Name=Information message
+Name[af]=Inligting boodskap
 Name[ar]=رسالة المعلومات
 Name[az]=Mə'lumat ismarışı
 Name[be]=Інфармацыйнае паведамленьне
@@ -1374,6 +1429,7 @@
 Name[fa]=پیام اطلاعاتی
 Name[fi]=Tiedoitusviesti
 Name[fr]=Message d'information
+Name[ga]=Teachtaireacht Eolais
 Name[gl]=Mensaxe de información
 Name[he]=הודעת מידע
 Name[hi]=सूचनात्मक संदेश
@@ -1385,6 +1441,7 @@
 Name[ja]=情報メッセージ
 Name[ko]=정보 메세지
 Name[lt]=Informacinis pranešimas
+Name[mk]=Информативна порака
 Name[mn]=Мэдээллийн мэдээ
 Name[ms]=Mesej maklumat
 Name[nb]=Informasjonsmelding
@@ -1413,6 +1470,7 @@
 Name[wa]=Messaedje d' informåcion
 Name[zh_CN]=信息性消息
 Comment=An information message is being shown
+Comment[af]='n Informasie boodskap word vertoon
 Comment[ar]=تظهر الآن رسالة معلوماتية
 Comment[az]=Mə'lumat ismarışı göstərilir
 Comment[bg]=Показване на уведомително съобщение (Информация)
@@ -1431,6 +1489,7 @@
 Comment[fa]=یک پیام اطلاعاتی نمایش داده می‌شود
 Comment[fi]=Näytetään tiedotusviesti
 Comment[fr]=Un message d'information est affiché actuellement
+Comment[ga]=Tá teachtaireacht eolais á taispeáint
 Comment[gl]=Estase a amosar unha mensaxe de información
 Comment[he]=מוצגת הדעת מידע
 Comment[hi]=एक जानकारी परक सूचना दिखाई जा रही है
@@ -1442,10 +1501,11 @@
 Comment[ja]=情報メッセージを表示します
 Comment[ko]=정보 메세지가 보입니다
 Comment[lt]=Rodomas informacinis pranešimas
+Comment[mk]=Прикажана е информативна порака
 Comment[mn]=Харуулж байхад мэдээллийн мэдээ
 Comment[ms]=Mesej yang dipaparkan
 Comment[nb]=En informasjonsmelding blir vist
-Comment[nds]=Dor is'n Informatschoon to sehn
+Comment[nds]=En Informatschoon warrt wiest
 Comment[nl]=Er wordt een informatiebericht getoond
 Comment[nn]=Ei informasjonsmelding vert vist
 Comment[pa]=ਇੱਕ ਜਾਣਕਾਰੀ ਸੁਨੇਹਾ ਹੇਠਾਂ ਵੇਖਿਆ ਗਿਆ ਹੈ
@@ -1474,6 +1534,7 @@
 
 [messageWarning]
 Name=Warning message
+Name[af]=Waarskuwing boodskap
 Name[ar]=رسالة تحذيرية
 Name[az]=Xəbərdarlıq ismarışı
 Name[be]=Папярэджаньне
@@ -1493,6 +1554,7 @@
 Name[fa]=پیام اخطاری
 Name[fi]=Varoitusviesti
 Name[fr]=Message d'avertissement
+Name[ga]=Teachtaireacht Rabhaidh
 Name[gl]=Mensaxe de aviso
 Name[he]=הודעת הזהרה
 Name[hi]=चेतावनी संदेश
@@ -1504,10 +1566,11 @@
 Name[ja]=警告メッセージ
 Name[ko]=경고 메세지
 Name[lt]=Perspėjantis pranešimas
+Name[mk]=Предупредувачка порака
 Name[mn]=Сануулга мэдээ
 Name[ms]=Mesej amaran
 Name[nb]=Varselmelding
-Name[nds]=Wohrschoen
+Name[nds]=Wohrschoon
 Name[nl]=Waarschuwingsbericht
 Name[nn]=Varselmelding
 Name[pa]=ਚੇਤਵਾਨੀ ਸੁਨੇਹਾ
@@ -1532,6 +1595,7 @@
 Name[wa]=Messaedje d' adviertixhmint
 Name[zh_CN]=警告消息
 Comment=A warning message is being shown
+Comment[af]='n Waarskuwing boodskap word vertoon
 Comment[ar]=تظهر الآن رسالة تحذيرية
 Comment[az]=Xəbərdarlıq ismarışı göstərilir
 Comment[bg]=Показване на предупредително съобщение (Предупреждение)
@@ -1561,10 +1625,11 @@
 Comment[ja]=警告メッセージを表示します
 Comment[ko]=경고 메세지가 보입니다
 Comment[lt]=Rodomas perspėjantis pranešimas
+Comment[mk]=Прикажана е предупредувачка порака
 Comment[mn]=Харуулж байхад сануулга
 Comment[ms]=Mesej amaran yang dipaparkan
 Comment[nb]=En varselmelding blir vist
-Comment[nds]=Dor is'n Wohrschoen to sehn
+Comment[nds]=En Wohrschoon warrt wiest
 Comment[nl]=Er wordt een waarschuwingsbericht getoond
 Comment[nn]=Ei varselmelding vert vist
 Comment[pa]=ਇੱਕ ਚੇਤਾਵਨੀ ਸੁਨੇਹਾ ਹੇਠਾਂ ਵੇਖਿਆ ਗਿਆ ਹੈ
@@ -1595,6 +1660,7 @@
 
 [messageCritical]
 Name=Critical message
+Name[af]=Kritiese boodskap
 Name[ar]=رسالة هامَة
 Name[az]=Kritik ismarış
 Name[bg]=Грешка
@@ -1624,10 +1690,11 @@
 Name[ja]=クリティカルメッセージ
 Name[ko]=중요 메세지
 Name[lt]=Kritinis pranešimas
+Name[mk]=Критична порака
 Name[mn]=Шүүмжлэлт мэдээ
 Name[ms]=Mesej Kritikal
 Name[nb]=Kritisk melding
-Name[nds]=Malör
+Name[nds]=Malöör
 Name[nl]=Kritiek bericht
 Name[nn]=Kritisk melding
 Name[pa]=ਘਾਤਕ ਸੁਨੇਹਾ
@@ -1651,6 +1718,7 @@
 Name[wa]=Messaedje critike
 Name[zh_CN]=关键消息
 Comment=A critical message is being shown
+Comment[af]='n Kritiese boodskap word vertoon
 Comment[ar]=تظهر الآن رسالة مهمَة
 Comment[az]=Kritik ismarış göstərilir
 Comment[bg]=Показване на съобщение за грешка (Грешка)
@@ -1680,10 +1748,11 @@
 Comment[ja]=クリティカルメッセージを表示します
 Comment[ko]=중요 메세지가 보입니다
 Comment[lt]=Rodomas kritinis pranešimas
+Comment[mk]=Прикажана е критична порака
 Comment[mn]=Харуулж байхад шүүмжилэлт сануулга
 Comment[ms]=Mesej kritikal yang dipaparkan
 Comment[nb]=En kritisk melding blir vist
-Comment[nds]=Dor is'n kritische Naricht to sehn
+Comment[nds]=En kritische Naricht warrt wiest
 Comment[nl]=Er wordt een kritiek bericht getoond
 Comment[nn]=Ei kritisk melding vert vist
 Comment[pa]=ਇੱਕ ਘਾਤਕ ਸੁਨੇਹਾ ਹੇਠਾਂ ਵੇਖਿਆ ਗਿਆ ਹੈ
@@ -1713,11 +1782,13 @@
 
 [messageboxQuestion]
 Name=Question
+Name[af]=Vraag
 Name[ar]=سؤال
 Name[az]=Sual
 Name[be]=Пытаньне
 Name[bg]=Въпрос
 Name[bn]=প্রশ্ন
+Name[br]=Goulenn
 Name[bs]=Pitanje
 Name[ca]=Pregunta
 Name[cs]=Dotaz
@@ -1731,6 +1802,7 @@
 Name[eu]=Galdera
 Name[fa]=سوال
 Name[fi]=Kysymys
+Name[ga]=Ceist
 Name[gl]=Pregunta
 Name[he]=שאלה
 Name[hi]=प्रश्न
@@ -1742,6 +1814,7 @@
 Name[ja]=質問
 Name[ko]=물음
 Name[lt]=Klausimas
+Name[mk]=Прашање
 Name[mn]=Асуулт
 Name[ms]=Soalan
 Name[nb]=Spørsmål
@@ -1770,6 +1843,7 @@
 Name[wa]=Kesse
 Name[zh_CN]=问题
 Comment=A question is being asked
+Comment[af]='n Vraag word gevra
 Comment[ar]=هناك سؤال يتم سؤاله
 Comment[az]=Sual ismarışı göstərilir
 Comment[bg]=Показване на въпросително съобщение (Въпрос)
@@ -1788,6 +1862,7 @@
 Comment[fa]=سوالی مطرح می‌شود
 Comment[fi]=Kysytään kysymys
 Comment[fr]=Une question est posée actuellement
+Comment[ga]=Tá ceist á cur.
 Comment[gl]=Estase a preguntar unha cuestión
 Comment[he]=נשאלת שאלה
 Comment[hi]=एक प्रश्न पूछा गया है
@@ -1799,10 +1874,11 @@
 Comment[ja]=質問が出されています
 Comment[ko]=물어보겠습니다
 Comment[lt]=Užduodamas klausimas
+Comment[mk]=Поставено е прашање
 Comment[mn]=Асуулт тавигдаж байна
 Comment[ms]=Soalan yang ditanya
 Comment[nb]=Et spørsmål blir stillt
-Comment[nds]=Een Fraag warrt stellt.
+Comment[nds]=En Fraag warrt stellt
 Comment[nl]=Er wordt een vraag gesteld
 Comment[nn]=Eit spørsmål vert spurd
 Comment[pa]=ਇੱਕ ਸਵਾਲ ਪੁਛਿਆ ਜਾ ਰਿਹਾ ਹੈ
diff -urN -x CVS kdelibs.orig/kdecore/kcharsets.cpp kdelibs/kdecore/kcharsets.cpp
--- kdelibs.orig/kdecore/kcharsets.cpp	Thu Jul  8 19:09:10 2004
+++ kdelibs/kdecore/kcharsets.cpp	Fri Oct 29 18:42:36 2004
@@ -1,6 +1,6 @@
 /* This file is part of the KDE libraries
     Copyright (C) 1999 Lars Knoll (knoll@kde.org)
-    $Id$
+    $Id$
 
     This library is free software; you can redistribute it and/or
     modify it under the terms of the GNU Library General Public
@@ -297,6 +297,9 @@
     { "paratype-154", "pt 154" },
     { "pt-154", "pt 154" },
     { "x-winsami2", "winsami2" },
+    { "x-mac-roman", "apple roman" },
+    { "macintosh", "apple roman" },
+    { "mac", "apple roman" },
     { 0, 0 }};
 
 // some different names for the encodings defined in the charmaps files.
diff -urN -x CVS kdelibs.orig/kdecore/kconfigbase.cpp kdelibs/kdecore/kconfigbase.cpp
--- kdelibs.orig/kdecore/kconfigbase.cpp	Sat Mar 13 15:04:15 2004
+++ kdelibs/kdecore/kconfigbase.cpp	Sat Oct 30 19:58:00 2004
@@ -1790,7 +1790,7 @@
 
 void KConfigGroup::deleteGroup(bool bGlobal)
 {
-  mMaster->deleteGroup(KConfigBase::group(), false, bGlobal);
+  mMaster->deleteGroup(KConfigBase::group(), true, bGlobal);
 }
 
 void KConfigGroup::setDirty(bool _bDirty)
diff -urN -x CVS kdelibs.orig/kdecore/kde_file.h kdelibs/kdecore/kde_file.h
--- kdelibs.orig/kdecore/kde_file.h	Thu Jan  1 01:00:00 1970
+++ kdelibs/kdecore/kde_file.h	Sat Nov  6 11:19:53 2004
@@ -0,0 +1,116 @@
+/*
+   This file is part of the KDE libraries
+   Copyright (C) 2001 Waldo Bastian <bastian@kde.org>
+   Copyright (C) 2004 Jaroslaw Staniek <js@iidea.pl>
+
+   This library is free software; you can redistribute it and/or
+   modify it under the terms of the GNU Library General Public
+   License version 2 as published by the Free Software Foundation.
+
+   This library is distributed in the hope that it will be useful,
+   but WITHOUT ANY WARRANTY; without even the implied warranty of
+   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+   Library General Public License for more details.
+
+   You should have received a copy of the GNU Library General Public License
+   along with this library; see the file COPYING.LIB.  If not, write to
+   the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
+   Boston, MA 02111-1307, USA.
+*/
+
+#ifndef _KDE_FILE_H_
+#define _KDE_FILE_H_
+
+/**
+ * This file provides portable defines for file support.
+ * Use the KDE_xxx defines instead of the normal C
+ * functions and structures.
+ */
+
+#include <unistd.h>
+#ifdef _WIN32
+#include <kde_file_win.h>
+#endif
+ 
+#if (defined _LFS64_LARGEFILE) && (defined _LARGEFILE64_SOURCE)
+/**
+ * This section provides portable defines for large file support.
+ * To use this you must compile your code with _LARGEFILE64_SOURCE 
+ * defined and use the KDE_xxx defines instead of the normal
+ * C functions and structures.
+ *
+ * Please note that not every platform supports 64 bit file structures,
+ * in that case the normal 32 bit functions will be used.
+ *
+ * @see http://www.suse.de/~aj/linux_lfs.html 
+ * @see http://ftp.sas.com/standards/large.file/xopen/x_open.05Mar96.html
+ *
+ * KDE makes use of the "Transitional Extensions" since we can not ensure
+ * that all modules and libraries used by KDE will be compiled with
+ * 64-bit support. 
+ * (A.3.2.3 Mixed API and Compile Environments within a Single Process)
+ */
+#define KDE_stat		::stat64
+#define KDE_lstat		::lstat64
+#define KDE_fstat		::fstat64
+#define KDE_open		::open64
+#define KDE_lseek		::lseek64
+#define KDE_fseek		::fseek64
+#define KDE_ftell		::ftell64
+#define KDE_fgetpos		::fgetpos64
+#define KDE_fsetpos		::fsetpos64
+#define KDE_readdir		::readdir64
+#define KDE_sendfile	::sendfile64
+#define KDE_struct_stat 	struct stat64
+#define KDE_struct_dirent	struct dirent64
+/* TODO: define for win32 */
+
+#else /* !_LFS64_LARGEFILE */
+
+/**
+ * This section defines portable defines for standard file support.
+ */
+#ifdef _WIN32
+#define KDE_stat		kdewin32_stat
+#define KDE_lstat		kdewin32_lstat
+#define KDE_open		kdewin32_open
+#else /* unix */
+#define KDE_stat		::stat
+#define KDE_lstat		::lstat
+#define KDE_open		::open
+#endif
+
+#define KDE_fstat		::fstat
+#define KDE_lseek		::lseek
+#define KDE_fseek		::fseek
+#define KDE_ftell		::ftell
+#define KDE_fgetpos		::fgetpos
+#define KDE_fsetpos		::fsetpos
+#define KDE_readdir		::readdir
+#define KDE_sendfile	::sendfile
+#define KDE_struct_stat 	struct stat
+#define KDE_struct_dirent	struct dirent
+#endif
+
+
+#ifdef _LFS64_STDIO
+#define KDE_fopen		::fopen64
+#define KDE_freopen	::freopen64
+/* TODO: define for win32 */
+#else
+#ifdef _WIN32
+#define KDE_fopen		kdewin32_fopen
+#define KDE_freopen	kdewin32_freopen
+#else /* unix */
+#define KDE_fopen		::fopen
+#endif
+#endif
+
+/* functions without 64-bit version but wrapped for compatibility reasons */
+#ifdef _WIN32
+#define KDE_fdopen	kdewin32_fdopen
+#else /* unix */
+#define KDE_fdopen	::fdopen
+#endif
+
+#endif /* _KDE_FILE_H_ */
diff -urN -x CVS kdelibs.orig/kdecore/kdebug.areas kdelibs/kdecore/kdebug.areas
--- kdelibs.orig/kdecore/kdebug.areas	Thu Jun 17 15:28:27 2004
+++ kdelibs/kdecore/kdebug.areas	Mon Nov 29 18:09:51 2004
@@ -459,6 +459,9 @@
 30518        openoffice-filter
 30519        import-export-openoffice-filter-lib
 30520        kword-1.3-filter
+30521        gnumeric-filter
+30522        latex-filter
+30523        quattro-pro-filter
 31000        koffice
 32001        kword
 32002        kword (formatting)
diff -urN -x CVS kdelibs.orig/kdecore/kdemacros.h kdelibs/kdecore/kdemacros.h
--- kdelibs.orig/kdecore/kdemacros.h	Mon Apr  5 18:48:17 2004
+++ kdelibs/kdecore/kdemacros.h	Sun Nov 21 21:12:10 2004
@@ -36,13 +36,22 @@
 
 #if __GNUC__ - 0 > 3 || (__GNUC__ - 0 == 3 && __GNUC_MINOR__ - 0 > 2)
 #define KDE_NO_EXPORT __attribute__ ((visibility("hidden")))
-#define KDE_EXPORT __attribute__ ((visibility("visible")))
+#define KDE_EXPORT __attribute__ ((visibility("default")))
 #else
 #define KDE_NO_EXPORT
 #define KDE_EXPORT
 #endif
 
 /**
+ * KDE_Q_EXPORT_PLUGIN is a workaround for Qt not being able to
+ * cope with symbol visibility.
+ */
+#define KDE_Q_EXPORT_PLUGIN(PLUGIN) \
+  Q_EXTERN_C KDE_EXPORT const char* qt_ucm_query_verification_data(); \
+  Q_EXTERN_C KDE_EXPORT QUnknownInterface* ucm_instantiate(); \
+  Q_EXPORT_PLUGIN(PLUGIN)
+
+/**
  * The KDE_PACKED can be used to hint the compiler that a particular
  * structure or class should not contain unnecessary paddings. 
  */
diff -urN -x CVS kdelibs.orig/kdecore/kdesktopfile.cpp kdelibs/kdecore/kdesktopfile.cpp
--- kdelibs.orig/kdecore/kdesktopfile.cpp	Wed Jul 21 15:32:05 2004
+++ kdelibs/kdecore/kdesktopfile.cpp	Mon Oct  4 12:14:06 2004
@@ -19,7 +19,7 @@
   Boston, MA 02111-1307, USA.
 */
 
-// $Id$
+// $Id$
 
 #include <stdlib.h>
 #include <unistd.h>
@@ -27,6 +27,7 @@
 #include <qfile.h>
 #include <qtextstream.h>
 
+#include <kdebug.h>
 #include "kurl.h"
 #include "kconfigbackend.h"
 #include "kapplication.h"
@@ -138,6 +139,8 @@
      return true;
   if (dirs->relativeLocation("data", path).startsWith("kdesktop/Desktop"))
      return true;
+     
+  kdWarning() << "Access to '" << path << "' denied because of 'run_desktop_files' restriction." << endl;
   return false;
 }
 
diff -urN -x CVS kdelibs.orig/kdecore/kdeversion.h kdelibs/kdecore/kdeversion.h
--- kdelibs.orig/kdecore/kdeversion.h	Sun Oct  3 09:11:51 2004
+++ kdelibs/kdecore/kdeversion.h	Sun Nov 28 14:35:04 2004
@@ -17,15 +17,15 @@
     Boston, MA 02111-1307, USA.
 */
 
-// $Id$
+// $Id$
 
 #ifndef _KDE_VERSION_H_
 #define _KDE_VERSION_H_
 
-#define KDE_VERSION_STRING "3.3.1"
+#define KDE_VERSION_STRING "3.3.2"
 #define KDE_VERSION_MAJOR 3
 #define KDE_VERSION_MINOR 3
-#define KDE_VERSION_RELEASE 1
+#define KDE_VERSION_RELEASE 2
 #define KDE_MAKE_VERSION( a,b,c ) (((a) << 16) | ((b) << 8) | (c))
 
 #define KDE_VERSION \
diff -urN -x CVS kdelibs.orig/kdecore/kglobalsettings.cpp kdelibs/kdecore/kglobalsettings.cpp
--- kdelibs.orig/kdecore/kglobalsettings.cpp	Mon May 17 22:23:45 2004
+++ kdelibs/kdecore/kglobalsettings.cpp	Wed Nov 24 19:33:44 2004
@@ -559,24 +559,21 @@
             // This is a simplified version of the code in input/mouse.cpp
             // Keep in sync !
             s.handed = KMouseSettings::RightHanded;
-            unsigned char map[5];
-            switch (XGetPointerMapping(kapp->getDisplay(), map, 5))
+            unsigned char map[20];
+            int num_buttons = XGetPointerMapping(kapp->getDisplay(), map, 20);
+            if( num_buttons == 2 )
             {
-                case 2:
-                    if ( (int)map[0] == 1 && (int)map[1] == 2 )
-                        s.handed = KMouseSettings::RightHanded;
-                    else if ( (int)map[0] == 2 && (int)map[1] == 1 )
-                        s.handed = KMouseSettings::LeftHanded;
-                    break;
-                case 3:
-                case 5:
-                    if ( (int)map[0] == 1 && (int)map[2] == 3 )
-                        s.handed = KMouseSettings::RightHanded;
-                    else if ( (int)map[0] == 3 && (int)map[2] == 1 )
-                        s.handed = KMouseSettings::LeftHanded;
-                    break;
-                default:
-                    break;
+                if ( (int)map[0] == 1 && (int)map[1] == 2 )
+                    s.handed = KMouseSettings::RightHanded;
+                else if ( (int)map[0] == 2 && (int)map[1] == 1 )
+                    s.handed = KMouseSettings::LeftHanded;
+            }
+            else if( num_buttons >= 3 )
+            {
+                if ( (int)map[0] == 1 && (int)map[2] == 3 )
+                    s.handed = KMouseSettings::RightHanded;
+                else if ( (int)map[0] == 3 && (int)map[2] == 1 )
+                    s.handed = KMouseSettings::LeftHanded;
             }
 #else
 	    // FIXME(E): Implement in Qt Embedded
diff -urN -x CVS kdelibs.orig/kdecore/kicontheme.cpp kdelibs/kdecore/kicontheme.cpp
--- kdelibs.orig/kdecore/kicontheme.cpp	Tue Sep 28 05:36:02 2004
+++ kdelibs/kdecore/kicontheme.cpp	Sun Oct  3 16:28:58 2004
@@ -1,6 +1,6 @@
 /* vi: ts=8 sts=4 sw=4
  *
- * $Id$
+ * $Id$
  *
  * This file is part of the KDE project, module kdecore.
  * Copyright (C) 2000 Geert Jansen <jansen@kde.org>
diff -urN -x CVS kdelibs.orig/kdecore/kprocess.cpp kdelibs/kdecore/kprocess.cpp
--- kdelibs.orig/kdecore/kprocess.cpp	Mon Jan 19 13:00:07 2004
+++ kdelibs/kdecore/kprocess.cpp	Wed Oct 13 22:07:23 2004
@@ -1,6 +1,6 @@
 /*
 
-   $Id$
+   $Id$
 
    This file is part of the KDE libraries
    Copyright (C) 1997 Christian Czezatke (e9025461@student.tuwien.ac.at)
@@ -739,7 +739,25 @@
 void KProcess::setUseShell(bool useShell, const char *shell)
 {
   d->useShell = useShell;
-  d->shell = (shell && *shell) ? shell : "/bin/sh";
+  if (shell && *shell)
+    d->shell = shell;
+  else
+// #ifdef NON_FREE // ... as they ship non-POSIX /bin/sh
+#if !defined(__linux__) && !defined(__FreeBSD__) && !defined(__NetBSD__) && !defined(__OpenBSD__) && !defined(__GNU__)
+  // Solaris POSIX ...
+  if (!access( "/usr/xpg4/bin/sh", X_OK ))
+    d->shell = "/usr/xpg4/bin/sh";
+  else
+  // ... which links here anyway
+  if (!access( "/bin/ksh", X_OK ))
+    d->shell = "/bin/ksh";
+  else
+  // dunno, maybe superfluous?
+  if (!access( "/usr/ucb/sh", X_OK ))
+    d->shell = "/usr/ucb/sh";
+  else
+#endif
+    d->shell = "/bin/sh";
 }
 
 void KProcess::setUsePty(Communication usePty, bool addUtmp)
diff -urN -x CVS kdelibs.orig/kdecore/kstartupinfo.cpp kdelibs/kdecore/kstartupinfo.cpp
--- kdelibs.orig/kdecore/kstartupinfo.cpp	Thu Jul 15 16:07:27 2004
+++ kdelibs/kdecore/kstartupinfo.cpp	Tue Oct 12 16:58:19 2004
@@ -1,6 +1,6 @@
 /****************************************************************************
 
- $Id$
+ $Id$
 
  Copyright (C) 2001-2003 Lubos Lunak        <l.lunak@kde.org>
 
@@ -595,28 +595,6 @@
         return NoMatch;
     if( d->startups.count() == 0 )
         return NoMatch; // no startups
-#if defined Q_WS_X11 && ! defined K_WS_QTONLY
-// SELI ???
-    NETWinInfo info( qt_xdisplay(),  w_P, qt_xrootwin(),
-        NET::WMWindowType | NET::WMPid | NET::WMState );
-    // ignore NET::Tool and other special window types
-    NET::WindowType type = info.windowType( NET::NormalMask | NET::DesktopMask
-        | NET::DockMask | NET::ToolbarMask | NET::MenuMask | NET::DialogMask
-        | NET::OverrideMask | NET::TopMenuMask | NET::UtilityMask | NET::SplashMask );
-    if( type != NET::Normal
-        && type != NET::Override
-        && type != NET::Unknown
-        && type != NET::Dialog
-        && type != NET::Utility )
-//        && type != NET::Dock ) why did I put this here?
-	return NoMatch;
-    // lets see if this is a transient
-    Window transient_for;
-    if( XGetTransientForHint( qt_xdisplay(), static_cast< Window >( w_P ), &transient_for )
-        && static_cast< WId >( transient_for ) != qt_xrootwin()
-        && transient_for != None )
-	return NoMatch;
-#endif
     // Strategy:
     //
     // Is this a compliant app ?
@@ -636,6 +614,8 @@
         return find_id( id, id_O, data_O ) ? Match : NoMatch;
         }
 #if defined Q_WS_X11 && ! defined K_WS_QTONLY
+    NETWinInfo info( qt_xdisplay(),  w_P, qt_xrootwin(),
+        NET::WMWindowType | NET::WMPid | NET::WMState );
     pid_t pid = info.pid();
     if( pid > 0 )
         {
@@ -655,6 +635,23 @@
         if( find_wclass( res_name, res_class, id_O, data_O ))
             return Match;
         }
+    // ignore NET::Tool and other special window types, if they can't be matched
+    NET::WindowType type = info.windowType( NET::NormalMask | NET::DesktopMask
+        | NET::DockMask | NET::ToolbarMask | NET::MenuMask | NET::DialogMask
+        | NET::OverrideMask | NET::TopMenuMask | NET::UtilityMask | NET::SplashMask );
+    if( type != NET::Normal
+        && type != NET::Override
+        && type != NET::Unknown
+        && type != NET::Dialog
+        && type != NET::Utility )
+//        && type != NET::Dock ) why did I put this here?
+	return NoMatch;
+    // lets see if this is a transient
+    Window transient_for;
+    if( XGetTransientForHint( qt_xdisplay(), static_cast< Window >( w_P ), &transient_for )
+        && static_cast< WId >( transient_for ) != qt_xrootwin()
+        && transient_for != None )
+	return NoMatch;
 #endif
     kdDebug( 172 ) << "check_startup:cantdetect" << endl;
     return CantDetect;
diff -urN -x CVS kdelibs.orig/kdecore/malloc/README kdelibs/kdecore/malloc/README
--- kdelibs.orig/kdecore/malloc/README	Wed Feb 26 18:10:54 2003
+++ kdelibs/kdecore/malloc/README	Mon Oct 11 14:50:50 2004
@@ -4,11 +4,11 @@
 Basically, it's here because for now it has better performance than both glibc-2.2.x and
 FreeBSD's libc.
 
- There's a new configure switch, --enable-fast-malloc. By default it's turned on, disabling
+ There's a new configure switch, --enable-fast-malloc. By default it's turned off, disabling
 the system libc one and using this one. Using --enable-fast-malloc=full enables this
 malloc unconditionally, aiming for the maximum performance. By using only --enable-fast-malloc,
-it's possible to select both malloc implementations at runtime. When $KDE_MALLOC is set to 1,
-this malloc is used, the system libc one is used otherwise.
+it's possible to select both malloc implementations at runtime. When $KDE_MALLOC is set to 0,
+the system libc malloc is used, otherwise this malloc is used.
 
  For now, the requirements are :
  - x86 CPU (because of the spinlock implementation in assembler), it should be easy to add
diff -urN -x CVS kdelibs.orig/kdecore/netwm.cpp kdelibs/kdecore/netwm.cpp
--- kdelibs.orig/kdecore/netwm.cpp	Wed Jul 28 17:49:07 2004
+++ kdelibs/kdecore/netwm.cpp	Fri Oct  8 15:25:55 2004
@@ -494,7 +494,7 @@
 	sz = p->icons[j].size.width * p->icons[j].size.height;
 	s = sz * sizeof(long);
 
-	if ( i + s - 1 > bufsize ) {
+	if ( i + s - 1 > bufsize || sz == 0 || sz > 1024 * 1024 ) {
 	    break;
 	}
 
diff -urN -x CVS kdelibs.orig/kdecore/network/Makefile.am kdelibs/kdecore/network/Makefile.am
--- kdelibs.orig/kdecore/network/Makefile.am	Tue Jun 15 19:13:52 2004
+++ kdelibs/kdecore/network/Makefile.am	Sun Nov  7 20:30:26 2004
@@ -10,7 +10,7 @@
 # the library search path. 
 # convenience lib - no LDFLAGS or LIBADD !
 # Note:
-#  ksocketdevice.cpp must appear before any inclusion of syssocket.h
+#  ksocketdevice.cpp must appear before any inclusion of ksocketdevice.h
 libkdecorenetwork_la_SOURCES = kresolver.cpp \
 		kresolvermanager.cpp \
 		kresolverworkerbase.cpp \
@@ -42,7 +42,8 @@
 	knetworkinterface.h \
 	khttpproxysocketdevice.h \
 	ksockssocketdevice.h \
-	kbufferedsocket.h
+	kbufferedsocket.h \
+	kiobuffer.h
 noinst_HEADERS = kresolver_p.h \
 	kresolverworkerbase.h \
 	kresolverstandardworkers_p.h \
diff -urN -x CVS kdelibs.orig/kdecore/network/kdatagramsocket.cpp kdelibs/kdecore/network/kdatagramsocket.cpp
--- kdelibs.orig/kdecore/network/kdatagramsocket.cpp	Sun Aug  1 04:38:41 2004
+++ kdelibs/kdecore/network/kdatagramsocket.cpp	Thu Nov 18 02:11:38 2004
@@ -1,5 +1,5 @@
 /*  -*- C++ -*-
- *  Copyright (C) 2003 Thiago Macieira <thiago.macieira@kdemail.net>
+ *  Copyright (C) 2003,2004 Thiago Macieira <thiago.macieira@kdemail.net>
  *
  *
  *  Permission is hereby granted, free of charge, to any person obtaining
@@ -34,6 +34,13 @@
 
 using namespace KNetwork;
 
+/*
+ * TODO:
+ *
+ * don't use signals and slots to track state changes: use stateChanging
+ *
+ */
+
 KDatagramSocket::KDatagramSocket(QObject* parent, const char *name)
   : KClientSocketBase(parent, name), d(0L)
 {
@@ -43,6 +50,8 @@
   peerResolver().setSocketType(SOCK_DGRAM);
   localResolver().setSocketType(SOCK_DGRAM);
 
+  localResolver().setFlags(KResolver::Passive);
+
   //  QObject::connect(localResolver(), SIGNAL(finished(KResolverResults)),
   //		   this, SLOT(lookupFinishedLocal()));
   QObject::connect(&peerResolver(), SIGNAL(finished(KResolverResults)),
@@ -199,7 +208,10 @@
     if (connect(*it))
       {
 	// weee, we connected
-	setState(Connected);
+
+	setState(Connected);	// this sets up signals
+	//setupSignals();	// setState sets up the signals
+
 	emit stateChanged(Connected);
 	emit connected(*it);
 	return;
@@ -224,6 +236,7 @@
     if (bind(*it))
       {
 	// bound
+	setupSignals();
 	return true;
       }
 
@@ -234,4 +247,25 @@
   return false;
 }
 
+void KDatagramSocket::setupSignals()
+{
+  QSocketNotifier *n = socketDevice()->readNotifier();
+  if (n)
+    {
+      n->setEnabled(emitsReadyRead());
+      QObject::connect(n, SIGNAL(activated(int)), this, SLOT(slotReadActivity()));
+    }
+  else
+    return;
+
+  n = socketDevice()->writeNotifier();
+  if (n)
+    {
+      n->setEnabled(emitsReadyWrite());
+      QObject::connect(n, SIGNAL(activated(int)), this, SLOT(slotWriteActivity()));
+    }
+  else
+    return;
+}
+
 #include "kdatagramsocket.moc"
diff -urN -x CVS kdelibs.orig/kdecore/network/kdatagramsocket.h kdelibs/kdecore/network/kdatagramsocket.h
--- kdelibs.orig/kdecore/network/kdatagramsocket.h	Thu Jul  8 17:07:07 2004
+++ kdelibs/kdecore/network/kdatagramsocket.h	Thu Nov 18 02:18:36 2004
@@ -1,5 +1,5 @@
 /*  -*- C++ -*-
- *  Copyright (C) 2003 Thiago Macieira <thiago.macieira@kdemail.net>
+ *  Copyright (C) 2003,2004 Thiago Macieira <thiago.macieira@kdemail.net>
  *
  *
  *  Permission is hereby granted, free of charge, to any person obtaining
@@ -263,6 +263,7 @@
 
 private:
   bool doBind();
+  void setupSignals();
 
   KDatagramSocketPrivate *d;
 };
diff -urN -x CVS kdelibs.orig/kdecore/network/kresolver.cpp kdelibs/kdecore/network/kresolver.cpp
--- kdelibs.orig/kdecore/network/kresolver.cpp	Mon Aug 30 02:50:48 2004
+++ kdelibs/kdecore/network/kresolver.cpp	Sat Oct 30 04:46:23 2004
@@ -1,5 +1,5 @@
 /*  -*- C++ -*-
- *  Copyright (C) 2003 Thiago Macieira <thiago.macieira@kdemail.net>
+ *  Copyright (C) 2003,2004 Thiago Macieira <thiago.macieira@kdemail.net>
  *
  *
  *  Permission is hereby granted, free of charge, to any person obtaining
@@ -838,7 +838,7 @@
 QStrList KResolver::serviceName(int port, const char *protoname)
 {
   struct servent *se;
-#ifndef HAVE_GETSERVBYNAME_R
+#ifndef HAVE_GETSERVBYPORT_R
   QMutexLocker locker(&getXXbyYYmutex);
 
   se = getservbyport(port, protoname);
@@ -902,7 +902,8 @@
 
   // 4) for each label, apply ToASCII
   QStringList::Iterator it = input.begin();
-  for ( ; it != input.end(); it++)
+  const QStringList::Iterator end = input.end();
+  for ( ; it != end; ++it)
     {
       QCString cs = ToASCII(*it);
       if (cs.isNull())
@@ -943,7 +944,8 @@
 
   // 4) for each label, apply ToUnicode
   QStringList::Iterator it;
-  for (it = input.begin(); it != input.end(); it++)
+  const QStringList::Iterator end = input.end();
+  for (it = input.begin(); it != end; ++it)
     {
       QString label = ToUnicode(*it).lower();
 
diff -urN -x CVS kdelibs.orig/kdecore/network/kresolvermanager.cpp kdelibs/kdecore/network/kresolvermanager.cpp
--- kdelibs.orig/kdecore/network/kresolvermanager.cpp	Mon Aug 30 02:36:29 2004
+++ kdelibs/kdecore/network/kresolvermanager.cpp	Sat Oct  9 02:10:16 2004
@@ -203,7 +203,7 @@
 // a thread will try maxThreadRetries to get data, waiting at most
 // maxThreadWaitTime milliseconds between each attempt. After that, it'll
 // exit
-static const int maxThreadWaitTime = 20000; // 20 seconds
+static const int maxThreadWaitTime = ULONG_MAX; // wait forever
 static const int maxThreads = 5;
 
 static pid_t pid;		// FIXME -- disable when everything is ok
diff -urN -x CVS kdelibs.orig/kdecore/network/ksocketbase.cpp kdelibs/kdecore/network/ksocketbase.cpp
--- kdelibs.orig/kdecore/network/ksocketbase.cpp	Sun Aug  1 04:39:23 2004
+++ kdelibs/kdecore/network/ksocketbase.cpp	Mon Nov  1 00:55:26 2004
@@ -1,5 +1,5 @@
 /*  -*- C++ -*-
- *  Copyright (C) 2003 Thiago Macieira <thiago.macieira@kdemail.net>
+ *  Copyright (C) 2003,2004 Thiago Macieira <thiago.macieira@kdemail.net>
  *
  *
  *  Permission is hereby granted, free of charge, to any person obtaining
@@ -257,6 +257,7 @@
     {
     case WouldBlock:
     case InProgress:
+    case NoError:
       return false;
     }
 
diff -urN -x CVS kdelibs.orig/kded/kdedmodule.desktop kdelibs/kded/kdedmodule.desktop
--- kdelibs.orig/kded/kdedmodule.desktop	Tue Aug 24 08:29:07 2004
+++ kdelibs/kded/kdedmodule.desktop	Sat Oct 30 08:38:08 2004
@@ -3,12 +3,12 @@
 Type=ServiceType
 X-KDE-ServiceType=KDEDModule
 Comment=KDED Module
-Comment[af]=Kded Module
 Comment[ar]=وحدة KDED
 Comment[az]=KDED Modulu
 Comment[be]=Модуль KDED
 Comment[bg]=Модул KDED
 Comment[bn]=KDED মডিইল
+Comment[br]=Mollad KDED
 Comment[bs]=KDED modul
 Comment[ca]=Mòdul per a KDED
 Comment[cs]=KDED modul
@@ -36,11 +36,12 @@
 Comment[ko]=KDED 모듈
 Comment[lt]=KDED modulis
 Comment[lv]=KDED Modulis
+Comment[mk]=KDED модул
 Comment[mn]=KDED-Модул
 Comment[ms]=Modul KDED
 Comment[mt]=Modulu KDED
 Comment[nb]=KDED-modul
-Comment[nds]=KDED Modul
+Comment[nds]=KDED-Moduul
 Comment[nn]=KDED-modul
 Comment[nso]=Seripa sa KDED
 Comment[pa]=KDED ਮੈਡੀਉਲ
diff -urN -x CVS kdelibs.orig/kded/test/test.desktop kdelibs/kded/test/test.desktop
--- kdelibs.orig/kded/test/test.desktop	Tue Aug 24 08:29:07 2004
+++ kdelibs/kded/test/test.desktop	Sat Oct 30 08:38:09 2004
@@ -42,11 +42,12 @@
 Name[ko]=KDED 시험 모듈
 Name[lt]=KDED testinis modulis
 Name[lv]=KDED Testa Modulis
+Name[mk]=KDED Тест модул
 Name[mn]=KDED-Тест модул
 Name[ms]=Modul Uji KDED
 Name[mt]=Modulu test KDED
 Name[nb]=KDED-testmodul
-Name[nds]=KDED Testmodule
+Name[nds]=KDED-Testmoduul
 Name[nn]=KDED-testmodul
 Name[nso]=Seripa sa Teko ya KDED
 Name[pa]=KDED ਜਾਂਚ ਮੈਡੀਊਲ
@@ -108,11 +109,12 @@
 Comment[ko]=KDED를 시험하는 모듈
 Comment[lt]=KDED testinis modulis
 Comment[lv]=KDED Testa Modulis
+Comment[mk]=Тест модул за KDED
 Comment[mn]=KDED-н тест модул
 Comment[ms]=Modul Uji untuk KDED
 Comment[mt]=Modulu għal testijiet ta' KDED
 Comment[nb]=En test-modul for KDED
-Comment[nds]='n Testmoduul för KDED
+Comment[nds]=En Testmoduul för KDED
 Comment[nl]=Een testmodule voor KDED
 Comment[nn]=Testmodul for KDED
 Comment[nso]=Seripa sa Teko sa KDED
diff -urN -x CVS kdelibs.orig/kdefx/kstyle.cpp kdelibs/kdefx/kstyle.cpp
--- kdelibs.orig/kdefx/kstyle.cpp	Tue Jul 13 21:52:09 2004
+++ kdelibs/kdefx/kstyle.cpp	Thu Nov 18 23:07:32 2004
@@ -1868,27 +1868,28 @@
 	register unsigned char* data = dst.bits();		// Skip alpha
 #endif
 	for(register int i = 0; i < 16; i++) {
-		*data++ = (unsigned char)((*data)*top_right_corner[i]);
-		*data++ = (unsigned char)((*data)*top_right_corner[i]);
-		*data++ = (unsigned char)((*data)*top_right_corner[i]);
+		*data = (unsigned char)((*data)*top_right_corner[i]); data++;
+		*data = (unsigned char)((*data)*top_right_corner[i]); data++;
+		*data = (unsigned char)((*data)*top_right_corner[i]); data++;
 		data++;	// skip alpha
 	}
 
 	pixels -= 32;	// tint right strip without rounded edges.
 	register int c = 0;
 	for(register int i = 0; i < pixels; i++) {
-		*data++ = (unsigned char)((*data)*shadow_strip[c]);
-		*data++ = (unsigned char)((*data)*shadow_strip[c]);
-		*data++ = (unsigned char)((*data)*shadow_strip[c]);
+		*data = (unsigned char)((*data)*shadow_strip[c]); data++;
+		*data = (unsigned char)((*data)*shadow_strip[c]); data++;
+		*data = (unsigned char)((*data)*shadow_strip[c]); data++;
 		data++; // skip alpha
-		c = ++c % 4;
+	        ++c;
+		c %= 4;
 	}
 
 	// tint bottom edge
 	for(register int i = 0; i < 16; i++) {
-		*data++ = (unsigned char)((*data)*bottom_right_corner[i]);
-		*data++ = (unsigned char)((*data)*bottom_right_corner[i]);
-		*data++ = (unsigned char)((*data)*bottom_right_corner[i]);
+		*data = (unsigned char)((*data)*bottom_right_corner[i]); data++;
+		*data = (unsigned char)((*data)*bottom_right_corner[i]); data++;
+		*data = (unsigned char)((*data)*bottom_right_corner[i]); data++;
 		data++;	// skip alpha
 	}
 }
@@ -1913,18 +1914,18 @@
 	{
 		// Bottom-left Corner
 		for(register int x = 0; x < 4; x++) {
-			*data++ = (unsigned char)((*data)*(*corner));
-			*data++ = (unsigned char)((*data)*(*corner));
-			*data++ = (unsigned char)((*data)*(*corner));
+			*data = (unsigned char)((*data)*(*corner)); data++;
+			*data = (unsigned char)((*data)*(*corner)); data++;
+			*data = (unsigned char)((*data)*(*corner)); data++;
 			data++; // skip alpha
 			corner++;
 		}
 
 		// Scanline
 		for(register int x = 0; x < width; x++) {
-			*data++ = (unsigned char)((*data)*strip_data);
-			*data++ = (unsigned char)((*data)*strip_data);
-			*data++ = (unsigned char)((*data)*strip_data);
+			*data = (unsigned char)((*data)*strip_data); data++;
+			*data = (unsigned char)((*data)*strip_data); data++;
+			*data = (unsigned char)((*data)*strip_data); data++;
 			data++;
 		}
 
diff -urN -x CVS kdelibs.orig/kdelibs.lsm kdelibs/kdelibs.lsm
--- kdelibs.orig/kdelibs.lsm	Sun Oct  3 09:19:00 2004
+++ kdelibs/kdelibs.lsm	Sun Nov 28 14:39:50 2004
@@ -1,7 +1,7 @@
 Begin4
 Title:          kdelibs
-Version:        3.3.1
-Entered-date:   2004-10-12
+Version:        3.3.2
+Entered-date:   2004-12-08
 Description:    libraries for the K Desktop Environment (KDE)
 Keywords:       KDE X11 desktop Qt 
 Author:         http://bugs.kde.org/ (KDE Bugtracking System)
diff -urN -x CVS kdelibs.orig/kdeprint/cups/cups.print kdelibs/kdeprint/cups/cups.print
--- kdelibs.orig/kdeprint/cups/cups.print	Tue Aug 31 09:21:17 2004
+++ kdelibs/kdeprint/cups/cups.print	Mon Nov 15 08:54:57 2004
@@ -20,6 +20,7 @@
 Comment[hi]=CUPS (सामान्य यूनिक्स प्रिंट सिस्टम)
 Comment[hr]=CUPS (Common Unix Print System)
 Comment[is]=CUPS (Common Unix Print System)
+Comment[ja]=CUPS (Common UNIX Printing System)
 Comment[ko]=CUPS (공통 유닉스 인쇄 시스템)
 Comment[lt]=CUPS (Bendra Unix Spausdinimo Sistema)
 Comment[mn]=CUPS (Юниксын Ерөнхий Хэвлэх Систем)
diff -urN -x CVS kdelibs.orig/kdeprint/droptionview.cpp kdelibs/kdeprint/droptionview.cpp
--- kdelibs.orig/kdeprint/droptionview.cpp	Mon Mar 15 11:27:38 2004
+++ kdelibs/kdeprint/droptionview.cpp	Fri Oct 29 23:26:12 2004
@@ -33,6 +33,7 @@
 #include <qapplication.h>
 
 #include <kcursor.h>
+#include <kdialog.h>
 #include <klocale.h>
 
 OptionBaseView::OptionBaseView(QWidget *parent, const char *name)
@@ -279,7 +280,6 @@
 DrOptionView::DrOptionView(QWidget *parent, const char *name)
 : QGroupBox(parent,name)
 {
-	//setFixedHeight(150);
 	m_stack = new QWidgetStack(this);
 
 	OptionBaseView	*w = new OptionListView(m_stack);
@@ -305,8 +305,10 @@
 	m_stack->raiseWidget(w);
 	setTitle(i18n("No Option Selected"));
 
-	QVBoxLayout	*main_ = new QVBoxLayout(this, 10, 10);
-	main_->addSpacing(10);
+	setColumnLayout(0, Qt::Vertical );
+	layout()->setSpacing( KDialog::spacingHint() );
+	layout()->setMargin( KDialog::marginHint() );
+	QVBoxLayout	*main_ = new QVBoxLayout(layout(), KDialog::marginHint());
 	main_->addWidget(m_stack);
 
 	m_item = 0;
@@ -353,8 +355,4 @@
 	}
 }
 
-QSize DrOptionView::sizeHint() const
-{
-	return QSize(200,140);
-}
 #include "droptionview.moc"
diff -urN -x CVS kdelibs.orig/kdeprint/droptionview.h kdelibs/kdeprint/droptionview.h
--- kdelibs.orig/kdeprint/droptionview.h	Mon Mar 15 11:27:38 2004
+++ kdelibs/kdeprint/droptionview.h	Fri Oct 29 23:26:12 2004
@@ -117,7 +117,6 @@
 	Q_OBJECT
 public:
 	DrOptionView(QWidget *parent = 0, const char *name = 0);
-	QSize sizeHint() const;
 	void setAllowFixed(bool on) 	{ m_allowfixed = on; }
 
 signals:
diff -urN -x CVS kdelibs.orig/kdeprint/ext/ext.print kdelibs/kdeprint/ext/ext.print
--- kdelibs.orig/kdeprint/ext/ext.print	Tue Aug 24 08:29:11 2004
+++ kdelibs/kdeprint/ext/ext.print	Sat Oct 30 08:38:09 2004
@@ -31,11 +31,12 @@
 Comment[ja]=外部プログラムを通して印刷 (一般的)
 Comment[ko]=바깥 프로그램을 통해 인쇄 (일반)
 Comment[lt]=Spausdinti naudojant išorinę programą (bendra)
+Comment[mk]=Печатење преку надворешен програм (општо)
 Comment[mn]=Гадаад программаар дамжуулан хэвлэх
 Comment[ms]=Cetak Melalui Program Luaran (biasa)
 Comment[mt]=Printja permezz ta' programm estern (ġeneriku)
 Comment[nb]=Skriv ut gjennom et eksternt program (generisk)
-Comment[nds]=Mit''n externen Programm drucken (Standard)
+Comment[nds]=Mit en extern Programm drucken
 Comment[nl]=Afdrukken met behulp van een extern programma (algemeen)
 Comment[nn]=Skriv ut gjennom eit eksternt program (generelt)
 Comment[nso]=Gatisetsa go Lenaneo la Kantle (kakaretso)
diff -urN -x CVS kdelibs.orig/kdeprint/filters/enscript.desktop kdelibs/kdeprint/filters/enscript.desktop
--- kdelibs.orig/kdeprint/filters/enscript.desktop	Tue Aug 31 09:21:17 2004
+++ kdelibs/kdeprint/filters/enscript.desktop	Wed Nov 10 08:36:33 2004
@@ -7,6 +7,7 @@
 Name[hi]=एनस्क्रिप्ट
 Name[lv]=enskript
 Name[mn]=Enscript
+Name[nds]=Enscript
 Name[nl]=Enscript
 Name[nso]=entshwaelo
 Name[ss]=bhala ngamakhodi
@@ -42,13 +43,14 @@
 Comment[id]=Filter Teks Enscript
 Comment[is]=Enscript textasía
 Comment[it]=Filtro di testi Enscript
-Comment[ja]=Enscript テキストフィルター
+Comment[ja]=Enscript テキストフィルタ
 Comment[lt]=Enscript teksto filtras
+Comment[mk]=Enscript текст филтер
 Comment[mn]=Enscript текст шүүлтүүр
 Comment[ms]=Penyaring Teks Enscript
 Comment[mt]=Filtru tat-test Enscript
 Comment[nb]=Enscript tekstfilter
-Comment[nds]=Enscript Textfilter
+Comment[nds]=Enscript-Textfilter
 Comment[nl]=Enscript-tekstfilter
 Comment[nn]=Enscript-tekstfilter
 Comment[nso]=Sesekodi sa Sengwalwana sa Enstshwaelo
diff -urN -x CVS kdelibs.orig/kdeprint/filters/imagetops.desktop kdelibs/kdeprint/filters/imagetops.desktop
--- kdelibs.orig/kdeprint/filters/imagetops.desktop	Tue Aug 31 09:21:17 2004
+++ kdelibs/kdeprint/filters/imagetops.desktop	Sat Oct 30 08:38:10 2004
@@ -7,6 +7,7 @@
 Name[fr]=Imagetops
 Name[hi]=इमेजटॉप्स
 Name[hr]=vrhslike
+Name[nds]=Imagetops
 Name[nl]=Imagetops
 Name[nso]=mabogodimo a diponagalo
 Name[pt_BR]=Imagenstops
@@ -49,11 +50,12 @@
 Comment[ja]=一般的な画像->PSフィルタ
 Comment[ko]=일반 그림을 PS로 바꿔주는 거르개
 Comment[lt]=Bendras filtras iš paveiksliukų į PS
+Comment[mk]=Општ филтер од слика во PS
 Comment[mn]=Ерөнхий зургаас PostScript-файл руу хөрвүүлэх шүүлтүүр
 Comment[ms]=Imej Generik kepada Penyaring PS
 Comment[mt]=Filtru ġeneriku minn stampa għal PS
 Comment[nb]=Bilder til PS-filter
-Comment[nds]=Standardfilter för't umwanneln vun'n Bild na PS
+Comment[nds]=Standardfilter för't ümwanneln vun'n Bild na PostScript
 Comment[nl]=Generieke afbeelding naar PS-filter
 Comment[nn]=Generelt bilete-til-PS-filter
 Comment[nso]=Ponagalo ya Kakaretso go Sesekodi sa PS
diff -urN -x CVS kdelibs.orig/kdeprint/filters/pdfwrite.desktop kdelibs/kdeprint/filters/pdfwrite.desktop
--- kdelibs.orig/kdeprint/filters/pdfwrite.desktop	Tue Aug 24 08:29:11 2004
+++ kdelibs/kdeprint/filters/pdfwrite.desktop	Sat Oct 30 08:38:10 2004
@@ -44,11 +44,12 @@
 Comment[ja]=PDFライター (GhostScriptが必要)
 Comment[ko]=PDF 쓰기 (고스트스크립트가 필요함)
 Comment[lt]=PDF rašiklis (reikalauja GhostScript)
+Comment[mk]=PDF Writer (бара Ghostscript)
 Comment[mn]=PDF-Үүсгэгч (GhostScript хэрэгтэй)
 Comment[ms]=Penulis PDF (perlukan Ghostscript)
 Comment[mt]=Kittieb PDF (jeħtieġ GhostScript)
 Comment[nb]=PDF-skriver (trenger Ghostscript)
-Comment[nds]=PDF Schrieven (bruukt Ghostscript)
+Comment[nds]=PDF-Maker (bruukt Ghostscript)
 Comment[nl]=PDF Writer (heeft ghostscript nodig)
 Comment[nn]=PDF-skrivar (treng GhostScript)
 Comment[nso]=Mongwadi wa PDF (o hloka tshwaelo yaGhost)
diff -urN -x CVS kdelibs.orig/kdeprint/filters/poster.desktop kdelibs/kdeprint/filters/poster.desktop
--- kdelibs.orig/kdeprint/filters/poster.desktop	Tue Aug 31 09:21:17 2004
+++ kdelibs/kdeprint/filters/poster.desktop	Sat Oct 30 08:38:10 2004
@@ -29,10 +29,11 @@
 Comment[ja]=ポスター印刷
 Comment[ko]=포스터 인쇄
 Comment[lt]=Afišų spausdinimas
+Comment[mk]=Печатење постер
 Comment[mn]=Зарлал хэвлэх
 Comment[ms]=Cetakan Poster
 Comment[nb]=Platakutskrift
-Comment[nds]=Plakat drucken
+Comment[nds]=Plakaat drucken
 Comment[nl]=Posterafdruk
 Comment[nn]=Plakatutskrift
 Comment[nso]=Kgatiso ya Seswantsho
@@ -63,6 +64,7 @@
 Comment[zh_TW]=海報列印
 Comment[zu]=Ukushicilela Kwebhodi lezithombe
 Description=Utility to print large posters on multiple small paper sheets. To use this command, the <b>poster</b> executable must be accessible in your <tt>PATH</tt>. Source code for this utility can be on the <a href="http://printing.kde.org/downloads">KDEPrint web site</a>. <p><b><u>WARNING:</u></b> The package found on the KDEPrint web site is a modified version of the original one that can be found on any CTAN archive mirror, but the original package will <b>not</b> work with KDE. You <b>must</b> use the package found on the <a href="http://printing.kde.org/downloads">KDEPrint web site</a>.
+Description[af]=Program wat jou toelaat om groot plakate op veelvuldige kleiner blaaie te druk. Om hierdie opdrag te gebruik moet die <b>poster</b> program in jou <tt>soekpad</tt> beskikbaar wees. Bronkode vir hierdie program is beskikbaar vanaf die <a href="http://printing.kde.org/downloads">KDEPrint web bediener</a>. 
 Description[ar]=أداة لطباعة ملصقات عريضة على أوراق صغيرة عديدة. لإستعمال هذا الأمر، يجب أن يكون البرنامج <b>poster</b> في ال<tt>PATH</tt>. الشفرة المصدرية لهذه الأداة توجد على <a href="http://printing.kde.org/downloads">موقع ويب KDEPrint</a>. <p><b><u>تحذير:</u></b> الحزمة الموجودة على موقع ويب KDEPrint هي نسخة مغيرة من النسخة الأصلية و التي يمكن أن تجدها في أي مرآة ارشيف CTAN، لكن الحزمة الأصلية <b>لن </b> تعمل مع كيدي. يجب استعمال الحزمة الموجودة على <a href="http://printing.kde.org/downloads">موقع ويب KDEPrint</a>.
 Description[az]=Böyük posterləri kiçik kağızlara çap etməyə yardım edən vasitə.
 Description[bg]=Програма за печат на големи постери (плакати) на няколко малки листа. За да използвате командата <b>poster</b>, тя трябва да е в директория описана от системната променлива <tt>PATH</tt>. Изходният код на тази програма може да бъде намерен на страницата на <a href="http://printing.kde.org/downloads">системата за печат в КДЕ</a>. <p><b><u>ВНИМАНИЕ:</u></b> Програмата, която се намира на сайта на КДЕ, е модифицирана версия на оригиналната програма, която може да бъде намерена на в архивите на CTAN. Оригиналната програма <b>НЕ</b> работи със системата за печат в КДЕ. Така, че трябва да използвате модифицираната версия на програмата, която се намира на страницата на <a href="http://printing.kde.org/downloads">системата за печат в КДЕ</a>.
@@ -90,9 +92,11 @@
 Description[ja]=複数の小さい用紙で大きなポスターを印刷するユーティリティです。このコマンドを使用するには <tt>PATH</tt>に<b>poster</b>実行可能ファイルが存在する必要があります。このユーティリティの ソースコードは <a href="http://printing.kde.org/downloads">KDEPrint web site</a>にあります。<p><b><u>警告:</u></b> KDEPrint web site にあるパッケージはオリジナルのCTAN アーカイブミラーにあるものの変更されたバージョンで、オリジナルの ものは KDEでは<b>動きません。</b><b>必ず</b> <a href="http://printing.kde.org/downloads">KDEPrint web site</a>にある パッケージを使用して下さい。
 Description[ko]=큰 포스터를 작은 종이 여러장에 나눠 찍는데 쓰이는 도구입니다. 이 명령을 쓰려면 <tt>PATH</tt>에 <b>poster</b>를 실행할 수 있는 경로가 들어 있어야 합니다. 이 명령은 <a href="http://printing.kde.org/downloads">KDE 인쇄 웹 사이트</a>에서 찾을 수 있습니다. <p><b><u>경고:</u></b> KDE 인쇄 웹 사이트에 있는 꾸러미는 CTAN 저장고 미러에서 내려받은 본디 꾸러미를 고친 것입니다. 본디 꾸러미는 KDE에서 돌아가지 <b>않습니다</b>. 따라서 <b>꼭</b> <a href="http://printing.kde.org/downloads">KDE 인쇄 웹 사이트</a>에 있는 꾸러미를 쓰십시오.
 Description[lt]=Programėlė, skirta didelių afišų ant daugelio mažų popieriaus lapų spausdinimui.  Norint naudoti šią komandą, <b>poster</b> vykdomoji byla turėtų būti jūsų kelyje <tt>PATH</tt>.  Šios programėlės išeities tekstas yra <a href="http://printing.kde.org/downloads">KDEPrint WWW srityje</a>. <p><b><u>PERSPĖJIMAS:</u></b> KDEPrint WWW srityje esantis paketas yra modifikuota originalaus paketo, randamo bet kuriame CTAN archyve, versija, tačiau originalus paketas <b>neveiks</b> su KDE.  Jūs <b>turite</b> naudoti paketą iš <a href="http://printing.kde.org/downloads">KDEPrint WWW srities</a>.
+Description[mk]=Алатка за печатење големи постери на повеќе мали листови хартија.За да ја користите оваа команда, извршната датотека <b>poster</b>мора да е достапна преку Вашиот <tt>PATH</tt>. Изворниот код за оваа алатка може да се најде на <a href="http://printing.kde.org/downloads">KDEPrint веб страницата</a>. <p><b><u>ПРЕДУПРЕДУВАЊЕ:</u></b> Пакетот што се наоѓа на KDEPrint веб страницата е модифицирана верзија на оригиналниот кој може да се најде на било која CTAN огледало-архива, но оригиналниот пакет<b>нема</b> да работи со KDE. <b>Морате</b> да го користите пакетот што сенаоѓа на <a href="http://printing.kde.org/downloads">KDEPrint веб сајтот</a>.
 Description[mn]=Том зарлалыг олон жижиг хуудсууд дээр хэвлэх хэрэгсэл.Энэ тушаалыг хэрэглэхдээ <b>poster</b>-ггүйцэтгэхээр болгохдоо өөрийн<tt>PATH</tt> даа ханддаг болгох ёстой. Энэ хэрэгслийн эх код <a href="http://printing.kde.org/downloads">KDEPrint вэб хуудсанд байгаа байх</a>. <p><b><u>САНАМЖ:</u></b> KDEPrint вэб хуудсанд эх хувилбарын өөрчилөгдсөн хувилбарууд олдох ба CTAN ариваар шахагдаж тус тусын сайтан дээр тавигдсан байгаа.Харин эх пакет КДЭ-тэй <b>ажиллахгүй</b>. Та <a href="http://printing.kde.org/downloads">KDEPrint веб хуудсаас</a> авсан пакетаа хэрэглэх <b>ёстой</b>.
 Description[ms]=Utiliti untuk mencetak poster besar pada banyak helaian kertas. Untuk menggunakan fungsi ini ini, <b>poster</b> boleh laksana mesti ada pada <tt>PATH</tt> anda.Kod sumber untuk utiliti ini ada di <a href="http://printing.kde.org/downloads">Laman KDEPrint</a>. <p><b><u>AMARAN:</u></b> Pakej di laman KDEPrint ialah versi telah diubah dari versi asal yang boleh diperoleh dari mana-mana cermin arkib CTAN. Namun, pakej asal <b>tidak</b> boleh berfungsi dengan KDE. Anda <b>mesti</b> menggunakan pakej yang terdapat di <a href="http://printing.kde.org/downloads">Laman KDEPrint</a>.
 Description[nb]=Hjelpeprogram for å skrive ut store plakater fordelt på mange små papirark. Du må ha <b>poster</b>-programmet i søkestien din, <tt>PATH</tt>. Kildekoden for dette programmet kan hentes fra <a href="http://printing.kde.org/downloads">KDEPrint-siden</a>. <p><b>ADVARSEL</u></b> Pakken som finnes på KDEPrint-siden er en modifisert utgave av originalen som kan finnes på alle CTAN-arkivspeil, men originalen virker <b>ikke</b> med KDE. Du <b>må</b> bruke utgaven fra <a href="http://printing.kde.org/downloads">KDEPrint-siden</a>.
+Description[nds]=Warktüüch, mit dat grote Biller op mennige lütte Sieden druckt warrn kann. Wenn Du dat bruken wullt, mutt dat Programm <b>poster</b> binnen dien <tt>PATH</tt> wesen. De Borncode dorför kann vun de <a href="http://printing.kde.org/downloads">KDEPrint-Nettsiet</a> daallaadt warrn. <p><b><u>WOHRSCHOON:</u></b> Dat Paket vun KDEPrint is en modifizeert Verschoon vun dat Orginaalpaket, dat op jichtenseen CTAN Archiv-Mirror liggt, aver dat Orginaalpaket warrt <b>nich</b> mit KDE arbeiden. Du <b>muttst</b> dat Paket vun de <a href="http://printing.kde.org/downloads">KDEPrint-Nettsiet</a> bruken.
 Description[nl]=Hulpprogramma voor het afdrukken van grote posterformaten op kleine vellen papier. Om dit commando te gebruiken dient het programmma <b>poster</b> zich in uw zoekpad (<tt>$PATH</tt>) te bevinden. De broncode voor dit hulpprogramma kunt u vinden op de <a href="http://printing.kde.org/downloads">website</a> van KDEPrint. <p><b><u>Waarschuwing:</u></b> het pakket dat aangeboden wordt op de website van KDEPrint is een afgeleide versie. Het originele pakket kunt u vinden op elke CTAN-archiefmirror, maar dit pakket zal <b>niet</b> met KDE werken. U kunt <b>alleen</b> het pakket dat aangeboden wordt op de <a href="http://printing.kde.org/downloads">website</a> van KDEPrint gebruiken.
 Description[nn]=Verktøy som let deg skriva ut store plakatar på fleire små ark. For å bruka denne kommandoen, må programmet <b>poster</b> vera tilgjengeleg i søkjestigen (<tt>PATH</tt>). Kjeldekoden til dette verktøyet finn du på <a href="http://printing.kde.org/downloads">nettstaden til KDEPrint</a>. <p><b><u>ÅTVARING:</u></b> Pakken som ligg på KDEPrint-nettstaden er ei tilpassa utgåve av den opphavlege som du kan finna i CTAN-arkivet. Den opphavlege pakken fungerer <b>ikkje</b> med KDE. Du <b>må</b> bruka pakken som ligg på <a href="http://printing.kde.org/downloads">KDEPrint-nettstaden</a>.
 Description[nso]=Sebereka sago gatisa diswantsho tse kgolo go matlakala a mantshi a mannyane. Go somisa taelo ye, phethagatsego ya <b>seswantsho</b> e swanetse go tsenelega kago <tt>TSEJANA</tt> ya gago. Khoutu ya mothopo wa sebereka se ekaba ele go <a href="http://printing.kde.org/downloads">Lefelo la web la Kgatiso ya KDE</a>. <p> <b><u>TEMOSO:</u></b> Pakana yeo e hweditswego kago lefelo la web la Kgatiso ya KDE ke tsweletso yeo e kaonafaditswego ya ya mathomothomo yeo eka hwetswago kago seipone sa polokelo ya CTAN, efela pakana ya mathomothomo e <b>kase</b> beereke le KDE. O <b>swanetse</b> go somisa pakana yeo e hweditswego kago <a href="http://printing.kde.org/downloads">lefelo la web la Kgatiso ya KDE</a>.
@@ -107,7 +111,7 @@
 Description[sl]=Orodje za tiskanje velikih posterjev na majhnih listih papirja. Za uporabo tega ukaza mora biti izvedljiva datoteka <b>poster</b> v vaši poti <tt>PATH</tt>. Izvirna koda za to orodje je na voljo na <a href="http://printing.kde.org/downloads">spletni strani KDEPrint</a>. <p><b><u>OPOZORILO:</u></b> Paket, ki je na strani KDEPrint je spremenjena različica originalne, ki je na voljo na vsakem zrcalnem strežniku arhivov CTAN, vendar pa ta <b>ne</b> dela s KDE. Uporabiti <b>morate</b> paket s <a href="http://printing.kde.org/downloads">spletne strani KDEPrint</a>.
 Description[sq]=Vegël për shtypjen edhe ndarjen e pllakatave në letra të vogla. Për ta përdorur këtë komandë, <b>pllakata</b> ekzekutuese duhet të jetë  e arrijshme në <tt>PATH</tt> e juaj. Kodi burimor për këtë vegël mund të gjindet në <a href="http://printing.kde.org/downloads">Web Faqën KDEPrint</a>. <p><b><u>VËREJTJE:</u></b> Pako e gjetur në web faqën e KDEPrint është verzion i ndryshuar nga origjinali, ky verzion mund të gjindet në çdo web faqe arkivore të CTAN pasqyrave, por verzioni origjinal <b>nuk punon</b> me sistemin KDE. Ju <b>duheni</b> ta përdorni pakon që gjendet në këtë web faqe: <a href="http://printing.kde.org/downloads">Web Faqja KDEPrint</a>.
 Description[sr]=Алатка за штампање великих постера на више малих папира. Да би сте користили ову наредбу, извршни фајл <b>poster</b> мора бити приступачан кроз ваш <tt>PATH(путању)</tt>. Изворни код овог алата можете наћи на <a href="http=://printing.kde.org/downloads">KDEPrint веб сајту</a>. <p><b><u>Упозорење:</u></b> Пакет који се налази на KDE Print веб сајту је измењена верзија оригинала који се може наћи на било ком CTAN огледалу, али оригинални пакет <b>неће</b> радити са KDE-ом. <b>Морате</b> користити пакет са <a href="http://printing.kde.org/downloads">KDEPrint веб сајта</a>.
-Description[sr@Latn]=Alatka za štampanje velikih postera na više malih papira. Da bi ste koristili ovu naredbu, <b>poster</b> izvršni fajl mora biti pristupačan kroz vaš <tt>PATH(putanju)</tt>. Izvorni kod ovog alata možete naći na <a href=" http=://printing.kde.org/downloads">KDEPrint veb sajtu</a>. <p><b><u>Upozorenje:</u></b> Paket koji se nalazi na KDE Print veb sajtu je izmenjena verzija originala koji se može naći na bilo kom CTAN ogledalu, ali originalni paket <b>neće</b> raditi sa KDE-om. <b>Morate</b> koristiti paket sa <a href="http://printing.kde.org/downloads">KDEPrint veb sajta</a>.
+Description[sr@Latn]=Alatka za štampanje velikih postera na više malih papira. Da bi ste koristili ovu naredbu, izvršni fajl <b>poster</b> mora biti pristupačan kroz vaš <tt>PATH(putanju)</tt>. Izvorni kod ovog alata možete naći na <a href="http=://printing.kde.org/downloads">KDEPrint veb sajtu</a>. <p><b><u>Upozorenje:</u></b> Paket koji se nalazi na KDE Print veb sajtu je izmenjena verzija originala koji se može naći na bilo kom CTAN ogledalu, ali originalni paket <b>neće</b> raditi sa KDE-om. <b>Morate</b> koristiti paket sa <a href="http://printing.kde.org/downloads">KDEPrint veb sajta</a>.
 Description[sv]=Verktyg för att skriva ut stora affischer på flera små blad. För att använda kommandot måste det körbara programmet <b>poster</b> vara tillgängligt i <tt>PATH</tt>. Källkod för detta verktyg kan finnas på <a href="http://printing.kde.org/downloads">KDEPrints webbplats</a>. <p><b><u>Varning:</u></b> Paketet som finns på KDEPrints webbplats är en ändrad version av originalet som finns på alla CTAN-arkivplatser. Men originalpaketet fungerar <b>inte</b> med KDE, man <b>måste</b> använda paketet som finns på <a href="http://printing.kde.org/downloads">KDEPrints webbplats</a>.
 Description[ta]=பலவித சிறிய தாள்களில் பெரிய போஸ்டர்களை அச்சிப்பதற்கான பயன்பாடு. இந்த கட்டளையை பயன்படுத்த <b>போஸ்டர் </b>நிறுவல் அணுகக்கூடியதாக <tt>உங்கள் பாதை இருக்க வேண்டும்</tt>. இந்த பயன்பாட்டுக்கான மூல குறியீடு கேடிஇஅச்சு வலைதளத்தில் <a href="http://printing.kde.org/downloads">இருக்கும்</a>. <p><b><u>எச்சரிக்கை:</u></b>கேடிஇ அச்சு வலைத்தளத்தில் காணப்படும் தொகுப்பு மாற்றப்பட்டுள்ளது. இது எல்லா CTAN காப்பத்திலும் காணப்படும்.ஆனால் அசல் தொகுப்பு கேடிஇயுடன் இயங்காது.நீங்கள் <b></b> <a href="http://printing.kde.org/downloads">கேடிஇஅச்சு வலைதளத்தில்</a> உள்ள தொகுப்பைத்தான் பயன்படுத்த வேண்டும்</a>.
 Description[tg]=Барномаҳои барои чопи сатроҳои бузург барои сафҳоти коғаз купак барои истифода аз ин дастури<b>poster</b> бояд дар<tt>PATH-и</tt> шумо кобали дастурӣ бошад . Коди марҷа ин обзор метавонад дар<a href="http://printing.kde.org/downloads"> KDEPrint сйти Вэб ёфта шавад.</a>. <p><b><u>Огоҳӣ:</u></b> Пакете, ки нусхаи таъғиршуда буд, дар Вэби KDEPrint ёфта шуд , ва он дар ягон CTAN archive mirror мумкин аст ки ёбад ,лекин нусхаи аслиаш <b>дар KDE</b> кор намекунад. Шумо<b>бояд</b> пакети ёфташударо истифода кунед дар<a href="http://printing.kde.org/downloads">KDEPrint web site</a>.
diff -urN -x CVS kdelibs.orig/kdeprint/filters/ps2pdf.desktop kdelibs/kdeprint/filters/ps2pdf.desktop
--- kdelibs.orig/kdeprint/filters/ps2pdf.desktop	Tue Aug 24 08:29:12 2004
+++ kdelibs/kdeprint/filters/ps2pdf.desktop	Sat Oct 30 08:38:10 2004
@@ -36,11 +36,12 @@
 Comment[ja]=PostScriptからPDFへの変換ツール
 Comment[ko]=포스트스크립트를 PDF 문서로 바꿔줍니다
 Comment[lt]=PostScript į PDF konverteris
+Comment[mk]=Конвертор од PostScript во PDF
 Comment[mn]=PostScript-ээс PDF-рүү хөрвүүлэлэгч
 Comment[ms]=Pengubah PostScript ke PDF
 Comment[mt]=Konvertitur PostScript għal PDF
 Comment[nb]=Postscript/PDF-dokumentkonvertering
-Comment[nds]=koverteert PostScript na PDF
+Comment[nds]=konverteert PostScript na PDF
 Comment[nl]=Conversie van PostScript naar PDF
 Comment[nn]=Konvertering mellom PostScript og PDF
 Comment[nso]=Mofetosetsi wa PostScript go PDF
diff -urN -x CVS kdelibs.orig/kdeprint/filters/psbook.desktop kdelibs/kdeprint/filters/psbook.desktop
--- kdelibs.orig/kdeprint/filters/psbook.desktop	Tue Aug 24 08:29:12 2004
+++ kdelibs/kdeprint/filters/psbook.desktop	Sat Oct 30 08:38:10 2004
@@ -40,10 +40,12 @@
 Comment[it]=Stampa libretto (da usare con la stampa fronte/retro dal lato corto)
 Comment[ja]=小冊子の印刷 - (端の短い折り重ね印刷を使用)
 Comment[lt]=Brošiūros spausdinimas (naudokite dvipusiam spausdinimui)
+Comment[mk]=Печатење памфлет (за користење со дуплекс печатење од помалата страна)
 Comment[mn]="Pamphlet"-хэвлэх: (Жижгээр хоёр талаар хэвлэхэд хэрэглэ)
 Comment[ms]=Cetakan Pamplet (guna cetakan dupleks sisi kecil)
 Comment[mt]=Printjar ta' fuljett (uża printjar dupleks min-naħa l-qasira)
 Comment[nb]=Brosjyreutskrift (brukes for dobbeltsidig utskrift med liten papirstørrelse)
+Comment[nds]=Lütte Böker drucken (mit Duplexdruck för smalle Sieden bruken)
 Comment[nl]=Pamflet afdrukken (gebruik i.c.m. smalle kant duplexafdruk)
 Comment[nn]=Brosjyreutskrift (bruk ved dupleksutskrift på små sider)
 Comment[nso]=Kgatiso ya Pamphlet (sumisa le kgatiso ya duplex ya lehlakori le lennyane)
diff -urN -x CVS kdelibs.orig/kdeprint/filters/psbook1.desktop kdelibs/kdeprint/filters/psbook1.desktop
--- kdelibs.orig/kdeprint/filters/psbook1.desktop	Tue Aug 24 08:29:12 2004
+++ kdelibs/kdeprint/filters/psbook1.desktop	Sat Oct 30 08:38:10 2004
@@ -42,10 +42,12 @@
 Comment[it]=Stampa libretto - pagine pari (passo 1)
 Comment[ja]=小冊子の印刷 - 偶数ページ (ステップ 1)
 Comment[lt]=Brošiūros spausdinimas – lyginiai puslapiai (1 žingsnis)
+Comment[mk]=Печатење памфлет - парни страници (чекор 1)
 Comment[mn]="Pamphlet"-Хэвлэх: Тэгш хуудсуудаар (Алхам 1)
 Comment[ms]=Cetakan Pamplet   Muka Genap (langkah 1)
 Comment[mt]=Printjar ta' fuljett - paġni żewġ (pass 1)
 Comment[nb]=Brosjyre-utskrift - like sider (steg 1)
+Comment[nds]=Lütte Böker drucken - evene Sieden (Stoop 1)
 Comment[nl]=Pamflet afdrukken -  even pagina's (stap 1)
 Comment[nn]=Brosjyreutskrift – partalssider (steg 1)
 Comment[nso]=Kgatiso ya Pamphlet - Matlakala a Even (kgato 1)
diff -urN -x CVS kdelibs.orig/kdeprint/filters/psbook2.desktop kdelibs/kdeprint/filters/psbook2.desktop
--- kdelibs.orig/kdeprint/filters/psbook2.desktop	Tue Aug 24 08:29:12 2004
+++ kdelibs/kdeprint/filters/psbook2.desktop	Sat Oct 30 08:38:10 2004
@@ -42,10 +42,12 @@
 Comment[it]=Stampa libretto - pagine dispari (passo 2)
 Comment[ja]=小冊子の印刷 - 奇数ページ (ステップ 2)
 Comment[lt]=Brošiūros spausdinimas – nelyginiai puslapiai (2 žingsnis)
+Comment[mk]=Печатење памфлет - непарни страници (чекор 2)
 Comment[mn]="Pamphlet"-Хэвлэх: Сондгой хуудсуудаар (Алхам 2)
 Comment[ms]=Cetakan Pamplet   Muka Genap (langkah 2)
 Comment[mt]=Printjar ta' fuljett - paġni fard (pass 2)
 Comment[nb]=Brosjyre-utskrift - odde sider (steg 2)
+Comment[nds]=Lütte Böker drucken - unevene Sieden (Stoop 2)
 Comment[nl]=Pamflet afdrukken - oneven pagina's (stap 2)
 Comment[nn]=Brosjyreutskrift – oddetalssider (steg 2)
 Comment[nso]=Kgatiso ya Pamphlet - Matlakala a Odd (kgato 2)
diff -urN -x CVS kdelibs.orig/kdeprint/filters/psnup.desktop kdelibs/kdeprint/filters/psnup.desktop
--- kdelibs.orig/kdeprint/filters/psnup.desktop	Tue Aug 31 09:21:17 2004
+++ kdelibs/kdeprint/filters/psnup.desktop	Sat Oct 30 08:38:10 2004
@@ -32,10 +32,12 @@
 Comment[ja]=シートフィルタ毎に複数ページ
 Comment[ko]=여러 쪽으로 나눠주는 거르개
 Comment[lt]=Kelių puslapių popieriaus lakšte filtras
+Comment[mk]=Филтер за повеќе страници по лист
 Comment[mn]=Олон хуудасыг нэг цаасан дээр хэвлэх үеийн шүүлтүүр
 Comment[ms]=Penapis Pelbagai Laman setiap Helaian
 Comment[mt]=Filtru għal iżjed minn paġna waħda fuq kull karta
 Comment[nb]=Filter for flere sider på hvert ark
+Comment[nds]=Mehr as een Siet pro Blatt drucken
 Comment[nl]=Meerdere pagina's per vel afdrukken
 Comment[nn]=Filter for fleire sider på kvart ark
 Comment[nso]=Matlakala A Mantshintshi ka Sesekodi sa Letlakala
diff -urN -x CVS kdelibs.orig/kdeprint/filters/psresize.desktop kdelibs/kdeprint/filters/psresize.desktop
--- kdelibs.orig/kdeprint/filters/psresize.desktop	Tue Aug 24 08:29:12 2004
+++ kdelibs/kdeprint/filters/psresize.desktop	Sun Oct 24 09:01:53 2004
@@ -46,7 +46,7 @@
 Comment[ms]=Skala Cetak Kandungan untuk menepati Saiz Kertas Lain
 Comment[mt]=Kabbar/ċekken id-daqs ta'l-print biex joqgħod fuq karta ta' daqs differenti
 Comment[nb]=Tilpass utskriften til en annen papirstørrelse
-Comment[nds]=Dat, wat Du drucken wullt för een annere Papeergrött gaatlich maken
+Comment[nds]=Dat, wat Du drucken wullt, för'n annere Papeergrött gaatlich maken
 Comment[nl]=Schaal de afdrukinhoud zodat deze past op een andere papierformaat
 Comment[nn]=Skaler utskrifta til ein annan papirstorleik
 Comment[nso]=Kala Bokagare bja Kgatiso gore bo Lekanele go Bogolo bjo Bongwe bja Letlakala
diff -urN -x CVS kdelibs.orig/kdeprint/filters/psselect.desktop kdelibs/kdeprint/filters/psselect.desktop
--- kdelibs.orig/kdeprint/filters/psselect.desktop	Tue Aug 31 09:21:17 2004
+++ kdelibs/kdeprint/filters/psselect.desktop	Mon Nov 15 08:54:57 2004
@@ -38,9 +38,10 @@
 Comment[hu]=Oldalkijelölő és -rendező szűrő
 Comment[is]=Síðuval / röðunarsía
 Comment[it]=Filtro per la selezione e l'ordinamento delle pagine
-Comment[ja]=ページ選択/並べ替えフィルター
+Comment[ja]=ページ選択/並べ替えフィルタ
 Comment[ko]=쪽을 고르거나 정렬하는 거르개
 Comment[lt]=Puslapių pasirinkimo/rūšiavimo filtras
+Comment[mk]=Филтер за селекција/подредување на страници
 Comment[mn]=Хуудасны сонголт болон дарааллыг шүүх
 Comment[ms]=Penapis Pilihan Laman/Susunan
 Comment[mt]=Filtru biex tagħżel/tissortja l-karti
diff -urN -x CVS kdelibs.orig/kdeprint/kdeprintd.desktop kdelibs/kdeprint/kdeprintd.desktop
--- kdelibs.orig/kdeprint/kdeprintd.desktop	Mon Sep 20 15:53:16 2004
+++ kdelibs/kdeprint/kdeprintd.desktop	Fri Nov 12 08:27:50 2004
@@ -45,7 +45,7 @@
 Name[ms]=Daemon Cetak KDE
 Name[mt]=Proċess tal-ipprintjar KDE
 Name[nb]=KDE-utskriftsnisse
-Name[nds]=KDE Druck-Dämon
+Name[nds]=KDE Druck-Dämoon
 Name[nn]=KDE-utskriftsnisse
 Name[nso]=Daemon ya Kgatiso ya KDE
 Name[pa]=KDE ਪ੍ਰਿੰਟਰ ਡਾਈਮੋਨ
@@ -75,6 +75,7 @@
 Name[zh_TW]=KDE 列印伺服程式
 Name[zu]= I-Daemon Yokushicilela kwe-KDE
 Comment=Print daemon for KDE
+Comment[af]=Druk Bediener vir KDE
 Comment[bg]=Демон за печат в КДЕ
 Comment[bn]=কে.ডি.ই-র মুদ্রণ ডিমন
 Comment[bs]=Demon za štampu za KDE
@@ -86,12 +87,16 @@
 Comment[et]=KDE trükkimise deemon
 Comment[fi]=KDE:n tulostuspalvelin
 Comment[fr]=Un démon d'impression pour KDE
+Comment[ga]=Deamhan priontála le haghaidh KDE
 Comment[he]=תהליך רקע של KDE להדפסה
 Comment[hu]=Nyomtatószolgáltatás a KDE-hez
 Comment[is]=Prentþjónn fyrir KDE
 Comment[it]=Demone di stampa per KDE
 Comment[ja]=KDE用の印刷デーモン
+Comment[lt]=Spausdinimo tarnyba, skirta KDE
+Comment[mk]=KDE даемон за печатење
 Comment[nb]=Utskriftsnisse for KDE
+Comment[nds]=Een Druck-Dämoon för KDE
 Comment[nl]=Printer-daemon voor KDE
 Comment[nn]=Utskriftsnisse for KDE
 Comment[pa]=KDE ਲਈ ਪ੍ਰਿੰਟਰ ਡਾਈਮੋਨ
@@ -99,11 +104,12 @@
 Comment[pt]=Servidor de impressão para o KDE
 Comment[pt_BR]=Serviço de Impressão para o KDE
 Comment[ro]=Demon de tipărire KDE
+Comment[ru]=Демон печати KDE
 Comment[se]=KDE:a čálihanbálvá
 Comment[sk]=Démon tlače pre KDE
 Comment[sl]=Tiskalniški strežnik za KDE
 Comment[sr]=KDE-ов демон за штампање
-Comment[sr@Latn]=KDE-ов демон за штампање
+Comment[sr@Latn]=KDE-ov demon za štampanje
 Comment[sv]=Skrivardemon för KDE
 Comment[ta]=கேடிஇக்கான ஒரு அச்ச் டெமான்
 Comment[tg]=Демони Чопкардан барои KDE
diff -urN -x CVS kdelibs.orig/kdeprint/lpd/lpd.print kdelibs/kdeprint/lpd/lpd.print
--- kdelibs.orig/kdeprint/lpd/lpd.print	Tue Aug 31 09:21:18 2004
+++ kdelibs/kdeprint/lpd/lpd.print	Sat Oct 30 08:38:10 2004
@@ -32,6 +32,7 @@
 Comment[ko]=LPR (표준 BSD 인쇄 시스템)
 Comment[lt]=LPR (Standartinė BSD spausdinimo sistema)
 Comment[lv]=LPR (Standarta BSD drukas sistēma)
+Comment[mk]=LPR (Стандардниот BSD систем за печатење)
 Comment[mn]=LPR (Стандарт BSD-Хэвлэх систем)
 Comment[ms]=LPR (Sistem cetak piawai BSD)
 Comment[mt]=LPR (sistema tal-ipprintjar standard BSD)
diff -urN -x CVS kdelibs.orig/kdeprint/lpdunix/lpdunix.print kdelibs/kdeprint/lpdunix/lpdunix.print
--- kdelibs.orig/kdeprint/lpdunix/lpdunix.print	Tue Aug 24 08:29:13 2004
+++ kdelibs/kdeprint/lpdunix/lpdunix.print	Sat Oct 30 08:38:11 2004
@@ -31,11 +31,12 @@
 Comment[ja]=一般的な UNIX LPD 印刷システム (標準)
 Comment[ko]=보통 유닉스 LPD 인쇄 시스템 (기본)
 Comment[lt]=Bendra UNIX LPD spausdinimo sistema (numatyta)
+Comment[mk]=Општ UNIX LPD систем за печатење (стандардно)
 Comment[mn]=UNIX-LPD-Хэвлэх систем (Стандарт)
 Comment[ms]=Sistem Cetak UNIX LPD Generik (default)
 Comment[mt]=Sistema ġenerika tal-ipprintjar Unix LPD (standard)
 Comment[nb]=Vanlig UNIX LPD skriversystem (standard)
-Comment[nds]=Dat allgemeene Drucksysteem vun UNIX LPD(is ook de Standard)
+Comment[nds]=Dat normale LPD-Drucksysteem vun UNIX (Standard)
 Comment[nl]=Generiek UNIX LPD-afdruksysteem (standaard)
 Comment[nn]=Generelt UNIX LPD-utskriftssystem (standard)
 Comment[nso]=System ya Kgatiso ya LPD ya UNIX ya Kakaretso (thuso ya tshoganetso)
diff -urN -x CVS kdelibs.orig/kdeprint/lpr/lpr.print kdelibs/kdeprint/lpr/lpr.print
--- kdelibs.orig/kdeprint/lpr/lpr.print	Tue Aug 24 08:29:13 2004
+++ kdelibs/kdeprint/lpr/lpr.print	Sat Oct 30 08:38:11 2004
@@ -31,6 +31,7 @@
 Comment[ja]=LPR/LPRng 印刷システム
 Comment[ko]=LPR/LPRng 인쇄 시스템
 Comment[lt]=LPR/LPRng spausdinimo sistema
+Comment[mk]=LPR/LPRng системот за печатење
 Comment[mn]=LPR/LPRng-Хэвлэх систем
 Comment[ms]=Sistem Cetak LPR/LPRng
 Comment[mt]=Sistema tal-ipprintjar LPR/LPRng
diff -urN -x CVS kdelibs.orig/kdeprint/rlpr/rlpr.print kdelibs/kdeprint/rlpr/rlpr.print
--- kdelibs.orig/kdeprint/rlpr/rlpr.print	Tue Aug 24 08:29:13 2004
+++ kdelibs/kdeprint/rlpr/rlpr.print	Sat Oct 30 08:38:11 2004
@@ -29,11 +29,12 @@
 Comment[ja]=RLPR 環境 (リモートLPDサーバ)
 Comment[ko]=RLPR 환경 (원격지 LPD 서버)
 Comment[lt]=RLPR aplinka (nutolę LPD serveriai)
+Comment[mk]=RLPR околина (оддалечени LPD сервери)
 Comment[mn]=RLPR-орчин (алсын LPD-Сервер)
 Comment[ms]=Persekitaran RLPR (Pelayan LPD jauh)
 Comment[mt]=Ambjent RLPR (servers LPD remoti)
 Comment[nb]=RLPR-miljø (LPD-tjenere over nettverk)
-Comment[nds]=RLPR-Ümkrink (för aflegene LPD-Servers)
+Comment[nds]=RLPR-Ümkrink (LPD-Server op'n annern Reekner)
 Comment[nl]=RLPR-omgeving (LPD-servers op afstand)
 Comment[nn]=RLPR-miljø (LPD-tenarar over nettverk)
 Comment[nso]=Tikologo ya RLPR (Baabi remote ba LPD)
diff -urN -x CVS kdelibs.orig/kdeprint/specials.desktop kdelibs/kdeprint/specials.desktop
--- kdelibs.orig/kdeprint/specials.desktop	Sun Sep 12 15:55:55 2004
+++ kdelibs/kdeprint/specials.desktop	Sun Nov 28 09:33:03 2004
@@ -35,6 +35,7 @@
 Name[ja]=ファイルに出力 (PostScript)
 Name[ko]=(포스트스크립트) 파일로 찍기
 Name[lt]=Spausdinti į bylą (PostScript)
+Name[mk]=Печати во датотека (PostScript)
 Name[mn]=Файл руу хэвлэх (PostScript)
 Name[ms]= Cetak ke Fail (PostScript)
 Name[mt]=Printja ġo fajl (PostScript)
@@ -103,6 +104,7 @@
 Description[ko]=포스트스크립트 파일로 씁니다
 Description[lt]=Rašyti Postscript bylą
 Description[lv]=Rakstīt PostSkript failā
+Description[mk]=Запиши PostScript датотека
 Description[mn]=PostScript-файл бичих
 Description[ms]=Tulis fail PostScript
 Description[mt]=Ikteb fajl PostScript
@@ -145,6 +147,7 @@
 Comment[be]=Лякальны файл
 Comment[bg]=Локален файл
 Comment[bn]=স্থানীয় ফাইল
+Comment[br]=Restr lec'hel
 Comment[bs]=Lokalna datoteka
 Comment[ca]=Fitxer local
 Comment[cs]=Lokální soubor
@@ -172,11 +175,12 @@
 Comment[ko]=울 안 파일
 Comment[lt]=Vietinė byla
 Comment[lv]=Lokāls fails
+Comment[mk]=Локална датотека
 Comment[mn]=локал файл
 Comment[ms]=Fail setempat
 Comment[mt]=Fajl lokali
 Comment[nb]=Lokal fil
-Comment[nds]=lokale Datei
+Comment[nds]=Lokale Datei
 Comment[nl]=Lokaal bestand
 Comment[nn]=Lokal fil
 Comment[nso]=Faele ya selegae
@@ -247,6 +251,7 @@
 Name[ja]=ファイルに出力 (PDF)
 Name[ko]=(PDF) 파일로 찍기
 Name[lt]=Spausdinti į bylą (PDF)
+Name[mk]=Печати во датотека (PDF)
 Name[mn]=Файл руу хэвлэх (PDF/Acrobat)
 Name[ms]= Cetak ke Fail(PDF)
 Name[mt]=Printja ġo fajl (PDF)
@@ -315,6 +320,7 @@
 Description[ko]=PDF/아크로뱃 파일로 씁니다
 Description[lt]=Rašyti PDF/Acrobat bylą
 Description[lv]=Rakstīt PDF/Akrobāta failā
+Description[mk]=Запиши PDF/Acrobat датотека
 Description[mn]=PDF-файл (Acrobat-Format) бичих
 Description[ms]=Tulis fail PDF/Acrobat
 Description[mt]=Ikteb fajl PDF/Acrobat
@@ -357,6 +363,7 @@
 Comment[be]=Лякальны файл
 Comment[bg]=Локален файл
 Comment[bn]=স্থানীয় ফাইল
+Comment[br]=Restr lec'hel
 Comment[bs]=Lokalna datoteka
 Comment[ca]=Fitxer local
 Comment[cs]=Lokální soubor
@@ -384,11 +391,12 @@
 Comment[ko]=울 안 파일
 Comment[lt]=Vietinė byla
 Comment[lv]=Lokāls fails
+Comment[mk]=Локална датотека
 Comment[mn]=локал файл
 Comment[ms]=Fail setempat
 Comment[mt]=Fajl lokali
 Comment[nb]=Lokal fil
-Comment[nds]=lokale Datei
+Comment[nds]=Lokale Datei
 Comment[nl]=Lokaal bestand
 Comment[nn]=Lokal fil
 Comment[nso]=Faele ya selegae
@@ -434,6 +442,7 @@
 Name[be]=Даслаць па факсу
 Name[bg]=Изпращане към факс
 Name[bn]=ফ্যাক্সে পাঠাও
+Name[br]=Kas d'ar faks
 Name[bs]=Šalji na fax
 Name[ca]=Envia al Fax
 Name[cs]=Poslat na fax
@@ -457,9 +466,10 @@
 Name[id]=Kirim sebagai Faks
 Name[is]=Senda á faxið
 Name[it]=Invia al fax
-Name[ja]=Faxに送信
+Name[ja]=Faxへ送信
 Name[ko]=팩스로 보내기
 Name[lt]=Siųsti į faksą
+Name[mk]=Прати на факс
 Name[mn]=Факс руу гаргах
 Name[ms]=Kirim ke Faks
 Name[mt]=Ibgħat bħala fax
@@ -526,6 +536,7 @@
 Description[ko]=바깥에 있는 팩스 시스템으로 보냅니다
 Description[lt]=Siųsti į išorinę fakso sistemą
 Description[lv]=Sūtīt uz ārējo faksa sistēmu
+Description[mk]=Испрати на надворешен факс-систем
 Description[mn]=Гадаад факсын систем рүү илгээх
 Description[ms]=Kirim ke sistem faks luaran
 Description[mt]=Ibgħat lis-sistema esterna tal-fax
@@ -594,6 +605,7 @@
 Comment[ko]=바깥
 Comment[lt]=Išorinė
 Comment[lv]=Ārējs
+Comment[mk]=Надворешно
 Comment[mn]=Гадаад
 Comment[ms]=Luaran
 Comment[mt]=Estern
@@ -668,11 +680,12 @@
 Comment[ko]=KDE 편지용 편집기로 덧붙여 보냅니다
 Comment[lt]=KMail rašyklės priesaga
 Comment[lv]=Pielikums KPasta Veidotājam
+Comment[mk]=Додаток за составувачот во KMail
 Comment[mn]=KMail-боловсруулагчийн хавсрага
 Comment[ms]=Kepilan untuk Penggubah KMail
 Comment[mt]=Abbinament għall-kompożitur KMail
 Comment[nb]=Vedlegg for e-postredigering i KMail
-Comment[nds]=Bilaag för KMail Composer
+Comment[nds]=Bilaag för den KMail-Editor
 Comment[nl]=Bijlage voor KMail Opsteller
 Comment[nn]=Vedlegg for e-postredigering i KMail
 Comment[nso]=Kgwathiso ya Mohlagisi wa KPoso
@@ -735,6 +748,7 @@
 Description[ko]=KDE 편지에 덧붙일 PDF/어크로뱃 파일로 만듭니다
 Description[lt]=Rašyti PDF/Acrobat bylą kaip priesagą KMail programai
 Description[lv]=Izveido PDF/Akrobāta failu kā pielikumu KPastam
+Description[mk]=Создава PDF/Acrobat датотека како додаток за KMail
 Description[mn]=PDF-файл (Acrobat-Format) KMail-н хувьд хавсрагаар үүсгэх
 Description[ms]=Cipta fail PDF/Acrobat sebagai kepilan untuk KMail
 Description[mt]=Joħloq fajl PDF/Acrobat bħala abbinament għall-KMail
@@ -775,6 +789,7 @@
 File=1
 Icon=kmail
 Name=Mail PDF File
+Name[af]=Pos PDF Lêer
 Name[be]=Даслаць PDF файл
 Name[bg]=Изпращане на файл PDF по е-поща
 Name[bn]=পি-ডি-এফ ফাইল মেইল করো
@@ -793,6 +808,8 @@
 Name[is]=Senda PDF skrá í pósti
 Name[it]=Spedisci file PDF
 Name[ja]=PDFファイルをメール
+Name[lt]=Pašto PDF byla
+Name[mk]=PDF по е-пошта
 Name[nb]=Send PDF-fil
 Name[nds]=PDF-Datei as Nettbreef afschicken
 Name[nl]=PDF-bestand e-mailen
@@ -802,11 +819,12 @@
 Name[pt]=Enviar PDF por E-mail
 Name[pt_BR]=Enviar por E-Mail Arquivo PDF
 Name[ro]=Trimite prin mail ca PDF
+Name[ru]=Отправить PDF файл
 Name[se]=Sádde PDF-fiilla
 Name[sk]=Poslať súbor PDF
 Name[sl]=Pošlji datoteko PDF po pošti
 Name[sr]=Слање PDF фајла поштом
-Name[sr@Latn]=Слање PDF фајла поштом
+Name[sr@Latn]=Slanje PDF fajla poštom
 Name[sv]=Skicka PDF-fil
 Name[ta]=PDF கோப்பை அஞ்சல் அனுப்பு
 Name[tg]=Файли почтавии PDF
@@ -834,6 +852,7 @@
 Comment[uz]=Факс жўнатиш
 Comment[ven]=K i rumela Fekisi
 Description=Use ksendfax to fax the current document
+Description[af]=Gebruik ksendfax om die huidige dokument te faks
 Description[ar]=استخدم ksendfax ﻹرسال المستند الحالي بالفاكس
 Description[az]=Hazırkı sənədi fakslamaq üçün ksendfax vasitəsini işlədin
 Description[bg]=Изпращане по факс на документа
@@ -862,11 +881,12 @@
 Description[ja]=ksendfax は現在のドキュメントをFaxするのに使います
 Description[ko]=현재 문서를 팩스로 보내기 위해 ksendfax를 씁니다
 Description[lt]=Naudoja ksendfax esamam dokumentui siųsti faksu
+Description[mk]=Испраќање на тековниот документ по факс со ksendfax
 Description[mn]=Энэ баримтыг факсдахдаа ksendfax-г хэрэглэ
 Description[ms]=Guna ksendfax untuk faks dokumen sekarang
 Description[mt]=Uża ksendfax biex tiffaksja d-dokument kurrenti
 Description[nb]=Bruk ksendfax for å fakse det aktive dokumentet
-Description[nds]=Dat aktuelle Dokment mit ksendfax as Fax afschicken
+Description[nds]=Dat aktuelle Dokment mit ksendfax as Fax schicken
 Description[nl]=Gebruik KSendFax voor het faxen van het huidige document
 Description[nn]=Bruk ksendfax til å faksa dokument
 Description[nso]=Somisa ksendfax go faxa tokomane ya bjale
@@ -881,7 +901,7 @@
 Description[sl]=Uporabite kdsendfax za faksiranje trenutnega dokumenta
 Description[sq]=Përdor ksendfax për ta dërguar dokumentin aktual me faks
 Description[sr]=Користите ksendfax да пошаљте текући документ на факс
-Description[sr@Latn]=Koristi ksendfax da pošalje tekući dokument na faks.
+Description[sr@Latn]=Koristite ksendfax da pošaljte tekući dokument na faks
 Description[ss]=Sebentisa i-ksendfax kutfumela ngefax kwelidokhumente lanyalo
 Description[sv]=Använd Ksendfax för att faxa aktuellt dokument
 Description[ta]=கேஃபாக்ஸ்அனுப்பு மூலம் நடப்பு ஆவணத்தை தொலைநகலிடு
@@ -899,6 +919,7 @@
 File=0
 Icon=kdeprintfax
 Name=Advanced Faxing Tool (ksendfax)
+Name[af]=Gevorderde Faks Program (ksendfax)
 Name[ar]=أداة إرسال فاكس متقدمة (ksendfax)
 Name[az]=Təkmilləşmiş Faks Vasitəsi (ksendfax)
 Name[bg]=Разширена факс програма (ksendfax)
@@ -928,11 +949,12 @@
 Name[ja]=高機能 Fax ツール (ksendfax)
 Name[ko]=고급 팩스 도구 (ksendfax)
 Name[lt]=Sudėtingesnis faksų siuntimo įrankis (ksendfax)
+Name[mk]=Напредна алатка за факсови (ksendfax)
 Name[mn]=Дэвшилтэт факс хэрэгсэл (ksendfax)
 Name[ms]=Alatan Faks Termaju (ksendfax)
 Name[mt]=Għodda avvanzata għall-fax (ksendfax)
 Name[nb]=Avansert faxverktøy (ksendfax)
-Name[nds]=Fax-Warktüüg (ksendfax)
+Name[nds]=Verwiedert Fax-Warktüüch (ksendfax)
 Name[nl]=Geavanceerd faxprogramma (ksendfax)
 Name[nn]=Avansert faksverktøy (ksendfax)
 Name[nso]=Sebereka sago Faxa seo se Beetswegopele (kromelafax)
@@ -942,7 +964,7 @@
 Name[pt_BR]=Ferramenta Avançada de Fax (ksendfax)
 Name[ro]=Utilitar de FAX avansat (ksendfax)
 Name[ru]=Утилита отправки факсов (ksendfax)
-Name[se]=Nana buorre fáksaneavvu (ksendfax)
+Name[se]=Nana buorre fáksareaidu (ksendfax)
 Name[sk]=Pokročilý nástroj pre faxy (ksendfax)
 Name[sl]=Napredno orodje za faksiranje (ksendfax)
 Name[sq]=Vegël e Avancuar Për Dërgesa me Faks (ksendfax)
diff -urN -x CVS kdelibs.orig/kdeui/.cvsignore kdelibs/kdeui/.cvsignore
--- kdelibs.orig/kdeui/.cvsignore	Wed Dec 10 20:23:18 2003
+++ kdelibs/kdeui/.cvsignore	Wed Nov 10 23:32:13 2004
@@ -1,4 +1,6 @@
 dummy.cpp
+*.moc
+*.lo
 *.kidl
 *_signals.cpp
 *_signals.h
diff -urN -x CVS kdelibs.orig/kdeui/kdepackages.h kdelibs/kdeui/kdepackages.h
--- kdelibs.orig/kdeui/kdepackages.h	Sun Oct  3 09:20:01 2004
+++ kdelibs/kdeui/kdepackages.h	Sun Nov 28 14:40:53 2004
@@ -2,12 +2,9 @@
 const char * const packages[] = {
 "HIG",
 "HIG/General",
-"Kommander",
-"Kommander/Kommander editor",
-"Kommander/Kommander executor",
 "akodelib",
 "akregator",
-"akregator/konqueror plugin",
+"akregator/akregator konqueror plugin",
 "akregator/kontact plugin",
 "aktion",
 "amarok",
@@ -52,7 +49,10 @@
 "digikamimageplugins/Charcoal",
 "digikamimageplugins/Despeckle",
 "digikamimageplugins/Emboss",
+"digikamimageplugins/Filmgrain",
+"digikamimageplugins/General",
 "digikamimageplugins/OilPaint",
+"digikamimageplugins/Raindrops",
 "digikamimageplugins/SolarizeImage",
 "digikamimageplugins/Unsharp",
 "docs",
@@ -236,9 +236,14 @@
 "kde/clipboard",
 "kde/dualhead",
 "kde/xinerama",
+"kdeaddons",
+"kdeaddons/dirfilter-plugin",
+"kdeaddons/khtmlsettings-plugin",
+"kdeaddons/useragent-plugin",
 "kdebugdialog",
 "kdelibs",
 "kdelibs/kbugreport",
+"kdelibs/kcertpart",
 "kdelibs/kded",
 "kdelibs/kdeinit",
 "kdelibs/kdesasl",
@@ -368,12 +373,15 @@
 "khexedit2/library",
 "khotkeys",
 "kicker",
+"kicker/Drag &apos;n Drop",
+"kicker/Panel Strut Management",
 "kicker/appletproxy",
 "kicker/devicesapplet",
 "kicker/dockbar",
 "kicker/kasbar",
 "kicker/kbinaryclock",
 "kicker/kclockapplet",
+"kicker/mediaapplet",
 "kicker/minipagerapplet",
 "kicker/multiscreen",
 "kicker/naughtyapplet",
@@ -381,6 +389,8 @@
 "kicker/sidebar",
 "kicker/systemtray",
 "kicker/taskbarapplet",
+"kicker/transparency",
+"kicker/trashapplet",
 "kiconedit",
 "kig",
 "kile",
@@ -407,6 +417,7 @@
 "kio/kioslave",
 "kio/kssl",
 "kio/man",
+"kio/media",
 "kio/nfs",
 "kio/nntp",
 "kio/pop3",
@@ -470,15 +481,18 @@
 "kmahjongg",
 "kmail",
 "kmail/IMAP",
+"kmail/addressbook",
 "kmail/composer",
 "kmail/disconnected IMAP",
 "kmail/display",
 "kmail/encryption",
 "kmail/filtering",
 "kmail/kde31compatibility",
+"kmail/keys and menus",
 "kmail/kmailcvt",
 "kmail/messageviewer",
 "kmail/mime",
+"kmail/pop3",
 "kmail/search",
 "kmameleon",
 "kmameleon/interface",
@@ -490,6 +504,11 @@
 "kmid",
 "kmidi",
 "kmilo",
+"kmilo/Asus",
+"kmilo/Generic MM module",
+"kmilo/Powerbook2 module",
+"kmilo/Thinkpad",
+"kmilo/vaio",
 "kmines",
 "kmix",
 "kmix/KMix Panel Applet",
@@ -518,6 +537,9 @@
 "koffice/filters",
 "kolf",
 "kolourpaint",
+"kommander",
+"kommander/Kommander editor",
+"kommander/Kommander executor",
 "kompare",
 "kompare/navigationpart",
 "kompare/parser",
@@ -526,6 +548,7 @@
 "konqueror",
 "konqueror/bookmarks",
 "konqueror/file icon view",
+"konqueror/file list view",
 "konqueror/fsview",
 "konqueror/imagerotation",
 "konqueror/kcookiejar",
@@ -533,6 +556,7 @@
 "konqueror/khtml event",
 "konqueror/khtml forms",
 "konqueror/khtml parsing",
+"konqueror/khtml part",
 "konqueror/khtml renderer",
 "konqueror/khtml xml",
 "konqueror/khtml",
@@ -566,6 +590,7 @@
 "kontact/news",
 "kontact/newsticker",
 "kontact/notes",
+"kontact/special dates",
 "kontact/summary",
 "kontact/todo",
 "kontour",
@@ -579,6 +604,7 @@
 "kopete/Alias Plugin",
 "kopete/Auto-Away Plugin",
 "kopete/Autoreplace plugin",
+"kopete/Bookmarks plugin",
 "kopete/Chat Window",
 "kopete/Chatwindow Styles",
 "kopete/Connection Status Plugin",
@@ -592,6 +618,7 @@
 "kopete/Importer plugin",
 "kopete/Jabber Plugin",
 "kopete/Latex Plugin",
+"kopete/Lotus Sametime Plugin",
 "kopete/MSN Plugin",
 "kopete/Main Application",
 "kopete/New plugin wishes",
@@ -610,7 +637,6 @@
 "korganizer/embedded",
 "korganizer/exchangeplugin",
 "korganizer/groupware",
-"korganizer/kalarmd",
 "korn",
 "koshell",
 "kpackage",
@@ -675,6 +701,16 @@
 "kspread",
 "kspread/filters",
 "kst",
+"kst/datasources",
+"kst/documentation",
+"kst/elog extension",
+"kst/equations",
+"kst/i18n",
+"kst/packaging",
+"kst/plotting",
+"kst/plugins",
+"kst/ui",
+"kst/view objects",
 "kstars",
 "kstart",
 "kstartperf",
@@ -743,6 +779,8 @@
 "kxmlrpcd",
 "lanbrowsing",
 "libkcddb",
+"libkdegames",
+"libkdegames/General",
 "lilo-config",
 "lskat",
 "mediacontrol",
@@ -761,6 +799,7 @@
 "noatun/simple",
 "noatun/split",
 "noatun/winskin",
+"pixieplus",
 "qca",
 "quanta",
 "quanta/VPL",
diff -urN -x CVS kdelibs.orig/kdeui/kdetrayproxy/kdetrayproxy.desktop kdelibs/kdeui/kdetrayproxy/kdetrayproxy.desktop
--- kdelibs.orig/kdeui/kdetrayproxy/kdetrayproxy.desktop	Mon Sep 20 15:53:18 2004
+++ kdelibs/kdeui/kdetrayproxy/kdetrayproxy.desktop	Fri Nov 12 08:27:51 2004
@@ -2,6 +2,7 @@
 Encoding=UTF-8
 Type=Service
 Name=KDE Tray Proxy Module
+Name[af]=KDE Skinkbord Proksie Module
 Name[bn]=কে.ডি.ই. ট্রে প্রক্সি মডিউল
 Name[bs]=KDE proxy modul za tray
 Name[ca]=Mòdul de safata d'intermediari del KDE
@@ -16,7 +17,9 @@
 Name[is]=KDE selstjórneining spjaldsins
 Name[it]=Modulo proxy per il vassoio di KDE
 Name[ja]=KDE トレイプロキシモジュール
+Name[lt]=KDE dėklo proxy modulis
 Name[nb]=KDE mellommodul
+Name[nds]=Proxy-Moduul för den Paneel-Systeemafsnitt
 Name[nl]=Proxy-module voor het KDE-systeemvak
 Name[nn]=KDE-mellommodul for systemtrauet
 Name[pa]=KDE ਟਰੇ ਪਰਾਕਸੀ ਮੈਡੀਊਲ
@@ -24,15 +27,17 @@
 Name[pt]=Módulo de 'Proxy' de Bandeja do KDE
 Name[pt_BR]=Módulo de Proxy do Painel do KDE
 Name[ro]=Modul proxy pentru tava de sistem KDE
+Name[ru]=Модуль прокси лотка KDE
 Name[sk]=Modul pre proxy lišty KDE
 Name[sr]=Прокси модул KDE-ове касете
-Name[sr@Latn]=Прокси модул KDE-ове касете
+Name[sr@Latn]=Proksi modul KDE-ove kasete
 Name[sv]=KDE-proxymodul för systembricka
 Name[ta]=KDE தட்டு மாற்று பதிலாள் கூறு
 Name[tg]=Новаи KDE-и модули прокси
 Name[uk]=Модуль посередника для програм в системному лотку
 Name[zh_CN]=KDE 托盘代理模块
 Comment=Proxy enabling KDE systray applications to work without KWin
+Comment[af]=Proksie wat KDE 'systray' programme toelaat om sonder KWin te werk
 Comment[bg]=Модул, който позволява на програмите от КДЕ да работят в системния поднос с други мениджъри на прозорци
 Comment[bn]=কে.ডি.ই. সিস-ট্রে অ্যাপলিকেশন কে-উইন ছাড়াই কাজ করাবার জন্য প্রক্সি
 Comment[bs]=Proxy koji omogućuje KDE systray programima da rade izvan KWin-a
@@ -48,7 +53,10 @@
 Comment[is]=Selstjórneining fyrir KDE spjaldið sem virkar án KWin
 Comment[it]=Permette alle applicazioni per il vassoio di KDE di funzionare senza KWin
 Comment[ja]=KWinなしでKDE systray アプリケーションを動作できるようにプロキシを有効にします。
+Comment[lt]=Proxy įgalinantis KDE sistemos dėklo taikomasias programas dirbti be KWin
+Comment[mk]=Прокси кое им овозможува на KDE апликациите од сис. лента да работат без KWin
 Comment[nb]=Modul som gjør at systemkurvprogrammet for KDE kan fungere uten KWin
+Comment[nds]=Disse Proxy laat Programmen ok ahn KWin as Finsterpleger binnen den Paneel-Systeemafsnitt lopen
 Comment[nl]=Proxy-module om applicaties in het KDE-systeemvak te plaatsen die geen KWin ondersteuning hebben.
 Comment[nn]=Modul som gjer at systemtrauprogram for KDE kan fungera uavhengig av KWin
 Comment[pa]=KWin ਬਿਨਾਂ ਕੰਮ ਕਰਨ ਲਈ KDE systray ਕਾਰਜਾਂ ਲਈ ਪਰਾਕਸੀ ਯੋਗ
@@ -56,10 +64,11 @@
 Comment[pt]='Proxy' que permite aplicações da bandeja de sistema do KDE funcionarem sem o KWin
 Comment[pt_BR]=Habilita o funcionamento do proxy em aplicativos sem o KWin
 Comment[ro]=Permite aplicaţiilor pentru tava de sistem KDE să lucreze fără suport din partea KWin
+Comment[ru]=Прокси, позволяющий приложениям лотка KDE работать без KWin
 Comment[se]=Moduvla mii dagaha ahte KDE:a vuogádatgárcoprográmmat doibmet KWin haga.
 Comment[sk]=Proxy pre aplikácie z lišty KDE, aby nevyžadovali KWin
 Comment[sr]=Прокси који омогућава KDE програмима за системску касету да раде без KWin-а
-Comment[sr@Latn]=Прокси који омогућава KDE програмима за системску касету да раде без KWin-а
+Comment[sr@Latn]=Proksi koji omogućava KDE programima za sistemsku kasetu da rade bez KWin-a
 Comment[sv]=Proxymodul som gör det möjligt för KDE:s program i systembrickan att fungera utan Kwin
 Comment[ta]=மாற்று பதிலாள் KDE அமைப்பு தட்டு பயன்பாட்டை KWin இல்லாமல் வேலை செய்ய செயல்படுத்துகிறது
 Comment[tg]=Proxy барномаҳои KDE systray-ро барои корнамоӣ, бидуни KWin фаъол месозад
diff -urN -x CVS kdelibs.orig/kdeui/kedittoolbar.cpp kdelibs/kdeui/kedittoolbar.cpp
--- kdelibs.orig/kdeui/kedittoolbar.cpp	Sun Jul 11 20:04:59 2004
+++ kdelibs/kdeui/kedittoolbar.cpp	Fri Nov 26 00:11:07 2004
@@ -47,8 +47,8 @@
 #include "kpushbutton.h"
 #include <kprocio.h>
 
-#define LINESEPARATORSTRING i18n("--- line separator ---")
-#define SEPARATORSTRING i18n("--- separator ---")
+#define LINESEPARATORSTRING I18N_NOOP("--- line separator ---")
+#define SEPARATORSTRING I18N_NOOP("--- separator ---")
 
 static void dump_xml(const QDomDocument& doc)
 {
@@ -105,9 +105,9 @@
   virtual QString key(int column, bool) const
   {
     QString s = text( column );
-    if ( s == LINESEPARATORSTRING )
+    if ( s == i18n(LINESEPARATORSTRING) )
       return "0";
-    if ( s == SEPARATORSTRING )
+    if ( s == i18n(SEPARATORSTRING) )
       return "1";
     return "2" + s;
   }
@@ -875,17 +875,19 @@
   QMap<QString, bool> active_list;
 
   // see if our current action is in this toolbar
-  QDomElement it = elem.lastChild().toElement();
-  for( ; !it.isNull(); it = it.previousSibling().toElement() )
+  QDomNode n = elem.lastChild();
+  for( ; !n.isNull(); n = n.previousSibling() )
   {
+    QDomElement it = n.toElement();
+    if (it.isNull()) continue;
     if (it.tagName() == tagSeparator)
     {
       ToolbarItem *act = new ToolbarItem(m_activeList, tagSeparator, sep_name.arg(sep_num++), QString::null);
       bool isLineSep = ( it.attribute(attrLineSeparator, "true").lower() == QString::fromLatin1("true") );
       if(isLineSep)
-        act->setText(1, LINESEPARATORSTRING);
+        act->setText(1, i18n(LINESEPARATORSTRING));
       else
-        act->setText(1, SEPARATORSTRING);
+        act->setText(1, i18n(SEPARATORSTRING));
       it.setAttribute( attrName, act->internalName() );
       continue;
     }
@@ -954,9 +956,9 @@
 
   // finally, add default separators to the inactive list
   ToolbarItem *act = new ToolbarItem(m_inactiveList, tagSeparator, sep_name.arg(sep_num++), QString::null);
-  act->setText(1, LINESEPARATORSTRING);
+  act->setText(1, i18n(LINESEPARATORSTRING));
   act = new ToolbarItem(m_inactiveList, tagSeparator, sep_name.arg(sep_num++), QString::null);
-  act->setText(1, SEPARATORSTRING);
+  act->setText(1, i18n(SEPARATORSTRING));
 }
 
 KActionCollection *KEditToolbarWidget::actionCollection() const
@@ -1103,9 +1105,9 @@
 
   QDomElement new_item;
   // let's handle the separator specially
-  if (item->text(1) == LINESEPARATORSTRING) {
+  if (item->text(1) == i18n(LINESEPARATORSTRING)) {
     new_item = domDocument().createElement(tagSeparator);
-  } else if (item->text(1) == SEPARATORSTRING) {
+  } else if (item->text(1) == i18n(SEPARATORSTRING)) {
     new_item = domDocument().createElement(tagSeparator);
     new_item.setAttribute(attrLineSeparator, "false");
   } else
diff -urN -x CVS kdelibs.orig/kdeui/kinputdialog.cpp kdelibs/kdeui/kinputdialog.cpp
--- kdelibs.orig/kdeui/kinputdialog.cpp	Thu Jun  3 18:40:03 2004
+++ kdelibs/kdeui/kinputdialog.cpp	Fri Nov 19 15:09:19 2004
@@ -198,6 +198,12 @@
     d->m_listBox->setSelected( current, true );
     d->m_listBox->ensureCurrentVisible();
     layout->addWidget( d->m_listBox, 10 );
+    connect( d->m_listBox, SIGNAL( doubleClicked( QListBoxItem * ) ),
+      SLOT( slotOk() ) );
+    connect( d->m_listBox, SIGNAL( returnPressed( QListBoxItem * ) ),
+      SLOT( slotOk() ) );
+
+    d->m_listBox->setFocus();
   }
 
   layout->addStretch();
@@ -240,6 +246,8 @@
   {
     connect( d->m_listBox, SIGNAL( doubleClicked( QListBoxItem * ) ),
       SLOT( slotOk() ) );
+    connect( d->m_listBox, SIGNAL( returnPressed( QListBoxItem * ) ),
+      SLOT( slotOk() ) );
 
     QString text = select.first();
     item = d->m_listBox->findItem( text, CaseSensitive|ExactMatch );
@@ -248,6 +256,7 @@
   }
 
   d->m_listBox->ensureCurrentVisible();
+  d->m_listBox->setFocus();
 
   layout->addStretch();
 
diff -urN -x CVS kdelibs.orig/kdeui/klineedit.cpp kdelibs/kdeui/klineedit.cpp
--- kdelibs.orig/kdeui/klineedit.cpp	Sun Sep 19 16:17:43 2004
+++ kdelibs/kdeui/klineedit.cpp	Wed Oct  6 22:42:17 2004
@@ -848,17 +848,13 @@
 
     QPopupMenu *popup = QLineEdit::createPopupMenu();
 
-    if ( isReadOnly() )
-      popup->changeItem( popup->idAt(0), SmallIconSet("editcopy"), popup->text( popup->idAt(0) ) );
-    else {
-      int id = popup->idAt(0);
-      popup->changeItem( id - IdUndo, SmallIconSet("undo"), popup->text( id - IdUndo) );
-      popup->changeItem( id - IdRedo, SmallIconSet("redo"), popup->text( id - IdRedo) );
-      popup->changeItem( id - IdCut, SmallIconSet("editcut"), popup->text( id - IdCut) );
-      popup->changeItem( id - IdCopy, SmallIconSet("editcopy"), popup->text( id - IdCopy) );
-      popup->changeItem( id - IdPaste, SmallIconSet("editpaste"), popup->text( id - IdPaste) );
-      popup->changeItem( id - IdClear, SmallIconSet("editclear"), popup->text( id - IdClear) );
-    }
+    int id = popup->idAt(0);
+    popup->changeItem( id - IdUndo, SmallIconSet("undo"), popup->text( id - IdUndo) );
+    popup->changeItem( id - IdRedo, SmallIconSet("redo"), popup->text( id - IdRedo) );
+    popup->changeItem( id - IdCut, SmallIconSet("editcut"), popup->text( id - IdCut) );
+    popup->changeItem( id - IdCopy, SmallIconSet("editcopy"), popup->text( id - IdCopy) );
+    popup->changeItem( id - IdPaste, SmallIconSet("editpaste"), popup->text( id - IdPaste) );
+    popup->changeItem( id - IdClear, SmallIconSet("editclear"), popup->text( id - IdClear) );
       
     // If a completion object is present and the input
     // widget is not read-only, show the Text Completion
diff -urN -x CVS kdelibs.orig/kdeui/kmainwindow.cpp kdelibs/kdeui/kmainwindow.cpp
--- kdelibs.orig/kdeui/kmainwindow.cpp	Mon Aug 30 02:04:47 2004
+++ kdelibs/kdeui/kmainwindow.cpp	Wed Oct  6 15:34:08 2004
@@ -1192,6 +1192,19 @@
     return size;
 }
 
+#if KDE_IS_VERSION( 3, 9, 0 )
+#ifdef __GNUC__
+#warning Remove, should be in Qt
+#endif
+#endif
+void KMainWindow::setIcon( const QPixmap& p )
+{
+    QMainWindow::setIcon( p );
+    // Qt3 doesn't support _NET_WM_ICON, but KApplication::setTopWidget(), which
+    // is used by KMainWindow, sets it
+    KWin::setIcons( winId(), p, QPixmap());
+}
+
 // why do we support old gcc versions? using KXMLGUIBuilder::finalizeGUI;
 // DF: because they compile KDE much faster :)
 void KMainWindow::finalizeGUI( KXMLGUIClient *client )
diff -urN -x CVS kdelibs.orig/kdeui/kmainwindow.h kdelibs/kdeui/kmainwindow.h
--- kdelibs.orig/kdeui/kmainwindow.h	Sat Oct  2 13:38:19 2004
+++ kdelibs/kdeui/kmainwindow.h	Wed Oct  6 14:50:58 2004
@@ -637,6 +637,12 @@
     // KDE4 to be removed
     QSize sizeForCentralWidgetSize(QSize size) KDE_DEPRECATED;
 
+    /**
+     * @internal
+     */
+    // KDE4 remove
+    virtual void setIcon( const QPixmap & );
+
 public slots:
     /**
      * Show a standard configure toolbar dialog.
diff -urN -x CVS kdelibs.orig/kdeui/ksconfig.cpp kdelibs/kdeui/ksconfig.cpp
--- kdelibs.orig/kdeui/ksconfig.cpp	Wed Apr 14 12:58:33 2004
+++ kdelibs/kdeui/ksconfig.cpp	Thu Nov 11 23:49:17 2004
@@ -265,8 +265,9 @@
     dname.truncate(i);
   }
 
-  // Aspell uses 2 alpha language codes or 2 alpha language + 2 alpha country
-  if ( dname.length() == 2 ) {
+  // Aspell uses 2 alpha language codes or 2 alpha language + 2 alpha country,
+  // but since aspell 0.6 also 3-character ISO-codes can be used
+  if ( (dname.length() == 2) || (dname.length() == 3) ) {
     lname = dname;
     hname = KGlobal::locale()->twoAlphaToLanguageName( lname );
   }
@@ -519,11 +520,24 @@
     // consider only simple dicts without '-' in the name
     // FIXME: may be this is wrong an the list should contain
     // all *.multi files too, to allow using special dictionaries
+    
+    // Well, KSpell2 has a better way to do this, but this code has to be
+    // cleaned up somehow: since aspell 0.6 we have quite a lot of files in the 
+    // aspell dictionary that are not dictionaries. These must not be presented as "languages"
+    // We only keep 
+    // *.rws: dictionary
+    // *.multi: definition file to load several subdictionaries
+    if ( !( fname.endsWith(".rws") || fname.endsWith(".multi") ) ) {
+        // remove noise from the language list
+        continue;
+    }
     if (fname[0] != '.')
     {
 
       // remove .multi
       if (fname.endsWith(".multi")) fname.remove (fname.length()-6,6);
+      // remove .rws
+      if (fname.endsWith(".rws")) fname.remove (fname.length()-4,4);
 
       if (interpret (fname, lname, hname) && langfnames[0].isEmpty())
       { // This one is the KDE default language
diff -urN -x CVS kdelibs.orig/kdeui/kspell.cpp kdelibs/kdeui/kspell.cpp
--- kdelibs.orig/kdeui/kspell.cpp	Sat Feb 21 17:37:06 2004
+++ kdelibs/kdeui/kspell.cpp	Thu Nov 25 07:28:22 2004
@@ -74,6 +74,7 @@
   KSpell* suggestSpell;
   bool checking;
   QValueList<BufferedWord> unchecked;
+  QTimer *checkNextTimer;
 };
 
 //TODO
@@ -433,7 +434,7 @@
   QString qs = buffer.simplifyWhiteSpace();
 
   if ( qs.find (' ') != -1 || qs.isEmpty() ) {   // make sure it's a _word_
-    QTimer::singleShot( 0, this, SLOT(checkNext()) );
+    d->checkNextTimer->start( 0, true );
     return false;
   }
   ///set the dialog signal handler
@@ -448,6 +449,9 @@
   else
     ksdlg->hide();
 
+  QString blank_line;
+  while (proc->readln( blank_line, true ) != -1); // eat spurious blanks
+
   OUTPUT(checkWord2);
   //  connect (this, SIGNAL (dialog3()), this, SLOT (checkWord3()));
 
@@ -472,7 +476,7 @@
   QString qs = buffer.simplifyWhiteSpace();
 
   if ( qs.find (' ') != -1 || qs.isEmpty() ) {   // make sure it's a _word_
-    QTimer::singleShot( 0, this, SLOT(checkNext()) );
+    d->checkNextTimer->start( 0, true );
     return false;
   }
 
@@ -488,6 +492,10 @@
     else
       ksdlg->hide();
   }
+  
+  QString blank_line;
+  while (proc->readln( blank_line, true ) != -1); // eat spurious blanks
+
   OUTPUT(checkWord2);
   //  connect (this, SIGNAL (dialog3()), this, SLOT (checkWord3()));
 
@@ -515,13 +523,13 @@
   QString blank_line;
   while (proc->readln( blank_line, true ) != -1); // eat the blank line
   NOOUTPUT(checkWord2);
-
+  
   bool mistake = ( parseOneResponse(line, word, sugg) == MISTAKE );
   if ( mistake && usedialog )
   {
     cwword = word;
     dialog( word, sugg, SLOT(checkWord3()) );
-    QTimer::singleShot( 0, this, SLOT(checkNext()) );
+    d->checkNextTimer->start( 0, true );
     return;
   }
   else if( mistake )
@@ -532,7 +540,7 @@
   //emits a "corrected" signal _even_ if no change was made
   //so that the calling program knows when the check is complete
   emit corrected( word, word, 0L );
-  QTimer::singleShot( 0, this, SLOT(checkNext()) );
+  d->checkNextTimer->start( 0, true );
 }
 
 void KSpell::checkNext()
@@ -542,6 +550,7 @@
   if (!d->unchecked.empty()) {
     BufferedWord buf = d->unchecked.front();
     d->unchecked.pop_front();
+    
     if (buf.method == Method1)
       checkWord( buf.word, buf.useDialog );
     else
@@ -1224,6 +1233,7 @@
   delete proc;
   delete ksconfig;
   delete ksdlg;
+  delete d->checkNextTimer;
   delete d;
 }
 
@@ -1397,6 +1407,9 @@
   d->m_bNoMisspellingsEncountered = true;
   d->type = type;
   d->checking = false;
+  d->checkNextTimer = new QTimer( this );
+  connect( d->checkNextTimer, SIGNAL( timeout() ),
+	   this, SLOT( checkNext() ));
   autoDelete = false;
   modaldlg = _modal;
   progressbar = _progressbar;
diff -urN -x CVS kdelibs.orig/kdeui/ktabbar.cpp kdelibs/kdeui/ktabbar.cpp
--- kdelibs.orig/kdeui/ktabbar.cpp	Sun Sep 12 21:59:21 2004
+++ kdelibs/kdeui/ktabbar.cpp	Tue Oct  5 20:29:33 2004
@@ -19,6 +19,7 @@
 */
 
 #include <qapplication.h>
+#include <qcursor.h>
 #include <qpainter.h>
 #include <qstyle.h>
 #include <qtimer.h>
@@ -220,7 +221,9 @@
 
 void KTabBar::activateDragSwitchTab()
 {
-    setCurrentTab( mDragSwitchTab );
+    QTab *tab = selectTab( mapFromGlobal( QCursor::pos() ) );
+    if ( tab!= 0L && mDragSwitchTab == tab )
+      setCurrentTab( mDragSwitchTab );
     mDragSwitchTab = 0;
 }
 
diff -urN -x CVS kdelibs.orig/kdeui/ktip.cpp kdelibs/kdeui/ktip.cpp
--- kdelibs.orig/kdeui/ktip.cpp	Wed Apr  7 14:07:19 2004
+++ kdelibs/kdeui/ktip.cpp	Fri Oct 22 14:23:49 2004
@@ -94,14 +94,14 @@
 
     if (fileName.isEmpty())
     {
-	kdDebug() << "can't find '" << tipFile << "' in standard dirs" << endl;
+	kdDebug() << "KTipDatabase::addTips: can't find '" << tipFile << "' in standard dirs" << endl;
         return;
     }
 
     QFile file(fileName);
     if (!file.open(IO_ReadOnly))
     {
-	kdDebug() << "can't open '" << fileName << "' for reading" << endl;
+	kdDebug() << "KTipDatabase::addTips: can't open '" << fileName << "' for reading" << endl;
 	return;
     }
 
@@ -142,6 +142,8 @@
 
 QString KTipDatabase::tip() const
 {
+    if (mTips.isEmpty())
+	return QString::null;
     return mTips[mCurrent];
 }
 
diff -urN -x CVS kdelibs.orig/kdoctools/customization/cs/entities/fdl-notice.docbook kdelibs/kdoctools/customization/cs/entities/fdl-notice.docbook
--- kdelibs.orig/kdoctools/customization/cs/entities/fdl-notice.docbook	Tue Mar 27 12:50:44 2001
+++ kdelibs/kdoctools/customization/cs/entities/fdl-notice.docbook	Thu Nov 18 19:05:04 2004
@@ -1,8 +1,49 @@
+<!-- This file can be used to include the notice in documentation 
+     <!DOCTYPE book ... [
+      <!ENTITY % FDLIS "INCLUDE">
+      <!ENTITY FDLISTitles "title 1, title 2, title 3">
+      <!ENTITY % FDLFCT "INCLUDE">
+      <!ENTITY FDLFCTTitles "title 4, title 5, title 6">
+      <!ENTITY % FDLBCT "INCLUDE">
+      <!ENTITY FDLBCTTitles "title 7, title 7b">
+      <!ENTITY % ents "-//KDE//ENTITIES Application-Variable Entities V1.0//EN">
+      %ents;
+      ...
+     ]>
+    ...
+     <bookinfo>
+       <legalnotice>
+         <para>Copyright (C) 20yy  [name of author]</para>
+         &FDLnotice;
+       </legalnotice>
+     </bookinfo>
+    ...
+
+    Alternatively, you can include the text literally.
+
+    Include a copy of the license in the documentation distribution.
+ -->
 <para>Permission is granted to copy, distribute and/or modify this
 document under the terms of the GNU Free Documentation License,
 Version 1.1 or any later version published by the Free Software
 Foundation; with &FDLInvariantSections;, with &FDLFrontCoverText;, and
 with &FDLBackCoverText;.  A copy of the license is included in <xref linkend="gnu-fdl"/>.</para>
+
+<!-- If you have no Invariant Sections, don't add any FDLIS entities.
+     If you have no Front-Cover Texts, don't add any FDLFCT; likewise
+     for Back-Cover Texts (the SGML setup takes care of complying with
+     the GNU requirements).  Adding the entities: if you use any, then
+     add FDL* with value "INCLUDE" and FDL*Titles with a list of
+     titles.  You will get the default GNU template text if you don't
+     specify the FDL*Titles entity after specifying the FDL* entity.
+     This will only have effect when you specify %FDLSlots; _after_
+     the entity definitions.
+
+     If your document contains nontrivial examples of program code, we
+     recommend releasing these examples in parallel under your choice
+     of free software license, such as the GNU General Public License,
+     to permit their use in free software.
+ -->
 <!--
 Local variables:
 mode: sgml
diff -urN -x CVS kdelibs.orig/kdoctools/customization/cs/entities/help-menu.docbook kdelibs/kdoctools/customization/cs/entities/help-menu.docbook
--- kdelibs.orig/kdoctools/customization/cs/entities/help-menu.docbook	Wed Sep 26 18:42:28 2001
+++ kdelibs/kdoctools/customization/cs/entities/help-menu.docbook	Thu Nov 18 19:05:04 2004
@@ -6,7 +6,7 @@
 <keycombo action="simul"><keycap>F1</keycap></keycombo>
 </shortcut>
 <guimenu>Help</guimenu>
-<guimenuitem>Contents...</guimenuitem>
+<guimenuitem>&kappname; Handbook</guimenuitem>
 </menuchoice>
 </term>
 <listitem><para><action>Invokes the KDE Help system</action> starting at the
diff -urN -x CVS kdelibs.orig/kdoctools/customization/cs/entities/underGPL.docbook kdelibs/kdoctools/customization/cs/entities/underGPL.docbook
--- kdelibs.orig/kdoctools/customization/cs/entities/underGPL.docbook	Tue Mar 20 13:59:10 2001
+++ kdelibs/kdoctools/customization/cs/entities/underGPL.docbook	Thu Nov 18 19:05:04 2004
@@ -1,2 +1,2 @@
 <para>This program is licensed under the terms of the <ulink
-url="common/gpl-translated.html">GNU General Public License</ulink>.</para>
+url="common/gpl-license.html">GNU General Public License</ulink>.</para>
diff -urN -x CVS kdelibs.orig/kdoctools/customization/cs/entities/underLGPL.docbook kdelibs/kdoctools/customization/cs/entities/underLGPL.docbook
--- kdelibs.orig/kdoctools/customization/cs/entities/underLGPL.docbook	Thu Jan  1 01:00:00 1970
+++ kdelibs/kdoctools/customization/cs/entities/underLGPL.docbook	Thu Nov 18 19:05:04 2004
@@ -0,0 +1,2 @@
+<para>This program is licensed under the terms of the <ulink
+url="common/lgpl-license.html">GNU Lesser General Public License</ulink>.</para>
diff -urN -x CVS kdelibs.orig/kdoctools/customization/cs/entities/update-doc.docbook kdelibs/kdoctools/customization/cs/entities/update-doc.docbook
--- kdelibs.orig/kdoctools/customization/cs/entities/update-doc.docbook	Tue Mar 20 13:59:10 2001
+++ kdelibs/kdoctools/customization/cs/entities/update-doc.docbook	Thu Nov 18 19:05:04 2004
@@ -1 +1,3 @@
-<!-- to be filled in -->
+<para>This document may have been updated since your installation.
+You can find the latest version at <ulink
+url="http://docs.kde.org/current/&package;/">http://docs.kde.org/current/&package;/</ulink>.</para>
diff -urN -x CVS kdelibs.orig/kdoctools/customization/fr/entities/update-doc.docbook kdelibs/kdoctools/customization/fr/entities/update-doc.docbook
--- kdelibs.orig/kdoctools/customization/fr/entities/update-doc.docbook	Tue Mar 20 13:59:10 2001
+++ kdelibs/kdoctools/customization/fr/entities/update-doc.docbook	Fri Oct 22 16:13:19 2004
@@ -1 +1,2 @@
-<!-- to be filled in -->
+<para>Ce document a peut-être été mis à jour depuis son installation sur votre ordinateur. Vous trouverez la dernière version sur <ulink
+url="http://docs.kde.org/current/&package;/">http://docs.kde.org/current/&package;/</ulink>.</para>
diff -urN -x CVS kdelibs.orig/kdoctools/customization/fr/user.entities kdelibs/kdoctools/customization/fr/user.entities
--- kdelibs.orig/kdoctools/customization/fr/user.entities	Wed Sep 22 07:15:46 2004
+++ kdelibs/kdoctools/customization/fr/user.entities	Sat Nov 13 18:01:18 2004
@@ -92,6 +92,8 @@
 <!ENTITY traducteurYvesGuillou    '<othercredit role="translator"><firstname>Yves</firstname><surname>Guillou</surname><affiliation><address><email>yv_guil@club-internet.fr</email></address></affiliation><contrib>Traduction française</contrib></othercredit>'>
 <!ENTITY relecteurYvesGuillou     '<othercredit role="reviewer"><firstname>Yves</firstname><surname>Guillou</surname><affiliation><address><email>yv_guil@club-internet.fr</email></address></affiliation><contrib>Relecture de la documentation française</contrib></othercredit>'>
 
+<!ENTITY traducteurYohannHamon    '<othercredit role="translator"><firstname>Yohann</firstname><surname>Hamon</surname><affiliation><address><email>yohann_hamon@yahoo.fr</email></address></affiliation><contrib>Traduction française</contrib></othercredit>'>
+<!ENTITY relecteurYohannHamon     '<othercredit role="reviewer"><firstname>Yohann</firstname><surname>Hamon</surname><affiliation><address><email>yohann_hamon@yahoo.fr</email></address></affiliation><contrib>Relecture de la documentation française</contrib></othercredit>'>
 
 <!ENTITY traducteurRobertJacolin      '<othercredit role="translator"><firstname>Robert</firstname><surname>Jacolin</surname><affiliation><address><email>rjacolin@ifrance.com</email></address></affiliation><contrib>Traduction française</contrib></othercredit>'>
 <!ENTITY relecteurRobertJacolin      '<othercredit role="reviewer"><firstname>Robert</firstname><surname>Jacolin</surname><affiliation><address><email>rjacolin@ifrance.com</email></address></affiliation><contrib>Relecture de la documentation française</contrib></othercredit>'>
@@ -141,6 +143,9 @@
 <!ENTITY relecteurGillesThioliere   '<othercredit role="relecteur"><firstname>Gilles</firstname><surname>Thioliere</surname><affiliation><address><email>zhovirax@wanadoo.fr</email></address></affiliation><contrib>Relecture de la documentation française</contrib></othercredit>'>
 
 
+<!ENTITY traducteurYannVerley  '<othercredit role="translator"><firstname>Yann</firstname><surname>Verley</surname><affiliation><address><email>yann.verley@free.fr</email></address></affiliation><contrib>Traduction française</contrib></othercredit>'>
+<!ENTITY relecteurYannVerley   '<othercredit role="relecteur"><firstname>Yann</firstname><surname>Verley</surname><affiliation><address><email>yann.verley@free.fr</email></address></affiliation><contrib>Relecture de la documentation française</contrib></othercredit>'>
+
 <!-- CREDITS FOR TRANSLATORS -->
 
 <!ENTITY DavidAmmouial     'David Ammouial <email></email>'>
@@ -171,6 +176,7 @@
 <!ENTITY LudovicGrossard   'Ludovic Grossard <email>grossard@kde.org</email>'>
 <!ENTITY YvesGuillou   'Yves Guillou <email>yv_guil@club-internet.fr</email>'>
 <!ENTITY PhilippeGuilbert  'Philippe Guilbert <email>guilbertph@wanadoo.fr</email>'>
+<!ENTITY YohannHamon  'Yohann Hamon <email>yohann_hamon@yahoo.fr</email>'>
 <!ENTITY RobertJacolin     'Robert Jacolin <email>rjacolin@ifrance.com</email>'>
 <!ENTITY EquipeKDE         'l&apos;équipe française &kde;<email>doc@kde-france.org</email>'>
 <!ENTITY GoneriLeBouder    'Gonéri Le Bouder <email>goneri@gnuart.org</email>'>
@@ -187,7 +193,7 @@
 <!ENTITY ChristopheRolland 'Christophe Rolland <email>crolland@freesurf.fr</email>'>
 <!ENTITY PenelopeSorveyron 'Pénélope Sorveyron <email>goneri@free.fr</email>'>
 <!ENTITY GillesThioliere   'Gilles Thiolière <email>zhovirax@wanadoo.fr</email>'>
-
+<!ENTITY YannVerley   ' Yann Verley<email>yann.verley@free.fr</email>'>
 
 <!-- OTHER USER ENTITIES -->
 
diff -urN -x CVS kdelibs.orig/kdoctools/customization/nl/user.entities kdelibs/kdoctools/customization/nl/user.entities
--- kdelibs.orig/kdoctools/customization/nl/user.entities	Sun Aug  1 00:33:10 2004
+++ kdelibs/kdoctools/customization/nl/user.entities	Tue Nov 23 20:56:31 2004
@@ -30,6 +30,9 @@
 <!ENTITY Rijk.van.Wel      '<othercredit role="translator"><firstname>Rijk</firstname><surname>van Wel</surname><affiliation><address><email>hotmail@ridge.nl</email></address></affiliation><contrib>Vertaler/Nalezer</contrib></othercredit>'>
 <!ENTITY Jonas.Drieghe      '<othercredit role="translator"><firstname>Jonas</firstname><surname>Drieghe</surname><affiliation><address><email>jonas_drieghe@skynet.be</email></address></affiliation><contrib>Vertaler/Nalezer</contrib></othercredit>'>
 <!ENTITY Pieter.Hoekstra    '<othercredit role="translator"><firstname>Pieter</firstname><surname>Hoekstra</surname><affiliation><address><email>pieterhoekstra@tiscali.nl</email></address></affiliation><contrib>Vertaler/Nalezer</contrib></othercredit>'>
+<!ENTITY Niels.Luten        '<othercredit role="translator"><firstname>Niels</firstname><surname>Luten</surname><affiliation><address><email>mail@niels1.tmfweb.nl</email></address></affiliation><contrib>Vertaler/Nalezer</contrib></othercredit>'>
+<!ENTITY Rik.van.Achterberg '<othercredit role="translator"><firstname>Rik</firstname><surname>van Achterberg</surname><affiliation><address><email>rikratva@xs4all.nl</email></address></affiliation><contrib>Vertaler/Nalezer</contrib></othercredit>'>
+<!ENTITY Daniel.Huisman	'<othercredit role="translator"><firstname>Daniel</firstname><surname>Huisman</surname><affiliation><address><email>phptesten@lycos.nl</email></address></affiliation><contrib>Vertaler/Nalezer</contrib></othercredit>'>
 <!ENTITY kde.nl.groep       "<email>i18n@kde.nl</email>">
 
 <!-- Tekstschema's -->
@@ -58,6 +61,10 @@
 <!ENTITY vertaling.rijk    "<para>Dit document is vertaald in het Nederlands door &Rijk.van.Wel;.</para>">
 <!ENTITY vertaling.jonas   "<para>Dit document is vertaald in het Nederlands door &Jonas.Drieghe;.</para>">
 <!ENTITY vertaling.pieter  "<para>Dit document is vertaald in het Nederlands door &Pieter.Hoekstra;.</para>">
+<!ENTITY vertaling.niels.luten	"<para>Dit document is vertaald in het Nederlands door &Niels.Luten;.</para>">
+<!ENTITY vertaling.rik	   "<para>Dit document is vertaald in het Nederlands door &Rik.van.Achterberg;.</para>">
+<!ENTITY vertaling.daniel  "<para>Dit document is vertaald in het Nederlands door &Daniel.Huisman;.</para>">
+
 
 <!-- Gebruiken als template voor nieuwe vertalers/nalezers
 <!ENTITY xxx '<othercredit role="translator"><firstname>xx</firstname><surname>xxx</surname><affiliation><address><email>xxx@xxx.xxx</email></address></affiliation><contrib>Vertaler/Nalezer</contrib></othercredit>'>
@@ -88,6 +95,7 @@
 <!ENTITY nagelezen.rijk    "<para>De vertaling werd nagelezen door &Rijk.van.Wel;.</para>">
 <!ENTITY nagelezen.jonas   "<para>De vertaling werd nagelezen door &Jonas.Drieghe;.</para>">
 <!ENTITY nagelezen.pieter  "<para>De vertaling werd nagelezen door &Pieter.Hoekstra;.</para>">
+<!ENTITY nagelezen.daniel  "<para>De vertaling werd nagelezen door &Daniel.Huisman;.</para>">
 
 <!-- Algemene afkortingen -->
 <!ENTITY Alt     "<keycap>Alt</keycap>">
@@ -108,9 +116,9 @@
 </guiicon>"><!-- if image is localised, then entityref should be used instead
                  of fileref -->
 <!ENTITY kmenu  "<guimenu>K</guimenu>-menu">
-<!ENTITY LMB     "<mousebutton>LMK</mousebutton>">
-<!ENTITY MMB     "<mousebutton>MMK</mousebutton>">
-<!ENTITY RMB     "<mousebutton>RMK</mousebutton>">
+<!ENTITY LMB     "<mousebutton>linker</mousebutton> muisknop">
+<!ENTITY MMB     "<mousebutton>middelste</mousebutton> muisknop">
+<!ENTITY RMB     "<mousebutton>rechter</mousebutton> muisknop">
 <!ENTITY Shift   "<keycap>Shift</keycap>">
 <!ENTITY Backspace   "<keycap>Backspace</keycap>">
 <!ENTITY Esc     "<keycap>Escape</keycap>">
diff -urN -x CVS kdelibs.orig/khtml/.cvsignore kdelibs/khtml/.cvsignore
--- kdelibs.orig/khtml/.cvsignore	Sun Dec 21 18:38:23 2003
+++ kdelibs/khtml/.cvsignore	Wed Nov 10 10:00:14 2004
@@ -21,3 +21,4 @@
 kjserrordlg.cpp
 kjserrordlg.h
 Doxyfile
+*.diff
diff -urN -x CVS kdelibs.orig/khtml/ChangeLog kdelibs/khtml/ChangeLog
--- kdelibs.orig/khtml/ChangeLog	Thu Oct  7 14:35:07 2004
+++ kdelibs/khtml/ChangeLog	Wed Nov 10 10:00:14 2004
@@ -1,29 +1,413 @@
+2004-11-09  Germain Garand  <germain@ebooksfrance.org>
+
+        fix globeandmail.com famlily of crashes (#65715)
+
+        * rendering/render_box.cpp (createAnonymousBlock): moved from RenderFlow
+        (restructureParentFlow): check soundness of parent's flow structure with regard to
+        the child's new display. Adapted from WebCore.
+        (setStyle): check parent if floats or positioned objects become in-flow
+        and thus affects flow structure.
+
+        * rendering/render_flow.cpp (createAnonymousBlock): moved.
+
+        * rendering/render_inline.cpp (splitInlines): use addChildToFlow
+        rather than appendChildNode
+
+        * rendering/render_line.cpp: display COMPACT cleanups
+
+        * rendering/render_object.cpp: ditto.
+
+2004-11-06  Allan Sandfeld Jensen <kde@carewolf.com>
+
+        Implement CSS3 property box-sizing to match MacIE, Opera and Mozilla
+
+        * css/css*.in: Add new property and primitive values
+        * css/cssparser.cpp: Detect content-box and border-box as primitives
+        * css/cssstyleselector.cpp: Parse box-sizing
+        * render/render_style.h: Add box-sizing to non-inherited values
+        * render/render_box.cpp: Consult box-sizing before adding padding and
+        border to width and height
+
+2004-11-05  Germain Garand  <germain@ebooksfrance.org>
+
+        * khtml_part.cpp (closeURL/slotData/restoreState): avoid triggering
+        full repaints of the view before the first layout is done.
+
+2004-11-05  Germain Garand  <germain@ebooksfrance.com>
+
+        * css/cssstyleselector.cpp (computeFontSizes): add compensated font scale
+        from Todd Fahrner's "Toward a standard font size interval system"
+        article for 12ppem and below (suggested by Bert Bos <bert@w3.org>)
+
+2004-11-04  Stephan Kulow  <coolo@kde.org>
+
+        * rendering/bidi.cpp (bidiReorderLine): applying patch by Mitz Pettel
+        to fix neutral types at beginning of context
+
+2004-11-03  Germain Garand  <germain@ebooksfrance.com>
+
+        * khtmlview.cpp (slotScrollBarMoved): make sure we are layouted before
+        scrolling if we are still loading (#51473)
+
+2004-11-02  Stephan Kulow  <coolo@kde.org>
+
+        * rendering/render_replaced.cpp (setStyle): set hidden widgets to invisible
+
+        * xml/dom_docimpl.cpp (recalcStyleSelector): avoid invalid casts on XML documents
+
+2004-11-02  Germain Garand  <germain@ebooksfrance.com>
+
+       * css/cssstyleselector.cpp (adjustRenderStyle):
+       ignore relative positioning on table sections. CSS 2.1 does not
+       define that, but it is a consensus amongst all major browsers.
+
+2004-11-01  Sandro Giessl <sandro@giessl.com>
+
+        * rendering/render_replaced.cpp (copyWidget): don't fill the
+	background of QFrames. they paint their own background now
+
+2004-10-30  Stephan Kulow  <coolo@kde.org>
+
+        * html/html_formimpl.cpp (parseAttribute): ignore height element
+        for input elements that are not image
+
+2004-10-28  Stephan Kulow  <coolo@kde.org>
+
+        * html/html_documentimpl.cpp (determineParseMode): adding a fixed list of
+        doctypes to enable quirks mode on (derived from Webcore, but majorly revised)
+        * enable strict CSS parsing also for transitional doctypes
+
+2004-10-27  Germain Garand  <germain@ebooksfrance.com>
+
+        make font-sizes CSS2.1 compliant.
+
+        * css/cssstyleselector.cpp (computeFontSizes): use standard ratios
+        from CSS 2.1 15.7.
+        (applyRule): don't apply zoom factor to ems/exs relative values (#91228).
+
+        * css/html4.css: Hx elements - margin ratios are now 1.1/corresponding ratio.
+        Switch to absolute sizes from CSS 2.1 15.7
+
+2004-10-27  Stephan Kulow  <coolo@kde.org>
+
+        * css/cssstyleselector.cpp (checkOneSelector): match exact matches case sensitive
+        only in XHTML - HTML attributes are all case insensitive
+
+2004-10-26  Stephan Kulow  <coolo@kde.org>
+
+        * html/html_elementimpl.cpp (addCSSProperty): don't add all css properties in
+        lower case but select those those where it matters
+
+2004-10-26  Allan Sandfeld Jensen <kde@carewolf.com>
+
+        * rendering/bidi.{h,cpp}: Merge bidi-changes from WebCore
+
+2004-10-26  David Faure  <faure@kde.org>
+
+        * khtml_part.cpp (urlSelected): Only call recursiveFrameRequest if target is
+        different from _self, _top, _blank and _parent. See tests/frames/target/*.
+
+2004-10-25  David Faure  <faure@kde.org>
+
+        * khtml_part.cpp (processObjectRequest): connect to completed(bool) for <embed>
+        too, to avoid a never-ending-spinning-wheel on the following testcase
+        <META HTTP-EQUIV="Refresh" content="10;URL=www.kde.org"><EMBED>
+
+2004-10-25  Stephan Kulow  <coolo@kde.org>
+
+        * html/html_elementimpl.cpp (addCSSProperty): add css properties parsed from
+        attributes as lower case
+
+2004-10-25  George Staikos  <staikos@kde.org>
+
+        * rendering/render_image.cpp: Pass through the CachedObject so we can
+        use the suggested filename possibly provided by the HTTP headers.
+
+	* khtml_ext.cpp: Make use of the suggested filename for images.
+
+2004-10-24  David Faure  <faure@kde.org>
+
+        * html/html_formimpl.cpp (value): Fixed m_value vs ATTR_VALUE problem
+        which didn't allow sending mail on gmail.google.com. Testcases:
+        forms/form_setattribute.html, mozilla/dom/dom-html/{hfor009.html,hinp017.html}
+
+2004-10-22  Stephan Kulow  <coolo@kde.org>
+
+        * ecma/kjs_window.cpp (tryCall): merging handling of event handlers
+
+        * css/cssparser.cpp (parseValue): implementing CSS 2.1 compliant parsing
+        of background-position (#91572)
+
+2004-10-21  Allan Sandfeld Jensen <kde@carewolf.com>
+
+        Implement limited DHTML capabilities to the layer implementation
+
+        * html/html_miscimpl.{h,cpp}: Extract collection of all layers
+        * dom/html_block.{h,cpp}: Add layer DOM
+        * dom/html_document.{h,cpp}: Add .layers to document DOM
+        * ecma/kjs_html.{h,cpp}: Add layer DHTML and allow layers to be found by ID
+        * ecma/kjs_window.cpp: Allow layers to be found by ID
+
+2004-10-19  Allan Sandfeld Jensen <kde@carewolf.com>
+
+        * rendering/render_box.{h,cpp}: Merge min,max-height fixes
+
+2004-10-19  Germain Garand  <germain@ebooksfrance.org>
+
+        finish merge of static position for positioned objects
+
+        * css/cssstyleselector.cpp (adjustRenderStyle): remember our original display
+        * rendering/bidi.cpp (appendRun): include positioned objects with static X/Y,
+        now that we use those.
+        (findNextLineBreak): adjust static position
+
+        * rendering/render_block.cpp (layoutBlockChildren): ditto.
+
+        * rendering/render_box.cpp (containingBlockWidth): use usesLineWidth
+        (position): activate static position logic
+        (calcAbsoluteHorizontal): replace static position calculation
+        (calcAbsoluteVertical): ditto.
+
+        * rendering/render_object.cpp (removeChild): fix typo
+        (usesLineWidth): merge usesLineWidth from WebCore
+
+        * rendering/render_style.h (NonInheritedFlags::): originalDisplay member
+        (setBitDefaults): initialize the above
+        (originalDisplay/setOriginalDisplay): accessors
+        (isDisplayReplacedType/isDisplayInlineType/isOriginalDisplayInlineType):
+        helpers
+
+2004-10-18  Allan Sandfeld Jensen <kde@carewolf.com>
+
+        * rendering/render_table.cpp: Merge layout fixes from Webcore
+
+2004-10-17  Stephan Kulow  <coolo@kde.org>
+
+        * ecma/kjs_dom.cpp: adding patch by Richard Lärkäng to support IE
+        extension insertAdjacentHTML (#33968)
+
+2004-10-16  Allan Sandfeld Jensen <kde@carewolf.com>
+
+        * html/html_formimpl.cpp: Escape otherwise unencodable characters.
+        Matches the behavior of Gecko.
+
+2004-10-15  Stephan Kulow  <coolo@kde.org>
+
+        * rendering/render_form.cpp (updateFromElement): don't set assume <select>
+        got items when we calculate a height for items (#87466)
+
+        * css/html4.css: changing default horizontal margins for H1-H6 from
+        auto to 0 (#91327)
+
+2004-10-15  Germain Garand  <germain@ebooksfrance.org>
+
+        bring z-order to QScrollView
+
+        * html/html_formimpl.cpp (defaultEventHandler): propagate events to
+        QScrollView
+
+        * khtmlview.{cpp,h}: QScrollview needs fast repaints. Fix
+        background color of QFrames.
+
+        * rendering/render_form.cpp (createListBox/TextAreaWidget):
+        make those widgets z-ordered as well.
+
+        * rendering/render_replaced.cpp (paintWidget): optimize painting by
+        avoiding unnecessary background repaints and by using a shared
+        paint buffer.
+
+2004-10-15  Germain Garand  <germain@ebooksfrance.org>
+
+        display: compact fixes.
+
+        * rendering/bidi.cpp: remove checks for display: compact,
+        not needed anymore.
+
+        * rendering/render_block.cpp (layoutBlockChildren):
+        simpler implementation for compact display: do not insert the
+        compact child within the next block anymore.
+        Solves lot of problems with host blocks having non-inline children.
+
+        * rendering/render_object.{cpp,h} (getVerticalPosition): add
+        ability to compute vertical position with respect to other
+        RenderObjects than parent.
+
+2004-10-14  David Faure  <faure@kde.org>
+
+        * html/htmltokenizer.cpp (parseTag): Merged patch by John Sullivan (safari)
+        to refuse skip more <script> tags depending on the value of type and language.
+
+        * html/html_documentimpl.cpp (determineParseMode):
+        When the document is loaded as text/html, even if xhtml doctype, activate case-insensitive
+        ("htmlCompat") lookup of tags and attributes (but not in CSS parser). (#86446)
+
+2004-10-14  Allan Sandfeld Jensen <kde@carewolf.com>
+        * rendering/*.*: WebCore merge/port of layouted->needsLayout
+
+2004-10-11  David Faure  <faure@kde.org>
+
+        * xml/dom_nodeimpl.cpp (dispatchGenericEvent): Fixed stopPropagation
+        when called from the target node itself (#90750).
+
+2004-10-11  Harri Porten  <porten@kde.org>
+
+	* ecma/*.cpp: return an empty string (instead of null) when
+	querying unset string properties
+
+	* ecma/kjs_html.cpp: use full url for Image.src.
+
+2004-10-08  David Faure  <faure@kde.org>
+
+        * ecma/kjs_html.cpp (KJS::HTMLCollection::tryGet):
+        return Undefined instead of Null for out-of-range indices.
+
+2004-10-07  Germain Garand  <germain@ebooksfrance.org>
+
+        * rendering/render_block.cpp
+        (updateFirstLetter): move update of first-letter from addChildToFlow to
+        setStyle/close. Better drilling logic. Use RenderTextFragment to
+        correctly handle text-transform on first-letter(#76078).
+        (addChildToFlow): ditto. fix display: block on pseudo-elements (#90917)
+        (layoutBlockChildren): only clear if floats actually changed our
+        height.
+        * rendering/render_object.h (node): accessor to m_node
+        * rendering/render_text.{cpp,h}: merge RenderTextFragment class
+        * xml/dom_nodeimpl.h (setRenderer): accessor
+
+2004-10-07  Allan Sandfeld Jensen <kde@carewolf.com>
+        * rendering/render_style.h:
+        WebCore merge of paged media attributes (#68930).
+        * rendering/render_block.cpp (paintObject):
+        Break on page-break-before and -after.
+        * rendering/render_canvas.{h,cpp}:
+        Merge bestTruncatedAt from WebCore.
+        * khtmlview.cpp (print):
+        Use bestTruncatedAt for detect truncated pages.
+
 2004-10-07  David Faure  <faure@kde.org>
 
         * xml/dom_nodeimpl.cpp (dispatchWindowEvent): Emit load event for frames
         from there, to avoid bubbling (safari merge)
 
+2004-10-05  Rob Buis   <buis@kde.org>
+	* render/render_form.{cpp,h}:
+	Implemented onchange event generating for checkbox and radio buttons (fixes #51765).
+
 2004-10-05  David Faure  <faure@kde.org>
 
-        * html/html_baseimpl.cpp (parseAttribute): 
+        * html/html_baseimpl.cpp (parseAttribute):
         Set event listener on frame element itself (fixes #72440)
         * xml/dom_docimpl.cpp (ownerElement): Safari merge.
-        * html/html_documentimpl.cpp (close): 
+        * html/html_documentimpl.cpp (close):
         Emit onload event for frames (famous gmail bug).
 
-        * ecma/kjs_html.cpp (getValueProperty): 
+        * ecma/kjs_html.cpp (getValueProperty):
         Don't return null when innerText or innerHTML is empty.
 
 2004-10-04  David Faure  <faure@kde.org>
 
-        * khtml_part.cpp (processObjectRequest): 
+        * khtml_part.cpp (processObjectRequest):
         Fixed showing of iframe hidden with display=none (#84332).
 
+2004-09-16  Leo Savernik  <l.savernik@aon.at>
+
+ * rendering/render_inline.{cpp,h} (paintOutline): removed.
+ (paintOutlinePath): Paints an outline by following a path consisting of
+ rectangular line segments.
+ (appendIfNew): Append point if not contained at end.
+ (reduceSpike): Reduce spikes.
+ (reduceSegmentSeparators): Redoce segment separators.
+ (appendPoint): Appends point with reductions.
+ (collectHorizontalBoxCoordinates): Determines points for top-/bottommost line box.
+ (lineBoxesDisjoint): Checks whether two line boxes don't share a common x-range.
+ (collectVerticalBoxCoordinates): Determines points for left/right sides of line boxes.
+ (linkBeginToEnd): Links the last point to the first one, reducing even more.
+ (paintOutlines): Uses new painting outline algorithm.
+ (kSwap): Swaps two variables (candidate for misc?)
+ (bsOrientation): returns whether border side is horizontal/vertical.
+ (newBorderSide): Determines new border side.
+ (paintOutlineSegment): Paints a straight outline segment.
+
 2004-09-11  David Faure  <faure@kde.org>
 
-        * khtml_part.cpp (defaultEncoding, encoding, createDecoder): 
+        * khtml_part.cpp (defaultEncoding, encoding, createDecoder):
         Make default charset latin1 over HTTP, keep default to locale on other protocols.
 
+2004-09-02  Leo Savernik  <l.savernik@aon.at>
+
+ * html_formimpl.{cpp,h} (HTMLTextAreaElementImpl::value):
+        Only take text from RenderTextArea when it has been fully initialized.
+        Mark it fully initialized when RenderTextArea has been initialized
+        from the DOM.
+        (HTMLTextAreaElementImpl::setValue): Mark element as initialized after
+        setting.
+        * render_form.cpp (RenderTextArea::setStyle):
+        Block signals on call to QTextEdit::setAlignment. Otherwise, a bogus
+        textChanged signal is emitted.
+
+2004-08-27  Germain Garand  <germain@ebooksfrance.org>
+
+        scope: - more accurate completed() signal.
+               - anchor jumps (#57360)
+
+        * khtml_part.cpp (openURL): when restoring a previous scroll
+        position on reload, avoid jumping to anchors.
+        (gotoAnchor): keep jumping at least while we are parsing.
+        (gotoAnchor): "top" and "" anchors mean top of document.
+
+        (checkCompleted): entrust the view to emit completed on our behalf
+        after any pending layout/repaint is done.
+
+        * khtmlview.{cpp,h}: ditto
+
+        * xml/dom_nodeimpl.cpp (getUpperLeftCorner/getLowerRightCorner):
+        use inlineYPos for text objects (#57360 c.#17).
+
+2004-08-27  Leo Savernik  <l.savernik@aon.at>
+
+	* html/html_tableimpl.cpp (HTMLTableCellElementImpl::attach):
+	Fixed explicit setting of border to 0 width.
+
+2004-08-24  Leo Savernik  <l.savernik@aon.at>
+
+	* ecma/kjs_html.{cpp,h} (HTMLDocument):
+	Added Javascript-support for HTMLDocument.compatMode.
+
+2004-08-23  Leo Savernik  <l.savernik@aon.at>
+
+	* rendering/render_layer.{cpp,h} (Marquee): Added a stop method for
+	the ECMAScript invokation.
+	Fixed starting and stopping and suspending by properly discriminating
+	against them.
+
+2004-08-19  Germain Garand  <germain@ebooksfrance.org>
+
+        * rendering/render_body.cpp (setStyle): only disallow fixed positioning
+        on body, not relative/absolute (#77048, #76982).
+
+        * rendering/render_box.cpp (paintBackgroundExtended): make sure backgrounds paint
+        in the border box and not just in the padding box (WC merge - meyerweb.com/unsorted/bg-position.html).
+
+2004-08-18  Leo Savernik  <l.savernik@aon.at>
+
+	* rendering/render_block.cpp (layoutBlock, layoutBlockChildren,
+	layoutPositionedObject): Ensure that m_overflowWidth/m_overflowHeight
+	get updated properly to include relatively positioned
+	elements, but to exclude the overflow-area of clipped children.
+
+	* rendering/render_box.cpp (repaint): Removed superfluous null ptr check.
+	Use effectiveWidth/Height instead of overflowWidth/Height.
+
+	* rendering/render_canvas.cpp (docHeight): Fixed superfluous vertical
+	scrollbars on clipped children.
+	(docWidth): Fixed superfluous horizontal scrollbars on clipped children.
+
+	* rendering/render_flow.cpp (repaint):
+	Use effectiveWidth/Height instead of overflowWidth/Height.
+
+	* rendering/render_object.h: Added effectiveWidth/Height.
+	Made hasClip and hasOverflowClip const.
+
 2004-08-05  Germain Garand  <germain@ebooksfrance.org>
 
         * rendering/render_block.cpp (layoutBlockChildren): when positionning floats,
@@ -31,7 +415,7 @@
         self-collapsing blocks in between (#85150).
         (calcMinMaxWidth): better calculation merged from WebCore.  Fixes a few testcases.
 
-        * rendering/render_object.h (collapsedMarginTop/Bottom): don't avoid max(Top|Bottom)Margin, 
+        * rendering/render_object.h (collapsedMarginTop/Bottom): don't avoid max(Top|Bottom)Margin,
         they are virtuals reimplemented for RenderBlock.
 
         * rendering/render_object.cpp (createObject): do not set the style before
@@ -75,15 +459,15 @@
 
         * css/parser.y: catching imports that come between rules.
         They have to be ignored (css1/test11.htm)
-	
+
 2004-07-14 Jean-Baptiste Mardelle <bj@altern.org>
-	* khtmlview.{cpp,h}: Accesskeys now activated when pressing & releasing 
+	* khtmlview.{cpp,h}: Accesskeys now activated when pressing & releasing
 	the crtl key (#83053).
 
 2004-07-12 Jean-Baptiste Mardelle <bj@altern.org>
 	* html/html_formimpl.{h,cpp}: Make form labels clickable (#59489)
 	* khtmlview.cpp (focusNodeWithAccessKey): Make accesskeys work for labels
-	
+
 2004-07-12 Germain Garand <germain@ebooksfrance.org>
 
 	* ecma/kjs_navigator.{h,cpp} (getValueProperty):
@@ -92,8 +476,8 @@
 
 2004-07-10 Germain Garand <germain@ebooksfrance.org>
 
-        * rendering/render_layer.cpp (calculateClipRects): 
-        absolutely positioned objects must update the overflowClipRect 
+        * rendering/render_layer.cpp (calculateClipRects):
+        absolutely positioned objects must update the overflowClipRect
         passed to relatively positioned child layers to match the
         posClipRect in effect (#67665/#72994).
 
@@ -108,12 +492,12 @@
 
 2004-06-26  Germain Garand  <germain@ebooksfrance.org>
 
-        * css/html4.css: 
+        * css/html4.css:
         - do not set vertical-align on the table: it breaks inline-table's
         default (baseline). cf.webcore/fast/inline-block/001.html
         - default all of tbody/tfoot/thead to 'vertical-align: middle'
         as per specification.
-        
+
         * rendering/render_object.cpp:
         (getVerticalPosition): fix inverted logic. cf.unsorted/74399.html
         (lineHeight/baselinePosition): inline-blocks behaves like replaced elements
@@ -123,18 +507,18 @@
         inline-tables need positioning. cf.webcore/fast/inline-block/001.html
 
         * rendering/render_box.cpp (calcAbsoluteHorizontal): subtract p/b width
-        when shrinking-to-fit, otherwise it gets accounted for twice. 
+        when shrinking-to-fit, otherwise it gets accounted for twice.
 
 2004-06-22  Zack Rusin  <zack@kde.org>
 
         * ecma/kjs_events.cpp (JSLazyEventListener): Adding a destructor
-        which is now needed since Niko's eventlistener changes make 
-        jseventlistener destructor not remove the listener from 
+        which is now needed since Niko's eventlistener changes make
+        jseventlistener destructor not remove the listener from
         jsEventListeners
 
 2004-06-22  Germain Garand  <germain@ebooksfrance.org>
 
-        Scope: Inline-blocks inlining. Merge Webcore improvements for 
+        Scope: Inline-blocks inlining. Merge Webcore improvements for
         Fieldset/Legend
 
         * css/html4.css: Legend => display: block.
@@ -162,22 +546,22 @@
 
         Scope: avoid leaking placeholder InlineBoxes. Cleanups.
 
-        * rendering/bidi.cpp (Bidinext): simplified logic. Do not return each 
+        * rendering/bidi.cpp (Bidinext): simplified logic. Do not return each
         InlineFlow twice.
         (layoutInlineChildren): clear InlineBoxes on relayout.
 
-        * rendering/render_object.{cpp,h}: 
+        * rendering/render_object.{cpp,h}:
         (deleteInlineBoxes): new virtual method.
 
         * rendering/render_box.{cpp,h}: added m_placeHolderBox member.
-        (createInlineBox/deleteInlineBoxes): reimplemented. 
+        (createInlineBox/deleteInlineBoxes): reimplemented.
 
         * rendering/render_flow.{cpp,h}:
-        (createInlineBox/deleteInlineBoxes): ditto. 
+        (createInlineBox/deleteInlineBoxes): ditto.
 
         * rendering/render_replaced.cpp (detach): call deleteLineBoxes
 
-        * rendering/render_text.{cpp,h} (deleteInlineBoxes): reimplemented, replacing 
+        * rendering/render_text.{cpp,h} (deleteInlineBoxes): reimplemented, replacing
         deleteTextBoxes
         (~RenderText): no need to clear lineboxes twice.
 
@@ -249,7 +633,7 @@
         * dom/html_elementimpl.h (innerHTML): implement in terms of
         toString,
         * xml/dom_nodeimpl.{h,cpp}: remove the toHTML and recursive_toHTML
-        methods, 
+        methods,
 
 2004-06-09  Zack Rusin  <zack@kde.org>
 
@@ -260,7 +644,7 @@
         the DOM tree back to a string
 
 2004-06-09  Zack Rusin  <zack@kde.org>
-        
+
         * xml/xml_tokenizer.{h,cpp}: adding bool isWaitingForScripts()
         const method to tokenizer interface which should return true if
         the tokenizer is waiting for scripts to finish. Adding the method
@@ -269,10 +653,10 @@
         method,
         * xml/dom_docimpl.cpp (close): On an explicit document.close()
         don't destroy the  tokenizer if it's still waiting on external
-        scripts  
-        
+        scripts
+
 2004-06-09  Zack Rusin  <zack@kde.org>
-        
+
         * ecma/kjs_events.{h,cpp}: made the listener in jseventlistener an
         object instead of a value and switch its function accordingly,
         adding JSLazyEventListener which delays evaluation of event
@@ -284,9 +668,9 @@
         listener implementation is in place (listener is valid),
         * ecma/kjs_proxy.cpp (createHTMLEventHandler): switched to use
         getJSLazyEventListener,
-        
+
 2004-06-08  Zack Rusin  <zack@kde.org>
-        
+
         * html/htmltokenizer.cpp (parseEntity): Fix to make 8-character
         hexadecimal entities work in khtml from Darin Adler. Testcase at
         http://www.alanwood.net/unicode/deseret.html
@@ -296,7 +680,7 @@
         * xml/dom_docimpl.cpp (getId): do html lookup if specified even if not
         in a html document since elements can be in xhtml the namespace
 
-        * xml/dom_docimpl.h (hasPendingSheets): adding function returning true, 
+        * xml/dom_docimpl.h (hasPendingSheets): adding function returning true,
         if stylesheets are currently loading for document.
 
         * xml/xml_tokenizer.cpp: Merging table hack for XML parsing from
@@ -306,12 +690,12 @@
 
 2004-06-02  Zack Rusin  <zack@kde.org>
 
-        * xml/dom_xmlimpl.cpp: Correctly handle stylesheet loading in 
+        * xml/dom_xmlimpl.cpp: Correctly handle stylesheet loading in
         XML documents (try to avoid FOUC)
 
         * xml/xml_tokenizer.{h,cpp}: Added pushNode(), popNode() and
         currenNode() methods. Removed m_currentNode memeber and switched
-        node construction to a stack based ones. Try to attach to the 
+        node construction to a stack based ones. Try to attach to the
         parent of the tag which encloses us if it can't handle children.
 
 2004-05-28  Leo Savernik  <l.savernik@aon.at>
diff -urN -x CVS kdelibs.orig/khtml/DESIGN.html kdelibs/khtml/DESIGN.html
--- kdelibs.orig/khtml/DESIGN.html	Fri Feb 13 21:53:18 2004
+++ kdelibs/khtml/DESIGN.html	Wed Nov 17 14:59:14 2004
@@ -342,7 +342,5 @@
 And now have fun hacking khtml.
 <div style="margin-left: 10em; margin-bottom: 1em;">Lars</div>
 </div>
-<hr>
-<center>$Id$</center>
 </body>
 </html>
diff -urN -x CVS kdelibs.orig/khtml/Makefile.am kdelibs/khtml/Makefile.am
--- kdelibs.orig/khtml/Makefile.am	Mon Mar 22 00:55:24 2004
+++ kdelibs/khtml/Makefile.am	Wed Nov 10 10:00:14 2004
@@ -124,3 +124,6 @@
 DOXYGEN_REFERENCES = kdecore kdeui kio kdefx kparts
 DOXYGEN_EXCLUDE =  test*.* html rendering xml misc pics test
 include ../admin/Doxyfile.am
+
+.PHONY: parser
+
diff -urN -x CVS kdelibs.orig/khtml/css/Makefile.am kdelibs/khtml/css/Makefile.am
--- kdelibs.orig/khtml/css/Makefile.am	Sun Mar 21 21:39:47 2004
+++ kdelibs/khtml/css/Makefile.am	Wed Nov 10 10:00:16 2004
@@ -56,8 +56,5 @@
 	else mv parser.tab.h parser.h; fi \
 	else :; fi
 
-## generate lib documentation
-srcdoc:
-	$(mkinstalldirs) $(SRCDOC_DEST)
-	kdoc -H -d $(SRCDOC_DEST) kdecore -lqt
+.PHONY: parser 
 
diff -urN -x CVS kdelibs.orig/khtml/css/css_base.cpp kdelibs/khtml/css/css_base.cpp
--- kdelibs.orig/khtml/css/css_base.cpp	Sun Feb 15 16:28:46 2004
+++ kdelibs/khtml/css/css_base.cpp	Wed Nov 10 10:00:16 2004
@@ -260,24 +260,24 @@
     // #### fix namespace
     DOMString str;
     const CSSSelector* cs = this;
-    if ( cs->tag == 0xffff && cs->attr == ATTR_ID && cs->match == CSSSelector::Exact )
+    if ( cs->tag == 0xffffffff && cs->attr == ATTR_ID && cs->match == CSSSelector::Exact )
     {
         str = "#";
         str += cs->value;
     }
-    else if ( cs->tag == 0xffff && cs->attr == ATTR_CLASS && cs->match == CSSSelector::List )
+    else if ( cs->tag == 0xffffffff && cs->attr == ATTR_CLASS && cs->match == CSSSelector::List )
     {
         str = ".";
         str += cs->value;
     }
-    else if ( cs->tag == 0xffff && cs->match == CSSSelector::Pseudo )
+    else if ( cs->tag == 0xffffffff && cs->match == CSSSelector::Pseudo )
     {
         str = ":";
         str += cs->value;
     }
     else
     {
-        if ( cs->tag == 0xffff )
+        if ( cs->tag == 0xffffffff )
             str = "*";
         else
             str = getTagName( cs->tag );
@@ -335,6 +335,8 @@
         DOMString tagHistoryText = cs->tagHistory->selectorText();
         if ( cs->relation == Sibling )
             str = tagHistoryText + " + " + str;
+        else if ( cs->relation == Cousin )
+            str = tagHistoryText + " ~ " + str;
         else if ( cs->relation == Child )
             str = tagHistoryText + " > " + str;
         else if ( cs->relation == SubSelector )
diff -urN -x CVS kdelibs.orig/khtml/css/css_base.h kdelibs/khtml/css/css_base.h
--- kdelibs.orig/khtml/css/css_base.h	Wed Jan 14 22:20:30 2004
+++ kdelibs/khtml/css/css_base.h	Wed Nov 17 14:59:15 2004
@@ -20,7 +20,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #ifndef _CSS_BASE_H
 #define _CSS_BASE_H
@@ -99,7 +98,8 @@
 	    Descendant = 0,
 	    Child,
 	    Sibling,
-	    SubSelector
+            Cousin,
+            SubSelector
 	};
 
 	enum PseudoType
@@ -138,7 +138,7 @@
         DOM::NodeImpl::Id attr;
         DOM::NodeImpl::Id tag;
 
-	Relation relation     : 2;
+	Relation relation     : 3;
 	Match 	 match         : 4;
 	bool	nonCSSHint : 1;
 	unsigned int pseudoId : 3;
diff -urN -x CVS kdelibs.orig/khtml/css/css_extensionsimpl.cpp kdelibs/khtml/css/css_extensionsimpl.cpp
--- kdelibs.orig/khtml/css/css_extensionsimpl.cpp	Tue Dec 10 14:45:05 2002
+++ kdelibs/khtml/css/css_extensionsimpl.cpp	Wed Nov 17 14:43:00 2004
@@ -18,7 +18,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #include "DOMException.h"
 #include "DOMString.h"
diff -urN -x CVS kdelibs.orig/khtml/css/css_extensionsimpl.h kdelibs/khtml/css/css_extensionsimpl.h
--- kdelibs.orig/khtml/css/css_extensionsimpl.h	Sun Oct  7 15:12:19 2001
+++ kdelibs/khtml/css/css_extensionsimpl.h	Wed Nov 17 14:43:00 2004
@@ -18,7 +18,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #ifndef _CSS_css_extensionsimpl_h_
 #define _CSS_css_extensionsimpl_h_
diff -urN -x CVS kdelibs.orig/khtml/css/css_ruleimpl.h kdelibs/khtml/css/css_ruleimpl.h
--- kdelibs.orig/khtml/css/css_ruleimpl.h	Sat Aug 16 08:38:39 2003
+++ kdelibs/khtml/css/css_ruleimpl.h	Wed Nov 17 14:43:00 2004
@@ -20,7 +20,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #ifndef _CSS_css_ruleimpl_h_
 #define _CSS_css_ruleimpl_h_
diff -urN -x CVS kdelibs.orig/khtml/css/css_stylesheetimpl.cpp kdelibs/khtml/css/css_stylesheetimpl.cpp
--- kdelibs.orig/khtml/css/css_stylesheetimpl.cpp	Sat Apr 19 18:04:33 2003
+++ kdelibs/khtml/css/css_stylesheetimpl.cpp	Wed Nov 17 14:59:15 2004
@@ -18,7 +18,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 
 //#define CSS_STYLESHEET_DEBUG
@@ -279,7 +278,7 @@
     QPtrListIterator<StyleSheetImpl> it(styleSheets);
     for (; it.current(); ++it) {
         if (!it.current()->isCSSStyleSheet() || !static_cast<CSSStyleSheetImpl*>(it.current())->implicit())
-            l++;
+            ++l;
     }
     return l;
 }
@@ -292,7 +291,7 @@
         if (!it.current()->isCSSStyleSheet() || !static_cast<CSSStyleSheetImpl*>(it.current())->implicit()) {
             if (l == index)
                 return it.current();
-            l++;
+            ++l;
         }
     }
     return 0;
@@ -315,7 +314,7 @@
 
 bool MediaListImpl::contains( const DOMString &medium ) const
 {
-    return m_lstMedia.count() == 0 || m_lstMedia.contains( medium ) ||
+    return m_lstMedia.empty() || m_lstMedia.contains( medium ) ||
             m_lstMedia.contains( "all" );
 }
 
@@ -333,7 +332,9 @@
 
 void MediaListImpl::deleteMedium( const DOMString &oldMedium )
 {
-    for ( QValueList<DOMString>::Iterator it = m_lstMedia.begin(); it != m_lstMedia.end(); ++it ) {
+    const QValueList<DOMString>::Iterator itEnd = m_lstMedia.end();
+
+    for ( QValueList<DOMString>::Iterator it = m_lstMedia.begin(); it != itEnd; ++it ) {
         if( (*it) == oldMedium ) {
             m_lstMedia.remove( it );
             return;
@@ -344,7 +345,9 @@
 DOM::DOMString MediaListImpl::mediaText() const
 {
     DOMString text;
-    for ( QValueList<DOMString>::ConstIterator it = m_lstMedia.begin(); it != m_lstMedia.end(); ++it ) {
+    const QValueList<DOMString>::ConstIterator itEnd = m_lstMedia.end();
+
+    for ( QValueList<DOMString>::ConstIterator it = m_lstMedia.begin(); it != itEnd; ++it ) {
         text += *it;
         text += ", ";
     }
@@ -354,11 +357,14 @@
 void MediaListImpl::setMediaText(const DOM::DOMString &value)
 {
     m_lstMedia.clear();
-    QString val = value.string();
-    QStringList list = QStringList::split( ',', value.string() );
-    for ( QStringList::Iterator it = list.begin(); it != list.end(); ++it )
+    const QString val = value.string();
+    const QStringList list = QStringList::split( ',', val );
+
+    const QStringList::ConstIterator itEnd = list.end();
+
+    for ( QStringList::ConstIterator it = list.begin(); it != itEnd; ++it )
     {
-        DOMString medium = (*it).stripWhiteSpace();
+        const DOMString medium = (*it).stripWhiteSpace();
         if( !medium.isEmpty() )
             m_lstMedia.append( medium );
     }
diff -urN -x CVS kdelibs.orig/khtml/css/css_stylesheetimpl.h kdelibs/khtml/css/css_stylesheetimpl.h
--- kdelibs.orig/khtml/css/css_stylesheetimpl.h	Sun May 18 00:12:57 2003
+++ kdelibs/khtml/css/css_stylesheetimpl.h	Wed Nov 17 14:43:00 2004
@@ -18,7 +18,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #ifndef _CSS_css_stylesheetimpl_h_
 #define _CSS_css_stylesheetimpl_h_
diff -urN -x CVS kdelibs.orig/khtml/css/css_valueimpl.h kdelibs/khtml/css/css_valueimpl.h
--- kdelibs.orig/khtml/css/css_valueimpl.h	Sun Feb 15 19:49:43 2004
+++ kdelibs/khtml/css/css_valueimpl.h	Wed Nov 17 14:43:00 2004
@@ -19,7 +19,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #ifndef _CSS_css_valueimpl_h_
 #define _CSS_css_valueimpl_h_
diff -urN -x CVS kdelibs.orig/khtml/css/csshelper.cpp kdelibs/khtml/css/csshelper.cpp
--- kdelibs.orig/khtml/css/csshelper.cpp	Fri Mar  1 02:04:06 2002
+++ kdelibs/khtml/css/csshelper.cpp	Wed Nov 17 14:43:00 2004
@@ -18,7 +18,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #include "csshelper.h"
 
diff -urN -x CVS kdelibs.orig/khtml/css/csshelper.h kdelibs/khtml/css/csshelper.h
--- kdelibs.orig/khtml/css/csshelper.h	Thu Apr 17 18:49:26 2003
+++ kdelibs/khtml/css/csshelper.h	Wed Nov 17 14:43:00 2004
@@ -18,7 +18,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #ifndef css_helper_h
 #define css_helper_h
diff -urN -x CVS kdelibs.orig/khtml/css/cssparser.cpp kdelibs/khtml/css/cssparser.cpp
--- kdelibs.orig/khtml/css/cssparser.cpp	Sun Jun 13 19:08:23 2004
+++ kdelibs/khtml/css/cssparser.cpp	Wed Nov 17 14:59:15 2004
@@ -3,8 +3,6 @@
  *
  * Copyright (C) 2003 Lars Knoll (knoll@kde.org)
  *
- * $Id$
- *
  * This library is free software; you can redistribute it and/or
  * modify it under the terms of the GNU Library General Public
  * License as published by the Free Software Foundation; either
@@ -376,7 +374,52 @@
     return b;
 }
 
-bool CSSParser::parseValue( int propId, bool important )
+CSSPrimitiveValueImpl *CSSParser::parseBackgroundPositionXY( int propId, bool forward, bool &ok )
+{
+    if ( forward )
+        valueList->next();
+
+    Value *value = valueList->current();
+
+    ok = true;
+
+    if ( !value )
+        return 0;
+
+    int id = value->id;
+
+    switch ( id ) {
+    case 0:
+        if ( !validUnit( value, FPercent|FLength, strict&(!nonCSSHint) ) )
+            ok = false;
+        break;
+
+    case CSS_VAL_LEFT:
+    case CSS_VAL_RIGHT:
+        if ( propId == CSS_PROP_BACKGROUND_POSITION_Y ) {
+            ok = false;
+            break;
+        }
+    case CSS_VAL_TOP:
+    case CSS_VAL_BOTTOM:
+        if ( propId == CSS_PROP_BACKGROUND_POSITION_X && ( id == CSS_VAL_BOTTOM || id == CSS_VAL_TOP ) ) {
+            ok = false;
+            break;
+        }
+    case CSS_VAL_CENTER:
+        return new CSSPrimitiveValueImpl( id );
+        break;
+    default:
+        ok = false;
+    }
+    if ( !ok )
+        return 0;
+    return new CSSPrimitiveValueImpl( value->fValue,
+                                      (CSSPrimitiveValue::UnitTypes) value->unit );
+}
+
+
+bool CSSParser::parseValue( int propId, bool important, int expected )
 {
     if ( !valueList ) return false;
 
@@ -385,13 +428,12 @@
     if ( !value )
         return false;
 
-    int id = 0;
-    id = value->id;
+    int id = value->id;
 
-    if ( id == CSS_VAL_INHERIT ) {
+    if ( id == CSS_VAL_INHERIT && expected == 1 ) {
         addProperty( propId, new CSSInheritedValueImpl(), important );
         return true;
-    } else if (id == CSS_VAL_INITIAL) {
+    } else if (id == CSS_VAL_INITIAL && expected == 1 ) {
         addProperty(propId, new CSSInitialValueImpl(), important);
         return true;
     }
@@ -541,7 +583,7 @@
         break;
 
     case CSS_PROP_TEXT_ALIGN:
-            // left | right | center | justify | -khtml_center | <string> | inherit
+        // left | right | center | justify | khtml_left | khtml_right | khtml_center | <string> | inherit
         if ( ( id >= CSS_VAL__KHTML_AUTO && id <= CSS_VAL__KHTML_CENTER ) ||
              value->unit == CSSPrimitiveValue::CSS_STRING )
             valid_primitive = true;
@@ -584,97 +626,163 @@
         break;
 
     case CSS_PROP_BACKGROUND_POSITION:
-        if ( id ) {
-            /* Problem: center is ambigous
-             * In case of 'center' center defines X and Y coords
-             * In case of 'center top', center defines the Y coord
-             * in case of 'center left', center defines the X coord
-             */
-            int pos[2];
-            pos[0] = -1;
-            pos[1] = -1;
-            bool invalid = false;
-            switch( id ) {
-            case CSS_VAL_TOP:
+    {
+        CSSPrimitiveValueImpl *pos[2];
+        pos[0] = 0;
+        pos[1] = 0;
+        bool pos_ok[2];
+        pos_ok[0] = true;
+        pos_ok[1] = true;
+
+        // if we loop beyond our values, do not call ->next twice
+        bool skip_next = true;
+
+        /* Problem: center is ambigous
+         * In case of 'center' center defines X and Y coords
+         * In case of 'center top', center defines the Y coord
+         * in case of 'center left', center defines the X coord
+         * in case of 'center 30%' center defines the X coord
+         * in case of '30% center' center defines the Y coord
+         */
+        bool invalid = false;
+        switch( id ) {
+        case CSS_VAL_TOP:
+            pos[0] = parseBackgroundPositionXY( CSS_PROP_BACKGROUND_POSITION_X, true, pos_ok[0] );
+            if ( pos[0] && pos_ok[0] && pos[0]->primitiveType() != CSSPrimitiveValue::CSS_IDENT )
+                pos_ok[0] = false; // after top only key words are allowed
+            pos[1] = new CSSPrimitiveValueImpl( 0, CSSPrimitiveValue::CSS_PERCENTAGE );
+            break;
+        case CSS_VAL_BOTTOM:
+            pos[0] = parseBackgroundPositionXY( CSS_PROP_BACKGROUND_POSITION_X, true, pos_ok[0] );
+            if ( pos[0] && pos_ok[0] && pos[0]->primitiveType() != CSSPrimitiveValue::CSS_IDENT )
+                pos_ok[0] = false; // after bottom only key words are allowed
+            pos[1] = new CSSPrimitiveValueImpl( 100, CSSPrimitiveValue::CSS_PERCENTAGE );
+            break;
+        case CSS_VAL_LEFT:
+            pos[0] = new CSSPrimitiveValueImpl( 0, CSSPrimitiveValue::CSS_PERCENTAGE );
+            pos[1] = parseBackgroundPositionXY( CSS_PROP_BACKGROUND_POSITION_Y, true, pos_ok[1] );
+            // after left everything is allowed
+            break;
+        case CSS_VAL_RIGHT:
+            pos[0] = new CSSPrimitiveValueImpl( 100, CSSPrimitiveValue::CSS_PERCENTAGE );
+            pos[1] = parseBackgroundPositionXY( CSS_PROP_BACKGROUND_POSITION_Y, true, pos_ok[1] );
+            // after right everything is allowed
+            break;
+        case CSS_VAL_CENTER:
+            value = valueList->next();
+            if ( !value ) {
+                // only one 'center'
+                pos[0] = 0;
                 pos[1] = 0;
+            } else {
+                bool ok = true;
+                CSSPrimitiveValueImpl *possibly_x = parseBackgroundPositionXY( CSS_PROP_BACKGROUND_POSITION_Y, false, ok );
+                if ( !ok ) {
+                    assert( !possibly_x );
+                    pos[0] = parseBackgroundPositionXY( CSS_PROP_BACKGROUND_POSITION_X, false, pos_ok[0] );
+                    if ( !pos_ok[0] && expected != 1 ) {
+                        pos_ok[0] = true;
+                        pos[0] = 0;
+                        skip_next = false;
+                    }
+                    pos[1] = 0;
+                } else {
+                    pos[0] = 0;
+                    pos[1] = possibly_x;
+                }
+            }
+            break;
+        case 0: // units
+            pos[0] = parseBackgroundPositionXY( CSS_PROP_BACKGROUND_POSITION_X, false, pos_ok[0] );
+            if ( pos[0] ) {
+                pos[1] = parseBackgroundPositionXY( CSS_PROP_BACKGROUND_POSITION_Y, true, pos_ok[1] );
+
+                if ( pos_ok[1] && pos[1] && pos[1]->primitiveType() == CSSPrimitiveValue::CSS_IDENT ) {
+                    // as the first hit the horizontal value as unit, the second value can only
+                    // be either a unit or center, top or bottom
+                    switch ( pos[1]->getIdent() )
+                    {
+                    case CSS_VAL_RIGHT:
+                    case CSS_VAL_LEFT:
+                        pos_ok[1] = false;
+                        break;
+                    }
+                }
+            }
+            break;
+        default:
+            invalid = true;
+        }
+        if ( invalid )
+            break;
+
+        if ( !pos_ok[0] || !pos_ok[1] ) {
+            delete pos[0];
+            delete pos[1];
+            return false; // invalid
+        }
+
+
+        if ( !pos[0] )
+            pos[0] = new CSSPrimitiveValueImpl( 50, CSSPrimitiveValue::CSS_PERCENTAGE );
+        else if ( pos[0]->primitiveType() == CSSPrimitiveValue::CSS_IDENT )
+        {
+            // map the values to percentages
+            id = pos[0]->getIdent();
+            delete pos[0];
+            switch ( id ) {
+            case CSS_VAL_LEFT:
+                pos[0] =  new CSSPrimitiveValueImpl( 0, CSSPrimitiveValue::CSS_PERCENTAGE );
                 break;
-            case CSS_VAL_BOTTOM:
-                pos[1] = 100;
+            case CSS_VAL_CENTER:
+                pos[0] =  new CSSPrimitiveValueImpl( 50, CSSPrimitiveValue::CSS_PERCENTAGE );
                 break;
-            case CSS_VAL_LEFT:
+            case CSS_VAL_RIGHT:
+                pos[0] =  new CSSPrimitiveValueImpl( 100, CSSPrimitiveValue::CSS_PERCENTAGE );
+                break;
+            default:
                 pos[0] = 0;
+                assert( false );
                 break;
-            case CSS_VAL_RIGHT:
-                pos[0] = 100;
+            }
+        }
+        if ( !pos[1] )
+            pos[1] = new CSSPrimitiveValueImpl( 50, CSSPrimitiveValue::CSS_PERCENTAGE );
+        else if ( pos[1]->primitiveType() == CSSPrimitiveValue::CSS_IDENT )
+        {
+            // map the values to percentages
+            id = pos[1]->getIdent();
+            delete pos[1];
+            switch ( id ) {
+            case CSS_VAL_TOP:
+                pos[1] =  new CSSPrimitiveValueImpl( 0, CSSPrimitiveValue::CSS_PERCENTAGE );
                 break;
-            case  CSS_VAL_CENTER:
+            case CSS_VAL_CENTER:
+                pos[1] =  new CSSPrimitiveValueImpl( 50, CSSPrimitiveValue::CSS_PERCENTAGE );
+                break;
+            case CSS_VAL_BOTTOM:
+                pos[1] =  new CSSPrimitiveValueImpl( 100, CSSPrimitiveValue::CSS_PERCENTAGE );
                 break;
             default:
-                invalid = true;
-            }
-            if ( invalid )
+                pos[1] = 0;
+                assert( false );
                 break;
-            value = valueList->next();
-            if ( value ) {
-                id = value->id;
-                switch( id ) {
-                case CSS_VAL_TOP:
-                    if ( pos[1] != -1 )
-                        invalid = true;
-                    pos[1] = 0;
-                    break;
-                case CSS_VAL_BOTTOM:
-                    if ( pos[1] != -1 )
-                        invalid = true;
-                    pos[1] = 100;
-                    break;
-                case CSS_VAL_LEFT:
-                    if ( pos[0] != -1 )
-                        invalid = true;
-                    pos[0] = 0;
-                    break;
-                case CSS_VAL_RIGHT:
-                    if ( pos[0] != -1 )
-                        invalid = true;
-                    pos[0] = 100;
-                    break;
-                case  CSS_VAL_CENTER:
-                    break;
-                default:
-                    invalid = true;
-                }
-                if ( !invalid )
-                    value = valueList->next();
             }
-            if ( pos[0] == -1 )
-                pos[0] = 50;
-            if ( pos[1] == -1 )
-                pos[1] = 50;
-            addProperty( CSS_PROP_BACKGROUND_POSITION_X,
-                         new CSSPrimitiveValueImpl( pos[0], CSSPrimitiveValue::CSS_PERCENTAGE ),
-                         important );
-            addProperty( CSS_PROP_BACKGROUND_POSITION_Y,
-                         new CSSPrimitiveValueImpl( pos[1], CSSPrimitiveValue::CSS_PERCENTAGE ),
-                         important );
-        } else {
-            bool ok = parseValue( CSS_PROP_BACKGROUND_POSITION_X, important );
-            if ( !ok )
-                break;
-            value = valueList->current();
-            if ( value )
-                ok = parseValue( CSS_PROP_BACKGROUND_POSITION_Y, important );
-            if ( !ok )
-                addProperty( CSS_PROP_BACKGROUND_POSITION_Y,
-                             new CSSPrimitiveValueImpl( 50, CSSPrimitiveValue::CSS_PERCENTAGE ),
-                             important );
         }
-        return true;
-
-    case CSS_PROP_BACKGROUND_POSITION_X:
-    case CSS_PROP_BACKGROUND_POSITION_Y:
-        valid_primitive = validUnit( value, FPercent|FLength, strict&(!nonCSSHint) );
-        break;
+        --expected; // we only expect one as this is always done in one run
+        if ( skip_next )
+            valueList->next();
+        if ( valueList->current() && expected == 0)
+            return false;
 
+        addProperty( CSS_PROP_BACKGROUND_POSITION_X,
+                     pos[0],
+                     important );
+        addProperty( CSS_PROP_BACKGROUND_POSITION_Y,
+                     pos[1],
+                     important );
+        return true;
+    }
     case CSS_PROP_BORDER_SPACING:
     {
         const int properties[2] = { CSS_PROP__KHTML_BORDER_HORIZONTAL_SPACING,
@@ -687,8 +795,8 @@
             return true;
         }
         else if (num == 2) {
-            if (!parseValue(properties[0], important)) return false;
-            if (!parseValue(properties[1], important)) return false;
+            if (!parseValue(properties[0], important, 2)) return false;
+            if (!parseValue(properties[1], important, 1)) return false;
             return true;
         }
         return false;
@@ -969,6 +1077,10 @@
         break;
 
     /* CSS3 properties */
+    case CSS_PROP_BOX_SIZING:        // border-box | content-box | inherit
+        if ( id == CSS_VAL_BORDER_BOX || id == CSS_VAL_CONTENT_BOX )
+            valid_primitive = true;
+        break;
     case CSS_PROP__KHTML_USER_INPUT:        // none | enabled | disabled | inherit
         if ( id == CSS_VAL_NONE || id == CSS_VAL_ENABLED || id == CSS_VAL_DISABLED )
             valid_primitive = true;
@@ -1016,6 +1128,11 @@
             // ['background-color' || 'background-image' ||'background-repeat' ||
         // 'background-attachment' || 'background-position'] | inherit
     {
+        /* FIXME: in case the property is invalid, but parsed a position-x and -y, the
+           invalid catcher will add another _POSITION property, which doesn't really overwrite
+           the X and Y values. But this case is pretty stupid anyway.
+           testcase: "background-position: bottom right; background: center nonsense;" should
+           appear top left (initial values) */
         const int properties[5] = { CSS_PROP_BACKGROUND_IMAGE, CSS_PROP_BACKGROUND_REPEAT,
                                     CSS_PROP_BACKGROUND_ATTACHMENT, CSS_PROP_BACKGROUND_POSITION,
                                     CSS_PROP_BACKGROUND_COLOR };
@@ -1120,6 +1237,7 @@
     }
 
     if ( valid_primitive ) {
+
         if ( id != 0 ) {
             // qDebug(" new value: id=%d", id );
             parsedValue = new CSSPrimitiveValueImpl( id );
@@ -1135,7 +1253,13 @@
             // qDebug(" new quirks value: value=%.2f, unit=%d", value->fValue, value->unit );
             parsedValue = new CSSQuirkPrimitiveValueImpl( value->fValue, CSSPrimitiveValue::CSS_EMS );
         }
+        --expected;
         valueList->next();
+        if ( valueList->current() && expected == 0)
+        {
+            delete parsedValue;
+            parsedValue = 0;
+        }
     }
     if ( parsedValue ) {
         addProperty( propId, parsedValue, important );
@@ -1153,6 +1277,7 @@
     inParseShortHand = true;
 
     bool found = false;
+    bool oldPropIndex = numParsedProperties;
     bool fnd[6]; //Trust me ;)
     for( int i = 0; i < numProperties; i++ )
             fnd[i] = false;
@@ -1169,7 +1294,7 @@
 #ifdef CSS_DEBUG
                 kdDebug(6080) << "LOOKING FOR: " << getPropertyName(properties[propIndex]).string() << endl;
 #endif
-                if ( parseValue( properties[propIndex], important ) ) {
+                if ( parseValue( properties[propIndex], important, numProperties ) ) {
                     fnd[propIndex] = found = true;
 #ifdef CSS_DEBUG
                     kdDebug(6080) << "FOUND: " << getPropertyName(properties[propIndex]).string() << endl;
@@ -1183,6 +1308,12 @@
 #ifdef CSS_DEBUG
             qDebug("didn't find anything" );
 #endif
+
+            // need to nuke the already added values
+            for ( int i = oldPropIndex; i < numParsedProperties; ++i )
+                delete parsedProperties[i];
+
+            numParsedProperties = oldPropIndex;
             inParseShortHand = false;
             return false;
         }
@@ -1212,12 +1343,12 @@
      */
 
     int num = inParseShortHand ? 1 : valueList->numValues;
-    // qDebug("parse4Values: num=%d", num );
+    //qDebug("parse4Values: num=%d %d", num,  valueList->numValues );
 
     // the order is top, right, bottom, left
     switch( num ) {
     case 1: {
-        if( !parseValue( properties[0], important ) ) return false;
+        if( !parseValue( properties[0], important, valueList->numValues ) ) return false;
         CSSValueImpl *value = parsedProperties[numParsedProperties-1]->value();
         addProperty( properties[1], value, important );
         addProperty( properties[2], value, important );
@@ -1226,8 +1357,8 @@
     }
     case 2: {
 
-        if( !parseValue( properties[0], important ) ) return false;
-        if( !parseValue( properties[1], important ) ) return false;
+        if( !parseValue( properties[0], important, valueList->numValues ) ) return false;
+        if( !parseValue( properties[1], important, valueList->numValues) ) return false;
         CSSValueImpl *value = parsedProperties[numParsedProperties-2]->value();
         addProperty( properties[2], value, important );
         value = parsedProperties[numParsedProperties-2]->value();
@@ -1235,18 +1366,18 @@
         return true;
     }
     case 3: {
-        if( !parseValue( properties[0], important ) ) return false;
-        if( !parseValue( properties[1], important ) ) return false;
-        if( !parseValue( properties[2], important ) ) return false;
+        if( !parseValue( properties[0], important, valueList->numValues ) ) return false;
+        if( !parseValue( properties[1], important, valueList->numValues ) ) return false;
+        if( !parseValue( properties[2], important, valueList->numValues ) ) return false;
         CSSValueImpl *value = parsedProperties[numParsedProperties-2]->value();
         addProperty( properties[3], value, important );
         return true;
     }
     case 4: {
-        if( !parseValue( properties[0], important ) ) return false;
-        if( !parseValue( properties[1], important ) ) return false;
-        if( !parseValue( properties[2], important ) ) return false;
-        if( !parseValue( properties[3], important ) ) return false;
+        if( !parseValue( properties[0], important, valueList->numValues ) ) return false;
+        if( !parseValue( properties[1], important, valueList->numValues ) ) return false;
+        if( !parseValue( properties[2], important, valueList->numValues ) ) return false;
+        if( !parseValue( properties[3], important, valueList->numValues ) ) return false;
         return true;
     }
     default:
@@ -1577,7 +1708,7 @@
 }
 
 
-static bool parseColor(const QString &name, QRgb& rgb)
+static bool parseColor(int unit, const QString &name, QRgb& rgb)
 {
     int len = name.length();
 
@@ -1605,12 +1736,14 @@
         }
     }
 
-    // try a little harder
-    QColor tc;
-    tc.setNamedColor(name.lower());
-    if ( tc.isValid() ) {
-        rgb = tc.rgb();
-        return true;
+    if ( unit == CSSPrimitiveValue::CSS_IDENT ) {
+        // try a little harder
+        QColor tc;
+        tc.setNamedColor(name.lower());
+        if ( tc.isValid() ) {
+            rgb = tc.rgb();
+            return true;
+        }
     }
 
     return false;
@@ -1625,12 +1758,12 @@
               value->fValue >= 0. && value->fValue < 1000000. ) {
         QString str;
         str.sprintf( "%06d", (int)(value->fValue+.5) );
-        if ( !::parseColor( str, c ) )
+        if ( !::parseColor( value->unit, str, c ) )
             return 0;
     } else if ( value->unit == CSSPrimitiveValue::CSS_RGBCOLOR ||
               value->unit == CSSPrimitiveValue::CSS_IDENT ||
               (!strict && value->unit == CSSPrimitiveValue::CSS_DIMENSION) ) {
-        if ( !::parseColor( qString( value->string ), c) )
+        if ( !::parseColor( value->unit, qString( value->string ), c) )
             return 0;
     }
     else if ( value->unit == Value::Function &&
diff -urN -x CVS kdelibs.orig/khtml/css/cssparser.h kdelibs/khtml/css/cssparser.h
--- kdelibs.orig/khtml/css/cssparser.h	Thu Feb 12 23:47:35 2004
+++ kdelibs/khtml/css/cssparser.h	Wed Nov 17 14:59:15 2004
@@ -3,8 +3,6 @@
  *
  * Copyright (C) 2003 Lars Knoll (knoll@kde.org)
  *
- * $Id$
- *
  * This library is free software; you can redistribute it and/or
  * modify it under the terms of the GNU Library General Public
  * License as published by the Free Software Foundation; either
@@ -84,6 +82,7 @@
 	void addValue( const Value &val );
 	Value *current() { return currentValue < numValues ? values + currentValue : 0; }
 	Value *next() { ++currentValue; return current(); }
+        bool isLast() const { return currentValue+1 >= numValues; }
 	Value *values;
 	int numValues;
 	int maxValues;
@@ -113,12 +112,17 @@
 	CSSStyleDeclarationImpl *createStyleDeclaration( CSSStyleRuleImpl *rule );
 	void clearProperties();
 
-	bool parseValue( int propId, bool important );
+	bool parseValue( int propId, bool important, int expected=1 );
 	bool parseShortHand( const int *properties, int numProperties, bool important );
 	bool parse4Values( const int *properties, bool important );
 	bool parseContent( int propId, bool important );
 	bool parseShape( int propId, bool important );
 	bool parseFont(bool important);
+
+        // returns the found property
+        // 0 if nothing found (or ok == false)
+        // @param forward if true, it parses the next in the list
+        CSSPrimitiveValueImpl *parseBackgroundPositionXY( int propId, bool forward, bool &ok );
 	CSSValueListImpl *parseFontFamily();
 	CSSPrimitiveValueImpl *parseColor();
 
diff -urN -x CVS kdelibs.orig/khtml/css/cssproperties.c kdelibs/khtml/css/cssproperties.c
--- kdelibs.orig/khtml/css/cssproperties.c	Sun Jun 13 19:08:23 2004
+++ kdelibs/khtml/css/cssproperties.c	Wed Nov 10 10:00:17 2004
@@ -65,7 +65,7 @@
       408, 408, 408, 408, 408, 408, 408, 408, 408, 408,
       408, 408, 408, 408, 408, 408, 408,   0,   0,   0,
         0,   5, 105,  20,  20,   0, 408,  50,   0,   0,
-        0,   0,   0,   0,   0,  15,   0, 150,  35,  55,
+        0,   0,   0,   0,   0,  15,   0, 150, 100,  55,
        95,  25,  40, 408, 408, 408, 408, 408, 408, 408,
       408, 408, 408, 408, 408, 408, 408, 408, 408, 408,
       408, 408, 408, 408, 408, 408, 408, 408, 408, 408,
@@ -193,7 +193,7 @@
 {
   enum
     {
-      TOTAL_KEYWORDS = 117,
+      TOTAL_KEYWORDS = 118,
       MIN_WORD_LENGTH = 3,
       MAX_WORD_LENGTH = 32,
       MIN_HASH_VALUE = 3,
@@ -230,9 +230,9 @@
       {"position", CSS_PROP_POSITION},
 #line 27 "cssproperties.gperf"
       {"border-bottom-color", CSS_PROP_BORDER_BOTTOM_COLOR},
-#line 117 "cssproperties.gperf"
+#line 118 "cssproperties.gperf"
       {"margin", CSS_PROP_MARGIN},
-#line 119 "cssproperties.gperf"
+#line 120 "cssproperties.gperf"
       {"padding", CSS_PROP_PADDING},
 #line 62 "cssproperties.gperf"
       {"margin-top", CSS_PROP_MARGIN_TOP},
@@ -254,7 +254,7 @@
       {"display", CSS_PROP_DISPLAY},
 #line 22 "cssproperties.gperf"
       {"border-spacing", CSS_PROP_BORDER_SPACING},
-#line 120 "cssproperties.gperf"
+#line 121 "cssproperties.gperf"
       {"scrollbar-base-color", CSS_PROP_SCROLLBAR_BASE_COLOR},
 #line 111 "cssproperties.gperf"
       {"border-right", CSS_PROP_BORDER_RIGHT},
@@ -272,7 +272,7 @@
       {"border-top-style", CSS_PROP_BORDER_TOP_STYLE},
 #line 31 "cssproperties.gperf"
       {"border-bottom-style", CSS_PROP_BORDER_BOTTOM_STYLE},
-#line 116 "cssproperties.gperf"
+#line 117 "cssproperties.gperf"
       {"list-style", CSS_PROP_LIST_STYLE},
 #line 55 "cssproperties.gperf"
       {"height", CSS_PROP_HEIGHT},
@@ -280,11 +280,9 @@
       {"margin-right", CSS_PROP_MARGIN_RIGHT},
 #line 82 "cssproperties.gperf"
       {"padding-right", CSS_PROP_PADDING_RIGHT},
-#line 99 "cssproperties.gperf"
-      {"vertical-align", CSS_PROP_VERTICAL_ALIGN},
 #line 74 "cssproperties.gperf"
       {"min-height", CSS_PROP_MIN_HEIGHT},
-#line 124 "cssproperties.gperf"
+#line 125 "cssproperties.gperf"
       {"scrollbar-3dlight-color", CSS_PROP_SCROLLBAR_3DLIGHT_COLOR},
 #line 103 "cssproperties.gperf"
       {"width", CSS_PROP_WIDTH},
@@ -292,11 +290,9 @@
       {"line-height", CSS_PROP_LINE_HEIGHT},
 #line 75 "cssproperties.gperf"
       {"min-width", CSS_PROP_MIN_WIDTH},
-#line 100 "cssproperties.gperf"
-      {"visibility", CSS_PROP_VISIBILITY},
-#line 126 "cssproperties.gperf"
-      {"scrollbar-track-color", CSS_PROP_SCROLLBAR_TRACK_COLOR},
 #line 127 "cssproperties.gperf"
+      {"scrollbar-track-color", CSS_PROP_SCROLLBAR_TRACK_COLOR},
+#line 128 "cssproperties.gperf"
       {"scrollbar-arrow-color", CSS_PROP_SCROLLBAR_ARROW_COLOR},
 #line 114 "cssproperties.gperf"
       {"border-width", CSS_PROP_BORDER_WIDTH},
@@ -314,7 +310,7 @@
       {"list-style-type", CSS_PROP_LIST_STYLE_TYPE},
 #line 30 "cssproperties.gperf"
       {"border-right-style", CSS_PROP_BORDER_RIGHT_STYLE},
-#line 115 "cssproperties.gperf"
+#line 116 "cssproperties.gperf"
       {"font", CSS_PROP_FONT},
 #line 49 "cssproperties.gperf"
       {"float", CSS_PROP_FLOAT},
@@ -330,7 +326,7 @@
       {"text-decoration", CSS_PROP_TEXT_DECORATION},
 #line 113 "cssproperties.gperf"
       {"border-left", CSS_PROP_BORDER_LEFT},
-#line 122 "cssproperties.gperf"
+#line 123 "cssproperties.gperf"
       {"scrollbar-shadow-color", CSS_PROP_SCROLLBAR_SHADOW_COLOR},
 #line 93 "cssproperties.gperf"
       {"text-align", CSS_PROP_TEXT_ALIGN},
@@ -340,21 +336,23 @@
       {"border-left-color", CSS_PROP_BORDER_LEFT_COLOR},
 #line 34 "cssproperties.gperf"
       {"border-right-width", CSS_PROP_BORDER_RIGHT_WIDTH},
-#line 123 "cssproperties.gperf"
+#line 99 "cssproperties.gperf"
+      {"vertical-align", CSS_PROP_VERTICAL_ALIGN},
+#line 124 "cssproperties.gperf"
       {"scrollbar-highlight-color", CSS_PROP_SCROLLBAR_HIGHLIGHT_COLOR},
 #line 65 "cssproperties.gperf"
       {"margin-left", CSS_PROP_MARGIN_LEFT},
 #line 84 "cssproperties.gperf"
       {"padding-left", CSS_PROP_PADDING_LEFT},
-#line 121 "cssproperties.gperf"
+#line 122 "cssproperties.gperf"
       {"scrollbar-face-color", CSS_PROP_SCROLLBAR_FACE_COLOR},
 #line 105 "cssproperties.gperf"
       {"z-index", CSS_PROP_Z_INDEX},
-#line 53 "cssproperties.gperf"
-      {"font-variant", CSS_PROP_FONT_VARIANT},
+#line 100 "cssproperties.gperf"
+      {"visibility", CSS_PROP_VISIBILITY},
 #line 52 "cssproperties.gperf"
       {"font-style", CSS_PROP_FONT_STYLE},
-#line 118 "cssproperties.gperf"
+#line 119 "cssproperties.gperf"
       {"outline", CSS_PROP_OUTLINE},
 #line 98 "cssproperties.gperf"
       {"unicode-bidi", CSS_PROP_UNICODE_BIDI},
@@ -372,9 +370,9 @@
       {"border-left-style", CSS_PROP_BORDER_LEFT_STYLE},
 #line 73 "cssproperties.gperf"
       {"max-width", CSS_PROP_MAX_WIDTH},
-#line 24 "cssproperties.gperf"
-      {"-khtml-border-vertical-spacing", CSS_PROP__KHTML_BORDER_VERTICAL_SPACING},
-#line 125 "cssproperties.gperf"
+#line 115 "cssproperties.gperf"
+      {"box-sizing", CSS_PROP_BOX_SIZING},
+#line 126 "cssproperties.gperf"
       {"scrollbar-darkshadow-color", CSS_PROP_SCROLLBAR_DARKSHADOW_COLOR},
 #line 43 "cssproperties.gperf"
       {"counter-increment", CSS_PROP_COUNTER_INCREMENT},
@@ -384,20 +382,20 @@
       {"counter-reset", CSS_PROP_COUNTER_RESET},
 #line 23 "cssproperties.gperf"
       {"-khtml-border-horizontal-spacing", CSS_PROP__KHTML_BORDER_HORIZONTAL_SPACING},
-#line 130 "cssproperties.gperf"
+#line 131 "cssproperties.gperf"
       {"-khtml-text-decoration-color", CSS_PROP__KHTML_TEXT_DECORATION_COLOR},
 #line 85 "cssproperties.gperf"
       {"page-break-after", CSS_PROP_PAGE_BREAK_AFTER},
 #line 36 "cssproperties.gperf"
       {"border-left-width", CSS_PROP_BORDER_LEFT_WIDTH},
-#line 80 "cssproperties.gperf"
-      {"overflow", CSS_PROP_OVERFLOW},
 #line 86 "cssproperties.gperf"
       {"page-break-before", CSS_PROP_PAGE_BREAK_BEFORE},
 #line 78 "cssproperties.gperf"
       {"outline-style", CSS_PROP_OUTLINE_STYLE},
 #line 54 "cssproperties.gperf"
       {"font-weight", CSS_PROP_FONT_WEIGHT},
+#line 53 "cssproperties.gperf"
+      {"font-variant", CSS_PROP_FONT_VARIANT},
 #line 106 "cssproperties.gperf"
       {"background", CSS_PROP_BACKGROUND},
 #line 96 "cssproperties.gperf"
@@ -408,11 +406,13 @@
       {"outline-width", CSS_PROP_OUTLINE_WIDTH},
 #line 66 "cssproperties.gperf"
       {"-khtml-marquee", CSS_PROP__KHTML_MARQUEE},
+#line 24 "cssproperties.gperf"
+      {"-khtml-border-vertical-spacing", CSS_PROP__KHTML_BORDER_VERTICAL_SPACING},
 #line 50 "cssproperties.gperf"
       {"font-family", CSS_PROP_FONT_FAMILY},
 #line 16 "cssproperties.gperf"
       {"background-repeat", CSS_PROP_BACKGROUND_REPEAT},
-#line 128 "cssproperties.gperf"
+#line 129 "cssproperties.gperf"
       {"-khtml-flow-mode", CSS_PROP__KHTML_FLOW_MODE},
 #line 18 "cssproperties.gperf"
       {"background-position", CSS_PROP_BACKGROUND_POSITION},
@@ -426,6 +426,8 @@
       {"-khtml-marquee-repetition", CSS_PROP__KHTML_MARQUEE_REPETITION},
 #line 17 "cssproperties.gperf"
       {"background-attachment", CSS_PROP_BACKGROUND_ATTACHMENT},
+#line 80 "cssproperties.gperf"
+      {"overflow", CSS_PROP_OVERFLOW},
 #line 70 "cssproperties.gperf"
       {"-khtml-marquee-speed", CSS_PROP__KHTML_MARQUEE_SPEED},
 #line 20 "cssproperties.gperf"
@@ -434,7 +436,7 @@
       {"-khtml-marquee-style", CSS_PROP__KHTML_MARQUEE_STYLE},
 #line 19 "cssproperties.gperf"
       {"background-position-x", CSS_PROP_BACKGROUND_POSITION_X},
-#line 129 "cssproperties.gperf"
+#line 130 "cssproperties.gperf"
       {"-khtml-user-input", CSS_PROP__KHTML_USER_INPUT}
     };
 
@@ -447,40 +449,40 @@
        21,  -1,  22,  -1,  -1,  23,  -1,  24,  -1,  -1,
        -1,  -1,  -1,  -1,  25,  26,  -1,  27,  -1,  28,
        -1,  29,  30,  31,  32,  -1,  33,  -1,  -1,  34,
-       35,  36,  37,  38,  39,  40,  -1,  -1,  41,  -1,
-       42,  43,  -1,  -1,  44,  45,  46,  -1,  -1,  -1,
-       -1,  47,  48,  -1,  49,  -1,  50,  -1,  -1,  51,
-       -1,  52,  53,  -1,  -1,  54,  -1,  -1,  55,  56,
-       57,  58,  -1,  -1,  59,  -1,  60,  61,  -1,  -1,
-       62,  -1,  -1,  -1,  -1,  -1,  63,  64,  -1,  -1,
-       65,  66,  67,  -1,  -1,  -1,  -1,  -1,  68,  -1,
-       69,  70,  71,  -1,  -1,  72,  -1,  73,  -1,  -1,
-       -1,  -1,  74,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       75,  -1,  76,  -1,  -1,  -1,  -1,  77,  78,  -1,
-       79,  80,  -1,  -1,  81,  -1,  82,  83,  -1,  84,
-       85,  86,  87,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  88,  89,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  90,  91,  -1,  -1,  92,  93,  94,  -1,
-       -1,  -1,  95,  96,  -1,  -1,  97,  -1,  -1,  -1,
+       35,  36,  37,  38,  -1,  39,  -1,  -1,  40,  -1,
+       41,  42,  -1,  -1,  43,  -1,  44,  -1,  -1,  -1,
+       -1,  45,  46,  -1,  47,  -1,  48,  -1,  -1,  49,
+       -1,  50,  51,  -1,  -1,  52,  -1,  -1,  53,  54,
+       55,  56,  -1,  -1,  57,  -1,  58,  59,  -1,  -1,
+       60,  -1,  -1,  -1,  -1,  -1,  61,  62,  -1,  -1,
+       63,  64,  65,  -1,  -1,  -1,  -1,  -1,  66,  67,
+       68,  69,  70,  -1,  -1,  71,  -1,  72,  -1,  -1,
+       73,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       74,  -1,  75,  -1,  -1,  -1,  -1,  76,  77,  -1,
+       78,  79,  -1,  -1,  80,  -1,  81,  82,  -1,  83,
+       84,  85,  86,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  87,  88,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  89,  90,  -1,  -1,  91,  92,  -1,  -1,
+       -1,  -1,  93,  94,  -1,  -1,  95,  96,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       98,  -1,  -1,  -1,  99,  -1, 100,  -1,  -1,  -1,
-       -1,  -1,  -1, 101, 102,  -1, 103, 104,  -1,  -1,
+       97,  -1,  -1,  -1,  98,  -1,  99,  -1,  -1,  -1,
+       -1,  -1,  -1, 100, 101, 102, 103, 104,  -1,  -1,
        -1, 105,  -1,  -1, 106,  -1,  -1,  -1,  -1, 107,
        -1, 108,  -1,  -1, 109, 110, 111,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1, 112,  -1,  -1,  -1,  -1,
-       -1, 113,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1, 114,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1, 112,  -1, 113,  -1,  -1,  -1,  -1,
+       -1, 114,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 115,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1, 115,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1, 116,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1, 116
+       -1,  -1,  -1,  -1,  -1,  -1,  -1, 117
     };
 
   if (len <= MAX_WORD_LENGTH && len >= MIN_WORD_LENGTH)
@@ -502,7 +504,7 @@
     }
   return 0;
 }
-#line 131 "cssproperties.gperf"
+#line 132 "cssproperties.gperf"
 
 static const char * const propertyList[] = {
 "",
@@ -607,6 +609,7 @@
 "border-bottom", 
 "border-left", 
 "border-width", 
+"box-sizing", 
 "font", 
 "list-style", 
 "margin", 
diff -urN -x CVS kdelibs.orig/khtml/css/cssproperties.h kdelibs/khtml/css/cssproperties.h
--- kdelibs.orig/khtml/css/cssproperties.h	Sun Jun 13 19:08:23 2004
+++ kdelibs/khtml/css/cssproperties.h	Wed Nov 10 10:00:17 2004
@@ -109,24 +109,25 @@
 #define CSS_PROP_BORDER_BOTTOM 99
 #define CSS_PROP_BORDER_LEFT 100
 #define CSS_PROP_BORDER_WIDTH 101
-#define CSS_PROP_FONT 102
-#define CSS_PROP_LIST_STYLE 103
-#define CSS_PROP_MARGIN 104
-#define CSS_PROP_OUTLINE 105
-#define CSS_PROP_PADDING 106
-#define CSS_PROP_SCROLLBAR_BASE_COLOR 107
-#define CSS_PROP_SCROLLBAR_FACE_COLOR 108
-#define CSS_PROP_SCROLLBAR_SHADOW_COLOR 109
-#define CSS_PROP_SCROLLBAR_HIGHLIGHT_COLOR 110
-#define CSS_PROP_SCROLLBAR_3DLIGHT_COLOR 111
-#define CSS_PROP_SCROLLBAR_DARKSHADOW_COLOR 112
-#define CSS_PROP_SCROLLBAR_TRACK_COLOR 113
-#define CSS_PROP_SCROLLBAR_ARROW_COLOR 114
-#define CSS_PROP__KHTML_FLOW_MODE 115
-#define CSS_PROP__KHTML_USER_INPUT 116
-#define CSS_PROP__KHTML_TEXT_DECORATION_COLOR 117
+#define CSS_PROP_BOX_SIZING 102
+#define CSS_PROP_FONT 103
+#define CSS_PROP_LIST_STYLE 104
+#define CSS_PROP_MARGIN 105
+#define CSS_PROP_OUTLINE 106
+#define CSS_PROP_PADDING 107
+#define CSS_PROP_SCROLLBAR_BASE_COLOR 108
+#define CSS_PROP_SCROLLBAR_FACE_COLOR 109
+#define CSS_PROP_SCROLLBAR_SHADOW_COLOR 110
+#define CSS_PROP_SCROLLBAR_HIGHLIGHT_COLOR 111
+#define CSS_PROP_SCROLLBAR_3DLIGHT_COLOR 112
+#define CSS_PROP_SCROLLBAR_DARKSHADOW_COLOR 113
+#define CSS_PROP_SCROLLBAR_TRACK_COLOR 114
+#define CSS_PROP_SCROLLBAR_ARROW_COLOR 115
+#define CSS_PROP__KHTML_FLOW_MODE 116
+#define CSS_PROP__KHTML_USER_INPUT 117
+#define CSS_PROP__KHTML_TEXT_DECORATION_COLOR 118
 
 #define CSS_PROP_MAX CSS_PROP_Z_INDEX
-#define CSS_PROP_TOTAL 118
+#define CSS_PROP_TOTAL 119
 #endif
 
diff -urN -x CVS kdelibs.orig/khtml/css/cssproperties.in kdelibs/khtml/css/cssproperties.in
--- kdelibs.orig/khtml/css/cssproperties.in	Sun Jun 13 19:08:23 2004
+++ kdelibs/khtml/css/cssproperties.in	Wed Nov 10 10:00:17 2004
@@ -115,6 +115,7 @@
 border-bottom
 border-left
 border-width
+box-sizing
 font
 list-style
 margin
diff -urN -x CVS kdelibs.orig/khtml/css/cssstyleselector.cpp kdelibs/khtml/css/cssstyleselector.cpp
--- kdelibs.orig/khtml/css/cssstyleselector.cpp	Sun Sep 26 19:06:28 2004
+++ kdelibs/khtml/css/cssstyleselector.cpp	Fri Nov 19 09:58:34 2004
@@ -2,7 +2,9 @@
  * This file is part of the CSS implementation for KDE.
  *
  * Copyright (C) 1999-2003 Lars Knoll (knoll@kde.org)
- * Copyright (C) 2003 Apple Computer, Inc.
+ *           (C) 2003 Apple Computer, Inc.
+ *           (C) 2004 Allan Sandfeld Jensen (kde@carewolf.com)
+ *           (C) 2004 Germain Garand (germain@ebooksfrance.org)
  *
  * This library is free software; you can redistribute it and/or
  * modify it under the terms of the GNU Library General Public
@@ -297,7 +299,7 @@
     s_defaultSheet = 0;
 }
 
-#define MAXFONTSIZES 15
+#define MAXFONTSIZES 9
 
 void CSSStyleSelector::computeFontSizes(QPaintDeviceMetrics* paintDeviceMetrics,  int zoomFactor)
 {
@@ -319,10 +321,10 @@
 #endif // ######### fix isFixed code again.
 
     fontSizes.clear();
-    const float factor = 1.2;
-    float scale = 1.0 / (factor*factor*factor);
-    float mediumFontSize;
-    float minFontSize;
+    float scale = 1.0;
+    static const float fontFactors[] =      {3./5., 3./4., 8./9., 1., 6./5., 3./2., 2., 3., 4.};
+    static const float smallFontFactors[] = {3./4., 5./6., 8./9., 1., 6./5., 3./2., 2., 3., 4.};
+    float mediumFontSize, minFontSize, factor;
     if (!khtml::printpainter) {
         scale *= zoomFactor / 100.0;
 #ifdef APPLE_CHANGES
@@ -338,10 +340,11 @@
         mediumFontSize = 12;
         minFontSize = 6;
     }
-
+    const float* factors = scale*mediumFontSize >= 12.5 ? fontFactors : smallFontFactors;
     for ( int i = 0; i < MAXFONTSIZES; i++ ) {
-        fontSizes << int(KMAX( mediumFontSize * scale + 0.5f, minFontSize));
-        scale *= factor;
+        factor = scale*factors[i];
+        fontSizes << int(KMAX( mediumFontSize*factor +.5f, minFontSize));
+        //kdDebug( 6080 ) << "index: " << i << " factor: " << factors[i] << " font pix size: " << int(KMAX( mediumFontSize*factor +.5f, minFontSize)) << endl;
     }
 }
 
@@ -544,10 +547,8 @@
 
 void CSSStyleSelector::adjustRenderStyle(RenderStyle* style, DOM::ElementImpl *e)
 {
-#ifdef APPLE_CHANGES
      // Cache our original display.
      style->setOriginalDisplay(style->display());
-#endif
 
     if (style->display() != NONE) {
         // If we have a <td> that specifies a float property, in quirks mode we just drop the float
@@ -585,9 +586,10 @@
         }
 
         // After performing the display mutation, check table rows.  We do not honor position:relative on
-        // table rows.  This has been established in CSS2.1 (and caused a crash in containingBlock() on
+        // table rows. This has been established in CSS2.1 (and caused a crash in containingBlock() on
         // some sites).
-        if (style->display() == TABLE_ROW && style->position() == RELATIVE)
+        // Likewise, disallow relative positioning on table sections.
+        if ( style->position() == RELATIVE && (style->display() > INLINE_TABLE && style->display() < TABLE_COLUMN_GROUP) )
             style->setPosition(STATIC);
     }
 
@@ -751,7 +753,10 @@
         cleanpath( u );
     }
     //completeURL( attr.string() );
-    pseudoState = KHTMLFactory::vLinks()->contains( u ) ? PseudoVisited : PseudoLink;
+    bool contains = KHTMLFactory::vLinks()->contains( u );
+    if ( !contains && u.contains('/')==2 )
+      contains = KHTMLFactory::vLinks()->contains( u+'/' );
+    pseudoState = contains ? PseudoVisited : PseudoLink;
 }
 
 void CSSStyleSelector::checkSelector(int selIndex, DOM::ElementImpl *e)
@@ -812,15 +817,28 @@
         }
         case CSSSelector::Sibling:
         {
-		subject = false;
+            subject = false;
             n = n->previousSibling();
-	    while( n && !n->isElementNode() )
-		n = n->previousSibling();
+            while( n && !n->isElementNode() )
+                n = n->previousSibling();
             if( !n ) return;
             ElementImpl *elem = static_cast<ElementImpl *>(n);
             if(!checkOneSelector(sel, elem)) return;
             break;
         }
+        case CSSSelector::Cousin:
+        {
+            subject = false;
+            ElementImpl *elem = 0;
+            do {
+                n = n->previousSibling();
+                while( n && !n->isElementNode() )
+                    n = n->previousSibling();
+                if( !n ) return;
+                elem = static_cast<ElementImpl *>(n);
+            } while (!checkOneSelector(sel, elem));
+            break;
+        }
         case CSSSelector::SubSelector:
 	{
             if (onlyHoverActive)
@@ -863,7 +881,7 @@
 	selectorCache[ selIndex ].state = Applies;
     //qDebug( "selector %d applies", selIndex );
     //selectors[ selIndex ]->print();
- 	return;
+    return;
 }
 
 bool CSSStyleSelector::checkOneSelector(DOM::CSSSelector *sel, DOM::ElementImpl *e)
@@ -907,6 +925,16 @@
         switch(sel->match)
         {
         case CSSSelector::Exact:
+            /* attribut values are case insensitive in all HTML modes,
+               even in the strict ones */
+            if ( e->getDocument()->htmlMode() != DocumentImpl::XHtml ) {
+                if ( strcasecmp(sel->value, value) )
+                    return false;
+            } else {
+                if ( strcmp(sel->value, value) )
+                    return false;
+            }
+            break;
         case CSSSelector::Id:
 	    if( (strictParsing && strcmp(sel->value, value) ) ||
                 (!strictParsing && strcasecmp(sel->value, value)))
@@ -1009,42 +1037,42 @@
 	    break;
 	case CSSSelector::PseudoFirstChild: {
 	    // first-child matches the first child that is an element!
-                if (e->parentNode() && e->parentNode()->isElementNode()) {
-                    DOM::NodeImpl* n = e->previousSibling();
-                    while ( n && !n->isElementNode() )
-                        n = n->previousSibling();
-                    if ( !n )
-                        return true;
-                }
-                break;
+            if (e->parentNode() && e->parentNode()->isElementNode()) {
+                DOM::NodeImpl* n = e->previousSibling();
+                while ( n && !n->isElementNode() )
+                    n = n->previousSibling();
+                if ( !n )
+                    return true;
+            }
+            break;
+        }
+        case CSSSelector::PseudoLastChild: {
+            // last-child matches the last child that is an element!
+            if (e->parentNode() && e->parentNode()->isElementNode()) {
+                DOM::NodeImpl* n = e->nextSibling();
+                while ( n && !n->isElementNode() )
+                    n = n->nextSibling();
+                if ( !n )
+                    return true;
             }
-            case CSSSelector::PseudoLastChild: {
-                // last-child matches the last child that is an element!
-                if (e->parentNode() && e->parentNode()->isElementNode()) {
-                    DOM::NodeImpl* n = e->nextSibling();
+            break;
+        }
+        case CSSSelector::PseudoOnlyChild: {
+            // If both first-child and last-child apply, then only-child applies.
+            if (e->parentNode() && e->parentNode()->isElementNode()) {
+                DOM::NodeImpl* n = e->previousSibling();
+                while ( n && !n->isElementNode() )
+                    n = n->previousSibling();
+                if ( !n ) {
+                    n = e->nextSibling();
                     while ( n && !n->isElementNode() )
-		n = n->nextSibling();
+                        n = n->nextSibling();
                     if ( !n )
                         return true;
-                }
-                break;
+	        }
             }
-            case CSSSelector::PseudoOnlyChild: {
-                // If both first-child and last-child apply, then only-child applies.
-                if (e->parentNode() && e->parentNode()->isElementNode()) {
-                    DOM::NodeImpl* n = e->previousSibling();
-                    while ( n && !n->isElementNode() )
-                        n = n->previousSibling();
-                    if ( !n ) {
-                        n = e->nextSibling();
-                        while ( n && !n->isElementNode() )
-                            n = n->nextSibling();
-                        if ( !n )
-		return true;
-	}
-                }
 	    break;
-            }
+        }
 	case CSSSelector::PseudoFirstLine:
 	    if ( subject ) {
 		dynamicPseudo=RenderStyle::FIRST_LINE;
@@ -1057,7 +1085,7 @@
 		return true;
 	    }
 	    break;
-            case CSSSelector::PseudoTarget:
+        case CSSSelector::PseudoTarget:
 #ifdef APPLE_CHANGES
                 if (!e->getDocument()->getCSSTarget() && // :target matches the root when no CSS target exists
                      e == e->getDocument()->documentElement())
@@ -1078,7 +1106,7 @@
 	    if ( pseudoState == PseudoVisited )
 		return true;
 	    break;
-            case CSSSelector::PseudoHover: {
+        case CSSSelector::PseudoHover: {
 	    // If we're in quirks mode, then hover should never match anchors with no
 	    // href.  This is important for sites like wsj.com.
 	    if (strictParsing || e->id() != ID_A || e->hasAnchor()) {
@@ -1110,23 +1138,23 @@
 		    return true;
 	    }
 	    break;
-            case CSSSelector::PseudoRoot:
-                if (e == e->getDocument()->documentElement())
+        case CSSSelector::PseudoRoot:
+            if (e == e->getDocument()->documentElement())
+                return true;
+            break;
+        case CSSSelector::PseudoNot: {
+            // check the simple selector
+            for (CSSSelector* subSel = sel->simpleSelector; subSel;
+                 subSel = subSel->tagHistory) {
+                // :not cannot nest.  I don't really know why this is a restriction in CSS3,
+                // but it is, so let's honor it.
+                if (subSel->simpleSelector)
+                    break;
+                if (!checkOneSelector(subSel, e))
                     return true;
-                break;
-            case CSSSelector::PseudoNot: {
-                // check the simple selector
-                for (CSSSelector* subSel = sel->simpleSelector; subSel;
-                     subSel = subSel->tagHistory) {
-                    // :not cannot nest.  I don't really know why this is a restriction in CSS3,
-                    // but it is, so let's honor it.
-                    if (subSel->simpleSelector)
-                        break;
-                    if (!checkOneSelector(subSel, e))
-                        return true;
-                }
-                break;
             }
+            break;
+        }
 	case CSSSelector::PseudoSelection:
 	    dynamicPseudo = RenderStyle::SELECTION;
 	    return true;
@@ -1140,7 +1168,7 @@
 	case CSSSelector::PseudoNotParsed:
 	    assert(false);
 	    break;
-            case CSSSelector::PseudoLang:
+        case CSSSelector::PseudoLang:
 	    /* not supported for now */
 	case CSSSelector::PseudoOther:
 	    break;
@@ -1755,6 +1783,10 @@
         ECaptionSide c = RenderStyle::initialCaptionSide();
         switch(primitiveValue->getIdent())
         {
+        case CSS_VAL_LEFT:
+            c = CAPLEFT; break;
+        case CSS_VAL_RIGHT:
+            c = CAPRIGHT; break;
         case CSS_VAL_TOP:
             c = CAPTOP; break;
         case CSS_VAL_BOTTOM:
@@ -1980,9 +2012,55 @@
         return;
     }
     break;
-    case CSS_PROP_PAGE_BREAK_AFTER:
     case CSS_PROP_PAGE_BREAK_BEFORE:
-    case CSS_PROP_PAGE_BREAK_INSIDE:
+    {
+        HANDLE_INHERIT_AND_INITIAL_WITH_VALUE(pageBreakBefore, PageBreakBefore, PageBreak)
+        if (!primitiveValue) return;
+        switch (primitiveValue->getIdent()) {
+            case CSS_VAL_AUTO:
+                style->setPageBreakBefore(PBAUTO);
+                break;
+            case CSS_VAL_LEFT:
+            case CSS_VAL_RIGHT:
+            case CSS_VAL_ALWAYS:
+                style->setPageBreakBefore(PBALWAYS); // CSS2.1: "Conforming user agents may map left/right to always."
+                break;
+            case CSS_VAL_AVOID:
+                style->setPageBreakBefore(PBAVOID);
+                break;
+        }
+        break;
+    }
+
+    case CSS_PROP_PAGE_BREAK_AFTER:
+    {
+        HANDLE_INHERIT_AND_INITIAL_WITH_VALUE(pageBreakAfter, PageBreakAfter, PageBreak)
+        if (!primitiveValue) return;
+        switch (primitiveValue->getIdent()) {
+            case CSS_VAL_AUTO:
+                style->setPageBreakAfter(PBAUTO);
+                break;
+            case CSS_VAL_LEFT:
+            case CSS_VAL_RIGHT:
+            case CSS_VAL_ALWAYS:
+                style->setPageBreakAfter(PBALWAYS); // CSS2.1: "Conforming user agents may map left/right to always."
+                break;
+            case CSS_VAL_AVOID:
+                style->setPageBreakAfter(PBAVOID);
+                break;
+        }
+        break;
+    }
+
+    case CSS_PROP_PAGE_BREAK_INSIDE: {
+        HANDLE_INHERIT_AND_INITIAL_WITH_VALUE(pageBreakInside, PageBreakInside, PageBreak)
+        if (!primitiveValue) return;
+        if (primitiveValue->getIdent() == CSS_VAL_AUTO)
+            style->setPageBreakInside(PBAUTO);
+        else if (primitiveValue->getIdent() == CSS_VAL_AVOID)
+            style->setPageBreakInside(PBAVOID);
+        return;
+    }
 //    case CSS_PROP_PAUSE_AFTER:
 //    case CSS_PROP_PAUSE_BEFORE:
         break;
@@ -2150,9 +2228,12 @@
         style->setBackgroundYPosition(l);
         break;
     }
-    case CSS_PROP_BORDER_SPACING:
-        assert( false );
-
+    case CSS_PROP_BORDER_SPACING: {
+        if(value->cssValueType() != CSSValue::CSS_INHERIT || !parentNode) return;
+        style->setBorderHorizontalSpacing(parentStyle->borderHorizontalSpacing());
+        style->setBorderVerticalSpacing(parentStyle->borderVerticalSpacing());
+        break;
+    }
     case CSS_PROP__KHTML_BORDER_HORIZONTAL_SPACING: {
         HANDLE_INHERIT_AND_INITIAL(borderHorizontalSpacing, BorderHorizontalSpacing)
         if (!primitiveValue) break;
@@ -2665,7 +2746,7 @@
             case CSS_VAL_LARGE:    size = int( fontSizes[4] ); break;
             case CSS_VAL_X_LARGE:  size = int( fontSizes[5] ); break;
             case CSS_VAL_XX_LARGE: size = int( fontSizes[6] ); break;
-            case CSS_VAL__KHTML_XXX_LARGE:  size = ( fontSizes[6]*5 )/3; break;
+            case CSS_VAL__KHTML_XXX_LARGE: size = int( fontSizes[7] ); break;
             case CSS_VAL_LARGER:
                 // ### use the next bigger standardSize!!!
                 size = ( oldSize * 5 ) / 4;
@@ -2680,7 +2761,8 @@
         } else {
             int type = primitiveValue->primitiveType();
             if(type > CSSPrimitiveValue::CSS_PERCENTAGE && type < CSSPrimitiveValue::CSS_DEG) {
-                if (!khtml::printpainter && element && element->getDocument()->view())
+                if ( !khtml::printpainter && type != CSSPrimitiveValue::CSS_EMS && type != CSSPrimitiveValue::CSS_EXS &&
+                     element && element->getDocument()->view())
                     size = int( primitiveValue->computeLengthFloat(parentStyle, paintDeviceMetrics) *
                                 element->getDocument()->view()->part()->zoomFactor() ) / 100;
 		else
@@ -2728,7 +2810,6 @@
         return;
     }
 
-    /*
     case CSS_PROP_WIDOWS:
     {
         HANDLE_INHERIT_AND_INITIAL(widows, Widows)
@@ -2746,7 +2827,6 @@
         style->setOrphans((int)primitiveValue->floatValue(CSSPrimitiveValue::CSS_NUMBER));
         break;
     }
-    */
 
 // length, percent, number
     case CSS_PROP_LINE_HEIGHT:
@@ -3197,6 +3277,15 @@
         else if (isInitial)
             style->resetOutline();
         break;
+    case CSS_PROP_BOX_SIZING:
+        HANDLE_INHERIT(boxSizing, BoxSizing)
+        if (!primitiveValue) return;
+        if (primitiveValue->getIdent() == CSS_VAL_CONTENT_BOX)
+            style->setBoxSizing(CONTENT_BOX);
+        else
+        if (primitiveValue->getIdent() == CSS_VAL_BORDER_BOX)
+            style->setBoxSizing(BORDER_BOX);
+        break;
     case CSS_PROP__KHTML_MARQUEE:
         if (value->cssValueType() != CSSValue::CSS_INHERIT || !parentNode) return;
         style->setMarqueeDirection(parentStyle->marqueeDirection());
diff -urN -x CVS kdelibs.orig/khtml/css/cssvalues.c kdelibs/khtml/css/cssvalues.c
--- kdelibs.orig/khtml/css/cssvalues.c	Sun Jun 13 19:08:23 2004
+++ kdelibs/khtml/css/cssvalues.c	Wed Nov 10 10:00:17 2004
@@ -40,7 +40,7 @@
 };
 
 static const css_value* findValue (register const char *str, register unsigned int len);
-/* maximum key range = 1475, duplicates = 0 */
+/* maximum key range = 1434, duplicates = 0 */
 
 #ifdef __GNUC__
 __inline
@@ -54,32 +54,32 @@
 {
   static const unsigned short asso_values[] =
     {
-      1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475,
-      1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475,
-      1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475,
-      1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475,
-      1475, 1475, 1475, 1475, 1475,  210,    0, 1475,    0,    0,
-        75,   55,   40,   35,   30,   15,   10,    5, 1475, 1475,
-      1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475,
-      1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475,
-      1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475,
-      1475, 1475, 1475, 1475, 1475, 1475, 1475,   70,   10,  205,
-         0,    0,   79,    4,   19,    5,   38,  115,   50,   40,
-        15,   15,   95,  124,  175,  110,    0,   35,  224,    9,
-         4,  164,   50, 1475, 1475, 1475, 1475, 1475, 1475, 1475,
-      1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475,
-      1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475,
-      1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475,
-      1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475,
-      1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475,
-      1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475,
-      1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475,
-      1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475,
-      1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475,
-      1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475,
-      1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475,
-      1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475, 1475,
-      1475, 1475, 1475, 1475, 1475, 1475, 1475
+      1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434,
+      1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434,
+      1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434,
+      1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434,
+      1434, 1434, 1434, 1434, 1434,  210,   55, 1434,    0,    0,
+        75,   55,   40,   35,   30,   15,   10,    5, 1434, 1434,
+      1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434,
+      1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434,
+      1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434,
+      1434, 1434, 1434, 1434, 1434, 1434, 1434,   70,   10,  205,
+         0,    0,   38,    4,   19,    5,  114,  115,   50,   40,
+        15,   15,   95,  254,  175,  110,    0,   35,    8,    9,
+         4,  129,   10, 1434, 1434, 1434, 1434, 1434, 1434, 1434,
+      1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434,
+      1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434,
+      1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434,
+      1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434,
+      1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434,
+      1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434,
+      1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434,
+      1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434,
+      1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434,
+      1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434,
+      1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434,
+      1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434, 1434,
+      1434, 1434, 1434, 1434, 1434, 1434, 1434
     };
   register int hval = 0;
 
@@ -163,11 +163,11 @@
 {
   enum
     {
-      TOTAL_KEYWORDS = 245,
+      TOTAL_KEYWORDS = 249,
       MIN_WORD_LENGTH = 2,
       MAX_WORD_LENGTH = 22,
       MIN_HASH_VALUE = 0,
-      MAX_HASH_VALUE = 1474
+      MAX_HASH_VALUE = 1433
     };
 
   static const struct css_value wordlist_value[] =
@@ -182,13 +182,13 @@
       {"700", CSS_VAL_700},
 #line 18 "cssvalues.gperf"
       {"inset", CSS_VAL_INSET},
-#line 217 "cssvalues.gperf"
+#line 219 "cssvalues.gperf"
       {"hide", CSS_VAL_HIDE},
-#line 142 "cssvalues.gperf"
+#line 144 "cssvalues.gperf"
       {"inside", CSS_VAL_INSIDE},
 #line 44 "cssvalues.gperf"
       {"600", CSS_VAL_600},
-#line 252 "cssvalues.gperf"
+#line 256 "cssvalues.gperf"
       {"down", CSS_VAL_DOWN},
 #line 43 "cssvalues.gperf"
       {"500", CSS_VAL_500},
@@ -202,7 +202,7 @@
       {"indigo", CSS_VAL_INDIGO},
 #line 16 "cssvalues.gperf"
       {"none", CSS_VAL_NONE},
-#line 255 "cssvalues.gperf"
+#line 259 "cssvalues.gperf"
       {"infinite", CSS_VAL_INFINITE},
 #line 22 "cssvalues.gperf"
       {"dotted", CSS_VAL_DOTTED},
@@ -216,25 +216,29 @@
       {"windowtext", CSS_VAL_WINDOWTEXT},
 #line 90 "cssvalues.gperf"
       {"teal", CSS_VAL_TEAL},
-#line 184 "cssvalues.gperf"
+#line 186 "cssvalues.gperf"
       {"move", CSS_VAL_MOVE},
 #line 36 "cssvalues.gperf"
       {"bold", CSS_VAL_BOLD},
-#line 91 "cssvalues.gperf"
-      {"white", CSS_VAL_WHITE},
+#line 76 "cssvalues.gperf"
+      {"blue", CSS_VAL_BLUE},
 #line 82 "cssvalues.gperf"
       {"lime", CSS_VAL_LIME},
-#line 240 "cssvalues.gperf"
-      {"thin", CSS_VAL_THIN},
-#line 207 "cssvalues.gperf"
+#line 225 "cssvalues.gperf"
+      {"loud", CSS_VAL_LOUD},
+#line 209 "cssvalues.gperf"
       {"below", CSS_VAL_BELOW},
 #line 40 "cssvalues.gperf"
       {"200", CSS_VAL_200},
-#line 210 "cssvalues.gperf"
+#line 203 "cssvalues.gperf"
+      {"visible", CSS_VAL_VISIBLE},
+#line 212 "cssvalues.gperf"
       {"both", CSS_VAL_BOTH},
-#line 163 "cssvalues.gperf"
+#line 165 "cssvalues.gperf"
       {"inline", CSS_VAL_INLINE},
-#line 245 "cssvalues.gperf"
+#line 25 "cssvalues.gperf"
+      {"double", CSS_VAL_DOUBLE},
+#line 249 "cssvalues.gperf"
       {"enabled", CSS_VAL_ENABLED},
 #line 23 "cssvalues.gperf"
       {"dashed", CSS_VAL_DASHED},
@@ -244,423 +248,427 @@
       {"menutext", CSS_VAL_MENUTEXT},
 #line 127 "cssvalues.gperf"
       {"middle", CSS_VAL_MIDDLE},
-#line 216 "cssvalues.gperf"
+#line 218 "cssvalues.gperf"
       {"hand", CSS_VAL_HAND},
-#line 221 "cssvalues.gperf"
+#line 258 "cssvalues.gperf"
+      {"fast", CSS_VAL_FAST},
+#line 223 "cssvalues.gperf"
       {"level", CSS_VAL_LEVEL},
 #line 100 "cssvalues.gperf"
       {"buttontext", CSS_VAL_BUTTONTEXT},
 #line 133 "cssvalues.gperf"
       {"bottom", CSS_VAL_BOTTOM},
-#line 194 "cssvalues.gperf"
-      {"wait", CSS_VAL_WAIT},
 #line 51 "cssvalues.gperf"
       {"medium", CSS_VAL_MEDIUM},
-#line 251 "cssvalues.gperf"
+#line 195 "cssvalues.gperf"
+      {"text", CSS_VAL_TEXT},
+#line 255 "cssvalues.gperf"
       {"up", CSS_VAL_UP},
-#line 246 "cssvalues.gperf"
+#line 250 "cssvalues.gperf"
       {"disabled", CSS_VAL_DISABLED},
-#line 132 "cssvalues.gperf"
-      {"top", CSS_VAL_TOP},
 #line 103 "cssvalues.gperf"
       {"highlight", CSS_VAL_HIGHLIGHT},
+#line 91 "cssvalues.gperf"
+      {"white", CSS_VAL_WHITE},
 #line 104 "cssvalues.gperf"
       {"highlighttext", CSS_VAL_HIGHLIGHTTEXT},
-#line 254 "cssvalues.gperf"
-      {"fast", CSS_VAL_FAST},
+#line 242 "cssvalues.gperf"
+      {"thin", CSS_VAL_THIN},
 #line 126 "cssvalues.gperf"
       {"baseline", CSS_VAL_BASELINE},
-#line 195 "cssvalues.gperf"
+#line 197 "cssvalues.gperf"
       {"help", CSS_VAL_HELP},
-#line 179 "cssvalues.gperf"
-      {"auto", CSS_VAL_AUTO},
 #line 181 "cssvalues.gperf"
+      {"auto", CSS_VAL_AUTO},
+#line 183 "cssvalues.gperf"
       {"default", CSS_VAL_DEFAULT},
-#line 196 "cssvalues.gperf"
+#line 198 "cssvalues.gperf"
       {"ltr", CSS_VAL_LTR},
-#line 193 "cssvalues.gperf"
-      {"text", CSS_VAL_TEXT},
-#line 146 "cssvalues.gperf"
+#line 148 "cssvalues.gperf"
       {"decimal", CSS_VAL_DECIMAL},
 #line 24 "cssvalues.gperf"
       {"solid", CSS_VAL_SOLID},
+#line 217 "cssvalues.gperf"
+      {"fixed", CSS_VAL_FIXED},
+#line 228 "cssvalues.gperf"
+      {"mix", CSS_VAL_MIX},
 #line 88 "cssvalues.gperf"
       {"red", CSS_VAL_RED},
-#line 204 "cssvalues.gperf"
+#line 208 "cssvalues.gperf"
+      {"avoid", CSS_VAL_AVOID},
+#line 206 "cssvalues.gperf"
       {"absolute", CSS_VAL_ABSOLUTE},
-#line 15 "cssvalues.gperf"
-      {"initial", CSS_VAL_INITIAL},
+#line 205 "cssvalues.gperf"
+      {"above", CSS_VAL_ABOVE},
 #line 20 "cssvalues.gperf"
       {"ridge", CSS_VAL_RIDGE},
+#line 85 "cssvalues.gperf"
+      {"olive", CSS_VAL_OLIVE},
 #line 58 "cssvalues.gperf"
       {"wider", CSS_VAL_WIDER},
+#line 196 "cssvalues.gperf"
+      {"wait", CSS_VAL_WAIT},
 #line 21 "cssvalues.gperf"
       {"outset", CSS_VAL_OUTSET},
-#line 256 "cssvalues.gperf"
-      {"slide", CSS_VAL_SLIDE},
-#line 141 "cssvalues.gperf"
+#line 253 "cssvalues.gperf"
+      {"ahead", CSS_VAL_AHEAD},
+#line 143 "cssvalues.gperf"
       {"outside", CSS_VAL_OUTSIDE},
-#line 219 "cssvalues.gperf"
+#line 221 "cssvalues.gperf"
       {"invert", CSS_VAL_INVERT},
 #line 14 "cssvalues.gperf"
       {"inherit", CSS_VAL_INHERIT},
-#line 226 "cssvalues.gperf"
-      {"mix", CSS_VAL_MIX},
-#line 143 "cssvalues.gperf"
+#line 145 "cssvalues.gperf"
       {"disc", CSS_VAL_DISC},
-#line 65 "cssvalues.gperf"
-      {"expanded", CSS_VAL_EXPANDED},
-#line 197 "cssvalues.gperf"
+#line 199 "cssvalues.gperf"
       {"rtl", CSS_VAL_RTL},
 #line 137 "cssvalues.gperf"
       {"right", CSS_VAL_RIGHT},
 #line 86 "cssvalues.gperf"
       {"orange", CSS_VAL_ORANGE},
-#line 209 "cssvalues.gperf"
-      {"blink", CSS_VAL_BLINK},
-#line 33 "cssvalues.gperf"
-      {"oblique", CSS_VAL_OBLIQUE},
-#line 237 "cssvalues.gperf"
+#line 84 "cssvalues.gperf"
+      {"navy", CSS_VAL_NAVY},
+#line 80 "cssvalues.gperf"
+      {"green", CSS_VAL_GREEN},
+#line 239 "cssvalues.gperf"
       {"show", CSS_VAL_SHOW},
 #line 52 "cssvalues.gperf"
       {"large", CSS_VAL_LARGE},
 #line 98 "cssvalues.gperf"
       {"buttonhighlight", CSS_VAL_BUTTONHIGHLIGHT},
-#line 218 "cssvalues.gperf"
+#line 220 "cssvalues.gperf"
       {"higher", CSS_VAL_HIGHER},
-#line 249 "cssvalues.gperf"
-      {"ahead", CSS_VAL_AHEAD},
 #line 37 "cssvalues.gperf"
       {"bolder", CSS_VAL_BOLDER},
-#line 224 "cssvalues.gperf"
+#line 92 "cssvalues.gperf"
+      {"yellow", CSS_VAL_YELLOW},
+#line 226 "cssvalues.gperf"
       {"lower", CSS_VAL_LOWER},
-#line 214 "cssvalues.gperf"
+#line 216 "cssvalues.gperf"
       {"embed", CSS_VAL_EMBED},
-#line 215 "cssvalues.gperf"
-      {"fixed", CSS_VAL_FIXED},
 #line 114 "cssvalues.gperf"
       {"threedhighlight", CSS_VAL_THREEDHIGHLIGHT},
-#line 84 "cssvalues.gperf"
-      {"navy", CSS_VAL_NAVY},
+#line 15 "cssvalues.gperf"
+      {"initial", CSS_VAL_INITIAL},
 #line 50 "cssvalues.gperf"
       {"small", CSS_VAL_SMALL},
-#line 253 "cssvalues.gperf"
+#line 68 "cssvalues.gperf"
+      {"serif", CSS_VAL_SERIF},
+#line 257 "cssvalues.gperf"
       {"slow", CSS_VAL_SLOW},
 #line 83 "cssvalues.gperf"
       {"maroon", CSS_VAL_MAROON},
 #line 38 "cssvalues.gperf"
       {"lighter", CSS_VAL_LIGHTER},
-#line 80 "cssvalues.gperf"
-      {"green", CSS_VAL_GREEN},
+#line 132 "cssvalues.gperf"
+      {"top", CSS_VAL_TOP},
+#line 260 "cssvalues.gperf"
+      {"slide", CSS_VAL_SLIDE},
 #line 32 "cssvalues.gperf"
       {"italic", CSS_VAL_ITALIC},
-#line 92 "cssvalues.gperf"
-      {"yellow", CSS_VAL_YELLOW},
-#line 76 "cssvalues.gperf"
-      {"blue", CSS_VAL_BLUE},
-#line 223 "cssvalues.gperf"
-      {"loud", CSS_VAL_LOUD},
-#line 201 "cssvalues.gperf"
-      {"visible", CSS_VAL_VISIBLE},
-#line 241 "cssvalues.gperf"
+#line 78 "cssvalues.gperf"
+      {"fuchsia", CSS_VAL_FUCHSIA},
+#line 243 "cssvalues.gperf"
       {"underline", CSS_VAL_UNDERLINE},
-#line 25 "cssvalues.gperf"
-      {"double", CSS_VAL_DOUBLE},
+#line 19 "cssvalues.gperf"
+      {"groove", CSS_VAL_GROOVE},
+#line 236 "cssvalues.gperf"
+      {"relative", CSS_VAL_RELATIVE},
 #line 35 "cssvalues.gperf"
       {"normal", CSS_VAL_NORMAL},
-#line 68 "cssvalues.gperf"
-      {"serif", CSS_VAL_SERIF},
-#line 54 "cssvalues.gperf"
-      {"xx-large", CSS_VAL_XX_LARGE},
-#line 165 "cssvalues.gperf"
+#line 211 "cssvalues.gperf"
+      {"blink", CSS_VAL_BLINK},
+#line 233 "cssvalues.gperf"
+      {"overline", CSS_VAL_OVERLINE},
+#line 235 "cssvalues.gperf"
+      {"pre", CSS_VAL_PRE},
+#line 167 "cssvalues.gperf"
       {"list-item", CSS_VAL_LIST_ITEM},
-#line 258 "cssvalues.gperf"
+#line 262 "cssvalues.gperf"
       {"unfurl", CSS_VAL_UNFURL},
-#line 78 "cssvalues.gperf"
-      {"fuchsia", CSS_VAL_FUCHSIA},
+#line 79 "cssvalues.gperf"
+      {"gray", CSS_VAL_GRAY},
 #line 27 "cssvalues.gperf"
       {"icon", CSS_VAL_ICON},
 #line 139 "cssvalues.gperf"
       {"justify", CSS_VAL_JUSTIFY},
-#line 169 "cssvalues.gperf"
+#line 102 "cssvalues.gperf"
+      {"graytext", CSS_VAL_GRAYTEXT},
+#line 171 "cssvalues.gperf"
       {"table", CSS_VAL_TABLE},
-#line 85 "cssvalues.gperf"
-      {"olive", CSS_VAL_OLIVE},
-#line 48 "cssvalues.gperf"
-      {"xx-small", CSS_VAL_XX_SMALL},
-#line 238 "cssvalues.gperf"
+#line 240 "cssvalues.gperf"
       {"static", CSS_VAL_STATIC},
 #line 99 "cssvalues.gperf"
       {"buttonshadow", CSS_VAL_BUTTONSHADOW},
-#line 182 "cssvalues.gperf"
-      {"pointer", CSS_VAL_POINTER},
-#line 233 "cssvalues.gperf"
-      {"pre", CSS_VAL_PRE},
+#line 89 "cssvalues.gperf"
+      {"silver", CSS_VAL_SILVER},
+#line 65 "cssvalues.gperf"
+      {"expanded", CSS_VAL_EXPANDED},
+#line 120 "cssvalues.gperf"
+      {"grey", CSS_VAL_GREY},
 #line 128 "cssvalues.gperf"
       {"sub", CSS_VAL_SUB},
 #line 116 "cssvalues.gperf"
       {"threedshadow", CSS_VAL_THREEDSHADOW},
-#line 79 "cssvalues.gperf"
-      {"gray", CSS_VAL_GRAY},
-#line 186 "cssvalues.gperf"
-      {"ne-resize", CSS_VAL_NE_RESIZE},
-#line 102 "cssvalues.gperf"
-      {"graytext", CSS_VAL_GRAYTEXT},
+#line 33 "cssvalues.gperf"
+      {"oblique", CSS_VAL_OBLIQUE},
 #line 62 "cssvalues.gperf"
       {"condensed", CSS_VAL_CONDENSED},
-#line 159 "cssvalues.gperf"
+#line 54 "cssvalues.gperf"
+      {"xx-large", CSS_VAL_XX_LARGE},
+#line 161 "cssvalues.gperf"
       {"hiragana", CSS_VAL_HIRAGANA},
-#line 187 "cssvalues.gperf"
-      {"nw-resize", CSS_VAL_NW_RESIZE},
-#line 156 "cssvalues.gperf"
+#line 158 "cssvalues.gperf"
       {"armenian", CSS_VAL_ARMENIAN},
-#line 157 "cssvalues.gperf"
+#line 159 "cssvalues.gperf"
       {"georgian", CSS_VAL_GEORGIAN},
-#line 122 "cssvalues.gperf"
-      {"repeat", CSS_VAL_REPEAT},
-#line 125 "cssvalues.gperf"
-      {"no-repeat", CSS_VAL_NO_REPEAT},
-#line 229 "cssvalues.gperf"
+#line 188 "cssvalues.gperf"
+      {"ne-resize", CSS_VAL_NE_RESIZE},
+#line 231 "cssvalues.gperf"
       {"nowrap", CSS_VAL_NOWRAP},
-#line 239 "cssvalues.gperf"
-      {"thick", CSS_VAL_THICK},
-#line 225 "cssvalues.gperf"
-      {"marquee", CSS_VAL_MARQUEE},
+#line 118 "cssvalues.gperf"
+      {"windowframe", CSS_VAL_WINDOWFRAME},
+#line 189 "cssvalues.gperf"
+      {"nw-resize", CSS_VAL_NW_RESIZE},
+#line 48 "cssvalues.gperf"
+      {"xx-small", CSS_VAL_XX_SMALL},
 #line 87 "cssvalues.gperf"
       {"purple", CSS_VAL_PURPLE},
 #line 75 "cssvalues.gperf"
       {"black", CSS_VAL_BLACK},
-#line 206 "cssvalues.gperf"
-      {"avoid", CSS_VAL_AVOID},
 #line 138 "cssvalues.gperf"
       {"center", CSS_VAL_CENTER},
-#line 203 "cssvalues.gperf"
-      {"above", CSS_VAL_ABOVE},
-#line 155 "cssvalues.gperf"
+#line 74 "cssvalues.gperf"
+      {"aqua", CSS_VAL_AQUA},
+#line 157 "cssvalues.gperf"
       {"hebrew", CSS_VAL_HEBREW},
 #line 57 "cssvalues.gperf"
       {"larger", CSS_VAL_LARGER},
-#line 257 "cssvalues.gperf"
+#line 184 "cssvalues.gperf"
+      {"pointer", CSS_VAL_POINTER},
+#line 261 "cssvalues.gperf"
       {"alternate", CSS_VAL_ALTERNATE},
-#line 118 "cssvalues.gperf"
-      {"windowframe", CSS_VAL_WINDOWFRAME},
-#line 170 "cssvalues.gperf"
+#line 131 "cssvalues.gperf"
+      {"text-bottom", CSS_VAL_TEXT_BOTTOM},
+#line 172 "cssvalues.gperf"
       {"inline-table", CSS_VAL_INLINE_TABLE},
-#line 120 "cssvalues.gperf"
-      {"grey", CSS_VAL_GREY},
+#line 97 "cssvalues.gperf"
+      {"buttonface", CSS_VAL_BUTTONFACE},
 #line 49 "cssvalues.gperf"
       {"x-small", CSS_VAL_X_SMALL},
+#line 125 "cssvalues.gperf"
+      {"no-repeat", CSS_VAL_NO_REPEAT},
 #line 115 "cssvalues.gperf"
       {"threedlightshadow", CSS_VAL_THREEDLIGHTSHADOW},
-#line 26 "cssvalues.gperf"
-      {"caption", CSS_VAL_CAPTION},
+#line 71 "cssvalues.gperf"
+      {"fantasy", CSS_VAL_FANTASY},
+#line 207 "cssvalues.gperf"
+      {"always", CSS_VAL_ALWAYS},
 #line 56 "cssvalues.gperf"
       {"smaller", CSS_VAL_SMALLER},
-#line 101 "cssvalues.gperf"
-      {"captiontext", CSS_VAL_CAPTIONTEXT},
 #line 96 "cssvalues.gperf"
       {"background", CSS_VAL_BACKGROUND},
-#line 129 "cssvalues.gperf"
-      {"super", CSS_VAL_SUPER},
-#line 189 "cssvalues.gperf"
-      {"se-resize", CSS_VAL_SE_RESIZE},
-#line 131 "cssvalues.gperf"
-      {"text-bottom", CSS_VAL_TEXT_BOTTOM},
-#line 166 "cssvalues.gperf"
+#line 113 "cssvalues.gperf"
+      {"threedface", CSS_VAL_THREEDFACE},
+#line 187 "cssvalues.gperf"
+      {"e-resize", CSS_VAL_E_RESIZE},
+#line 130 "cssvalues.gperf"
+      {"text-top", CSS_VAL_TEXT_TOP},
+#line 241 "cssvalues.gperf"
+      {"thick", CSS_VAL_THICK},
+#line 194 "cssvalues.gperf"
+      {"w-resize", CSS_VAL_W_RESIZE},
+#line 168 "cssvalues.gperf"
       {"run-in", CSS_VAL_RUN_IN},
 #line 190 "cssvalues.gperf"
-      {"sw-resize", CSS_VAL_SW_RESIZE},
+      {"n-resize", CSS_VAL_N_RESIZE},
 #line 29 "cssvalues.gperf"
       {"message-box", CSS_VAL_MESSAGE_BOX},
-#line 97 "cssvalues.gperf"
-      {"buttonface", CSS_VAL_BUTTONFACE},
-#line 205 "cssvalues.gperf"
-      {"always", CSS_VAL_ALWAYS},
-#line 250 "cssvalues.gperf"
+#line 191 "cssvalues.gperf"
+      {"se-resize", CSS_VAL_SE_RESIZE},
+#line 254 "cssvalues.gperf"
       {"reverse", CSS_VAL_REVERSE},
-#line 232 "cssvalues.gperf"
+#line 234 "cssvalues.gperf"
       {"portrait", CSS_VAL_PORTRAIT},
-#line 164 "cssvalues.gperf"
-      {"block", CSS_VAL_BLOCK},
-#line 113 "cssvalues.gperf"
-      {"threedface", CSS_VAL_THREEDFACE},
-#line 130 "cssvalues.gperf"
-      {"text-top", CSS_VAL_TEXT_TOP},
-#line 185 "cssvalues.gperf"
-      {"e-resize", CSS_VAL_E_RESIZE},
-#line 74 "cssvalues.gperf"
-      {"aqua", CSS_VAL_AQUA},
+#line 70 "cssvalues.gperf"
+      {"cursive", CSS_VAL_CURSIVE},
 #line 192 "cssvalues.gperf"
-      {"w-resize", CSS_VAL_W_RESIZE},
-#line 188 "cssvalues.gperf"
-      {"n-resize", CSS_VAL_N_RESIZE},
+      {"sw-resize", CSS_VAL_SW_RESIZE},
+#line 166 "cssvalues.gperf"
+      {"block", CSS_VAL_BLOCK},
+#line 248 "cssvalues.gperf"
+      {"content-box", CSS_VAL_CONTENT_BOX},
+#line 122 "cssvalues.gperf"
+      {"repeat", CSS_VAL_REPEAT},
 #line 53 "cssvalues.gperf"
       {"x-large", CSS_VAL_X_LARGE},
-#line 71 "cssvalues.gperf"
-      {"fantasy", CSS_VAL_FANTASY},
-#line 19 "cssvalues.gperf"
-      {"groove", CSS_VAL_GROOVE},
-#line 234 "cssvalues.gperf"
-      {"relative", CSS_VAL_RELATIVE},
+#line 227 "cssvalues.gperf"
+      {"marquee", CSS_VAL_MARQUEE},
 #line 64 "cssvalues.gperf"
       {"semi-expanded", CSS_VAL_SEMI_EXPANDED},
-#line 228 "cssvalues.gperf"
-      {"no-open-quote", CSS_VAL_NO_OPEN_QUOTE},
-#line 235 "cssvalues.gperf"
+#line 251 "cssvalues.gperf"
+      {"forwards", CSS_VAL_FORWARDS},
+#line 237 "cssvalues.gperf"
       {"scroll", CSS_VAL_SCROLL},
-#line 222 "cssvalues.gperf"
+#line 224 "cssvalues.gperf"
       {"line-through", CSS_VAL_LINE_THROUGH},
-#line 236 "cssvalues.gperf"
-      {"separate", CSS_VAL_SEPARATE},
-#line 89 "cssvalues.gperf"
-      {"silver", CSS_VAL_SILVER},
-#line 248 "cssvalues.gperf"
+#line 247 "cssvalues.gperf"
+      {"border-box", CSS_VAL_BORDER_BOX},
+#line 193 "cssvalues.gperf"
+      {"s-resize", CSS_VAL_S_RESIZE},
+#line 252 "cssvalues.gperf"
       {"backwards", CSS_VAL_BACKWARDS},
-#line 160 "cssvalues.gperf"
+#line 162 "cssvalues.gperf"
       {"katakana", CSS_VAL_KATAKANA},
-#line 231 "cssvalues.gperf"
-      {"overline", CSS_VAL_OVERLINE},
+#line 26 "cssvalues.gperf"
+      {"caption", CSS_VAL_CAPTION},
 #line 72 "cssvalues.gperf"
       {"monospace", CSS_VAL_MONOSPACE},
-#line 247 "cssvalues.gperf"
-      {"forwards", CSS_VAL_FORWARDS},
+#line 101 "cssvalues.gperf"
+      {"captiontext", CSS_VAL_CAPTIONTEXT},
 #line 59 "cssvalues.gperf"
       {"narrower", CSS_VAL_NARROWER},
-#line 212 "cssvalues.gperf"
+#line 214 "cssvalues.gperf"
       {"crop", CSS_VAL_CROP},
-#line 144 "cssvalues.gperf"
+#line 129 "cssvalues.gperf"
+      {"super", CSS_VAL_SUPER},
+#line 146 "cssvalues.gperf"
       {"circle", CSS_VAL_CIRCLE},
-#line 198 "cssvalues.gperf"
-      {"capitalize", CSS_VAL_CAPITALIZE},
-#line 123 "cssvalues.gperf"
-      {"repeat-x", CSS_VAL_REPEAT_X},
-#line 202 "cssvalues.gperf"
+#line 204 "cssvalues.gperf"
       {"collapse", CSS_VAL_COLLAPSE},
-#line 230 "cssvalues.gperf"
-      {"open-quote", CSS_VAL_OPEN_QUOTE},
-#line 152 "cssvalues.gperf"
+#line 154 "cssvalues.gperf"
       {"lower-latin", CSS_VAL_LOWER_LATIN},
-#line 191 "cssvalues.gperf"
-      {"s-resize", CSS_VAL_S_RESIZE},
-#line 77 "cssvalues.gperf"
-      {"crimson", CSS_VAL_CRIMSON},
-#line 167 "cssvalues.gperf"
+#line 169 "cssvalues.gperf"
       {"compact", CSS_VAL_COMPACT},
-#line 220 "cssvalues.gperf"
+#line 210 "cssvalues.gperf"
+      {"bidi-override", CSS_VAL_BIDI_OVERRIDE},
+#line 222 "cssvalues.gperf"
       {"landscape", CSS_VAL_LANDSCAPE},
-#line 200 "cssvalues.gperf"
+#line 147 "cssvalues.gperf"
+      {"square", CSS_VAL_SQUARE},
+#line 105 "cssvalues.gperf"
+      {"inactiveborder", CSS_VAL_INACTIVEBORDER},
+#line 202 "cssvalues.gperf"
       {"lowercase", CSS_VAL_LOWERCASE},
 #line 121 "cssvalues.gperf"
       {"-khtml-text", CSS_VAL__KHTML_TEXT},
+#line 106 "cssvalues.gperf"
+      {"inactivecaption", CSS_VAL_INACTIVECAPTION},
+#line 107 "cssvalues.gperf"
+      {"inactivecaptiontext", CSS_VAL_INACTIVECAPTIONTEXT},
 #line 73 "cssvalues.gperf"
       {"transparent", CSS_VAL_TRANSPARENT},
+#line 200 "cssvalues.gperf"
+      {"capitalize", CSS_VAL_CAPITALIZE},
+#line 77 "cssvalues.gperf"
+      {"crimson", CSS_VAL_CRIMSON},
+#line 232 "cssvalues.gperf"
+      {"open-quote", CSS_VAL_OPEN_QUOTE},
 #line 66 "cssvalues.gperf"
       {"extra-expanded", CSS_VAL_EXTRA_EXPANDED},
+#line 238 "cssvalues.gperf"
+      {"separate", CSS_VAL_SEPARATE},
 #line 108 "cssvalues.gperf"
       {"infobackground", CSS_VAL_INFOBACKGROUND},
-#line 168 "cssvalues.gperf"
+#line 170 "cssvalues.gperf"
       {"inline-block", CSS_VAL_INLINE_BLOCK},
-#line 70 "cssvalues.gperf"
-      {"cursive", CSS_VAL_CURSIVE},
-#line 213 "cssvalues.gperf"
+#line 215 "cssvalues.gperf"
       {"cross", CSS_VAL_CROSS},
+#line 93 "cssvalues.gperf"
+      {"activeborder", CSS_VAL_ACTIVEBORDER},
 #line 63 "cssvalues.gperf"
       {"semi-condensed", CSS_VAL_SEMI_CONDENSED},
-#line 145 "cssvalues.gperf"
-      {"square", CSS_VAL_SQUARE},
 #line 112 "cssvalues.gperf"
       {"threeddarkshadow", CSS_VAL_THREEDDARKSHADOW},
+#line 123 "cssvalues.gperf"
+      {"repeat-x", CSS_VAL_REPEAT_X},
+#line 140 "cssvalues.gperf"
+      {"-khtml-left", CSS_VAL__KHTML_LEFT},
+#line 230 "cssvalues.gperf"
+      {"no-open-quote", CSS_VAL_NO_OPEN_QUOTE},
+#line 94 "cssvalues.gperf"
+      {"activecaption", CSS_VAL_ACTIVECAPTION},
 #line 31 "cssvalues.gperf"
       {"status-bar", CSS_VAL_STATUS_BAR},
-#line 174 "cssvalues.gperf"
+#line 176 "cssvalues.gperf"
       {"table-row", CSS_VAL_TABLE_ROW},
-#line 124 "cssvalues.gperf"
-      {"repeat-y", CSS_VAL_REPEAT_Y},
-#line 150 "cssvalues.gperf"
+#line 152 "cssvalues.gperf"
       {"lower-greek", CSS_VAL_LOWER_GREEK},
 #line 135 "cssvalues.gperf"
       {"-khtml-auto", CSS_VAL__KHTML_AUTO},
-#line 151 "cssvalues.gperf"
+#line 153 "cssvalues.gperf"
       {"lower-alpha", CSS_VAL_LOWER_ALPHA},
 #line 67 "cssvalues.gperf"
       {"ultra-expanded", CSS_VAL_ULTRA_EXPANDED},
-#line 183 "cssvalues.gperf"
+#line 185 "cssvalues.gperf"
       {"progress", CSS_VAL_PROGRESS},
-#line 148 "cssvalues.gperf"
+#line 150 "cssvalues.gperf"
       {"lower-roman", CSS_VAL_LOWER_ROMAN},
-#line 154 "cssvalues.gperf"
-      {"upper-latin", CSS_VAL_UPPER_LATIN},
-#line 227 "cssvalues.gperf"
-      {"no-close-quote", CSS_VAL_NO_CLOSE_QUOTE},
 #line 111 "cssvalues.gperf"
       {"scrollbar", CSS_VAL_SCROLLBAR},
-#line 199 "cssvalues.gperf"
-      {"uppercase", CSS_VAL_UPPERCASE},
-#line 208 "cssvalues.gperf"
-      {"bidi-override", CSS_VAL_BIDI_OVERRIDE},
-#line 105 "cssvalues.gperf"
-      {"inactiveborder", CSS_VAL_INACTIVEBORDER},
-#line 177 "cssvalues.gperf"
+#line 141 "cssvalues.gperf"
+      {"-khtml-right", CSS_VAL__KHTML_RIGHT},
+#line 124 "cssvalues.gperf"
+      {"repeat-y", CSS_VAL_REPEAT_Y},
+#line 179 "cssvalues.gperf"
       {"table-cell", CSS_VAL_TABLE_CELL},
-#line 211 "cssvalues.gperf"
-      {"close-quote", CSS_VAL_CLOSE_QUOTE},
+#line 69 "cssvalues.gperf"
+      {"sans-serif", CSS_VAL_SANS_SERIF},
 #line 61 "cssvalues.gperf"
       {"extra-condensed", CSS_VAL_EXTRA_CONDENSED},
-#line 161 "cssvalues.gperf"
+#line 163 "cssvalues.gperf"
       {"hiragana-iroha", CSS_VAL_HIRAGANA_IROHA},
-#line 106 "cssvalues.gperf"
-      {"inactivecaption", CSS_VAL_INACTIVECAPTION},
-#line 107 "cssvalues.gperf"
-      {"inactivecaptiontext", CSS_VAL_INACTIVECAPTIONTEXT},
 #line 30 "cssvalues.gperf"
       {"small-caption", CSS_VAL_SMALL_CAPTION},
-#line 69 "cssvalues.gperf"
-      {"sans-serif", CSS_VAL_SANS_SERIF},
-#line 176 "cssvalues.gperf"
+#line 178 "cssvalues.gperf"
       {"table-column", CSS_VAL_TABLE_COLUMN},
-#line 93 "cssvalues.gperf"
-      {"activeborder", CSS_VAL_ACTIVEBORDER},
+#line 156 "cssvalues.gperf"
+      {"upper-latin", CSS_VAL_UPPER_LATIN},
+#line 149 "cssvalues.gperf"
+      {"decimal-leading-zero", CSS_VAL_DECIMAL_LEADING_ZERO},
 #line 60 "cssvalues.gperf"
       {"ultra-condensed", CSS_VAL_ULTRA_CONDENSED},
-#line 178 "cssvalues.gperf"
+#line 180 "cssvalues.gperf"
       {"table-caption", CSS_VAL_TABLE_CAPTION},
-#line 153 "cssvalues.gperf"
-      {"upper-alpha", CSS_VAL_UPPER_ALPHA},
-#line 94 "cssvalues.gperf"
-      {"activecaption", CSS_VAL_ACTIVECAPTION},
+#line 201 "cssvalues.gperf"
+      {"uppercase", CSS_VAL_UPPERCASE},
 #line 34 "cssvalues.gperf"
       {"small-caps", CSS_VAL_SMALL_CAPS},
-#line 149 "cssvalues.gperf"
-      {"upper-roman", CSS_VAL_UPPER_ROMAN},
-#line 180 "cssvalues.gperf"
+#line 182 "cssvalues.gperf"
       {"crosshair", CSS_VAL_CROSSHAIR},
-#line 147 "cssvalues.gperf"
-      {"decimal-leading-zero", CSS_VAL_DECIMAL_LEADING_ZERO},
-#line 243 "cssvalues.gperf"
+#line 213 "cssvalues.gperf"
+      {"close-quote", CSS_VAL_CLOSE_QUOTE},
+#line 229 "cssvalues.gperf"
+      {"no-close-quote", CSS_VAL_NO_CLOSE_QUOTE},
+#line 245 "cssvalues.gperf"
       {"-khtml-normal", CSS_VAL__KHTML_NORMAL},
-#line 242 "cssvalues.gperf"
+#line 244 "cssvalues.gperf"
       {"-khtml-nowrap", CSS_VAL__KHTML_NOWRAP},
-#line 140 "cssvalues.gperf"
+#line 142 "cssvalues.gperf"
       {"-khtml-center", CSS_VAL__KHTML_CENTER},
-#line 162 "cssvalues.gperf"
+#line 164 "cssvalues.gperf"
       {"katakana-iroha", CSS_VAL_KATAKANA_IROHA},
-#line 95 "cssvalues.gperf"
-      {"appworkspace", CSS_VAL_APPWORKSPACE},
-#line 158 "cssvalues.gperf"
-      {"cjk-ideographic", CSS_VAL_CJK_IDEOGRAPHIC},
+#line 155 "cssvalues.gperf"
+      {"upper-alpha", CSS_VAL_UPPER_ALPHA},
+#line 151 "cssvalues.gperf"
+      {"upper-roman", CSS_VAL_UPPER_ROMAN},
 #line 55 "cssvalues.gperf"
       {"-khtml-xxx-large", CSS_VAL__KHTML_XXX_LARGE},
+#line 160 "cssvalues.gperf"
+      {"cjk-ideographic", CSS_VAL_CJK_IDEOGRAPHIC},
 #line 134 "cssvalues.gperf"
       {"-khtml-baseline-middle", CSS_VAL__KHTML_BASELINE_MIDDLE},
-#line 171 "cssvalues.gperf"
-      {"table-row-group", CSS_VAL_TABLE_ROW_GROUP},
-#line 172 "cssvalues.gperf"
-      {"table-header-group", CSS_VAL_TABLE_HEADER_GROUP},
+#line 95 "cssvalues.gperf"
+      {"appworkspace", CSS_VAL_APPWORKSPACE},
 #line 173 "cssvalues.gperf"
-      {"table-footer-group", CSS_VAL_TABLE_FOOTER_GROUP},
+      {"table-row-group", CSS_VAL_TABLE_ROW_GROUP},
 #line 175 "cssvalues.gperf"
+      {"table-footer-group", CSS_VAL_TABLE_FOOTER_GROUP},
+#line 174 "cssvalues.gperf"
+      {"table-header-group", CSS_VAL_TABLE_HEADER_GROUP},
+#line 177 "cssvalues.gperf"
       {"table-column-group", CSS_VAL_TABLE_COLUMN_GROUP},
-#line 244 "cssvalues.gperf"
+#line 246 "cssvalues.gperf"
       {"-khtml-around-floats", CSS_VAL__KHTML_AROUND_FLOATS}
     };
 
@@ -672,148 +680,144 @@
         7,  -1,  -1,  -1,   8,   9,  -1,  -1,  -1,  10,
        11,  -1,  -1,  12,  13,  14,  -1,  -1,  -1,  15,
        16,  -1,  -1,  17,  18,  19,  -1,  20,  -1,  -1,
-       21,  -1,  -1,  -1,  22,  23,  24,  -1,  -1,  -1,
-       25,  -1,  26,  -1,  27,  28,  -1,  -1,  -1,  29,
-       30,  -1,  -1,  -1,  -1,  31,  -1,  -1,  -1,  32,
-       33,  -1,  -1,  -1,  34,  35,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  36,  -1,  -1,  -1,  -1,  37,
-       -1,  -1,  -1,  -1,  38,  39,  -1,  40,  -1,  -1,
-       41,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       42,  -1,  -1,  -1,  -1,  43,  -1,  -1,  -1,  44,
-       45,  -1,  -1,  -1,  46,  -1,  -1,  -1,  -1,  47,
-       48,  -1,  -1,  -1,  49,  50,  -1,  -1,  -1,  51,
-       52,  -1,  -1,  -1,  53,  54,  -1,  -1,  -1,  -1,
+       21,  -1,  -1,  -1,  22,  23,  -1,  -1,  24,  -1,
+       25,  -1,  -1,  26,  27,  28,  -1,  -1,  29,  30,
+       31,  -1,  -1,  32,  -1,  33,  -1,  -1,  -1,  34,
+       35,  -1,  -1,  -1,  36,  37,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  38,  -1,  -1,  -1,  39,  40,
+       -1,  -1,  -1,  -1,  41,  42,  -1,  -1,  -1,  -1,
+       43,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  44,
+       45,  -1,  -1,  -1,  -1,  46,  -1,  -1,  -1,  -1,
+       47,  -1,  48,  -1,  49,  -1,  -1,  -1,  50,  -1,
+       51,  -1,  -1,  -1,  52,  53,  -1,  -1,  -1,  54,
        55,  -1,  -1,  -1,  -1,  56,  -1,  -1,  -1,  -1,
-       57,  -1,  -1,  58,  59,  -1,  -1,  -1,  -1,  60,
-       -1,  -1,  -1,  -1,  -1,  61,  -1,  -1,  62,  -1,
-       63,  -1,  -1,  -1,  64,  65,  -1,  -1,  -1,  66,
-       67,  -1,  -1,  68,  -1,  69,  -1,  -1,  70,  71,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  72,  73,
-       -1,  -1,  -1,  74,  75,  76,  -1,  77,  78,  -1,
-       79,  -1,  -1,  -1,  80,  81,  -1,  -1,  82,  -1,
-       -1,  -1,  -1,  -1,  83,  -1,  -1,  -1,  84,  -1,
-       85,  -1,  -1,  -1,  86,  87,  -1,  -1,  88,  -1,
-       -1,  -1,  -1,  89,  -1,  90,  -1,  -1,  91,  -1,
-       -1,  -1,  -1,  -1,  92,  -1,  -1,  -1,  -1,  93,
-       -1,  -1,  -1,  -1,  94,  95,  -1,  -1,  -1,  96,
-       97,  -1,  -1,  -1,  98,  -1,  -1,  99,  -1,  -1,
-      100,  -1,  -1,  -1, 101,  -1,  -1,  -1, 102,  -1,
-      103, 104,  -1,  -1,  -1, 105,  -1, 106, 107,  -1,
-      108,  -1,  -1, 109,  -1,  -1,  -1,  -1, 110,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 111,
-      112,  -1, 113, 114,  -1, 115,  -1, 116,  -1,  -1,
-      117,  -1,  -1, 118, 119, 120,  -1,  -1, 121, 122,
-      123,  -1,  -1,  -1, 124,  -1,  -1, 125,  -1, 126,
-       -1,  -1,  -1,  -1,  -1, 127,  -1,  -1,  -1,  -1,
-      128,  -1,  -1,  -1, 129, 130,  -1,  -1,  -1, 131,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 132, 133,
-       -1,  -1,  -1,  -1,  -1, 134,  -1, 135,  -1,  -1,
-      136,  -1, 137,  -1, 138,  -1,  -1,  -1,  -1,  -1,
-      139,  -1,  -1,  -1, 140, 141,  -1,  -1, 142, 143,
-       -1,  -1,  -1,  -1, 144,  -1,  -1,  -1,  -1,  -1,
-      145,  -1,  -1,  -1, 146, 147,  -1,  -1,  -1, 148,
-       -1,  -1,  -1, 149, 150,  -1,  -1,  -1, 151, 152,
-      153,  -1,  -1,  -1,  -1, 154,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1, 155, 156, 157,  -1,  -1, 158,  -1,
-       -1,  -1,  -1,  -1, 159,  -1,  -1,  -1,  -1,  -1,
-      160,  -1,  -1, 161,  -1,  -1,  -1,  -1, 162,  -1,
-       -1,  -1,  -1, 163, 164,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1, 165,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 166,
-      167,  -1,  -1,  -1,  -1,  -1,  -1, 168,  -1, 169,
-       -1,  -1,  -1,  -1, 170,  -1,  -1,  -1,  -1, 171,
-      172,  -1,  -1, 173,  -1, 174,  -1,  -1, 175, 176,
-      177,  -1,  -1,  -1,  -1, 178,  -1,  -1,  -1, 179,
-       -1,  -1,  -1, 180,  -1, 181,  -1,  -1, 182,  -1,
-       -1,  -1,  -1,  -1, 183, 184,  -1,  -1, 185,  -1,
-       -1,  -1,  -1,  -1,  -1, 186,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1, 187,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 188,
+       57,  -1,  58,  -1,  59,  60,  -1,  -1,  61,  -1,
+       62,  -1,  -1,  63,  64,  -1,  -1,  65,  -1,  66,
+       -1,  -1,  -1,  67,  -1,  68,  -1,  69,  -1,  -1,
+       70,  -1,  -1,  -1,  71,  72,  -1,  -1,  -1,  -1,
+       73,  -1,  -1,  -1,  -1,  74,  -1,  -1,  75,  76,
+       -1,  -1,  -1,  77,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  78,  79,  80,  81,  -1,  82,  -1,  -1,
+       83,  -1,  -1,  84,  85,  86,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  87,  -1,  -1,  -1,  -1,  88,
+       89,  -1,  -1,  90,  91,  92,  -1,  -1,  93,  94,
+       -1,  -1,  -1,  -1,  95,  96,  -1,  97,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  98,  -1,  99, 100,  -1,
+      101,  -1,  -1,  -1, 102,  -1, 103,  -1, 104,  -1,
+      105,  -1,  -1,  -1, 106,  -1,  -1,  -1, 107,  -1,
+      108, 109, 110,  -1,  -1, 111,  -1,  -1,  -1,  -1,
+      112,  -1,  -1, 113,  -1,  -1,  -1,  -1, 114,  -1,
+       -1,  -1,  -1, 115,  -1,  -1, 116,  -1,  -1,  -1,
+      117,  -1, 118,  -1,  -1,  -1,  -1,  -1,  -1, 119,
+      120,  -1, 121, 122,  -1, 123,  -1,  -1, 124,  -1,
+      125,  -1,  -1,  -1, 126,  -1, 127,  -1,  -1, 128,
+       -1,  -1,  -1, 129,  -1, 130,  -1,  -1,  -1,  -1,
+      131,  -1,  -1,  -1,  -1, 132,  -1,  -1,  -1,  -1,
+       -1,  -1, 133,  -1,  -1,  -1,  -1,  -1, 134, 135,
+       -1,  -1,  -1,  -1, 136, 137,  -1,  -1,  -1, 138,
+      139,  -1,  -1, 140, 141, 142,  -1,  -1,  -1,  -1,
+      143,  -1, 144, 145,  -1, 146,  -1,  -1,  -1, 147,
+       -1,  -1, 148,  -1,  -1, 149,  -1,  -1,  -1, 150,
+       -1,  -1,  -1, 151, 152, 153,  -1,  -1,  -1,  -1,
+      154,  -1,  -1, 155,  -1, 156,  -1,  -1,  -1, 157,
+      158,  -1,  -1, 159, 160, 161,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 162,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 163,
+       -1,  -1,  -1, 164,  -1,  -1,  -1,  -1,  -1, 165,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1, 166,  -1,  -1, 167,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+      168,  -1,  -1,  -1,  -1,  -1,  -1, 169,  -1, 170,
+       -1,  -1,  -1,  -1,  -1, 171,  -1,  -1,  -1, 172,
+      173,  -1,  -1,  -1, 174, 175,  -1,  -1, 176, 177,
+      178,  -1,  -1,  -1, 179, 180,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 181,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1, 182,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 183,  -1,  -1, 184,  -1,
+       -1,  -1,  -1,  -1,  -1, 185,  -1, 186,  -1,  -1,
+       -1,  -1,  -1, 187,  -1,  -1,  -1,  -1,  -1, 188,
        -1,  -1,  -1,  -1, 189,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1, 190,  -1,  -1,  -1, 191,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 192,  -1,  -1,  -1, 193,
+       -1,  -1,  -1,  -1, 194,  -1,  -1, 195, 196, 197,
+       -1,  -1,  -1, 198,  -1, 199,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 200,  -1,  -1, 201,  -1,
+      202,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1, 203, 204,  -1,  -1,  -1,  -1, 205,  -1,
+       -1,  -1,  -1,  -1, 206,  -1,  -1,  -1, 207,  -1,
+      208,  -1,  -1,  -1, 209,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 210,  -1,
+      211,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 212, 213,
+       -1,  -1,  -1,  -1, 214,  -1,  -1,  -1,  -1, 215,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1, 190,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 191,  -1,
-       -1,  -1,  -1, 192,  -1, 193,  -1,  -1,  -1, 194,
-       -1,  -1,  -1,  -1,  -1, 195,  -1,  -1,  -1,  -1,
-      196,  -1,  -1, 197,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1, 198,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-      199,  -1,  -1,  -1, 200,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1, 201,  -1,  -1,  -1,  -1, 202,  -1,
-      203,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 204, 205,
-       -1,  -1,  -1,  -1, 206,  -1,  -1,  -1,  -1, 207,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 208,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1, 209, 210,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1, 211,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1, 212,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 213,
-      214,  -1,  -1,  -1, 215,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1, 216,  -1,  -1, 217,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 218,
-       -1,  -1,  -1, 219,  -1, 220,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1, 221,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1, 222,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1, 223,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 216,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1, 224,  -1,  -1,  -1,  -1,
-      225,  -1,  -1, 226, 227,  -1,  -1,  -1,  -1,  -1,
-      228,  -1,  -1,  -1, 229,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1, 230,  -1,  -1,  -1,  -1, 231,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1, 232,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 233,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1, 234,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1, 217,  -1,  -1,  -1,  -1, 218,  -1,
+      219,  -1,  -1, 220,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1, 221,  -1,  -1, 222,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 223,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1, 235,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 224,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 225,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1, 236,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1, 237,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 226,
+       -1,  -1,  -1,  -1,  -1, 227,  -1,  -1,  -1,  -1,
+      228,  -1,  -1,  -1, 229,  -1,  -1,  -1,  -1,  -1,
+      230,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1, 231,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1, 232,  -1,  -1,  -1,  -1, 233,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 234,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 235,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 236,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1, 237,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1, 238,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1, 238,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1, 239,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1, 239,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1, 240,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1, 241,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 242,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 240,  -1,
+       -1,  -1,  -1, 243,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 244,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1, 241,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1, 242,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1, 245,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1, 246,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 243,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1, 244
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 247,
+       -1,  -1,  -1, 248
     };
 
   if (len <= MAX_WORD_LENGTH && len >= MIN_WORD_LENGTH)
@@ -835,7 +839,7 @@
     }
   return 0;
 }
-#line 259 "cssvalues.gperf"
+#line 263 "cssvalues.gperf"
 
 static const char * const valueList[] = {
 "",
@@ -965,6 +969,8 @@
 "right", 
 "center", 
 "justify", 
+"-khtml-left", 
+"-khtml-right", 
 "-khtml-center", 
 "outside", 
 "inside", 
@@ -1070,6 +1076,8 @@
 "-khtml-nowrap", 
 "-khtml-normal", 
 "-khtml-around-floats", 
+"border-box", 
+"content-box", 
 "enabled", 
 "disabled", 
 "forwards", 
diff -urN -x CVS kdelibs.orig/khtml/css/cssvalues.h kdelibs/khtml/css/cssvalues.h
--- kdelibs.orig/khtml/css/cssvalues.h	Sun Jun 13 19:08:23 2004
+++ kdelibs/khtml/css/cssvalues.h	Wed Nov 10 10:00:17 2004
@@ -135,126 +135,130 @@
 #define CSS_VAL_RIGHT 124
 #define CSS_VAL_CENTER 125
 #define CSS_VAL_JUSTIFY 126
-#define CSS_VAL__KHTML_CENTER 127
-#define CSS_VAL_OUTSIDE 128
-#define CSS_VAL_INSIDE 129
-#define CSS_VAL_DISC 130
-#define CSS_VAL_CIRCLE 131
-#define CSS_VAL_SQUARE 132
-#define CSS_VAL_DECIMAL 133
-#define CSS_VAL_DECIMAL_LEADING_ZERO 134
-#define CSS_VAL_LOWER_ROMAN 135
-#define CSS_VAL_UPPER_ROMAN 136
-#define CSS_VAL_LOWER_GREEK 137
-#define CSS_VAL_LOWER_ALPHA 138
-#define CSS_VAL_LOWER_LATIN 139
-#define CSS_VAL_UPPER_ALPHA 140
-#define CSS_VAL_UPPER_LATIN 141
-#define CSS_VAL_HEBREW 142
-#define CSS_VAL_ARMENIAN 143
-#define CSS_VAL_GEORGIAN 144
-#define CSS_VAL_CJK_IDEOGRAPHIC 145
-#define CSS_VAL_HIRAGANA 146
-#define CSS_VAL_KATAKANA 147
-#define CSS_VAL_HIRAGANA_IROHA 148
-#define CSS_VAL_KATAKANA_IROHA 149
-#define CSS_VAL_INLINE 150
-#define CSS_VAL_BLOCK 151
-#define CSS_VAL_LIST_ITEM 152
-#define CSS_VAL_RUN_IN 153
-#define CSS_VAL_COMPACT 154
-#define CSS_VAL_INLINE_BLOCK 155
-#define CSS_VAL_TABLE 156
-#define CSS_VAL_INLINE_TABLE 157
-#define CSS_VAL_TABLE_ROW_GROUP 158
-#define CSS_VAL_TABLE_HEADER_GROUP 159
-#define CSS_VAL_TABLE_FOOTER_GROUP 160
-#define CSS_VAL_TABLE_ROW 161
-#define CSS_VAL_TABLE_COLUMN_GROUP 162
-#define CSS_VAL_TABLE_COLUMN 163
-#define CSS_VAL_TABLE_CELL 164
-#define CSS_VAL_TABLE_CAPTION 165
-#define CSS_VAL_AUTO 166
-#define CSS_VAL_CROSSHAIR 167
-#define CSS_VAL_DEFAULT 168
-#define CSS_VAL_POINTER 169
-#define CSS_VAL_PROGRESS 170
-#define CSS_VAL_MOVE 171
-#define CSS_VAL_E_RESIZE 172
-#define CSS_VAL_NE_RESIZE 173
-#define CSS_VAL_NW_RESIZE 174
-#define CSS_VAL_N_RESIZE 175
-#define CSS_VAL_SE_RESIZE 176
-#define CSS_VAL_SW_RESIZE 177
-#define CSS_VAL_S_RESIZE 178
-#define CSS_VAL_W_RESIZE 179
-#define CSS_VAL_TEXT 180
-#define CSS_VAL_WAIT 181
-#define CSS_VAL_HELP 182
-#define CSS_VAL_LTR 183
-#define CSS_VAL_RTL 184
-#define CSS_VAL_CAPITALIZE 185
-#define CSS_VAL_UPPERCASE 186
-#define CSS_VAL_LOWERCASE 187
-#define CSS_VAL_VISIBLE 188
-#define CSS_VAL_COLLAPSE 189
-#define CSS_VAL_ABOVE 190
-#define CSS_VAL_ABSOLUTE 191
-#define CSS_VAL_ALWAYS 192
-#define CSS_VAL_AVOID 193
-#define CSS_VAL_BELOW 194
-#define CSS_VAL_BIDI_OVERRIDE 195
-#define CSS_VAL_BLINK 196
-#define CSS_VAL_BOTH 197
-#define CSS_VAL_CLOSE_QUOTE 198
-#define CSS_VAL_CROP 199
-#define CSS_VAL_CROSS 200
-#define CSS_VAL_EMBED 201
-#define CSS_VAL_FIXED 202
-#define CSS_VAL_HAND 203
-#define CSS_VAL_HIDE 204
-#define CSS_VAL_HIGHER 205
-#define CSS_VAL_INVERT 206
-#define CSS_VAL_LANDSCAPE 207
-#define CSS_VAL_LEVEL 208
-#define CSS_VAL_LINE_THROUGH 209
-#define CSS_VAL_LOUD 210
-#define CSS_VAL_LOWER 211
-#define CSS_VAL_MARQUEE 212
-#define CSS_VAL_MIX 213
-#define CSS_VAL_NO_CLOSE_QUOTE 214
-#define CSS_VAL_NO_OPEN_QUOTE 215
-#define CSS_VAL_NOWRAP 216
-#define CSS_VAL_OPEN_QUOTE 217
-#define CSS_VAL_OVERLINE 218
-#define CSS_VAL_PORTRAIT 219
-#define CSS_VAL_PRE 220
-#define CSS_VAL_RELATIVE 221
-#define CSS_VAL_SCROLL 222
-#define CSS_VAL_SEPARATE 223
-#define CSS_VAL_SHOW 224
-#define CSS_VAL_STATIC 225
-#define CSS_VAL_THICK 226
-#define CSS_VAL_THIN 227
-#define CSS_VAL_UNDERLINE 228
-#define CSS_VAL__KHTML_NOWRAP 229
-#define CSS_VAL__KHTML_NORMAL 230
-#define CSS_VAL__KHTML_AROUND_FLOATS 231
-#define CSS_VAL_ENABLED 232
-#define CSS_VAL_DISABLED 233
-#define CSS_VAL_FORWARDS 234
-#define CSS_VAL_BACKWARDS 235
-#define CSS_VAL_AHEAD 236
-#define CSS_VAL_REVERSE 237
-#define CSS_VAL_UP 238
-#define CSS_VAL_DOWN 239
-#define CSS_VAL_SLOW 240
-#define CSS_VAL_FAST 241
-#define CSS_VAL_INFINITE 242
-#define CSS_VAL_SLIDE 243
-#define CSS_VAL_ALTERNATE 244
-#define CSS_VAL_UNFURL 245
+#define CSS_VAL__KHTML_LEFT 127
+#define CSS_VAL__KHTML_RIGHT 128
+#define CSS_VAL__KHTML_CENTER 129
+#define CSS_VAL_OUTSIDE 130
+#define CSS_VAL_INSIDE 131
+#define CSS_VAL_DISC 132
+#define CSS_VAL_CIRCLE 133
+#define CSS_VAL_SQUARE 134
+#define CSS_VAL_DECIMAL 135
+#define CSS_VAL_DECIMAL_LEADING_ZERO 136
+#define CSS_VAL_LOWER_ROMAN 137
+#define CSS_VAL_UPPER_ROMAN 138
+#define CSS_VAL_LOWER_GREEK 139
+#define CSS_VAL_LOWER_ALPHA 140
+#define CSS_VAL_LOWER_LATIN 141
+#define CSS_VAL_UPPER_ALPHA 142
+#define CSS_VAL_UPPER_LATIN 143
+#define CSS_VAL_HEBREW 144
+#define CSS_VAL_ARMENIAN 145
+#define CSS_VAL_GEORGIAN 146
+#define CSS_VAL_CJK_IDEOGRAPHIC 147
+#define CSS_VAL_HIRAGANA 148
+#define CSS_VAL_KATAKANA 149
+#define CSS_VAL_HIRAGANA_IROHA 150
+#define CSS_VAL_KATAKANA_IROHA 151
+#define CSS_VAL_INLINE 152
+#define CSS_VAL_BLOCK 153
+#define CSS_VAL_LIST_ITEM 154
+#define CSS_VAL_RUN_IN 155
+#define CSS_VAL_COMPACT 156
+#define CSS_VAL_INLINE_BLOCK 157
+#define CSS_VAL_TABLE 158
+#define CSS_VAL_INLINE_TABLE 159
+#define CSS_VAL_TABLE_ROW_GROUP 160
+#define CSS_VAL_TABLE_HEADER_GROUP 161
+#define CSS_VAL_TABLE_FOOTER_GROUP 162
+#define CSS_VAL_TABLE_ROW 163
+#define CSS_VAL_TABLE_COLUMN_GROUP 164
+#define CSS_VAL_TABLE_COLUMN 165
+#define CSS_VAL_TABLE_CELL 166
+#define CSS_VAL_TABLE_CAPTION 167
+#define CSS_VAL_AUTO 168
+#define CSS_VAL_CROSSHAIR 169
+#define CSS_VAL_DEFAULT 170
+#define CSS_VAL_POINTER 171
+#define CSS_VAL_PROGRESS 172
+#define CSS_VAL_MOVE 173
+#define CSS_VAL_E_RESIZE 174
+#define CSS_VAL_NE_RESIZE 175
+#define CSS_VAL_NW_RESIZE 176
+#define CSS_VAL_N_RESIZE 177
+#define CSS_VAL_SE_RESIZE 178
+#define CSS_VAL_SW_RESIZE 179
+#define CSS_VAL_S_RESIZE 180
+#define CSS_VAL_W_RESIZE 181
+#define CSS_VAL_TEXT 182
+#define CSS_VAL_WAIT 183
+#define CSS_VAL_HELP 184
+#define CSS_VAL_LTR 185
+#define CSS_VAL_RTL 186
+#define CSS_VAL_CAPITALIZE 187
+#define CSS_VAL_UPPERCASE 188
+#define CSS_VAL_LOWERCASE 189
+#define CSS_VAL_VISIBLE 190
+#define CSS_VAL_COLLAPSE 191
+#define CSS_VAL_ABOVE 192
+#define CSS_VAL_ABSOLUTE 193
+#define CSS_VAL_ALWAYS 194
+#define CSS_VAL_AVOID 195
+#define CSS_VAL_BELOW 196
+#define CSS_VAL_BIDI_OVERRIDE 197
+#define CSS_VAL_BLINK 198
+#define CSS_VAL_BOTH 199
+#define CSS_VAL_CLOSE_QUOTE 200
+#define CSS_VAL_CROP 201
+#define CSS_VAL_CROSS 202
+#define CSS_VAL_EMBED 203
+#define CSS_VAL_FIXED 204
+#define CSS_VAL_HAND 205
+#define CSS_VAL_HIDE 206
+#define CSS_VAL_HIGHER 207
+#define CSS_VAL_INVERT 208
+#define CSS_VAL_LANDSCAPE 209
+#define CSS_VAL_LEVEL 210
+#define CSS_VAL_LINE_THROUGH 211
+#define CSS_VAL_LOUD 212
+#define CSS_VAL_LOWER 213
+#define CSS_VAL_MARQUEE 214
+#define CSS_VAL_MIX 215
+#define CSS_VAL_NO_CLOSE_QUOTE 216
+#define CSS_VAL_NO_OPEN_QUOTE 217
+#define CSS_VAL_NOWRAP 218
+#define CSS_VAL_OPEN_QUOTE 219
+#define CSS_VAL_OVERLINE 220
+#define CSS_VAL_PORTRAIT 221
+#define CSS_VAL_PRE 222
+#define CSS_VAL_RELATIVE 223
+#define CSS_VAL_SCROLL 224
+#define CSS_VAL_SEPARATE 225
+#define CSS_VAL_SHOW 226
+#define CSS_VAL_STATIC 227
+#define CSS_VAL_THICK 228
+#define CSS_VAL_THIN 229
+#define CSS_VAL_UNDERLINE 230
+#define CSS_VAL__KHTML_NOWRAP 231
+#define CSS_VAL__KHTML_NORMAL 232
+#define CSS_VAL__KHTML_AROUND_FLOATS 233
+#define CSS_VAL_BORDER_BOX 234
+#define CSS_VAL_CONTENT_BOX 235
+#define CSS_VAL_ENABLED 236
+#define CSS_VAL_DISABLED 237
+#define CSS_VAL_FORWARDS 238
+#define CSS_VAL_BACKWARDS 239
+#define CSS_VAL_AHEAD 240
+#define CSS_VAL_REVERSE 241
+#define CSS_VAL_UP 242
+#define CSS_VAL_DOWN 243
+#define CSS_VAL_SLOW 244
+#define CSS_VAL_FAST 245
+#define CSS_VAL_INFINITE 246
+#define CSS_VAL_SLIDE 247
+#define CSS_VAL_ALTERNATE 248
+#define CSS_VAL_UNFURL 249
 
-#define CSS_VAL_TOTAL 246
+#define CSS_VAL_TOTAL 250
 #endif
 
diff -urN -x CVS kdelibs.orig/khtml/css/cssvalues.in kdelibs/khtml/css/cssvalues.in
--- kdelibs.orig/khtml/css/cssvalues.in	Sun Jun 13 19:08:23 2004
+++ kdelibs/khtml/css/cssvalues.in	Wed Nov 10 10:00:17 2004
@@ -184,6 +184,8 @@
 right
 center
 justify
+-khtml-left
+-khtml-right
 -khtml-center
 #
 # CSS_PROP_LIST_STYLE_POSITION:
@@ -315,12 +317,17 @@
 thin
 underline
 -khtml-nowrap
-# CSS_PROP__KONQ_FLOW_MODE
+#
+# CSS_PROP__KHTML_FLOW_MODE
 -khtml-normal
 -khtml-around-floats
 
 # CSS3 Values
-# CSS_PROP__KONQ_USER_INPUT
+# CSS_PROP__KHTML_BOX_SIZING
+border-box
+content-box
+
+# CSS_PROP__KHTML_USER_INPUT
 enabled
 disabled
 #none
diff -urN -x CVS kdelibs.orig/khtml/css/html4.css kdelibs/khtml/css/html4.css
--- kdelibs.orig/khtml/css/html4.css	Sat Jun 26 15:09:08 2004
+++ kdelibs/khtml/css/html4.css	Wed Nov 24 14:51:41 2004
@@ -131,46 +131,50 @@
 
 /*
  * heading elements
+ * margin values rely on font-sizes ratio defined in CSS-2.1 15.7
+ * (cf. CSSStyleSelector for absolute font-sizes computation) 
+ * We have an 1.1/font-ratio margin
  */
 
 H1 {
 	display: block;
-	font-size: 1.7em;
-	margin: .67__qem auto .67em auto;
+	font-size: xx-large;
+	margin: .55__qem 0 .55em 0;
 	font-weight: bolder;
 }
 
 H2 {
 	display: block;
-	font-size: 1.4em;
-	margin: .83__qem auto .83em auto;
+	font-size: x-large;
+	margin: .73__qem 0 .73em 0;
 	font-weight: bolder;
 }
 
 H3 {
 	display: block;
-	font-size: 1.17em;
-	margin: 1__qem auto 1em auto;
+	font-size: large;
+	margin: 0.92__qem 0 0.92em 0;
 	font-weight: bolder;
 }
 
 H4 {
 	display: block;
-	margin: 1.33__qem auto 1.33em auto;
+        font-size: medium;
+	margin: 1.1__qem 0 1.1em 0;
 	font-weight: bolder;
 }
 
 H5 {
 	display: block;
-	font-size: .83em;
-	margin: 1.67__qem auto 1.67em auto;
+	font-size: small;
+	margin: 1.24__qem 0 1.24em 0;
 	font-weight: bolder;
 }
 
 H6 {
 	display: block;
-	font-size: .67em;
-	margin: 2.33__qem auto 2.33em auto;
+	font-size: xx-small;
+	margin: 1.83__qem 0 1.83em 0;
 	font-weight: bolder;
 }
 
@@ -367,6 +371,7 @@
         padding: 0.75em 0.625em;
 	margin: 1.0em auto;
         border: 2px groove ThreeDFace;
+        -khtml-flow-mode: -khtml-around-floats
 }
 
 BUTTON {
@@ -425,7 +430,6 @@
 
 TEXTAREA {
         color: windowtext;
-        font-size: normal;
         font-family: monospace;
         margin: 0__qem;
 }
diff -urN -x CVS kdelibs.orig/khtml/css/parser.cpp kdelibs/khtml/css/parser.cpp
--- kdelibs.orig/khtml/css/parser.cpp	Mon Jul 26 10:59:25 2004
+++ kdelibs/khtml/css/parser.cpp	Wed Nov 10 10:00:17 2004
@@ -268,6 +268,7 @@
     unsigned int element;
     unsigned int ns;
     CSSSelector::Relation relation;
+    CSSSelector::Match match;
     bool b;
     char tok;
     Value value;
@@ -404,16 +405,16 @@
 /* YYFINAL -- State number of the termination state. */
 #define YYFINAL  16
 /* YYLAST -- Last index in YYTABLE.  */
-#define YYLAST   447
+#define YYLAST   427
 
 /* YYNTOKENS -- Number of terminals. */
-#define YYNTOKENS  63
+#define YYNTOKENS  64
 /* YYNNTS -- Number of nonterminals. */
 #define YYNNTS  57
 /* YYNRULES -- Number of rules. */
-#define YYNRULES  154
+#define YYNRULES  155
 /* YYNRULES -- Number of states. */
-#define YYNSTATES  281
+#define YYNSTATES  283
 
 /* YYTRANSLATE(YYLEX) -- Bison symbol number corresponding to YYLEX.  */
 #define YYUNDEFTOK  2
@@ -429,15 +430,15 @@
        2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
        2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
        2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,    60,    17,    55,    54,    57,    15,    61,     2,     2,
+       2,    61,    17,    55,    54,    58,    15,    62,     2,     2,
        2,     2,     2,     2,     2,     2,     2,     2,    14,    53,
-       2,    59,    56,     2,    62,     2,     2,     2,     2,     2,
+       2,    60,    57,     2,    63,     2,     2,     2,     2,     2,
        2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
        2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,    16,     2,    58,     2,     2,     2,     2,     2,     2,
+       2,    16,     2,    59,     2,     2,     2,     2,     2,     2,
        2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
        2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,    51,    18,    52,     2,     2,     2,     2,
+       2,     2,     2,    51,    18,    52,    56,     2,     2,     2,
        2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
        2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
        2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
@@ -468,92 +469,93 @@
       65,    72,    76,    80,    81,    84,    91,    93,    94,    97,
       98,   102,   104,   106,   108,   110,   112,   114,   117,   119,
      121,   122,   124,   126,   131,   134,   142,   143,   147,   150,
-     154,   158,   162,   166,   169,   172,   173,   175,   177,   180,
-     182,   187,   190,   192,   196,   199,   202,   206,   209,   212,
-     214,   216,   219,   222,   224,   226,   228,   231,   234,   236,
-     238,   240,   242,   245,   248,   250,   253,   258,   267,   269,
-     271,   273,   275,   277,   279,   281,   283,   286,   290,   296,
-     301,   306,   311,   317,   323,   327,   331,   336,   341,   347,
-     350,   353,   356,   357,   359,   363,   366,   369,   370,   372,
-     375,   378,   381,   384,   387,   390,   392,   394,   397,   400,
+     154,   158,   162,   166,   169,   172,   175,   176,   178,   180,
+     183,   185,   190,   193,   195,   199,   202,   205,   209,   212,
+     215,   217,   219,   222,   225,   227,   229,   231,   234,   237,
+     239,   241,   243,   245,   248,   251,   253,   256,   261,   270,
+     272,   274,   276,   278,   280,   282,   284,   286,   289,   293,
+     299,   304,   309,   314,   320,   326,   330,   334,   339,   344,
+     350,   353,   356,   359,   360,   362,   366,   369,   372,   373,
+     375,   378,   381,   384,   387,   390,   393,   395,   397,   400,
      403,   406,   409,   412,   415,   418,   421,   424,   427,   430,
-     433,   436,   439,   442,   445,   448,   454,   458,   461,   465,
-     469,   472,   478,   482,   484
+     433,   436,   439,   442,   445,   448,   451,   457,   461,   464,
+     468,   472,   475,   481,   485,   487
 };
 
 /* YYRHS -- A `-1'-separated list of the rules' RHS. */
 static const yysigned_char yyrhs[] =
 {
-      64,     0,    -1,    70,    69,    71,    73,    77,    -1,    65,
-      68,    -1,    66,    68,    -1,    67,    68,    -1,    25,    51,
-      68,    89,    68,    52,    -1,    26,   105,    -1,    27,    51,
-      68,   110,    52,    -1,    -1,    68,     4,    -1,    -1,    69,
-       5,    -1,    69,     4,    -1,    -1,    23,    68,    11,    68,
-      53,    -1,    23,     1,   118,    -1,    23,     1,    53,    -1,
-      -1,    71,    72,    69,    -1,    19,    68,    79,    68,    80,
-      53,    -1,    19,     1,   118,    -1,    19,     1,    53,    -1,
-      -1,    74,    69,    -1,    24,    68,    76,    79,    68,    53,
-      -1,    12,    -1,    -1,    75,    68,    -1,    -1,    77,    78,
-      69,    -1,    89,    -1,    82,    -1,    85,    -1,    86,    -1,
-     117,    -1,   116,    -1,    72,     1,    -1,    11,    -1,    48,
-      -1,    -1,    81,    -1,    84,    -1,    81,    54,    68,    84,
-      -1,    81,     1,    -1,    21,    68,    81,    51,    68,    83,
-      52,    -1,    -1,    83,    89,    68,    -1,    12,    68,    -1,
-      20,     1,   118,    -1,    20,     1,    53,    -1,    22,     1,
-     118,    -1,    22,     1,    53,    -1,    55,    68,    -1,    56,
-      68,    -1,    -1,    57,    -1,    55,    -1,    90,   105,    -1,
-      91,    -1,    90,    54,    68,    91,    -1,    90,     1,    -1,
-      92,    -1,    91,    87,    92,    -1,    91,     1,    -1,    93,
-      68,    -1,    93,    96,    68,    -1,    96,    68,    -1,    94,
-      95,    -1,    95,    -1,    18,    -1,    12,    18,    -1,    17,
-      18,    -1,    12,    -1,    17,    -1,    97,    -1,    96,    97,
-      -1,    96,     1,    -1,    13,    -1,    98,    -1,   101,    -1,
-     104,    -1,    15,    12,    -1,    94,   100,    -1,   100,    -1,
-      12,    68,    -1,    16,    68,    99,    58,    -1,    16,    68,
-      99,   102,    68,   103,    68,    58,    -1,    59,    -1,     6,
-      -1,     7,    -1,     8,    -1,     9,    -1,    10,    -1,    12,
-      -1,    11,    -1,    14,    12,    -1,    14,    14,    12,    -1,
-      14,    49,    68,    92,    60,    -1,    51,    68,   107,    52,
-      -1,    51,    68,     1,    52,    -1,    51,    68,   106,    52,
-      -1,    51,    68,   106,   107,    52,    -1,    51,    68,   106,
-       1,    52,    -1,   107,    53,    68,    -1,     1,    53,    68,
-      -1,   106,   107,    53,    68,    -1,   106,     1,    53,    68,
-      -1,   108,    14,    68,   110,   109,    -1,     1,   118,    -1,
-      12,    68,    -1,    28,    68,    -1,    -1,   112,    -1,   110,
-     111,   112,    -1,    61,    68,    -1,    54,    68,    -1,    -1,
-     113,    -1,    88,   113,    -1,    45,    68,    -1,    11,    68,
-      -1,    12,    68,    -1,    48,    68,    -1,    50,    68,    -1,
-     115,    -1,   114,    -1,    47,    68,    -1,    46,    68,    -1,
-      32,    68,    -1,    33,    68,    -1,    34,    68,    -1,    35,
-      68,    -1,    36,    68,    -1,    37,    68,    -1,    38,    68,
-      -1,    39,    68,    -1,    40,    68,    -1,    41,    68,    -1,
-      42,    68,    -1,    43,    68,    -1,    44,    68,    -1,    30,
-      68,    -1,    29,    68,    -1,    31,    68,    -1,    49,    68,
-     110,    60,    68,    -1,    49,    68,     1,    -1,    13,    68,
-      -1,    62,     1,   118,    -1,    62,     1,    53,    -1,     1,
-     118,    -1,    51,     1,   119,     1,    52,    -1,    51,     1,
-      52,    -1,   118,    -1,   119,     1,   118,    -1
+      65,     0,    -1,    71,    70,    72,    74,    78,    -1,    66,
+      69,    -1,    67,    69,    -1,    68,    69,    -1,    25,    51,
+      69,    90,    69,    52,    -1,    26,   106,    -1,    27,    51,
+      69,   111,    52,    -1,    -1,    69,     4,    -1,    -1,    70,
+       5,    -1,    70,     4,    -1,    -1,    23,    69,    11,    69,
+      53,    -1,    23,     1,   119,    -1,    23,     1,    53,    -1,
+      -1,    72,    73,    70,    -1,    19,    69,    80,    69,    81,
+      53,    -1,    19,     1,   119,    -1,    19,     1,    53,    -1,
+      -1,    75,    70,    -1,    24,    69,    77,    80,    69,    53,
+      -1,    12,    -1,    -1,    76,    69,    -1,    -1,    78,    79,
+      70,    -1,    90,    -1,    83,    -1,    86,    -1,    87,    -1,
+     118,    -1,   117,    -1,    73,     1,    -1,    11,    -1,    48,
+      -1,    -1,    82,    -1,    85,    -1,    82,    54,    69,    85,
+      -1,    82,     1,    -1,    21,    69,    82,    51,    69,    84,
+      52,    -1,    -1,    84,    90,    69,    -1,    12,    69,    -1,
+      20,     1,   119,    -1,    20,     1,    53,    -1,    22,     1,
+     119,    -1,    22,     1,    53,    -1,    55,    69,    -1,    56,
+      69,    -1,    57,    69,    -1,    -1,    58,    -1,    55,    -1,
+      91,   106,    -1,    92,    -1,    91,    54,    69,    92,    -1,
+      91,     1,    -1,    93,    -1,    92,    88,    93,    -1,    92,
+       1,    -1,    94,    69,    -1,    94,    97,    69,    -1,    97,
+      69,    -1,    95,    96,    -1,    96,    -1,    18,    -1,    12,
+      18,    -1,    17,    18,    -1,    12,    -1,    17,    -1,    98,
+      -1,    97,    98,    -1,    97,     1,    -1,    13,    -1,    99,
+      -1,   102,    -1,   105,    -1,    15,    12,    -1,    95,   101,
+      -1,   101,    -1,    12,    69,    -1,    16,    69,   100,    59,
+      -1,    16,    69,   100,   103,    69,   104,    69,    59,    -1,
+      60,    -1,     6,    -1,     7,    -1,     8,    -1,     9,    -1,
+      10,    -1,    12,    -1,    11,    -1,    14,    12,    -1,    14,
+      14,    12,    -1,    14,    49,    69,    93,    61,    -1,    51,
+      69,   108,    52,    -1,    51,    69,     1,    52,    -1,    51,
+      69,   107,    52,    -1,    51,    69,   107,   108,    52,    -1,
+      51,    69,   107,     1,    52,    -1,   108,    53,    69,    -1,
+       1,    53,    69,    -1,   107,   108,    53,    69,    -1,   107,
+       1,    53,    69,    -1,   109,    14,    69,   111,   110,    -1,
+       1,   119,    -1,    12,    69,    -1,    28,    69,    -1,    -1,
+     113,    -1,   111,   112,   113,    -1,    62,    69,    -1,    54,
+      69,    -1,    -1,   114,    -1,    89,   114,    -1,    45,    69,
+      -1,    11,    69,    -1,    12,    69,    -1,    48,    69,    -1,
+      50,    69,    -1,   116,    -1,   115,    -1,    47,    69,    -1,
+      46,    69,    -1,    32,    69,    -1,    33,    69,    -1,    34,
+      69,    -1,    35,    69,    -1,    36,    69,    -1,    37,    69,
+      -1,    38,    69,    -1,    39,    69,    -1,    40,    69,    -1,
+      41,    69,    -1,    42,    69,    -1,    43,    69,    -1,    44,
+      69,    -1,    30,    69,    -1,    29,    69,    -1,    31,    69,
+      -1,    49,    69,   111,    61,    69,    -1,    49,    69,     1,
+      -1,    13,    69,    -1,    63,     1,   119,    -1,    63,     1,
+      53,    -1,     1,   119,    -1,    51,     1,   120,     1,    52,
+      -1,    51,     1,    52,    -1,   119,    -1,   120,     1,   119,
+      -1
 };
 
 /* YYRLINE[YYN] -- source line where rule number YYN was defined.  */
 static const unsigned short yyrline[] =
 {
-       0,   253,   253,   254,   255,   256,   260,   267,   273,   298,
-     299,   302,   304,   305,   308,   310,   315,   316,   319,   321,
-     332,   342,   345,   351,   352,   356,   360,   364,   365,   368,
-     370,   381,   382,   383,   384,   385,   386,   387,   391,   392,
-     396,   399,   404,   408,   413,   420,   434,   435,   445,   467,
-     470,   476,   479,   485,   486,   487,   491,   492,   496,   516,
-     529,   543,   550,   553,   574,   581,   585,   590,   598,   599,
-     608,   609,   610,   615,   635,   639,   643,   653,   660,   666,
-     667,   668,   672,   681,   682,   689,   713,   718,   727,   730,
-     733,   736,   739,   742,   748,   749,   753,   759,   764,   773,
-     776,   779,   782,   787,   793,   797,   800,   805,   811,   833,
-     839,   846,   847,   851,   855,   871,   874,   877,   883,   884,
-     886,   887,   888,   894,   895,   896,   898,   904,   905,   906,
-     907,   908,   909,   910,   911,   912,   913,   914,   915,   916,
-     917,   918,   919,   920,   921,   926,   934,   950,   957,   963,
-     972,   998,   999,  1003,  1004
+       0,   254,   254,   255,   256,   257,   261,   268,   274,   299,
+     300,   303,   305,   306,   309,   311,   316,   317,   320,   322,
+     333,   343,   346,   352,   353,   357,   361,   365,   366,   369,
+     371,   382,   383,   384,   385,   386,   387,   388,   392,   393,
+     397,   400,   405,   409,   414,   421,   435,   436,   446,   468,
+     471,   477,   480,   486,   487,   488,   489,   493,   494,   498,
+     518,   531,   545,   552,   555,   576,   583,   587,   592,   600,
+     601,   610,   611,   612,   617,   637,   641,   645,   655,   662,
+     668,   669,   670,   674,   683,   684,   691,   715,   720,   729,
+     732,   735,   738,   741,   744,   750,   751,   755,   761,   766,
+     775,   778,   781,   784,   789,   795,   799,   802,   807,   813,
+     835,   841,   848,   849,   853,   857,   873,   876,   879,   885,
+     886,   888,   889,   890,   896,   897,   898,   900,   906,   907,
+     908,   909,   910,   911,   912,   913,   914,   915,   916,   917,
+     918,   919,   920,   921,   922,   923,   928,   936,   952,   959,
+     965,   974,  1000,  1001,  1005,  1006
 };
 #endif
 
@@ -570,20 +572,20 @@
   "IMPORTANT_SYM", "QEMS", "EMS", "EXS", "PXS", "CMS", "MMS", "INS", 
   "PTS", "PCS", "DEGS", "RADS", "GRADS", "MSECS", "SECS", "HERZ", "KHERZ", 
   "DIMEN", "PERCENTAGE", "NUMBER", "URI", "FUNCTION", "UNICODERANGE", 
-  "'{'", "'}'", "';'", "','", "'+'", "'>'", "'-'", "']'", "'='", "')'", 
-  "'/'", "'@'", "$accept", "stylesheet", "khtml_rule", "khtml_decls", 
-  "khtml_value", "maybe_space", "maybe_sgml", "maybe_charset", 
-  "import_list", "import", "maybe_namespace", "namespace", "ns_prefix", 
-  "maybe_ns_prefix", "rule_list", "rule", "string_or_uri", 
-  "maybe_media_list", "media_list", "media", "ruleset_list", "medium", 
-  "page", "font_face", "combinator", "unary_operator", "ruleset", 
-  "selector_list", "selector", "simple_selector", "ns_element", 
-  "ns_selector", "element_name", "specifier_list", "specifier", "class", 
-  "ns_attrib_id", "attrib_id", "attrib", "match", "ident_or_string", 
-  "pseudo", "declaration_block", "declaration_list", "declaration", 
-  "property", "prio", "expr", "operator", "term", "unary_term", 
-  "function", "hexcolor", "invalid_at", "invalid_rule", "invalid_block", 
-  "invalid_block_list", 0
+  "'{'", "'}'", "';'", "','", "'+'", "'~'", "'>'", "'-'", "']'", "'='", 
+  "')'", "'/'", "'@'", "$accept", "stylesheet", "khtml_rule", 
+  "khtml_decls", "khtml_value", "maybe_space", "maybe_sgml", 
+  "maybe_charset", "import_list", "import", "maybe_namespace", 
+  "namespace", "ns_prefix", "maybe_ns_prefix", "rule_list", "rule", 
+  "string_or_uri", "maybe_media_list", "media_list", "media", 
+  "ruleset_list", "medium", "page", "font_face", "combinator", 
+  "unary_operator", "ruleset", "selector_list", "selector", 
+  "simple_selector", "ns_element", "ns_selector", "element_name", 
+  "specifier_list", "specifier", "class", "ns_attrib_id", "attrib_id", 
+  "attrib", "match", "ident_or_string", "pseudo", "declaration_block", 
+  "declaration_list", "declaration", "property", "prio", "expr", 
+  "operator", "term", "unary_term", "function", "hexcolor", "invalid_at", 
+  "invalid_rule", "invalid_block", "invalid_block_list", 0
 };
 #endif
 
@@ -597,30 +599,30 @@
      270,   271,   272,   273,   274,   275,   276,   277,   278,   279,
      280,   281,   282,   283,   284,   285,   286,   287,   288,   289,
      290,   291,   292,   293,   294,   295,   296,   297,   298,   299,
-     300,   123,   125,    59,    44,    43,    62,    45,    93,    61,
-      41,    47,    64
+     300,   123,   125,    59,    44,    43,   126,    62,    45,    93,
+      61,    41,    47,    64
 };
 # endif
 
 /* YYR1[YYN] -- Symbol number of symbol that rule YYN derives.  */
 static const unsigned char yyr1[] =
 {
-       0,    63,    64,    64,    64,    64,    65,    66,    67,    68,
-      68,    69,    69,    69,    70,    70,    70,    70,    71,    71,
-      72,    72,    72,    73,    73,    74,    75,    76,    76,    77,
-      77,    78,    78,    78,    78,    78,    78,    78,    79,    79,
-      80,    80,    81,    81,    81,    82,    83,    83,    84,    85,
-      85,    86,    86,    87,    87,    87,    88,    88,    89,    90,
-      90,    90,    91,    91,    91,    92,    92,    92,    93,    93,
-      94,    94,    94,    95,    95,    96,    96,    96,    97,    97,
-      97,    97,    98,    99,    99,   100,   101,   101,   102,   102,
-     102,   102,   102,   102,   103,   103,   104,   104,   104,   105,
-     105,   105,   105,   105,   106,   106,   106,   106,   107,   107,
-     108,   109,   109,   110,   110,   111,   111,   111,   112,   112,
-     112,   112,   112,   112,   112,   112,   112,   113,   113,   113,
-     113,   113,   113,   113,   113,   113,   113,   113,   113,   113,
-     113,   113,   113,   113,   113,   114,   114,   115,   116,   116,
-     117,   118,   118,   119,   119
+       0,    64,    65,    65,    65,    65,    66,    67,    68,    69,
+      69,    70,    70,    70,    71,    71,    71,    71,    72,    72,
+      73,    73,    73,    74,    74,    75,    76,    77,    77,    78,
+      78,    79,    79,    79,    79,    79,    79,    79,    80,    80,
+      81,    81,    82,    82,    82,    83,    84,    84,    85,    86,
+      86,    87,    87,    88,    88,    88,    88,    89,    89,    90,
+      91,    91,    91,    92,    92,    92,    93,    93,    93,    94,
+      94,    95,    95,    95,    96,    96,    97,    97,    97,    98,
+      98,    98,    98,    99,   100,   100,   101,   102,   102,   103,
+     103,   103,   103,   103,   103,   104,   104,   105,   105,   105,
+     106,   106,   106,   106,   106,   107,   107,   107,   107,   108,
+     108,   109,   110,   110,   111,   111,   112,   112,   112,   113,
+     113,   113,   113,   113,   113,   113,   113,   113,   114,   114,
+     114,   114,   114,   114,   114,   114,   114,   114,   114,   114,
+     114,   114,   114,   114,   114,   114,   115,   115,   116,   117,
+     117,   118,   119,   119,   120,   120
 };
 
 /* YYR2[YYN] -- Number of symbols composing right hand side of rule YYN.  */
@@ -631,17 +633,17 @@
        6,     3,     3,     0,     2,     6,     1,     0,     2,     0,
        3,     1,     1,     1,     1,     1,     1,     2,     1,     1,
        0,     1,     1,     4,     2,     7,     0,     3,     2,     3,
-       3,     3,     3,     2,     2,     0,     1,     1,     2,     1,
-       4,     2,     1,     3,     2,     2,     3,     2,     2,     1,
-       1,     2,     2,     1,     1,     1,     2,     2,     1,     1,
-       1,     1,     2,     2,     1,     2,     4,     8,     1,     1,
-       1,     1,     1,     1,     1,     1,     2,     3,     5,     4,
-       4,     4,     5,     5,     3,     3,     4,     4,     5,     2,
-       2,     2,     0,     1,     3,     2,     2,     0,     1,     2,
-       2,     2,     2,     2,     2,     1,     1,     2,     2,     2,
+       3,     3,     3,     2,     2,     2,     0,     1,     1,     2,
+       1,     4,     2,     1,     3,     2,     2,     3,     2,     2,
+       1,     1,     2,     2,     1,     1,     1,     2,     2,     1,
+       1,     1,     1,     2,     2,     1,     2,     4,     8,     1,
+       1,     1,     1,     1,     1,     1,     1,     2,     3,     5,
+       4,     4,     4,     5,     5,     3,     3,     4,     4,     5,
+       2,     2,     2,     0,     1,     3,     2,     2,     0,     1,
+       2,     2,     2,     2,     2,     2,     1,     1,     2,     2,
        2,     2,     2,     2,     2,     2,     2,     2,     2,     2,
-       2,     2,     2,     2,     2,     5,     3,     2,     3,     3,
-       2,     5,     3,     1,     3
+       2,     2,     2,     2,     2,     2,     5,     3,     2,     3,
+       3,     2,     5,     3,     1,     3
 };
 
 /* YYDEFACT[STATE-NAME] -- Default rule to reduce with in state
@@ -652,191 +654,187 @@
       14,     0,     0,     0,     0,     0,     9,     9,     9,    11,
        0,     0,     9,     9,     7,     9,     1,     3,     4,     5,
       18,     0,    17,    16,    10,     9,     0,     0,     0,    13,
-      12,    23,     0,     0,    73,    78,     0,     0,     9,    74,
-      70,     9,     0,     0,    62,     9,     0,    69,     0,    75,
-      79,    80,    81,     0,     9,     0,     0,     0,     9,     9,
+      12,    23,     0,     0,    74,    79,     0,     0,     9,    75,
+      71,     9,     0,     0,    63,     9,     0,    70,     0,    76,
+      80,    81,    82,     0,     9,     0,     0,     0,     9,     9,
        9,     9,     9,     9,     9,     9,     9,     9,     9,     9,
        9,     9,     9,     9,     9,     9,     9,     9,     9,     9,
-       9,     9,     9,    57,    56,     0,   117,   113,   118,   126,
-     125,     0,     9,    11,    29,    11,   152,   153,     0,    15,
-      71,    96,     0,     9,    82,     0,    72,     0,    61,     9,
-      58,    64,     9,     9,     0,    65,     0,    73,    74,    68,
-      77,    67,    76,   100,     9,   109,   110,     0,   101,     0,
-      99,     9,     9,   121,   122,   147,   143,   142,   144,   129,
+       9,     9,     9,    58,    57,     0,   118,   114,   119,   127,
+     126,     0,     9,    11,    29,    11,   153,   154,     0,    15,
+      72,    97,     0,     9,    83,     0,    73,     0,    62,     9,
+      59,    65,     9,     9,     9,     0,    66,     0,    74,    75,
+      69,    78,    68,    77,   101,     9,   110,   111,     0,   102,
+       0,   100,     9,     9,   122,   123,   148,   144,   143,   145,
      130,   131,   132,   133,   134,   135,   136,   137,   138,   139,
-     140,   141,   120,   128,   127,   123,     0,   124,   119,     8,
-       9,     9,     0,     0,     0,    27,    19,     0,    24,     0,
-      97,     0,     9,     0,     0,     0,    84,     6,     0,    53,
-      54,    63,    66,   105,   103,     9,   102,     9,   104,     0,
-     146,   117,   116,   115,   114,    22,    21,    38,    39,     9,
-      26,     9,     0,     0,     0,     9,     0,     0,     0,    11,
-      32,    33,    34,    31,    36,    35,   151,   154,     0,    85,
-       9,    83,    89,    90,    91,    92,    93,    86,    88,     9,
-       0,   107,   106,   117,     9,    40,    28,     9,   150,     0,
-       0,     0,     0,    37,    30,    98,     0,     9,   108,   145,
-       9,     0,     0,    42,     0,    50,    49,     0,    52,    51,
-     149,   148,    95,    94,     9,   111,    48,    20,    44,     9,
-      25,     9,     0,     0,    46,    87,    43,     0,    45,     9,
-      47
+     140,   141,   142,   121,   129,   128,   124,     0,   125,   120,
+       8,     9,     9,     0,     0,     0,    27,    19,     0,    24,
+       0,    98,     0,     9,     0,     0,     0,    85,     6,     0,
+      53,    54,    55,    64,    67,   106,   104,     9,   103,     9,
+     105,     0,   147,   118,   117,   116,   115,    22,    21,    38,
+      39,     9,    26,     9,     0,     0,     0,     9,     0,     0,
+       0,    11,    32,    33,    34,    31,    36,    35,   152,   155,
+       0,    86,     9,    84,    90,    91,    92,    93,    94,    87,
+      89,     9,     0,   108,   107,   118,     9,    40,    28,     9,
+     151,     0,     0,     0,     0,    37,    30,    99,     0,     9,
+     109,   146,     9,     0,     0,    42,     0,    50,    49,     0,
+      52,    51,   150,   149,    96,    95,     9,   112,    48,    20,
+      44,     9,    25,     9,     0,     0,    46,    88,    43,     0,
+      45,     9,    47
 };
 
 /* YYDEFGOTO[NTERM-NUM]. */
 static const short yydefgoto[] =
 {
-      -1,     5,     6,     7,     8,   219,    20,     9,    31,    93,
-      94,    95,   201,   202,   167,   209,   199,   251,   252,   210,
-     277,   253,   211,   212,   114,    85,    41,    42,    43,    44,
-      45,    46,    47,    48,    49,    50,   175,   176,    51,   229,
-     264,    52,    14,    55,    56,    57,   248,    86,   162,    87,
-      88,    89,    90,   214,   215,   125,    98
+      -1,     5,     6,     7,     8,   221,    20,     9,    31,    93,
+      94,    95,   203,   204,   168,   211,   201,   253,   254,   212,
+     279,   255,   213,   214,   115,    85,    41,    42,    43,    44,
+      45,    46,    47,    48,    49,    50,   176,   177,    51,   231,
+     266,    52,    14,    55,    56,    57,   250,    86,   163,    87,
+      88,    89,    90,   216,   217,   126,    98
 };
 
 /* YYPACT[STATE-NUM] -- Index in YYTABLE of the portion describing
    STATE-NUM.  */
-#define YYPACT_NINF -159
+#define YYPACT_NINF -161
 static const short yypact[] =
 {
-     214,    15,   -34,   -18,    -5,    95,  -159,  -159,  -159,  -159,
-     127,    94,  -159,  -159,  -159,  -159,  -159,    89,    89,    89,
-     251,    98,  -159,  -159,  -159,  -159,   310,     9,   331,  -159,
-    -159,   129,    -9,    50,    92,  -159,   112,   115,  -159,   126,
-    -159,  -159,    31,   175,  -159,   229,     6,  -159,   151,  -159,
-    -159,  -159,  -159,   122,  -159,    44,   206,   133,  -159,  -159,
-    -159,  -159,  -159,  -159,  -159,  -159,  -159,  -159,  -159,  -159,
-    -159,  -159,  -159,  -159,  -159,  -159,  -159,  -159,  -159,  -159,
-    -159,  -159,  -159,  -159,  -159,   400,   -23,  -159,  -159,  -159,
-    -159,   103,  -159,  -159,  -159,  -159,  -159,  -159,   153,  -159,
-    -159,  -159,   146,  -159,  -159,    18,  -159,    93,  -159,  -159,
-    -159,  -159,  -159,  -159,   207,    89,   151,  -159,  -159,  -159,
-    -159,    89,  -159,  -159,  -159,  -159,    89,   157,  -159,   208,
-    -159,  -159,  -159,    89,    89,    89,    89,    89,    89,    89,
-      89,    89,    89,    89,    89,    89,    89,    89,    89,    89,
-      89,    89,    89,    89,    89,    89,   253,    89,  -159,  -159,
-    -159,  -159,   371,   130,   102,    16,   251,   120,   251,   220,
-    -159,   310,    92,   126,   165,    42,  -159,  -159,   310,    89,
-      89,  -159,    89,    89,  -159,  -159,  -159,  -159,    89,   331,
-    -159,    68,    89,    89,  -159,  -159,  -159,  -159,  -159,  -159,
-    -159,  -159,    77,   134,   193,  -159,   202,   226,   237,  -159,
-    -159,  -159,  -159,  -159,  -159,  -159,  -159,  -159,   187,    89,
-    -159,  -159,  -159,  -159,  -159,  -159,  -159,  -159,  -159,  -159,
-     303,    89,    89,   118,  -159,   145,    89,  -159,  -159,   144,
-     145,   148,   197,  -159,   251,  -159,   105,  -159,  -159,    89,
-    -159,   198,    33,  -159,    90,  -159,  -159,    38,  -159,  -159,
-    -159,  -159,  -159,  -159,  -159,    89,    89,  -159,  -159,  -159,
-    -159,  -159,    -3,   145,    89,  -159,  -159,   200,  -159,  -159,
-      89
+     201,    17,   -28,   -22,   -12,    45,  -161,  -161,  -161,  -161,
+      76,    99,  -161,  -161,  -161,  -161,  -161,    48,    48,    48,
+     144,    54,  -161,  -161,  -161,  -161,   228,    15,   310,  -161,
+    -161,    80,   122,    34,    70,  -161,   116,    94,  -161,    96,
+    -161,  -161,    35,   163,  -161,   239,    88,  -161,   154,  -161,
+    -161,  -161,  -161,   230,  -161,    95,   211,   103,  -161,  -161,
+    -161,  -161,  -161,  -161,  -161,  -161,  -161,  -161,  -161,  -161,
+    -161,  -161,  -161,  -161,  -161,  -161,  -161,  -161,  -161,  -161,
+    -161,  -161,  -161,  -161,  -161,   380,   -32,  -161,  -161,  -161,
+    -161,   114,  -161,  -161,  -161,  -161,  -161,  -161,   125,  -161,
+    -161,  -161,   111,  -161,  -161,   195,  -161,    46,  -161,  -161,
+    -161,  -161,  -161,  -161,  -161,   312,    48,   154,  -161,  -161,
+    -161,  -161,    48,  -161,  -161,  -161,  -161,    48,   256,  -161,
+     267,  -161,  -161,  -161,    48,    48,    48,    48,    48,    48,
+      48,    48,    48,    48,    48,    48,    48,    48,    48,    48,
+      48,    48,    48,    48,    48,    48,    48,   255,    48,  -161,
+    -161,  -161,  -161,   350,   132,     6,    39,   144,   121,   144,
+     280,  -161,   228,    70,    96,   133,    25,  -161,  -161,   228,
+      48,    48,    48,  -161,    48,    48,  -161,  -161,  -161,  -161,
+      48,   310,  -161,    90,    48,    48,  -161,  -161,  -161,  -161,
+    -161,  -161,  -161,  -161,    -2,   105,   149,  -161,   158,   181,
+     186,  -161,  -161,  -161,  -161,  -161,  -161,  -161,  -161,  -161,
+     135,    48,  -161,  -161,  -161,  -161,  -161,  -161,  -161,  -161,
+    -161,  -161,   261,    48,    48,   169,  -161,    97,    48,  -161,
+    -161,   150,    97,   196,   207,  -161,   144,  -161,   142,  -161,
+    -161,    48,  -161,   151,    40,  -161,    44,  -161,  -161,    41,
+    -161,  -161,  -161,  -161,  -161,  -161,  -161,    48,    48,  -161,
+    -161,  -161,  -161,  -161,    -3,    97,    48,  -161,  -161,   177,
+    -161,  -161,    48
 };
 
 /* YYPGOTO[NTERM-NUM].  */
 static const short yypgoto[] =
 {
-    -159,  -159,  -159,  -159,  -159,    -1,   -91,  -159,  -159,    86,
-    -159,  -159,  -159,  -159,  -159,  -159,    60,  -159,    27,  -159,
-    -159,    -4,  -159,  -159,  -159,  -159,  -158,  -159,    96,   -87,
-    -159,   168,   230,   232,   -33,  -159,  -159,   101,  -159,  -159,
-    -159,  -159,   238,  -159,   224,  -159,  -159,  -148,  -159,   119,
-     221,  -159,  -159,  -159,  -159,    -7,  -159
+    -161,  -161,  -161,  -161,  -161,    -1,   -91,  -161,  -161,    57,
+    -161,  -161,  -161,  -161,  -161,  -161,    12,  -161,    -9,  -161,
+    -161,   -36,  -161,  -161,  -161,  -161,  -160,  -161,    71,   -89,
+    -161,   152,   215,   224,   -35,  -161,  -161,   131,  -161,  -161,
+    -161,  -161,   229,  -161,   278,  -161,  -161,  -142,  -161,   148,
+     249,  -161,  -161,  -161,  -161,    -7,  -161
 };
 
 /* YYTABLE[YYPACT[STATE-NUM]].  What to do in state STATE-NUM.  If
    positive, shift that token.  If negative, reduce the rule which
    number is the opposite.  If zero, do what YYDEFACT says.
    If YYTABLE_NINF, syntax error.  */
-#define YYTABLE_NINF -113
+#define YYTABLE_NINF -114
 static const short yytable[] =
 {
-      11,    24,   166,    23,   168,    17,    18,    19,   191,   213,
-      53,    26,    27,    24,    28,   122,    10,    12,   117,    -9,
-      24,    54,    24,   118,    33,    97,    -9,   181,   200,   159,
-     172,   160,   108,    13,   268,   173,    40,   105,   161,   268,
-     107,   233,    21,    96,   115,   127,    15,   121,   222,   223,
-     224,   225,   226,   126,    24,   275,    54,   133,   134,   135,
-     136,   137,   138,   139,   140,   141,   142,   143,   144,   145,
-     146,   147,   148,   149,   150,   151,   152,   153,   154,   155,
-     156,   157,    13,   122,   218,   109,   -41,   269,   197,   271,
-     164,   165,   269,    24,    24,    16,   128,    24,    24,    32,
-     227,   228,   171,    99,   163,    25,    24,    -9,   178,    24,
-     100,   179,   180,   197,    -9,   182,   262,   263,   244,   279,
-      -2,   203,   160,   183,   101,   198,   102,   104,   234,   161,
-     188,   189,    34,    35,    36,    37,    38,    39,    40,    91,
-     204,   205,   206,   270,   106,   177,   247,   132,    91,    24,
-     198,    -9,   120,    92,   169,    -9,   196,   250,   170,   192,
-     193,   103,   217,    -9,    35,    36,    37,    38,    -9,    -9,
-    -112,  -112,   160,    21,   123,   124,   111,   220,    21,   161,
-      22,    21,   207,   195,   231,    21,   232,   -55,   -55,   -55,
-     -55,   -55,   -55,   -55,   239,    21,   238,   255,   235,    21,
-     236,   258,    -9,   241,   240,    -9,    -9,    -9,    21,   184,
-     185,    -9,    34,    35,    36,    37,    38,    39,    40,    34,
-      35,    36,    37,    38,    39,    40,   -59,   242,   246,   -59,
-     112,   113,   256,   249,   259,   261,   254,     1,   243,     2,
-       3,     4,    35,    36,    37,    38,   265,   245,    21,   266,
-     260,   267,   278,   208,   190,    29,    30,    24,   130,   131,
-     186,   187,   237,   272,    58,    59,    60,   257,   273,   276,
-     274,    21,   216,   174,   230,   221,   119,   116,   280,   129,
-     110,   194,    61,    62,    63,    64,    65,    66,    67,    68,
-      69,    70,    71,    72,    73,    74,    75,    76,    77,    78,
-      79,    80,    81,    82,   111,     0,   158,     0,    83,     0,
-      84,     0,     0,     0,    24,   -55,   -55,   -55,   -55,   -55,
-     -55,   -55,    34,    35,    36,    37,    38,    39,    40,     0,
-       0,     0,     0,     0,     0,    24,     0,     0,     0,     0,
-       0,     0,    58,    59,    60,     0,     0,     0,     0,     0,
-       0,     0,     0,     0,   -60,     0,     0,   -60,   112,   113,
-      61,    62,    63,    64,    65,    66,    67,    68,    69,    70,
-      71,    72,    73,    74,    75,    76,    77,    78,    79,    80,
-      81,    82,    58,    59,    60,     0,    83,     0,    84,     0,
-       0,     0,     0,     0,     0,     0,     0,     0,     0,     0,
-      61,    62,    63,    64,    65,    66,    67,    68,    69,    70,
-      71,    72,    73,    74,    75,    76,    77,    78,    79,    80,
-      81,    82,     0,     0,     0,     0,    83,     0,    84,    61,
+      11,    24,   167,    23,   169,    17,    18,    19,   215,   199,
+      24,    26,    27,   123,    28,   193,    53,   199,    10,    24,
+     160,    -9,   161,    12,    33,    97,   183,    54,    -9,    13,
+     162,   224,   225,   226,   227,   228,   108,   105,    24,    15,
+     107,   270,   270,    24,   116,    16,   200,   122,    24,   235,
+      24,   202,    24,   127,   200,    32,   277,   134,   135,   136,
+     137,   138,   139,   140,   141,   142,   143,   144,   145,   146,
+     147,   148,   149,   150,   151,   152,   153,   154,   155,   156,
+     157,   158,   123,   220,   229,   230,    13,    99,   100,   109,
+     165,   166,   273,   -41,   271,   271,   128,   272,   178,    91,
+     118,    24,   172,    24,    92,   119,   104,    54,   179,   252,
+      25,   180,   181,   182,   106,   164,   184,   133,    -9,   281,
+     246,    -2,   205,   171,   185,    -9,   170,    21,   101,    22,
+     102,   190,   191,    34,    35,    36,    37,    38,    39,    40,
+      91,   206,   207,   208,   161,   222,    24,   129,    29,    30,
+     241,   236,   162,   264,   265,   121,    21,   198,    -9,   243,
+     194,   195,    -9,   219,   111,   103,    -9,    35,    36,    37,
+      38,    -9,    -9,    21,    96,   -56,   -56,   -56,   -56,   -56,
+     -56,   -56,   244,    21,   209,   197,   233,   245,   234,    34,
+      35,    36,    37,    38,    39,    40,   247,   249,   240,    24,
+     237,    21,   238,   257,   269,    -9,   242,   173,    -9,    -9,
+      -9,    -9,   174,    40,   -60,    -9,   239,   -60,   112,   113,
+     114,  -113,  -113,   161,     1,   210,     2,     3,     4,   280,
+     248,   162,    24,   259,   258,   251,   261,   263,   256,   278,
+      34,    35,    36,    37,    38,    39,    40,    21,   267,   260,
+     232,   268,    35,    36,    37,    38,   192,   175,    21,    24,
+     262,   120,   111,   131,   132,   274,    58,    59,    60,   117,
+     275,   110,   276,   -56,   -56,   -56,   -56,   -56,   -56,   -56,
+     282,    21,   124,   125,    61,    62,    63,    64,    65,    66,
+      67,    68,    69,    70,    71,    72,    73,    74,    75,    76,
+      77,    78,    79,    80,    81,    82,   223,    21,   186,   187,
+      83,   196,   -61,    84,    24,   -61,   112,   113,   114,   188,
+     189,    58,    59,    60,    34,    35,    36,    37,    38,    39,
+      40,    21,   218,   130,   159,     0,     0,     0,     0,    61,
+      62,    63,    64,    65,    66,    67,    68,    69,    70,    71,
+      72,    73,    74,    75,    76,    77,    78,    79,    80,    81,
+      82,    58,    59,    60,     0,    83,     0,     0,    84,     0,
+       0,     0,     0,     0,     0,     0,     0,     0,     0,    61,
+      62,    63,    64,    65,    66,    67,    68,    69,    70,    71,
+      72,    73,    74,    75,    76,    77,    78,    79,    80,    81,
+      82,     0,     0,     0,     0,    83,     0,     0,    84,    61,
       62,    63,    64,    65,    66,    67,    68,    69,    70,    71,
       72,    73,    74,    75,    76,     0,    78,    79
 };
 
 static const short yycheck[] =
 {
-       1,     4,    93,    10,    95,     6,     7,     8,   156,   167,
-       1,    12,    13,     4,    15,    48,     1,    51,    12,     4,
-       4,    12,     4,    17,    25,    32,    11,   114,    12,    52,
-      12,    54,     1,    51,     1,    17,    18,    38,    61,     1,
-      41,   189,    51,    52,    45,     1,    51,    48,     6,     7,
-       8,     9,    10,    54,     4,    58,    12,    58,    59,    60,
+       1,     4,    93,    10,    95,     6,     7,     8,   168,    11,
+       4,    12,    13,    48,    15,   157,     1,    11,     1,     4,
+      52,     4,    54,    51,    25,    32,   115,    12,    11,    51,
+      62,     6,     7,     8,     9,    10,     1,    38,     4,    51,
+      41,     1,     1,     4,    45,     0,    48,    48,     4,   191,
+       4,    12,     4,    54,    48,     1,    59,    58,    59,    60,
       61,    62,    63,    64,    65,    66,    67,    68,    69,    70,
       71,    72,    73,    74,    75,    76,    77,    78,    79,    80,
-      81,    82,    51,   116,   171,    54,    53,    54,    11,    51,
-      91,    92,    54,     4,     4,     0,    52,     4,     4,     1,
-      58,    59,   103,    53,     1,    11,     4,     4,   109,     4,
-      18,   112,   113,    11,    11,   116,    11,    12,   209,   277,
-       0,     1,    54,   124,    12,    48,    14,    12,    60,    61,
-     131,   132,    12,    13,    14,    15,    16,    17,    18,    19,
-      20,    21,    22,    53,    18,    52,    28,    14,    19,     4,
-      48,    48,     1,    24,     1,     4,   163,    12,    12,   160,
-     161,    49,   169,    12,    13,    14,    15,    16,    17,    18,
-      52,    53,    54,    51,    52,    53,     1,    12,    51,    61,
-      53,    51,    62,    53,   185,    51,   187,    12,    13,    14,
-      15,    16,    17,    18,     1,    51,   203,    53,   199,    51,
-     201,    53,    51,     1,   205,    54,    55,    56,    51,    52,
-      53,    60,    12,    13,    14,    15,    16,    17,    18,    12,
-      13,    14,    15,    16,    17,    18,    51,     1,   229,    54,
-      55,    56,   239,   234,   241,   242,   237,    23,     1,    25,
-      26,    27,    13,    14,    15,    16,   247,    60,    51,   250,
-      53,    53,    52,   167,     1,     4,     5,     4,    52,    53,
-      52,    53,   202,   264,    11,    12,    13,   240,   269,   273,
-     271,    51,    52,   105,   178,   174,    46,    45,   279,    55,
-      42,   162,    29,    30,    31,    32,    33,    34,    35,    36,
-      37,    38,    39,    40,    41,    42,    43,    44,    45,    46,
-      47,    48,    49,    50,     1,    -1,    85,    -1,    55,    -1,
-      57,    -1,    -1,    -1,     4,    12,    13,    14,    15,    16,
-      17,    18,    12,    13,    14,    15,    16,    17,    18,    -1,
-      -1,    -1,    -1,    -1,    -1,     4,    -1,    -1,    -1,    -1,
-      -1,    -1,    11,    12,    13,    -1,    -1,    -1,    -1,    -1,
-      -1,    -1,    -1,    -1,    51,    -1,    -1,    54,    55,    56,
-      29,    30,    31,    32,    33,    34,    35,    36,    37,    38,
-      39,    40,    41,    42,    43,    44,    45,    46,    47,    48,
-      49,    50,    11,    12,    13,    -1,    55,    -1,    57,    -1,
-      -1,    -1,    -1,    -1,    -1,    -1,    -1,    -1,    -1,    -1,
-      29,    30,    31,    32,    33,    34,    35,    36,    37,    38,
-      39,    40,    41,    42,    43,    44,    45,    46,    47,    48,
-      49,    50,    -1,    -1,    -1,    -1,    55,    -1,    57,    29,
+      81,    82,   117,   172,    59,    60,    51,    53,    18,    54,
+      91,    92,    51,    53,    54,    54,     1,    53,    52,    19,
+      12,     4,   103,     4,    24,    17,    12,    12,   109,    12,
+      11,   112,   113,   114,    18,     1,   117,    14,     4,   279,
+     211,     0,     1,    12,   125,    11,     1,    51,    12,    53,
+      14,   132,   133,    12,    13,    14,    15,    16,    17,    18,
+      19,    20,    21,    22,    54,    12,     4,    52,     4,     5,
+       1,    61,    62,    11,    12,     1,    51,   164,     4,     1,
+     161,   162,    48,   170,     1,    49,    12,    13,    14,    15,
+      16,    17,    18,    51,    52,    12,    13,    14,    15,    16,
+      17,    18,     1,    51,    63,    53,   187,     1,   189,    12,
+      13,    14,    15,    16,    17,    18,    61,    28,   205,     4,
+     201,    51,   203,    53,    53,    51,   207,    12,    54,    55,
+      56,    57,    17,    18,    51,    61,   204,    54,    55,    56,
+      57,    52,    53,    54,    23,   168,    25,    26,    27,    52,
+     231,    62,     4,   242,   241,   236,   243,   244,   239,   275,
+      12,    13,    14,    15,    16,    17,    18,    51,   249,    53,
+     179,   252,    13,    14,    15,    16,     1,   105,    51,     4,
+      53,    46,     1,    52,    53,   266,    11,    12,    13,    45,
+     271,    42,   273,    12,    13,    14,    15,    16,    17,    18,
+     281,    51,    52,    53,    29,    30,    31,    32,    33,    34,
+      35,    36,    37,    38,    39,    40,    41,    42,    43,    44,
+      45,    46,    47,    48,    49,    50,   175,    51,    52,    53,
+      55,   163,    51,    58,     4,    54,    55,    56,    57,    52,
+      53,    11,    12,    13,    12,    13,    14,    15,    16,    17,
+      18,    51,    52,    55,    85,    -1,    -1,    -1,    -1,    29,
+      30,    31,    32,    33,    34,    35,    36,    37,    38,    39,
+      40,    41,    42,    43,    44,    45,    46,    47,    48,    49,
+      50,    11,    12,    13,    -1,    55,    -1,    -1,    58,    -1,
+      -1,    -1,    -1,    -1,    -1,    -1,    -1,    -1,    -1,    29,
+      30,    31,    32,    33,    34,    35,    36,    37,    38,    39,
+      40,    41,    42,    43,    44,    45,    46,    47,    48,    49,
+      50,    -1,    -1,    -1,    -1,    55,    -1,    -1,    58,    29,
       30,    31,    32,    33,    34,    35,    36,    37,    38,    39,
       40,    41,    42,    43,    44,    -1,    46,    47
 };
@@ -845,35 +843,35 @@
    symbol of state STATE-NUM.  */
 static const unsigned char yystos[] =
 {
-       0,    23,    25,    26,    27,    64,    65,    66,    67,    70,
-       1,    68,    51,    51,   105,    51,     0,    68,    68,    68,
-      69,    51,    53,   118,     4,    11,    68,    68,    68,     4,
-       5,    71,     1,    68,    12,    13,    14,    15,    16,    17,
-      18,    89,    90,    91,    92,    93,    94,    95,    96,    97,
-      98,   101,   104,     1,    12,   106,   107,   108,    11,    12,
+       0,    23,    25,    26,    27,    65,    66,    67,    68,    71,
+       1,    69,    51,    51,   106,    51,     0,    69,    69,    69,
+      70,    51,    53,   119,     4,    11,    69,    69,    69,     4,
+       5,    72,     1,    69,    12,    13,    14,    15,    16,    17,
+      18,    90,    91,    92,    93,    94,    95,    96,    97,    98,
+      99,   102,   105,     1,    12,   107,   108,   109,    11,    12,
       13,    29,    30,    31,    32,    33,    34,    35,    36,    37,
       38,    39,    40,    41,    42,    43,    44,    45,    46,    47,
-      48,    49,    50,    55,    57,    88,   110,   112,   113,   114,
-     115,    19,    24,    72,    73,    74,    52,   118,   119,    53,
-      18,    12,    14,    49,    12,    68,    18,    68,     1,    54,
-     105,     1,    55,    56,    87,    68,    96,    12,    17,    95,
-       1,    68,    97,    52,    53,   118,    68,     1,    52,   107,
-      52,    53,    14,    68,    68,    68,    68,    68,    68,    68,
-      68,    68,    68,    68,    68,    68,    68,    68,    68,    68,
-      68,    68,    68,    68,    68,    68,    68,    68,   113,    52,
-      54,    61,   111,     1,    68,    68,    69,    77,    69,     1,
-      12,    68,    12,    17,    94,    99,   100,    52,    68,    68,
-      68,    92,    68,    68,    52,    53,    52,    53,    68,    68,
-       1,   110,    68,    68,   112,    53,   118,    11,    48,    79,
-      12,    75,    76,     1,    20,    21,    22,    62,    72,    78,
-      82,    85,    86,    89,   116,   117,    52,   118,    92,    68,
-      12,   100,     6,     7,     8,     9,    10,    58,    59,   102,
-      91,    68,    68,   110,    60,    68,    68,    79,   118,     1,
-      68,     1,     1,     1,    69,    60,    68,    28,   109,    68,
-      12,    80,    81,    84,    68,    53,   118,    81,    53,   118,
-      53,   118,    11,    12,   103,    68,    68,    53,     1,    54,
-      53,    51,    68,    68,    68,    58,    84,    83,    52,    89,
-      68
+      48,    49,    50,    55,    58,    89,   111,   113,   114,   115,
+     116,    19,    24,    73,    74,    75,    52,   119,   120,    53,
+      18,    12,    14,    49,    12,    69,    18,    69,     1,    54,
+     106,     1,    55,    56,    57,    88,    69,    97,    12,    17,
+      96,     1,    69,    98,    52,    53,   119,    69,     1,    52,
+     108,    52,    53,    14,    69,    69,    69,    69,    69,    69,
+      69,    69,    69,    69,    69,    69,    69,    69,    69,    69,
+      69,    69,    69,    69,    69,    69,    69,    69,    69,   114,
+      52,    54,    62,   112,     1,    69,    69,    70,    78,    70,
+       1,    12,    69,    12,    17,    95,   100,   101,    52,    69,
+      69,    69,    69,    93,    69,    69,    52,    53,    52,    53,
+      69,    69,     1,   111,    69,    69,   113,    53,   119,    11,
+      48,    80,    12,    76,    77,     1,    20,    21,    22,    63,
+      73,    79,    83,    86,    87,    90,   117,   118,    52,   119,
+      93,    69,    12,   101,     6,     7,     8,     9,    10,    59,
+      60,   103,    92,    69,    69,   111,    61,    69,    69,    80,
+     119,     1,    69,     1,     1,     1,    70,    61,    69,    28,
+     110,    69,    12,    81,    82,    85,    69,    53,   119,    82,
+      53,   119,    53,   119,    11,    12,   104,    69,    69,    53,
+       1,    54,    53,    51,    69,    69,    69,    59,    85,    84,
+      52,    90,    69
 };
 
 #if ! defined (YYSIZE_T) && defined (__SIZE_TYPE__)
@@ -1156,62 +1154,62 @@
 
   switch (yytype)
     {
-      case 80: /* maybe_media_list */
+      case 81: /* maybe_media_list */
 
         (null);
 
         break;
-      case 81: /* media_list */
+      case 82: /* media_list */
 
         (null);
 
         break;
-      case 83: /* ruleset_list */
+      case 84: /* ruleset_list */
 
         (null);
 
         break;
-      case 90: /* selector_list */
+      case 91: /* selector_list */
 
         (null);
 
         break;
-      case 91: /* selector */
+      case 92: /* selector */
 
         (null);
 
         break;
-      case 92: /* simple_selector */
+      case 93: /* simple_selector */
 
         (null);
 
         break;
-      case 96: /* specifier_list */
+      case 97: /* specifier_list */
 
         (null);
 
         break;
-      case 97: /* specifier */
+      case 98: /* specifier */
 
         (null);
 
         break;
-      case 98: /* class */
+      case 99: /* class */
 
         (null);
 
         break;
-      case 101: /* attrib */
+      case 102: /* attrib */
 
         (null);
 
         break;
-      case 104: /* pseudo */
+      case 105: /* pseudo */
 
         (null);
 
         break;
-      case 110: /* expr */
+      case 111: /* expr */
 
         (null);
 
@@ -1242,62 +1240,62 @@
 
   switch (yytype)
     {
-      case 80: /* maybe_media_list */
+      case 81: /* maybe_media_list */
 
         { delete yyvaluep->mediaList; yyvaluep->mediaList = 0; };
 
         break;
-      case 81: /* media_list */
+      case 82: /* media_list */
 
         { delete yyvaluep->mediaList; yyvaluep->mediaList = 0; };
 
         break;
-      case 83: /* ruleset_list */
+      case 84: /* ruleset_list */
 
         { delete yyvaluep->ruleList; yyvaluep->ruleList = 0; };
 
         break;
-      case 90: /* selector_list */
+      case 91: /* selector_list */
 
         { delete yyvaluep->selectorList; yyvaluep->selectorList = 0; };
 
         break;
-      case 91: /* selector */
+      case 92: /* selector */
 
         { delete yyvaluep->selector; yyvaluep->selector = 0; };
 
         break;
-      case 92: /* simple_selector */
+      case 93: /* simple_selector */
 
         { delete yyvaluep->selector; yyvaluep->selector = 0; };
 
         break;
-      case 96: /* specifier_list */
+      case 97: /* specifier_list */
 
         { delete yyvaluep->selector; yyvaluep->selector = 0; };
 
         break;
-      case 97: /* specifier */
+      case 98: /* specifier */
 
         { delete yyvaluep->selector; yyvaluep->selector = 0; };
 
         break;
-      case 98: /* class */
+      case 99: /* class */
 
         { delete yyvaluep->selector; yyvaluep->selector = 0; };
 
         break;
-      case 101: /* attrib */
+      case 102: /* attrib */
 
         { delete yyvaluep->selector; yyvaluep->selector = 0; };
 
         break;
-      case 104: /* pseudo */
+      case 105: /* pseudo */
 
         { delete yyvaluep->selector; yyvaluep->selector = 0; };
 
         break;
-      case 110: /* expr */
+      case 111: /* expr */
 
         { delete yyvaluep->valueList; yyvaluep->valueList = 0; };
 
@@ -1819,26 +1817,31 @@
 
   case 54:
 
-    { yyval.relation = CSSSelector::Child; ;}
+    { yyval.relation = CSSSelector::Cousin; ;}
     break;
 
   case 55:
 
-    { yyval.relation = CSSSelector::Descendant; ;}
+    { yyval.relation = CSSSelector::Child; ;}
     break;
 
   case 56:
 
-    { yyval.val = -1; ;}
+    { yyval.relation = CSSSelector::Descendant; ;}
     break;
 
   case 57:
 
-    { yyval.val = 1; ;}
+    { yyval.val = -1; ;}
     break;
 
   case 58:
 
+    { yyval.val = 1; ;}
+    break;
+
+  case 59:
+
     {
 #ifdef CSS_DEBUG
 	kdDebug( 6080 ) << "got ruleset" << endl << "  selector:" << endl;
@@ -1858,7 +1861,7 @@
     ;}
     break;
 
-  case 59:
+  case 60:
 
     {
 	if ( yyvsp[0].selector ) {
@@ -1875,7 +1878,7 @@
     ;}
     break;
 
-  case 60:
+  case 61:
 
     {
 	if ( yyvsp[-3].selectorList && yyvsp[0].selector ) {
@@ -1893,7 +1896,7 @@
     ;}
     break;
 
-  case 61:
+  case 62:
 
     {
 	delete yyvsp[-1].selectorList;
@@ -1901,14 +1904,14 @@
     ;}
     break;
 
-  case 62:
+  case 63:
 
     {
 	yyval.selector = yyvsp[0].selector;
     ;}
     break;
 
-  case 63:
+  case 64:
 
     {
 	if ( !yyvsp[-2].selector || !yyvsp[0].selector ) {
@@ -1933,7 +1936,7 @@
     ;}
     break;
 
-  case 64:
+  case 65:
 
     {
 	delete yyvsp[-1].selector;
@@ -1941,7 +1944,7 @@
     ;}
     break;
 
-  case 65:
+  case 66:
 
     {
 	yyval.selector = new CSSSelector();
@@ -1949,7 +1952,7 @@
     ;}
     break;
 
-  case 66:
+  case 67:
 
     {
 	yyval.selector = yyvsp[-1].selector;
@@ -1958,7 +1961,7 @@
     ;}
     break;
 
-  case 67:
+  case 68:
 
     {
 	yyval.selector = yyvsp[-1].selector;
@@ -1967,12 +1970,12 @@
     ;}
     break;
 
-  case 68:
+  case 69:
 
     { yyval.element = (yyvsp[-1].ns<<16) | yyvsp[0].element; ;}
     break;
 
-  case 69:
+  case 70:
 
     {
         /* according to the specs this one matches all namespaces if no
@@ -1982,22 +1985,22 @@
     ;}
     break;
 
-  case 70:
+  case 71:
 
     { yyval.ns = 0; ;}
     break;
 
-  case 71:
+  case 72:
 
     { yyval.ns = 1; /* #### insert correct namespace id here */ ;}
     break;
 
-  case 72:
+  case 73:
 
     { yyval.ns = 0xffff; ;}
     break;
 
-  case 73:
+  case 74:
 
     {
 	CSSParser *p = static_cast<CSSParser *>(parser);
@@ -2021,12 +2024,12 @@
     ;}
     break;
 
-  case 74:
+  case 75:
 
     { yyval.element = 0xffff; ;}
     break;
 
-  case 75:
+  case 76:
 
     {
 	yyval.selector = yyvsp[0].selector;
@@ -2034,7 +2037,7 @@
     ;}
     break;
 
-  case 76:
+  case 77:
 
     {
 	yyval.selector = yyvsp[-1].selector;
@@ -2048,7 +2051,7 @@
     ;}
     break;
 
-  case 77:
+  case 78:
 
     {
 	delete yyvsp[-1].selector;
@@ -2056,7 +2059,7 @@
     ;}
     break;
 
-  case 78:
+  case 79:
 
     {
 	yyval.selector = new CSSSelector();
@@ -2066,7 +2069,7 @@
     ;}
     break;
 
-  case 82:
+  case 83:
 
     {
 	yyval.selector = new CSSSelector();
@@ -2076,12 +2079,12 @@
     ;}
     break;
 
-  case 83:
+  case 84:
 
     { yyval.attribute = (yyvsp[-1].ns<<16) | yyvsp[0].attribute; ;}
     break;
 
-  case 84:
+  case 85:
 
     {
 	/* opposed to elements, these only match for non namespaced attributes */
@@ -2089,7 +2092,7 @@
     ;}
     break;
 
-  case 85:
+  case 86:
 
     {
 	CSSParser *p = static_cast<CSSParser *>(parser);
@@ -2114,7 +2117,7 @@
     ;}
     break;
 
-  case 86:
+  case 87:
 
     {
 	yyval.selector = new CSSSelector();
@@ -2123,59 +2126,59 @@
     ;}
     break;
 
-  case 87:
+  case 88:
 
     {
 	yyval.selector = new CSSSelector();
 	yyval.selector->attr = yyvsp[-5].attribute;
-	yyval.selector->match = (CSSSelector::Match)yyvsp[-4].val;
+	yyval.selector->match = yyvsp[-4].match;
 	yyval.selector->value = domString(yyvsp[-2].string);
     ;}
     break;
 
-  case 88:
-
-    {
-	yyval.val = CSSSelector::Exact;
-    ;}
-    break;
-
   case 89:
 
     {
-	yyval.val = CSSSelector::List;
+	yyval.match = CSSSelector::Exact;
     ;}
     break;
 
   case 90:
 
     {
-	yyval.val = CSSSelector::Hyphen;
+	yyval.match = CSSSelector::List;
     ;}
     break;
 
   case 91:
 
     {
-	yyval.val = CSSSelector::Begin;
+	yyval.match = CSSSelector::Hyphen;
     ;}
     break;
 
   case 92:
 
     {
-	yyval.val = CSSSelector::End;
+	yyval.match = CSSSelector::Begin;
     ;}
     break;
 
   case 93:
 
     {
-	yyval.val = CSSSelector::Contain;
+	yyval.match = CSSSelector::End;
+    ;}
+    break;
+
+  case 94:
+
+    {
+	yyval.match = CSSSelector::Contain;
     ;}
     break;
 
-  case 96:
+  case 97:
 
     {
 	yyval.selector = new CSSSelector();
@@ -2184,7 +2187,7 @@
     ;}
     break;
 
-  case 97:
+  case 98:
 
     {
 	yyval.selector = new CSSSelector();
@@ -2193,7 +2196,7 @@
     ;}
     break;
 
-  case 98:
+  case 99:
 
     {
         yyval.selector = new CSSSelector();
@@ -2203,28 +2206,28 @@
     ;}
     break;
 
-  case 99:
+  case 100:
 
     {
 	yyval.ok = yyvsp[-1].ok;
     ;}
     break;
 
-  case 100:
+  case 101:
 
     {
 	yyval.ok = false;
     ;}
     break;
 
-  case 101:
+  case 102:
 
     {
 	yyval.ok = yyvsp[-1].ok;
     ;}
     break;
 
-  case 102:
+  case 103:
 
     {
 	yyval.ok = yyvsp[-2].ok;
@@ -2233,28 +2236,28 @@
     ;}
     break;
 
-  case 103:
+  case 104:
 
     {
 	yyval.ok = yyvsp[-2].ok;
     ;}
     break;
 
-  case 104:
+  case 105:
 
     {
 	yyval.ok = yyvsp[-2].ok;
     ;}
     break;
 
-  case 105:
+  case 106:
 
     {
         yyval.ok = false;
     ;}
     break;
 
-  case 106:
+  case 107:
 
     {
 	yyval.ok = yyvsp[-3].ok;
@@ -2263,14 +2266,14 @@
     ;}
     break;
 
-  case 107:
+  case 108:
 
     {
         yyval.ok = yyvsp[-3].ok;
     ;}
     break;
 
-  case 108:
+  case 109:
 
     {
 	yyval.ok = false;
@@ -2296,14 +2299,14 @@
     ;}
     break;
 
-  case 109:
+  case 110:
 
     {
         yyval.ok = false;
     ;}
     break;
 
-  case 110:
+  case 111:
 
     {
 	QString str = qString(yyvsp[-1].string);
@@ -2311,17 +2314,17 @@
     ;}
     break;
 
-  case 111:
+  case 112:
 
     { yyval.b = true; ;}
     break;
 
-  case 112:
+  case 113:
 
     { yyval.b = false; ;}
     break;
 
-  case 113:
+  case 114:
 
     {
 	yyval.valueList = new ValueList;
@@ -2329,7 +2332,7 @@
     ;}
     break;
 
-  case 114:
+  case 115:
 
     {
 	yyval.valueList = yyvsp[-2].valueList;
@@ -2346,48 +2349,48 @@
     ;}
     break;
 
-  case 115:
+  case 116:
 
     {
 	yyval.tok = '/';
     ;}
     break;
 
-  case 116:
+  case 117:
 
     {
 	yyval.tok = ',';
     ;}
     break;
 
-  case 117:
+  case 118:
 
     {
         yyval.tok = 0;
   ;}
     break;
 
-  case 118:
+  case 119:
 
     { yyval.value = yyvsp[0].value; ;}
     break;
 
-  case 119:
+  case 120:
 
     { yyval.value = yyvsp[0].value; yyval.value.fValue *= yyvsp[-1].val; ;}
     break;
 
-  case 120:
+  case 121:
 
     { yyval.value.id = 0; yyval.value.string = yyvsp[-1].string; yyval.value.unit = CSSPrimitiveValue::CSS_DIMENSION; ;}
     break;
 
-  case 121:
+  case 122:
 
     { yyval.value.id = 0; yyval.value.string = yyvsp[-1].string; yyval.value.unit = CSSPrimitiveValue::CSS_STRING; ;}
     break;
 
-  case 122:
+  case 123:
 
     {
       QString str = qString( yyvsp[-1].string );
@@ -2397,119 +2400,119 @@
   ;}
     break;
 
-  case 123:
+  case 124:
 
     { yyval.value.id = 0; yyval.value.string = yyvsp[-1].string; yyval.value.unit = CSSPrimitiveValue::CSS_URI; ;}
     break;
 
-  case 124:
+  case 125:
 
     { yyval.value.id = 0; yyval.value.iValue = 0; yyval.value.unit = CSSPrimitiveValue::CSS_UNKNOWN;/* ### */ ;}
     break;
 
-  case 125:
+  case 126:
 
     { yyval.value.id = 0; yyval.value.string = yyvsp[0].string; yyval.value.unit = CSSPrimitiveValue::CSS_RGBCOLOR; ;}
     break;
 
-  case 126:
+  case 127:
 
     {
       yyval.value = yyvsp[0].value;
   ;}
     break;
 
-  case 127:
+  case 128:
 
     { yyval.value.id = 0; yyval.value.fValue = yyvsp[-1].val; yyval.value.unit = CSSPrimitiveValue::CSS_NUMBER; ;}
     break;
 
-  case 128:
+  case 129:
 
     { yyval.value.id = 0; yyval.value.fValue = yyvsp[-1].val; yyval.value.unit = CSSPrimitiveValue::CSS_PERCENTAGE; ;}
     break;
 
-  case 129:
+  case 130:
 
     { yyval.value.id = 0; yyval.value.fValue = yyvsp[-1].val; yyval.value.unit = CSSPrimitiveValue::CSS_PX; ;}
     break;
 
-  case 130:
+  case 131:
 
     { yyval.value.id = 0; yyval.value.fValue = yyvsp[-1].val; yyval.value.unit = CSSPrimitiveValue::CSS_CM; ;}
     break;
 
-  case 131:
+  case 132:
 
     { yyval.value.id = 0; yyval.value.fValue = yyvsp[-1].val; yyval.value.unit = CSSPrimitiveValue::CSS_MM; ;}
     break;
 
-  case 132:
+  case 133:
 
     { yyval.value.id = 0; yyval.value.fValue = yyvsp[-1].val; yyval.value.unit = CSSPrimitiveValue::CSS_IN; ;}
     break;
 
-  case 133:
+  case 134:
 
     { yyval.value.id = 0; yyval.value.fValue = yyvsp[-1].val; yyval.value.unit = CSSPrimitiveValue::CSS_PT; ;}
     break;
 
-  case 134:
+  case 135:
 
     { yyval.value.id = 0; yyval.value.fValue = yyvsp[-1].val; yyval.value.unit = CSSPrimitiveValue::CSS_PC; ;}
     break;
 
-  case 135:
+  case 136:
 
     { yyval.value.id = 0; yyval.value.fValue = yyvsp[-1].val; yyval.value.unit = CSSPrimitiveValue::CSS_DEG; ;}
     break;
 
-  case 136:
+  case 137:
 
     { yyval.value.id = 0; yyval.value.fValue = yyvsp[-1].val; yyval.value.unit = CSSPrimitiveValue::CSS_RAD; ;}
     break;
 
-  case 137:
+  case 138:
 
     { yyval.value.id = 0; yyval.value.fValue = yyvsp[-1].val; yyval.value.unit = CSSPrimitiveValue::CSS_GRAD; ;}
     break;
 
-  case 138:
+  case 139:
 
     { yyval.value.id = 0; yyval.value.fValue = yyvsp[-1].val; yyval.value.unit = CSSPrimitiveValue::CSS_MS; ;}
     break;
 
-  case 139:
+  case 140:
 
     { yyval.value.id = 0; yyval.value.fValue = yyvsp[-1].val; yyval.value.unit = CSSPrimitiveValue::CSS_S; ;}
     break;
 
-  case 140:
+  case 141:
 
     { yyval.value.id = 0; yyval.value.fValue = yyvsp[-1].val; yyval.value.unit = CSSPrimitiveValue::CSS_HZ; ;}
     break;
 
-  case 141:
+  case 142:
 
     { yyval.value.id = 0; yyval.value.fValue = yyvsp[-1].val; yyval.value.unit = CSSPrimitiveValue::CSS_KHZ; ;}
     break;
 
-  case 142:
+  case 143:
 
     { yyval.value.id = 0; yyval.value.fValue = yyvsp[-1].val; yyval.value.unit = CSSPrimitiveValue::CSS_EMS; ;}
     break;
 
-  case 143:
+  case 144:
 
     { yyval.value.id = 0; yyval.value.fValue = yyvsp[-1].val; yyval.value.unit = Value::Q_EMS; ;}
     break;
 
-  case 144:
+  case 145:
 
     { yyval.value.id = 0; yyval.value.fValue = yyvsp[-1].val; yyval.value.unit = CSSPrimitiveValue::CSS_EXS; ;}
     break;
 
-  case 145:
+  case 146:
 
     {
       Function *f = new Function;
@@ -2521,7 +2524,7 @@
   ;}
     break;
 
-  case 146:
+  case 147:
 
     {
       Function *f = new Function;
@@ -2533,12 +2536,12 @@
   ;}
     break;
 
-  case 147:
+  case 148:
 
     { yyval.string = yyvsp[-1].string; ;}
     break;
 
-  case 148:
+  case 149:
 
     {
 	yyval.rule = 0;
@@ -2548,7 +2551,7 @@
     ;}
     break;
 
-  case 149:
+  case 150:
 
     {
 	yyval.rule = 0;
@@ -2558,7 +2561,7 @@
     ;}
     break;
 
-  case 150:
+  case 151:
 
     {
 	yyval.rule = 0;
@@ -2684,15 +2687,10 @@
 
     }
 
-  /* Else will try to reuse lookahead token after shifting the error
-     token.  */
-  goto yyerrlab2;
-
-
 /*---------------------------------------------------------------.
 | yyerrlab2 -- pop states until the error token can be shifted.  |
 `---------------------------------------------------------------*/
-yyerrlab2:
+yyerrlab1:
   yyerrstatus = 3;	/* Each real token shifted decrements this.  */
 
   for (;;)
diff -urN -x CVS kdelibs.orig/khtml/css/parser.h kdelibs/khtml/css/parser.h
--- kdelibs.orig/khtml/css/parser.h	Sat Jul 24 12:29:28 2004
+++ kdelibs/khtml/css/parser.h	Wed Nov 10 10:00:17 2004
@@ -138,6 +138,7 @@
     unsigned int element;
     unsigned int ns;
     CSSSelector::Relation relation;
+    CSSSelector::Match match;
     bool b;
     char tok;
     Value value;
diff -urN -x CVS kdelibs.orig/khtml/css/parser.y kdelibs/khtml/css/parser.y
--- kdelibs.orig/khtml/css/parser.y	Mon Jul 26 10:59:25 2004
+++ kdelibs/khtml/css/parser.y	Wed Nov 10 10:00:17 2004
@@ -97,6 +97,7 @@
     unsigned int element;
     unsigned int ns;
     CSSSelector::Relation relation;
+    CSSSelector::Match match;
     bool b;
     char tok;
     Value value;
@@ -231,7 +232,7 @@
 
 %type <b> prio
 
-%type <val> match
+%type <match> match
 %type <val> unary_operator
 %type <tok> operator
 
@@ -483,6 +484,7 @@
 
 combinator:
   '+' maybe_space { $$ = CSSSelector::Sibling; }
+  | '~' maybe_space { $$ = CSSSelector::Cousin; }
   | '>' maybe_space { $$ = CSSSelector::Child; }
   | /* empty */ { $$ = CSSSelector::Descendant; }
   ;
@@ -718,7 +720,7 @@
     | '[' maybe_space ns_attrib_id match maybe_space ident_or_string maybe_space ']' {
 	$$ = new CSSSelector();
 	$$->attr = $3;
-	$$->match = (CSSSelector::Match)$4;
+	$$->match = $4;
 	$$->value = domString($6);
     }
   ;
diff -urN -x CVS kdelibs.orig/khtml/css/quirks.css kdelibs/khtml/css/quirks.css
--- kdelibs.orig/khtml/css/quirks.css	Fri May 14 18:58:09 2004
+++ kdelibs/khtml/css/quirks.css	Wed Nov 10 10:00:17 2004
@@ -25,4 +25,3 @@
     font-size: medium;
     empty-cells: hide;
 }
-
diff -urN -x CVS kdelibs.orig/khtml/css/tokenizer.cpp kdelibs/khtml/css/tokenizer.cpp
--- kdelibs.orig/khtml/css/tokenizer.cpp	Thu Feb 12 23:47:35 2004
+++ kdelibs/khtml/css/tokenizer.cpp	Wed Nov 17 14:43:00 2004
@@ -3,8 +3,6 @@
  *
  * Copyright (C) 2003 Lars Knoll (knoll@kde.org)
  *
- * $Id$
- *
  * This library is free software; you can redistribute it and/or
  * modify it under the terms of the GNU Library General Public
  * License as published by the Free Software Foundation; either
diff -urN -x CVS kdelibs.orig/khtml/dom/css_extensions.cpp kdelibs/khtml/dom/css_extensions.cpp
--- kdelibs.orig/khtml/dom/css_extensions.cpp	Thu Oct  4 12:34:17 2001
+++ kdelibs/khtml/dom/css_extensions.cpp	Wed Nov 17 14:43:01 2004
@@ -18,7 +18,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #include "dom_exception.h"
 #include "dom_string.h"
diff -urN -x CVS kdelibs.orig/khtml/dom/css_extensions.h kdelibs/khtml/dom/css_extensions.h
--- kdelibs.orig/khtml/dom/css_extensions.h	Fri Nov  7 00:00:58 2003
+++ kdelibs/khtml/dom/css_extensions.h	Wed Nov 17 14:43:01 2004
@@ -23,7 +23,6 @@
  * http://www.w3.org/TR/2000/CR-DOM-Level-2-20000510/
  * Copyright  2000 W3C (MIT, INRIA, Keio), All Rights Reserved.
  *
- * $Id$
  */
 #ifndef _CSS_css_extensions_h_
 #define _CSS_css_extensions_h_
diff -urN -x CVS kdelibs.orig/khtml/dom/dom2_events.cpp kdelibs/khtml/dom/dom2_events.cpp
--- kdelibs.orig/khtml/dom/dom2_events.cpp	Tue Feb 24 13:38:40 2004
+++ kdelibs/khtml/dom/dom2_events.cpp	Wed Nov 17 14:43:01 2004
@@ -18,7 +18,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 
 #include "dom/dom2_views.h"
diff -urN -x CVS kdelibs.orig/khtml/dom/dom2_range.cpp kdelibs/khtml/dom/dom2_range.cpp
--- kdelibs.orig/khtml/dom/dom2_range.cpp	Sat Oct  4 20:56:52 2003
+++ kdelibs/khtml/dom/dom2_range.cpp	Wed Nov 17 14:43:01 2004
@@ -22,7 +22,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #include "dom/dom_exception.h"
 #include "xml/dom_docimpl.h"
diff -urN -x CVS kdelibs.orig/khtml/dom/dom_core.h kdelibs/khtml/dom/dom_core.h
--- kdelibs.orig/khtml/dom/dom_core.h	Tue May 23 16:21:34 2000
+++ kdelibs/khtml/dom/dom_core.h	Wed Nov 17 14:43:01 2004
@@ -18,7 +18,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #ifndef _DOM_CORE_H_
 #define _DOM_CORE_H_
diff -urN -x CVS kdelibs.orig/khtml/dom/dom_element.cpp kdelibs/khtml/dom/dom_element.cpp
--- kdelibs.orig/khtml/dom/dom_element.cpp	Thu Jan 22 11:12:18 2004
+++ kdelibs/khtml/dom/dom_element.cpp	Wed Nov 17 14:43:01 2004
@@ -18,7 +18,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 
 #include "dom/dom_exception.h"
diff -urN -x CVS kdelibs.orig/khtml/dom/dom_misc.h kdelibs/khtml/dom/dom_misc.h
--- kdelibs.orig/khtml/dom/dom_misc.h	Sat Sep  6 21:06:34 2003
+++ kdelibs/khtml/dom/dom_misc.h	Wed Nov 17 14:43:01 2004
@@ -18,7 +18,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #ifndef _DOM_RefCountImpl_h_
 #define _DOM_RefCountImpl_h_
diff -urN -x CVS kdelibs.orig/khtml/dom/html_base.h kdelibs/khtml/dom/html_base.h
--- kdelibs.orig/khtml/dom/html_base.h	Sat Aug 16 21:45:07 2003
+++ kdelibs/khtml/dom/html_base.h	Wed Nov 17 14:43:01 2004
@@ -25,7 +25,6 @@
  * Technology , Institut National de Recherche en Informatique et en
  * Automatique , Keio University ). All Rights Reserved.
  *
- * $Id$
  */
 
 #ifndef HTML_BASE_H
diff -urN -x CVS kdelibs.orig/khtml/dom/html_block.cpp kdelibs/khtml/dom/html_block.cpp
--- kdelibs.orig/khtml/dom/html_block.cpp	Thu Oct  9 21:36:42 2003
+++ kdelibs/khtml/dom/html_block.cpp	Wed Nov 10 10:00:19 2004
@@ -1,7 +1,8 @@
 /**
  * This file is part of the DOM implementation for KDE.
  *
- * (C) 1999 Lars Knoll (knoll@kde.org)
+ * Copyright (C) 1999 Lars Knoll (knoll@kde.org)
+ *           (C) 2004 Allan Sandfeld Jensen (kde@carewolf.com)
  *
  * This library is free software; you can redistribute it and/or
  * modify it under the terms of the GNU Library General Public
@@ -23,7 +24,9 @@
 
 
 #include "dom/html_block.h"
+#include "dom/html_misc.h"
 #include "html/html_blockimpl.h"
+#include "html/html_miscimpl.h"
 
 using namespace DOM;
 
@@ -117,17 +120,17 @@
 
 // --------------------------------------------------------------------------
 
-HTMLHRElement::HTMLHRElement() 
+HTMLHRElement::HTMLHRElement()
     : HTMLElement()
 {
 }
 
-HTMLHRElement::HTMLHRElement(const HTMLHRElement &other) 
+HTMLHRElement::HTMLHRElement(const HTMLHRElement &other)
     : HTMLElement(other)
 {
 }
 
-HTMLHRElement::HTMLHRElement(HTMLHRElementImpl *impl) 
+HTMLHRElement::HTMLHRElement(HTMLHRElementImpl *impl)
     : HTMLElement(impl)
 {
 }
@@ -200,17 +203,17 @@
 
 // --------------------------------------------------------------------------
 
-HTMLHeadingElement::HTMLHeadingElement() 
+HTMLHeadingElement::HTMLHeadingElement()
     : HTMLElement()
 {
 }
 
-HTMLHeadingElement::HTMLHeadingElement(const HTMLHeadingElement &other) 
+HTMLHeadingElement::HTMLHeadingElement(const HTMLHeadingElement &other)
     : HTMLElement(other)
 {
 }
 
-HTMLHeadingElement::HTMLHeadingElement(HTMLElementImpl *impl) 
+HTMLHeadingElement::HTMLHeadingElement(HTMLElementImpl *impl)
     : HTMLElement(impl)
 {
 }
@@ -259,12 +262,12 @@
 {
 }
 
-HTMLParagraphElement::HTMLParagraphElement(const HTMLParagraphElement &other) 
+HTMLParagraphElement::HTMLParagraphElement(const HTMLParagraphElement &other)
     : HTMLElement(other)
 {
 }
 
-HTMLParagraphElement::HTMLParagraphElement(HTMLElementImpl *impl) 
+HTMLParagraphElement::HTMLParagraphElement(HTMLElementImpl *impl)
     : HTMLElement(impl)
 {
 }
@@ -302,12 +305,12 @@
 {
 }
 
-HTMLPreElement::HTMLPreElement(const HTMLPreElement &other) 
+HTMLPreElement::HTMLPreElement(const HTMLPreElement &other)
     : HTMLElement(other)
 {
 }
 
-HTMLPreElement::HTMLPreElement(HTMLPreElementImpl *impl) 
+HTMLPreElement::HTMLPreElement(HTMLPreElementImpl *impl)
     : HTMLElement(impl)
 {
 }
@@ -345,3 +348,96 @@
     ((ElementImpl *)impl)->setAttribute(ATTR_WIDTH, value);
 }
 
+// --------------------------------------------------------------------------
+
+HTMLLayerElement::HTMLLayerElement() : HTMLElement()
+{
+}
+
+HTMLLayerElement::HTMLLayerElement(const HTMLLayerElement &other)
+    : HTMLElement(other)
+{
+}
+
+HTMLLayerElement::HTMLLayerElement(HTMLLayerElementImpl *impl)
+    : HTMLElement(impl)
+{
+}
+
+HTMLLayerElement &HTMLLayerElement::operator = (const Node &other)
+{
+    assignOther( other, ID_LAYER );
+    return *this;
+}
+
+HTMLLayerElement &HTMLLayerElement::operator = (const HTMLLayerElement &other)
+{
+    HTMLElement::operator = (other);
+    return *this;
+}
+
+HTMLLayerElement::~HTMLLayerElement()
+{
+}
+
+long HTMLLayerElement::top() const
+{
+    if(!impl) return 0;
+    DOMString t = ((ElementImpl *)impl)->getAttribute(ATTR_TOP);
+    return t.toInt();
+}
+
+void HTMLLayerElement::setTop( long _top )
+{
+    if(!impl) return;
+
+    QString aStr;
+    aStr.sprintf("%ld", _top);
+    DOMString value(aStr);
+    ((ElementImpl *)impl)->setAttribute(ATTR_TOP, value);
+}
+
+long HTMLLayerElement::left() const
+{
+    if(!impl) return 0;
+    DOMString l = ((ElementImpl *)impl)->getAttribute(ATTR_LEFT);
+    return l.toInt();
+}
+
+void HTMLLayerElement::setLeft( long _left )
+{
+    if(!impl) return;
+
+    QString aStr;
+    aStr.sprintf("%ld", _left);
+    DOMString value(aStr);
+    ((ElementImpl *)impl)->setAttribute(ATTR_LEFT, value);
+}
+
+DOMString HTMLLayerElement::visibility() const
+{
+    if(!impl) return DOMString();
+    return ((ElementImpl *)impl)->getAttribute(ATTR_VISIBILITY);
+}
+
+void HTMLLayerElement::setVisibility( const DOMString &value )
+{
+    if(impl) ((ElementImpl *)impl)->setAttribute(ATTR_VISIBILITY, value);
+}
+
+DOMString HTMLLayerElement::bgColor() const
+{
+    if(!impl) return DOMString();
+    return ((ElementImpl *)impl)->getAttribute(ATTR_BGCOLOR);
+}
+
+void HTMLLayerElement::setBgColor( const DOMString &value )
+{
+    if(impl) ((ElementImpl *)impl)->setAttribute(ATTR_BGCOLOR, value);
+}
+
+HTMLCollection HTMLLayerElement::layers() const
+{
+    if(!impl) return HTMLCollection();
+    return HTMLCollection(impl, HTMLCollectionImpl::DOC_LAYERS);
+}
diff -urN -x CVS kdelibs.orig/khtml/dom/html_block.h kdelibs/khtml/dom/html_block.h
--- kdelibs.orig/khtml/dom/html_block.h	Thu Oct  9 21:18:24 2003
+++ kdelibs/khtml/dom/html_block.h	Wed Nov 10 10:00:19 2004
@@ -1,7 +1,8 @@
 /*
  * This file is part of the DOM implementation for KDE.
  *
- * (C) 1999 Lars Knoll (knoll@kde.org)
+ * Copyright (C) 1999 Lars Knoll (knoll@kde.org)
+ *           (C) 2004 Allan Sandfeld Jensen (kde@carewolf.com)
  *
  * This library is free software; you can redistribute it and/or
  * modify it under the terms of the GNU Library General Public
@@ -324,6 +325,80 @@
     void setWidth( long );
 };
 
+class HTMLLayerElementImpl;
+
+/**
+ * Layer container for Netscape 4.x compatability.
+ * Behaves mostly like absolute positioned DIV-blocks.
+ *
+ */
+class HTMLLayerElement : public HTMLElement
+{
+public:
+    HTMLLayerElement();
+    HTMLLayerElement(const HTMLLayerElement &other);
+    HTMLLayerElement(const Node &other) : HTMLElement()
+         {(*this)=other;}
+protected:
+    HTMLLayerElement(HTMLLayerElementImpl *impl);
+public:
+
+    HTMLLayerElement & operator = (const HTMLLayerElement &other);
+    HTMLLayerElement & operator = (const Node &other);
+
+    ~HTMLLayerElement();
+
+    /**
+     * The absolute position of the layer from the top.
+     *
+     */
+    long top() const;
+
+    /**
+     * see top
+     */
+    void setTop( long );
+
+    /**
+     * The absolute position of the layer from the left.
+     *
+     */
+    long left() const;
+
+    /**
+     * see left
+     */
+    void setLeft( long );
+
+    /**
+     * The visibility of layers is either "show" or "hide"
+     *
+     */
+    DOMString visibility() const;
+
+    /**
+     * see visibility
+     */
+    void setVisibility( const DOMString & );
+
+    /**
+     * The background color of the layer.
+     *
+     */
+    DOMString bgColor() const;
+
+    /**
+     * see bgColor
+     */
+    void setBgColor( const DOMString & );
+
+    /**
+     * The collection of sub-layers
+     *
+     */
+    HTMLCollection layers() const;
+};
+
 } //namespace
 
 #endif
diff -urN -x CVS kdelibs.orig/khtml/dom/html_document.cpp kdelibs/khtml/dom/html_document.cpp
--- kdelibs.orig/khtml/dom/html_document.cpp	Wed Jan 14 21:43:04 2004
+++ kdelibs/khtml/dom/html_document.cpp	Wed Nov 10 10:00:19 2004
@@ -164,6 +164,12 @@
     return HTMLCollection(impl, HTMLCollectionImpl::DOC_FORMS);
 }
 
+HTMLCollection HTMLDocument::layers() const
+{
+    if(!impl) return HTMLCollection();
+    return HTMLCollection(impl, HTMLCollectionImpl::DOC_LAYERS);
+}
+
 HTMLCollection HTMLDocument::anchors() const
 {
     if(!impl) return HTMLCollection();
diff -urN -x CVS kdelibs.orig/khtml/dom/html_document.h kdelibs/khtml/dom/html_document.h
--- kdelibs.orig/khtml/dom/html_document.h	Fri Nov  7 00:00:58 2003
+++ kdelibs/khtml/dom/html_document.h	Wed Nov 17 14:59:15 2004
@@ -25,7 +25,6 @@
  * Technology , Institut National de Recherche en Informatique et en
  * Automatique , Keio University ). All Rights Reserved.
  *
- * $Id$
  */
 
 #ifndef HTML_DOCUMENT_H
@@ -171,6 +170,12 @@
     HTMLCollection forms() const;
 
     /**
+     * A collection of all the layers of a document.
+     *
+     */
+    HTMLCollection layers() const;
+
+    /**
      * A collection of all the anchor ( \c A ) elements in
      * a document with a value for the \c name attribute.
      * Note. For reasons of backwards compatibility, the returned set
diff -urN -x CVS kdelibs.orig/khtml/dom/html_form.h kdelibs/khtml/dom/html_form.h
--- kdelibs.orig/khtml/dom/html_form.h	Mon Oct 13 08:20:16 2003
+++ kdelibs/khtml/dom/html_form.h	Wed Nov 17 14:43:01 2004
@@ -25,7 +25,6 @@
  * Technology , Institut National de Recherche en Informatique et en
  * Automatique , Keio University ). All Rights Reserved.
  *
- * $Id$
  */
 #ifndef HTML_FORM_H
 #define HTML_FORM_H
diff -urN -x CVS kdelibs.orig/khtml/dom/html_misc.h kdelibs/khtml/dom/html_misc.h
--- kdelibs.orig/khtml/dom/html_misc.h	Sat Aug 30 11:24:18 2003
+++ kdelibs/khtml/dom/html_misc.h	Wed Nov 10 10:00:19 2004
@@ -132,6 +132,7 @@
     friend class HTMLTableElement;
     friend class HTMLTableRowElement;
     friend class HTMLTableSectionElement;
+    friend class HTMLLayerElement;
     friend class HTMLElement;
 
 public:
diff -urN -x CVS kdelibs.orig/khtml/ecma/README kdelibs/khtml/ecma/README
--- kdelibs.orig/khtml/ecma/README	Wed May  7 14:17:30 2003
+++ kdelibs/khtml/ecma/README	Wed Nov 10 10:00:19 2004
@@ -17,4 +17,5 @@
 
 Appendix B: References for HTML JavaScript bindings
 
+http://msdn.microsoft.com/workshop/author/dhtml/reference/objects.asp
 http://docs.sun.com/source/816-6408-10/
diff -urN -x CVS kdelibs.orig/khtml/ecma/kjs_binding.cpp kdelibs/khtml/ecma/kjs_binding.cpp
--- kdelibs.orig/khtml/ecma/kjs_binding.cpp	Tue Feb 24 17:11:55 2004
+++ kdelibs/khtml/ecma/kjs_binding.cpp	Wed Nov 10 10:00:19 2004
@@ -26,8 +26,10 @@
 #include "dom/dom_exception.h"
 #include "dom/dom2_range.h"
 #include "xml/dom2_eventsimpl.h"
+#include "khtmlpart_p.h"
 
 #include <kdebug.h>
+#include <kparts/browserextension.h>
 
 #include <assert.h>
 
@@ -85,28 +87,24 @@
 
 Value DOMFunction::get(ExecState *exec, const Identifier &propertyName) const
 {
-  Value result;
   try {
-    result = tryGet(exec, propertyName);
+    return tryGet(exec, propertyName);
   }
   catch (DOM::DOMException e) {
-    result = Undefined();
     Object err = Error::create(exec, GeneralError, QString("DOM exception %1").arg(e.code).local8Bit());
     exec->setException(err);
+    return Undefined();
   }
   catch (...) {
     kdError(6070) << "Unknown exception in DOMFunction::get()" << endl;
-    result = String("Unknown exception");
+    return String("Unknown exception");
   }
-
-  return result;
 }
 
 Value DOMFunction::call(ExecState *exec, Object &thisObj, const List &args)
 {
-  Value val;
   try {
-    val = tryCall(exec, thisObj, args);
+    return tryCall(exec, thisObj, args);
   }
   // pity there's no way to distinguish between these in JS code
   // ### Look into setting prototypes of these & the use of instanceof so the exception
@@ -115,39 +113,43 @@
     Object err = Error::create(exec, GeneralError, QString("DOM Exception %1").arg(e.code).local8Bit());
     err.put(exec, "code", Number(e.code));
     exec->setException(err);
+    return Undefined();
   }
   catch (DOM::RangeException e) {
     Object err = Error::create(exec, GeneralError, QString("DOM Range Exception %1").arg(e.code).local8Bit());
     err.put(exec, "code", Number(e.code));
     exec->setException(err);
+    return Undefined();
   }
   catch (DOM::CSSException e) {
     Object err = Error::create(exec, GeneralError, QString("CSS Exception %1").arg(e.code).local8Bit());
     err.put(exec, "code", Number(e.code));
     exec->setException(err);
+    return Undefined();
   }
   catch (DOM::EventException e) {
     Object err = Error::create(exec, GeneralError, QString("DOM Event Exception %1").arg(e.code).local8Bit());
     err.put(exec, "code", Number(e.code));
     exec->setException(err);
+    return Undefined();
   }
   catch (...) {
     kdError(6070) << "Unknown exception in DOMFunction::call()" << endl;
     Object err = Error::create(exec, GeneralError, "Unknown exception");
     exec->setException(err);
+    return Undefined();
   }
-  return val;
 }
 
 typedef QPtrList<ScriptInterpreter> InterpreterList;
 static InterpreterList *interpreterList;
 
-ScriptInterpreter::ScriptInterpreter( const Object &global, KHTMLPart* part )
-  : Interpreter( global ), m_part( part ), m_domObjects(1021),
+ScriptInterpreter::ScriptInterpreter( const Object &global, khtml::ChildFrame* frame )
+  : Interpreter( global ), m_frame( frame ), m_domObjects(1021),
     m_evt( 0L ), m_inlineCode(false), m_timerCallback(false)
 {
 #ifdef KJS_VERBOSE
-  kdDebug(6070) << "ScriptInterpreter::ScriptInterpreter " << this << " for part=" << m_part << endl;
+  kdDebug(6070) << "ScriptInterpreter::ScriptInterpreter " << this << " for part=" << m_frame << endl;
 #endif
   if ( !interpreterList )
     interpreterList = new InterpreterList;
@@ -157,7 +159,7 @@
 ScriptInterpreter::~ScriptInterpreter()
 {
 #ifdef KJS_VERBOSE
-  kdDebug(6070) << "ScriptInterpreter::~ScriptInterpreter " << this << " for part=" << m_part << endl;
+  kdDebug(6070) << "ScriptInterpreter::~ScriptInterpreter " << this << " for part=" << m_frame << endl;
 #endif
   assert( interpreterList && interpreterList->contains( this ) );
   interpreterList->remove( this );
@@ -189,6 +191,10 @@
     it.current()->mark();
 }
 
+KParts::ReadOnlyPart* ScriptInterpreter::part() const {
+    return m_frame->m_part;
+}
+
 bool ScriptInterpreter::isWindowOpenAllowed() const
 {
   if ( m_evt )
@@ -304,3 +310,126 @@
   }
   return res;
 }
+
+class EmbedLiveConnect : public ObjectImp
+{
+  friend Value KJS::getLiveConnectValue(KParts::LiveConnectExtension *lc, const QString & name, const int type, const QString & value, int id);
+  EmbedLiveConnect(KParts::LiveConnectExtension *lc, UString n, KParts::LiveConnectExtension::Type t, int id);
+public:
+  ~EmbedLiveConnect();
+
+  virtual Value get(ExecState *, const Identifier & prop) const;
+  virtual void put(ExecState * exec, const Identifier &prop, const Value & value, int=None);
+  virtual Value call(ExecState * exec, Object &, const List &args);
+  virtual bool implementsCall() const;
+  virtual bool toBoolean(ExecState *) const;
+  virtual Value toPrimitive(ExecState *exec, Type) const;
+  virtual UString toString(ExecState *) const;
+
+private:
+  EmbedLiveConnect(const EmbedLiveConnect &);
+  QGuardedPtr<KParts::LiveConnectExtension> m_liveconnect;
+  UString name;
+  KParts::LiveConnectExtension::Type objtype;
+  unsigned long objid;
+};
+
+Value KJS::getLiveConnectValue(KParts::LiveConnectExtension *lc, const QString & name, const int type, const QString & value, int id)
+{
+  KParts::LiveConnectExtension::Type t=(KParts::LiveConnectExtension::Type)type;
+  switch(t) {
+    case KParts::LiveConnectExtension::TypeBool: {
+      bool ok;
+      int i = value.toInt(&ok);
+      if (ok)
+        return Boolean(i);
+      return Boolean(!strcasecmp(value.latin1(), "true"));
+    }
+    case KParts::LiveConnectExtension::TypeObject:
+    case KParts::LiveConnectExtension::TypeFunction:
+      return Value(new EmbedLiveConnect(lc, name, t, id));
+    case KParts::LiveConnectExtension::TypeNumber: {
+      bool ok;
+      int i = value.toInt(&ok);
+      if (ok)
+        return Number(i);
+      else
+        return Number(value.toDouble(&ok));
+    }
+    case KParts::LiveConnectExtension::TypeString:
+      return String(value);
+    case KParts::LiveConnectExtension::TypeVoid:
+    default:
+      return Undefined();
+  }
+}
+
+/* only with gcc > 3.4 KDE_NO_EXPORT */
+EmbedLiveConnect::EmbedLiveConnect(KParts::LiveConnectExtension *lc, UString n, KParts::LiveConnectExtension::Type t, int id)
+  : m_liveconnect (lc), name(n), objtype(t), objid(id)
+{}
+
+/* only with gcc > 3.4 KDE_NO_EXPORT */
+EmbedLiveConnect::~EmbedLiveConnect() {
+  if (m_liveconnect)
+    m_liveconnect->unregister(objid);
+}
+
+KDE_NO_EXPORT
+Value EmbedLiveConnect::get(ExecState *, const Identifier & prop) const
+{
+  if (m_liveconnect) {
+    KParts::LiveConnectExtension::Type rettype;
+    QString retval;
+    unsigned long retobjid;
+    if (m_liveconnect->get(objid, prop.qstring(), rettype, retobjid, retval))
+      return getLiveConnectValue(m_liveconnect, prop.qstring(), rettype, retval, retobjid);
+  }
+  return Undefined();
+}
+
+KDE_NO_EXPORT
+void EmbedLiveConnect::put(ExecState * exec, const Identifier &prop, const Value & value, int)
+{
+  if (m_liveconnect)
+    m_liveconnect->put(objid, prop.qstring(), value.toString(exec).qstring());
+}
+
+KDE_NO_EXPORT
+bool EmbedLiveConnect::implementsCall() const {
+  return objtype == KParts::LiveConnectExtension::TypeFunction;
+}
+
+KDE_NO_EXPORT
+Value EmbedLiveConnect::call(ExecState *exec, Object&, const List &args)
+{
+  if (m_liveconnect) {
+    QStringList qargs;
+    for (ListIterator i = args.begin(); i != args.end(); ++i)
+      qargs.append((*i).toString(exec).qstring());
+    KParts::LiveConnectExtension::Type rtype;
+    QString rval;
+    unsigned long robjid;
+    if (m_liveconnect->call(objid, name.qstring(), qargs, rtype, robjid, rval))
+      return getLiveConnectValue(m_liveconnect, name.qstring(), rtype, rval, robjid);
+  }
+  return Undefined();
+}
+
+KDE_NO_EXPORT
+bool EmbedLiveConnect::toBoolean(ExecState *) const {
+  return true;
+}
+
+KDE_NO_EXPORT
+Value EmbedLiveConnect::toPrimitive(ExecState *exec, Type) const {
+  return String(toString(exec));
+}
+
+KDE_NO_EXPORT
+UString EmbedLiveConnect::toString(ExecState *) const {
+  QString str;
+  const char *type = objtype == KParts::LiveConnectExtension::TypeFunction ? "Function" : "Object";
+  str.sprintf("[object %s ref=%d]", type, (int) objid);
+  return UString(str);
+}
diff -urN -x CVS kdelibs.orig/khtml/ecma/kjs_binding.h kdelibs/khtml/ecma/kjs_binding.h
--- kdelibs.orig/khtml/ecma/kjs_binding.h	Fri Oct 17 15:57:01 2003
+++ kdelibs/khtml/ecma/kjs_binding.h	Wed Nov 10 10:00:19 2004
@@ -31,7 +31,14 @@
 #include <kurl.h>
 #include <kjs/lookup.h>
 
-class KHTMLPart;
+namespace KParts {
+  class ReadOnlyPart;
+  class LiveConnectExtension;
+}
+
+namespace khtml {
+  class ChildFrame;
+}
 
 namespace KJS {
 
@@ -86,7 +93,7 @@
   class ScriptInterpreter : public Interpreter
   {
   public:
-    ScriptInterpreter( const Object &global, KHTMLPart* part );
+    ScriptInterpreter( const Object &global, khtml::ChildFrame* frame );
     virtual ~ScriptInterpreter();
 
     DOMObject* getDOMObject( void* objectHandle ) const {
@@ -110,7 +117,7 @@
      * Mark objects in the DOMObject cache.
      */
     virtual void mark();
-    KHTMLPart* part() const { return m_part; }
+    KParts::ReadOnlyPart* part() const;
 
     virtual int rtti() { return 1; }
 
@@ -126,7 +133,7 @@
     bool isWindowOpenAllowed() const;
 
   private:
-    KHTMLPart* m_part;
+    khtml::ChildFrame* m_frame;
     QPtrDict<DOMObject> m_domObjects;
     DOM::Event *m_evt;
     bool m_inlineCode;
@@ -244,6 +251,8 @@
   }; \
   }
 
+  Value getLiveConnectValue(KParts::LiveConnectExtension *lc, const QString & name, const int type, const QString & value, int id);
+
 } // namespace
 
 #endif
diff -urN -x CVS kdelibs.orig/khtml/ecma/kjs_css.cpp kdelibs/khtml/ecma/kjs_css.cpp
--- kdelibs.orig/khtml/ecma/kjs_css.cpp	Sun Oct  5 16:03:27 2003
+++ kdelibs/khtml/ecma/kjs_css.cpp	Wed Nov 10 10:00:19 2004
@@ -110,7 +110,7 @@
   if (entry)
     switch (entry->value) {
     case CssText:
-      return getString(styleDecl.cssText());
+      return String(styleDecl.cssText());
     case Length:
       return Number(styleDecl.length());
     case ParentRule:
@@ -127,7 +127,7 @@
   bool ok;
   long unsigned int u = propertyName.toULong(&ok);
   if (ok)
-    return getString(DOM::CSSStyleDeclaration(styleDecl).item(u));
+    return String(DOM::CSSStyleDeclaration(styleDecl).item(u));
 
   // pixelTop returns "CSS Top" as number value in unit pixels
   // posTop returns "CSS top" as number value in unit pixels _if_ its a
@@ -152,7 +152,7 @@
 
   // see if we know this css property, return empty then
   if (DOM::getPropertyID(p.latin1(), p.length()))
-      return getString(DOM::DOMString(""));
+      return String(DOM::DOMString(""));
 
   return DOMObject::tryGet(exec, propertyName);
 }
@@ -198,20 +198,20 @@
 
   switch (id) {
     case DOMCSSStyleDeclaration::GetPropertyValue:
-      return getString(styleDecl.getPropertyValue(s));
+      return String(styleDecl.getPropertyValue(s));
     case DOMCSSStyleDeclaration::GetPropertyCSSValue:
       return getDOMCSSValue(exec,styleDecl.getPropertyCSSValue(s));
     case DOMCSSStyleDeclaration::RemoveProperty:
-      return getString(styleDecl.removeProperty(s));
+      return String(styleDecl.removeProperty(s));
     case DOMCSSStyleDeclaration::GetPropertyPriority:
-      return getString(styleDecl.getPropertyPriority(s));
+      return String(styleDecl.getPropertyPriority(s));
     case DOMCSSStyleDeclaration::SetProperty:
       styleDecl.setProperty(args[0].toString(exec).string(),
                             args[1].toString(exec).string(),
                             args[2].toString(exec).string());
       return Undefined();
     case DOMCSSStyleDeclaration::Item:
-      return getString(styleDecl.item(args[0].toInteger(exec)));
+      return String(styleDecl.item(args[0].toInteger(exec)));
     default:
       return Undefined();
   }
@@ -256,7 +256,7 @@
 {
   switch (token) {
   case Type:
-    return getString(styleSheet.type());
+    return String(styleSheet.type());
   case Disabled:
     return Boolean(styleSheet.disabled());
   case OwnerNode:
@@ -264,9 +264,9 @@
   case ParentStyleSheet:
     return getDOMStyleSheet(exec,styleSheet.parentStyleSheet());
   case Href:
-    return getString(styleSheet.href());
+    return String(styleSheet.href());
   case Title:
-    return getString(styleSheet.title());
+    return String(styleSheet.title());
   case Media:
     return getDOMMediaList(exec, styleSheet.media());
   }
@@ -454,14 +454,14 @@
 Value DOMMediaList::tryGet(ExecState *exec, const Identifier &p) const
 {
   if (p == "mediaText")
-    return getString(mediaList.mediaText());
+    return String(mediaList.mediaText());
   else if (p == lengthPropertyName)
     return Number(mediaList.length());
 
   bool ok;
   long unsigned int u = p.toULong(&ok);
   if (ok)
-    return getString(mediaList.item(u));
+    return String(mediaList.item(u));
 
   return DOMObject::tryGet(exec, p);
 }
@@ -485,7 +485,7 @@
   DOM::MediaList mediaList = static_cast<DOMMediaList *>(thisObj.imp())->toMediaList();
   switch (id) {
     case DOMMediaList::Item:
-      return getString(mediaList.item(args[0].toInteger(exec)));
+      return String(mediaList.item(args[0].toInteger(exec)));
     case DOMMediaList::DeleteMedium:
       mediaList.deleteMedium(args[0].toString(exec).string());
       return Undefined();
@@ -715,7 +715,7 @@
   case Type:
     return Number(cssRule.type());
   case CssText:
-    return getString(cssRule.cssText());
+    return String(cssRule.cssText());
   case ParentStyleSheet:
     return getDOMStyleSheet(exec,cssRule.parentStyleSheet());
   case ParentRule:
@@ -723,7 +723,7 @@
 
   // for DOM::CSSRule::STYLE_RULE:
   case Style_SelectorText:
-    return getString(static_cast<DOM::CSSStyleRule>(cssRule).selectorText());
+    return String(static_cast<DOM::CSSStyleRule>(cssRule).selectorText());
   case Style_Style:
     return getDOMCSSStyleDeclaration(exec,static_cast<DOM::CSSStyleRule>(cssRule).style());
 
@@ -739,13 +739,13 @@
 
   // for DOM::CSSRule::PAGE_RULE:
   case Page_SelectorText:
-    return getString(static_cast<DOM::CSSPageRule>(cssRule).selectorText());
+    return String(static_cast<DOM::CSSPageRule>(cssRule).selectorText());
   case Page_Style:
     return getDOMCSSStyleDeclaration(exec,static_cast<DOM::CSSPageRule>(cssRule).style());
 
   // for DOM::CSSRule::IMPORT_RULE:
   case Import_Href:
-    return getString(static_cast<DOM::CSSImportRule>(cssRule).href());
+    return String(static_cast<DOM::CSSImportRule>(cssRule).href());
   case Import_Media:
     return getDOMMediaList(exec,static_cast<DOM::CSSImportRule>(cssRule).media());
   case Import_StyleSheet:
@@ -753,7 +753,7 @@
 
   // for DOM::CSSRule::CHARSET_RULE:
   case Charset_Encoding:
-    return getString(static_cast<DOM::CSSCharsetRule>(cssRule).encoding());
+    return String(static_cast<DOM::CSSCharsetRule>(cssRule).encoding());
 
   default:
     kdDebug(6070) << "WARNING: DOMCSSRule::getValueProperty unhandled token " << token << endl;
@@ -912,7 +912,7 @@
 Value DOMCSSValue::tryGet(ExecState *exec, const Identifier &p) const
 {
   if (p == "cssText")
-    return getString(cssValue.cssText());
+    return String(cssValue.cssText());
   else if (p == "cssValueType")
     return Number(cssValue.cssValueType());
   return DOMObject::tryGet(exec,p);
@@ -1033,7 +1033,7 @@
       val.setStringValue(args[0].toInteger(exec),args[1].toString(exec).string());
       return Undefined();
     case DOMCSSPrimitiveValue::GetStringValue:
-      return getString(val.getStringValue());
+      return String(val.getStringValue());
     case DOMCSSPrimitiveValue::GetCounterValue:
       return getDOMCounter(exec,val.getCounterValue());
     case DOMCSSPrimitiveValue::GetRectValue:
@@ -1269,11 +1269,11 @@
 {
   switch (token) {
   case identifier:
-    return getString(counter.identifier());
+    return String(counter.identifier());
   case listStyle:
-    return getString(counter.listStyle());
+    return String(counter.listStyle());
   case separator:
-    return getString(counter.separator());
+    return String(counter.separator());
   default:
     return Value();
   }
diff -urN -x CVS kdelibs.orig/khtml/ecma/kjs_debugwin.cpp kdelibs/khtml/ecma/kjs_debugwin.cpp
--- kdelibs.orig/khtml/ecma/kjs_debugwin.cpp	Tue Aug 10 17:41:08 2004
+++ kdelibs/khtml/ecma/kjs_debugwin.cpp	Wed Nov 10 10:00:19 2004
@@ -249,7 +249,7 @@
 QString SourceFile::getCode()
 {
   if (interpreter) {
-    KHTMLPart *part = static_cast<ScriptInterpreter*>(interpreter)->part();
+    KHTMLPart *part = ::qt_cast<KHTMLPart*>(static_cast<ScriptInterpreter*>(interpreter)->part());
     if (part && url == part->url().url() && KHTMLPageCache::self()->isValid(part->cacheId())) {
       Decoder *decoder = part->createDecoder();
       QByteArray data;
@@ -710,7 +710,7 @@
     if (!m_nextSourceUrl.isEmpty()) {
 
       QString code = source.qstring();
-      KHTMLPart *part = static_cast<ScriptInterpreter*>(exec->interpreter())->part();
+      KParts::ReadOnlyPart *part = static_cast<ScriptInterpreter*>(exec->interpreter())->part();
       if (m_nextSourceUrl == part->url().url()) {
 	// Only store the code here if it's not from the part's html page... in that
 	// case we can get it from KHTMLPageCache
@@ -792,11 +792,12 @@
   if (inTryCatch)
     return true;
 
-  KHTMLPart *part = static_cast<ScriptInterpreter*>(exec->interpreter())->part();
-  if (!part->settings()->isJavaScriptErrorReportingEnabled())
+  KParts::ReadOnlyPart *part = static_cast<ScriptInterpreter*>(exec->interpreter())->part();
+  KHTMLPart *khtmlpart = ::qt_cast<KHTMLPart*>(part);
+  if (khtmlpart && !khtmlpart->settings()->isJavaScriptErrorReportingEnabled())
     return true;
 
-  QWidget *dlgParent = (m_evalDepth == 0) ? (QWidget*)part->view() : (QWidget*)this;
+  QWidget *dlgParent = (m_evalDepth == 0) ? (QWidget*)part->widget() : (QWidget*)this;
 
   QString exceptionMsg = value.toString(exec).qstring();
 
diff -urN -x CVS kdelibs.orig/khtml/ecma/kjs_dom.cpp kdelibs/khtml/ecma/kjs_dom.cpp
--- kdelibs.orig/khtml/ecma/kjs_dom.cpp	Wed Jun  9 12:31:16 2004
+++ kdelibs/khtml/ecma/kjs_dom.cpp	Wed Nov 10 10:00:19 2004
@@ -64,6 +64,7 @@
   dispatchEvent		DOMNode::DispatchEvent	DontDelete|Function 1
 # IE extensions
   contains	DOMNode::Contains		DontDelete|Function 1
+  insertAdjacentHTML	DOMNode::InsertAdjacentHTML	DontDelete|Function 2
 # "DOM level 0" (from Gecko DOM reference; also in WinIE)
   item          DOMNode::Item           DontDelete|Function 1
 @end
@@ -167,9 +168,9 @@
 {
   switch (token) {
   case NodeName:
-    return getString(node.nodeName());
+    return String(node.nodeName());
   case NodeValue:
-    return getString(node.nodeValue());
+    return getString(node.nodeValue()); // initially null, per domts/level1/core/hc_documentcreateelement.html
   case NodeType:
     return Number((unsigned int)node.nodeType());
   case ParentNode:
@@ -189,11 +190,11 @@
   case Attributes:
     return getDOMNamedNodeMap(exec,node.attributes());
   case NamespaceURI:
-    return getString(node.namespaceURI());
+    return getString(node.namespaceURI()); // Moz returns null if not set (dom/namespaces.html)
   case Prefix:
-    return getString(node.prefix());
+    return getString(node.prefix());  // Moz returns null if not set (dom/namespaces.html)
   case LocalName:
-    return getString(node.localName());
+    return getString(node.localName());  // Moz returns null if not set (dom/namespaces.html)
   case OwnerDocument:
     return getDOMNode(exec,node.ownerDocument());
   case OnAbort:
@@ -496,6 +497,32 @@
 	}
         return Undefined();
     }
+    case DOMNode::InsertAdjacentHTML:
+    {
+      // see http://www.faqts.com/knowledge_base/view.phtml/aid/5756 
+      // and http://msdn.microsoft.com/workshop/author/dhtml/reference/methods/insertAdjacentHTML.asp 
+      Range range = node.ownerDocument().createRange();
+
+      range.setStartBefore(node);
+
+      DocumentFragment docFrag = range.createContextualFragment(args[1].toString(exec).string());
+
+      DOMString where = args[0].toString(exec).string();
+
+      if (where == "beforeBegin" || where == "BeforeBegin")
+        node.parentNode().insertBefore(docFrag, node);
+      else if (where == "afterBegin" || where == "AfterBegin")
+        node.insertBefore(docFrag, node.firstChild());
+      else if (where == "beforeEnd" || where == "BeforeEnd")
+        return getDOMNode(exec, node.appendChild(docFrag));
+      else if (where == "afterEnd" || where == "AfterEnd")
+        if (!node.nextSibling().isNull())
+	  node.parentNode().insertBefore(docFrag, node.nextSibling());
+	else
+	  node.parentNode().appendChild(docFrag);
+
+      return Undefined();
+    }
     case DOMNode::Item:
       return getDOMNode(exec, node.childNodes().item(static_cast<unsigned long>(args[0].toNumber(exec))));
   }
@@ -596,12 +623,21 @@
 {
   // Do not use thisObj here. See HTMLCollection.
   UString s = args[0].toString(exec);
+
+  // index-based lookup?
   bool ok;
   unsigned int u = s.toULong(&ok);
   if (ok)
     return getDOMNode(exec,list.item(u));
 
-  kdDebug(6070) << "WARNING: KJS::DOMNodeList::tryCall " << s.qstring() << " not implemented" << endl;
+  // try lookup by name
+  // ### NodeList::namedItem() would be cool to have
+  // ### do we need to support the same two arg overload as in HTMLCollection?
+  Value result = tryGet(exec, Identifier(s));
+
+  if (result.isValid())
+    return result;
+
   return Undefined();
 }
 
@@ -663,11 +699,11 @@
 {
   switch (token) {
   case Name:
-    return getString(static_cast<DOM::Attr>(node).name());
+    return String(static_cast<DOM::Attr>(node).name());
   case Specified:
     return Boolean(static_cast<DOM::Attr>(node).specified());
   case ValueProperty:
-    return getString(static_cast<DOM::Attr>(node).value());
+    return String(static_cast<DOM::Attr>(node).value());
   case OwnerElement: // DOM2
     return getDOMNode(exec,static_cast<DOM::Attr>(node).ownerElement());
   }
@@ -779,9 +815,9 @@
   case DOMDocument::DefaultView: // DOM2
     return getDOMAbstractView(exec, doc.defaultView());
   case PreferredStylesheetSet:
-    return getString(doc.preferredStylesheetSet());
+    return String(doc.preferredStylesheetSet());
   case SelectedStylesheetSet:
-    return getString(doc.selectedStylesheetSet());
+    return String(doc.selectedStylesheetSet());
   case ReadyState:
     {
     DOM::DocumentImpl* docimpl = node.handle()->getDocument();
@@ -912,10 +948,11 @@
     Window* active = Window::retrieveActive(exec);
     // Complete the URL using the "active part" (running interpreter). We do this for the security
     // check and to make sure we load exactly the same url as we have verified to be safe
-    if (active->part()) {
+    KHTMLPart *khtmlpart = ::qt_cast<KHTMLPart *>(active->part());
+    if (khtmlpart) {
       // Security: only allow documents to be loaded from the same host
-      QString dstUrl = active->part()->htmlDocument().completeURL(s).string();
-      KHTMLPart *part = static_cast<KJS::ScriptInterpreter*>(exec->interpreter())->part();
+      QString dstUrl = khtmlpart->htmlDocument().completeURL(s).string();
+      KParts::ReadOnlyPart *part = static_cast<KJS::ScriptInterpreter*>(exec->interpreter())->part();
       if (part->url().host() == KURL(dstUrl).host()) {
 	kdDebug(6070) << "JavaScript: access granted for document.load() of " << dstUrl << endl;
 	doc.load(dstUrl);
@@ -986,7 +1023,7 @@
   {
     switch( entry->value ) {
     case TagName:
-      return getString(element.tagName());
+      return String(element.tagName());
     case Style:
       return getDOMCSSStyleDeclaration(exec,element.style());
     default:
@@ -1003,7 +1040,7 @@
   DOM::DOMString attr = element.getAttribute( propertyName.string() );
   // Give access to attributes
   if ( !attr.isNull() )
-    return getString( attr );
+    return String( attr );
 
   return Undefined();
 }
@@ -1093,11 +1130,14 @@
   case DOMDOMImplementation::CreateDocument: { // DOM2
     // Initially set the URL to document of the creator... this is so that it resides in the same
     // host/domain for security checks. The URL will be updated if Document.load() is called.
-    Document doc = implementation.createDocument(args[0].toString(exec).string(),args[1].toString(exec).string(),toNode(args[2]));
-    KHTMLPart *part = static_cast<KJS::ScriptInterpreter*>(exec->interpreter())->part();
-    KURL url = static_cast<DocumentImpl*>(part->document().handle())->URL();
-    static_cast<DocumentImpl*>(doc.handle())->setURL(url.url());
-    return getDOMNode(exec,doc);
+    KHTMLPart *part = ::qt_cast<KHTMLPart*>(static_cast<KJS::ScriptInterpreter*>(exec->interpreter())->part());
+    if (part) {
+      Document doc = implementation.createDocument(args[0].toString(exec).string(),args[1].toString(exec).string(),toNode(args[2]));
+      KURL url = static_cast<DocumentImpl*>(part->document().handle())->URL();
+      static_cast<DocumentImpl*>(doc.handle())->setURL(url.url());
+      return getDOMNode(exec,doc);
+    }
+    break;
   }
   case DOMDOMImplementation::CreateCSSStyleSheet: // DOM2
     return getDOMStyleSheet(exec,implementation.createCSSStyleSheet(args[0].toString(exec).string(),args[1].toString(exec).string()));
@@ -1140,17 +1180,17 @@
   DOM::DocumentType type = static_cast<DOM::DocumentType>(node);
   switch (token) {
   case Name:
-    return String(type.name()); // not getString, otherwise doctype.name.indexOf() fails.
+    return String(type.name());
   case Entities:
     return getDOMNamedNodeMap(exec,type.entities());
   case Notations:
     return getDOMNamedNodeMap(exec,type.notations());
   case PublicId: // DOM2
-    return getString(type.publicId());
+    return String(type.publicId());
   case SystemId: // DOM2
-    return getString(type.systemId());
+    return String(type.systemId());
   case InternalSubset: // DOM2
-    return getString(type.internalSubset());
+    return getString(type.internalSubset()); // can be null, see domts/level2/core/internalSubset01.html
   default:
     kdDebug(6070) << "WARNING: DOMDocumentType::getValueProperty unhandled token " << token << endl;
     return Value();
@@ -1257,9 +1297,9 @@
 {
   switch (token) {
   case Target:
-    return getString(static_cast<DOM::ProcessingInstruction>(node).target());
+    return String(static_cast<DOM::ProcessingInstruction>(node).target());
   case Data:
-    return getString(static_cast<DOM::ProcessingInstruction>(node).data());
+    return String(static_cast<DOM::ProcessingInstruction>(node).data());
   case Sheet:
     return getDOMStyleSheet(exec,static_cast<DOM::ProcessingInstruction>(node).sheet());
   default:
@@ -1296,9 +1336,9 @@
 {
   switch (token) {
   case PublicId:
-    return getString(static_cast<DOM::Notation>(node).publicId());
+    return String(static_cast<DOM::Notation>(node).publicId());
   case SystemId:
-    return getString(static_cast<DOM::Notation>(node).systemId());
+    return String(static_cast<DOM::Notation>(node).systemId());
   default:
     kdDebug(6070) << "WARNING: DOMNotation::getValueProperty unhandled token " << token << endl;
     return Value();
@@ -1325,11 +1365,11 @@
 {
   switch (token) {
   case PublicId:
-    return getString(static_cast<DOM::Entity>(node).publicId());
+    return String(static_cast<DOM::Entity>(node).publicId());
   case SystemId:
-    return getString(static_cast<DOM::Entity>(node).systemId());
+    return String(static_cast<DOM::Entity>(node).systemId());
   case NotationName:
-    return getString(static_cast<DOM::Entity>(node).notationName());
+    return String(static_cast<DOM::Entity>(node).notationName());
   default:
     kdDebug(6070) << "WARNING: DOMEntity::getValueProperty unhandled token " << token << endl;
     return Value();
@@ -1669,7 +1709,7 @@
   DOM::CharacterData data = static_cast<DOMCharacterData *>(thisObj.imp())->toData();
   switch(id) {
     case DOMCharacterData::SubstringData:
-      return getString(data.substringData(args[0].toInteger(exec),args[1].toInteger(exec)));
+      return String(data.substringData(args[0].toInteger(exec),args[1].toInteger(exec)));
     case DOMCharacterData::AppendData:
       data.appendData(args[0].toString(exec).string());
       return Undefined();
diff -urN -x CVS kdelibs.orig/khtml/ecma/kjs_dom.h kdelibs/khtml/ecma/kjs_dom.h
--- kdelibs.orig/khtml/ecma/kjs_dom.h	Wed Oct 29 08:14:33 2003
+++ kdelibs/khtml/ecma/kjs_dom.h	Wed Nov 10 10:00:19 2004
@@ -59,7 +59,7 @@
            Attributes, NamespaceURI, Prefix, LocalName, OwnerDocument, InsertBefore,
            ReplaceChild, RemoveChild, AppendChild, HasAttributes, HasChildNodes,
            CloneNode, Normalize, IsSupported, AddEventListener, RemoveEventListener,
-           DispatchEvent, Contains,
+           DispatchEvent, Contains, InsertAdjacentHTML,
            OnAbort, OnBlur, OnChange, OnClick, OnDblClick, OnDragDrop, OnError,
            OnFocus, OnKeyDown, OnKeyPress, OnKeyUp, OnLoad, OnMouseDown,
            OnMouseMove, OnMouseOut, OnMouseOver, OnMouseUp, OnMove, OnReset,
diff -urN -x CVS kdelibs.orig/khtml/ecma/kjs_events.cpp kdelibs/khtml/ecma/kjs_events.cpp
--- kdelibs.orig/khtml/ecma/kjs_events.cpp	Wed Jun 23 00:45:14 2004
+++ kdelibs/khtml/ecma/kjs_events.cpp	Wed Nov 10 10:00:19 2004
@@ -28,6 +28,7 @@
 #include "xml/dom_docimpl.h"
 #include "xml/dom2_eventsimpl.h"
 #include "rendering/render_object.h"
+#include "rendering/render_canvas.h"
 #include "xml/dom2_eventsimpl.h"
 #include "khtml_part.h"
 
@@ -61,7 +62,7 @@
   if (KJSDebugWin::debugWindow() && KJSDebugWin::debugWindow()->inSession())
     return;
 #endif
-  KHTMLPart *part = static_cast<Window*>(win.imp())->part();
+  KHTMLPart *part = ::qt_cast<KHTMLPart *>(static_cast<Window*>(win.imp())->part());
   KJSProxy *proxy = 0L;
   if (part)
     proxy = part->jScript();
@@ -170,7 +171,7 @@
 void JSLazyEventListener::parseCode() const
 {
   if (!parsed) {
-    KHTMLPart *part = static_cast<Window*>(win.imp())->part();
+    KHTMLPart *part = ::qt_cast<KHTMLPart *>(static_cast<Window*>(win.imp())->part());
     KJSProxy *proxy = 0L;
     if (part)
       proxy = part->jScript();
@@ -611,6 +612,12 @@
         x -= xPos;
         y -= yPos;
       }
+      if ( rend->canvas() ) {
+        int cYPos, cXPos;
+        rend->canvas()->absolutePosition( cXPos,  cYPos,  true );
+        x += cXPos;
+        y += cYPos;
+      }
     }
     return Number( token == OffsetX ? x : y );
   }
diff -urN -x CVS kdelibs.orig/khtml/ecma/kjs_html.cpp kdelibs/khtml/ecma/kjs_html.cpp
--- kdelibs.orig/khtml/ecma/kjs_html.cpp	Thu Oct  7 14:34:20 2004
+++ kdelibs/khtml/ecma/kjs_html.cpp	Wed Nov 10 11:24:05 2004
@@ -34,7 +34,6 @@
 #include "html/html_baseimpl.h"
 #include "html/html_documentimpl.h"
 #include "html/html_imageimpl.h"
-#include "html/html_objectimpl.h"
 #include "html/html_miscimpl.h"
 #include "xml/dom2_eventsimpl.h"
 
@@ -53,6 +52,7 @@
 #include "misc/htmlattrs.h"
 #include "rendering/render_object.h"
 #include "rendering/render_canvas.h"
+#include "rendering/render_frames.h"
 #include "rendering/render_layer.h"
 
 #include "kmessagebox.h"
@@ -167,8 +167,9 @@
   compatMode		HTMLDocument::CompatMode	DontDelete|ReadOnly
 #IE extension
   frames		HTMLDocument::Frames		DontDelete|ReadOnly
+#NS4 extension
+#  layers		HTMLDocument::Layers		DontDelete|ReadOnly
 #potentially obsolete array properties
-# layers
 # plugins
 # tags
 #potentially obsolete properties
@@ -208,11 +209,11 @@
     return false;
 
   // Keep in sync with tryGet
-  NamedTagLengthDeterminer::TagLength tags[3] = {
-    {ID_IMG, 0, 0L}, {ID_FORM, 0, 0L}, {ID_APPLET, 0, 0L}
+  NamedTagLengthDeterminer::TagLength tags[4] = {
+      {ID_IMG, 0, 0L}, {ID_FORM, 0, 0L}, {ID_APPLET, 0, 0L}, {ID_LAYER, 0, 0L}
   };
-  NamedTagLengthDeterminer(p.string(), tags, 3)(doc.handle());
-  for (int i = 0; i < 3; i++)
+  NamedTagLengthDeterminer(p.string(), tags, 4)(doc.handle());
+  for (int i = 0; i < 4; i++)
     if (tags[i].length > 0)
         return true;
 
@@ -245,11 +246,11 @@
   // Note that document.myform should only look at forms
   // Check for applets with name==propertyName, return item or list if found
 
-  NamedTagLengthDeterminer::TagLength tags[3] = {
-    {ID_IMG, 0, 0L}, {ID_FORM, 0, 0L}, {ID_APPLET, 0, 0L}
+  NamedTagLengthDeterminer::TagLength tags[4] = {
+    {ID_IMG, 0, 0L}, {ID_FORM, 0, 0L}, {ID_APPLET, 0, 0L}, {ID_LAYER, 0, 0L}
   };
-  NamedTagLengthDeterminer(propertyName.string(), tags, 3)(doc.handle());
-  for (int i = 0; i < 3; i++)
+  NamedTagLengthDeterminer(propertyName.string(), tags, 4)(doc.handle());
+  for (int i = 0; i < 4; i++)
     if (tags[i].length > 0) {
       if (tags[i].length == 1)
         return getDOMNode(exec, tags[i].last);
@@ -273,11 +274,11 @@
     case Title:
       return String(doc.title());
     case Referrer:
-      return String(doc.referrer()); // not getString - DOMTS HTMLDocument02.html
+      return String(doc.referrer());
     case Domain:
       return String(doc.domain());
     case URL:
-      return getString(doc.URL());
+      return String(doc.URL());
     case Body:
       return getDOMNode(exec,doc.body());
     case Location:
@@ -295,6 +296,10 @@
       return getHTMLCollection(exec,doc.links());
     case Forms:
       return getHTMLCollection(exec,doc.forms());
+    case Layers:
+      return Undefined();
+      // ### Should not be hidden when we emulate Netscape4
+      //return getHTMLCollection(exec,doc.layers(), true);
     case Anchors:
       return getHTMLCollection(exec,doc.anchors());
     case Scripts: // TODO (IE-specific)
@@ -329,7 +334,7 @@
     case ReleaseEvents:
       return lookupOrCreateFunction<HTMLDocFunction>( exec, propertyName, this, entry->value, entry->params, entry->attr );
     case CompatMode:
-      return getString(static_cast<HTMLDocumentImpl *>(doc.handle())->parseMode()
+      return String(static_cast<HTMLDocumentImpl *>(doc.handle())->parseMode()
               == DocumentImpl::Compat ? "BackCompat" : "CSS1Compat");
     }
   }
@@ -376,6 +381,12 @@
     if (!element.isNull()) {
       return getDOMNode(exec,element);
     }
+
+    DOM::HTMLCollection coll2 = doc.layers();
+    DOM::HTMLElement element2 = coll2.namedItem(propertyName.string());
+    if (!element2.isNull()) {
+      return getDOMNode(exec,element2);
+    }
   }
 #ifdef KJS_VERBOSE
   kdDebug(6070) << "KJS::HTMLDocument::tryGet " << propertyName.qstring() << " not found" << endl;
@@ -511,6 +522,7 @@
 const ClassInfo KJS::HTMLElement::frame_info = { "HTMLFrameElement", &KJS::HTMLElement::info, &HTMLFrameElementTable, 0 };
 const ClassInfo KJS::HTMLElement::iFrame_info = { "HTMLIFrameElement", &KJS::HTMLElement::info, &HTMLIFrameElementTable, 0 };
 const ClassInfo KJS::HTMLElement::marquee_info = { "HTMLMarqueeElement", &KJS::HTMLElement::info, &HTMLMarqueeElementTable, 0 };
+const ClassInfo KJS::HTMLElement::layer_info = { "HTMLLayerElement", &KJS::HTMLElement::info, &HTMLLayerElementTable, 0 };
 
 const ClassInfo* KJS::HTMLElement::classInfo() const
 {
@@ -637,12 +649,14 @@
     return &iFrame_info;
   case ID_MARQUEE:
     return &marquee_info;
+  case ID_LAYER:
+    return &layer_info;
   default:
     return &info;
   }
 }
 /*
-@begin HTMLElementTable 8
+@begin HTMLElementTable 11
   id		KJS::HTMLElement::ElementId	DontDelete
   title		KJS::HTMLElement::ElementTitle	DontDelete
   lang		KJS::HTMLElement::ElementLang	DontDelete
@@ -1070,6 +1084,15 @@
   cols		KJS::HTMLElement::FrameSetCols			DontDelete
   rows		KJS::HTMLElement::FrameSetRows			DontDelete
 @end
+@begin HTMLLayerElementTable 6
+  top		  KJS::HTMLElement::LayerTop			DontDelete
+  left		  KJS::HTMLElement::LayerLeft			DontDelete
+  visibility	  KJS::HTMLElement::LayerVisibility		DontDelete
+  bgColor	  KJS::HTMLElement::LayerBgColor		DontDelete
+  document  	  KJS::HTMLElement::LayerDocument		DontDelete|ReadOnly
+  clip	  	  KJS::HTMLElement::LayerClip			DontDelete|ReadOnly
+  layers	  KJS::HTMLElement::LayerLayers			DontDelete|ReadOnly
+@end
 @begin HTMLFrameElementTable 9
   contentDocument KJS::HTMLElement::FrameContentDocument        DontDelete|ReadOnly
   frameBorder     KJS::HTMLElement::FrameFrameBorder		DontDelete
@@ -1103,92 +1126,14 @@
 
 */
 
-class EmbedLiveConnect : public ObjectImp {
-public:
-    EmbedLiveConnect(const DOM::HTMLElement& elm, UString n, KParts::LiveConnectExtension::Type t, int id)
-        : element (elm), name(n), objtype(t), objid(id) {}
-    ~EmbedLiveConnect() {
-        DOM::HTMLObjectBaseElementImpl * elm = static_cast<DOM::HTMLObjectBaseElementImpl*>(element.handle());
-        if (elm)
-            elm->unregister(objid);
-    }
-    static Value getValue(const DOM::HTMLElement& elm, const QString & name,
-                          const KParts::LiveConnectExtension::Type t,
-                          const QString & value, int id)
-    {
-        switch(t) {
-            case KParts::LiveConnectExtension::TypeBool: {
-                bool ok;
-                int i = value.toInt(&ok);
-                if (ok)
-                    return Boolean(i);
-                return Boolean(!strcasecmp(value.latin1(), "true"));
-            }
-            case KParts::LiveConnectExtension::TypeFunction:
-                return Value(new EmbedLiveConnect(elm, name, t, id));
-            case KParts::LiveConnectExtension::TypeNumber: {
-                bool ok;
-                int i = value.toInt(&ok);
-                if (ok)
-                    return Number(i);
-                else
-                    return Number(value.toDouble(&ok));
-            }
-            case KParts::LiveConnectExtension::TypeObject:
-                return Value(new EmbedLiveConnect(elm, name, t, id));
-            case KParts::LiveConnectExtension::TypeString:
-                return String(value);
-            case KParts::LiveConnectExtension::TypeVoid:
-            default:
-                return Undefined();
-        }
-    }
-    virtual Value get(ExecState *, const Identifier & prop) const {
-        DOM::HTMLObjectBaseElementImpl * elm = static_cast<DOM::HTMLObjectBaseElementImpl*>(element.handle());
-        KParts::LiveConnectExtension::Type rettype;
-        QString retvalue;
-        unsigned long retobjid;
-        if (elm && elm->get(objid, prop.qstring(), rettype, retobjid, retvalue))
-            return getValue(element, prop.qstring(), rettype, retvalue, retobjid);
-        return Undefined();
-    }
-    virtual void put(ExecState * exec, const Identifier &prop, const Value & value, int=None) {
-        DOM::HTMLObjectBaseElementImpl * elm = static_cast<DOM::HTMLObjectBaseElementImpl*>(element.handle());
-        if (elm)
-            elm->put(objid, prop.qstring(), value.toString(exec).qstring());
-    }
-    virtual bool implementsCall() const {
-        return objtype == KParts::LiveConnectExtension::TypeFunction;
-    }
-    virtual Value call(ExecState * exec, Object &, const List &args) {
-        DOM::HTMLObjectBaseElementImpl * elm = static_cast<DOM::HTMLObjectBaseElementImpl*>(element.handle());
-        QStringList qargs;
-        for (ListIterator i = args.begin(); i != args.end(); i++)
-            qargs.append((*i).toString(exec).qstring());
-        KParts::LiveConnectExtension::Type rettype;
-        QString retvalue;
-        unsigned long retobjid;
-        if (elm && elm->call(objid, name.qstring(), qargs, rettype, retobjid, retvalue))
-            return getValue(element, name.qstring(), rettype, retvalue, retobjid);
-        return Undefined();
-    }
-    virtual bool toBoolean(ExecState *) const { return true; }
-    virtual Value toPrimitive(ExecState *exec, Type) const {
-        return String(toString(exec));
-    }
-    virtual UString toString(ExecState *) const {
-        QString str;
-        const char *type = objtype == KParts::LiveConnectExtension::TypeFunction ? "Function" : "Object";
-        str.sprintf("[object %s ref=%d]", type, (int) objid);
-        return UString(str);
-    }
-private:
-    EmbedLiveConnect(const EmbedLiveConnect &);
-    DOM::HTMLElement element;
-    UString name;
-    KParts::LiveConnectExtension::Type objtype;
-    unsigned long objid;
-};
+static KParts::LiveConnectExtension *getLiveConnectExtension(const DOM::HTMLElement & element)
+{
+  DOM::HTMLDocument doc = element.ownerDocument();
+  KHTMLView *view = static_cast<DOM::DocumentImpl*>(doc.handle())->view();
+  if (view && element.handle())
+    return view->part()->liveConnectExtension(static_cast<khtml::RenderPart*>(element.handle()->renderer()));
+  return 0L;
+}
 
 Value KJS::HTMLElement::tryGet(ExecState *exec, const Identifier &propertyName) const
 {
@@ -1220,17 +1165,17 @@
         return getDOMNode(exec,select.options().item(u)); // not specified by DOM(?) but supported in netscape/IE
     }
       break;
-  case ID_APPLET:
-  case ID_OBJECT:
-  case ID_EMBED: {
-      DOM::HTMLObjectBaseElementImpl * elm = static_cast<DOM::HTMLObjectBaseElementImpl*>(element.handle());
-      QString retvalue;
-      KParts::LiveConnectExtension::Type rettype;
-      unsigned long retobjid;
-      if (elm && elm->get(0, propertyName.qstring(), rettype, retobjid, retvalue))
-          return EmbedLiveConnect::getValue(element, propertyName.qstring(), rettype, retvalue, retobjid);
+    case ID_APPLET:
+    case ID_OBJECT:
+    case ID_EMBED: {
+      KParts::LiveConnectExtension *lc = getLiveConnectExtension(element);
+      QString rvalue;
+      KParts::LiveConnectExtension::Type rtype;
+      unsigned long robjid;
+      if (lc && lc->get(0, propertyName.qstring(), rtype, robjid, rvalue))
+        return getLiveConnectValue(lc, propertyName.qstring(), rtype, rvalue, robjid);
+    }
       break;
-  }
   default:
     break;
   }
@@ -1253,26 +1198,26 @@
   switch (element.elementId()) {
   case ID_HTML: {
     DOM::HTMLHtmlElement html = element;
-    if      (token == HtmlVersion)         return getString(html.version());
+    if      (token == HtmlVersion)         return String(html.version());
   }
   break;
   case ID_HEAD: {
     DOM::HTMLHeadElement head = element;
-    if      (token == HeadProfile)         return getString(head.profile());
+    if      (token == HeadProfile)         return String(head.profile());
   }
   break;
   case ID_LINK: {
     DOM::HTMLLinkElement link = element;
     switch (token) {
     case LinkDisabled:        return Boolean(link.disabled());
-    case LinkCharset:         return getString(link.charset());
-    case LinkHref:            return getString(link.href());
-    case LinkHrefLang:        return getString(link.hreflang());
-    case LinkMedia:           return getString(link.media());
-    case LinkRel:             return getString(link.rel());
-    case LinkRev:             return getString(link.rev());
-    case LinkTarget:          return getString(link.target());
-    case LinkType:            return getString(link.type());
+    case LinkCharset:         return String(link.charset());
+    case LinkHref:            return String(link.href());
+    case LinkHrefLang:        return String(link.hreflang());
+    case LinkMedia:           return String(link.media());
+    case LinkRel:             return String(link.rel());
+    case LinkRev:             return String(link.rev());
+    case LinkTarget:          return String(link.target());
+    case LinkType:            return String(link.type());
     case LinkSheet:           return getDOMStyleSheet(exec,static_cast<DOM::ProcessingInstruction>(node).sheet());
     }
   }
@@ -1280,7 +1225,7 @@
   case ID_TITLE: {
     DOM::HTMLTitleElement title = element;
     switch (token) {
-    case TitleText:                 return getString(title.text());
+    case TitleText:                 return String(title.text());
     }
   }
   break;
@@ -1297,8 +1242,8 @@
   case ID_BASE: {
     DOM::HTMLBaseElement base = element;
     switch (token) {
-    case BaseHref:            return getString(base.href());
-    case BaseTarget:          return getString(base.target());
+    case BaseHref:            return String(base.href());
+    case BaseTarget:          return String(base.target());
     }
   }
   break;
@@ -1306,7 +1251,7 @@
     DOM::HTMLIsIndexElement isindex = element;
     switch (token) {
     case IsIndexForm:            return getDOMNode(exec,isindex.form()); // type HTMLFormElement
-    case IsIndexPrompt:          return getString(isindex.prompt());
+    case IsIndexPrompt:          return String(isindex.prompt());
     }
   }
   break;
@@ -1314,8 +1259,8 @@
     DOM::HTMLStyleElement style = element;
     switch (token) {
     case StyleDisabled:        return Boolean(style.disabled());
-    case StyleMedia:           return getString(style.media());
-    case StyleType:            return getString(style.type());
+    case StyleMedia:           return String(style.media());
+    case StyleType:            return String(style.type());
     case StyleSheet:           return getDOMStyleSheet(exec,style.sheet());
     }
   }
@@ -1323,12 +1268,12 @@
   case ID_BODY: {
     DOM::HTMLBodyElement body = element;
     switch (token) {
-    case BodyALink:           return getString(body.aLink());
-    case BodyBackground:      return getString(body.background());
-    case BodyBgColor:         return getString(body.bgColor());
-    case BodyLink:            return getString(body.link());
-    case BodyText:            return getString(body.text());
-    case BodyVLink:           return getString(body.vLink());
+    case BodyALink:           return String(body.aLink());
+    case BodyBackground:      return String(body.background());
+    case BodyBgColor:         return String(body.bgColor());
+    case BodyLink:            return String(body.link());
+    case BodyText:            return String(body.text());
+    case BodyVLink:           return String(body.vLink());
     default:
       // Update the document's layout before we compute these attributes.
       DOM::DocumentImpl* docimpl = node.handle()->getDocument();
@@ -1353,10 +1298,10 @@
     case FormElements:        return getHTMLCollection(exec,form.elements());
     case FormLength:          return Number(form.length());
     case FormName:            return String(form.name()); // NOT getString (IE gives empty string)
-    case FormAcceptCharset:   return getString(form.acceptCharset());
-    case FormAction:          return getString(form.action());
-    case FormEncType:         return getString(form.enctype());
-    case FormMethod:          return getString(form.method());
+    case FormAcceptCharset:   return String(form.acceptCharset());
+    case FormAction:          return String(form.action());
+    case FormEncType:         return String(form.enctype());
+    case FormMethod:          return String(form.method());
     case FormTarget:          return String(form.target());
     }
   }
@@ -1364,9 +1309,9 @@
   case ID_SELECT: {
     DOM::HTMLSelectElement select = element;
     switch (token) {
-    case SelectType:            return getString(select.type());
+    case SelectType:            return String(select.type());
     case SelectSelectedIndex:   return Number(select.selectedIndex());
-    case SelectValue:           return getString(select.value());
+    case SelectValue:           return String(select.value());
     case SelectLength:          return Number(select.length());
     case SelectForm:            return getDOMNode(exec,select.form()); // type HTMLFormElement
     case SelectOptions:         return getSelectHTMLCollection(exec, select.options(), select); // type HTMLCollection
@@ -1382,7 +1327,7 @@
     DOM::HTMLOptGroupElement optgroup = element;
     switch (token) {
     case OptGroupDisabled:        return Boolean(optgroup.disabled());
-    case OptGroupLabel:           return getString(optgroup.label());
+    case OptGroupLabel:           return String(optgroup.label());
     }
   }
   break;
@@ -1391,24 +1336,24 @@
     switch (token) {
     case OptionForm:            return getDOMNode(exec,option.form()); // type HTMLFormElement
     case OptionDefaultSelected: return Boolean(option.defaultSelected());
-    case OptionText:            return getString(option.text());
+    case OptionText:            return String(option.text());
     case OptionIndex:           return Number(option.index());
     case OptionDisabled:        return Boolean(option.disabled());
-    case OptionLabel:           return getString(option.label());
+    case OptionLabel:           return String(option.label());
     case OptionSelected:        return Boolean(option.selected());
-    case OptionValue:           return getString(option.value());
+    case OptionValue:           return String(option.value());
     }
   }
   break;
   case ID_INPUT: {
     DOM::HTMLInputElement input = element;
     switch (token) {
-    case InputDefaultValue:    return getString(input.defaultValue());
+    case InputDefaultValue:    return String(input.defaultValue());
     case InputDefaultChecked:  return Boolean(input.defaultChecked());
     case InputForm:            return getDOMNode(exec,input.form()); // type HTMLFormElement
-    case InputAccept:          return getString(input.accept());
-    case InputAccessKey:       return getString(input.accessKey());
-    case InputAlign:           return getString(input.align());
+    case InputAccept:          return String(input.accept());
+    case InputAccessKey:       return String(input.accessKey());
+    case InputAlign:           return String(input.align());
     case InputAlt:             return String(input.alt());
     case InputChecked:         return Boolean(input.checked());
     case InputDisabled:        return Boolean(input.disabled());
@@ -1416,28 +1361,28 @@
     case InputName:            return String(input.name()); // NOT getString (IE gives empty string)
     case InputReadOnly:        return Boolean(input.readOnly());
     case InputSize:            return Number(input.getSize());
-    case InputSrc:             return getString(input.src());
+    case InputSrc:             return String(input.src());
     case InputTabIndex:        return Number(input.tabIndex());
-    case InputType:            return getString(input.type());
-    case InputUseMap:          return getString(input.useMap());
-    case InputValue:           return getString(input.value());
+    case InputType:            return String(input.type());
+    case InputUseMap:          return String(input.useMap());
+    case InputValue:           return String(input.value());
     }
   }
   break;
   case ID_TEXTAREA: {
     DOM::HTMLTextAreaElement textarea = element;
     switch (token) {
-    case TextAreaDefaultValue:    return getString(textarea.defaultValue());
+    case TextAreaDefaultValue:    return String(textarea.defaultValue());
     case TextAreaForm:            return getDOMNode(exec,textarea.form()); // type HTMLFormElement
-    case TextAreaAccessKey:       return getString(textarea.accessKey());
+    case TextAreaAccessKey:       return String(textarea.accessKey());
     case TextAreaCols:            return Number(textarea.cols());
     case TextAreaDisabled:        return Boolean(textarea.disabled());
     case TextAreaName:            return String(textarea.name());
     case TextAreaReadOnly:        return Boolean(textarea.readOnly());
     case TextAreaRows:            return Number(textarea.rows());
     case TextAreaTabIndex:        return Number(textarea.tabIndex());
-    case TextAreaType:            return getString(textarea.type());
-    case TextAreaValue:           return getString(textarea.value());
+    case TextAreaType:            return String(textarea.type());
+    case TextAreaValue:           return String(textarea.value());
     }
   }
   break;
@@ -1445,12 +1390,12 @@
     DOM::HTMLButtonElement button = element;
     switch (token) {
     case ButtonForm:            return getDOMNode(exec,button.form()); // type HTMLFormElement
-    case ButtonAccessKey:       return getString(button.accessKey());
+    case ButtonAccessKey:       return String(button.accessKey());
     case ButtonDisabled:        return Boolean(button.disabled());
     case ButtonName:            return String(button.name());
     case ButtonTabIndex:        return Number(button.tabIndex());
-    case ButtonType:            return getString(button.type());
-    case ButtonValue:           return getString(button.value());
+    case ButtonType:            return String(button.type());
+    case ButtonValue:           return String(button.value());
     }
   }
   break;
@@ -1458,8 +1403,8 @@
     DOM::HTMLLabelElement label = element;
     switch (token) {
     case LabelForm:            return getDOMNode(exec,label.form()); // type HTMLFormElement
-    case LabelAccessKey:       return getString(label.accessKey());
-    case LabelHtmlFor:         return getString(label.htmlFor());
+    case LabelAccessKey:       return String(label.accessKey());
+    case LabelHtmlFor:         return String(label.htmlFor());
     }
   }
   break;
@@ -1474,8 +1419,8 @@
     DOM::HTMLLegendElement legend = element;
     switch (token) {
     case LegendForm:            return getDOMNode(exec,legend.form()); // type HTMLFormElement
-    case LegendAccessKey:       return getString(legend.accessKey());
-    case LegendAlign:           return getString(legend.align());
+    case LegendAccessKey:       return String(legend.accessKey());
+    case LegendAlign:           return String(legend.align());
     }
   }
   break;
@@ -1483,7 +1428,7 @@
     DOM::HTMLUListElement uList = element;
     switch (token) {
     case UListCompact:         return Boolean(uList.compact());
-    case UListType:            return getString(uList.type());
+    case UListType:            return String(uList.type());
     }
   }
   break;
@@ -1492,7 +1437,7 @@
     switch (token) {
     case OListCompact:         return Boolean(oList.compact());
     case OListStart:           return Number(oList.start());
-    case OListType:            return getString(oList.type());
+    case OListType:            return String(oList.type());
     }
   }
   break;
@@ -1520,7 +1465,7 @@
   case ID_LI: {
     DOM::HTMLLIElement li = element;
     switch (token) {
-    case LIType:            return getString(li.type());
+    case LIType:            return String(li.type());
     case LIValue:           return Number(li.value());
     }
   }
@@ -1528,14 +1473,14 @@
   case ID_DIV: {
     DOM::HTMLDivElement div = element;
     switch (token) {
-    case DivAlign:           return getString(div.align());
+    case DivAlign:           return String(div.align());
     }
   }
   break;
   case ID_P: {
     DOM::HTMLParagraphElement paragraph = element;
     switch (token) {
-    case ParagraphAlign:           return getString(paragraph.align());
+    case ParagraphAlign:           return String(paragraph.align());
     }
   }
   break;
@@ -1547,20 +1492,20 @@
   case ID_H6: {
     DOM::HTMLHeadingElement heading = element;
     switch (token) {
-    case HeadingAlign:           return getString(heading.align());
+    case HeadingAlign:           return String(heading.align());
     }
   }
   break;
   case ID_BLOCKQUOTE: {
     DOM::HTMLBlockquoteElement blockquote = element;
     switch (token) {
-    case BlockQuoteCite:            return getString(blockquote.cite());
+    case BlockQuoteCite:            return String(blockquote.cite());
     }
   }
   case ID_Q: {
     DOM::HTMLQuoteElement quote = element;
     switch (token) {
-    case QuoteCite:            return getString(quote.cite());
+    case QuoteCite:            return String(quote.cite());
     }
   }
   case ID_PRE: {
@@ -1573,15 +1518,15 @@
   case ID_BR: {
     DOM::HTMLBRElement br = element;
     switch (token) {
-    case BRClear:           return getString(br.clear());
+    case BRClear:           return String(br.clear());
     }
   }
   break;
   case ID_BASEFONT: {
     DOM::HTMLBaseFontElement baseFont = element;
     switch (token) {
-    case BaseFontColor:           return getString(baseFont.color());
-    case BaseFontFace:            return getString(baseFont.face());
+    case BaseFontColor:           return String(baseFont.color());
+    case BaseFontFace:            return String(baseFont.face());
     case BaseFontSize:            return Number(baseFont.getSize());
     }
   }
@@ -1589,19 +1534,19 @@
   case ID_FONT: {
     DOM::HTMLFontElement font = element;
     switch (token) {
-    case FontColor:           return getString(font.color());
-    case FontFace:            return getString(font.face());
-    case FontSize:            return getString(font.size());
+    case FontColor:           return String(font.color());
+    case FontFace:            return String(font.face());
+    case FontSize:            return String(font.size());
     }
   }
   break;
   case ID_HR: {
     DOM::HTMLHRElement hr = element;
     switch (token) {
-    case HRAlign:           return getString(hr.align());
+    case HRAlign:           return String(hr.align());
     case HRNoShade:         return Boolean(hr.noShade());
-    case HRSize:            return getString(hr.size());
-    case HRWidth:           return getString(hr.width());
+    case HRSize:            return String(hr.size());
+    case HRWidth:           return String(hr.width());
     }
   }
   break;
@@ -1609,8 +1554,8 @@
   case ID_DEL: {
     DOM::HTMLModElement mod = element;
     switch (token) {
-    case ModCite:            return getString(mod.cite());
-    case ModDateTime:        return getString(mod.dateTime());
+    case ModCite:            return String(mod.cite());
+    case ModDateTime:        return String(mod.dateTime());
     }
   }
   break;
@@ -1653,16 +1598,16 @@
     DOM::HTMLImageElement image = element;
     switch (token) {
     case ImageName:            return String(image.name()); // NOT getString (IE gives empty string)
-    case ImageAlign:           return getString(image.align());
+    case ImageAlign:           return String(image.align());
     case ImageAlt:             return String(image.alt());
     case ImageBorder:          return String(image.getBorder());
     case ImageComplete:        return Boolean(static_cast<DOM::HTMLImageElementImpl*>( image.handle() )->complete());
     case ImageHeight:          return Number(image.height());
     case ImageHspace:          return Number(image.hspace());
     case ImageIsMap:           return Boolean(image.isMap());
-    case ImageLongDesc:        return getString(image.longDesc());
+    case ImageLongDesc:        return String(image.longDesc());
     case ImageSrc:             return String(image.src());
-    case ImageUseMap:          return getString(image.useMap());
+    case ImageUseMap:          return String(image.useMap());
     case ImageVspace:          return Number(image.vspace());
     case ImageWidth:           return Number(image.width());
     case ImageX:               return Number(image.x());
@@ -1674,52 +1619,52 @@
     DOM::HTMLObjectElement object = element;
     switch (token) {
     case ObjectForm:            return getDOMNode(exec,object.form()); // type HTMLFormElement
-    case ObjectCode:            return String(object.code()); // not getString, cf DOM2TS-HTMLObjectElement02.html
-    case ObjectAlign:           return getString(object.align());
-    case ObjectArchive:         return getString(object.archive());
-    case ObjectBorder:          return getString(object.border());
-    case ObjectCodeBase:        return getString(object.codeBase());
-    case ObjectCodeType:        return getString(object.codeType());
+    case ObjectCode:            return String(object.code());
+    case ObjectAlign:           return String(object.align());
+    case ObjectArchive:         return String(object.archive());
+    case ObjectBorder:          return String(object.border());
+    case ObjectCodeBase:        return String(object.codeBase());
+    case ObjectCodeType:        return String(object.codeType());
     case ObjectContentDocument: return checkNodeSecurity(exec,object.contentDocument()) ?
 				       getDOMNode(exec, object.contentDocument()) : Undefined();
-    case ObjectData:            return getString(object.data());
+    case ObjectData:            return String(object.data());
     case ObjectDeclare:         return Boolean(object.declare());
-    case ObjectHeight:          return getString(object.height());
+    case ObjectHeight:          return String(object.height());
     case ObjectHspace:          return Number(object.getHspace());
-    case ObjectName:            return getString(object.name());
-    case ObjectStandby:         return getString(object.standby());
+    case ObjectName:            return String(object.name());
+    case ObjectStandby:         return String(object.standby());
     case ObjectTabIndex:        return Number(object.tabIndex());
-    case ObjectType:            return getString(object.type());
-    case ObjectUseMap:          return getString(object.useMap());
+    case ObjectType:            return String(object.type());
+    case ObjectUseMap:          return String(object.useMap());
     case ObjectVspace:          return Number(object.getVspace());
-    case ObjectWidth:           return getString(object.width());
+    case ObjectWidth:           return String(object.width());
     }
   }
   break;
   case ID_PARAM: {
     DOM::HTMLParamElement param = element;
     switch (token) {
-    case ParamName:            return getString(param.name());
-    case ParamType:            return getString(param.type());
-    case ParamValue:           return getString(param.value());
-    case ParamValueType:       return getString(param.valueType());
+    case ParamName:            return String(param.name());
+    case ParamType:            return String(param.type());
+    case ParamValue:           return String(param.value());
+    case ParamValueType:       return String(param.valueType());
     }
   }
   break;
   case ID_APPLET: {
     DOM::HTMLAppletElement applet = element;
     switch (token) {
-    case AppletAlign:           return getString(applet.align());
+    case AppletAlign:           return String(applet.align());
     case AppletAlt:             return String(applet.alt());
-    case AppletArchive:         return getString(applet.archive());
-    case AppletCode:            return getString(applet.code());
-    case AppletCodeBase:        return getString(applet.codeBase());
-    case AppletHeight:          return getString(applet.height());
+    case AppletArchive:         return String(applet.archive());
+    case AppletCode:            return String(applet.code());
+    case AppletCodeBase:        return String(applet.codeBase());
+    case AppletHeight:          return String(applet.height());
     case AppletHspace:          return Number(applet.getHspace());
-    case AppletName:            return getString(applet.name());
-    case AppletObject:          return getString(applet.object());
+    case AppletName:            return String(applet.name());
+    case AppletObject:          return String(applet.object());
     case AppletVspace:          return Number(applet.getVspace());
-    case AppletWidth:           return getString(applet.width());
+    case AppletWidth:           return String(applet.width());
     }
   }
   break;
@@ -1727,16 +1672,16 @@
     DOM::HTMLMapElement map = element;
     switch (token) {
     case MapAreas:           return getHTMLCollection(exec, map.areas()); // type HTMLCollection
-    case MapName:            return getString(map.name());
+    case MapName:            return String(map.name());
     }
   }
   break;
   case ID_AREA: {
     DOM::HTMLAreaElement area = element;
     switch (token) {
-    case AreaAccessKey:       return getString(area.accessKey());
+    case AreaAccessKey:       return String(area.accessKey());
     case AreaAlt:             return String(area.alt());
-    case AreaCoords:          return getString(area.coords());
+    case AreaCoords:          return String(area.coords());
     // Group everything that needs href
     case AreaHref:
     case AreaHash:
@@ -1775,22 +1720,22 @@
       }
     }
     case AreaNoHref:          return Boolean(area.noHref());
-    case AreaShape:           return getString(area.shape());
+    case AreaShape:           return String(area.shape());
     case AreaTabIndex:        return Number(area.tabIndex());
-    case AreaTarget:          return getString(area.target());
+    case AreaTarget:          return String(area.target());
     }
   }
   break;
   case ID_SCRIPT: {
     DOM::HTMLScriptElement script = element;
     switch (token) {
-    case ScriptText:            return getString(script.text());
-    case ScriptHtmlFor:         return getString(script.htmlFor());
-    case ScriptEvent:           return getString(script.event());
-    case ScriptCharset:         return getString(script.charset());
+    case ScriptText:            return String(script.text());
+    case ScriptHtmlFor:         return String(script.htmlFor());
+    case ScriptEvent:           return String(script.event());
+    case ScriptCharset:         return String(script.charset());
     case ScriptDefer:           return Boolean(script.defer());
-    case ScriptSrc:             return getString(script.src());
-    case ScriptType:            return getString(script.type());
+    case ScriptSrc:             return String(script.src());
+    case ScriptType:            return String(script.type());
     }
   }
   break;
@@ -1802,22 +1747,22 @@
     case TableTFoot:           return getDOMNode(exec,table.tFoot()); // type HTMLTableSectionElement
     case TableRows:            return getHTMLCollection(exec,table.rows()); // type HTMLCollection
     case TableTBodies:         return getHTMLCollection(exec,table.tBodies()); // type HTMLCollection
-    case TableAlign:           return getString(table.align());
-    case TableBgColor:         return getString(table.bgColor());
-    case TableBorder:          return getString(table.border());
-    case TableCellPadding:     return getString(table.cellPadding());
-    case TableCellSpacing:     return getString(table.cellSpacing());
-    case TableFrame:           return getString(table.frame());
-    case TableRules:           return getString(table.rules());
-    case TableSummary:         return getString(table.summary());
-    case TableWidth:           return getString(table.width());
+    case TableAlign:           return String(table.align());
+    case TableBgColor:         return String(table.bgColor());
+    case TableBorder:          return String(table.border());
+    case TableCellPadding:     return String(table.cellPadding());
+    case TableCellSpacing:     return String(table.cellSpacing());
+    case TableFrame:           return String(table.frame());
+    case TableRules:           return String(table.rules());
+    case TableSummary:         return String(table.summary());
+    case TableWidth:           return String(table.width());
     }
   }
   break;
   case ID_CAPTION: {
     DOM::HTMLTableCaptionElement tableCaption = element;
     switch (token) {
-    case TableCaptionAlign:       return getString(tableCaption.align());
+    case TableCaptionAlign:       return String(tableCaption.align());
     }
   }
   break;
@@ -1825,12 +1770,12 @@
   case ID_COLGROUP: {
     DOM::HTMLTableColElement tableCol = element;
     switch (token) {
-    case TableColAlign:           return getString(tableCol.align());
-    case TableColCh:              return getString(tableCol.ch());
-    case TableColChOff:           return getString(tableCol.chOff());
+    case TableColAlign:           return String(tableCol.align());
+    case TableColCh:              return String(tableCol.ch());
+    case TableColChOff:           return String(tableCol.chOff());
     case TableColSpan:            return Number(tableCol.span());
-    case TableColVAlign:          return getString(tableCol.vAlign());
-    case TableColWidth:           return getString(tableCol.width());
+    case TableColVAlign:          return String(tableCol.vAlign());
+    case TableColWidth:           return String(tableCol.width());
     }
   }
   break;
@@ -1839,10 +1784,10 @@
   case ID_TFOOT: {
     DOM::HTMLTableSectionElement tableSection = element;
     switch (token) {
-    case TableSectionAlign:           return getString(tableSection.align());
-    case TableSectionCh:              return getString(tableSection.ch());
-    case TableSectionChOff:           return getString(tableSection.chOff());
-    case TableSectionVAlign:          return getString(tableSection.vAlign());
+    case TableSectionAlign:           return String(tableSection.align());
+    case TableSectionCh:              return String(tableSection.ch());
+    case TableSectionChOff:           return String(tableSection.chOff());
+    case TableSectionVAlign:          return String(tableSection.vAlign());
     case TableSectionRows:            return getHTMLCollection(exec,tableSection.rows()); // type HTMLCollection
     }
   }
@@ -1853,11 +1798,11 @@
    case TableRowRowIndex:        return Number(tableRow.rowIndex());
    case TableRowSectionRowIndex: return Number(tableRow.sectionRowIndex());
    case TableRowCells:           return getHTMLCollection(exec,tableRow.cells()); // type HTMLCollection
-   case TableRowAlign:           return getString(tableRow.align());
-   case TableRowBgColor:         return getString(tableRow.bgColor());
-   case TableRowCh:              return getString(tableRow.ch());
-   case TableRowChOff:           return getString(tableRow.chOff());
-   case TableRowVAlign:          return getString(tableRow.vAlign());
+   case TableRowAlign:           return String(tableRow.align());
+   case TableRowBgColor:         return String(tableRow.bgColor());
+   case TableRowCh:              return String(tableRow.ch());
+   case TableRowChOff:           return String(tableRow.chOff());
+   case TableRowVAlign:          return String(tableRow.vAlign());
    }
   }
   break;
@@ -1866,28 +1811,41 @@
     DOM::HTMLTableCellElement tableCell = element;
     switch (token) {
     case TableCellCellIndex:       return Number(tableCell.cellIndex());
-    case TableCellAbbr:            return getString(tableCell.abbr());
-    case TableCellAlign:           return getString(tableCell.align());
-    case TableCellAxis:            return getString(tableCell.axis());
-    case TableCellBgColor:         return getString(tableCell.bgColor());
-    case TableCellCh:              return getString(tableCell.ch());
-    case TableCellChOff:           return getString(tableCell.chOff());
+    case TableCellAbbr:            return String(tableCell.abbr());
+    case TableCellAlign:           return String(tableCell.align());
+    case TableCellAxis:            return String(tableCell.axis());
+    case TableCellBgColor:         return String(tableCell.bgColor());
+    case TableCellCh:              return String(tableCell.ch());
+    case TableCellChOff:           return String(tableCell.chOff());
     case TableCellColSpan:         return Number(tableCell.colSpan());
-    case TableCellHeaders:         return getString(tableCell.headers());
-    case TableCellHeight:          return getString(tableCell.height());
+    case TableCellHeaders:         return String(tableCell.headers());
+    case TableCellHeight:          return String(tableCell.height());
     case TableCellNoWrap:          return Boolean(tableCell.noWrap());
     case TableCellRowSpan:         return Number(tableCell.rowSpan());
-    case TableCellScope:           return getString(tableCell.scope());
-    case TableCellVAlign:          return getString(tableCell.vAlign());
-    case TableCellWidth:           return getString(tableCell.width());
+    case TableCellScope:           return String(tableCell.scope());
+    case TableCellVAlign:          return String(tableCell.vAlign());
+    case TableCellWidth:           return String(tableCell.width());
     }
   }
   break;
   case ID_FRAMESET: {
     DOM::HTMLFrameSetElement frameSet = element;
     switch (token) {
-    case FrameSetCols:            return getString(frameSet.cols());
-    case FrameSetRows:            return getString(frameSet.rows());
+    case FrameSetCols:            return String(frameSet.cols());
+    case FrameSetRows:            return String(frameSet.rows());
+    }
+  }
+  break;
+  case ID_LAYER: {
+    DOM::HTMLLayerElement layerElement = element;
+    switch (token) {
+    case LayerTop:            return Number(layerElement.top());
+    case LayerLeft:           return Number(layerElement.left());
+    case LayerVisibility:     return getString(layerElement.visibility());
+    case LayerBgColor:        return getString(layerElement.bgColor());
+    /*case LayerClip:           return getLayerClip(exec, layerElement); */
+    case LayerDocument:       return Undefined();
+    case LayerLayers:         return getHTMLCollection(exec,layerElement.layers());
     }
   }
   break;
@@ -1896,33 +1854,33 @@
     switch (token) {
     case FrameContentDocument: return checkNodeSecurity(exec,frameElement.contentDocument()) ?
 				      getDOMNode(exec, frameElement.contentDocument()) : Undefined();
-    case FrameFrameBorder:     return getString(frameElement.frameBorder());
-    case FrameLongDesc:        return getString(frameElement.longDesc());
-    case FrameMarginHeight:    return getString(frameElement.marginHeight());
-    case FrameMarginWidth:     return getString(frameElement.marginWidth());
-    case FrameName:            return getString(frameElement.name());
+    case FrameFrameBorder:     return String(frameElement.frameBorder());
+    case FrameLongDesc:        return String(frameElement.longDesc());
+    case FrameMarginHeight:    return String(frameElement.marginHeight());
+    case FrameMarginWidth:     return String(frameElement.marginWidth());
+    case FrameName:            return String(frameElement.name());
     case FrameNoResize:        return Boolean(frameElement.noResize());
-    case FrameScrolling:       return getString(frameElement.scrolling());
+    case FrameScrolling:       return String(frameElement.scrolling());
     case FrameSrc:
-    case FrameLocation:        return getString(frameElement.src());
+    case FrameLocation:        return String(frameElement.src());
     }
   }
   break;
   case ID_IFRAME: {
     DOM::HTMLIFrameElement iFrame = element;
     switch (token) {
-    case IFrameAlign:           return getString(iFrame.align());
+    case IFrameAlign:           return String(iFrame.align());
     case IFrameContentDocument: return checkNodeSecurity(exec,iFrame.contentDocument()) ?
 				       getDOMNode(exec, iFrame.contentDocument()) : Undefined();
-    case IFrameFrameBorder:     return getString(iFrame.frameBorder());
-    case IFrameHeight:          return getString(iFrame.height());
-    case IFrameLongDesc:        return getString(iFrame.longDesc());
-    case IFrameMarginHeight:    return getString(iFrame.marginHeight());
-    case IFrameMarginWidth:     return getString(iFrame.marginWidth());
-    case IFrameName:            return getString(iFrame.name());
-    case IFrameScrolling:       return getString(iFrame.scrolling());
-    case IFrameSrc:             return getString(iFrame.src());
-    case IFrameWidth:           return getString(iFrame.width());
+    case IFrameFrameBorder:     return String(iFrame.frameBorder());
+    case IFrameHeight:          return String(iFrame.height());
+    case IFrameLongDesc:        return String(iFrame.longDesc());
+    case IFrameMarginHeight:    return String(iFrame.marginHeight());
+    case IFrameMarginWidth:     return String(iFrame.marginWidth());
+    case IFrameName:            return String(iFrame.name());
+    case IFrameScrolling:       return String(iFrame.scrolling());
+    case IFrameSrc:             return String(iFrame.src());
+    case IFrameWidth:           return String(iFrame.width());
     }
     break;
   }
@@ -1932,15 +1890,15 @@
   // generic properties
   switch (token) {
   case ElementId:
-    return String(element.id()); // getString is wrong here. Other browsers return empty string if no id specified.
+    return String(element.id()); // String is wrong here. Other browsers return empty string if no id specified.
   case ElementTitle:
     return String(element.title());
   case ElementLang:
-    return getString(element.lang());
+    return String(element.lang());
   case ElementDir:
-    return getString(element.dir());
+    return String(element.dir());
   case ElementClassName:
-    return getString(element.className());
+    return String(element.className());
   case ElementInnerHTML:
     return String(element.innerHTML());
   case ElementInnerText:
@@ -1998,14 +1956,14 @@
   if (node.elementId() == ID_A)
     return UString(static_cast<const DOM::HTMLAnchorElement&>(node).href());
   else if (node.elementId() == ID_APPLET) {
-    DOM::HTMLObjectBaseElementImpl * elm = static_cast<DOM::HTMLObjectBaseElementImpl*>(node.handle());
+    KParts::LiveConnectExtension *lc = getLiveConnectExtension(node);
     QStringList qargs;
     QString retvalue;
     KParts::LiveConnectExtension::Type rettype;
     unsigned long retobjid;
-    if (elm && elm->call(0, "hashCode", qargs, rettype, retobjid, retvalue)) {
-        QString str("[object APPLET ref=");
-        return UString(str + retvalue + QString("]"));
+    if (lc && lc->call(0, "hashCode", qargs, rettype, retobjid, retvalue)) {
+      QString str("[object APPLET ref=");
+      return UString(str + retvalue + QString("]"));
     }
   } else if (node.elementId() == ID_IMG) {
     DOM::HTMLImageElement image(node);
@@ -2349,10 +2307,9 @@
     case ID_APPLET:
     case ID_OBJECT:
     case ID_EMBED: {
-      DOM::HTMLObjectBaseElementImpl * elm = static_cast<DOM::HTMLObjectBaseElementImpl*>(element.handle());
-      if (elm && elm->put(0, propertyName.qstring(),
-                          value.toString(exec).qstring()))
-          return;
+      KParts::LiveConnectExtension *lc = getLiveConnectExtension(element);
+      if (lc && lc->put(0, propertyName.qstring(), value.toString(exec).qstring()))
+        return;
       break;
     }
     default:
@@ -2998,6 +2955,17 @@
       }
     }
     break;
+    case ID_LAYER: {
+      DOM::HTMLLayerElement layerElement = element;
+      switch (token) {
+      case LayerTop:                   { layerElement.setTop(value.toInteger(exec)); return; }
+      case LayerLeft:                  { layerElement.setLeft(value.toInteger(exec)); return; }
+      case LayerVisibility:            { layerElement.setVisibility(str); return; }
+      case LayerBgColor:               { layerElement.setBgColor(str); return; }
+      // read-only: layers, clip
+      }
+    }
+    break;
     case ID_FRAME: {
       DOM::HTMLFrameElement frameElement = element;
       switch (token) {
@@ -3079,13 +3047,24 @@
 const ClassInfo KJS::HTMLCollection::info = { "HTMLCollection", 0, 0, 0 };
 
 KJS::HTMLCollection::HTMLCollection(ExecState *exec, const DOM::HTMLCollection& c)
-  : DOMObject(HTMLCollectionProto::self(exec)), collection(c) {}
+  : DOMObject(HTMLCollectionProto::self(exec)), collection(c), hidden(false) {}
 
 KJS::HTMLCollection::~HTMLCollection()
 {
   ScriptInterpreter::forgetDOMObject(collection.handle());
 }
 
+bool KJS::HTMLCollection::toBoolean(ExecState *) const {
+    return !hidden;
+}
+
+Type KJS::HTMLCollection::type() const {
+    if (hidden) // what, me? No, I do not exist..
+        return UndefinedType;
+    else
+        return ObjectImp::type();
+}
+
 // We have to implement hasProperty since we don't use a hashtable for 'selectedIndex' and 'length'
 // ## this breaks "for (..in..)" though.
 bool KJS::HTMLCollection::hasProperty(ExecState *exec, const Identifier &p) const
@@ -3139,8 +3118,11 @@
   bool ok;
   unsigned int u = propertyName.toULong(&ok);
   if (ok) {
-    DOM::Node node = collection.item(u);
-    return getDOMNode(exec,node);
+    if ( u < collection.length() ) {
+      DOM::Node node = collection.item(u);
+      return getDOMNode(exec,node);
+    } else
+      return Undefined();
   }
   else
     return getNamedItems(exec,propertyName);
@@ -3480,15 +3462,16 @@
 void Image::putValueProperty(ExecState *exec, int token, const Value& value, int)
 {
   switch (token) {
-  case Src: {
-    String str = value.toString(exec);
-    src = str.value();
+  case Src:
+    src = value.toString(exec);
     if ( img ) img->deref(this);
     img = static_cast<DOM::DocumentImpl*>( doc.handle() )->docLoader()->requestImage( src.string() );
 // ### img = doc ? doc->docLoader()->requestImage( src.string() ) : 0;
-    if ( img ) img->ref(this);
+    if ( img ) {
+      img->ref(this);
+      src = img->url();
+    }
     break;
-  }
   case OnLoad:
     if ( m_onLoadListener )
         m_onLoadListener->deref();
@@ -3525,9 +3508,14 @@
       m_onLoadListener->deref();
 }
 
-Value KJS::getHTMLCollection(ExecState *exec, const DOM::HTMLCollection& c)
+Value KJS::getHTMLCollection(ExecState *exec, const DOM::HTMLCollection& c, bool hide)
 {
-  return cacheDOMObject<DOM::HTMLCollection, KJS::HTMLCollection>(exec, c);
+  Value coll = cacheDOMObject<DOM::HTMLCollection, KJS::HTMLCollection>(exec, c);
+  if (hide) {
+    KJS::HTMLCollection *impl = static_cast<KJS::HTMLCollection*>(coll.imp());
+    impl->hide();
+  }
+  return coll;
 }
 
 Value KJS::getSelectHTMLCollection(ExecState *exec, const DOM::HTMLCollection& c, const DOM::HTMLSelectElement& e)
diff -urN -x CVS kdelibs.orig/khtml/ecma/kjs_html.h kdelibs/khtml/ecma/kjs_html.h
--- kdelibs.orig/khtml/ecma/kjs_html.h	Tue Sep  7 17:19:54 2004
+++ kdelibs/khtml/ecma/kjs_html.h	Wed Nov 10 10:00:19 2004
@@ -46,7 +46,7 @@
     virtual const ClassInfo* classInfo() const { return &info; }
     static const ClassInfo info;
     enum { Title, Referrer, Domain, URL, Body, Location, Cookie,
-           Images, Applets, Links, Forms, Anchors, Scripts, All, Clear, Open, Close,
+           Images, Applets, Links, Forms, Layers, Anchors, Scripts, All, Clear, Open, Close,
            Write, WriteLn, GetElementsByName, GetSelection, CaptureEvents, ReleaseEvents,
            BgColor, FgColor, AlinkColor, LinkColor, VlinkColor, LastModified,
            Height, Width, Dir, Frames, CompatMode };
@@ -75,7 +75,7 @@
       hr_info, mod_info, a_info, img_info, object_info, param_info,
       applet_info, map_info, area_info, script_info, table_info,
       caption_info, col_info, tablesection_info, tr_info,
-      tablecell_info, frameSet_info, frame_info, iFrame_info, marquee_info;
+      tablecell_info, frameSet_info, frame_info, iFrame_info, marquee_info, layer_info;
 
     enum { HtmlVersion, HeadProfile, LinkHref, LinkRel, LinkMedia,
            LinkCharset, LinkDisabled, LinkHrefLang, LinkRev, LinkTarget, LinkType,
@@ -146,6 +146,7 @@
            IFrameFrameBorder, IFrameSrc, IFrameName, IFrameHeight,
            IFrameMarginHeight, IFrameMarginWidth, IFrameScrolling, IFrameWidth, IFrameContentDocument,
            MarqueeStart, MarqueeStop,
+           LayerTop, LayerLeft, LayerVisibility, LayerBgColor, LayerClip, LayerDocument, LayerLayers,
            ElementInnerHTML, ElementTitle, ElementId, ElementDir, ElementLang,
            ElementClassName, ElementInnerText, ElementDocument, ElementChildren, ElementAll };
 
@@ -169,15 +170,18 @@
     virtual Value call(ExecState *exec, Object &thisObj, const List&args);
     virtual Value tryCall(ExecState *exec, Object &thisObj, const List&args);
     virtual bool implementsCall() const { return true; }
-    virtual bool toBoolean(ExecState *) const { return true; }
+    virtual bool toBoolean(ExecState *) const;
+    virtual Type type() const;
     virtual bool hasProperty(ExecState *exec, const Identifier &p) const;
     enum { Item, NamedItem, Tags };
     Value getNamedItems(ExecState *exec, const Identifier &propertyName) const;
     virtual const ClassInfo* classInfo() const { return &info; }
     static const ClassInfo info;
     DOM::HTMLCollection toCollection() const { return collection; }
+    virtual void hide() { hidden = true; }
   protected:
     DOM::HTMLCollection collection;
+    bool hidden;
   };
 
   class HTMLSelectCollection : public HTMLCollection {
@@ -232,7 +236,7 @@
     JSEventListener *m_onLoadListener;
   };
 
-  Value getHTMLCollection(ExecState *exec, const DOM::HTMLCollection& c);
+  Value getHTMLCollection(ExecState *exec, const DOM::HTMLCollection& c, bool hide=false);
   Value getSelectHTMLCollection(ExecState *exec, const DOM::HTMLCollection& c, const DOM::HTMLSelectElement& e);
 
   /* Helper function object for determining the number
diff -urN -x CVS kdelibs.orig/khtml/ecma/kjs_navigator.cpp kdelibs/khtml/ecma/kjs_navigator.cpp
--- kdelibs.orig/khtml/ecma/kjs_navigator.cpp	Mon Jul 12 21:49:09 2004
+++ kdelibs/khtml/ecma/kjs_navigator.cpp	Wed Nov 10 10:00:19 2004
@@ -169,7 +169,10 @@
 Value Navigator::getValueProperty(ExecState *exec, int token) const
 {
   KURL url = m_part->url();
-  QString userAgent = KProtocolManager::userAgentForHost(url.host());
+  QString userAgent = url.host();
+  if (userAgent.isEmpty())
+     userAgent = "localhost";
+  userAgent = KProtocolManager::userAgentForHost(userAgent);
   switch (token) {
   case AppCodeName:
     return String("Mozilla");
@@ -193,11 +196,24 @@
     // We assume the string is something like Mozilla/version (properties)
     return String(userAgent.mid(userAgent.find('/') + 1));
   case Product:
+    // We are pretending to be Mozilla or Safari
+    if (userAgent.find(QString::fromLatin1("Mozilla")) >= 0 &&
+        userAgent.find(QString::fromLatin1("compatible")) == -1)
+    {
+        return String("Gecko");
+    }
+    // When spoofing as IE, we use Undefined().
+    if (userAgent.find(QString::fromLatin1("Microsoft")) >= 0 ||
+        userAgent.find(QString::fromLatin1("MSIE")) >= 0)
+    {
+        return Undefined();
+    }
+    // We are acting straight
     return String("Konqueror/khtml");
   case ProductSub:
     {
       int ix = userAgent.find("Gecko");
-      if (ix >= 0 && userAgent.length() >= (uint)ix+14 && userAgent.at(ix+5) == '/' && 
+      if (ix >= 0 && userAgent.length() >= (uint)ix+14 && userAgent.at(ix+5) == '/' &&
           userAgent.find(QRegExp("\\d{8}"), ix+6) == ix+6)
       {
           // We have Gecko/<productSub> in the UA string
@@ -207,7 +223,7 @@
       {
           return String("20040107");
       }
-    } 
+    }
     return Undefined();
   case Vendor:
     return String("KDE");
diff -urN -x CVS kdelibs.orig/khtml/ecma/kjs_proxy.cpp kdelibs/khtml/ecma/kjs_proxy.cpp
--- kdelibs.orig/khtml/ecma/kjs_proxy.cpp	Wed Jun  9 12:31:16 2004
+++ kdelibs/khtml/ecma/kjs_proxy.cpp	Wed Nov 10 10:00:19 2004
@@ -25,6 +25,8 @@
 #include "kjs_window.h"
 #include "kjs_events.h"
 #include "kjs_debugwin.h"
+#include "xml/dom_nodeimpl.h"
+#include "khtmlpart_p.h"
 #include <khtml_part.h>
 #include <kprotocolmanager.h>
 #include <kdebug.h>
@@ -39,14 +41,14 @@
 using namespace KJS;
 
 extern "C" {
-  KJSProxy *kjs_html_init(KHTMLPart *khtmlpart);
+  KJSProxy *kjs_html_init(khtml::ChildFrame *childframe);
 }
 
 namespace KJS {
 
 class KJSProxyImpl : public KJSProxy {
 public:
-  KJSProxyImpl(KHTMLPart *part);
+  KJSProxyImpl(khtml::ChildFrame *frame);
   virtual ~KJSProxyImpl();
   virtual QVariant evaluate(QString filename, int baseLine, const QString &, const DOM::Node &n,
 			    Completion *completion = 0);
@@ -77,10 +79,10 @@
 int KJSProxyImpl::s_count = 0;
 #endif
 
-KJSProxyImpl::KJSProxyImpl(KHTMLPart *part)
+KJSProxyImpl::KJSProxyImpl(khtml::ChildFrame *frame)
 {
   m_script = 0;
-  m_part = part;
+  m_frame = frame;
   m_debugEnabled = false;
 #ifndef NDEBUG
   s_count++;
@@ -142,8 +144,8 @@
 #endif
 
   m_script->setInlineCode(inlineCode);
-  Window* window = Window::retrieveWindow( m_part );
-  KJS::Value thisNode = n.isNull() ? Window::retrieve( m_part ) : getDOMNode(m_script->globalExec(),n);
+  Window* window = Window::retrieveWindow( m_frame->m_part );
+  KJS::Value thisNode = n.isNull() ? Window::retrieve( m_frame->m_part ) : getDOMNode(m_script->globalExec(),n);
 
   UString code( str );
 
@@ -214,7 +216,7 @@
       // re-add "debug", clear() removed it
       m_script->globalObject().put(m_script->globalExec(),
                                    "debug", Value(new TestFunctionImp()), Internal);
-      if ( !win->part().isNull() )
+      if ( win->part() )
         applyUserAgent();
     }
 
@@ -238,7 +240,7 @@
   Q_UNUSED(sourceUrl);
 #endif
 
-  return KJS::Window::retrieveWindow(m_part)->getJSLazyEventListener(code,name,true);
+  return KJS::Window::retrieveWindow(m_frame->m_part)->getJSLazyEventListener(code,name,true);
 }
 
 void KJSProxyImpl::finishedWithEvent(const DOM::Event &event)
@@ -300,8 +302,8 @@
 void KJSProxyImpl::dataReceived()
 {
 #ifdef KJS_DEBUGGER
-  if (KJSDebugWin::debugWindow())
-    KJSDebugWin::debugWindow()->sourceChanged(m_script,m_part->url().url());
+  if (KJSDebugWin::debugWindow() && m_frame->m_part)
+    KJSDebugWin::debugWindow()->sourceChanged(m_script,m_frame->m_part->url().url());
 #endif
 }
 
@@ -311,10 +313,10 @@
     return;
 
   // Build the global object - which is a Window instance
-  Object globalObject( new Window(m_part) );
+  Object globalObject( new Window(m_frame) );
 
   // Create a KJS interpreter for this part
-  m_script = new KJS::ScriptInterpreter(globalObject, m_part);
+  m_script = new KJS::ScriptInterpreter(globalObject, m_frame);
   static_cast<ObjectImp*>(globalObject.imp())->setPrototype(m_script->builtinObjectPrototype());
 
 #ifdef KJS_DEBUGGER
@@ -329,7 +331,7 @@
 void KJSProxyImpl::applyUserAgent()
 {
   assert( m_script );
-  QString host = m_part->url().isLocalFile() ? "localhost" : m_part->url().host();
+  QString host = m_frame->m_part->url().isLocalFile() ? "localhost" : m_frame->m_part->url().host();
   QString userAgent = KProtocolManager::userAgentForHost(host);
   if (userAgent.find(QString::fromLatin1("Microsoft")) >= 0 ||
       userAgent.find(QString::fromLatin1("MSIE")) >= 0)
@@ -352,9 +354,9 @@
 }
 
 // initialize HTML module
-KJSProxy *kjs_html_init(KHTMLPart *khtmlpart)
+KJSProxy *kjs_html_init(khtml::ChildFrame *childframe)
 {
-  return new KJSProxyImpl(khtmlpart);
+  return new KJSProxyImpl(childframe);
 }
 
 void KJSCPUGuard::start(unsigned int ms, unsigned int i_ms)
diff -urN -x CVS kdelibs.orig/khtml/ecma/kjs_proxy.h kdelibs/khtml/ecma/kjs_proxy.h
--- kdelibs.orig/khtml/ecma/kjs_proxy.h	Fri Feb 20 15:36:44 2004
+++ kdelibs/khtml/ecma/kjs_proxy.h	Wed Nov 10 10:00:19 2004
@@ -41,6 +41,10 @@
   class KJSDebugWin;
 }
 
+namespace khtml {
+  class ChildFrame;
+}
+
 /**
  * @internal
  *
@@ -64,7 +68,7 @@
 
   void setEventHandlerLineno(int lineno) { m_handlerLineno = lineno; }
 
-  KHTMLPart *m_part;
+  khtml::ChildFrame *m_frame;
   int m_handlerLineno;
 };
 
diff -urN -x CVS kdelibs.orig/khtml/ecma/kjs_range.cpp kdelibs/khtml/ecma/kjs_range.cpp
--- kdelibs.orig/khtml/ecma/kjs_range.cpp	Wed Apr 23 19:55:46 2003
+++ kdelibs/khtml/ecma/kjs_range.cpp	Wed Nov 10 10:00:19 2004
@@ -167,7 +167,7 @@
       result = getDOMRange(exec,range.cloneRange());
       break;
     case DOMRange::ToString:
-      result = getString(range.toString());
+      result = String(range.toString());
       break;
     case DOMRange::Detach:
       range.detach();
diff -urN -x CVS kdelibs.orig/khtml/ecma/kjs_window.cpp kdelibs/khtml/ecma/kjs_window.cpp
--- kdelibs.orig/khtml/ecma/kjs_window.cpp	Thu Oct  7 14:34:21 2004
+++ kdelibs/khtml/ecma/kjs_window.cpp	Wed Nov 17 14:23:07 2004
@@ -57,11 +57,13 @@
 
 #include "khtmlview.h"
 #include "khtml_part.h"
+#include "khtmlpart_p.h"
 #include "khtml_settings.h"
 #include "xml/dom2_eventsimpl.h"
 #include "xml/dom_docimpl.h"
 #include "misc/htmltags.h"
 #include "html/html_documentimpl.h"
+#include "rendering/render_frames.h"
 
 using namespace KJS;
 
@@ -155,7 +157,7 @@
 #if defined Q_WS_X11 && ! defined K_WS_QTONLY
   KWinModule info(0, KWinModule::INFO_DESKTOP);
 #endif
-  QWidget *thisWidget = Window::retrieveActive(exec)->part()->view();
+  QWidget *thisWidget = Window::retrieveActive(exec)->part()->widget();
   QRect sg = KGlobalSettings::desktopGeometry(thisWidget);
 
   switch( token ) {
@@ -316,8 +318,8 @@
 */
 IMPLEMENT_PROTOFUNC_DOM(WindowFunc)
 
-Window::Window(KHTMLPart *p)
-  : ObjectImp(/*no proto*/), m_part(p), screen(0), history(0), external(0), m_frames(0), loc(0), m_evt(0)
+Window::Window(khtml::ChildFrame *p)
+  : ObjectImp(/*no proto*/), m_frame(p), screen(0), history(0), external(0), m_frames(0), loc(0), m_evt(0)
 {
   winq = new WindowQObject(this);
   //kdDebug(6070) << "Window::Window this=" << this << " part=" << m_part << " " << m_part->name() << endl;
@@ -328,12 +330,13 @@
   delete winq;
 }
 
-Window *Window::retrieveWindow(KHTMLPart *p)
+Window *Window::retrieveWindow(KParts::ReadOnlyPart *p)
 {
   Object obj = Object::dynamicCast( retrieve( p ) );
 #ifndef NDEBUG
   // obj should never be null, except when javascript has been disabled in that part.
-  if ( p && p->jScriptEnabled() )
+  KHTMLPart *part = ::qt_cast<KHTMLPart *>(p);
+  if ( part && part->jScriptEnabled() )
   {
     assert( !obj.isNull() );
 #ifndef QWS
@@ -356,13 +359,20 @@
   return static_cast<KJS::Window*>(imp);
 }
 
-Value Window::retrieve(KHTMLPart *p)
+Value Window::retrieve(KParts::ReadOnlyPart *p)
 {
   assert(p);
-  KJSProxy *proxy = p->jScript();
+  KHTMLPart * part = ::qt_cast<KHTMLPart *>(p);
+  KJSProxy *proxy = 0L;
+  if (!part) {
+    part = ::qt_cast<KHTMLPart *>(p->parent());
+    if (part)
+      proxy = part->framejScript(p);
+  } else
+    proxy = part->jScript();
   if (proxy) {
 #ifdef KJS_VERBOSE
-    kdDebug(6070) << "Window::retrieve part=" << p << " '" << p->name() << "' interpreter=" << proxy->interpreter() << " window=" << proxy->interpreter()->globalObject().imp() << endl;
+    kdDebug(6070) << "Window::retrieve part=" << part << " '" << part->name() << "' interpreter=" << proxy->interpreter() << " window=" << proxy->interpreter()->globalObject().imp() << endl;
 #endif
     return proxy->interpreter()->globalObject(); // the Global object is the "window"
   } else {
@@ -376,14 +386,17 @@
 Location *Window::location() const
 {
   if (!loc)
-    const_cast<Window*>(this)->loc = new Location(m_part);
+    const_cast<Window*>(this)->loc = new Location(m_frame);
   return loc;
 }
 
 ObjectImp* Window::frames( ExecState* exec ) const
 {
-  return m_frames ? m_frames :
-    (const_cast<Window*>(this)->m_frames = new FrameArray(exec,m_part));
+  KHTMLPart *part = ::qt_cast<KHTMLPart *>(m_frame->m_part);
+  if (part)
+    return m_frames ? m_frames :
+      (const_cast<Window*>(this)->m_frames = new FrameArray(exec, part));
+  return 0L;
 }
 
 // reference our special objects during garbage collection
@@ -408,7 +421,7 @@
 bool Window::hasProperty(ExecState *exec, const Identifier &p) const
 {
   // we don't want any operations on a closed window
-  if (m_part.isNull())
+  if (m_frame.isNull() || m_frame->m_part.isNull())
     return ( p == "closed" );
 
   if (ObjectImp::hasProperty(exec, p))
@@ -417,22 +430,26 @@
   if (Lookup::findEntry(&WindowTable, p))
     return true;
 
+  KHTMLPart *part = ::qt_cast<KHTMLPart *>(m_frame->m_part);
+  if (!part)
+      return false;
+
   QString q = p.qstring();
-  if (m_part->findFrame(p.qstring()))
+  if (part->findFramePart(p.qstring()))
     return true;
   // allow window[1] or parent[1] etc. (#56983)
   bool ok;
   unsigned int i = p.toArrayIndex(&ok);
   if (ok) {
-    QPtrList<KParts::ReadOnlyPart> frames = m_part->frames();
+    QPtrList<KParts::ReadOnlyPart> frames = part->frames();
     unsigned int len = frames.count();
     if (i < len)
       return true;
   }
 
   // allow shortcuts like 'Image1' instead of document.images.Image1
-  if (m_part->document().isHTMLDocument()) { // might be XML
-    DOM::HTMLDocument doc = m_part->htmlDocument();
+  if (part->document().isHTMLDocument()) { // might be XML
+    DOM::HTMLDocument doc = part->htmlDocument();
     // Keep in sync with tryGet
     NamedTagLengthDeterminer::TagLength tags[3] = {
       {ID_IMG, 0, 0L}, {ID_FORM, 0, 0L}, {ID_APPLET, 0, 0L}
@@ -459,7 +476,7 @@
   kdDebug(6070) << "Window("<<this<<")::get " << p.qstring() << endl;
 #endif
   // we don't want any operations on a closed window
-  if (m_part.isNull()) {
+  if (m_frame.isNull() || m_frame->m_part.isNull()) {
     if ( p == "closed" )
       return Boolean( true );
     return Undefined();
@@ -473,29 +490,38 @@
   }
 
   const HashEntry* entry = Lookup::findEntry(&WindowTable, p);
+  KHTMLPart *part = ::qt_cast<KHTMLPart *>(m_frame->m_part);
 
   // properties that work on all windows
   if (entry) {
+    // ReadOnlyPart first
     switch(entry->value) {
     case Closed:
       return Boolean( false );
-      case _Location:
+    case _Location:
         // No isSafeScript test here, we must be able to _set_ location.href (#49819)
-        return Value(location());
+      return Value(location());
+    case _Window:
+    case Self:
+      return retrieve(m_frame->m_part);
+    default:
+        break;
+    }
+    if (!part)
+        return Undefined();
+    // KHTMLPart next
+    switch(entry->value) {
     case Frames:
       return Value(frames(exec));
     case Opener:
-      if (!m_part->opener())
+      if (!part->opener())
         return Null();    // ### a null Window might be better, but == null
       else                // doesn't work yet
-        return retrieve(m_part->opener());
+        return retrieve(part->opener());
     case Parent:
-      return retrieve(m_part->parentPart() ? m_part->parentPart() : (KHTMLPart*)m_part);
-    case _Window:
-    case Self:
-      return retrieve(m_part);
+      return retrieve(part->parentPart() ? part->parentPart() : (KHTMLPart*)part);
     case Top: {
-      KHTMLPart *p = m_part;
+      KHTMLPart *p = part;
       while (p->parentPart())
         p = p->parentPart();
       return retrieve(p);
@@ -510,8 +536,17 @@
     default:
       break;
     }
+  } else if (!part) {
+    // not a  KHTMLPart
+    QString rvalue;
+    KParts::LiveConnectExtension::Type rtype;
+    unsigned long robjid;
+    if (m_frame->m_liveconnect &&
+        isSafeScript(exec) &&
+        m_frame->m_liveconnect->get(0, p.qstring(), rtype, robjid, rvalue))
+      return getLiveConnectValue(m_frame->m_liveconnect, p.qstring(), rtype, rvalue, robjid);
+    return Undefined();
   }
-
   // properties that only work on safe windows
   if (isSafeScript(exec) &&  entry)
   {
@@ -520,17 +555,17 @@
     case Crypto:
       return Undefined(); // ###
     case DefaultStatus:
-      return String(UString(m_part->jsDefaultStatusBarText()));
+      return String(UString(part->jsDefaultStatusBarText()));
     case Status:
-      return String(UString(m_part->jsStatusBarText()));
+      return String(UString(part->jsStatusBarText()));
     case Document:
-      if (m_part->document().isNull()) {
+      if (part->document().isNull()) {
         kdDebug(6070) << "Document.write: adding <HTML><BODY> to create document" << endl;
-        m_part->begin();
-        m_part->write("<HTML><BODY>");
-        m_part->end();
+        part->begin();
+        part->write("<HTML><BODY>");
+        part->end();
       }
-      return getDOMNode(exec,m_part->document());
+      return getDOMNode(exec,part->document());
     case Node:
       return getNodeConstructor(exec);
     case Range:
@@ -545,48 +580,48 @@
       return getEventConstructor(exec);
     case _History:
       return Value(history ? history :
-                   (const_cast<Window*>(this)->history = new History(exec,m_part)));
+                   (const_cast<Window*>(this)->history = new History(exec,part)));
 
     case _External:
       return Value(external ? external :
-                   (const_cast<Window*>(this)->external = new External(exec,m_part)));
+                   (const_cast<Window*>(this)->external = new External(exec,part)));
 
     case Event:
       if (m_evt)
         return getDOMEvent(exec,*m_evt);
       else {
 #ifdef KJS_VERBOSE
-        kdDebug(6070) << "WARNING: window(" << this << "," << m_part->name() << ").event, no event!" << endl;
+        kdDebug(6070) << "WARNING: window(" << this << "," << part->name() << ").event, no event!" << endl;
 #endif
         return Undefined();
       }
     case InnerHeight:
-      if (!m_part->view())
+      if (!part->view())
         return Undefined();
       khtml::RenderWidget::flushWidgetResizes(); // make sure frames have their final size
-      return Number(m_part->view()->visibleHeight());
+      return Number(part->view()->visibleHeight());
     case InnerWidth:
-      if (!m_part->view())
+      if (!part->view())
         return Undefined();
       khtml::RenderWidget::flushWidgetResizes(); // make sure frames have their final size
-      return Number(m_part->view()->visibleWidth());
+      return Number(part->view()->visibleWidth());
     case Length:
-      return Number(m_part->frames().count());
+      return Number(part->frames().count());
     case Name:
-      return String(m_part->name());
+      return String(part->name());
     case SideBar:
-      return Value(new MozillaSidebarExtension(exec, m_part));
+      return Value(new MozillaSidebarExtension(exec, part));
     case _Navigator:
     case ClientInformation: {
       // Store the navigator in the object so we get the same one each time.
-      Value nav( new Navigator(exec, m_part) );
+      Value nav( new Navigator(exec, part) );
       const_cast<Window *>(this)->put(exec, "navigator", nav, DontDelete|ReadOnly|Internal);
       const_cast<Window *>(this)->put(exec, "clientInformation", nav, DontDelete|ReadOnly|Internal);
       return nav;
     }
 #ifdef Q_WS_QWS
     case _Konqueror: {
-      Value k( new Konqueror(exec, m_part) );
+      Value k( new Konqueror(exec, part) );
       const_cast<Window *>(this)->put(exec, "konqueror", k, DontDelete|ReadOnly|Internal);
       return k;
     }
@@ -596,41 +631,41 @@
     case OuterHeight:
     case OuterWidth:
     {
-      if (!m_part->widget())
+      if (!part->widget())
         return Number(0);
-      KWin::WindowInfo inf = KWin::windowInfo(m_part->widget()->topLevelWidget()->winId());
+      KWin::WindowInfo inf = KWin::windowInfo(part->widget()->topLevelWidget()->winId());
       return Number(entry->value == OuterHeight ?
                     inf.geometry().height() : inf.geometry().width());
     }
     case PageXOffset:
-      return Number(m_part->view()->contentsX());
+      return Number(part->view()->contentsX());
     case PageYOffset:
-      return Number(m_part->view()->contentsY());
+      return Number(part->view()->contentsY());
     case Personalbar:
       return Undefined(); // ###
     case ScreenLeft:
     case ScreenX: {
-      if (!m_part->view())
+      if (!part->view())
         return Undefined();
-      QRect sg = KGlobalSettings::desktopGeometry(m_part->view());
-      return Number(m_part->view()->mapToGlobal(QPoint(0,0)).x() + sg.x());
+      QRect sg = KGlobalSettings::desktopGeometry(part->view());
+      return Number(part->view()->mapToGlobal(QPoint(0,0)).x() + sg.x());
     }
     case ScreenTop:
     case ScreenY: {
-      if (!m_part->view())
+      if (!part->view())
         return Undefined();
-      QRect sg = KGlobalSettings::desktopGeometry(m_part->view());
-      return Number(m_part->view()->mapToGlobal(QPoint(0,0)).y() + sg.y());
+      QRect sg = KGlobalSettings::desktopGeometry(part->view());
+      return Number(part->view()->mapToGlobal(QPoint(0,0)).y() + sg.y());
     }
     case ScrollX: {
-      if (!m_part->view())
+      if (!part->view())
         return Undefined();
-      return Number(m_part->view()->contentsX());
+      return Number(part->view()->contentsX());
     }
     case ScrollY: {
-      if (!m_part->view())
+      if (!part->view())
         return Undefined();
-      return Number(m_part->view()->contentsY());
+      return Number(part->view()->contentsY());
     }
     case Scrollbars:
       return Undefined(); // ###
@@ -638,11 +673,11 @@
       return Value(screen ? screen :
                    (const_cast<Window*>(this)->screen = new Screen(exec)));
     case Image:
-      return Value(new ImageConstructorImp(exec, m_part->document()));
+      return Value(new ImageConstructorImp(exec, part->document()));
     case Option:
-      return Value(new OptionConstructorImp(exec, m_part->document()));
+      return Value(new OptionConstructorImp(exec, part->document()));
     case XMLHttpRequest:
-      return Value(new XMLHttpRequestConstructorImp(exec, m_part->document()));
+      return Value(new XMLHttpRequestConstructorImp(exec, part->document()));
     case XMLSerializer:
       return Value(new XMLSerializerConstructorImp(exec));
     case Close:
@@ -718,35 +753,33 @@
       return getListener(exec,DOM::EventImpl::UNLOAD_EVENT);
     }
   }
-  KHTMLPart *kp = m_part->findFrame( p.qstring() );
-  if (kp)
-    return retrieve(kp);
+  KParts::ReadOnlyPart *rop = part->findFramePart( p.qstring() );
+  if (rop)
+    return retrieve(rop);
 
   // allow window[1] or parent[1] etc. (#56983)
   bool ok;
   unsigned int i = p.toArrayIndex(&ok);
   if (ok) {
-    QPtrList<KParts::ReadOnlyPart> frames = m_part->frames();
+    QPtrList<KParts::ReadOnlyPart> frames = part->frames();
     unsigned int len = frames.count();
     if (i < len) {
       KParts::ReadOnlyPart* frame = frames.at(i);
-      if (frame && ::qt_cast<KHTMLPart*>(frame)) {
-        KHTMLPart *khtml = static_cast<KHTMLPart*>(frame);
-        return Window::retrieve(khtml);
-      }
+      if (frame)
+        return Window::retrieve(frame);
     }
   }
 
   // allow shortcuts like 'Image1' instead of document.images.Image1
   if (isSafeScript(exec) &&
-      m_part->document().isHTMLDocument()) { // might be XML
-    // This is only for images, forms and applets, see KJS::HTMLDocument::tryGet
-    DOM::HTMLDocument doc = m_part->htmlDocument();
-    NamedTagLengthDeterminer::TagLength tags[3] = {
-      {ID_IMG, 0, 0L}, {ID_FORM, 0, 0L}, {ID_APPLET, 0, 0L}
+      part->document().isHTMLDocument()) { // might be XML
+    // This is only for images, forms, layers and applets, see KJS::HTMLDocument::tryGet
+    DOM::HTMLDocument doc = part->htmlDocument();
+    NamedTagLengthDeterminer::TagLength tags[4] = {
+      {ID_IMG, 0, 0L}, {ID_FORM, 0, 0L}, {ID_APPLET, 0, 0L}, {ID_LAYER, 0, 0L}
     };
-    NamedTagLengthDeterminer(p.string(), tags, 3)(doc.handle());
-    for (int i = 0; i < 3; i++)
+    NamedTagLengthDeterminer(p.string(), tags, 4)(doc.handle());
+    for (int i = 0; i < 4; i++)
       if (tags[i].length > 0) {
         if (tags[i].length == 1)
           return getDOMNode(exec, tags[i].last);
@@ -780,31 +813,37 @@
   }
 
   const HashEntry* entry = Lookup::findEntry(&WindowTable, propertyName);
-  if (entry && !m_part.isNull())
+  if (entry && !m_frame.isNull() && !m_frame->m_part.isNull())
   {
 #ifdef KJS_VERBOSE
     kdDebug(6070) << "Window("<<this<<")::put " << propertyName.qstring() << endl;
 #endif
+    switch( entry->value) {
+    case _Location:
+      goURL(exec, value.toString(exec).qstring(), false /*don't lock history*/);
+      return;
+    default:
+      break;
+    }
+    KHTMLPart *part = ::qt_cast<KHTMLPart *>(m_frame->m_part);
+    if (part) {
     switch( entry->value ) {
     case Status: {
-      if  (isSafeScript(exec) && m_part->settings()->windowStatusPolicy(m_part->url().host())
+      if  (isSafeScript(exec) && part->settings()->windowStatusPolicy(part->url().host())
 		== KHTMLSettings::KJSWindowStatusAllow) {
       String s = value.toString(exec);
-      m_part->setJSStatusBarText(s.value().qstring());
+      part->setJSStatusBarText(s.value().qstring());
       }
       return;
     }
     case DefaultStatus: {
-      if (isSafeScript(exec) && m_part->settings()->windowStatusPolicy(m_part->url().host())
+      if (isSafeScript(exec) && part->settings()->windowStatusPolicy(part->url().host())
 		== KHTMLSettings::KJSWindowStatusAllow) {
       String s = value.toString(exec);
-      m_part->setJSDefaultStatusBarText(s.value().qstring());
+      part->setJSDefaultStatusBarText(s.value().qstring());
       }
       return;
     }
-    case _Location:
-      goURL(exec, value.toString(exec).qstring(), false /*don't lock history*/);
-      return;
     case Onabort:
       if (isSafeScript(exec))
         setListener(exec, DOM::EventImpl::ABORT_EVENT,value);
@@ -899,12 +938,17 @@
       return;
     case Name:
       if (isSafeScript(exec))
-        m_part->setName( value.toString(exec).qstring().local8Bit().data() );
+        part->setName( value.toString(exec).qstring().local8Bit().data() );
       return;
     default:
       break;
     }
+    }
   }
+  if (m_frame->m_liveconnect &&
+      isSafeScript(exec) &&
+      m_frame->m_liveconnect->put(0, propertyName.qstring(), value.toString(exec).qstring()))
+    return;
   if (isSafeScript(exec)) {
     //kdDebug(6070) << "Window("<<this<<")::put storing " << propertyName.qstring() << endl;
     ObjectImp::put(exec, propertyName, value, attr);
@@ -913,27 +957,32 @@
 
 bool Window::toBoolean(ExecState *) const
 {
-  return !m_part.isNull();
+  return !m_frame.isNull() && !m_frame->m_part.isNull();
 }
 
 void Window::scheduleClose()
 {
-  kdDebug(6070) << "Window::scheduleClose window.close() " << m_part << endl;
+  kdDebug(6070) << "Window::scheduleClose window.close() " << m_frame << endl;
   Q_ASSERT(winq);
   QTimer::singleShot( 0, winq, SLOT( timeoutClose() ) );
 }
 
 void Window::closeNow()
 {
-  if (!m_part.isNull())
-  {
-    //kdDebug(6070) << k_funcinfo << " -> closing window" << endl;
-    // We want to make sure that window.open won't find this part by name.
-    m_part->setName( 0 );
-    m_part->deleteLater();
-    m_part = 0;
-  } else
+  if (m_frame.isNull() || m_frame->m_part.isNull()) {
     kdDebug(6070) << k_funcinfo << "part is deleted already" << endl;
+  } else {
+    KHTMLPart *part = ::qt_cast<KHTMLPart *>(m_frame->m_part);
+    if (!part) {
+      kdDebug(6070) << "closeNow on non KHTML part" << endl;
+    } else {
+      //kdDebug(6070) << k_funcinfo << " -> closing window" << endl;
+      // We want to make sure that window.open won't find this part by name.
+      part->setName( 0 );
+      part->deleteLater();
+      part = 0;
+    }
+  }
 }
 
 void Window::afterScriptExecution()
@@ -958,9 +1007,9 @@
   }
 }
 
-bool Window::checkIsSafeScript(KHTMLPart *activePart) const
+bool Window::checkIsSafeScript(KParts::ReadOnlyPart *activePart) const
 {
-  if (m_part.isNull()) { // part deleted ? can't grant access
+  if (m_frame.isNull() || m_frame->m_part.isNull()) { // part deleted ? can't grant access
     kdDebug(6070) << "Window::isSafeScript: accessing deleted part !" << endl;
     return false;
   }
@@ -968,19 +1017,27 @@
     kdDebug(6070) << "Window::isSafeScript: current interpreter's part is 0L!" << endl;
     return false;
   }
-   if ( activePart == m_part ) // Not calling from another frame, no problem.
+   if ( activePart == m_frame->m_part ) // Not calling from another frame, no problem.
      return true;
 
-  if ( m_part->document().isNull() )
+  KHTMLPart *part = ::qt_cast<KHTMLPart *>(m_frame->m_part);
+  if (!part)
+    return true; // not a KHTMLPart
+
+  if ( part->document().isNull() )
     return true; // allow to access a window that was just created (e.g. with window.open("about:blank"))
 
-  DOM::HTMLDocument thisDocument = m_part->htmlDocument();
+  DOM::HTMLDocument thisDocument = part->htmlDocument();
   if ( thisDocument.isNull() ) {
     kdDebug(6070) << "Window::isSafeScript: trying to access an XML document !?" << endl;
     return false;
   }
 
-  DOM::HTMLDocument actDocument = activePart->htmlDocument();
+  KHTMLPart *activeKHTMLPart = ::qt_cast<KHTMLPart *>(activePart);
+  if (!activeKHTMLPart)
+    return true; // not a KHTMLPart
+
+  DOM::HTMLDocument actDocument = activeKHTMLPart->htmlDocument();
   if ( actDocument.isNull() ) {
     kdDebug(6070) << "Window::isSafeScript: active part has no document!" << endl;
     return false;
@@ -990,7 +1047,7 @@
 
   if ( actDomain == thisDomain ) {
 #ifdef KJS_VERBOSE
-    kdDebug(6070) << "JavaScript: access granted, domain is '" << actDomain.string() << "'" << endl;
+    //kdDebug(6070) << "JavaScript: access granted, domain is '" << actDomain.string() << "'" << endl;
 #endif
     return true;
   }
@@ -1002,25 +1059,27 @@
 
 void Window::setListener(ExecState *exec, int eventId, Value func)
 {
-  if (!isSafeScript(exec))
+  KHTMLPart *part = ::qt_cast<KHTMLPart *>(m_frame->m_part);
+  if (!part || !isSafeScript(exec))
     return;
-  DOM::DocumentImpl *doc = static_cast<DOM::DocumentImpl*>(m_part->htmlDocument().handle());
+  DOM::DocumentImpl *doc = static_cast<DOM::DocumentImpl*>(part->htmlDocument().handle());
   if (!doc)
     return;
 
-  doc->setWindowEventListener(eventId,getJSEventListener(func,true));
+  doc->setHTMLWindowEventListener(eventId,getJSEventListener(func,true));
 }
 
 Value Window::getListener(ExecState *exec, int eventId) const
 {
-  if (!isSafeScript(exec))
+  KHTMLPart *part = ::qt_cast<KHTMLPart *>(m_frame->m_part);
+  if (!part || !isSafeScript(exec))
     return Undefined();
-  DOM::DocumentImpl *doc = static_cast<DOM::DocumentImpl*>(m_part->htmlDocument().handle());
+  DOM::DocumentImpl *doc = static_cast<DOM::DocumentImpl*>(part->htmlDocument().handle());
   if (!doc)
     return Undefined();
 
-  DOM::EventListener *listener = doc->getWindowEventListener(eventId);
-  if (listener)
+  DOM::EventListener *listener = doc->getHTMLWindowEventListener(eventId);
+  if (listener && static_cast<JSEventListener*>(listener)->listenerObjImp())
     return static_cast<JSEventListener*>(listener)->listenerObj();
   else
     return Null();
@@ -1030,7 +1089,8 @@
 JSEventListener *Window::getJSEventListener(const Value& val, bool html)
 {
   // This function is so hot that it's worth coding it directly with imps.
-  if (val.type() != ObjectType)
+  KHTMLPart *part = ::qt_cast<KHTMLPart *>(m_frame->m_part);
+  if (!part || val.type() != ObjectType)
     return 0;
 
   // It's ObjectType, so it must be valid.
@@ -1038,10 +1098,10 @@
   ObjectImp *listenerObjectImp = listenerObject.imp();
 
   // 'listener' is not a simple ecma function. (Always use sanity checks: Better safe than sorry!)
-  if (!listenerObject.implementsCall() && m_part && m_part->jScript() && m_part->jScript()->interpreter())
+  if (!listenerObject.implementsCall() && part && part->jScript() && part->jScript()->interpreter())
   {
-    Interpreter *interpreter = m_part->jScript()->interpreter();
-    
+    Interpreter *interpreter = part->jScript()->interpreter();
+
     // 'listener' probably is an EventListener object containing a 'handleEvent' function.
     Value handleEventValue = listenerObject.get(interpreter->globalExec(), Identifier("handleEvent"));
     Object handleEventObject = Object::dynamicCast(handleEventValue);
@@ -1052,7 +1112,7 @@
       listenerObjectImp = handleEventObject.imp();
     }
   }
-  
+
   JSEventListener *existingListener = jsEventListeners[listenerObjectImp];
   if (existingListener)
     return existingListener;
@@ -1080,8 +1140,8 @@
   // Forget about the listeners (the DOM::NodeImpls will delete them)
   jsEventListeners.clear();
 
-  if (!m_part.isNull()) {
-    KJSProxy* proxy = m_part->jScript();
+  if (m_frame) {
+    KJSProxy* proxy = m_frame->m_jscript;
     if (proxy) // i.e. JS not disabled
     {
       winq = new WindowQObject(this);
@@ -1101,14 +1161,16 @@
 void Window::goURL(ExecState* exec, const QString& url, bool lockHistory)
 {
   Window* active = Window::retrieveActive(exec);
+  KHTMLPart *part = ::qt_cast<KHTMLPart *>(m_frame->m_part);
+  KHTMLPart *active_part = ::qt_cast<KHTMLPart *>(active->part());
   // Complete the URL using the "active part" (running interpreter)
-  if (active->part()) {
+  if (active_part && part) {
     if (url[0] == QChar('#')) {
-      m_part->gotoAnchor(url.mid(1));
+      part->gotoAnchor(url.mid(1));
     } else {
-      QString dstUrl = active->part()->htmlDocument().completeURL(url).string();
+      QString dstUrl = active_part->htmlDocument().completeURL(url).string();
       KURL dst( dstUrl );
-      KURL partURL( m_part->url() );
+      KURL partURL( part->url() );
       // Remove refs for the comparison
       dst.setRef( QString::null );
       partURL.setRef( QString::null );
@@ -1119,13 +1181,22 @@
       // SYNC check with khtml_part.cpp::slotRedirect!
       if ( isSafeScript(exec) ||
             dstUrl.find(QString::fromLatin1("javascript:"), 0, false) != 0 )
-          m_part->scheduleRedirection(-1,
+          part->scheduleRedirection(-1,
                                 dstUrl,
                                   lockHistory);
     }
+  } else if (!part && !m_frame->m_part.isNull()) {
+    KParts::BrowserExtension *b = KParts::BrowserExtension::childObject(m_frame->m_part);
+    if (b)
+      b->emit openURLRequest(m_frame->m_frame->element()->getDocument()->completeURL(url));
+    kdDebug() << "goURL for ROPart" << endl;
   }
 }
 
+KParts::ReadOnlyPart *Window::part() const {
+    return m_frame.isNull() ? 0L : static_cast<KParts::ReadOnlyPart *>(m_frame->m_part);
+}
+
 void Window::delayedGoHistory( int steps )
 {
     m_delayed.append( DelayedAction( DelayedGoHistory, steps ) );
@@ -1133,7 +1204,11 @@
 
 void Window::goHistory( int steps )
 {
-  KParts::BrowserExtension *ext = m_part->browserExtension();
+  KHTMLPart *part = ::qt_cast<KHTMLPart *>(m_frame->m_part);
+  if(!part)
+      // TODO history readonlypart
+    return;
+  KParts::BrowserExtension *ext = part->browserExtension();
   if(!ext)
     return;
   KParts::BrowserInterface *iface = ext->browserInterface();
@@ -1147,7 +1222,11 @@
 
 void KJS::Window::resizeTo(QWidget* tl, int width, int height)
 {
-  KParts::BrowserExtension *ext = m_part->browserExtension();
+  KHTMLPart *part = ::qt_cast<KHTMLPart *>(m_frame->m_part);
+  if(!part)
+      // TODO resizeTo readonlypart
+    return;
+  KParts::BrowserExtension *ext = part->browserExtension();
   if (!ext) {
     kdDebug(6070) << "Window::resizeTo found no browserExtension" << endl;
     return;
@@ -1166,14 +1245,9 @@
     return;
   }
 
-  // Take into account the window frame - so that (width,height) is the external window size
-  // ### (is that correct? for window.open it's the size of the HTML area...)
-  int deltaWidth = tl->frameGeometry().width() - tl->width();
-  int deltaHeight = tl->frameGeometry().height() - tl->height();
+  kdDebug(6070) << "resizing to " << width << "x" << height << endl;
 
-  kdDebug() << "resizing to " << width - deltaWidth << "x" << height - deltaHeight << endl;
-
-  emit ext->resizeTopLevelWidget( width - deltaWidth, height - deltaHeight );
+  emit ext->resizeTopLevelWidget( width, height );
 
   // If the window is out of the desktop, move it up/left
   // (maybe we should use workarea instead of sg, otherwise the window ends up below kicker)
@@ -1191,7 +1265,10 @@
 
 Value Window::openWindow(ExecState *exec, const List& args)
 {
-  KHTMLView *widget = m_part->view();
+  KHTMLPart *part = ::qt_cast<KHTMLPart *>(m_frame->m_part);
+  if (!part)
+    return Undefined();
+  KHTMLView *widget = part->view();
   Value v = args[0];
   QString str = v.toString(exec).qstring();
 
@@ -1199,7 +1276,7 @@
   KURL url;
   if (!str.isEmpty())
   {
-    KHTMLPart* p = Window::retrieveActive(exec)->m_part;
+    KHTMLPart* p = ::qt_cast<KHTMLPart *>(Window::retrieveActive(exec)->m_frame->m_part);
     if ( p )
       url = p->htmlDocument().completeURL(str).string();
     if ( !p ||
@@ -1208,12 +1285,12 @@
   }
 
   KHTMLSettings::KJSWindowOpenPolicy policy =
-		m_part->settings()->windowOpenPolicy(m_part->url().host());
+		part->settings()->windowOpenPolicy(part->url().host());
   if ( policy == KHTMLSettings::KJSWindowOpenAsk ) {
-    emit m_part->browserExtension()->requestFocus(m_part);
+    emit part->browserExtension()->requestFocus(part);
     QString caption;
-    if (!m_part->url().host().isEmpty())
-      caption = m_part->url().host() + " - ";
+    if (!part->url().host().isEmpty())
+      caption = part->url().host() + " - ";
     caption += i18n( "Confirmation: JavaScript Popup" );
     if ( KMessageBox::questionYesNo(widget,
                                     str.isEmpty() ?
@@ -1300,7 +1377,7 @@
     }
 
     KParts::URLArgs uargs;
-    KHTMLPart *p = m_part;
+    KHTMLPart *p = part;
     uargs.frameName = args.size() > 1 ?
                       args[1].toString(exec).qstring()
                       : QString("_blank");
@@ -1365,7 +1442,7 @@
   Window *window = static_cast<Window *>(thisObj.imp());
   QString str, str2;
 
-  KHTMLPart *part = window->m_part;
+  KHTMLPart *part = ::qt_cast<KHTMLPart *>(window->m_frame->m_part);
   if (!part)
     return Undefined();
 
@@ -1428,8 +1505,10 @@
 		part->settings()->windowFocusPolicy(part->url().host());
     if(policy == KHTMLSettings::KJSWindowFocusAllow && widget) {
       widget->topLevelWidget()->raise();
+      KWin::deIconifyWindow( widget->topLevelWidget()->winId() );
       widget->setActiveWindow();
-	}
+      emit part->browserExtension()->requestFocus(part);
+    }
     return Undefined();
   }
   case Window::Blur:
@@ -1625,27 +1704,21 @@
     break;
   case Window::AddEventListener: {
         JSEventListener *listener = Window::retrieveActive(exec)->getJSEventListener(args[1]);
-        DOM::Document doc = part->document();
-        if (doc.isHTMLDocument()) {
-            DOM::HTMLDocument htmlDoc = doc;
-            htmlDoc.body().addEventListener(args[0].toString(exec).string(),listener,args[2].toBoolean(exec));
+        if (listener) {
+	    DOM::DocumentImpl* docimpl = static_cast<DOM::DocumentImpl *>(part->document().handle());
+            docimpl->addWindowEventListener(DOM::EventImpl::typeToId(args[0].toString(exec).string()),listener,args[2].toBoolean(exec));
         }
-        else
-            doc.addEventListener(args[0].toString(exec).string(),listener,args[2].toBoolean(exec));
         return Undefined();
     }
   case Window::RemoveEventListener: {
         JSEventListener *listener = Window::retrieveActive(exec)->getJSEventListener(args[1]);
-        DOM::Document doc = part->document();
-        if (doc.isHTMLDocument()) {
-            DOM::HTMLDocument htmlDoc = doc;
-            htmlDoc.body().removeEventListener(args[0].toString(exec).string(),listener,args[2].toBoolean(exec));
+        if (listener) {
+	    DOM::DocumentImpl* docimpl = static_cast<DOM::DocumentImpl *>(part->document().handle());
+            docimpl->removeWindowEventListener(DOM::EventImpl::typeToId(args[0].toString(exec).string()),listener,args[2].toBoolean(exec));
         }
-        else
-            doc.removeEventListener(args[0].toString(exec).string(),listener,args[2].toBoolean(exec));
         return Undefined();
     }
-    break;
+
   }
   return Undefined();
 }
@@ -1685,7 +1758,10 @@
 
 void ScheduledAction::execute(Window *window)
 {
-  ScriptInterpreter *interpreter = static_cast<ScriptInterpreter *>(window->m_part->jScript()->interpreter());
+  KHTMLPart *part = ::qt_cast<KHTMLPart *>(window->m_frame->m_part);
+  if (!part)
+    return;
+  ScriptInterpreter *interpreter = static_cast<ScriptInterpreter *>(part->jScript()->interpreter());
 
   interpreter->setProcessingTimerCallback(true);
 
@@ -1693,10 +1769,10 @@
   if (isFunction) {
     if (func->implementsCall()) {
       // #### check this
-      Q_ASSERT( window->m_part );
-      if ( window->m_part )
+      Q_ASSERT( part );
+      if ( part )
       {
-        KJS::Interpreter *interpreter = window->m_part->jScript()->interpreter();
+        KJS::Interpreter *interpreter = part->jScript()->interpreter();
         ExecState *exec = interpreter->globalExec();
         Q_ASSERT( window == interpreter->globalObject().imp() );
         Object obj( window );
@@ -1705,12 +1781,12 @@
           exec->clearException();
 
         // Update our document's rendering following the execution of the timeout callback.
-        window->m_part->document().updateRendering();
+        part->document().updateRendering();
       }
     }
   }
   else {
-    window->m_part->executeScript(DOM::Node(), code);
+    part->executeScript(DOM::Node(), code);
   }
 
   interpreter->setProcessingTimerCallback(false);
@@ -1734,11 +1810,10 @@
   : parent(w)
 {
   //kdDebug(6070) << "WindowQObject::WindowQObject " << this << endl;
-  part = parent->m_part;
-  if ( !part )
+  if ( !parent->m_frame )
       kdDebug(6070) << "WARNING: null part in " << k_funcinfo << endl;
   else
-      connect( part, SIGNAL( destroyed() ),
+      connect( parent->m_frame, SIGNAL( destroyed() ),
                this, SLOT( parentDestroyed() ) );
   pausedTime = 0;
   lastTimerId = 0;
@@ -1799,6 +1874,11 @@
   }
 }
 
+bool WindowQObject::hasTimers() const
+{
+  return scheduledActions.count();
+}
+
 void WindowQObject::mark()
 {
   QPtrListIterator<ScheduledAction> it(scheduledActions);
@@ -1835,7 +1915,7 @@
 
     if (action->singleShot)
       scheduledActions.removeRef(action);
-    if (!parent->part().isNull())
+    if (parent->part())
       action->execute(parent);
 
     action->executing = false;
@@ -1896,7 +1976,7 @@
   }
 
   // check for the name or number
-  KParts::ReadOnlyPart *frame = part->findFrame(p.qstring());
+  KParts::ReadOnlyPart *frame = part->findFramePart(p.qstring());
   if (!frame) {
     bool ok;
     unsigned int i = p.toArrayIndex(&ok);
@@ -1907,9 +1987,8 @@
   // we are potentially fetching a reference to a another Window object here.
   // i.e. we may be accessing objects from another interpreter instance.
   // Therefore we have to be a bit careful with memory management.
-  if (frame && ::qt_cast<KHTMLPart*>(frame)) {
-    KHTMLPart *khtml = static_cast<KHTMLPart*>(frame);
-    return Window::retrieve(khtml);
+  if (frame) {
+    return Window::retrieve(frame);
   }
 
   return ObjectImp::get(exec, p);
@@ -1936,7 +2015,7 @@
 @end
 */
 IMPLEMENT_PROTOFUNC_DOM(LocationFunc)
-Location::Location(KHTMLPart *p) : m_part(p)
+Location::Location(khtml::ChildFrame *f) : m_frame(f)
 {
   //kdDebug(6070) << "Location::Location " << this << " m_part=" << (void*)m_part << endl;
 }
@@ -1946,13 +2025,17 @@
   //kdDebug(6070) << "Location::~Location " << this << " m_part=" << (void*)m_part << endl;
 }
 
+KParts::ReadOnlyPart *Location::part() const {
+  return m_frame ? static_cast<KParts::ReadOnlyPart *>(m_frame->m_part) : 0L;
+}
+
 Value Location::get(ExecState *exec, const Identifier &p) const
 {
 #ifdef KJS_VERBOSE
-  kdDebug(6070) << "Location::get " << p.qstring() << " m_part=" << (void*)m_part << endl;
+  kdDebug(6070) << "Location::get " << p.qstring() << " m_part=" << (void*)m_frame->m_part << endl;
 #endif
 
-  if (m_part.isNull())
+  if (m_frame.isNull() || m_frame->m_part.isNull())
     return Undefined();
 
   const HashEntry *entry = Lookup::findEntry(&LocationTable, p);
@@ -1962,11 +2045,11 @@
       return lookupOrCreateFunction<LocationFunc>(exec,p,this,entry->value,entry->params,entry->attr);
 
   // XSS check
-  const Window* window = Window::retrieveWindow( m_part );
+  const Window* window = Window::retrieveWindow( m_frame->m_part );
   if ( !window || !window->isSafeScript(exec) )
     return Undefined();
 
-  KURL url = m_part->url();
+  KURL url = m_frame->m_part->url();
   if (entry)
     switch (entry->value) {
     case Hash:
@@ -2013,23 +2096,23 @@
 void Location::put(ExecState *exec, const Identifier &p, const Value &v, int attr)
 {
 #ifdef KJS_VERBOSE
-  kdDebug(6070) << "Location::put " << p.qstring() << " m_part=" << (void*)m_part << endl;
+  kdDebug(6070) << "Location::put " << p.qstring() << " m_part=" << (void*)m_frame->m_part << endl;
 #endif
-  if (m_part.isNull())
+  if (m_frame.isNull() || m_frame->m_part.isNull())
     return;
 
   // XSS check
-  const Window* window = Window::retrieveWindow( m_part );
+  const Window* window = Window::retrieveWindow( m_frame->m_part );
   if ( !window || !window->isSafeScript(exec) )
     return;
 
   QString str = v.toString(exec).qstring();
-  KURL url = m_part->url();
+  KURL url = m_frame->m_part->url();
   const HashEntry *entry = Lookup::findEntry(&LocationTable, p);
   if (entry)
     switch (entry->value) {
     case Href: {
-      KHTMLPart* p = Window::retrieveActive(exec)->part();
+      KHTMLPart* p =::qt_cast<KHTMLPart*>(Window::retrieveActive(exec)->part());
       if ( p )
         url = p->htmlDocument().completeURL( str ).string();
       else
@@ -2069,26 +2152,30 @@
     return;
   }
 
-  Window::retrieveWindow(m_part)->goURL(exec, url.url(), false /* don't lock history*/ );
+  Window::retrieveWindow(m_frame->m_part)->goURL(exec, url.url(), false /* don't lock history*/ );
 }
 
 Value Location::toPrimitive(ExecState *exec, Type) const
 {
-  Window* window = Window::retrieveWindow( m_part );
-  if ( window && window->isSafeScript(exec) )
-    return String(toString(exec));
+  if (m_frame) {
+    Window* window = Window::retrieveWindow( m_frame->m_part );
+    if ( window && window->isSafeScript(exec) )
+      return String(toString(exec));
+  }
   return Undefined();
 }
 
 UString Location::toString(ExecState *exec) const
 {
-  Window* window = Window::retrieveWindow( m_part );
-  if ( window && window->isSafeScript(exec) )
-  {
-    if (!m_part->url().hasPath())
-      return m_part->url().prettyURL()+"/";
-    else
-      return m_part->url().prettyURL();
+  if (m_frame) {
+    Window* window = Window::retrieveWindow( m_frame->m_part );
+    if ( window && window->isSafeScript(exec) )
+    {
+      if (!m_frame->m_part->url().hasPath())
+        return m_frame->m_part->url().prettyURL()+"/";
+      else
+        return m_frame->m_part->url().prettyURL();
+    }
   }
   return "";
 }
@@ -2097,7 +2184,7 @@
 {
   KJS_CHECK_THIS( Location, thisObj );
   Location *location = static_cast<Location *>(thisObj.imp());
-  KHTMLPart *part = location->part();
+  KParts::ReadOnlyPart *part = location->part();
 
   if (!part) return Undefined();
 
@@ -2112,9 +2199,12 @@
     Window::retrieveWindow(part)->goURL(exec, args[0].toString(exec).qstring(),
             id == Location::Replace);
     break;
-  case Location::Reload:
-    part->scheduleRedirection(-1, part->url().url(), true/*lock history*/);
+  case Location::Reload: {
+    KHTMLPart *khtmlpart = ::qt_cast<KHTMLPart *>(part);
+    if (part)
+      khtmlpart->scheduleRedirection(-1, part->url().url(), true/*lock history*/);
     break;
+  }
   case Location::ToString:
     return String(location->toString(exec));
   }
diff -urN -x CVS kdelibs.orig/khtml/ecma/kjs_window.h kdelibs/khtml/ecma/kjs_window.h
--- kdelibs.orig/khtml/ecma/kjs_window.h	Sat Jun 12 17:41:48 2004
+++ kdelibs/khtml/ecma/kjs_window.h	Wed Nov 10 10:00:20 2004
@@ -34,6 +34,14 @@
 class KHTMLView;
 class KHTMLPart;
 
+namespace KParts {
+  class ReadOnlyPart;
+}
+
+namespace khtml {
+  class ChildFrame;
+}
+
 namespace KJS {
 
   class WindowFunc;
@@ -67,7 +75,7 @@
     friend class WindowQObject;
     friend class ScheduledAction;
   public:
-    Window(KHTMLPart *p);
+    Window(khtml::ChildFrame *p);
   public:
     ~Window();
     /**
@@ -75,17 +83,17 @@
      * for the specified part p this will be returned in order to have unique
      * bindings.
      */
-    static Value retrieve(KHTMLPart *p);
+    static Value retrieve(KParts::ReadOnlyPart *p);
     /**
-     * Returns the Window object for a given HTML part
+     * Returns the Window object for a given part
      */
-    static Window *retrieveWindow(KHTMLPart *p);
+    static Window *retrieveWindow(KParts::ReadOnlyPart *p);
     /**
      * returns a pointer to the Window object this javascript interpreting instance
      * was called from.
      */
     static Window *retrieveActive(ExecState *exec);
-    QGuardedPtr<KHTMLPart> part() const { return m_part; }
+    KParts::ReadOnlyPart *part() const;
     virtual void mark();
     virtual bool hasProperty(ExecState *exec, const Identifier &p) const;
     virtual Value get(ExecState *exec, const Identifier &propertyName) const;
@@ -100,8 +108,8 @@
     void resizeTo(QWidget* tl, int width, int height);
     void afterScriptExecution();
     bool isSafeScript(ExecState *exec) const {
-      KHTMLPart *activePart = static_cast<KJS::ScriptInterpreter *>(  exec->interpreter() )->part();
-      if ( activePart == m_part ) return true;
+        KParts::ReadOnlyPart *activePart = static_cast<KJS::ScriptInterpreter *>(  exec->interpreter() )->part();
+      if ( activePart == part() ) return true;
       return checkIsSafeScript( activePart );
     }
     Location *location() const;
@@ -142,9 +150,9 @@
     struct DelayedAction;
     friend struct DelayedAction;
 
-    bool checkIsSafeScript( KHTMLPart* activePart ) const;
+    bool checkIsSafeScript( KParts::ReadOnlyPart* activePart ) const;
 
-    QGuardedPtr<KHTMLPart> m_part;
+    QGuardedPtr<khtml::ChildFrame> m_frame;
     Screen *screen;
     History *history;
     External *external;
@@ -195,6 +203,7 @@
     int installTimeout(const Value &func, List args, int t, bool singleShot);
     void clearTimeout(int timerId);
     void mark();
+    bool hasTimers() const;
   public slots:
     void timeoutClose();
   protected slots:
@@ -204,7 +213,6 @@
     void setNextTimer();
   private:
     Window *parent;
-    KHTMLPart *part;   		// not guarded, may be dangling
     QPtrList<ScheduledAction> scheduledActions;
     int pausedTime;
     int lastTimerId;
@@ -219,13 +227,13 @@
     virtual UString toString(ExecState *exec) const;
     enum { Hash, Href, Hostname, Host, Pathname, Port, Protocol, Search, EqualEqual,
            Assign, Replace, Reload, ToString };
-    KHTMLPart *part() const { return m_part; }
+    KParts::ReadOnlyPart *part() const;
     virtual const ClassInfo* classInfo() const { return &info; }
     static const ClassInfo info;
   private:
     friend class Window;
-    Location(KHTMLPart *p);
-    QGuardedPtr<KHTMLPart> m_part;
+    Location(khtml::ChildFrame *f);
+    QGuardedPtr<khtml::ChildFrame> m_frame;
   };
 
 #ifdef Q_WS_QWS
diff -urN -x CVS kdelibs.orig/khtml/ecma/xmlhttprequest.cpp kdelibs/khtml/ecma/xmlhttprequest.cpp
--- kdelibs.orig/khtml/ecma/xmlhttprequest.cpp	Thu Oct  7 13:40:55 2004
+++ kdelibs/khtml/ecma/xmlhttprequest.cpp	Wed Nov 17 14:36:12 2004
@@ -207,7 +207,7 @@
     if (onLoadListener) onLoadListener->ref();
     break;
   default:
-    kdWarning() << "HTMLDocument::putValue unhandled token " << token << endl;
+    kdWarning() << "XMLHttpRequest::putValue unhandled token " << token << endl;
   }
 }
 
@@ -305,7 +305,6 @@
 void XMLHttpRequest::send(const QString& _body)
 {
   aborted = false;
-
   if (method.lower() == "post" && (url.protocol().lower() == "http" || url.protocol().lower() == "https") ) {
       // FIXME: determine post encoding correctly by looking in headers for charset
       job = KIO::http_post( url, QCString(_body.utf8()), false );
@@ -497,14 +496,16 @@
   slotFinished(0);
 }
 
-void XMLHttpRequest::slotFinished(KIO::Job *job)
+void XMLHttpRequest::slotFinished(KIO::Job *)
 {
   if (decoder) {
     response += decoder->flush();
   }
 
-  changeState(Completed);
+  // make sure to forget about the job before emitting completed,
+  // since changeState triggers JS code, which might e.g. call abort.
   job = 0;
+  changeState(Completed);
 
   delete decoder;
   decoder = 0;
@@ -565,7 +566,6 @@
   }
 
   XMLHttpRequest *request = static_cast<XMLHttpRequest *>(thisObj.imp());
-
   switch (id) {
   case XMLHttpRequest::Abort:
     request->abort();
@@ -585,7 +585,7 @@
   case XMLHttpRequest::Open:
     {
       if (args.size() < 2 || args.size() > 5) {
-    return Undefined();
+        return Undefined();
       }
 
       QString method = args[0].toString(exec).qstring();
@@ -624,8 +624,9 @@
       QString body;
 
       if (args.size() >= 1) {
-	if (args[0].toObject(exec).inherits(&DOMDocument::info)) {
-	  DOM::Node docNode = static_cast<KJS::DOMDocument *>(args[0].toObject(exec).imp())->toNode();
+	Object obj = Object::dynamicCast(args[0]);
+	if (!obj.isNull() && obj.inherits(&DOMDocument::info)) {
+	  DOM::Node docNode = static_cast<KJS::DOMDocument *>(obj.imp())->toNode();
 	  DOM::DocumentImpl *doc = static_cast<DOM::DocumentImpl *>(docNode.handle());
 
 	  try {
@@ -637,8 +638,6 @@
 	     exec->setException(err);
 	  }
 	} else {
-	  // converting certain values (like null) to object can set an exception
-	  exec->clearException();
 	  body = args[0].toString(exec).qstring();
 	}
       }
diff -urN -x CVS kdelibs.orig/khtml/ecma/xmlhttprequest.h kdelibs/khtml/ecma/xmlhttprequest.h
--- kdelibs.orig/khtml/ecma/xmlhttprequest.h	Thu Oct  7 13:40:55 2004
+++ kdelibs/khtml/ecma/xmlhttprequest.h	Wed Nov 17 14:37:58 2004
@@ -60,7 +60,8 @@
     virtual bool toBoolean(ExecState *) const { return true; }
     virtual const ClassInfo* classInfo() const { return &info; }
     static const ClassInfo info;
-    enum { Onload, Onreadystatechange, ReadyState, ResponseText, ResponseXML, Status, StatusText, Abort, GetAllResponseHeaders, GetResponseHeader, Open, Send, SetRequestHeader };
+    enum { Onload, Onreadystatechange, ReadyState, ResponseText, ResponseXML, Status, StatusText, Abort,
+           GetAllResponseHeaders, GetResponseHeader, Open, Send, SetRequestHeader };
 
   private:
     friend class XMLHttpRequestProtoFunc;
diff -urN -x CVS kdelibs.orig/khtml/ecma/xmlserializer.cpp kdelibs/khtml/ecma/xmlserializer.cpp
--- kdelibs.orig/khtml/ecma/xmlserializer.cpp	Fri Aug  6 18:19:11 2004
+++ kdelibs/khtml/ecma/xmlserializer.cpp	Mon Nov 29 10:55:07 2004
@@ -57,12 +57,7 @@
   return Object(new XMLSerializer(exec));
 }
 
-const ClassInfo XMLSerializer::info = { "XMLSerializer", 0, &XMLSerializerTable, 0 };
-
-/* Source for XMLSerializerTable.
-@begin XMLSerializerTable 0
-@end
-*/
+const ClassInfo XMLSerializer::info = { "XMLSerializer", 0, 0, 0 };
 
 XMLSerializer::XMLSerializer(ExecState *exec)
   : DOMObject(XMLSerializerProto::self(exec))
diff -urN -x CVS kdelibs.orig/khtml/html/Makefile.am kdelibs/khtml/html/Makefile.am
--- kdelibs.orig/khtml/html/Makefile.am	Sun Mar 21 21:39:47 2004
+++ kdelibs/khtml/html/Makefile.am	Wed Nov 10 10:00:21 2004
@@ -45,10 +45,10 @@
  -I$(top_srcdir)/kwallet/client -I$(top_srcdir)/kutils \
  $(all_includes)
 
-SRCDOC_DEST=$(kde_htmldir)/en/kdelibs/khtml
+# Use "make doctypes" to regenerate doctypes.cpp from doctypes.gperf
+doctypes: $(srcdir)/doctypes.gperf $(srcdir)/Makefile.am
+	gperf -CEot -L "ANSI-C" -k "*" -N findDoctypeEntry -F ,PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards $(srcdir)/doctypes.gperf > $(srcdir)/doctypes.cpp
 
-## generate lib documentation 
-srcdoc:
-	$(mkinstalldirs) $(SRCDOC_DEST)
-	kdoc -H -d $(SRCDOC_DEST) kdecore -lqt
+#html_documentimpl.lo: doctypes.cpp
+.PHONY: doctypes
 
diff -urN -x CVS kdelibs.orig/khtml/html/doctypes.cpp kdelibs/khtml/html/doctypes.cpp
--- kdelibs.orig/khtml/html/doctypes.cpp	Thu Jan  1 01:00:00 1970
+++ kdelibs/khtml/html/doctypes.cpp	Wed Nov 10 10:00:21 2004
@@ -0,0 +1,646 @@
+/* ANSI-C code produced by gperf version 3.0.1 */
+/* Command-line: gperf -CEot -L ANSI-C -k '*' -N findDoctypeEntry -F ,PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards ./doctypes.gperf  */
+
+#if !((' ' == 32) && ('!' == 33) && ('"' == 34) && ('#' == 35) \
+      && ('%' == 37) && ('&' == 38) && ('\'' == 39) && ('(' == 40) \
+      && (')' == 41) && ('*' == 42) && ('+' == 43) && (',' == 44) \
+      && ('-' == 45) && ('.' == 46) && ('/' == 47) && ('0' == 48) \
+      && ('1' == 49) && ('2' == 50) && ('3' == 51) && ('4' == 52) \
+      && ('5' == 53) && ('6' == 54) && ('7' == 55) && ('8' == 56) \
+      && ('9' == 57) && (':' == 58) && (';' == 59) && ('<' == 60) \
+      && ('=' == 61) && ('>' == 62) && ('?' == 63) && ('A' == 65) \
+      && ('B' == 66) && ('C' == 67) && ('D' == 68) && ('E' == 69) \
+      && ('F' == 70) && ('G' == 71) && ('H' == 72) && ('I' == 73) \
+      && ('J' == 74) && ('K' == 75) && ('L' == 76) && ('M' == 77) \
+      && ('N' == 78) && ('O' == 79) && ('P' == 80) && ('Q' == 81) \
+      && ('R' == 82) && ('S' == 83) && ('T' == 84) && ('U' == 85) \
+      && ('V' == 86) && ('W' == 87) && ('X' == 88) && ('Y' == 89) \
+      && ('Z' == 90) && ('[' == 91) && ('\\' == 92) && (']' == 93) \
+      && ('^' == 94) && ('_' == 95) && ('a' == 97) && ('b' == 98) \
+      && ('c' == 99) && ('d' == 100) && ('e' == 101) && ('f' == 102) \
+      && ('g' == 103) && ('h' == 104) && ('i' == 105) && ('j' == 106) \
+      && ('k' == 107) && ('l' == 108) && ('m' == 109) && ('n' == 110) \
+      && ('o' == 111) && ('p' == 112) && ('q' == 113) && ('r' == 114) \
+      && ('s' == 115) && ('t' == 116) && ('u' == 117) && ('v' == 118) \
+      && ('w' == 119) && ('x' == 120) && ('y' == 121) && ('z' == 122) \
+      && ('{' == 123) && ('|' == 124) && ('}' == 125) && ('~' == 126))
+/* The character set is not based on ISO-646.  */
+#error "gperf generated tables don't work with this execution character set. Please report a bug to <bug-gnu-gperf@gnu.org>."
+#endif
+
+#line 1 "./doctypes.gperf"
+struct PubIDInfo {
+    enum eMode { 
+        eQuirks,         
+        eQuirks3,       
+        eAlmostStandards
+    };
+
+    const char* name;
+    eMode mode_if_no_sysid;
+    eMode mode_if_sysid;
+};
+/* maximum key range = 178, duplicates = 0 */
+
+#ifdef __GNUC__
+__inline
+#else
+#ifdef __cplusplus
+inline
+#endif
+#endif
+static unsigned int
+hash (register const char *str, register unsigned int len)
+{
+  static const unsigned char asso_values[] =
+    {
+      241, 241, 241, 241, 241, 241, 241, 241, 241, 241,
+      241, 241, 241, 241, 241, 241, 241, 241, 241, 241,
+      241, 241, 241, 241, 241, 241, 241, 241, 241, 241,
+      241, 241,   0, 241, 241, 241, 241, 241, 241,   0,
+      241, 241, 241,   0, 241,   0,   0,   0,  10,   0,
+        5,   0,   0,   0,   0,   0, 241,   0,   0, 241,
+      241, 241, 241, 241, 241, 241, 241, 241, 241, 241,
+      241, 241, 241, 241, 241, 241, 241, 241, 241, 241,
+      241, 241, 241, 241, 241, 241, 241, 241, 241, 241,
+      241, 241, 241, 241, 241, 241, 241,   5,   0,   0,
+       10,   0,  10,   0,   0,   0, 241, 241,   0,  15,
+        5,   0,   0,   0,   0,   0,   0,   0,   0,   0,
+       10,   0,   0, 241, 241, 241, 241, 241, 241, 241,
+      241, 241, 241, 241, 241, 241, 241, 241, 241, 241,
+      241, 241, 241, 241, 241, 241, 241, 241, 241, 241,
+      241, 241, 241, 241, 241, 241, 241, 241, 241, 241,
+      241, 241, 241, 241, 241, 241, 241, 241, 241, 241,
+      241, 241, 241, 241, 241, 241, 241, 241, 241, 241,
+      241, 241, 241, 241, 241, 241, 241, 241, 241, 241,
+      241, 241, 241, 241, 241, 241, 241, 241, 241, 241,
+      241, 241, 241, 241, 241, 241, 241, 241, 241, 241,
+      241, 241, 241, 241, 241, 241, 241, 241, 241, 241,
+      241, 241, 241, 241, 241, 241, 241, 241, 241, 241,
+      241, 241, 241, 241, 241, 241, 241, 241, 241, 241,
+      241, 241, 241, 241, 241, 241, 241, 241, 241, 241,
+      241, 241, 241, 241, 241, 241
+    };
+  register int hval = len;
+
+  switch (hval)
+    {
+      default:
+        hval += asso_values[(unsigned char)str[79]];
+      /*FALLTHROUGH*/
+      case 79:
+        hval += asso_values[(unsigned char)str[78]];
+      /*FALLTHROUGH*/
+      case 78:
+        hval += asso_values[(unsigned char)str[77]];
+      /*FALLTHROUGH*/
+      case 77:
+        hval += asso_values[(unsigned char)str[76]];
+      /*FALLTHROUGH*/
+      case 76:
+        hval += asso_values[(unsigned char)str[75]];
+      /*FALLTHROUGH*/
+      case 75:
+        hval += asso_values[(unsigned char)str[74]];
+      /*FALLTHROUGH*/
+      case 74:
+        hval += asso_values[(unsigned char)str[73]];
+      /*FALLTHROUGH*/
+      case 73:
+        hval += asso_values[(unsigned char)str[72]];
+      /*FALLTHROUGH*/
+      case 72:
+        hval += asso_values[(unsigned char)str[71]];
+      /*FALLTHROUGH*/
+      case 71:
+        hval += asso_values[(unsigned char)str[70]];
+      /*FALLTHROUGH*/
+      case 70:
+        hval += asso_values[(unsigned char)str[69]];
+      /*FALLTHROUGH*/
+      case 69:
+        hval += asso_values[(unsigned char)str[68]];
+      /*FALLTHROUGH*/
+      case 68:
+        hval += asso_values[(unsigned char)str[67]];
+      /*FALLTHROUGH*/
+      case 67:
+        hval += asso_values[(unsigned char)str[66]];
+      /*FALLTHROUGH*/
+      case 66:
+        hval += asso_values[(unsigned char)str[65]];
+      /*FALLTHROUGH*/
+      case 65:
+        hval += asso_values[(unsigned char)str[64]];
+      /*FALLTHROUGH*/
+      case 64:
+        hval += asso_values[(unsigned char)str[63]];
+      /*FALLTHROUGH*/
+      case 63:
+        hval += asso_values[(unsigned char)str[62]];
+      /*FALLTHROUGH*/
+      case 62:
+        hval += asso_values[(unsigned char)str[61]];
+      /*FALLTHROUGH*/
+      case 61:
+        hval += asso_values[(unsigned char)str[60]];
+      /*FALLTHROUGH*/
+      case 60:
+        hval += asso_values[(unsigned char)str[59]];
+      /*FALLTHROUGH*/
+      case 59:
+        hval += asso_values[(unsigned char)str[58]];
+      /*FALLTHROUGH*/
+      case 58:
+        hval += asso_values[(unsigned char)str[57]];
+      /*FALLTHROUGH*/
+      case 57:
+        hval += asso_values[(unsigned char)str[56]];
+      /*FALLTHROUGH*/
+      case 56:
+        hval += asso_values[(unsigned char)str[55]];
+      /*FALLTHROUGH*/
+      case 55:
+        hval += asso_values[(unsigned char)str[54]];
+      /*FALLTHROUGH*/
+      case 54:
+        hval += asso_values[(unsigned char)str[53]];
+      /*FALLTHROUGH*/
+      case 53:
+        hval += asso_values[(unsigned char)str[52]];
+      /*FALLTHROUGH*/
+      case 52:
+        hval += asso_values[(unsigned char)str[51]];
+      /*FALLTHROUGH*/
+      case 51:
+        hval += asso_values[(unsigned char)str[50]];
+      /*FALLTHROUGH*/
+      case 50:
+        hval += asso_values[(unsigned char)str[49]];
+      /*FALLTHROUGH*/
+      case 49:
+        hval += asso_values[(unsigned char)str[48]];
+      /*FALLTHROUGH*/
+      case 48:
+        hval += asso_values[(unsigned char)str[47]];
+      /*FALLTHROUGH*/
+      case 47:
+        hval += asso_values[(unsigned char)str[46]];
+      /*FALLTHROUGH*/
+      case 46:
+        hval += asso_values[(unsigned char)str[45]];
+      /*FALLTHROUGH*/
+      case 45:
+        hval += asso_values[(unsigned char)str[44]];
+      /*FALLTHROUGH*/
+      case 44:
+        hval += asso_values[(unsigned char)str[43]];
+      /*FALLTHROUGH*/
+      case 43:
+        hval += asso_values[(unsigned char)str[42]];
+      /*FALLTHROUGH*/
+      case 42:
+        hval += asso_values[(unsigned char)str[41]];
+      /*FALLTHROUGH*/
+      case 41:
+        hval += asso_values[(unsigned char)str[40]];
+      /*FALLTHROUGH*/
+      case 40:
+        hval += asso_values[(unsigned char)str[39]];
+      /*FALLTHROUGH*/
+      case 39:
+        hval += asso_values[(unsigned char)str[38]];
+      /*FALLTHROUGH*/
+      case 38:
+        hval += asso_values[(unsigned char)str[37]];
+      /*FALLTHROUGH*/
+      case 37:
+        hval += asso_values[(unsigned char)str[36]];
+      /*FALLTHROUGH*/
+      case 36:
+        hval += asso_values[(unsigned char)str[35]];
+      /*FALLTHROUGH*/
+      case 35:
+        hval += asso_values[(unsigned char)str[34]];
+      /*FALLTHROUGH*/
+      case 34:
+        hval += asso_values[(unsigned char)str[33]];
+      /*FALLTHROUGH*/
+      case 33:
+        hval += asso_values[(unsigned char)str[32]];
+      /*FALLTHROUGH*/
+      case 32:
+        hval += asso_values[(unsigned char)str[31]];
+      /*FALLTHROUGH*/
+      case 31:
+        hval += asso_values[(unsigned char)str[30]];
+      /*FALLTHROUGH*/
+      case 30:
+        hval += asso_values[(unsigned char)str[29]];
+      /*FALLTHROUGH*/
+      case 29:
+        hval += asso_values[(unsigned char)str[28]];
+      /*FALLTHROUGH*/
+      case 28:
+        hval += asso_values[(unsigned char)str[27]];
+      /*FALLTHROUGH*/
+      case 27:
+        hval += asso_values[(unsigned char)str[26]];
+      /*FALLTHROUGH*/
+      case 26:
+        hval += asso_values[(unsigned char)str[25]];
+      /*FALLTHROUGH*/
+      case 25:
+        hval += asso_values[(unsigned char)str[24]];
+      /*FALLTHROUGH*/
+      case 24:
+        hval += asso_values[(unsigned char)str[23]];
+      /*FALLTHROUGH*/
+      case 23:
+        hval += asso_values[(unsigned char)str[22]];
+      /*FALLTHROUGH*/
+      case 22:
+        hval += asso_values[(unsigned char)str[21]];
+      /*FALLTHROUGH*/
+      case 21:
+        hval += asso_values[(unsigned char)str[20]];
+      /*FALLTHROUGH*/
+      case 20:
+        hval += asso_values[(unsigned char)str[19]];
+      /*FALLTHROUGH*/
+      case 19:
+        hval += asso_values[(unsigned char)str[18]];
+      /*FALLTHROUGH*/
+      case 18:
+        hval += asso_values[(unsigned char)str[17]];
+      /*FALLTHROUGH*/
+      case 17:
+        hval += asso_values[(unsigned char)str[16]];
+      /*FALLTHROUGH*/
+      case 16:
+        hval += asso_values[(unsigned char)str[15]];
+      /*FALLTHROUGH*/
+      case 15:
+        hval += asso_values[(unsigned char)str[14]];
+      /*FALLTHROUGH*/
+      case 14:
+        hval += asso_values[(unsigned char)str[13]];
+      /*FALLTHROUGH*/
+      case 13:
+        hval += asso_values[(unsigned char)str[12]];
+      /*FALLTHROUGH*/
+      case 12:
+        hval += asso_values[(unsigned char)str[11]];
+      /*FALLTHROUGH*/
+      case 11:
+        hval += asso_values[(unsigned char)str[10]];
+      /*FALLTHROUGH*/
+      case 10:
+        hval += asso_values[(unsigned char)str[9]];
+      /*FALLTHROUGH*/
+      case 9:
+        hval += asso_values[(unsigned char)str[8]];
+      /*FALLTHROUGH*/
+      case 8:
+        hval += asso_values[(unsigned char)str[7]];
+      /*FALLTHROUGH*/
+      case 7:
+        hval += asso_values[(unsigned char)str[6]];
+      /*FALLTHROUGH*/
+      case 6:
+        hval += asso_values[(unsigned char)str[5]];
+      /*FALLTHROUGH*/
+      case 5:
+        hval += asso_values[(unsigned char)str[4]];
+      /*FALLTHROUGH*/
+      case 4:
+        hval += asso_values[(unsigned char)str[3]];
+      /*FALLTHROUGH*/
+      case 3:
+        hval += asso_values[(unsigned char)str[2]];
+      /*FALLTHROUGH*/
+      case 2:
+        hval += asso_values[(unsigned char)str[1]];
+      /*FALLTHROUGH*/
+      case 1:
+        hval += asso_values[(unsigned char)str[0]];
+        break;
+    }
+  return hval;
+}
+
+#ifdef __GNUC__
+__inline
+#endif
+const struct PubIDInfo *
+findDoctypeEntry (register const char *str, register unsigned int len)
+{
+  enum
+    {
+      TOTAL_KEYWORDS = 41,
+      MIN_WORD_LENGTH = 21,
+      MAX_WORD_LENGTH = 80,
+      MIN_HASH_VALUE = 63,
+      MAX_HASH_VALUE = 240
+    };
+
+  static const struct PubIDInfo wordlist[] =
+    {
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 48 "./doctypes.gperf"
+      {"-//w3c//dtd w3 html//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 40 "./doctypes.gperf"
+      {"-//w3c//dtd html 3.2//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 27 "./doctypes.gperf"
+      {"-//ietf//dtd html//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 26 "./doctypes.gperf"
+      {"-//ietf//dtd html 3//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 51 "./doctypes.gperf"
+      {"-//w3o//dtd w3 html 3.0//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 52 "./doctypes.gperf"
+      {"-//w3o//dtd w3 html 3.0//en//", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 25 "./doctypes.gperf"
+      {"-//ietf//dtd html 3.2//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 21 "./doctypes.gperf"
+      {"-//ietf//dtd html 2.1e//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 22 "./doctypes.gperf"
+      {"-//ietf//dtd html 3.0//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 29 "./doctypes.gperf"
+      {"-//ietf//dtd html//en//3.0", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 23 "./doctypes.gperf"
+      {"-//ietf//dtd html 3.0//en//", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 37 "./doctypes.gperf"
+      {"-//w3c//dtd html 3 1995-03-24//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 20 "./doctypes.gperf"
+      {"-//ietf//dtd html 2.0//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 28 "./doctypes.gperf"
+      {"-//ietf//dtd html//en//2.0", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 36 "./doctypes.gperf"
+      {"-//w30//dtd w3 html 2.0//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 39 "./doctypes.gperf"
+      {"-//w3c//dtd html 3.2 final//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 19 "./doctypes.gperf"
+      {"-//ietf//dtd html 2.0 strict//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 15 "./doctypes.gperf"
+      {"-//ietf//dtd html 2.0 level 1//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 38 "./doctypes.gperf"
+      {"-//w3c//dtd html 3.2 draft//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 41 "./doctypes.gperf"
+      {"-//w3c//dtd html 3.2s draft//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 16 "./doctypes.gperf"
+      {"-//ietf//dtd html 2.0 level 2//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 17 "./doctypes.gperf"
+      {"-//ietf//dtd html 2.0 strict level 1//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 24 "./doctypes.gperf"
+      {"-//ietf//dtd html 3.2 final//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 43 "./doctypes.gperf"
+      {"-//w3c//dtd html 4.0 transitional//en", PubIDInfo::eQuirks, PubIDInfo::eQuirks},
+#line 45 "./doctypes.gperf"
+      {"-//w3c//dtd html 4.01 transitional//en", PubIDInfo::eQuirks, PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 18 "./doctypes.gperf"
+      {"-//ietf//dtd html 2.0 strict level 2//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 53 "./doctypes.gperf"
+      {"-//webtechs//dtd mozilla html 2.0//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 42 "./doctypes.gperf"
+      {"-//w3c//dtd html 4.0 frameset//en", PubIDInfo::eQuirks, PubIDInfo::eQuirks},
+#line 44 "./doctypes.gperf"
+      {"-//w3c//dtd html 4.01 frameset//en", PubIDInfo::eQuirks, PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 30 "./doctypes.gperf"
+      {"-//netscape comm. corp.//dtd html//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 50 "./doctypes.gperf"
+      {"-//w3c//dtd xhtml 1.0 transitional//en", PubIDInfo::eAlmostStandards, PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 49 "./doctypes.gperf"
+      {"-//w3c//dtd xhtml 1.0 frameset//en", PubIDInfo::eAlmostStandards, PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 31 "./doctypes.gperf"
+      {"-//o'reilly and associates//dtd html 2.0//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 47 "./doctypes.gperf"
+      {"-//w3c//dtd html experimental 970421//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 46 "./doctypes.gperf"
+      {"-//w3c//dtd html experimental 19960712//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 34 "./doctypes.gperf"
+      {"-//spyglass//dtd html 2.0 extended//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 14 "./doctypes.gperf"
+      {"-//as//dtd html 3.0 aswedit + extensions//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 35 "./doctypes.gperf"
+      {"-//sq//dtd html 2.0 hotmetal + extensions//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 13 "./doctypes.gperf"
+      {"-//advasoft ltd//dtd html 3.0 aswedit + extensions//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 33 "./doctypes.gperf"
+      {"-//softquad//dtd hotmetal pro 4.0::19971010::extensions to html 4.0//en", PubIDInfo::eQuirks, PubIDInfo::eQuirks},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 32 "./doctypes.gperf"
+      {"-//softquad software//dtd hotmetal pro 6.0::19990601::extensions to html 4.0//en", PubIDInfo::eQuirks, PubIDInfo::eQuirks}
+    };
+
+  if (len <= MAX_WORD_LENGTH && len >= MIN_WORD_LENGTH)
+    {
+      register int key = hash (str, len);
+
+      if (key <= MAX_HASH_VALUE && key >= 0)
+        {
+          register const char *s = wordlist[key].name;
+
+          if (*str == *s && !strcmp (str + 1, s + 1))
+            return &wordlist[key];
+        }
+    }
+  return 0;
+}
diff -urN -x CVS kdelibs.orig/khtml/html/doctypes.gperf kdelibs/khtml/html/doctypes.gperf
--- kdelibs.orig/khtml/html/doctypes.gperf	Thu Jan  1 01:00:00 1970
+++ kdelibs/khtml/html/doctypes.gperf	Wed Nov 10 10:00:21 2004
@@ -0,0 +1,53 @@
+struct PubIDInfo {
+    enum eMode { 
+        eQuirks,         
+        eQuirks3,       
+        eAlmostStandards
+    };
+
+    const char* name;
+    eMode mode_if_no_sysid;
+    eMode mode_if_sysid;
+}
+%%
+"-//advasoft ltd//dtd html 3.0 aswedit + extensions//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//as//dtd html 3.0 aswedit + extensions//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//ietf//dtd html 2.0 level 1//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//ietf//dtd html 2.0 level 2//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//ietf//dtd html 2.0 strict level 1//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//ietf//dtd html 2.0 strict level 2//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//ietf//dtd html 2.0 strict//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//ietf//dtd html 2.0//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//ietf//dtd html 2.1e//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//ietf//dtd html 3.0//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//ietf//dtd html 3.0//en//", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//ietf//dtd html 3.2 final//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//ietf//dtd html 3.2//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//ietf//dtd html 3//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//ietf//dtd html//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//ietf//dtd html//en//2.0", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//ietf//dtd html//en//3.0", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//netscape comm. corp.//dtd html//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//o'reilly and associates//dtd html 2.0//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//softquad software//dtd hotmetal pro 6.0::19990601::extensions to html 4.0//en", PubIDInfo::eQuirks, PubIDInfo::eQuirks
+"-//softquad//dtd hotmetal pro 4.0::19971010::extensions to html 4.0//en", PubIDInfo::eQuirks, PubIDInfo::eQuirks
+"-//spyglass//dtd html 2.0 extended//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//sq//dtd html 2.0 hotmetal + extensions//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//w30//dtd w3 html 2.0//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//w3c//dtd html 3 1995-03-24//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//w3c//dtd html 3.2 draft//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//w3c//dtd html 3.2 final//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//w3c//dtd html 3.2//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//w3c//dtd html 3.2s draft//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//w3c//dtd html 4.0 frameset//en", PubIDInfo::eQuirks, PubIDInfo::eQuirks
+"-//w3c//dtd html 4.0 transitional//en", PubIDInfo::eQuirks, PubIDInfo::eQuirks
+"-//w3c//dtd html 4.01 frameset//en", PubIDInfo::eQuirks, PubIDInfo::eAlmostStandards
+"-//w3c//dtd html 4.01 transitional//en", PubIDInfo::eQuirks, PubIDInfo::eAlmostStandards
+"-//w3c//dtd html experimental 19960712//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//w3c//dtd html experimental 970421//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//w3c//dtd w3 html//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//w3c//dtd xhtml 1.0 frameset//en", PubIDInfo::eAlmostStandards, PubIDInfo::eAlmostStandards
+"-//w3c//dtd xhtml 1.0 transitional//en", PubIDInfo::eAlmostStandards, PubIDInfo::eAlmostStandards
+"-//w3o//dtd w3 html 3.0//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//w3o//dtd w3 html 3.0//en//", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//webtechs//dtd mozilla html 2.0//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
diff -urN -x CVS kdelibs.orig/khtml/html/dtd.cpp kdelibs/khtml/html/dtd.cpp
--- kdelibs.orig/khtml/html/dtd.cpp	Wed Mar  3 13:57:32 2004
+++ kdelibs/khtml/html/dtd.cpp	Wed Nov 17 14:43:01 2004
@@ -18,7 +18,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 
 #include "html/dtd.h"
diff -urN -x CVS kdelibs.orig/khtml/html/html_baseimpl.cpp kdelibs/khtml/html/html_baseimpl.cpp
--- kdelibs.orig/khtml/html/html_baseimpl.cpp	Tue Oct  5 21:43:17 2004
+++ kdelibs/khtml/html/html_baseimpl.cpp	Wed Nov 10 10:00:21 2004
@@ -139,23 +139,23 @@
         break;
     }
     case ATTR_ONLOAD:
-        getDocument()->setWindowEventListener(EventImpl::LOAD_EVENT,
+        getDocument()->setHTMLWindowEventListener(EventImpl::LOAD_EVENT,
 	    getDocument()->createHTMLEventListener(attr->value().string(),"onload"));
         break;
     case ATTR_ONUNLOAD:
-        getDocument()->setWindowEventListener(EventImpl::UNLOAD_EVENT,
+        getDocument()->setHTMLWindowEventListener(EventImpl::UNLOAD_EVENT,
 	    getDocument()->createHTMLEventListener(attr->value().string(),"onunload"));
         break;
     case ATTR_ONBLUR:
-        getDocument()->setWindowEventListener(EventImpl::BLUR_EVENT,
+        getDocument()->setHTMLWindowEventListener(EventImpl::BLUR_EVENT,
 	    getDocument()->createHTMLEventListener(attr->value().string(),"onblur"));
         break;
     case ATTR_ONFOCUS:
-        getDocument()->setWindowEventListener(EventImpl::FOCUS_EVENT,
+        getDocument()->setHTMLWindowEventListener(EventImpl::FOCUS_EVENT,
 	    getDocument()->createHTMLEventListener(attr->value().string(),"onfocus"));
         break;
     case ATTR_ONRESIZE:
-        getDocument()->setWindowEventListener(EventImpl::RESIZE_EVENT,
+        getDocument()->setHTMLWindowEventListener(EventImpl::RESIZE_EVENT,
 	    getDocument()->createHTMLEventListener(attr->value().string(),"onresize"));
         break;
     case ATTR_NOSAVE:
@@ -376,7 +376,7 @@
     }
 }
 
-bool HTMLFrameElementImpl::isSelectable() const
+bool HTMLFrameElementImpl::isFocusable() const
 {
     return m_render!=0;
 }
@@ -530,7 +530,7 @@
 void HTMLFrameSetElementImpl::recalcStyle( StyleChange ch )
 {
     if (changed() && m_render) {
-        m_render->setLayouted(false);
+        m_render->setNeedsLayout(true);
 //         m_render->layout();
         setChanged(false);
     }
diff -urN -x CVS kdelibs.orig/khtml/html/html_baseimpl.h kdelibs/khtml/html/html_baseimpl.h
--- kdelibs.orig/khtml/html/html_baseimpl.h	Sat Apr 17 00:53:48 2004
+++ kdelibs/khtml/html/html_baseimpl.h	Wed Nov 10 10:00:21 2004
@@ -91,7 +91,7 @@
     bool noResize() { return noresize; }
     void setLocation( const DOMString& str );
 
-    virtual bool isSelectable() const;
+    virtual bool isFocusable() const;
     virtual void setFocus(bool);
 
     DocumentImpl* contentDocument() const;
diff -urN -x CVS kdelibs.orig/khtml/html/html_blockimpl.cpp kdelibs/khtml/html/html_blockimpl.cpp
--- kdelibs.orig/khtml/html/html_blockimpl.cpp	Sun Jun 13 19:08:24 2004
+++ kdelibs/khtml/html/html_blockimpl.cpp	Thu Nov 25 18:33:26 2004
@@ -3,6 +3,8 @@
  *
  * Copyright (C) 1999-2003 Lars Knoll (knoll@kde.org)
  *           (C) 1999 Antti Koivisto (koivisto@kde.org)
+ *           (C) 2003 Apple Computer, Inc.
+ *           (C) 2004 Allan Sandfeld Jensen (kde@carewolf.com)
  *
  * This library is free software; you can redistribute it and/or
  * modify it under the terms of the GNU Library General Public
@@ -19,7 +21,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 // -------------------------------------------------------------------------
 //#define DEBUG
@@ -42,10 +43,15 @@
     {
     case ATTR_ALIGN:
     {
-        DOMString v = attr->value();
-        if ( strcasecmp( attr->value(), "center" ) == 0 )
-            v = "\\2d khtml-center";
-        addCSSProperty(CSS_PROP_TEXT_ALIGN, v);
+        DOMString v = attr->value().lower();
+        if ( strcmp( v, "middle" ) == 0 || strcmp( v, "center" ) == 0 )
+            addCSSProperty(CSS_PROP_TEXT_ALIGN, CSS_VAL__KHTML_CENTER);
+        else if (strcmp(v, "left") == 0)
+            addCSSProperty(CSS_PROP_TEXT_ALIGN, CSS_VAL__KHTML_LEFT);
+        else if (strcmp(v, "right") == 0)
+            addCSSProperty(CSS_PROP_TEXT_ALIGN, CSS_VAL__KHTML_RIGHT);
+        else
+            addCSSProperty(CSS_PROP_TEXT_ALIGN, v);
         break;
     }
     default:
@@ -64,16 +70,21 @@
 {
     switch( attr->id() )
     {
-    case ATTR_ALIGN:
-        if ( strcasecmp( attr->value(), "left") != 0) // _not_ equal
-            addCSSProperty(CSS_PROP_MARGIN_LEFT, CSS_VAL_AUTO);
-        else
-            addCSSProperty(CSS_PROP_MARGIN_LEFT, "1px");
-        if( strcasecmp( attr->value(), "right") != 0)
+    case ATTR_ALIGN: {
+        if (strcasecmp(attr->value(), "left") == 0) {
+            addCSSProperty(CSS_PROP_MARGIN_LEFT, "0");
+	    addCSSProperty(CSS_PROP_MARGIN_RIGHT, CSS_VAL_AUTO);
+	}
+        else if (strcasecmp(attr->value(), "right") == 0) {
+	    addCSSProperty(CSS_PROP_MARGIN_LEFT, CSS_VAL_AUTO);
+	    addCSSProperty(CSS_PROP_MARGIN_RIGHT, "0");
+	}
+	else {
+	    addCSSProperty(CSS_PROP_MARGIN_LEFT, CSS_VAL_AUTO);
             addCSSProperty(CSS_PROP_MARGIN_RIGHT, CSS_VAL_AUTO);
-        else
-            addCSSProperty(CSS_PROP_MARGIN_RIGHT, "1px");
+	}
         break;
+    }
     case ATTR_WIDTH:
     {
         if(!attr->val()) break;
@@ -218,20 +229,20 @@
                 if (attr->value() == "-1" || strcasecmp(attr->value(), "infinite") == 0)
                     addCSSProperty(CSS_PROP__KHTML_MARQUEE_REPETITION, CSS_VAL_INFINITE);
                 else
-                    addCSSLength(CSS_PROP__KHTML_MARQUEE_REPETITION, attr->value(), true);
+                    addCSSLength(CSS_PROP__KHTML_MARQUEE_REPETITION, attr->value().lower(), true);
             }
             else
                 removeCSSProperty(CSS_PROP__KHTML_MARQUEE_REPETITION);
             break;
         case ATTR_BEHAVIOR:
             if (!attr->value().isEmpty())
-                addCSSProperty(CSS_PROP__KHTML_MARQUEE_STYLE, attr->value());
+                addCSSProperty(CSS_PROP__KHTML_MARQUEE_STYLE, attr->value().lower());
             else
                 removeCSSProperty(CSS_PROP__KHTML_MARQUEE_STYLE);
             break;
         case ATTR_DIRECTION:
             if (!attr->value().isEmpty())
-                addCSSProperty(CSS_PROP__KHTML_MARQUEE_DIRECTION, attr->value());
+                addCSSProperty(CSS_PROP__KHTML_MARQUEE_DIRECTION, attr->value().lower());
             else
                 removeCSSProperty(CSS_PROP__KHTML_MARQUEE_DIRECTION);
             break;
@@ -240,6 +251,85 @@
             break;
         default:
             HTMLElementImpl::parseAttribute(attr);
+    }
+}
+
+// ------------------------------------------------------------------------
+
+HTMLLayerElementImpl::HTMLLayerElementImpl(DocumentPtr *doc, ushort _tagid)
+    : HTMLDivElementImpl( doc, _tagid )
+{
+    absolute = false;
+    fixed = false;
+}
+
+void HTMLLayerElementImpl::parseAttribute(AttributeImpl *attr)
+{
+    // Layers are evil
+    // They are mainly implemented here to correctly parse the hidden attribute
+    switch(attr->id()) {
+        case ATTR_LEFT:
+            if (!absolute && id() == ID_LAYER) {
+                addCSSProperty(CSS_PROP_POSITION, CSS_VAL_ABSOLUTE);
+                absolute = true;
+            }
+            addCSSProperty(CSS_PROP_LEFT, attr->value());
+            break;
+        case ATTR_TOP:
+            if (!absolute && id() == ID_LAYER) {
+                addCSSProperty(CSS_PROP_POSITION, CSS_VAL_ABSOLUTE);
+                absolute = true;
+            }
+            addCSSProperty(CSS_PROP_TOP, attr->value());
+            break;
+        case ATTR_PAGEX:
+            if (!fixed) {
+                addCSSProperty(CSS_PROP_POSITION, CSS_VAL_FIXED);
+                fixed = true;
+            }
+            addCSSProperty(CSS_PROP_LEFT, attr->value());
+            break;
+        case ATTR_PAGEY:
+            if (!fixed) {
+                addCSSProperty(CSS_PROP_POSITION, CSS_VAL_FIXED);
+                fixed = true;
+            }
+            addCSSProperty(CSS_PROP_TOP, attr->value());
+            break;
+        case ATTR_WIDTH:
+            if (!attr->value().isEmpty())
+                addCSSLength(CSS_PROP_WIDTH, attr->value());
+            else
+                removeCSSProperty(CSS_PROP_WIDTH);
+            break;
+        case ATTR_HEIGHT:
+            if (!attr->value().isEmpty())
+                addCSSLength(CSS_PROP_HEIGHT, attr->value());
+            else
+                removeCSSProperty(CSS_PROP_HEIGHT);
+            break;
+        case ATTR_BGCOLOR:
+            if (!attr->value().isEmpty())
+                addHTMLColor(CSS_PROP_BACKGROUND_COLOR, attr->value());
+            else
+                removeCSSProperty(CSS_PROP_BACKGROUND_COLOR);
+            break;
+        case ATTR_Z_INDEX:
+            if (!attr->value().isEmpty())
+                addCSSProperty(CSS_PROP_Z_INDEX, attr->value());
+            else
+                removeCSSProperty(CSS_PROP_Z_INDEX);
+            break;
+        case ATTR_VISIBILITY:
+            if (attr->value().lower() == "show")
+                addCSSProperty(CSS_PROP_VISIBILITY, CSS_VAL_VISIBLE);
+            else if (attr->value().lower() == "hide")
+                addCSSProperty(CSS_PROP_VISIBILITY, CSS_VAL_HIDDEN);
+            else if (attr->value().lower() == "inherit")
+                addCSSProperty(CSS_PROP_VISIBILITY, CSS_VAL_INHERIT);
+            break;
+        default:
+            HTMLElementImpl::parseAttribute(attr);
     }
 }
 
diff -urN -x CVS kdelibs.orig/khtml/html/html_blockimpl.h kdelibs/khtml/html/html_blockimpl.h
--- kdelibs.orig/khtml/html/html_blockimpl.h	Sun Jun 13 19:08:24 2004
+++ kdelibs/khtml/html/html_blockimpl.h	Thu Nov 25 18:33:26 2004
@@ -3,6 +3,7 @@
  *
  * Copyright (C) 1999 Lars Knoll (knoll@kde.org)
  *           (C) 1999 Antti Koivisto (koivisto@kde.org)
+ *           (C) 2003 Apple Computer, Inc.
  *
  * This library is free software; you can redistribute it and/or
  * modify it under the terms of the GNU Library General Public
@@ -19,7 +20,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 
 // -------------------------------------------------------------------------
@@ -83,6 +83,19 @@
     int m_minimumDelay;
 };
 
+// -------------------------------------------------------------------------
+
+class HTMLLayerElementImpl : public HTMLDivElementImpl
+{
+public:
+    HTMLLayerElementImpl( DocumentPtr *doc, ushort _tagid );
+
+    virtual void parseAttribute(AttributeImpl *);
+private:
+    bool absolute;
+    bool fixed;
+};
+
 } //namespace
 #endif
 
diff -urN -x CVS kdelibs.orig/khtml/html/html_documentimpl.cpp kdelibs/khtml/html/html_documentimpl.cpp
--- kdelibs.orig/khtml/html/html_documentimpl.cpp	Thu Oct  7 14:35:07 2004
+++ kdelibs/khtml/html/html_documentimpl.cpp	Wed Nov 10 10:00:21 2004
@@ -57,6 +57,12 @@
 #include <stdlib.h>
 #include <qptrstack.h>
 
+// Turn off inlining to avoid warning with newer gcc.
+#undef __inline
+#define __inline
+#include "doctypes.cpp"
+#undef __inline
+
 template class QPtrStack<DOM::NodeImpl>;
 
 using namespace DOM;
@@ -239,19 +245,6 @@
         return 0;
 }
 
-static bool isTransitional(const QString &spec, int start)
-{
-    if((spec.find("TRANSITIONAL", start, false ) != -1 ) ||
-       (spec.find("LOOSE", start, false ) != -1 ) ||
-       (spec.find("FRAMESET", start, false ) != -1 ) ||
-       (spec.find("LATIN1", start, false ) != -1 ) ||
-       (spec.find("SYMBOLS", start, false ) != -1 ) ||
-       (spec.find("SPECIAL", start, false ) != -1 ) ) {
-        return true;
-    }
-    return false;
-}
-
 void HTMLDocumentImpl::close()
 {
     bool doload = !parsing() && m_tokenizer;
@@ -288,111 +281,254 @@
 }
 
 
+const int PARSEMODE_HAVE_DOCTYPE	=	(1<<0);
+const int PARSEMODE_HAVE_PUBLIC_ID	=	(1<<1);
+const int PARSEMODE_HAVE_SYSTEM_ID	=	(1<<2);
+const int PARSEMODE_HAVE_INTERNAL	=	(1<<3);
+
+static int parseDocTypePart(const QString& buffer, int index)
+{
+    while (true) {
+        QChar ch = buffer[index];
+        if (ch == ' ' || ch == '\t' || ch == '\n' || ch == '\r')
+            ++index;
+        else if (ch == '-') {
+            int tmpIndex=index;
+            if (buffer[index+1] == '-' &&
+                ((tmpIndex=buffer.find("--", index+2)) != -1))
+                index = tmpIndex+2;
+            else
+                return index;
+        }
+        else
+            return index;
+    }
+}
+
+static bool containsString(const char* str, const QString& buffer, int offset)
+{
+    QString startString(str);
+    if (offset + startString.length() > buffer.length())
+        return false;
+
+    QString bufferString = buffer.mid(offset, startString.length()).lower();
+    QString lowerStart = startString.lower();
+
+    return bufferString.startsWith(lowerStart);
+}
+
+static bool parseDocTypeDeclaration(const QString& buffer,
+                                    int* resultFlags,
+                                    QString& publicID,
+                                    QString& systemID)
+{
+    bool haveDocType = false;
+    *resultFlags = 0;
+
+    // Skip through any comments and processing instructions.
+    int index = 0;
+    do {
+        index = buffer.find('<', index);
+        if (index == -1) break;
+        QChar nextChar = buffer[index+1];
+        if (nextChar == '!') {
+            if (containsString("doctype", buffer, index+2)) {
+                haveDocType = true;
+                index += 9; // Skip "<!DOCTYPE"
+                break;
+            }
+            index = parseDocTypePart(buffer,index);
+            index = buffer.find('>', index);
+        }
+        else if (nextChar == '?')
+            index = buffer.find('>', index);
+        else
+            break;
+    } while (index != -1);
+
+    if (!haveDocType)
+        return true;
+    *resultFlags |= PARSEMODE_HAVE_DOCTYPE;
+
+    index = parseDocTypePart(buffer, index);
+    if (!containsString("html", buffer, index))
+        return false;
+
+    index = parseDocTypePart(buffer, index+4);
+    bool hasPublic = containsString("public", buffer, index);
+    if (hasPublic) {
+        index = parseDocTypePart(buffer, index+6);
+
+        // We've read <!DOCTYPE HTML PUBLIC (not case sensitive).
+        // Now we find the beginning and end of the public identifers
+        // and system identifiers (assuming they're even present).
+        QChar theChar = buffer[index];
+        if (theChar != '\"' && theChar != '\'')
+            return false;
+
+        // |start| is the first character (after the quote) and |end|
+        // is the final quote, so there are |end|-|start| characters.
+        int publicIDStart = index+1;
+        int publicIDEnd = buffer.find(theChar, publicIDStart);
+        if (publicIDEnd == -1)
+            return false;
+        index = parseDocTypePart(buffer, publicIDEnd+1);
+        QChar next = buffer[index];
+        if (next == '>') {
+            // Public identifier present, but no system identifier.
+            // Do nothing.  Note that this is the most common
+            // case.
+        }
+        else if (next == '\"' || next == '\'') {
+            // We have a system identifier.
+            *resultFlags |= PARSEMODE_HAVE_SYSTEM_ID;
+            int systemIDStart = index+1;
+            int systemIDEnd = buffer.find(next, systemIDStart);
+            if (systemIDEnd == -1)
+                return false;
+            systemID = buffer.mid(systemIDStart, systemIDEnd - systemIDStart);
+        }
+        else if (next == '[') {
+            // We found an internal subset.
+            *resultFlags |= PARSEMODE_HAVE_INTERNAL;
+        }
+        else
+            return false; // Something's wrong.
+
+        // We need to trim whitespace off the public identifier.
+        publicID = buffer.mid(publicIDStart, publicIDEnd - publicIDStart);
+        publicID = publicID.stripWhiteSpace();
+        *resultFlags |= PARSEMODE_HAVE_PUBLIC_ID;
+    } else {
+        if (containsString("system", buffer, index)) {
+            // Doctype has a system ID but no public ID
+            *resultFlags |= PARSEMODE_HAVE_SYSTEM_ID;
+            index = parseDocTypePart(buffer, index+6);
+            QChar next = buffer[index];
+            if (next != '\"' && next != '\'')
+                return false;
+            int systemIDStart = index+1;
+            int systemIDEnd = buffer.find(next, systemIDStart);
+            if (systemIDEnd == -1)
+                return false;
+            systemID = buffer.mid(systemIDStart, systemIDEnd - systemIDStart);
+            index = parseDocTypePart(buffer, systemIDEnd+1);
+        }
+
+        QChar nextChar = buffer[index];
+        if (nextChar == '[')
+            *resultFlags |= PARSEMODE_HAVE_INTERNAL;
+        else if (nextChar != '>')
+            return false;
+    }
+
+    return true;
+}
+
 void HTMLDocumentImpl::determineParseMode( const QString &str )
 {
     //kdDebug() << "DocumentImpl::determineParseMode str=" << str<< endl;
-    // determines the parse mode for HTML
-    // quite some hints here are inspired by the mozilla code.
     int oldPMode = pMode;
 
-    // default parsing mode is Loose
-    pMode = Compat;
-    hMode = Html3;
-
-    ParseMode systemId = Unknown;
-    ParseMode publicId = Unknown;
-
-    int pos = 0;
-    int doctype = str.find("!doctype", 0, false);
-    if( doctype > 2 ) {
-        pos = doctype - 2;
-        // Store doctype name
-        int start = doctype + 9;
-        while ( start < (int)str.length() && str[start].isSpace() )
-            start++;
-        int espace = str.find(' ',start);
-        QString name = str.mid(start,espace-start);
-        //kdDebug() << "DocumentImpl::determineParseMode setName: " << name << endl;
-        m_doctype->setName( name );
-    }
-
-    // get the first tag (or the doctype tag)
-    int start = str.find('<', pos);
-    int stop = str.find('>', pos);
-    if( start > -1 && stop > start ) {
-        QString spec = str.mid( start + 1, stop - start - 1 );
-        //kdDebug() << "DocumentImpl::determineParseMode dtd=" << spec<< endl;
-        start = 0;
-        int quote = -1;
-        if( doctype != -1 ) {
-            while( (quote = spec.find( "\"", start )) != -1 ) {
-                int quote2 = spec.find( "\"", quote+1 );
-                if(quote2 < 0) quote2 = spec.length();
-                QString val = spec.mid( quote+1, quote2 - quote-1 );
-                //kdDebug() << "DocumentImpl::determineParseMode val = " << val << endl;
-                // find system id
-                pos = val.find("http://www.w3.org/tr/", 0, false);
-                if ( pos != -1 ) {
-                    // loose or strict dtd?
-                    if ( val.find("strict.dtd", pos, false) != -1 )
-                        systemId = Strict;
-                    else if (isTransitional(val, pos))
-                        systemId = Transitional;
-                }
-
-                // find public id
-                pos = val.find("//dtd", 0, false );
-                if ( pos != -1 ) {
-                    if( val.find( "xhtml", pos+6, false ) != -1 ) {
-                        hMode = XHtml;
-                        publicId = isTransitional(val, pos) ? Transitional : Strict;
-                    } else if ( val.find( "15445:1999", pos+6 ) != -1 ) {
-                        hMode = Html4;
-                        publicId = Strict;
-                    } else {
-                        int tagPos = val.find( "html", pos+6, false );
-                        if( tagPos == -1 )
-                            tagPos = val.find( "hypertext markup", pos+6, false );
-                        if ( tagPos != -1 ) {
-                            tagPos = val.find(QRegExp("[0-9]"), tagPos );
-                            int version = val.mid( tagPos, 1 ).toInt();
-                            if( version > 3 ) {
-                                hMode = Html4;
-                                publicId = isTransitional( val, tagPos ) ? Transitional : Strict;
-                            }
-                        }
-                    }
-                }
-                start = quote2 + 1;
-            }
+    // This code more or less mimics Mozilla's implementation (specifically the
+    // doctype parsing implemented by David Baron in Mozilla's nsParser.cpp).
+    //
+    // There are three possible parse modes:
+    // COMPAT - quirks mode emulates WinIE
+    // and NS4.  CSS parsing is also relaxed in this mode, e.g., unit types can
+    // be omitted from numbers.
+    // ALMOST STRICT - This mode is identical to strict mode
+    // except for its treatment of line-height in the inline box model.  For
+    // now (until the inline box model is re-written), this mode is identical
+    // to STANDARDS mode.
+    // STRICT - no quirks apply.  Web pages will obey the specifications to
+    // the letter.
+
+    QString systemID, publicID;
+    int resultFlags = 0;
+    if (parseDocTypeDeclaration(str, &resultFlags, publicID, systemID)) {
+        if (resultFlags & PARSEMODE_HAVE_DOCTYPE) {
+            m_doctype->setName("HTML");
+            m_doctype->setPublicId(publicID);
+            m_doctype->setSystemId(systemID);
         }
-
-        if( systemId && systemId == publicId ) { // not unknown and both agree
-            pMode = publicId;
-        }
-        else if ( systemId == Unknown )
-            pMode = hMode == Html3 ? Compat : publicId;
-        else if ( ( publicId == Transitional && systemId == Strict ) ||
-                  ( publicId == Strict && systemId == Transitional ) ) {
-            pMode = hMode == Html3 ? Compat : Transitional;
-        } else {
+        if (!(resultFlags & PARSEMODE_HAVE_DOCTYPE)) {
+            // No doctype found at all.  Default to quirks mode and Html4.
             pMode = Compat;
+            hMode = Html4;
+        }
+        else if ((resultFlags & PARSEMODE_HAVE_INTERNAL) ||
+                 !(resultFlags & PARSEMODE_HAVE_PUBLIC_ID)) {
+            // Internal subsets always denote full standards, as does
+            // a doctype without a public ID.
+            pMode = Strict;
+            hMode = Html4;
         }
+        else {
+            // We have to check a list of public IDs to see what we
+            // should do.
+            QString lowerPubID = publicID.lower();
+            const char* pubIDStr = lowerPubID.latin1();
+
+            // Look up the entry in our gperf-generated table.
+            const PubIDInfo* doctypeEntry = findDoctypeEntry(pubIDStr, publicID.length());
+            if (!doctypeEntry) {
+                // The DOCTYPE is not in the list.  Assume strict mode.
+                pMode = Strict;
+                hMode = Html4;
+                return;
+            }
+
+            switch ((resultFlags & PARSEMODE_HAVE_SYSTEM_ID) ?
+                    doctypeEntry->mode_if_sysid :
+                    doctypeEntry->mode_if_no_sysid)
+            {
+                case PubIDInfo::eQuirks3:
+                    pMode = Compat;
+                    hMode = Html3;
+                    break;
+                case PubIDInfo::eQuirks:
+                    pMode = Compat;
+                    hMode = Html4;
+                    break;
+                case PubIDInfo::eAlmostStandards:
+                    pMode = Transitional;
+                    hMode = Html4;
+                    break;
+                 default:
+                    assert(false);
+            }
+        }
+    }
+    else {
+        // Malformed doctype implies quirks mode.
+        pMode = Compat;
+        hMode = Html3;
+    }
 
-        if ( hMode == XHtml )
-            pMode = publicId;
+    // This needs to be done last, see tests/parser/compatmode_xhtml_mixed.html
+    if ( hMode == Html4 && !m_htmlRequested ) {
+        // this part is still debatable and possibly UA dependent
+        hMode = XHtml;
+        pMode = Transitional;
     }
-    // kdDebug() << "DocumentImpl::determineParseMode: publicId =" << publicId << " systemId = " << systemId << endl;
+
+    m_styleSelector->strictParsing = !inCompatMode();
+
+    // kdDebug() << "DocumentImpl::determineParseMode: publicId =" << publicID << " systemId = " << systemID << endl;
     // kdDebug() << "DocumentImpl::determineParseMode: htmlMode = " << hMode<< endl;
     if( pMode == Strict )
-        kdDebug(6020) << " using strict parseMode" << endl;
+        kdDebug(6030) << " using strict parseMode" << endl;
     else if (pMode == Compat )
-        kdDebug(6020) << " using compatibility parseMode" << endl;
+        kdDebug(6030) << " using compatibility parseMode" << endl;
     else
-        kdDebug(6020) << " using transitional parseMode" << endl;
+        kdDebug(6030) << " using transitional parseMode" << endl;
 
+    // not sure this is needed
     if ( pMode != oldPMode && styleSelector() )
         recalcStyleSelector();
+
 }
 
+
 #include "html_documentimpl.moc"
diff -urN -x CVS kdelibs.orig/khtml/html/html_documentimpl.h kdelibs/khtml/html/html_documentimpl.h
--- kdelibs.orig/khtml/html/html_documentimpl.h	Thu Oct  7 14:35:07 2004
+++ kdelibs/khtml/html/html_documentimpl.h	Wed Nov 17 14:59:16 2004
@@ -19,13 +19,13 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 
 #ifndef HTML_DOCUMENTIMPL_H
 #define HTML_DOCUMENTIMPL_H
 
 #include "xml/dom_docimpl.h"
+#include "html/html_miscimpl.h"
 
 #include <qmap.h>
 
@@ -72,6 +72,9 @@
     virtual void close();
 
     void setAutoFill() { m_doAutoFill = true; }
+    void setHTMLRequested( bool html ) { m_htmlRequested = html; }
+
+    HTMLCollectionImpl::CollectionInfo *collectionInfo(int type) { return m_collection_info+type; }
 
 protected:
     HTMLElementImpl *htmlElement;
@@ -79,12 +82,15 @@
     friend class HTMLImageElementImpl;
     QMap<QString,HTMLMapElementImpl*> mapMap;
     bool m_doAutoFill;
+    bool m_htmlRequested;
 
 protected slots:
     /**
      * Repaints, so that all links get the proper color
      */
     void slotHistoryChanged();
+private:
+    HTMLCollectionImpl::CollectionInfo m_collection_info[HTMLCollectionImpl::LAST_TYPE];
 };
 
 } //namespace
diff -urN -x CVS kdelibs.orig/khtml/html/html_elementimpl.cpp kdelibs/khtml/html/html_elementimpl.cpp
--- kdelibs.orig/khtml/html/html_elementimpl.cpp	Tue Sep  7 12:27:19 2004
+++ kdelibs/khtml/html/html_elementimpl.cpp	Wed Nov 10 10:00:21 2004
@@ -162,7 +162,7 @@
             if ( strcasecmp(attr->value(), "middle" ) == 0 )
                 addCSSProperty( CSS_PROP_TEXT_ALIGN, CSS_VAL_CENTER );
             else
-                addCSSProperty(CSS_PROP_TEXT_ALIGN, attr->value());
+                addCSSProperty(CSS_PROP_TEXT_ALIGN, attr->value().lower());
         }
         else
             removeCSSProperty(CSS_PROP_TEXT_ALIGN);
@@ -195,7 +195,7 @@
     case ATTR_LANG:
         break;
     case ATTR_DIR:
-        addCSSProperty(CSS_PROP_DIRECTION, attr->value());
+        addCSSProperty(CSS_PROP_DIRECTION, attr->value().lower());
         addCSSProperty(CSS_PROP_UNICODE_BIDI, CSS_VAL_EMBED);
         break;
 // standard events
diff -urN -x CVS kdelibs.orig/khtml/html/html_elementimpl.h kdelibs/khtml/html/html_elementimpl.h
--- kdelibs.orig/khtml/html/html_elementimpl.h	Wed Jun  9 16:26:57 2004
+++ kdelibs/khtml/html/html_elementimpl.h	Wed Nov 17 14:43:02 2004
@@ -19,7 +19,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #ifndef HTML_ELEMENTIMPL_H
 #define HTML_ELEMENTIMPL_H
diff -urN -x CVS kdelibs.orig/khtml/html/html_formimpl.cpp kdelibs/khtml/html/html_formimpl.cpp
--- kdelibs.orig/khtml/html/html_formimpl.cpp	Tue Sep 14 17:01:34 2004
+++ kdelibs/khtml/html/html_formimpl.cpp	Thu Nov 18 01:45:16 2004
@@ -20,7 +20,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 
 #undef FORMS_DEBUG
@@ -85,6 +84,9 @@
 
 HTMLFormElementImpl::~HTMLFormElementImpl()
 {
+    if (getDocument() && getDocument()->view() && getDocument()->view()->part()) {
+        getDocument()->view()->part()->dequeueWallet(this);
+    }
     QPtrListIterator<HTMLGenericFormElementImpl> it(formElements);
     for (; it.current(); ++it)
         it.current()->m_form = 0;
@@ -173,9 +175,27 @@
     return encoded;
 }
 
+// ### This function only encodes to numeric ampersand escapes,
+// ### we could use standard ampersand values as well.
+inline static QString escapeUnencodeable(const QTextCodec* codec, const QString& s) {
+    QString enc_string;
+    const int len = s.length();
+    for(int i=0; i <len; ++i) {
+        const QChar c = s[i];
+        if (codec->canEncode(c))
+            enc_string.append(c);
+        else {
+            QString ampersandEscape;
+            ampersandEscape.sprintf("&#%u;", c.unicode());
+            enc_string.append(ampersandEscape);
+        }
+    }
+    return enc_string;
+}
+
 inline static QCString fixUpfromUnicode(const QTextCodec* codec, const QString& s)
 {
-    QCString str = codec->fromUnicode(s);
+    QCString str = codec->fromUnicode(escapeUnencodeable(codec,s));
     str.truncate(str.length());
     return str;
 }
@@ -190,26 +210,31 @@
     QCString enc_string = ""; // used for non-multipart data
 
     // find out the QTextcodec to use
-    QString str = m_acceptcharset.string();
-    QChar space(' ');
-    for(unsigned int i=0; i < str.length(); i++) if(str[i].latin1() == ',') str[i] = space;
-    QStringList charsets = QStringList::split(' ', str);
+    const QString str = m_acceptcharset.string();
+    const QChar space(' ');
+    const unsigned int strLength = str.length();
+    for(unsigned int i=0; i < strLength; ++i) if(str[i].latin1() == ',') str[i] = space;
+    const QStringList charsets = QStringList::split(' ', str);
     QTextCodec* codec = 0;
     KHTMLView *view = getDocument()->view();
-    for ( QStringList::Iterator it = charsets.begin(); it != charsets.end(); ++it )
     {
-        QString enc = (*it);
-        if(enc.contains("UNKNOWN"))
+        QStringList::ConstIterator it = charsets.begin();
+        const QStringList::ConstIterator itEnd = charsets.end();
+
+        for ( ; it != itEnd; ++it )
         {
-            // use standard document encoding
-            enc = "ISO 8859-1";
-            if(view && view->part())
-                enc = view->part()->encoding();
+            QString enc = (*it);
+            if(enc.contains("UNKNOWN"))
+            {
+                // use standard document encoding
+                enc = "ISO 8859-1";
+                if(view && view->part())
+                    enc = view->part()->encoding();
+            }
+            if((codec = KGlobal::charsets()->codecForName(enc.latin1())))
+                break;
         }
-        if((codec = KGlobal::charsets()->codecForName(enc.latin1())))
-            break;
     }
-
     if(!codec)
         codec = QTextCodec::codecForLocale();
 
@@ -219,20 +244,22 @@
 	codec = QTextCodec::codecForMib( 85 );
 
     m_encCharset = codec->name();
-    for(unsigned int i=0; i < m_encCharset.length(); i++)
+    const unsigned int m_encCharsetLength = m_encCharset.length();
+    for(unsigned int i=0; i < m_encCharsetLength; ++i)
         m_encCharset[i] = m_encCharset[i].latin1() == ' ' ? QChar('-') : m_encCharset[i].lower();
 
-    QStringList fileUploads;
+    QStringList fileUploads, fileNotUploads;
 
     for (QPtrListIterator<HTMLGenericFormElementImpl> it(formElements); it.current(); ++it) {
-        HTMLGenericFormElementImpl* current = it.current();
+        HTMLGenericFormElementImpl* const current = it.current();
         khtml::encodingList lst;
 
         if (!current->disabled() && current->encoding(codec, lst, m_multipart))
         {
-            //kdDebug(6030) << "adding name " << current->name().string() << endl;
-            khtml::encodingList::Iterator it;
-            for( it = lst.begin(); it != lst.end(); ++it )
+            //kdDebug(6030) << "adding name '" << current->name().string() << "'" << endl;
+            khtml::encodingList::ConstIterator it = lst.begin();
+            const khtml::encodingList::ConstIterator itEnd = lst.end();
+            for( it = lst.begin(); it != itEnd; ++it )
             {
                 if (!m_multipart)
                 {
@@ -267,16 +294,26 @@
                         static_cast<HTMLInputElementImpl*>(current)->inputType() == HTMLInputElementImpl::FILE &&
                         current->renderer())
                     {
-                        KURL path ( static_cast<HTMLInputElementImpl*>(current)->value().string());
+                        KURL path;
+                        QString val = static_cast<HTMLInputElementImpl*>(current)->value().string().stripWhiteSpace();
+                        if (!val.isEmpty() &&
+                            QDir::isRelativePath(val) &&
+                            QFile::exists(KGlobalSettings::documentPath() + val)) {
+                            path.setPath(KGlobalSettings::documentPath() + val);
+                        } else {
+                            path = KURL::fromPathOrURL(val);
+                        }
 
                         hstr += fixUpfromUnicode(codec, "; filename=\"" + path.fileName() + "\"");
-                        if(path.isValid()) {
+                        if (path.isValid()) {
                             fileUploads << path.prettyURL(0, KURL::StripFileProtocol);
-                            KMimeType::Ptr ptr = KMimeType::findByURL(path);
+                            const KMimeType::Ptr ptr = KMimeType::findByURL(path);
                             if (!ptr->name().isEmpty()) {
                                 hstr += "\r\nContent-Type: ";
                                 hstr += ptr->name().ascii();
                             }
+                        } else if (!val.isEmpty()) {
+                            fileNotUploads << path.prettyURL(0, KURL::StripFileProtocol);
                         }
                     }
 
@@ -284,10 +321,10 @@
                     ++it;
 
                     // append body
-                    unsigned int old_size = form_data.size();
-		    form_data.resize( old_size + hstr.length() + (*it).size() + 1); 
+                    const unsigned int old_size = form_data.size();
+		    form_data.resize( old_size + hstr.length() + (*it).size() + 1);
                     memcpy(form_data.data() + old_size, hstr.data(), hstr.length());
-		    memcpy(form_data.data() + old_size + hstr.length(), *it, (*it).size()); 
+		    memcpy(form_data.data() + old_size + hstr.length(), *it, (*it).size());
                     form_data[form_data.size()-2] = '\r';
                     form_data[form_data.size()-1] = '\n';
 
@@ -295,17 +332,32 @@
                     if (current->id() == ID_INPUT &&
                         static_cast<HTMLInputElementImpl*>(current)->inputType() == HTMLInputElementImpl::TEXT)
                         static_cast<HTMLInputElementImpl*>(current)->setUnsubmittedFormChange(false);
-                
+
                     if (current->id() == ID_TEXTAREA)
                         static_cast<HTMLTextAreaElementImpl*>(current)->setUnsubmittedFormChange(false);
 
-		}
+                }
             }
         }
     }
 
+    if (fileNotUploads.count()) {
+        const int result = KMessageBox::warningContinueCancelList( 0,
+                                                             i18n("The following files will not be uploaded"
+                                                                  " because they could not be found.\n"
+                                                                  "Do you want to continue?"),
+                                                             fileNotUploads,
+                                                             i18n("Submit Confirmation"),KGuiItem(i18n("&Submit Anyway")));
+
+
+        if (result == KMessageBox::Cancel) {
+            ok = false;
+            return QByteArray();
+        }
+    }
+
     if (fileUploads.count()) {
-        int result = KMessageBox::warningContinueCancelList( 0,
+        const int result = KMessageBox::warningContinueCancelList( 0,
                                                              i18n("You're about to transfer the following files from "
                                                                   "your local computer to the Internet.\n"
                                                                   "Do you really want to continue?"),
@@ -322,7 +374,7 @@
     if (m_multipart)
         enc_string = ("--" + m_boundary + "--\r\n").ascii();
 
-    int old_size = form_data.size();
+    const int old_size = form_data.size();
     form_data.resize( form_data.size() + enc_string.length() );
     memcpy(form_data.data() + old_size, enc_string.data(), enc_string.length() );
 
@@ -358,42 +410,52 @@
     // ensure that we have the user / password inside the url
     // otherwise we might have a potential security problem
     // by saving passwords under wrong lookup key.
-    QString name = e.getAttribute(ATTR_NAME).string().stripWhiteSpace();
-    return k.url() + '#' + name;
+    const QString name = e.getAttribute(ATTR_NAME).string().stripWhiteSpace();
+    const QRegExp re("[;,!]");
+    const QStringList url = QStringList::split(re, k.url());
+    return url[0] + '#' + name;
 }
 
 void HTMLFormElementImpl::doAutoFill()
 {
-    QString key = calculateAutoFillKey(*this);
+    const QString key = calculateAutoFillKey(*this);
 
     if (KWallet::Wallet::keyDoesNotExist(KWallet::Wallet::NetworkWallet(),
                                          KWallet::Wallet::FormDataFolder(),
-                                         key) )
+                                         key))
         return;
 
     // assert(view())
-    KWallet::Wallet* w = getDocument()->view()->part()->wallet();
+    getDocument()->view()->part()->openWallet(this);
+}
 
-    if (w) {
-        if (!w->hasFolder(KWallet::Wallet::FormDataFolder())) {
-            if (!w->createFolder(KWallet::Wallet::FormDataFolder()))
-                return; // failed
-        }
-        w->setFolder(KWallet::Wallet::FormDataFolder());
-        QMap<QString, QString> map;
-        if (w->readMap(key, map))
-            return; // failed, abort
 
-        for (QPtrListIterator<HTMLGenericFormElementImpl> it(formElements); it.current(); ++it) {
-            if (it.current()->id() == ID_INPUT) {
-                HTMLInputElementImpl* current = static_cast<HTMLInputElementImpl*>(it.current());
-                if (current->inputType() == HTMLInputElementImpl::PASSWORD ||
-                    current->inputType() == HTMLInputElementImpl::TEXT &&
-                    map.contains(current->name().string()))
-                    current->setValue(map[current->name().string()]);
+void HTMLFormElementImpl::walletOpened(KWallet::Wallet *w) {
+    assert(w);
+    const QString key = calculateAutoFillKey(*this);
+    if (!w->hasFolder(KWallet::Wallet::FormDataFolder())) {
+            return; // failed
+    }
+    w->setFolder(KWallet::Wallet::FormDataFolder());
+    QMap<QString, QString> map;
+    if (w->readMap(key, map))
+        return; // failed, abort
+
+    HTMLInputElementImpl *last = 0L;
+    for (QPtrListIterator<HTMLGenericFormElementImpl> it(formElements); it.current(); ++it) {
+        if (it.current()->id() == ID_INPUT) {
+            HTMLInputElementImpl* const current = static_cast<HTMLInputElementImpl*>(it.current());
+            if ((current->inputType() == HTMLInputElementImpl::PASSWORD ||
+                    current->inputType() == HTMLInputElementImpl::TEXT) &&
+                    !current->readOnly() &&
+                    map.contains(current->name().string())) {
+                current->setValue(map[current->name().string()]);
+                last = current;
             }
         }
     }
+
+    getDocument()->setFocusNode(last);
 }
 
 void HTMLFormElementImpl::submitFromKeyboard()
@@ -404,13 +466,13 @@
     unsigned int inputtext = 0;
     for (QPtrListIterator<HTMLGenericFormElementImpl> it(formElements); it.current(); ++it) {
         if (it.current()->id() == ID_BUTTON) {
-            HTMLButtonElementImpl* current = static_cast<HTMLButtonElementImpl *>(it.current());
+            HTMLButtonElementImpl* const current = static_cast<HTMLButtonElementImpl *>(it.current());
             if (current->buttonType() == HTMLButtonElementImpl::SUBMIT && !current->disabled()) {
                 current->activate();
                 return;
             }
         } else if (it.current()->id() == ID_INPUT) {
-            HTMLInputElementImpl* current = static_cast<HTMLInputElementImpl *>(it.current());
+            HTMLInputElementImpl* const current = static_cast<HTMLInputElementImpl *>(it.current());
             switch(current->inputType())  {
             case HTMLInputElementImpl::SUBMIT:
             case HTMLInputElementImpl::IMAGE:
@@ -429,12 +491,43 @@
         prepareSubmit();
 }
 
+
+void HTMLFormElementImpl::gatherWalletData()
+{
+    KHTMLView* const view = getDocument()->view();
+    // check if we have any password input's
+    m_walletMap.clear();
+    m_havePassword = false;
+    m_haveTextarea = false;
+    const KURL formUrl(getDocument()->URL());
+    if (!view->nonPasswordStorableSite(formUrl.host())) {
+        for (QPtrListIterator<HTMLGenericFormElementImpl> it(formElements); it.current(); ++it) {
+            if (it.current()->id() == ID_INPUT)  {
+                HTMLInputElementImpl* const c = static_cast<HTMLInputElementImpl*> (it.current());
+                if ((c->inputType() == HTMLInputElementImpl::TEXT ||
+                        c->inputType() == HTMLInputElementImpl::PASSWORD) &&
+                        !c->readOnly())  {
+                    m_walletMap.insert(c->name().string(), c->value().string());
+                    if (c->inputType() == HTMLInputElementImpl::PASSWORD &&
+                            !c->value().isEmpty())
+                        m_havePassword = true;
+                }
+            }
+            else if (it.current()->id() == ID_TEXTAREA)
+                m_haveTextarea = true;
+        }
+    }
+}
+
+
 bool HTMLFormElementImpl::prepareSubmit()
 {
-    KHTMLView *view = getDocument()->view();
+    KHTMLView* const view = getDocument()->view();
     if(m_insubmit || !view || !view->part() || view->part()->onlyLocalReferences())
         return m_insubmit;
 
+    gatherWalletData();
+
     m_insubmit = true;
     m_doingsubmit = false;
 
@@ -463,67 +556,52 @@
 #endif
 
     bool ok;
-    KHTMLView* view = getDocument()->view();
-    QByteArray form_data = formData(ok);
+    KHTMLView* const view = getDocument()->view();
+    const QByteArray form_data = formData(ok);
+    const KURL formUrl(getDocument()->URL());
 
     if (ok && view) {
-        // check if we have any password input's
-        QMap<QString, QString> walletMap;
-        bool havePassword = false;
-        bool haveTextarea = false;
-        KURL formUrl(getDocument()->URL());
-        if (!view->nonPasswordStorableSite(formUrl.host())) {
-            for (QPtrListIterator<HTMLGenericFormElementImpl> it(formElements); it.current(); ++it)
-                if (it.current()->id() == ID_INPUT)  {
-                    HTMLInputElementImpl* c = static_cast<HTMLInputElementImpl*> (it.current());
-                    if (c->inputType() == HTMLInputElementImpl::TEXT ||
-                        c->inputType() == HTMLInputElementImpl::PASSWORD)  {
-                        walletMap.insert(c->name().string(), c->value().string());
-                        if (c->inputType() == HTMLInputElementImpl::PASSWORD &&
-                            !c->value().isEmpty())
-                            havePassword = true;
-                    }
-                }
-                else if (it.current()->id() == ID_TEXTAREA)
-                    haveTextarea = true;
+        if (m_walletMap.isEmpty()) {
+            gatherWalletData();
         }
-
-        QString key = calculateAutoFillKey(*this);
-        bool doesnotexist = KWallet::Wallet::keyDoesNotExist(KWallet::Wallet::NetworkWallet(),
-                                                             KWallet::Wallet::FormDataFolder(), key);
-
-        if (havePassword && !haveTextarea ) {
-            KWallet::Wallet* w = view->part()->wallet();
-            if (w)  {
-                if (!w->hasFolder(KWallet::Wallet::FormDataFolder()))
-                    w->createFolder(KWallet::Wallet::FormDataFolder());
-                w->setFolder(KWallet::Wallet::FormDataFolder());
-                bool login_changed = false;
-                if ( !doesnotexist ) {
-                    // check if the login information changed from what
-                    // we had so far.
+        if (m_havePassword && !m_haveTextarea && KWallet::Wallet::isEnabled()) {
+            const QString key = calculateAutoFillKey(*this);
+            const bool doesnotexist = KWallet::Wallet::keyDoesNotExist(KWallet::Wallet::NetworkWallet(), KWallet::Wallet::FormDataFolder(), key);
+            KWallet::Wallet* const w = view->part()->wallet();
+            bool login_changed = false;
+
+            if (!doesnotexist && w) {
+                // check if the login information changed from what
+                // we had so far.
+                if (w->hasFolder(KWallet::Wallet::FormDataFolder())) {
+                    kdDebug() << "   -> has folder" << endl;
+                    w->setFolder(KWallet::Wallet::FormDataFolder());
                     QMap<QString, QString> map;
                     if (!w->readMap(key, map)) {
-                        for ( QMapIterator<QString, QString> it( map.begin() ); it != map.end(); ++it )
-                            if ( map[it.key()] != walletMap[it.key()] ) {
+                        QMapConstIterator<QString, QString> it = map.begin();
+                        const QMapConstIterator<QString, QString> itEnd = map.end();
+                        for ( ; it != itEnd; ++it )
+                            if ( map[it.key()] != m_walletMap[it.key()] ) {
                                 login_changed = true;
                                 break;
                             }
-                    }
-                    else
+                    } else {
                         login_changed = true;
+                    }
                 }
+                kdDebug() << "   -> login_changed=" << (login_changed ? "true" : "false" ) << endl;
+            }
 
-                if ( doesnotexist || login_changed ) {
-                    // TODO use KMessageBox::questionYesNoCancel() again, if you can pass a KGuiItem for Cancel
-                    KDialogBase* dialog = new KDialogBase(i18n("Save Login Information"),
+            if ( doesnotexist || !w || login_changed ) {
+                // TODO use KMessageBox::questionYesNoCancel() again, if you can pass a KGuiItem for Cancel
+                KDialogBase* const dialog = new KDialogBase(i18n("Save Login Information"),
                                                           KDialogBase::Yes | KDialogBase::No | KDialogBase::Cancel,
                                                           KDialogBase::Yes, KDialogBase::Cancel,
                                                           0, "questionYesNoCancel", true, true,
                                                           KStdGuiItem::yes(), KGuiItem(i18n("Never for This Site")), KStdGuiItem::no());
 
-                    bool checkboxResult = false;
-                    const int savePassword = KMessageBox::createKMessageBox(dialog, QMessageBox::Information,
+                bool checkboxResult = false;
+                const int savePassword = KMessageBox::createKMessageBox(dialog, QMessageBox::Information,
                                                                             i18n("Konqueror has the ability to store the password "
                                                                                  "in an encrypted wallet. When the wallet is unlocked, it "
                                                                                  "can then automatically restore the login information "
@@ -531,20 +609,19 @@
                                                                                  "the information now?"),
                                                                             QStringList(), QString::null, &checkboxResult, KMessageBox::Notify);
 
-                    if ( savePassword == KDialogBase::Yes ) {
-                        // ensure that we have the user / password inside the url
-                        // otherwise we might have a potential security problem
-                        // by saving passwords under wrong lookup key.
-
-                        w->setFolder(KWallet::Wallet::FormDataFolder());
-                        w->writeMap(key, walletMap);
-                    } else if ( savePassword == KDialogBase::No )
-                        view->addNonPasswordStorableSite(formUrl.host());
+                if ( savePassword == KDialogBase::Yes ) {
+                    // ensure that we have the user / password inside the url
+                    // otherwise we might have a potential security problem
+                    // by saving passwords under wrong lookup key.
+
+                    getDocument()->view()->part()->saveToWallet(key, m_walletMap);
+                } else if ( savePassword == KDialogBase::No ) {
+                    view->addNonPasswordStorableSite(formUrl.host());
                 }
             }
         }
 
-        DOMString url(khtml::parseURL(getAttribute(ATTR_ACTION)));
+        const DOMString url(khtml::parseURL(getAttribute(ATTR_ACTION)));
         if(m_post) {
             view->part()->submitForm( "post", url.string(), form_data,
                                       m_target.string(),
@@ -557,12 +634,14 @@
         }
     }
 
+    m_walletMap.clear(); // done with it
+    m_havePassword = m_haveTextarea= false;
     m_doingsubmit = m_insubmit = false;
 }
 
 void HTMLFormElementImpl::reset(  )
 {
-    KHTMLView *view = getDocument()->view();
+    KHTMLView* const view = getDocument()->view();
     if(m_inreset || !view || !view->part()) return;
 
     m_inreset = true;
@@ -629,7 +708,7 @@
 void HTMLFormElementImpl::radioClicked( HTMLGenericFormElementImpl *caller )
 {
     for (QPtrListIterator<HTMLGenericFormElementImpl> it(formElements); it.current(); ++it) {
-        HTMLGenericFormElementImpl *current = it.current();
+        HTMLGenericFormElementImpl* const current = it.current();
         if (current->id() == ID_INPUT &&
             static_cast<HTMLInputElementImpl*>(current)->inputType() == HTMLInputElementImpl::RADIO &&
             current != caller && current->form() == caller->form() && current->name() == caller->name())
@@ -677,7 +756,7 @@
 {
     HTMLElementImpl::insertedIntoDocument();
 
-    HTMLFormElementImpl* newform = getForm();
+    HTMLFormElementImpl* const newform = getForm();
 
     if (!m_form && newform) {
         m_form = newform;
@@ -699,6 +778,7 @@
 {
     if (m_form)
         m_form->removeFormElement(this);
+    if (m_name) m_name->deref();
 }
 
 void HTMLGenericFormElementImpl::parseAttribute(AttributeImpl *attr)
@@ -712,7 +792,7 @@
         break;
     case ATTR_READONLY:
     {
-        bool m_oldreadOnly = m_readOnly;
+        const bool m_oldreadOnly = m_readOnly;
         m_readOnly = attr->val() != 0;
         if (m_oldreadOnly != m_readOnly) setChanged();
         break;
@@ -764,7 +844,7 @@
 // ###
 //     DOMString n = getDocument()->htmlMode() != DocumentImpl::XHtml ?
 //                   getAttribute(ATTR_NAME) : getAttribute(ATTR_ID);
-    DOMString n = getAttribute(ATTR_NAME);
+    const DOMString n = getAttribute(ATTR_NAME);
     if (n.isNull())
         return new DOMStringImpl("");
 
@@ -798,7 +878,7 @@
     }
 }
 
-bool HTMLGenericFormElementImpl::isSelectable() const
+bool HTMLGenericFormElementImpl::isFocusable() const
 {
     return  m_render && m_render->isWidget() &&
         static_cast<RenderWidget*>(m_render)->widget() &&
@@ -815,8 +895,7 @@
 
 void HTMLGenericFormElementImpl::defaultEventHandler(EventImpl *evt)
 {
-    if (evt->target() == this && renderer() && renderer()->isWidget() &&
-        !static_cast<RenderWidget*>(renderer())->widget()->inherits("QScrollView")) {
+    if (evt->target() == this && renderer() && renderer()->isWidget()) {
         switch(evt->id())  {
         case EventImpl::MOUSEDOWN_EVENT:
         case EventImpl::MOUSEUP_EVENT:
@@ -836,10 +915,10 @@
     if (evt->target()==this && !m_disabled)
     {
         // Report focus in/out changes to the browser extension (editable widgets only)
-        KHTMLView *view = getDocument()->view();
+        KHTMLView* const view = getDocument()->view();
         if (view && evt->id() == EventImpl::DOMFOCUSIN_EVENT && isEditable() && m_render && m_render->isWidget()) {
             KHTMLPartBrowserExtension *ext = static_cast<KHTMLPartBrowserExtension *>(view->part()->browserExtension());
-            QWidget *widget = static_cast<RenderWidget*>(m_render)->widget();
+            QWidget* const widget = static_cast<RenderWidget*>(m_render)->widget();
             if (ext)
                 ext->editableWidgetFocused(widget);
         }
@@ -860,10 +939,10 @@
         }
 
 	if (evt->id() == EventImpl::KHTML_KEYPRESS_EVENT) {
-	    TextEventImpl * k = static_cast<TextEventImpl *>(evt);
-	    int key = k->qKeyEvent ? k->qKeyEvent->key() : 0;
+	    TextEventImpl* const k = static_cast<TextEventImpl *>(evt);
+	    const int key = k->qKeyEvent ? k->qKeyEvent->key() : 0;
 	    if (m_render && (key == Qt::Key_Tab || key == Qt::Key_BackTab)) {
-		QWidget *widget = static_cast<RenderWidget*>(m_render)->widget();
+		QWidget* const widget = static_cast<RenderWidget*>(m_render)->widget();
 		if (widget)
 		    static_cast<FocusHandleWidget *>(widget)
 			->focusNextPrev(key == Qt::Key_Tab);
@@ -872,8 +951,8 @@
 
 
 	if (view && evt->id() == EventImpl::DOMFOCUSOUT_EVENT && isEditable() && m_render && m_render->isWidget()) {
-	    KHTMLPartBrowserExtension *ext = static_cast<KHTMLPartBrowserExtension *>(view->part()->browserExtension());
-	    QWidget *widget = static_cast<RenderWidget*>(m_render)->widget();
+	    KHTMLPartBrowserExtension* const ext = static_cast<KHTMLPartBrowserExtension *>(view->part()->browserExtension());
+	    QWidget* const widget = static_cast<RenderWidget*>(m_render)->widget();
 	    if (ext)
 		ext->editableWidgetBlurred(widget);
 
@@ -945,7 +1024,7 @@
     if (m_type != BUTTON && !m_disabled) {
 	bool act = (evt->id() == EventImpl::DOMACTIVATE_EVENT);
 	if (!act && evt->id()==EventImpl::KEYUP_EVENT) {
-	    QKeyEvent *ke = static_cast<TextEventImpl *>(evt)->qKeyEvent;
+	    QKeyEvent* const ke = static_cast<TextEventImpl *>(evt)->qKeyEvent;
 	    if (ke && active() && (ke->key() == Qt::Key_Return || ke->key() == Qt::Key_Enter || ke->key() == Qt::Key_Space))
 		act = true;
 	}
@@ -980,7 +1059,7 @@
         return false;
 
     encoding += fixUpfromUnicode(codec, name().string());
-    QString enc_str = m_currValue.isNull() ? QString("") : m_currValue;
+    const QString enc_str = m_currValue.isNull() ? QString("") : m_currValue;
     encoding += fixUpfromUnicode(codec, enc_str);
 
     return true;
@@ -1014,7 +1093,7 @@
     assert(!m_render);
     assert(parentNode());
 
-    RenderStyle* _style = getDocument()->styleSelector()->styleForElement(this);
+    RenderStyle* const _style = getDocument()->styleSelector()->styleForElement(this);
     _style->ref();
     if (parentNode()->renderer() && _style->display() != NONE) {
         m_render = new (getDocument()->renderArena()) RenderFieldset(this);
@@ -1044,7 +1123,7 @@
     m_autocomplete = true;
     m_inited = false;
     m_unsubmittedFormChange = false;
-    
+
     xPos = 0;
     yPos = 0;
 
@@ -1148,15 +1227,18 @@
         // ignore to avoid that javascript can change a type field to file
         break;
     case ATTR_VALUE:
+        if (m_value.isNull()) // We only need to setChanged if the form is looking
+            setChanged();     // at the default value right now.
+        break;
     case ATTR_CHECKED:
-        // these are the defaults, don't change them
+        // WebCore has m_defaultChecked and m_useDefaultChecked code here....
         break;
     case ATTR_MAXLENGTH:
     {
         m_maxLen = -1;
         if (!attr->val()) break;
         bool ok;
-        int ml = attr->val()->toInt(&ok);
+        const int ml = attr->val()->toInt(&ok);
         if (ml > 0 && ml < 1024)
             m_maxLen = ml;
         else if (ok && ml <= 0)
@@ -1177,12 +1259,12 @@
     case ATTR_ACCESSKEY:
         break;
     case ATTR_WIDTH:
-        // ignore this attribute,  do _not_ add
-        // a CSS_PROP_WIDTH here!
-        // webdesigner are stupid - and IE/NS behave the same ( Dirk )
+        if ( m_type == IMAGE )
+            addCSSLength(CSS_PROP_WIDTH, attr->value() );
         break;
     case ATTR_HEIGHT:
-        addCSSLength(CSS_PROP_HEIGHT, attr->value() );
+        if ( m_type == IMAGE )
+            addCSSLength(CSS_PROP_HEIGHT, attr->value() );
         break;
     case ATTR_ONSELECT:
         setHTMLEventListener(EventImpl::SELECT_EVENT,
@@ -1204,7 +1286,7 @@
     assert(parentNode());
 
     if (!m_inited) {
-        DOMString type = getAttribute(ATTR_TYPE);
+        const DOMString type = getAttribute(ATTR_TYPE);
         if ( strcasecmp( type, "password" ) == 0 )
             m_type = PASSWORD;
         else if ( strcasecmp( type, "checkbox" ) == 0 )
@@ -1228,12 +1310,12 @@
         else
             m_type = TEXT;
 
-        if (m_type != FILE) m_value = getAttribute(ATTR_VALUE);
         if ((uint) m_type <= ISINDEX && !m_value.isEmpty()) {
-            QString value = m_value.string();
+            const QString value = m_value.string();
             // remove newline stuff..
             QString nvalue;
-            for (unsigned int i = 0; i < value.length(); ++i)
+	    unsigned int valueLength = value.length();
+            for (unsigned int i = 0; i < valueLength; ++i)
                 if (value[i] >= ' ')
                     nvalue += value[i];
             m_value = nvalue;
@@ -1253,11 +1335,13 @@
     case IMAGE:
         if (!getAttribute(ATTR_WIDTH).isNull())
             addCSSLength(CSS_PROP_WIDTH, getAttribute(ATTR_WIDTH));
+        if (!getAttribute(ATTR_HEIGHT).isNull())
+            addCSSLength(CSS_PROP_HEIGHT, getAttribute(ATTR_HEIGHT));
     default:
         break;
     };
 
-    RenderStyle* _style = getDocument()->styleSelector()->styleForElement(this);
+    RenderStyle* const _style = getDocument()->styleSelector()->styleForElement(this);
     _style->ref();
     if (parentNode()->renderer() && _style->display() != NONE) {
         switch(m_type)
@@ -1302,7 +1386,7 @@
 
 bool HTMLInputElementImpl::encoding(const QTextCodec* codec, khtml::encodingList& encoding, bool multipart)
 {
-    QString nme = name().string();
+    const QString nme = name().string();
 
     // image generates its own name's
     if (nme.isEmpty() && m_type != IMAGE) return false;
@@ -1355,9 +1439,9 @@
 
             if (m_activeSubmit)
             {
-                QString enc_str = m_value.isNull() ?
-                    static_cast<RenderSubmitButton*>(m_render)->defaultLabel() : value().string();
-
+                QString enc_str = value().string();
+                if (enc_str.isEmpty())
+                    enc_str = static_cast<RenderSubmitButton*>(m_render)->defaultLabel();
                 if(!enc_str.isEmpty())
                 {
                     encoding += fixUpfromUnicode(codec, enc_str);
@@ -1366,28 +1450,37 @@
             }
             break;
 
-        case FILE:
+	case FILE: // hmm, we have the type FILE also.  bad choice here...
         {
             // don't submit if display: none or display: hidden
             if(!renderer() || renderer()->style()->visibility() != khtml::VISIBLE)
                 return false;
 
             QString local;
-            KURL fileurl(value().string());
+            KURL fileurl;
+            QString val = value().string();
+            if (!val.isEmpty() &&
+                QDir::isRelativePath(val) &&
+                QFile::exists(KGlobalSettings::documentPath() + val)) {
+                fileurl.setPath(KGlobalSettings::documentPath() + val);
+            } else {
+                fileurl = KURL::fromPathOrURL(val);
+            }
+
             KIO::UDSEntry filestat;
 
             // can't submit file in www-url-form encoded
-            QWidget* toplevel = static_cast<RenderSubmitButton*>(m_render)->widget()->topLevelWidget();
+            QWidget* const toplevel = static_cast<RenderSubmitButton*>(m_render)->widget()->topLevelWidget();
             if (multipart) {
                 QCString filearray( "" );
                 if ( KIO::NetAccess::stat(fileurl, filestat, toplevel)) {
-                    KFileItem fileitem(filestat, fileurl, true, false);
+                    const KFileItem fileitem(filestat, fileurl, true, false);
                     if ( fileitem.isFile() &&
-                         KIO::NetAccess::download(KURL(value().string()), local, toplevel) ) {
+                         KIO::NetAccess::download(fileurl, local, toplevel) ) {
                         QFile file(local);
                         filearray.resize(file.size()+1);
                         if ( file.open( IO_ReadOnly ) ) {
-                            int readbytes = file.readBlock( filearray.data(), file.size());
+                            const int readbytes = file.readBlock( filearray.data(), file.size());
                             if ( readbytes >= 0 )
                                 filearray[readbytes] = '\0';
                             file.close();
@@ -1407,7 +1500,7 @@
             encoding += fixUpfromUnicode(codec, value().string());
             return true;
         case ISINDEX:
-            encoding += fixUpfromUnicode(codec, m_value.string());
+            encoding += fixUpfromUnicode(codec, value().string());
             return true;
     }
     return false;
@@ -1432,10 +1525,24 @@
 
 DOMString HTMLInputElementImpl::value() const
 {
-    if(m_value.isNull())
-        return (m_type == CHECKBOX || m_type ==RADIO) ?
-            DOMString("on") : DOMString("");
-
+    if (m_type == CHECKBOX || m_type == RADIO) {
+        const DOMString val = getAttribute(ATTR_VALUE);
+        // If no attribute exists, then just use "on" or "" based off the checked() state
+        // of the control.
+        if (val.isNull()) {
+            if (checked())
+                return DOMString("on");
+            else
+                return DOMString("");
+        }
+        return val;
+    }
+
+    // It's important *not* to fall back to the value attribute for file inputs,
+    // because that would allow a malicious web page to upload files by setting the
+    // value attribute in markup.
+    if (m_value.isNull() && m_type != FILE)
+        return getAttribute(ATTR_VALUE);
     return m_value;
 }
 
@@ -1465,7 +1572,7 @@
     {
 
         if (evt->isMouseEvent()) {
-	    MouseEventImpl *me = static_cast<MouseEventImpl*>(evt);
+	    MouseEventImpl* const me = static_cast<MouseEventImpl*>(evt);
             if ((m_type == RADIO || m_type == CHECKBOX)
 		&& me->id() == EventImpl::MOUSEUP_EVENT && me->detail() > 0) {
 		// click will follow
@@ -1484,7 +1591,7 @@
 	    bool check = false;
 	    if (active() && ( evt->id() == EventImpl::KEYUP_EVENT ||
 	                      evt->id() == EventImpl::KHTML_KEYPRESS_EVENT ) ) {
-		TextEventImpl *te = static_cast<TextEventImpl *>(evt);
+		TextEventImpl* const te = static_cast<TextEventImpl *>(evt);
 		if (te->keyVal() == ' ')
 		    check = true;
 	    }
@@ -1504,7 +1611,7 @@
         if (m_type == IMAGE || m_type == SUBMIT || m_type == RESET) {
 	    bool act = (evt->id() == EventImpl::DOMACTIVATE_EVENT);
 	    if (!act && evt->id() == EventImpl::KEYUP_EVENT) {
-		QKeyEvent *ke = static_cast<TextEventImpl *>(evt)->qKeyEvent;
+		QKeyEvent* const ke = static_cast<TextEventImpl *>(evt)->qKeyEvent;
 		if (ke && active() && (ke->key() == Qt::Key_Return || ke->key() == Qt::Key_Enter || ke->key() == Qt::Key_Space))
 		    act = true;
 	    }
@@ -1563,15 +1670,15 @@
 
 NodeImpl* HTMLLabelElementImpl::getFormElement()
 {
-	    DOMString formElementId = getAttribute(ATTR_FOR);
+	    const DOMString formElementId = getAttribute(ATTR_FOR);
 	    NodeImpl *newNode=0L;
     	    if (!formElementId.isEmpty())
 	        newNode=getDocument()->getElementById(formElementId);
     	    if (!newNode){
-    		uint children=childNodeCount();
-    		if (children>1) 
-    		    for (unsigned int i=0;i<children;i++){
-			uint nodeId=childNode(i)->id();
+    		const uint children=childNodeCount();
+    		if (children>1)
+    		    for (unsigned int i=0;i<children;++i){
+			const uint nodeId=childNode(i)->id();
 			if (nodeId==ID_INPUT || nodeId==ID_SELECT || nodeId==ID_TEXTAREA){
 			    newNode=childNode(i);
 			    break;
@@ -1590,13 +1697,13 @@
 	}
 	else if ( evt->id() == EventImpl::KEYUP_EVENT ||
 	                      evt->id() == EventImpl::KHTML_KEYPRESS_EVENT ) {
-	    QKeyEvent *ke = static_cast<TextEventImpl *>(evt)->qKeyEvent;
+	    QKeyEvent* const ke = static_cast<TextEventImpl *>(evt)->qKeyEvent;
 	    if (ke && active() && (ke->key() == Qt::Key_Return || ke->key() == Qt::Key_Enter || ke->key() == Qt::Key_Space))
 		act = true;
 	}
 
 	if (act) {
-	    NodeImpl *formNode=getFormElement();
+	    NodeImpl* const formNode=getFormElement();
 	    if (formNode) {
 		getDocument()->setFocusNode(formNode);
 		if (formNode->id()==ID_INPUT)
@@ -1629,7 +1736,7 @@
     assert(!attached());
     assert(!m_render);
     assert(parentNode());
-    RenderStyle* _style = getDocument()->styleSelector()->styleForElement(this);
+    RenderStyle* const _style = getDocument()->styleSelector()->styleForElement(this);
     _style->ref();
     if (parentNode()->renderer() && _style->display() != NONE) {
         m_render = new (getDocument()->renderArena()) RenderLegend(this);
@@ -1682,7 +1789,8 @@
     // return the number of the first option selected
     uint o = 0;
     QMemArray<HTMLGenericFormElementImpl*> items = listItems();
-    for (unsigned int i = 0; i < items.size(); i++) {
+    const unsigned int itemsSize = items.size();
+    for (unsigned int i = 0; i < itemsSize; ++i) {
         if (items[i]->id() == ID_OPTION) {
             if (static_cast<HTMLOptionElementImpl*>(items[i])->selected())
                 return o;
@@ -1698,7 +1806,8 @@
     // deselect all other options and select only the new one
     QMemArray<HTMLGenericFormElementImpl*> items = listItems();
     int listIndex;
-    for (listIndex = 0; listIndex < int(items.size()); listIndex++) {
+    const int itemsSize = int(items.size());
+    for (listIndex = 0; listIndex < itemsSize; ++listIndex) {
         if (items[listIndex]->id() == ID_OPTION)
             static_cast<HTMLOptionElementImpl*>(items[listIndex])->setSelected(false);
     }
@@ -1714,9 +1823,10 @@
     int len = 0;
     uint i;
     QMemArray<HTMLGenericFormElementImpl*> items = listItems();
-    for (i = 0; i < items.size(); i++) {
+    const uint itemsSize = items.size();
+    for (i = 0; i < itemsSize; ++i) {
         if (items[i]->id() == ID_OPTION)
-            len++;
+            ++len;
     }
     return len;
 }
@@ -1734,7 +1844,7 @@
 void HTMLSelectElementImpl::remove( long index )
 {
     int exceptioncode = 0;
-    int listIndex = optionToListIndex(index);
+    const int listIndex = optionToListIndex(index);
 
     QMemArray<HTMLGenericFormElementImpl*> items = listItems();
     if(listIndex < 0 || index >= int(items.size()))
@@ -1760,7 +1870,8 @@
 {
     uint i;
     QMemArray<HTMLGenericFormElementImpl*> items = listItems();
-    for (i = 0; i < items.size(); i++) {
+    const uint itemsSize = items.size();
+    for (i = 0; i < itemsSize; ++i) {
         if ( items[i]->id() == ID_OPTION
             && static_cast<HTMLOptionElementImpl*>(items[i])->selected())
             return static_cast<HTMLOptionElementImpl*>(items[i])->value();
@@ -1780,10 +1891,10 @@
     QString state;
     QMemArray<HTMLGenericFormElementImpl*> items = listItems();
 
-    int l = items.count();
+    const int l = items.count();
 
     state.fill('.', l);
-    for(int i = 0; i < l; i++)
+    for(int i = 0; i < l; ++i)
         if(items[i]->id() == ID_OPTION && static_cast<HTMLOptionElementImpl*>(items[i])->selected())
             state[i] = 'X';
 
@@ -1802,10 +1913,10 @@
 
     QMemArray<HTMLGenericFormElementImpl*> items = listItems();
 
-    int l = items.count();
-    for(int i = 0; i < l; i++) {
+    const int l = items.count();
+    for(int i = 0; i < l; ++i) {
         if(items[i]->id() == ID_OPTION) {
-            HTMLOptionElementImpl* oe = static_cast<HTMLOptionElementImpl*>(items[i]);
+            HTMLOptionElementImpl* const oe = static_cast<HTMLOptionElementImpl*>(items[i]);
             oe->setSelected(state[i] == 'X');
         }
     }
@@ -1814,7 +1925,7 @@
 
 NodeImpl *HTMLSelectElementImpl::insertBefore ( NodeImpl *newChild, NodeImpl *refChild, int &exceptioncode )
 {
-    NodeImpl *result = HTMLGenericFormElementImpl::insertBefore(newChild,refChild, exceptioncode );
+    NodeImpl* const result = HTMLGenericFormElementImpl::insertBefore(newChild,refChild, exceptioncode );
     if (!exceptioncode)
         setRecalcListItems();
     return result;
@@ -1822,7 +1933,7 @@
 
 NodeImpl *HTMLSelectElementImpl::replaceChild ( NodeImpl *newChild, NodeImpl *oldChild, int &exceptioncode )
 {
-    NodeImpl *result = HTMLGenericFormElementImpl::replaceChild(newChild,oldChild, exceptioncode);
+    NodeImpl* const result = HTMLGenericFormElementImpl::replaceChild(newChild,oldChild, exceptioncode);
     if( !exceptioncode )
         setRecalcListItems();
     return result;
@@ -1830,7 +1941,7 @@
 
 NodeImpl *HTMLSelectElementImpl::removeChild ( NodeImpl *oldChild, int &exceptioncode )
 {
-    NodeImpl *result = HTMLGenericFormElementImpl::removeChild(oldChild, exceptioncode);
+    NodeImpl* const result = HTMLGenericFormElementImpl::removeChild(oldChild, exceptioncode);
     if( !exceptioncode )
         setRecalcListItems();
     return result;
@@ -1838,7 +1949,7 @@
 
 NodeImpl *HTMLSelectElementImpl::appendChild ( NodeImpl *newChild, int &exceptioncode )
 {
-    NodeImpl *result = HTMLGenericFormElementImpl::appendChild(newChild, exceptioncode);
+    NodeImpl* const result = HTMLGenericFormElementImpl::appendChild(newChild, exceptioncode);
     if( !exceptioncode )
         setRecalcListItems();
     setChanged(true);
@@ -1881,7 +1992,7 @@
     assert(parentNode());
     assert(!renderer());
 
-    RenderStyle* _style = getDocument()->styleSelector()->styleForElement(this);
+    RenderStyle* const _style = getDocument()->styleSelector()->styleForElement(this);
     _style->ref();
     if (parentNode()->renderer() && _style->display() != NONE) {
         m_render = new (getDocument()->renderArena()) RenderSelect(this);
@@ -1895,13 +2006,14 @@
 bool HTMLSelectElementImpl::encoding(const QTextCodec* codec, khtml::encodingList& encoded_values, bool)
 {
     bool successful = false;
-    QCString enc_name = fixUpfromUnicode(codec, name().string());
+    const QCString enc_name = fixUpfromUnicode(codec, name().string());
     QMemArray<HTMLGenericFormElementImpl*> items = listItems();
 
     uint i;
-    for (i = 0; i < items.size(); i++) {
+    const uint itemsSize = items.size();
+    for (i = 0; i < itemsSize; ++i) {
         if (items[i]->id() == ID_OPTION) {
-            HTMLOptionElementImpl *option = static_cast<HTMLOptionElementImpl*>(items[i]);
+            HTMLOptionElementImpl* const option = static_cast<HTMLOptionElementImpl*>(items[i]);
             if (option->selected()) {
                 encoded_values += enc_name;
                 encoded_values += fixUpfromUnicode(codec, option->value().string());
@@ -1913,9 +2025,9 @@
     // ### this case should not happen. make sure that we select the first option
     // in any case. otherwise we have no consistency with the DOM interface. FIXME!
     // we return the first one if it was a combobox select
-    if (!successful && !m_multiple && m_size <= 1 && items.size() &&
+    if (!successful && !m_multiple && m_size <= 1 && itemsSize &&
         (items[0]->id() == ID_OPTION) ) {
-        HTMLOptionElementImpl *option = static_cast<HTMLOptionElementImpl*>(items[0]);
+        HTMLOptionElementImpl* const option = static_cast<HTMLOptionElementImpl*>(items[0]);
         encoded_values += enc_name;
         if (option->value().isNull())
             encoded_values += fixUpfromUnicode(codec, option->text().string().stripWhiteSpace());
@@ -1930,18 +2042,19 @@
 int HTMLSelectElementImpl::optionToListIndex(int optionIndex) const
 {
     QMemArray<HTMLGenericFormElementImpl*> items = listItems();
-    if (optionIndex < 0 || optionIndex >= int(items.size()))
+    const int itemsSize = int(items.size());
+    if (optionIndex < 0 || optionIndex >= itemsSize)
         return -1;
 
     int listIndex = 0;
     int optionIndex2 = 0;
     for (;
-         optionIndex2 < int(items.size()) && optionIndex2 <= optionIndex;
-         listIndex++) { // not a typo!
+         optionIndex2 < itemsSize && optionIndex2 <= optionIndex;
+         ++listIndex) { // not a typo!
         if (items[listIndex]->id() == ID_OPTION)
-            optionIndex2++;
+            ++optionIndex2;
     }
-    listIndex--;
+    --listIndex;
     return listIndex;
 }
 
@@ -1984,7 +2097,7 @@
                 foundSelected = static_cast<HTMLOptionElementImpl*>(current);
             }
         }
-        NodeImpl *parent = current->parentNode();
+        NodeImpl* const parent = current->parentNode();
         current = current->nextSibling();
         if (!current) {
             if (parent != this)
@@ -2013,10 +2126,11 @@
 {
     QMemArray<HTMLGenericFormElementImpl*> items = listItems();
     uint i;
-    for (i = 0; i < items.size(); i++) {
+    const uint itemsSize = items.size();
+    for (i = 0; i < itemsSize; ++i) {
         if (items[i]->id() == ID_OPTION) {
-            HTMLOptionElementImpl *option = static_cast<HTMLOptionElementImpl*>(items[i]);
-            bool selected = (!option->getAttribute(ATTR_SELECTED).isNull());
+            HTMLOptionElementImpl* const option = static_cast<HTMLOptionElementImpl*>(items[i]);
+            const bool selected = (!option->getAttribute(ATTR_SELECTED).isNull());
             option->setSelected(selected);
         }
     }
@@ -2031,7 +2145,8 @@
         // deselect all other options
         QMemArray<HTMLGenericFormElementImpl*> items = listItems();
         uint i;
-        for (i = 0; i < items.size(); i++) {
+	const uint itemsSize = items.size();
+        for (i = 0; i < itemsSize; ++i) {
             if (items[i]->id() == ID_OPTION)
                 static_cast<HTMLOptionElementImpl*>(items[i])->m_selected = (items[i] == selectedOption);
         }
@@ -2047,9 +2162,11 @@
 HTMLKeygenElementImpl::HTMLKeygenElementImpl(DocumentPtr* doc, HTMLFormElementImpl* f)
     : HTMLSelectElementImpl(doc, f)
 {
-    QStringList keys = KSSLKeyGen::supportedKeySizes();
-    for (QStringList::Iterator i = keys.begin(); i != keys.end(); ++i) {
-        HTMLOptionElementImpl* o = new HTMLOptionElementImpl(doc, form());
+    const QStringList keys = KSSLKeyGen::supportedKeySizes();
+    QStringList::ConstIterator i = keys.begin();
+    const QStringList::ConstIterator iEnd = keys.end();
+    for ( ; i != iEnd; ++i) {
+        HTMLOptionElementImpl* const o = new HTMLOptionElementImpl(doc, form());
         addChild(o);
         o->addChild(doc->document()->createTextNode(DOMString(*i).implementation()));
     }
@@ -2075,12 +2192,12 @@
 bool HTMLKeygenElementImpl::encoding(const QTextCodec* codec, khtml::encodingList& encoded_values, bool)
 {
     bool successful = false;
-    QCString enc_name = fixUpfromUnicode(codec, name().string());
+    const QCString enc_name = fixUpfromUnicode(codec, name().string());
 
     encoded_values += enc_name;
 
     // pop up the fancy certificate creation dialog here
-    KSSLKeyGen *kg = new KSSLKeyGen(static_cast<RenderWidget *>(m_render)->widget(), "Key Generator", true);
+    KSSLKeyGen* const kg = new KSSLKeyGen(static_cast<RenderWidget *>(m_render)->widget(), "Key Generator", true);
 
     kg->setKeySize(0);
     successful = (QDialog::Accepted == kg->exec());
@@ -2136,14 +2253,14 @@
     // Let's do this dynamically. Might be a bit slow, but we're sure
     // we won't forget to update a member variable in some cases...
     QMemArray<HTMLGenericFormElementImpl*> items = getSelect()->listItems();
-    int l = items.count();
+    const int l = items.count();
     int optionIndex = 0;
-    for(int i = 0; i < l; i++) {
+    for(int i = 0; i < l; ++i) {
         if(items[i]->id() == ID_OPTION)
         {
             if (static_cast<HTMLOptionElementImpl*>(items[i]) == this)
                 return optionIndex;
-            optionIndex++;
+            ++optionIndex;
         }
     }
     kdWarning() << "HTMLOptionElementImpl::index(): option not found!" << endl;
@@ -2189,7 +2306,7 @@
     if(m_selected == _selected)
         return;
     m_selected = _selected;
-    HTMLSelectElementImpl *select = getSelect();
+    HTMLSelectElementImpl* const select = getSelect();
     if (select)
         select->notifyOptionSelected(this,_selected);
 }
@@ -2293,7 +2410,7 @@
     assert(!m_render);
     assert(parentNode());
 
-    RenderStyle* _style = getDocument()->styleSelector()->styleForElement(this);
+    RenderStyle* const _style = getDocument()->styleSelector()->styleForElement(this);
     _style->ref();
     if (parentNode()->renderer() && _style->display() != NONE) {
         m_render = new (getDocument()->renderArena()) RenderTextArea(this);
@@ -2431,7 +2548,7 @@
 {
     // When IsIndex is parsed, <HR/>Prompt: <ISINDEX/><HR/> is created.
     // So we have to look at the previous sibling to find the prompt text
-    DOM::NodeImpl* prev = previousSibling();
+    DOM::NodeImpl* const prev = previousSibling();
     if ( prev && prev->nodeType() == DOM::Node::TEXT_NODE)
         return prev->nodeValue();
     return "";
@@ -2442,7 +2559,7 @@
     // When IsIndex is parsed, <HR/>Prompt: <ISINDEX/><HR/> is created.
     // So we have to look at the previous sibling to find the prompt text
     int exceptioncode = 0;
-    DOM::NodeImpl* prev = previousSibling();
+    DOM::NodeImpl* const prev = previousSibling();
     if ( prev && prev->nodeType() == DOM::Node::TEXT_NODE)
         static_cast<DOM::TextImpl *>(prev)->setData(str, exceptioncode);
 }
diff -urN -x CVS kdelibs.orig/khtml/html/html_formimpl.h kdelibs/khtml/html/html_formimpl.h
--- kdelibs.orig/khtml/html/html_formimpl.h	Tue Sep 14 17:01:34 2004
+++ kdelibs/khtml/html/html_formimpl.h	Wed Nov 17 14:59:16 2004
@@ -20,7 +20,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #ifndef HTML_FORMIMPL_H
 #define HTML_FORMIMPL_H
@@ -52,6 +51,10 @@
     typedef QValueList<QCString> encodingList;
 }
 
+namespace KWallet {
+    class Wallet;
+}
+
 namespace DOM {
 
 class HTMLFormElement;
@@ -78,6 +81,7 @@
 
     bool autoComplete() const { return m_autocomplete; }
     void doAutoFill();
+    void walletOpened(KWallet::Wallet *w);
 
     virtual void parseAttribute(AttributeImpl *attr);
 
@@ -100,6 +104,7 @@
     friend class HTMLFormCollectionImpl;
 
 private:
+    void gatherWalletData();
     QPtrList<HTMLGenericFormElementImpl> formElements;
     QPtrList<HTMLImageElementImpl> imgElements;
     DOMString m_target;
@@ -114,6 +119,9 @@
     bool m_doingsubmit : 1;
     bool m_inreset : 1;
     bool m_malformed : 1;
+    bool m_haveTextarea : 1; // for wallet storage
+    bool m_havePassword : 1; // for wallet storage
+    QMap<QString, QString> m_walletMap; // for wallet storage
 };
 
 // -------------------------------------------------------------------------
@@ -142,7 +150,7 @@
     bool disabled() const { return m_disabled; }
     void setDisabled(bool _disabled);
 
-    virtual bool isSelectable() const;
+    virtual bool isFocusable() const;
     virtual bool isEnumeratable() const { return false; }
 
     bool readOnly() const { return m_readOnly; }
@@ -293,7 +301,7 @@
     void activate();
 
     void setUnsubmittedFormChange(bool unsubmitted) { m_unsubmittedFormChange = unsubmitted; }
-    
+
 protected:
 
     DOMString m_value;
@@ -322,7 +330,8 @@
     virtual Id id() const;
     virtual void attach();
     virtual void defaultEventHandler(EventImpl *evt);
-    virtual bool isSelectable() const { return true; }
+    virtual bool isFocusable() const { return true; };
+    virtual bool isTabFocusable() const { return false; };
     NodeImpl* getFormElement();
 
  private:
diff -urN -x CVS kdelibs.orig/khtml/html/html_headimpl.cpp kdelibs/khtml/html/html_headimpl.cpp
--- kdelibs.orig/khtml/html/html_headimpl.cpp	Fri Feb 13 02:11:06 2004
+++ kdelibs/khtml/html/html_headimpl.cpp	Wed Nov 10 10:00:21 2004
@@ -234,7 +234,7 @@
         m_sheet->deref();
     m_sheet = new CSSStyleSheetImpl(this, url);
     m_sheet->ref();
-    m_sheet->parseString( sheetStr, getDocument()->parseMode() == DocumentImpl::Strict );
+    m_sheet->parseString( sheetStr, !getDocument()->inCompatMode() );
 
     MediaListImpl *media = new MediaListImpl( m_sheet, m_media );
     m_sheet->setMedia( media );
@@ -411,7 +411,7 @@
         m_loading = true;
         m_sheet = new CSSStyleSheetImpl(this);
         m_sheet->ref();
-        m_sheet->parseString( text, (getDocument()->parseMode() == DocumentImpl::Strict) );
+        m_sheet->parseString( text, !getDocument()->inCompatMode() );
         MediaListImpl* media = new MediaListImpl( m_sheet, DOMString( m_media ) );
         m_sheet->setMedia( media );
         m_loading = false;
diff -urN -x CVS kdelibs.orig/khtml/html/html_imageimpl.cpp kdelibs/khtml/html/html_imageimpl.cpp
--- kdelibs.orig/khtml/html/html_imageimpl.cpp	Wed Feb 25 01:41:34 2004
+++ kdelibs/khtml/html/html_imageimpl.cpp	Wed Nov 10 10:00:21 2004
@@ -106,7 +106,7 @@
 	addHTMLAlignment( attr->value() );
 	break;
     case ATTR_VALIGN:
-	addCSSProperty(CSS_PROP_VERTICAL_ALIGN, attr->value());
+	addCSSProperty(CSS_PROP_VERTICAL_ALIGN, attr->value().lower());
         break;
     case ATTR_USEMAP:
         if ( attr->value()[0] == '#' )
diff -urN -x CVS kdelibs.orig/khtml/html/html_imageimpl.h kdelibs/khtml/html/html_imageimpl.h
--- kdelibs.orig/khtml/html/html_imageimpl.h	Wed Jul 28 00:11:50 2004
+++ kdelibs/khtml/html/html_imageimpl.h	Wed Nov 17 14:43:02 2004
@@ -19,7 +19,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #ifndef HTML_IMAGEIMPL_H
 #define HTML_IMAGEIMPL_H
diff -urN -x CVS kdelibs.orig/khtml/html/html_inlineimpl.cpp kdelibs/khtml/html/html_inlineimpl.cpp
--- kdelibs.orig/khtml/html/html_inlineimpl.cpp	Thu Mar 18 14:41:37 2004
+++ kdelibs/khtml/html/html_inlineimpl.cpp	Wed Nov 10 10:00:21 2004
@@ -200,9 +200,9 @@
     {
     case ATTR_CLEAR:
     {
-        DOMString str = attr->value();
+        DOMString str = attr->value().lower();
         if( str.isEmpty() ) str = "none";
-        else if( strcasecmp (str,"all")==0 ) str = "both";
+        else if( strcmp (str,"all")==0 ) str = "both";
         addCSSProperty(CSS_PROP_CLEAR, str);
         break;
     }
@@ -256,7 +256,7 @@
             switch (num)
             {
             case -2:
-            case  1: size = CSS_VAL_X_SMALL;  break;
+            case  1: size = CSS_VAL_XX_SMALL;  break;
             case -1:
             case  2: size = CSS_VAL_SMALL;    break;
             case  0: // treat 0 the same as 3, because people
diff -urN -x CVS kdelibs.orig/khtml/html/html_inlineimpl.h kdelibs/khtml/html/html_inlineimpl.h
--- kdelibs.orig/khtml/html/html_inlineimpl.h	Thu Mar 18 14:41:37 2004
+++ kdelibs/khtml/html/html_inlineimpl.h	Wed Nov 17 14:59:16 2004
@@ -20,7 +20,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #ifndef HTML_INLINEIMPL_H
 #define HTML_INLINEIMPL_H
@@ -37,7 +36,7 @@
     HTMLAnchorElementImpl(DocumentPtr *doc)
         : HTMLElementImpl(doc), m_hasTarget(false) {}
 
-    virtual bool isSelectable() const { return m_hasAnchor; }
+    virtual bool isFocusable() const { return m_hasAnchor; }
     virtual Id id() const;
     virtual void parseAttribute(AttributeImpl *attr);
     virtual void defaultEventHandler(EventImpl *evt);
diff -urN -x CVS kdelibs.orig/khtml/html/html_listimpl.h kdelibs/khtml/html/html_listimpl.h
--- kdelibs.orig/khtml/html/html_listimpl.h	Tue Feb 11 02:49:54 2003
+++ kdelibs/khtml/html/html_listimpl.h	Wed Nov 17 14:43:02 2004
@@ -19,7 +19,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #ifndef HTML_LISTIMPL_H
 #define HTML_LISTIMPL_H
diff -urN -x CVS kdelibs.orig/khtml/html/html_miscimpl.cpp kdelibs/khtml/html/html_miscimpl.cpp
--- kdelibs.orig/khtml/html/html_miscimpl.cpp	Wed Jul 28 11:02:33 2004
+++ kdelibs/khtml/html/html_miscimpl.cpp	Wed Nov 17 14:59:16 2004
@@ -19,11 +19,11 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 // -------------------------------------------------------------------------
 #include "html/html_miscimpl.h"
 #include "html/html_formimpl.h"
+#include "html/html_documentimpl.h"
 
 #include "misc/htmlhashes.h"
 #include "dom/dom_node.h"
@@ -53,15 +53,26 @@
     base = _base;
     base->ref();
     type = _type;
-    currentItem = 0L;
     idsDone = false;
+    info = base->isDocumentNode() ? static_cast<HTMLDocumentImpl*>(base->getDocument())->collectionInfo(type) : new CollectionInfo;
 }
 
 HTMLCollectionImpl::~HTMLCollectionImpl()
 {
+    if (!base->isDocumentNode())
+        delete info;
     base->deref();
 }
 
+void HTMLCollectionImpl::updateCollectionInfo() const
+{
+    unsigned int docversion = static_cast<HTMLDocumentImpl*>(base->getDocument())->domTreeVersion();
+    if (info->version != docversion) {
+        memset( info, 0, sizeof( CollectionInfo ));
+        info->version = docversion;
+    }
+}
+
 unsigned long HTMLCollectionImpl::calcLength(NodeImpl *current) const
 {
     unsigned long len = 0;
@@ -81,6 +92,10 @@
                 if(e->id() == ID_FORM)
                     len++;
                 break;
+            case DOC_LAYERS:
+                if(e->id() == ID_LAYER || e->id() == ID_ILAYER)
+                    len++;
+                break;
             case TABLE_TBODIES:
                 if(e->id() == ID_TBODY)
                     len++;
@@ -145,7 +160,12 @@
 // calculation every time...
 unsigned long HTMLCollectionImpl::length() const
 {
-    return calcLength(base->firstChild());
+    updateCollectionInfo();
+    if (!info->haslength) {
+        info->length = calcLength(base->firstChild());
+        info->haslength = true;
+    }
+    return info->length;
 }
 
 NodeImpl *HTMLCollectionImpl::getItem(NodeImpl *current, int index, int &len) const
@@ -166,6 +186,10 @@
                 if(e->id() == ID_FORM)
                     len++;
                 break;
+            case DOC_LAYERS:
+                if(e->id() == ID_LAYER || e->id() == ID_ILAYER)
+                    len++;
+                break;
             case TABLE_TBODIES:
                 if(e->id() == ID_TBODY)
                     len++;
@@ -231,41 +255,64 @@
 
 NodeImpl *HTMLCollectionImpl::item( unsigned long index ) const
 {
-    int pos = 0;
-    return getItem(base->firstChild(), index, pos);
+    updateCollectionInfo();
+    if (info->current && info->position == index) {
+        return info->current;
+    }
+    if (info->haslength && info->length <= index) {
+        return 0L;
+    }
+    if (!info->current || info->position > index) {
+        info->current = base->firstChild();
+        info->position = 0;
+        if (!info->current)
+            return 0L;
+    }
+    int pos = (int) info->position;
+    NodeImpl *node = getItem(info->current, index, pos);
+    while (!node && info->current->parentNode() && info->current->parentNode() != base) {
+        info->current = info->current->parentNode();
+        if (info->current->nextSibling())
+            node = getItem(info->current->nextSibling(), index, pos);
+    }
+    info->current = node;
+    info->position = index;
+    return info->current;
 }
 
 NodeImpl *HTMLCollectionImpl::firstItem() const
 {
-    int pos = 0;
-    currentItem = getItem(base->firstChild(), 0, pos);
-    return currentItem;
+    return item(0);
 }
 
 NodeImpl *HTMLCollectionImpl::nextItem() const
 {
+    updateCollectionInfo();
     int pos = 0;
+
+    info->position = ~0;  // no position
     // Look for the 'second' item. The first one is currentItem, already given back.
-    NodeImpl *retval = getItem(currentItem, 1, pos);
+    NodeImpl *retval = getItem(info->current, 1, pos);
     if (retval)
     {
-        currentItem = retval;
+        info->current = retval;
         return retval;
     }
     // retval was 0, means we have to go up
-    while( !retval && currentItem->parentNode()
-           && currentItem->parentNode() != base )
+    while( !retval && info->current->parentNode()
+           && info->current->parentNode() != base )
     {
-        currentItem = currentItem->parentNode();
-        if (currentItem->nextSibling())
+        info->current = info->current->parentNode();
+        if (info->current->nextSibling())
         {
             // ... and to take the first one from there
             pos = 0;
-            retval = getItem(currentItem->nextSibling(), 0, pos);
+            retval = getItem(info->current->nextSibling(), 0, pos);
         }
-    }
-    currentItem = retval;
-    return currentItem;
+     }
+    info->current = retval;
+    return info->current;
+
 }
 
 NodeImpl *HTMLCollectionImpl::getNamedItem( NodeImpl *current, int attr_id,
@@ -291,6 +338,10 @@
                 if(e->id() == ID_FORM)
                     check = true;
                 break;
+            case DOC_LAYERS:
+                if(e->id() == ID_LAYER || e->id() == ID_ILAYER)
+                    check = true;
+                break;
             case TABLE_TBODIES:
                 if(e->id() == ID_TBODY)
                     check = true;
@@ -347,7 +398,7 @@
                           e->id() == ID_IMG ||
                           e->id() == ID_INPUT ||
                           e->id() == ID_MAP ||
-			  e->id() == ID_META || 
+			  e->id() == ID_META ||
                           e->id() == ID_OBJECT ||
                           e->id() == ID_SELECT ||
                           e->id() == ID_TEXTAREA
@@ -388,13 +439,15 @@
     // attribute. If a match is not found, the method then searches for an
     // object with a matching name attribute, but only on those elements
     // that are allowed a name attribute.
+    updateCollectionInfo();
+    info->position = ~0;  // no position
     idsDone = false;
-    currentItem = getNamedItem(base->firstChild(), ATTR_ID, name);
-    if(currentItem)
-        return currentItem;
+    info->current = getNamedItem(base->firstChild(), ATTR_ID, name);
+    if(info->current)
+        return info->current;
     idsDone = true;
-    currentItem = getNamedItem(base->firstChild(), ATTR_NAME, name);
-    return currentItem;
+    info->current = getNamedItem(base->firstChild(), ATTR_NAME, name);
+    return info->current;
 }
 
 NodeImpl *HTMLCollectionImpl::nextNamedItem( const DOMString &name ) const
@@ -422,38 +475,39 @@
 
 NodeImpl *HTMLCollectionImpl::nextNamedItemInternal( const DOMString &name ) const
 {
-    //kdDebug() << "\nHTMLCollectionImpl::nextNamedItem starting at " << currentItem << endl;
+    updateCollectionInfo();
+    //kdDebug() << "\nHTMLCollectionImpl::nextNamedItem starting at " << info->current << endl;
     // Go to next item first (to avoid returning the same)
-    currentItem = nextItem();
-    //kdDebug() << "*HTMLCollectionImpl::nextNamedItem next item is " << currentItem << endl;
+    nextItem(); // sets info->current and invalidates info->postion
+    //kdDebug() << "*HTMLCollectionImpl::nextNamedItem next item is " << info->current << endl;
 
-    if ( currentItem )
+    if ( info->current )
     {
         // Then look for next matching named item
-        NodeImpl *retval = getNamedItem(currentItem, idsDone ? ATTR_NAME : ATTR_ID, name);
+        NodeImpl *retval = getNamedItem(info->current, idsDone ? ATTR_NAME : ATTR_ID, name);
         if ( retval )
         {
             //kdDebug() << "*HTMLCollectionImpl::nextNamedItem found " << retval << endl;
-            currentItem = retval;
+            info->current = retval;
             return retval;
         }
 
         // retval was 0, means we have to go up
-        while( !retval && currentItem->parentNode()
-               && currentItem->parentNode() != base )
+        while( !retval && info->current->parentNode()
+               && info->current->parentNode() != base )
         {
-            currentItem = currentItem->parentNode();
-            if (currentItem->nextSibling())
+            info->current = info->current->parentNode();
+            if (info->current->nextSibling())
             {
                 // ... and to take the first one from there
-                retval = getNamedItem(currentItem->nextSibling(), idsDone ? ATTR_NAME : ATTR_ID, name);
+                retval = getNamedItem(info->current->nextSibling(), idsDone ? ATTR_NAME : ATTR_ID, name);
             }
         }
         if ( retval )
         {
             //kdDebug() << "*HTMLCollectionImpl::nextNamedItem found after going up " << retval << endl;
-            currentItem = retval;
-            return currentItem;
+            info->current = retval;
+            return info->current;
         }
     }
 
@@ -462,8 +516,8 @@
     // After doing all ATTR_ID, do ATTR_NAME
     //kdDebug() << "*HTMLCollectionImpl::nextNamedItem going to ATTR_NAME now" << endl;
     idsDone = true;
-    currentItem = getNamedItem(base->firstChild(), ATTR_NAME, name);
-    return currentItem;
+    info->current = getNamedItem(base->firstChild(), ATTR_NAME, name);
+    return info->current;
 
 }
 
diff -urN -x CVS kdelibs.orig/khtml/html/html_miscimpl.h kdelibs/khtml/html/html_miscimpl.h
--- kdelibs.orig/khtml/html/html_miscimpl.h	Mon Aug  9 10:58:12 2004
+++ kdelibs/khtml/html/html_miscimpl.h	Wed Nov 17 14:59:16 2004
@@ -19,7 +19,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #ifndef HTML_MISCIMPL_H
 #define HTML_MISCIMPL_H
@@ -51,9 +50,10 @@
 public:
     enum Type {
         // from HTMLDocument
-        DOC_IMAGES,    // all IMG elements in the document
+        DOC_IMAGES = 0, // all IMG elements in the document
         DOC_APPLETS,   // all OBJECT and APPLET elements
         DOC_FORMS,     // all FORMS
+        DOC_LAYERS,    // all LAYERS
         DOC_LINKS,     // all A _and_ AREA elements with a value for href
         DOC_ANCHORS,      // all A elements with a value for name
         // from HTMLTable, HTMLTableSection, HTMLTableRow
@@ -66,15 +66,17 @@
         // from HTMLMap
         MAP_AREAS,
         DOC_ALL,        // "all" elements (IE)
-        NODE_CHILDREN   // first-level children (IE)
+        NODE_CHILDREN,   // first-level children (IE)
+        LAST_TYPE
     };
 
     HTMLCollectionImpl(NodeImpl *_base, int _tagId);
 
     virtual ~HTMLCollectionImpl();
     unsigned long length() const;
-    // This method is o(n), so you should't use it to iterate over all items. Use firstItem/nextItem instead.
+    // Only when iterating forward, it will use caching, ie. making it O(1).
     NodeImpl *item ( unsigned long index ) const;
+    // obsolete and not domtree changes save, virtual too.
     virtual NodeImpl *firstItem() const;
     virtual NodeImpl *nextItem() const;
 
@@ -82,15 +84,25 @@
     // In case of multiple items named the same way
     NodeImpl *nextNamedItem( const DOMString &name ) const;
 
+    struct CollectionInfo {
+        CollectionInfo() : version((unsigned int) ~0) {}
+        unsigned int version;
+        NodeImpl *current;
+        unsigned int position;
+        unsigned int length;
+        bool haslength;
+    };
 protected:
     virtual unsigned long calcLength(NodeImpl *current) const;
     virtual NodeImpl *getItem(NodeImpl *current, int index, int &pos) const;
     virtual NodeImpl *getNamedItem(NodeImpl *current, int attr_id, const DOMString &name) const;
     virtual NodeImpl *nextNamedItemInternal( const DOMString &name ) const;
+    void updateCollectionInfo() const;
     // the base node, the collection refers to
     NodeImpl *base;
     // The collection list the following elements
     int type;
+    mutable CollectionInfo *info;
 
     // ### add optimization, so that a linear loop through the
     // Collection [using item(i)] is O(n) and not O(n^2)!
@@ -98,8 +110,6 @@
     //NodeImpl *current;
     //int currentPos;
 
-    // For firstItem()/nextItem()
-    mutable NodeImpl *currentItem;
     // For nextNamedItem()
     mutable bool idsDone;
 };
diff -urN -x CVS kdelibs.orig/khtml/html/html_objectimpl.cpp kdelibs/khtml/html/html_objectimpl.cpp
--- kdelibs.orig/khtml/html/html_objectimpl.cpp	Thu Feb 19 15:40:22 2004
+++ kdelibs/khtml/html/html_objectimpl.cpp	Wed Nov 10 10:00:21 2004
@@ -49,7 +49,7 @@
 
 // -------------------------------------------------------------------------
 HTMLObjectBaseElementImpl::HTMLObjectBaseElementImpl(DocumentPtr *doc)
-    : HTMLElementImpl(doc), liveconnect(0L)
+    : HTMLElementImpl(doc)
 {
     needWidgetUpdate = false;
     m_renderAlternative = false;
@@ -60,9 +60,6 @@
     int pos = serviceType.find( ";" );
     if ( pos!=-1 )
         serviceType.truncate( pos );
-    pos = serviceType.find( "-plugin" );
-    if ( pos!=-1 )
-        serviceType.truncate( pos );
 }
 
 void HTMLObjectBaseElementImpl::parseAttribute(AttributeImpl *attr)
@@ -119,63 +116,6 @@
     attach();
 }
 
-bool HTMLObjectBaseElementImpl::get(const unsigned long objid, const QString & field, KParts::LiveConnectExtension::Type & type, unsigned long & retobjid, QString & value) {
-    if (!liveconnect)
-        return false;
-    return liveconnect->get(objid, field, type, retobjid, value);
-}
-
-bool HTMLObjectBaseElementImpl::put(const unsigned long objid, const QString & field, const QString & value) {
-    if (!liveconnect)
-        return false;
-    return liveconnect->put(objid, field, value);
-}
-
-bool HTMLObjectBaseElementImpl::call(const unsigned long objid, const QString & func, const QStringList & args, KParts::LiveConnectExtension::Type & type, unsigned long & retobjid, QString & value) {
-    if (!liveconnect)
-        return false;
-    return liveconnect->call(objid, func, args, type, retobjid, value);
-}
-
-void HTMLObjectBaseElementImpl::unregister(const unsigned long objid) {
-    if (!liveconnect)
-        return;
-    liveconnect->unregister(objid);
-}
-
-void HTMLObjectBaseElementImpl::setLiveConnect(KParts::LiveConnectExtension * lc) {
-    liveconnect = lc;
-    if (lc)
-        connect(lc, SIGNAL(partEvent(const unsigned long, const QString &, const KParts::LiveConnectExtension::ArgList &)), static_cast<HTMLObjectBaseElementImpl*>(this), SLOT(liveConnectEvent( const unsigned long, const QString&, const KParts::LiveConnectExtension::ArgList &)));
-}
-
-void HTMLObjectBaseElementImpl::liveConnectEvent(const unsigned long, const QString & event, const KParts::LiveConnectExtension::ArgList & args)
-{
-    if (!liveconnect)
-        // not attached
-        return;
-
-    QString script;
-    script.sprintf("%s(", event.latin1());
-    KParts::LiveConnectExtension::ArgList::const_iterator i = args.begin();
-    for ( ; i != args.end(); i++) {
-        if (i != args.begin())
-            script += ",";
-        if ((*i).first == KParts::LiveConnectExtension::TypeString) {
-            script += "\"";
-            script += QString((*i).second).replace('\\', "\\\\").replace('"', "\\\"");
-            script += "\"";
-        } else
-            script += (*i).second;
-    }
-    script += ")";
-
-    kdDebug(6036) << "HTMLObjectBaseElementImpl::liveConnectEvent " << script << endl;
-    KHTMLView* w = getDocument()->view();
-    if (w)
-	w->part()->executeScript(this, script);
-}
-
 void HTMLObjectBaseElementImpl::attach() {
     assert(!attached());
     assert(!m_render);
@@ -199,7 +139,7 @@
     {
         needWidgetUpdate = false;
         bool imagelike = serviceType.startsWith("image/") &&
-                         (KImageIO::typeForMime(serviceType) != QString::null);
+                         !KImageIO::typeForMime(serviceType).isNull();
         if (imagelike) {
             m_render = new (getDocument()->renderArena()) RenderImage(this);
             // make sure we don't attach the inner contents
@@ -222,7 +162,6 @@
 }
 
 void HTMLObjectBaseElementImpl::detach() {
-    setLiveConnect(0L);
 
     if (attached())
         // ### do this when we are actualy removed from document instead
@@ -333,7 +272,7 @@
 	addHTMLAlignment( attr->value() );
 	break;
      case ATTR_VALIGN:
-        addCSSProperty(CSS_PROP_VERTICAL_ALIGN, attr->value());
+        addCSSProperty(CSS_PROP_VERTICAL_ALIGN, attr->value().lower() );
         break;
      case ATTR_PLUGINPAGE:
      case ATTR_PLUGINSPAGE: {
@@ -341,7 +280,7 @@
         break;
       }
      case ATTR_HIDDEN:
-        if (attr->value().lower()=="yes" || attr->value().lower()=="true")
+        if (strcasecmp( attr->value(), "yes" ) == 0 || strcasecmp( attr->value() , "true") == 0 )
            hidden = true;
         else
            hidden = false;
diff -urN -x CVS kdelibs.orig/khtml/html/html_objectimpl.h kdelibs/khtml/html/html_objectimpl.h
--- kdelibs.orig/khtml/html/html_objectimpl.h	Sun Jan 25 20:46:21 2004
+++ kdelibs/khtml/html/html_objectimpl.h	Wed Nov 17 14:59:16 2004
@@ -19,14 +19,13 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #ifndef HTML_OBJECTIMPL_H
 #define HTML_OBJECTIMPL_H
 
 #include "html_elementimpl.h"
 #include "xml/dom_stringimpl.h"
-#include <kparts/browserextension.h>
+#include <qobject.h>
 #include <qstringlist.h>
 
 class KHTMLView;
@@ -51,12 +50,6 @@
 
     void renderAlternative();
 
-    bool get(const unsigned long, const QString &, KParts::LiveConnectExtension::Type &, unsigned long &, QString &);
-    bool put(const unsigned long, const QString &, const QString &);
-    bool call(const unsigned long, const QString &, const QStringList &, KParts::LiveConnectExtension::Type &, unsigned long &, QString &);
-    void unregister(const unsigned long);
-
-    void setLiveConnect(KParts::LiveConnectExtension * lc);
     void setServiceType(const QString &);
 
     QString url;
@@ -66,11 +59,8 @@
     bool m_renderAlternative;
 
 protected slots:
-    void liveConnectEvent(const unsigned long, const QString&, const KParts::LiveConnectExtension::ArgList&);
     void slotRenderAlternative();
 
-private:
-    KParts::LiveConnectExtension *liveconnect;
 };
 
 // -------------------------------------------------------------------------
diff -urN -x CVS kdelibs.orig/khtml/html/html_tableimpl.cpp kdelibs/khtml/html/html_tableimpl.cpp
--- kdelibs.orig/khtml/html/html_tableimpl.cpp	Fri Feb 13 00:14:08 2004
+++ kdelibs/khtml/html/html_tableimpl.cpp	Wed Nov 10 10:00:21 2004
@@ -6,6 +6,7 @@
  *           (C) 1998 Waldo Bastian (bastian@kde.org)
  *           (C) 1999-2003 Lars Knoll (knoll@kde.org)
  *           (C) 1999 Antti Koivisto (koivisto@kde.org)
+ *           (C) 2003 Apple Computer, Inc.
  *
  * This library is free software; you can redistribute it and/or
  * modify it under the terms of the GNU Library General Public
@@ -475,18 +476,19 @@
         int c;
         c = attr->val()->toInt();
         addColumns(c-totalCols);
-        break;
 #endif
+        break;
+
     }
     case ATTR_ALIGN:
         if (!attr->value().isEmpty())
-            addCSSProperty(CSS_PROP_FLOAT, attr->value());
+            addCSSProperty(CSS_PROP_FLOAT, attr->value().lower());
         else
             removeCSSProperty(CSS_PROP_FLOAT);
         break;
     case ATTR_VALIGN:
         if (!attr->value().isEmpty())
-            addCSSProperty(CSS_PROP_VERTICAL_ALIGN, attr->value());
+            addCSSProperty(CSS_PROP_VERTICAL_ALIGN, attr->value().lower());
         else
             removeCSSProperty(CSS_PROP_VERTICAL_ALIGN);
         break;
@@ -549,15 +551,22 @@
     case ATTR_ALIGN:
     {
         DOMString v = attr->value();
-        if ( strcasecmp( attr->value(), "center" ) == 0 )
-            v = "\\2d khtml-center";
-        addCSSProperty(CSS_PROP_TEXT_ALIGN, v);
+        if ( strcasecmp( attr->value(), "middle" ) == 0 || strcasecmp( attr->value(), "center" ) == 0 )
+            addCSSProperty(CSS_PROP_TEXT_ALIGN, CSS_VAL__KHTML_CENTER);
+        else if (strcasecmp(attr->value(), "absmiddle") == 0)
+            addCSSProperty(CSS_PROP_TEXT_ALIGN, CSS_VAL_CENTER);
+        else if (strcasecmp(attr->value(), "left") == 0)
+            addCSSProperty(CSS_PROP_TEXT_ALIGN, CSS_VAL__KHTML_LEFT);
+        else if (strcasecmp(attr->value(), "right") == 0)
+            addCSSProperty(CSS_PROP_TEXT_ALIGN, CSS_VAL__KHTML_RIGHT);
+        else
+            addCSSProperty(CSS_PROP_TEXT_ALIGN, v);
         break;
     }
     case ATTR_VALIGN:
     {
         if (!attr->value().isEmpty())
-            addCSSProperty(CSS_PROP_VERTICAL_ALIGN, attr->value());
+            addCSSProperty(CSS_PROP_VERTICAL_ALIGN, attr->value().lower());
         else
             removeCSSProperty(CSS_PROP_VERTICAL_ALIGN);
         break;
@@ -772,7 +781,7 @@
                 strcasecmp(attr->value(), "center" ) == 0 )
                 addCSSProperty( CSS_PROP_TEXT_ALIGN, CSS_VAL__KHTML_CENTER );
             else
-                addCSSProperty(CSS_PROP_TEXT_ALIGN, attr->value());
+                addCSSProperty(CSS_PROP_TEXT_ALIGN, attr->value().lower());
         }
         else
             removeCSSProperty(CSS_PROP_TEXT_ALIGN);
@@ -821,7 +830,7 @@
     if(p) {
         HTMLTableElementImpl* table = static_cast<HTMLTableElementImpl*>(p);
         if (table->m_noBorder) {
-            addCSSProperty(CSS_PROP_BORDER_WIDTH, "0");
+            removeCSSProperty(CSS_PROP_BORDER_WIDTH);
         }
         else {
             addCSSProperty(CSS_PROP_BORDER_WIDTH, "1px");
@@ -869,7 +878,7 @@
         break;
     case ATTR_VALIGN:
         if (!attr->value().isEmpty())
-            addCSSProperty(CSS_PROP_VERTICAL_ALIGN, attr->value());
+            addCSSProperty(CSS_PROP_VERTICAL_ALIGN, attr->value().lower());
         else
             removeCSSProperty(CSS_PROP_VERTICAL_ALIGN);
         break;
@@ -893,7 +902,7 @@
     {
     case ATTR_ALIGN:
         if (!attr->value().isEmpty())
-            addCSSProperty(CSS_PROP_CAPTION_SIDE, attr->value());
+            addCSSProperty(CSS_PROP_CAPTION_SIDE, attr->value().lower());
         else
             removeCSSProperty(CSS_PROP_CAPTION_SIDE);
         break;
diff -urN -x CVS kdelibs.orig/khtml/html/html_tableimpl.h kdelibs/khtml/html/html_tableimpl.h
--- kdelibs.orig/khtml/html/html_tableimpl.h	Tue Feb 11 02:49:54 2003
+++ kdelibs/khtml/html/html_tableimpl.h	Wed Nov 17 14:43:02 2004
@@ -22,7 +22,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #ifndef HTML_TABLEIMPL_H
 #define HTML_TABLEIMPL_H
@@ -188,7 +187,7 @@
 
     int colSpan() const { return cSpan; }
     int rowSpan() const { return rSpan; }
-    
+
     virtual Id id() const { return _id; }
     virtual void parseAttribute(AttributeImpl *attr);
     virtual void attach();
diff -urN -x CVS kdelibs.orig/khtml/html/htmlparser.cpp kdelibs/khtml/html/htmlparser.cpp
--- kdelibs.orig/khtml/html/htmlparser.cpp	Sun Jun 13 19:08:24 2004
+++ kdelibs/khtml/html/htmlparser.cpp	Wed Nov 10 10:00:21 2004
@@ -219,7 +219,7 @@
 
     // holy shit. apparently some sites use </br> instead of <br>
     // be compatible with IE and NS
-    if(t->tid == ID_BR+ID_CLOSE_TAG && document->document()->parseMode() != DocumentImpl::Strict)
+    if(t->tid == ID_BR+ID_CLOSE_TAG && document->document()->inCompatMode())
         t->tid -= ID_CLOSE_TAG;
 
     if(t->tid > ID_CLOSE_TAG)
@@ -888,9 +888,11 @@
     }
 // formatting elements (block)
     case ID_BLOCKQUOTE:
+        n = new HTMLGenericElementImpl(document, t->tid);
+        break;
     case ID_LAYER:
     case ID_ILAYER:
-        n = new HTMLGenericElementImpl(document, t->tid);
+        n = new HTMLLayerElementImpl(document, t->tid);
         break;
     case ID_P:
     case ID_DIV:
diff -urN -x CVS kdelibs.orig/khtml/html/htmlparser.h kdelibs/khtml/html/htmlparser.h
--- kdelibs.orig/khtml/html/htmlparser.h	Mon Nov 24 01:22:39 2003
+++ kdelibs/khtml/html/htmlparser.h	Wed Nov 17 14:43:02 2004
@@ -24,7 +24,6 @@
 //----------------------------------------------------------------------------
 //
 // KDE HTML Widget -- HTML Parser
-// $Id$
 
 #ifndef HTMLPARSER_H
 #define HTMLPARSER_H
diff -urN -x CVS kdelibs.orig/khtml/html/htmltokenizer.cpp kdelibs/khtml/html/htmltokenizer.cpp
--- kdelibs.orig/khtml/html/htmltokenizer.cpp	Wed Jun  9 12:35:00 2004
+++ kdelibs/khtml/html/htmltokenizer.cpp	Wed Nov 17 14:59:16 2004
@@ -27,7 +27,6 @@
 //----------------------------------------------------------------------------
 //
 // KDE HTML Widget - Tokenizers
-// $Id$
 
 //#define TOKEN_DEBUG 1
 //#define TOKEN_DEBUG 2
@@ -70,7 +69,7 @@
 static const char titleEnd [] = "</title";
 
 #define KHTML_ALLOC_QCHAR_VEC( N ) (QChar*) malloc( sizeof(QChar)*( N ) )
-#define KHTML_REALLOC_QCHAR_VEC(P, N ) (QChar*) P = realloc(p, sizeof(QChar)*( N ))
+#define KHTML_REALLOC_QCHAR_VEC(P, N ) (QChar*) realloc(P, sizeof(QChar)*( N ))
 #define KHTML_DELETE_QCHAR_VEC( P ) free((char*)( P ))
 
 // Full support for MS Windows extensions to Latin-1.
@@ -1059,6 +1058,7 @@
                 tagID -= ID_CLOSE_TAG;
             else if ( beginTag && !brokenScript && tagID == ID_SCRIPT ) {
                 DOMStringImpl* a = 0;
+                bool foundTypeAttribute = false;
                 scriptSrc = scriptSrcCharset = QString::null;
                 if ( currToken.attrs && /* potentially have a ATTR_SRC ? */
                      view &&  /* are we a regular tokenizer or just for innerHTML ? */
@@ -1070,17 +1070,54 @@
                         scriptSrcCharset = DOMString(a).string().stripWhiteSpace();
                     if ( scriptSrcCharset.isEmpty() && view)
                         scriptSrcCharset = parser->doc()->view()->part()->encoding();
-                    if (!(a = currToken.attrs->getValue( ATTR_LANGUAGE )))
-                        a = currToken.attrs->getValue(ATTR_TYPE);
+                    /* Check type before language, since language is deprecated */
+                    if ((a = currToken.attrs->getValue(ATTR_TYPE)) != 0 && !DOMString(a).string().isEmpty())
+                        foundTypeAttribute = true;
+                    else
+                        a = currToken.attrs->getValue(ATTR_LANGUAGE);
                 }
                 javascript = true;
-                if( a ) {
+
+                if( foundTypeAttribute ) {
+                    /*
+                        Mozilla 1.5 doesn't accept the text/javascript1.x formats, but WinIE 6 does.
+                        Mozilla 1.5 doesn't accept text/jscript, text/ecmascript, and text/livescript, but WinIE 6 does.
+                        Mozilla 1.5 allows leading and trailing whitespace, but WinIE 6 doesn't.
+                        Mozilla 1.5 and WinIE 6 both accept the empty string, but neither accept a whitespace-only string.
+                        We want to accept all the values that either of these browsers accept, but not other values.
+                     */
+                    QString type = DOMString(a).string().stripWhiteSpace().lower();
+                    if( type.compare("text/javascript") != 0 &&
+                        type.compare("text/javascript1.0") != 0 &&
+                        type.compare("text/javascript1.1") != 0 &&
+                        type.compare("text/javascript1.2") != 0 &&
+                        type.compare("text/javascript1.3") != 0 &&
+                        type.compare("text/javascript1.4") != 0 &&
+                        type.compare("text/javascript1.5") != 0 &&
+                        type.compare("text/jscript") != 0 &&
+                        type.compare("text/ecmascript") != 0 &&
+                        type.compare("text/livescript") )
+                        javascript = false;
+                } else if( a ) {
+                    /*
+                     Mozilla 1.5 doesn't accept jscript or ecmascript, but WinIE 6 does.
+                     Mozilla 1.5 accepts javascript1.0, javascript1.4, and javascript1.5, but WinIE 6 accepts only 1.1 - 1.3.
+                     Neither Mozilla 1.5 nor WinIE 6 accept leading or trailing whitespace.
+                     We want to accept all the values that either of these browsers accept, but not other values.
+                     */
                     QString lang = DOMString(a).string();
                     lang = lang.lower();
-                    if( !lang.contains("javascript") &&
-                        !lang.contains("ecmascript") &&
-                        !lang.contains("livescript") &&
-                        !lang.contains("jscript") )
+                    if( lang.compare("") != 0 &&
+                        lang.compare("javascript") != 0 &&
+                        lang.compare("javascript1.0") != 0 &&
+                        lang.compare("javascript1.1") != 0 &&
+                        lang.compare("javascript1.2") != 0 &&
+                        lang.compare("javascript1.3") != 0 &&
+                        lang.compare("javascript1.4") != 0 &&
+                        lang.compare("javascript1.5") != 0 &&
+                        lang.compare("ecmascript") != 0 &&
+                        lang.compare("livescript") != 0 &&
+                        lang.compare("jscript") )
                         javascript = false;
                 }
             }
@@ -1599,7 +1636,7 @@
     int newsize = kMax(size*2, size+len);
     int oldoffs = (dest - buffer);
 
-    buffer = (QChar*)realloc(buffer, newsize*sizeof(QChar));
+    buffer = KHTML_REALLOC_QCHAR_VEC(buffer, newsize);
     dest = buffer + oldoffs;
     size = newsize;
 }
@@ -1607,7 +1644,7 @@
 void HTMLTokenizer::enlargeScriptBuffer(int len)
 {
     int newsize = kMax(scriptCodeMaxSize*2, scriptCodeMaxSize+len);
-    scriptCode = (QChar*)realloc(scriptCode, newsize*sizeof(QChar));
+    scriptCode = KHTML_REALLOC_QCHAR_VEC(scriptCode, newsize);
     scriptCodeMaxSize = newsize;
 }
 
@@ -1653,6 +1690,11 @@
     return cachedScript.count();
 }
 
+bool HTMLTokenizer::isExecutingScript() const
+{
+    return (m_executingScript > 0);
+}
+
 void HTMLTokenizer::setSrc(const QString& source)
 {
     lineno += src.lineCount();
diff -urN -x CVS kdelibs.orig/khtml/html/htmltokenizer.h kdelibs/khtml/html/htmltokenizer.h
--- kdelibs.orig/khtml/html/htmltokenizer.h	Wed Jun  9 12:35:00 2004
+++ kdelibs/khtml/html/htmltokenizer.h	Wed Nov 17 14:59:16 2004
@@ -24,7 +24,6 @@
 //----------------------------------------------------------------------------
 //
 // KDE HTML Widget -- Tokenizers
-// $Id$
 
 #ifndef HTMLTOKENIZER_H
 #define HTMLTOKENIZER_H
@@ -171,6 +170,7 @@
     void notifyFinished(khtml::CachedObject *finishedObj);
 
     virtual bool isWaitingForScripts() const;
+    virtual bool isExecutingScript() const;
 protected:
     // Internal buffers
     ///////////////////
Binary files kdelibs.orig/khtml/java/kjava.jar and kdelibs/khtml/java/kjava.jar differ
diff -urN -x CVS kdelibs.orig/khtml/java/kjavaapplet.h kdelibs/khtml/java/kjavaapplet.h
--- kdelibs.orig/khtml/java/kjavaapplet.h	Wed Aug 13 21:47:44 2003
+++ kdelibs/khtml/java/kjavaapplet.h	Wed Nov 17 14:43:02 2004
@@ -37,7 +37,6 @@
  * the Applet class files, and set the proper size of the Applet.  It also
  * has an interface for applets to resize themselves.
  *
- * @version $Id$
  * @author Richard J. Moore, rich@kde.org
  * @author Wynn Wilkes, wynnw@kde.org
  */
@@ -181,7 +180,7 @@
      * Returns status of applet- whether it's been created or not
      */
     bool isCreated();
- 
+
     /**
      * Run the applet.
      */
@@ -201,9 +200,9 @@
      * Set the applet ID.
      */
     void setAppletId( int id );
-    
+
     KJavaAppletContext* getContext() const { return context; }
-    
+
     /**
      * Get/Set the user name
      */
diff -urN -x CVS kdelibs.orig/khtml/java/kjavaappletcontext.cpp kdelibs/khtml/java/kjavaappletcontext.cpp
--- kdelibs.orig/khtml/java/kjavaappletcontext.cpp	Fri Mar 12 15:10:33 2004
+++ kdelibs/khtml/java/kjavaappletcontext.cpp	Wed Nov 10 10:00:23 2004
@@ -59,7 +59,7 @@
     id = contextCount;
     server->createContext( id, this );
 
-    contextCount++;
+    ++contextCount;
 }
 
 KJavaAppletContext::~KJavaAppletContext()
@@ -107,7 +107,7 @@
 
 void KJavaAppletContext::destroy( KJavaApplet* applet )
 {
-    int appletId = applet->appletId();
+    const int appletId = applet->appletId();
     d->applets.remove( appletId );
 
     server->destroyApplet( id, appletId );
@@ -139,9 +139,9 @@
     kdDebug(6100) << "arg count = " << arg.count() << endl;
 
     if ( cmd == QString::fromLatin1("showstatus")
-         && arg.count() > 0 )
+	 && !arg.empty() )
     {
-        QString tmp = arg[0];
+        QString tmp = arg.first();
         tmp.replace(QRegExp("[\n\r]"), "");
         kdDebug(6100) << "status message = " << tmp << endl;
         emit showStatus( tmp );
@@ -153,10 +153,10 @@
         emit showDocument( arg[0], arg[1] );
     }
     else if ( cmd == QString::fromLatin1( "showdocument" )
-              && arg.count() > 0 )
+              && !arg.empty() )
     {
-        kdDebug(6100) << "url = " << arg[0] << endl;
-        emit showDocument( arg[0], "_top" );
+        kdDebug(6100) << "url = " << arg.first() << endl;
+        emit showDocument( arg.first(), "_top" );
     }
     else if ( cmd == QString::fromLatin1( "resizeapplet" )
               && arg.count() > 2 )
@@ -165,9 +165,9 @@
         //arg[2] should be new width
         //arg[3] should be new height
         bool ok;
-        int appletID = arg[0].toInt( &ok );
-        int width = arg[1].toInt( &ok );
-        int height = arg[2].toInt( &ok );
+        const int appletID = arg[0].toInt( &ok );
+        const int width = arg[1].toInt( &ok );
+        const int height = arg[2].toInt( &ok );
 
         if( !ok )
         {
@@ -175,7 +175,7 @@
         }
         else
         {
-            KJavaApplet* tmp = d->applets[appletID];
+            KJavaApplet* const tmp = d->applets[appletID];
             if (tmp)
                 tmp->resizeAppletWidget( width, height );
         }
@@ -187,7 +187,7 @@
               && arg.count() > 2 )
     {
         bool ok;
-        int appletID = arg[0].toInt(&ok);
+        const int appletID = arg.first().toInt(&ok);
         KJavaApplet * applet;
         if (ok && (applet = d->applets[appletID]))
         {
@@ -201,13 +201,13 @@
     else if ( cmd == QString::fromLatin1( "AppletStateNotification" ) )
     {
         bool ok;
-        int appletID = arg[0].toInt(&ok);
+        const int appletID = arg.first().toInt(&ok);
         if (ok)
         {
-            KJavaApplet * applet = d->applets[appletID];
+            KJavaApplet* const applet = d->applets[appletID];
             if ( applet )
             {
-                int newState   = arg[1].toInt(&ok);
+                const int newState   = arg[1].toInt(&ok);
                 if (ok)
                 {
                     applet->stateChange(newState);
@@ -224,10 +224,10 @@
     }
     else if ( cmd == QString::fromLatin1( "AppletFailed" ) ) {
         bool ok;
-        int appletID = arg[0].toInt(&ok);
+        const int appletID = arg.first().toInt(&ok);
         if (ok)
         {
-            KJavaApplet * applet = d->applets[appletID];
+            KJavaApplet* const applet = d->applets[appletID];
             /*
             QString errorDetail(arg[1]);
             errorDetail.replace(QRegExp(":\\s*"), ":\n");
@@ -242,7 +242,8 @@
 
 void KJavaAppletContext::javaProcessExited(int) {
     AppletMap::iterator it = d->applets.begin();
-    for (; it != d->applets.end(); it++)
+    const AppletMap::iterator itEnd = d->applets.end();
+    for (; it != itEnd; ++it)
         if (!(*it).isNull() && (*it)->isCreated() && !(*it)->failed()) {
             (*it)->setFailed();
             if ((*it)->state() < KJavaApplet::INITIALIZED)
diff -urN -x CVS kdelibs.orig/khtml/java/kjavaappletcontext.h kdelibs/khtml/java/kjavaappletcontext.h
--- kdelibs.orig/khtml/java/kjavaappletcontext.h	Fri Mar 12 15:10:33 2004
+++ kdelibs/khtml/java/kjavaappletcontext.h	Wed Nov 17 14:43:02 2004
@@ -33,7 +33,6 @@
  * on contexts).  Currently, each document in KHTML creates one context, in
  * which multiple applets can run.
  *
- * @version $Id$
  * @author Richard J. Moore, rich@kde.org
  * @author Wynn Wilkes, wynnw@caldera.com
  */
@@ -62,7 +61,7 @@
     void setContextId( int id );
 
     /**
-     * registers applet 
+     * registers applet
      **/
     void registerApplet( KJavaApplet* );
 
diff -urN -x CVS kdelibs.orig/khtml/java/kjavaappletserver.cpp kdelibs/khtml/java/kjavaappletserver.cpp
--- kdelibs.orig/khtml/java/kjavaappletserver.cpp	Wed Jul  7 16:18:17 2004
+++ kdelibs/khtml/java/kjavaappletserver.cpp	Wed Nov 10 10:00:23 2004
@@ -179,13 +179,13 @@
       self->d->counter = 0;
    }
 
-   self->d->counter++;
+   ++(self->d->counter);
    return self;
 }
 
 void KJavaAppletServer::freeJavaServer()
 {
-    self->d->counter--;
+    --(self->d->counter);
 
     if( self->d->counter == 0 )
     {
@@ -196,7 +196,7 @@
         config.setGroup( "Java/JavaScript Settings" );
         if( config.readBoolEntry( "ShutdownAppletServer", true )  )
         {
-            int value = config.readNumEntry( "AppletServerTimeout", 60 );
+            const int value = config.readNumEntry( "AppletServerTimeout", 60 );
             QTimer::singleShot( value*1000, self, SLOT( checkShutdown() ) );
         }
     }
@@ -254,21 +254,24 @@
     dir.cdUp();
     kdDebug(6100) << "dir = " << dir.absPath() << endl;
 
-    QStringList entries = dir.entryList( "*.jar" );
+    const QStringList entries = dir.entryList( "*.jar" );
     kdDebug(6100) << "entries = " << entries.join( ":" ) << endl;
 
     QString classes;
-    for( QStringList::Iterator it = entries.begin();
-         it != entries.end(); it++ )
     {
-        if( !classes.isEmpty() )
-            classes += ":";
-        classes += dir.absFilePath( *it );
+        QStringList::ConstIterator it = entries.begin();
+	const QStringList::ConstIterator itEnd = entries.end();
+        for( ; it != itEnd; ++it )
+        {
+            if( !classes.isEmpty() )
+                classes += ":";
+            classes += dir.absFilePath( *it );
+        }
     }
     p->setClasspath( classes );
 
     // Fix all the extra arguments
-    QString extraArgs = config.readEntry( "JavaArgs" );
+    const QString extraArgs = config.readEntry( "JavaArgs" );
     p->setExtraArgs( extraArgs );
 
     if( config.readBoolEntry( "ShowJavaConsole", false) )
@@ -298,11 +301,11 @@
         // we do not know the applet url here so we just use a dummy url
         // this is a workaround for now
         // FIXME
-        KURL dummyURL( "http://www.kde.org/" );
-        QString httpProxy = KProtocolManager::proxyForURL(dummyURL);
+        const KURL dummyURL( "http://www.kde.org/" );
+        const QString httpProxy = KProtocolManager::proxyForURL(dummyURL);
         kdDebug(6100) << "httpProxy is " << httpProxy << endl;
 
-        KURL url( httpProxy );
+        const KURL url( httpProxy );
         p->setSystemProperty( "http.proxyHost", url.host() );
         p->setSystemProperty( "http.proxyPort", QString::number( url.port() ) );
     }
@@ -374,13 +377,14 @@
     args.append( windowTitle );
 
     //add on the number of parameter pairs...
-    int num = params.count();
-    QString num_params = QString("%1").arg( num, 8 );
+    const int num = params.count();
+    const QString num_params = QString("%1").arg( num, 8 );
     args.append( num_params );
 
-    QMap< QString, QString >::ConstIterator it;
+    QMap< QString, QString >::ConstIterator it = params.begin();
+    const QMap< QString, QString >::ConstIterator itEnd = params.end();
 
-    for( it = params.begin(); it != params.end(); ++it )
+    for( ; it != itEnd; ++it )
     {
         args.append( it.key() );
         args.append( it.data() );
@@ -442,7 +446,7 @@
 
 void KJavaAppletServer::removeDataJob( int loaderID )
 {
-    KIOJobMap::iterator it = d->kiojobs.find( loaderID );
+    const KIOJobMap::iterator it = d->kiojobs.find( loaderID );
     if (it != d->kiojobs.end()) {
         it.data()->deleteLater();
         d->kiojobs.erase( it );
@@ -451,7 +455,7 @@
 
 void KJavaAppletServer::quit()
 {
-    QStringList args;
+    const QStringList args;
 
     process->send( KJAS_SHUTDOWN_SERVER, args );
     process->flushBuffers();
@@ -465,10 +469,10 @@
     QString cmd;
     QStringList args;
     int index = 0;
-    int qb_size = qb.size();
+    const int qb_size = qb.size();
 
     //get the command code
-    char cmd_code = qb[ index++ ];
+    const char cmd_code = qb[ index++ ];
     ++index; //skip the next sep
 
     //get contextID
@@ -478,7 +482,7 @@
         contextID += qb[ index++ ];
     }
     bool ok;
-    int ID_num = contextID.toInt( &ok ); // context id or kio job id
+    const int ID_num = contextID.toInt( &ok ); // context id or kio job id
     /*if (d->locked_context > -1 &&
         ID_num != d->locked_context &&
         (cmd_code == KJAS_JAVASCRIPT_EVENT ||
@@ -541,28 +545,28 @@
             break;
 
         case KJAS_GET_URLDATA:
-            if (ok && args.size () > 0) {
-                d->kiojobs.insert(ID_num, new KJavaDownloader(ID_num, args[0]));
-                kdDebug(6100) << "GetURLData(" << ID_num << ") url=" << args[0] << endl;
+            if (ok && !args.empty() ) {
+                d->kiojobs.insert(ID_num, new KJavaDownloader(ID_num, args.first()));
+                kdDebug(6100) << "GetURLData(" << ID_num << ") url=" << args.first() << endl;
             } else
                 kdError(6100) << "GetURLData error " << ok << " args:" << args.size() << endl;
             return;
         case KJAS_PUT_URLDATA:
-            if (ok && args.size () > 0) {
-                KJavaUploader *job = new KJavaUploader(ID_num, args[0]);
+            if (ok && !args.empty()) {
+                KJavaUploader* const job = new KJavaUploader(ID_num, args.first());
                 d->kiojobs.insert(ID_num, job);
                 job->start();
-                kdDebug(6100) << "PutURLData(" << ID_num << ") url=" << args[0] << endl;
+                kdDebug(6100) << "PutURLData(" << ID_num << ") url=" << args.first() << endl;
             } else
                 kdError(6100) << "PutURLData error " << ok << " args:" << args.size() << endl;
             return;
         case KJAS_DATA_COMMAND:
-            if (ok && args.size () > 0) {
-                int cmd = args[0].toInt( &ok );
+            if (ok && !args.empty()) {
+                const int cmd = args.first().toInt( &ok );
                 KIOJobMap::iterator it = d->kiojobs.find( ID_num );
                 if (ok && it != d->kiojobs.end())
                     it.data()->jobCommand( cmd );
-                kdDebug(6100) << "KIO Data command: " << ID_num << " " << args[0] << endl;
+                kdDebug(6100) << "KIO Data command: " << ID_num << " " << args.first() << endl;
             } else
                 kdError(6100) << "KIO Data command error " << ok << " args:" << args.size() << endl;
             return;
@@ -574,7 +578,7 @@
         case KJAS_GET_MEMBER:
         case KJAS_PUT_MEMBER:
         case KJAS_CALL_MEMBER: {
-            int ticket = args[0].toInt();
+            const int ticket = args[0].toInt();
             JSStack::iterator it = d->jsstack.find(ticket);
             if (it != d->jsstack.end()) {
                 kdDebug(6100) << "slotJavaRequest: " << ticket << endl;
@@ -615,11 +619,11 @@
             if (!d->kssl) {
                 answer = "nossl";
             } else if (args.size() > 2) {
-                int certsnr = args[1].toInt();
+                const int certsnr = args[1].toInt();
                 QString text;
                 QPtrList<KSSLCertificate> certs;
                 certs.setAutoDelete( true );
-                for (int i = certsnr; i >= 0; i--) {
+                for (int i = certsnr; i >= 0; --i) {
                     KSSLCertificate * cert = KSSLCertificate::fromString(args[i+2].ascii());
                     if (cert) {
                         certs.prepend(cert);
@@ -669,8 +673,8 @@
                         text += subject.mid(1);
                     }
                 }
-                kdDebug(6100) << "Security confirm " << args[0] << certs.count() << endl;
-                if ( certs.count() ) {
+                kdDebug(6100) << "Security confirm " << args.first() << certs.count() << endl;
+		if ( !certs.isEmpty() ) {
                     KSSLCertChain chain;
                     chain.setChain( certs );
                     if ( chain.isValid() )
@@ -694,7 +698,7 @@
         return;
     }
 
-    KJavaAppletContext* context = d->contexts[ ID_num ];
+    KJavaAppletContext* const context = d->contexts[ ID_num ];
     if( context )
         context->processCmd( cmd, args );
     else if (cmd != "AppletStateNotification")
@@ -705,7 +709,8 @@
     kdDebug(6100) << "KJavaAppletServer::endWaitForReturnData" << endl;
     killTimers();
     JSStack::iterator it = d->jsstack.begin();
-    for (; it != d->jsstack.end(); ++it)
+    JSStack::iterator itEnd = d->jsstack.end();
+    for (; it != itEnd; ++it)
         it.data()->exit = true;
 }
 
@@ -776,28 +781,28 @@
     dialog->setModal( true );
     dialog->setCaption( i18n("Security Alert") );
 
-    QVBoxLayout * dialogLayout = new QVBoxLayout( dialog, 11, 6, "dialogLayout");
+    QVBoxLayout* const dialogLayout = new QVBoxLayout( dialog, 11, 6, "dialogLayout");
 
     dialogLayout->addWidget( new QLabel( i18n("Do you grant Java applet with certificate(s):"), dialog ) );
     dialogLayout->addWidget( new QLabel( cert, dialog, "message" ) );
     dialogLayout->addWidget( new QLabel( i18n("the following permission"), dialog, "message" ) );
     dialogLayout->addWidget( new QLabel( perm, dialog, "message" ) );
-    QSpacerItem * spacer2 = new QSpacerItem( 20, 40, QSizePolicy::Minimum, QSizePolicy::Expanding );
+    QSpacerItem* const spacer2 = new QSpacerItem( 20, 40, QSizePolicy::Minimum, QSizePolicy::Expanding );
     dialogLayout->addItem( spacer2 );
 
-    QHBoxLayout * buttonLayout = new QHBoxLayout( 0, 0, 6, "buttonLayout");
+    QHBoxLayout* const buttonLayout = new QHBoxLayout( 0, 0, 6, "buttonLayout");
 
-    QPushButton * no = new QPushButton( i18n("&No"), dialog, "no" );
+    QPushButton* const no = new QPushButton( i18n("&No"), dialog, "no" );
     no->setDefault( true );
     buttonLayout->addWidget( no );
 
-    QPushButton * reject = new QPushButton( i18n("&Reject All"), dialog, "reject" );
+    QPushButton* const reject = new QPushButton( i18n("&Reject All"), dialog, "reject" );
     buttonLayout->addWidget( reject );
 
-    QPushButton * yes = new QPushButton( i18n("&Yes"), dialog, "yes" );
+    QPushButton* const yes = new QPushButton( i18n("&Yes"), dialog, "yes" );
     buttonLayout->addWidget( yes );
 
-    QPushButton * grant = new QPushButton( i18n("&Grant All"), dialog, "grant" );
+    QPushButton* const grant = new QPushButton( i18n("&Grant All"), dialog, "grant" );
     buttonLayout->addWidget( grant );
     dialogLayout->addLayout( buttonLayout );
     dialog->resize( dialog->minimumSizeHint() );
diff -urN -x CVS kdelibs.orig/khtml/java/kjavaappletserver.h kdelibs/khtml/java/kjavaappletserver.h
--- kdelibs.orig/khtml/java/kjavaappletserver.h	Sat Mar 13 22:37:25 2004
+++ kdelibs/khtml/java/kjavaappletserver.h	Wed Nov 17 14:43:02 2004
@@ -32,7 +32,6 @@
 /**
  * @short Communicates with a KJAS server to display and control Java applets.
  *
- * @version $Id$
  * @author Richard J. Moore, rich@kde.org
  */
 
diff -urN -x CVS kdelibs.orig/khtml/java/kjavaappletviewer.cpp kdelibs/khtml/java/kjavaappletviewer.cpp
--- kdelibs.orig/khtml/java/kjavaappletviewer.cpp	Fri Oct  8 10:33:10 2004
+++ kdelibs/khtml/java/kjavaappletviewer.cpp	Wed Nov 10 10:00:23 2004
@@ -89,10 +89,10 @@
     ContextMap::key_type key = qMakePair (w, doc);
     ContextMap::iterator it = m_contextmap.find (key);
     if (it != m_contextmap.end ()) {
-        (*it).second++;
+        ++((*it).second);
         return (*it).first;
     }
-    KJavaAppletContext * context = new KJavaAppletContext ();
+    KJavaAppletContext* const context = new KJavaAppletContext ();
     m_contextmap.insert (key, qMakePair(context, 1));
     return context;
 }
@@ -119,12 +119,12 @@
     : KDialogBase (parent, "paramdialog", true, i18n ("Applet Parameters"),
                    KDialogBase::Close, KDialogBase::Close, true),
       m_appletWidget (parent) {
-    KJavaApplet * applet = parent->applet ();
+    KJavaApplet* const applet = parent->applet ();
     table = new QTable (30, 2, this);
     table->setMinimumSize (QSize (600, 400));
     table->setColumnWidth (0, 200);
     table->setColumnWidth (1, 340);
-    QHeader *header = table->horizontalHeader();
+    QHeader* const header = table->horizontalHeader();
     header->setLabel (0, i18n ("Parameter"));
     header->setLabel (1, i18n ("Value"));
     QTableItem * tit = new QTableItem (table, QTableItem::Never, i18n("Class"));
@@ -139,8 +139,9 @@
     table->setItem (2, 0, tit);
     tit = new QTableItem(table, QTableItem::Always, applet->archives());
     table->setItem (2, 1, tit);
-    QMap<QString,QString>::iterator it = applet->getParams().begin ();
-    for (int count = 2; it != applet->getParams().end (); ++it) {
+    QMap<QString,QString>::const_iterator it = applet->getParams().begin();
+    const QMap<QString,QString>::const_iterator itEnd = applet->getParams().end();
+    for (int count = 2; it != itEnd; ++it) {
         tit = new QTableItem (table, QTableItem::Always, it.key ());
         table->setItem (++count, 0, tit);
         tit = new QTableItem(table, QTableItem::Always, it.data ());
@@ -151,11 +152,12 @@
 
 void AppletParameterDialog::slotClose () {
     table->selectCells (0, 0, 0, 0);
-    KJavaApplet * applet = m_appletWidget->applet ();
+    KJavaApplet* const applet = m_appletWidget->applet ();
     applet->setAppletClass (table->item (0, 1)->text ());
     applet->setBaseURL (table->item (1, 1)->text ());
     applet->setArchives (table->item (2, 1)->text ());
-    for (int i = 3; i < table->numRows (); ++i) {
+    const int lim = table->numRows();
+    for (int i = 3; i < lim; ++i) {
         if (table->item (i, 0) && table->item (i, 1) && !table->item (i, 0)->text ().isEmpty ())
             applet->setParameter (table->item (i, 0)->text (),
                                   table->item (i, 1)->text ());
@@ -203,15 +205,16 @@
                                            new KJavaServerMaintainer);
     }
     m_view = new CoverWidget (wparent);
-    QString classname, classid, codebase, khtml_codebase;
+    QString classname, classid, codebase, khtml_codebase, src_param;
     int width = -1;
     int height = -1;
-    KJavaApplet * applet = m_view->appletWidget()->applet ();
-    QStringList::const_iterator it = args.begin ();
-    for ( ; it != args.end (); ++it) {
-        int equalPos = (*it).find("=");
+    KJavaApplet* const applet = m_view->appletWidget()->applet ();
+    QStringList::const_iterator it = args.begin();
+    const QStringList::const_iterator itEnd = args.end();
+    for ( ; it != itEnd; ++it) {
+        const int equalPos = (*it).find("=");
         if (equalPos > 0) {
-            QString name = (*it).left (equalPos).upper ();
+            const QString name = (*it).left (equalPos).upper ();
             QString value = (*it).right ((*it).length () - equalPos - 1);
             if (value.at(0)=='\"')
                 value = value.right (value.length () - 1);
@@ -219,7 +222,7 @@
                 value.truncate (value.length () - 1);
             kdDebug(6100) << "name=" << name << " value=" << value << endl;
             if (!name.isEmpty()) {
-                QString name_lower = name.lower ();
+                const QString name_lower = name.lower ();
                 if (name == "__KHTML__PLUGINBASEURL") {
                     baseurl = KURL (KURL (value), QString (".")).url ();
                 } else if (name == "__KHTML__CODEBASE")
@@ -232,9 +235,10 @@
                 //else if (name.lower()==QString::fromLatin1("classid"))
                     classid = value;
                 else if (name_lower == QString::fromLatin1("code") ||
-                         name_lower == QString::fromLatin1("java_code") ||
-                         name_lower == QString::fromLatin1("src"))
+                         name_lower == QString::fromLatin1("java_code"))
                     classname = value;
+                else if (name_lower == QString::fromLatin1("src"))
+                    src_param = value;
                 else if (name_lower == QString::fromLatin1("archive") ||
                          name_lower == QString::fromLatin1("java_archive") ||
                          name_lower.startsWith ("cache_archive"))
@@ -260,6 +264,10 @@
         else if (classname.isEmpty () && classid.startsWith ("java:"))
             classname = classid.mid(5);
     }
+    if (classname.isEmpty ())
+        classname = src_param;
+    else if (!src_param.isEmpty ())
+        applet->setParameter (QString ("SRC"), src_param);
     if (codebase.isEmpty ())
         codebase = khtml_codebase;
     if (baseurl.isEmpty ()) {
@@ -275,15 +283,15 @@
     }
     applet->setBaseURL (baseurl);
     // check codebase first
-    KURL kbaseURL( baseurl );
-    KURL newURL(kbaseURL, codebase);
+    const KURL kbaseURL( baseurl );
+    const KURL newURL(kbaseURL, codebase);
     if (kapp->authorizeURLAction("redirect", KURL(baseurl), newURL))
         applet->setCodeBase (newURL.url());
     applet->setAppletClass (classname);
-    KJavaAppletContext * cxt = serverMaintainer->getContext (parent, baseurl);
+    KJavaAppletContext* const cxt = serverMaintainer->getContext (parent, baseurl);
     applet->setAppletContext (cxt);
 
-    KJavaAppletServer * server = cxt->getServer ();
+    KJavaAppletServer* const server = cxt->getServer ();
 
     serverMaintainer->setServer (server);
 
@@ -349,8 +357,8 @@
 bool KJavaAppletViewer::openURL (const KURL & url) {
     if (!m_view) return false;
     m_closed = false;
-    KJavaAppletWidget * w = m_view->appletWidget ();
-    KJavaApplet * applet = w->applet ();
+    KJavaAppletWidget* const w = m_view->appletWidget ();
+    KJavaApplet* const applet = w->applet ();
     if (applet->isCreated ())
         applet->stop ();
     if (applet->appletClass ().isEmpty ()) {
@@ -376,7 +384,7 @@
 bool KJavaAppletViewer::closeURL () {
     kdDebug(6100) << "closeURL" << endl;
     m_closed = true;
-    KJavaApplet * applet = m_view->appletWidget ()->applet ();
+    KJavaApplet* const applet = m_view->appletWidget ()->applet ();
     if (applet->isCreated ())
         applet->stop ();
     applet->getContext()->getServer()->endWaitForReturnData();
@@ -394,14 +402,14 @@
 }
 
 void KJavaAppletViewer::delayedCreateTimeOut () {
-    KJavaAppletWidget * w = m_view->appletWidget ();
+    KJavaAppletWidget* const w = m_view->appletWidget ();
     if (!w->applet ()->isCreated () && !m_closed)
         w->showApplet ();
 }
 
 void KJavaAppletViewer::appletLoaded () {
     if (!m_view) return;
-    KJavaApplet * applet = m_view->appletWidget ()->applet ();
+    KJavaApplet* const applet = m_view->appletWidget ()->applet ();
     if (applet->isAlive() || applet->failed())
         emit completed();
 }
@@ -432,21 +440,22 @@
 }
 
 void KJavaAppletViewerBrowserExtension::saveState (QDataStream & stream) {
-    KJavaApplet * applet = static_cast<KJavaAppletViewer*>(parent())->view()->appletWidget ()->applet ();
+    KJavaApplet* const applet = static_cast<KJavaAppletViewer*>(parent())->view()->appletWidget ()->applet ();
     stream << applet->appletClass();
     stream << applet->baseURL();
     stream << applet->archives();
     stream << applet->getParams().size ();
-    QMap<QString,QString>::iterator it = applet->getParams().begin ();
-    for ( ; it != applet->getParams().end (); ++it) {
+    QMap<QString,QString>::const_iterator it = applet->getParams().begin();
+    const QMap<QString,QString>::const_iterator itEnd = applet->getParams().end();
+    for ( ; it != itEnd; ++it) {
         stream << it.key ();
         stream << it.data ();
     }
 }
 
 void KJavaAppletViewerBrowserExtension::restoreState (QDataStream & stream) {
-    KJavaAppletWidget * w = static_cast<KJavaAppletViewer*>(parent())->view()->appletWidget();
-    KJavaApplet * applet = w->applet ();
+    KJavaAppletWidget* const w = static_cast<KJavaAppletViewer*>(parent())->view()->appletWidget();
+    KJavaApplet* const applet = w->applet ();
     QString key, val;
     int paramcount;
     stream >> val;
@@ -469,7 +478,7 @@
 
 void KJavaAppletViewerBrowserExtension::showDocument (const QString & doc,
                                                       const QString & frame) {
-    KURL url (doc);
+    const KURL url (doc);
     KParts::URLArgs args;
     args.frameName = frame;
     emit openURLRequest (url, args);
@@ -489,12 +498,12 @@
     if (!m_viewer->appletAlive ())
         return false;
     QStringList args, ret_args;
-    KJavaApplet * applet = m_viewer->view ()->appletWidget ()->applet ();
+    KJavaApplet* const applet = m_viewer->view ()->appletWidget ()->applet ();
     args.append (QString::number (applet->appletId ()));
     args.append (QString::number ((int) objid));
     args.append (name);
     m_jssessions++;
-    bool ret = applet->getContext()->getMember (args, ret_args);
+    const bool ret = applet->getContext()->getMember (args, ret_args);
     m_jssessions--;
     if (!ret || ret_args.count() != 3) return false;
     bool ok;
@@ -512,14 +521,14 @@
     if (!m_viewer->appletAlive ())
         return false;
     QStringList args;
-    KJavaApplet * applet = m_viewer->view ()->appletWidget ()->applet ();
+    KJavaApplet* const applet = m_viewer->view ()->appletWidget ()->applet ();
     args.append (QString::number (applet->appletId ()));
     args.append (QString::number ((int) objid));
     args.append (name);
     args.append (value);
-    m_jssessions++;
-    bool ret = applet->getContext()->putMember (args);
-    m_jssessions--;
+    ++m_jssessions;
+    const bool ret = applet->getContext()->putMember (args);
+    --m_jssessions;
     return ret;
 }
 
@@ -527,19 +536,24 @@
 {
     if (!m_viewer->appletAlive ())
         return false;
-    KJavaApplet * applet = m_viewer->view ()->appletWidget ()->applet ();
+    KJavaApplet* const applet = m_viewer->view ()->appletWidget ()->applet ();
     QStringList args, ret_args;
     args.append (QString::number (applet->appletId ()));
     args.append (QString::number ((int) objid));
     args.append (func);
-    for (QStringList::const_iterator it=fargs.begin(); it != fargs.end(); ++it)
-        args.append(*it);
-    m_jssessions++;
-    bool ret = applet->getContext()->callMember (args, ret_args);
-    m_jssessions--;
+    {
+        QStringList::const_iterator it = fargs.begin();
+        const QStringList::const_iterator itEnd = fargs.end();
+	for ( ; it != itEnd; ++it)
+            args.append(*it);
+    }
+
+    ++m_jssessions;
+    const bool ret = applet->getContext()->callMember (args, ret_args);
+    --m_jssessions;
     if (!ret || ret_args.count () != 3) return false;
     bool ok;
-    int itype = ret_args[0].toInt (&ok);
+    const int itype = ret_args[0].toInt (&ok);
     if (!ok || itype < 0) return false;
     type = (KParts::LiveConnectExtension::Type) itype;
     retobjid = ret_args[1].toInt (&ok);
@@ -552,7 +566,7 @@
 {
     if (!m_viewer->view () || !m_viewer->view ())
         return;
-    KJavaApplet * applet = m_viewer->view ()->appletWidget ()->applet ();
+    KJavaApplet* const applet = m_viewer->view ()->appletWidget ()->applet ();
     if (!applet || objid == 0) {
         // typically a gc after a function call on the applet,
         // no need to send to the jvm
@@ -568,12 +582,19 @@
     if (args.count () < 2 || !m_viewer->appletAlive ())
         return;
     bool ok;
-    unsigned long objid = args[0].toInt(&ok);
-    QString event = args[1];
+    QStringList::ConstIterator it = args.begin();
+    const QStringList::ConstIterator itEnd = args.end();
+    const unsigned long objid = (*it).toInt(&ok);
+    ++it;
+    const QString event = (*it);
+    ++it;
     KParts::LiveConnectExtension::ArgList arglist;
-    for (unsigned i = 2; i < args.count(); i += 2)
+
+    for (; it != itEnd; ++it) {
         // take a deep breath here
-        arglist.push_back(KParts::LiveConnectExtension::ArgList::value_type((KParts::LiveConnectExtension::Type) args[i].toInt(), args[i+1]));
+        const QStringList::ConstIterator prev = it++;
+	arglist.push_back(KParts::LiveConnectExtension::ArgList::value_type((KParts::LiveConnectExtension::Type) (*prev).toInt(), (*it)));
+    }
     emit partEvent (objid, event, arglist);
 }
 
diff -urN -x CVS kdelibs.orig/khtml/java/kjavaappletviewer.desktop kdelibs/khtml/java/kjavaappletviewer.desktop
--- kdelibs.orig/khtml/java/kjavaappletviewer.desktop	Tue Aug 31 09:21:23 2004
+++ kdelibs/khtml/java/kjavaappletviewer.desktop	Thu Nov 11 08:50:26 2004
@@ -1,6 +1,7 @@
 [Desktop Entry]
 Encoding=UTF-8
 Name=Embedded Java Applet Viewer
+Name[af]=Ingelegde Java Program Bekyker
 Name[ar]=عارض بريمجات جافا المدمج
 Name[az]=Daxili Java Applet Nümayişçisi
 Name[bg]=Вграден визуализатор на аплети Java
@@ -29,9 +30,11 @@
 Name[ja]=埋め込み Java アプレットビューア
 Name[ko]=끼워넣은 자바 애플릿 보기
 Name[lt]=Įdedamas Java Applet žiūriklis
+Name[mk]=Вгнезден гледач на Java аплети
 Name[mn]=Суулгаж болох Жава Апплет Харагч
 Name[ms]=Pelihat Aplet Java Terserta
 Name[nb]=Innebygd Java Applet-viser
+Name[nds]=Inbett Kieker vör Java-Programmen
 Name[nl]=Ingebed Java Applet-weergaveprogramma
 Name[nn]=Innebygd Java-appletvisar
 Name[pa]=ਸ਼ਾਮਿਲ Java Applet ਦਰਸ਼ਕ
@@ -58,7 +61,7 @@
 Name[zh_TW]=Embedded Java Applet 檢視器
 X-KDE-Library=kjavaappletviewer
 Icon=java
-MimeType=application/x-java-applet;
+MimeType=application/x-java-applet;application/x-java;
 ServiceTypes=KParts/ReadOnlyPart,Browser/View
 Type=Service
 InitialPreference=2
diff -urN -x CVS kdelibs.orig/khtml/java/kjavaprocess.cpp kdelibs/khtml/java/kjavaprocess.cpp
--- kdelibs.orig/khtml/java/kjavaprocess.cpp	Sun Feb 29 12:24:20 2004
+++ kdelibs/khtml/java/kjavaprocess.cpp	Tue Nov 30 10:31:32 2004
@@ -127,12 +127,12 @@
 QByteArray* KJavaProcess::addArgs( char cmd_code, const QStringList& args )
 {
     //the buffer to store stuff, etc.
-    QByteArray* buff = new QByteArray();
+    QByteArray* const buff = new QByteArray();
     QTextOStream output( *buff );
-    char sep = 0;
+    const char sep = 0;
 
     //make space for the command size: 8 characters...
-    QCString space( "        " );
+    const QCString space( "        " );
     output << space;
 
     //write command code
@@ -145,8 +145,9 @@
     }
     else
     {
-        for( QStringList::ConstIterator it = args.begin();
-             it != args.end(); ++it )
+        QStringList::ConstIterator it = args.begin();
+        const QStringList::ConstIterator itEnd = args.end();
+        for( ; it != itEnd; ++it )
         {
             if( !(*it).isEmpty() )
             {
@@ -161,12 +162,12 @@
 
 void KJavaProcess::storeSize( QByteArray* buff )
 {
-    int size = buff->size() - 8;  //subtract out the length of the size_str
-    QString size_str = QString("%1").arg( size, 8 );
+    const int size = buff->size() - 8;  //subtract out the length of the size_str
+    const QString size_str = QString("%1").arg( size, 8 );
     kdDebug(6100) << "KJavaProcess::storeSize, size = " << size_str << endl;
 
     const char* size_ptr = size_str.latin1();
-    for( int i = 0; i < 8; i++ )
+    for( int i = 0; i < 8; ++i )
         buff->at(i) = size_ptr[i];
 }
 
@@ -183,7 +184,7 @@
 {
     if( isRunning() )
     {
-        QByteArray* buff = addArgs( cmd_code, args );
+        QByteArray* const buff = addArgs( cmd_code, args );
         storeSize( buff );
         kdDebug(6100) << "<KJavaProcess::send " << (int)cmd_code << endl;
         sendBuffer( buff );
@@ -197,9 +198,9 @@
     {
         kdDebug(6100) << "KJavaProcess::send, qbytearray is size = " << data.size() << endl;
 
-        QByteArray* buff = addArgs( cmd_code, args );
-        int cur_size = buff->size();
-        int data_size = data.size();
+        QByteArray* const buff = addArgs( cmd_code, args );
+        const int cur_size = buff->size();
+        const int data_size = data.size();
         buff->resize( cur_size + data_size );
         memcpy( buff->data() + cur_size, data.data(), data_size );
 
@@ -210,7 +211,7 @@
 
 void KJavaProcess::popBuffer()
 {
-    QByteArray* buf = d->BufferList.first();
+    QByteArray* const buf = d->BufferList.first();
     if( buf )
     {
 //        DEBUG stuff...
@@ -260,8 +261,10 @@
     }
 
     //set the system properties, iterate through the qmap of system properties
-    for( QMap<QString,QString>::Iterator it = d->systemProps.begin();
-         it != d->systemProps.end(); ++it )
+    QMap<QString,QString>::ConstIterator it = d->systemProps.begin();
+    const QMap<QString,QString>::ConstIterator itEnd = d->systemProps.end();
+
+    for( ; it != itEnd; ++it )
     {
         QString currarg;
 
@@ -281,8 +284,10 @@
     {
         // BUG HERE: if an argument contains space (-Dname="My name")
         // this parsing will fail. Need more sophisticated parsing -- use KShell?
-        QStringList args = QStringList::split( " ", d->extraArgs );
-        for ( QStringList::Iterator it = args.begin(); it != args.end(); ++it )
+        const QStringList args = QStringList::split( " ", d->extraArgs );
+        QStringList::ConstIterator it = args.begin();
+        const QStringList::ConstIterator itEnd = args.end();
+        for ( ; it != itEnd; ++it )
             *javaProcess << *it;
     }
 
@@ -294,7 +299,7 @@
     kdDebug(6100) << "Invoking JVM now...with arguments = " << endl;
     QString argStr;
     QTextOStream stream( &argStr );
-    QValueList<QCString> args = javaProcess->args();
+    const QValueList<QCString> args = javaProcess->args();
     qCopy( args.begin(), args.end(), QTextOStreamIterator<QCString>( stream, " " ) );
     kdDebug(6100) << argStr << endl;
 
@@ -302,7 +307,7 @@
                                      (KProcess::Stdin | KProcess::Stdout |
                                       KProcess::NoRead);
 
-    bool rval = javaProcess->start( KProcess::NotifyOnExit, flags );
+    const bool rval = javaProcess->start( KProcess::NotifyOnExit, flags );
     if( rval )
         javaProcess->resume(); //start processing stdout on the java process
     else
@@ -321,8 +326,12 @@
 
 void KJavaProcess::flushBuffers()
 {
-    while ( !d->BufferList.isEmpty() )
-        slotSendData(0);
+    while ( !d->BufferList.isEmpty() ) {
+        if (innot)
+            slotSendData(0);
+        else
+            d->BufferList.removeFirst();  //note: AutoDelete is true
+    }
 }
 
 /*  In this method, read one command and send it to the d->appletServer
@@ -333,7 +342,7 @@
     //read out the length of the message,
     //read the message and send it to the applet server
     char length[9] = { 0 };
-    int num_bytes = ::read( fd, length, 8 );
+    const int num_bytes = ::read( fd, length, 8 );
     if( !num_bytes )
     {
         len = 0;
@@ -346,9 +355,9 @@
         return;
     }
 
-    QString lengthstr( length );
+    const QString lengthstr( length );
     bool ok;
-    int num_len = lengthstr.toInt( &ok );
+    const int num_len = lengthstr.toInt( &ok );
     if( !ok )
     {
         kdError(6100) << "could not parse length out of: " << lengthstr << endl;
@@ -357,8 +366,8 @@
     }
 
     //now parse out the rest of the message.
-    char* msg = new char[num_len];
-    int num_bytes_msg = ::read( fd, msg, num_len );
+    char* const msg = new char[num_len];
+    const int num_bytes_msg = ::read( fd, msg, num_len );
     if( num_bytes_msg == -1 || num_bytes_msg != num_len )
     {
         kdError(6100) << "could not read the msg, num_bytes_msg = " << num_bytes_msg << endl;
diff -urN -x CVS kdelibs.orig/khtml/java/org/kde/javascript/JSObject.java kdelibs/khtml/java/org/kde/javascript/JSObject.java
--- kdelibs.orig/khtml/java/org/kde/javascript/JSObject.java	Sun Mar  7 22:22:09 2004
+++ kdelibs/khtml/java/org/kde/javascript/JSObject.java	Mon Nov 29 21:53:22 2004
@@ -1,7 +1,8 @@
 package org.kde.javascript;
 
 import java.applet.Applet;
-import org.kde.kjas.server.*;
+import org.kde.kjas.server.KJASAppletContext;
+import org.kde.kjas.server.Main;
 
 public class JSObject extends netscape.javascript.JSObject {
     public String returnvalue = null;
@@ -122,7 +123,7 @@
             int p1 = value.indexOf("ref=");
             int p2 = value.indexOf(']', p1+4);
             int objecthashcode = Integer.parseInt(value.substring(p1+4, p2));
-            return kc.getJSReferencedObject(objecthashcode);
+            return kc.getJSReferencedObject(applet, objecthashcode);
         }
         /* Ok, make it a JSObject */
         return new JSObject(applet, value, Integer.parseInt(type));
diff -urN -x CVS kdelibs.orig/khtml/java/org/kde/kjas/server/KJASAppletClassLoader.java kdelibs/khtml/java/org/kde/kjas/server/KJASAppletClassLoader.java
--- kdelibs.orig/khtml/java/org/kde/kjas/server/KJASAppletClassLoader.java	Sun May 16 22:05:11 2004
+++ kdelibs/khtml/java/org/kde/kjas/server/KJASAppletClassLoader.java	Mon Nov 29 21:53:22 2004
@@ -120,6 +120,9 @@
     private int myId = 0;
     private Vector statusListeners = new Vector();
     private AccessControlContext acc;
+    // a mapping JS referenced Java objects
+    private Hashtable jsReferencedObjects = new Hashtable();
+    final static RuntimePermission kjas_access = new RuntimePermission("accessClassInPackage.org.kde.kjas.server");
     
     public KJASAppletClassLoader( URL[] urlList, URL _docBaseURL, URL _codeBaseURL)
     {
@@ -210,79 +213,41 @@
         return codeBaseURL;
     }
 
+    Hashtable getJSReferencedObjects() {
+        return jsReferencedObjects;
+    }
     /***************************************************************************
      **** Class Loading Methods
      **************************************************************************/
     public synchronized Class findClass( String name ) throws ClassNotFoundException
     {
         Class rval = null;
-        try
-        {
-            //check for a system class
-            rval = findSystemClass( name );
-        } catch (ClassNotFoundException e )
-        {
-            String displayName = name;
-            // we lie a bit and do not display the inner
-            // classes because their names are ugly
-            int idx = name.indexOf('$');
-            if (idx > 0) {
-                displayName = name.substring(0, idx);
-            }
-            showStatus("Loading Class: " + displayName + "...");
-            //check the loaded classes 
-            rval = findLoadedClass( name );
-            if( rval == null ) {
-                try {
-                    rval =  super.findClass(name);
-                } catch (ClassFormatError cfe) {
-                    Main.debug(name + ": Catched " + cfe + ". Trying to repair...");
-                    rval = loadFixedClass( name );
-                } catch (Exception ex)
-                {
-                    Main.debug("findClass " + name + " " + ex.getMessage());
-                }
+        //check the loaded classes 
+        rval = findLoadedClass( name );
+        if( rval == null ) {
+            try {
+                rval =  super.findClass(name);
+            } catch (ClassFormatError cfe) {
+                Main.debug(name + ": Catched " + cfe + ". Trying to repair...");
+                rval = loadFixedClass( name );
+            } catch (Exception ex) {
+                Main.debug("findClass " + name + " " + ex.getMessage());
             }
         }
         if (rval == null) {
-            throw new ClassNotFoundException("Class:" + name);
+            throw new ClassNotFoundException("Class: " + name);
         }
         return rval;
     }
-    
-    private Hashtable loadedClasses = new Hashtable();
-    public synchronized Class loadClass( String name ) throws ClassNotFoundException
-    {
-        //Main.debug( dbgID + "loadClass, class name = " + name );
-        //We need to be able to handle foo.class, so strip off the suffix
-        String fixed_name = name;
-        /*
-        // need to convert to lowercase to match the suffix
-        // people from the windoze world don't know the difference
-        // see http://www.zdftext.de/
-        String lowerName = name.toLowerCase();
-        if( lowerName.endsWith( ".class" ) )
-        {
-            int max = lowerName.lastIndexOf( ".class" );
-            fixed_name = name.substring( 0, max);
-        }
-        else if( lowerName.endsWith( ".java" ) )
-        {
-            // be smart, some applets specify code=XyzClass.java
-            int max = lowerName.lastIndexOf( ".java" );
-            fixed_name = name.substring( 0, max);
-        }
-        */
-        Object o = loadedClasses.get(fixed_name);
-        if (o != null) {
-            Main.debug("already loaded: " + o);
-            return (Class)o;
-        }
-        Class cl = findClass(fixed_name);
-        //Class cl = super.loadClass(fixed_name);
-        //Main.debug(dbgID + " returns class " + cl.getName() + " Classloader=" + cl.getClassLoader());
-        return cl;
+    public Class loadClass(String name) throws ClassNotFoundException {
+        if (name.startsWith("org.kde.kjas.server")) {
+            SecurityManager sec = System.getSecurityManager();
+            if (sec != null)
+                sec.checkPermission(kjas_access);
+       }
+        return super.loadClass(name);
     }
+    private Hashtable loadedClasses = new Hashtable();
 
     private synchronized final Class loadFixedClass(String name) throws ClassNotFoundException {
         final String fileName = name.replace('.', '/') + ".class";
diff -urN -x CVS kdelibs.orig/khtml/java/org/kde/kjas/server/KJASAppletContext.java kdelibs/khtml/java/org/kde/kjas/server/KJASAppletContext.java
--- kdelibs.orig/khtml/java/org/kde/kjas/server/KJASAppletContext.java	Tue Aug 19 01:17:01 2003
+++ kdelibs/khtml/java/org/kde/kjas/server/KJASAppletContext.java	Mon Nov 29 21:53:22 2004
@@ -50,17 +50,7 @@
     private String myID;
     private KJASAppletClassLoader loader;
     private boolean active;
-    // a mapping JS referenced Java objects
-    private Hashtable jsReferencedObjects;
     private final static KJASAuthenticator authenticator = new KJASAuthenticator();
-    // keep this in sync with KParts::LiveConnectExtension::Type
-    private final static int JError    = -1;
-    private final static int JVoid     = 0;
-    private final static int JBoolean  = 1;
-    private final static int JFunction = 2;
-    private final static int JNumber   = 3;
-    private final static int JObject   = 4;
-    private final static int JString   = 5;
 
     /**
      * Create a KJASAppletContext
@@ -72,7 +62,6 @@
         pendingImages = new Vector();
         streams = new Hashtable();
         jsobjects = new Stack();
-        jsReferencedObjects = new Hashtable();
         myID   = _contextID;
         active = true;
     }
@@ -99,10 +88,6 @@
         return ((KJASAppletStub) stubs.get( appletId )).getApplet();
     }
 
-    public Object getJSReferencedObject(int objid) {
-        return jsReferencedObjects.get(new Integer(objid));
-    }
-
     public String getAppletName(String appletID) {
         KJASAppletStub stub = (KJASAppletStub) stubs.get(appletID);
         if (stub == null)
@@ -264,11 +249,10 @@
         {
             KJASAppletStub stub = (KJASAppletStub) e.nextElement();
             stub.destroyApplet();
+            stub.loader.getJSReferencedObjects().clear();
         }
 
         stubs.clear();
-        jsReferencedObjects.clear();
-        jsobjects.clear();
         active = false;
     }
 
@@ -415,64 +399,21 @@
                     jsobjects.push(jso);
                 }
             }
-            int [] types = { JString };
+            int [] types = { KJASAppletStub.JString };
             String [] arglist = { script };
             Main.protocol.sendJavaScriptEventCmd(myID, appletID, 0, "eval", types, arglist);
         }
     }
-    private int[] getJSTypeValue(Object obj, int objid, StringBuffer value) {
-        String val = obj.toString();
-        int[] rettype = { JError, objid };
-        String type = obj.getClass().getName();
-        if (type.equals("boolean") || type.equals("java.lang.Boolean"))
-            rettype[0] = JBoolean;
-        else if (type.equals("int") || type.equals("long") || 
-                type.equals("float") || type.equals("double") ||
-                type.equals("byte") || obj instanceof java.lang.Number)
-            rettype[0] = JNumber;
-        else if (type.equals("java.lang.String"))
-            rettype[0] = JString;
-        else {
-            rettype[0] = JObject;
-            rettype[1] = obj.hashCode();
-            jsReferencedObjects.put(new Integer(rettype[1]), obj);
-        }
-        value.insert(0, val);
-        return rettype;
-    }
-
-    public int[] getMember(String appletID, int objid, String name, StringBuffer value)
-    {
-        Main.debug("getMember: " + name);
-        Object o = null;
-        KJASAppletStub stub = null;
-        if (objid != 0)
-            o = jsReferencedObjects.get(new Integer(objid));
-        else {
-            stub = (KJASAppletStub) stubs.get( appletID );
-            if (stub != null)
-                o = ((KJASAppletStub) stubs.get( appletID )).getApplet();
-        } 
-        int ret[] = { JError, objid };
-        if (o == null || (stub != null && !stub.isLoaded()))
-            return ret;
-
-        Class c = o.getClass();
-        try {
-            Field field = c.getField(name);
-            ret = getJSTypeValue(field.get(o), objid, value);
-        } catch (Exception ex) {
-            Method [] m = c.getMethods();
-            for (int i = 0; i < m.length; i++)
-                if (m[i].getName().equals(name)) {
-                    ret[0] = JFunction;
-                    break;
-                }
-        }
-        return ret;
+
+    public boolean getMember(String appletID, int callid, int objid, String name)
+    {
+        KJASAppletStub stub = (KJASAppletStub) stubs.get( appletID );
+        if (stub == null || !stub.isLoaded())
+            return false;
+        return stub.getMember(callid, objid, name);
     }
 
-    public boolean putMember(String appletID, int objid, String name, String value)
+    public boolean putMember(String appletID, int callid, int objid, String name, String value)
     {
         if (name.equals("__lc_ret")) {
             // special case; return value of JS script evaluation
@@ -488,194 +429,33 @@
             try {
                 jso.thread.interrupt();
             } catch (SecurityException ex) {}
-            return true;
-        }
-        KJASAppletStub stub = null;
-        Object o = null;
-        if (objid != 0)
-            o = jsReferencedObjects.get(new Integer(objid));
-        else {
-            stub = (KJASAppletStub) stubs.get( appletID );
-            if (stub != null)
-                o = ((KJASAppletStub) stubs.get( appletID )).getApplet();
+            Main.protocol.sendPutMember( myID, callid, true ); 
         }
-        if (o == null || (stub != null && !stub.isLoaded())) {
-            Main.debug("Error in putValue: applet " + appletID + " not found");
-            return false;
-        }
-        Field f;
-        try {
-            f = o.getClass().getField(name);
-        } catch (Exception e) {
-            return false;
-        }
-        if (f == null) {
-            Main.debug("Error in putValue: " + name + " not found");
-            return false;
-        }
-        try {
-            String type = f.getType().getName();
-            Main.debug("putValue: (" + type + ")" + name + "=" + value);
-            if (type.equals("boolean"))
-                f.setBoolean(o, Boolean.getBoolean(value));
-            else if (type.equals("java.lang.Boolean"))
-                f.set(o, Boolean.valueOf(value));
-            else if (type.equals("int"))
-                f.setInt(o, Integer.parseInt(value));
-            else if (type.equals("java.lang.Integer"))
-                f.set(o, Integer.valueOf(value));
-            else if (type.equals("byte"))
-                f.setByte(o, Byte.parseByte(value));
-            else if (type.equals("java.lang.Byte"))
-                f.set(o, Byte.valueOf(value));
-            else if (type.equals("char"))
-                f.setChar(o, value.charAt(0));
-            else if (type.equals("java.lang.Character"))
-                f.set(o, new Character(value.charAt(0)));
-            else if (type.equals("double"))
-                f.setDouble(o, Double.parseDouble(value));
-            else if (type.equals("java.lang.Double"))
-                f.set(o, Double.valueOf(value));
-            else if (type.equals("float"))
-                f.setFloat(o, Float.parseFloat(value));
-            else if (type.equals("java.lang.Float"))
-                f.set(o, Float.valueOf(value));
-            else if (type.equals("long"))
-                f.setLong(o, Long.parseLong(value));
-            else if (type.equals("java.lang.Long"))
-                f.set(o, Long.valueOf(value));
-            else if (type.equals("short"))
-                f.setShort(o, Short.parseShort(value));
-            else if (type.equals("java.lang.Short"))
-                f.set(o, Short.valueOf(value));
-            else if (type.equals("java.lang.String"))
-                f.set(o, value);
-            else {
-                Main.debug("Error putValue: unsupported type: " + type);
-                return false;
-            }
-            return true;
-        } catch (Exception e) {
-            Main.debug("Exception in putValue: " + e.getMessage());
+        KJASAppletStub stub = (KJASAppletStub) stubs.get( appletID );
+        if (stub == null || !stub.isLoaded())
             return false;
-        }
-    }
-    private Method findMethod(Class c, String name, Class [] argcls) {
-        
-        try {
-            Method[] methods = c.getMethods();
-            for (int i = 0; i < methods.length; i++) {
-                Method m = methods[i];
-                if (m.getName().equals(name)) {
-                    Main.debug("Candidate: " + m);
-                    Class [] parameterTypes = m.getParameterTypes();
-                    if (argcls == null) {
-                        if (parameterTypes.length == 0) {
-                           return m;
-                        } 
-                    } else {
-                        if (argcls.length == parameterTypes.length) {
-                          for (int j = 0; j < argcls.length; j++) {
-                            // Main.debug("Parameter " + j + " " + parameterTypes[j]);
-                            argcls[j] = parameterTypes[j];
-                          }
-                          return m;                        
-                        }
-                    }
-                }
-            }
-        } catch (Exception e) {
-            e.printStackTrace();
-        }
-        return null;
+        return stub.putMember(callid, objid, name, value);
     }
 
-    /**
-    * converts Object <b>arg</b> into an object of class <b>cl</b>.
-    * @param arg Object to convert
-    * @param cl Destination class
-    * @return An Object of the specified class with the value specified
-    *  in <b>arg</b>
-    */
-    private static final Object cast(Object arg, Class cl) throws NumberFormatException {
-        Object ret = arg;
-        if (arg == null) {
-            ret = null;
-        }
-        else if (cl.isAssignableFrom(arg.getClass())) {
-            return arg;
-        }
-        else if (arg instanceof String) {
-            String s = (String)arg;
-            Main.debug("Argument String: \"" + s + "\"");
-            if (cl == Boolean.TYPE || cl == Boolean.class) {
-                ret = new Boolean(s);
-            } else if (cl == Integer.TYPE || cl == Integer.class) {
-                ret = new Integer(s);
-            } else if (cl == Long.TYPE || cl == Long.class) {
-                ret = new Long(s);
-            } else if (cl == Float.TYPE || cl == Float.class) {
-                ret = new Float(s);
-            } else if (cl == Double.TYPE || cl == Double.class) {
-                ret = new Double(s);
-            } else if (cl == Short.TYPE || cl == Short.class) {
-                ret = new Short(s);
-            } else if (cl  == Byte.TYPE || cl == Byte.class) {
-                ret = new Byte(s);
-            } else if (cl == Character.TYPE || cl == Character.class) {
-                ret = new Character(s.charAt(0));
-            }
-        }
-        return ret;
-    }
-    
-    public int[] callMember(String appletID, int objid, String name, StringBuffer value, java.util.List args)
-    {
-        Object o = null;
-        KJASAppletStub stub = null;
-        if (objid != 0)
-            o = jsReferencedObjects.get(new Integer(objid));
-        else {
-            stub = (KJASAppletStub) stubs.get( appletID );
-            if (stub != null)
-                o = ((KJASAppletStub) stubs.get( appletID )).getApplet();
-        }
-
-        int [] ret = { JError, objid };
-        if (o == null || (stub != null && !stub.isLoaded()))
-            return ret;
-
-        try {
-            Main.debug("callMember: " + name);
-            Object obj;
-            Class c = o.getClass();
-            String type;
-            Class [] argcls = new Class[args.size()];
-            for (int i = 0; i < args.size(); i++)
-                argcls[i] = name.getClass(); // String for now, will be updated by findMethod
-            Method m = findMethod(c, (String) name, argcls);
-            Main.debug("Found Method: " + m);
-            if (m != null) {
-                Object [] argobj = new Object[args.size()];
-                for (int i = 0; i < args.size(); i++) {
-                    argobj[i] = cast(args.get(i), argcls[i]);
-                }
-                Object retval =  m.invoke(o, argobj);
-                if (retval == null)
-                    ret[0] = JVoid;
-                else
-                    ret = getJSTypeValue(retval, objid, value);
-             }
-        } catch (Exception e) {
-            Main.debug("callMember threw exception: " + e.toString());
-            e.printStackTrace();
-        }
-        return ret;
+    public Object getJSReferencedObject(Applet applet, int objid)
+    {
+        return ((KJASAppletClassLoader)(applet.getClass().getClassLoader())).getJSReferencedObjects().get(new Integer(objid));
     }
-    public void derefObject(int objid) {
+    boolean callMember(String appletID, int cid, int oid, String n, java.util.List args)
+    {
+        KJASAppletStub stub = (KJASAppletStub) stubs.get( appletID );
+        if (stub == null || !stub.isLoaded())
+            return false;
+        return stub.callMember( cid, oid, n, args);
+    }
+    public void derefObject(String appletID, int objid) {
         if (objid == 0)
             return; // that's an applet
-        if (jsReferencedObjects.remove(new Integer(objid)) == null)
+        KJASAppletStub stub = (KJASAppletStub) stubs.get( appletID );
+        if (stub == null)
+            return;
+        Hashtable jsRefs = stub.loader.getJSReferencedObjects();
+        if (jsRefs.remove(new Integer(objid)) == null)
             Main.debug("couldn't remove referenced object");
     }
 
diff -urN -x CVS kdelibs.orig/khtml/java/org/kde/kjas/server/KJASAppletStub.java kdelibs/khtml/java/org/kde/kjas/server/KJASAppletStub.java
--- kdelibs.orig/khtml/java/org/kde/kjas/server/KJASAppletStub.java	Fri Oct  8 10:33:10 2004
+++ kdelibs/khtml/java/org/kde/kjas/server/KJASAppletStub.java	Mon Nov 29 21:53:24 2004
@@ -6,7 +6,12 @@
 import java.awt.*;
 import java.awt.event.*;
 import javax.swing.JFrame;
-
+import java.security.PrivilegedAction;
+import java.security.AccessController;
+import java.security.AccessControlContext;
+import java.security.ProtectionDomain;
+import java.lang.reflect.Field;
+import java.lang.reflect.Method;
 
 /**
  * The stub used by Applets to communicate with their environment.
@@ -29,6 +34,10 @@
     private JFrame            frame;
 
     /**
+    * out of bounds applet state :-), perform an action
+    */
+    public static final int ACTION = -1;
+    /**
     * applet state unknown
     */
     public static final int UNKNOWN = 0;
@@ -66,14 +75,34 @@
     private static final int FAILED = 8;
    
     
-    private KJASAppletClassLoader loader;
+    //private KJASAppletClassLoader loader;
+    KJASAppletClassLoader loader;
     private KJASAppletPanel       panel;
     private Applet                app;
     KJASAppletStub                me;
 
+    /**
+     * Interface for so called LiveConnect actions, put-, get- and callMember
+     */
+    // keep this in sync with KParts::LiveConnectExtension::Type
+    private final static int JError    = -1;
+    private final static int JVoid     = 0;
+    private final static int JBoolean  = 1;
+    private final static int JFunction = 2;
+    private final static int JNumber   = 3;
+    private final static int JObject   = 4;
+    final static int         JString   = 5;
+
+    interface AppletAction {
+        void apply();
+        void fail();
+    }
+
     private class RunThread extends Thread {
         private int request_state = CLASS_LOADED;
         private int current_state = UNKNOWN;
+        private Vector actions = new Vector();
+        private AccessControlContext acc = null;
 
         RunThread() {
             super("KJAS-AppletStub-" + appletID + "-" + appletName);
@@ -88,14 +117,27 @@
                 notifyAll();
             }
         }
+        synchronized void requestAction(AppletAction action) {
+            actions.add(action);
+            notifyAll();
+        }
         /**
          * Get the asked state
          */
         synchronized private int getRequestState() {
             while (request_state == current_state) {
-                try {
-                    wait ();
-                } catch(InterruptedException ie) {
+                if (!actions.isEmpty()) {
+                    if (current_state >= INITIALIZED && current_state < STOPPED)
+                        return ACTION;
+                    else {
+                        AppletAction action = (AppletAction) actions.remove(0);
+                        action.fail();
+                    }
+                } else {
+                    try {
+                        wait ();
+                    } catch(InterruptedException ie) {
+                    }
                 }
             }
             return request_state;
@@ -137,6 +179,7 @@
                         } else
                             throw e;
                     }
+                    acc = new AccessControlContext(new ProtectionDomain[] {app.getClass().getProtectionDomain()});
                     requestState(INITIALIZED);
                     break;
                 }
@@ -175,7 +218,6 @@
                     app.destroy();
                     frame.dispose();
                     app = null;
-                    loader = null;
                     requestState(TERMINATE);
                     break;
                 default:
@@ -188,24 +230,41 @@
         public void run() {
             while (true) {
                 int nstate = getRequestState();
-                if (nstate == TERMINATE)
+                if (nstate >= TERMINATE)
                     return;
-                try {
-                    doState(nstate);
-                } catch (Exception ex) {
-                    Main.kjas_err("Error during state " + nstate, ex);
-                    if (nstate < INITIALIZED) {
+                if (nstate == ACTION) {
+                    AccessController.doPrivileged(
+                            new PrivilegedAction() {
+                                public Object run() {
+                                    AppletAction action = (AppletAction) actions.remove(0);
+                                    try {
+                                        action.apply();
+                                    } catch (Exception ex) {
+                                        Main.debug("Error during action " + ex);
+                                        action.fail();
+                                    }
+                                    return null;
+                                }
+                            },
+                            acc);
+                } else { // move to nstate
+                    try {
+                        doState(nstate);
+                    } catch (Exception ex) {
+                        Main.kjas_err("Error during state " + nstate, ex);
+                        if (nstate < INITIALIZED) {
+                            setState(FAILED);
+                            setFailed(ex.toString());
+                            return;
+                        }
+                    } catch (Throwable tr) {
                         setState(FAILED);
-                        setFailed(ex.toString());
+                        setFailed(tr.toString());
                         return;
                     }
-                } catch (Throwable tr) {
-                    setState(FAILED);
-                    setFailed(tr.toString());
-                    return;
+                    setState(nstate);
+                    stateChange(nstate);
                 }
-                setState(nstate);
-                stateChange(nstate);
             }
         }
     }
@@ -413,6 +472,284 @@
         }
     }
 
+    /**
+    * converts Object <b>arg</b> into an object of class <b>cl</b>.
+    * @param arg Object to convert
+    * @param cl Destination class
+    * @return An Object of the specified class with the value specified
+    *  in <b>arg</b>
+    */
+    private static final Object cast(Object arg, Class cl) throws NumberFormatException {
+        Object ret = arg;
+        if (arg == null) {
+            ret = null;
+        }
+        else if (cl.isAssignableFrom(arg.getClass())) {
+            return arg;
+        }
+        else if (arg instanceof String) {
+            String s = (String)arg;
+            Main.debug("Argument String: \"" + s + "\"");
+            if (cl == Boolean.TYPE || cl == Boolean.class) {
+                ret = new Boolean(s);
+            } else if (cl == Integer.TYPE || cl == Integer.class) {
+                ret = new Integer(s);
+            } else if (cl == Long.TYPE || cl == Long.class) {
+                ret = new Long(s);
+            } else if (cl == Float.TYPE || cl == Float.class) {
+                ret = new Float(s);
+            } else if (cl == Double.TYPE || cl == Double.class) {
+                ret = new Double(s);
+            } else if (cl == Short.TYPE || cl == Short.class) {
+                ret = new Short(s);
+            } else if (cl  == Byte.TYPE || cl == Byte.class) {
+                ret = new Byte(s);
+            } else if (cl == Character.TYPE || cl == Character.class) {
+                ret = new Character(s.charAt(0));
+            }
+        }
+        return ret;
+    }
+    private Method findMethod(Class c, String name, Class [] argcls) {
+        try {
+            Method[] methods = c.getMethods();
+            for (int i = 0; i < methods.length; i++) {
+                Method m = methods[i];
+                if (m.getName().equals(name)) {
+                    Main.debug("Candidate: " + m);
+                    Class [] parameterTypes = m.getParameterTypes();
+                    if (argcls == null) {
+                        if (parameterTypes.length == 0) {
+                           return m;
+                        } 
+                    } else {
+                        if (argcls.length == parameterTypes.length) {
+                          for (int j = 0; j < argcls.length; j++) {
+                            // Main.debug("Parameter " + j + " " + parameterTypes[j]);
+                            argcls[j] = parameterTypes[j];
+                          }
+                          return m;                        
+                        }
+                    }
+                }
+            }
+        } catch (Exception e) {
+            e.printStackTrace();
+        }
+        return null;
+    }
+    private int[] getJSTypeValue(Hashtable jsRefs, Object obj, int objid, StringBuffer value) {
+        String val = obj.toString();
+        int[] rettype = { JError, objid };
+        String type = obj.getClass().getName();
+        if (type.equals("boolean") || type.equals("java.lang.Boolean"))
+            rettype[0] = JBoolean;
+        else if (type.equals("int") || type.equals("long") || 
+                type.equals("float") || type.equals("double") ||
+                type.equals("byte") || obj instanceof java.lang.Number)
+            rettype[0] = JNumber;
+        else if (type.equals("java.lang.String"))
+            rettype[0] = JString;
+        else if (!type.startsWith("org.kde.kjas.server") &&
+                 !(obj instanceof java.lang.Class &&
+                   ((Class)obj).getName().startsWith("org.kde.kjas.server"))) {
+            rettype[0] = JObject;
+            rettype[1] = obj.hashCode();
+            jsRefs.put(new Integer(rettype[1]), obj);
+        }
+        value.insert(0, val);
+        return rettype;
+    }
+    private class PutAction implements AppletAction {
+        int call_id;
+        int objid;
+        String name;
+        String value;
+        PutAction(int cid, int oid, String n, String v) {
+            call_id = cid;
+            objid = oid;
+            name = n;
+            value = v;
+        }
+        public void apply() {
+            Hashtable jsRefs = loader.getJSReferencedObjects();
+            Object o = objid==0 ? getApplet() : jsRefs.get(new Integer(objid));
+            if (o == null) {
+                Main.debug("Error in putValue: object " + objid + " not found");
+                fail();
+                return;
+            }
+            Field f;
+            try {
+                f = o.getClass().getField(name);
+            } catch (Exception e) {
+                fail();
+                return;
+            }
+            if (f == null) {
+                Main.debug("Error in putValue: " + name + " not found");
+                fail();
+                return;
+            }
+            try {
+                String type = f.getType().getName();
+                Main.debug("putValue: (" + type + ")" + name + "=" + value);
+                if (type.equals("boolean"))
+                    f.setBoolean(o, Boolean.getBoolean(value));
+                else if (type.equals("java.lang.Boolean"))
+                    f.set(o, Boolean.valueOf(value));
+                else if (type.equals("int"))
+                    f.setInt(o, Integer.parseInt(value));
+                else if (type.equals("java.lang.Integer"))
+                    f.set(o, Integer.valueOf(value));
+                else if (type.equals("byte"))
+                    f.setByte(o, Byte.parseByte(value));
+                else if (type.equals("java.lang.Byte"))
+                    f.set(o, Byte.valueOf(value));
+                else if (type.equals("char"))
+                    f.setChar(o, value.charAt(0));
+                else if (type.equals("java.lang.Character"))
+                    f.set(o, new Character(value.charAt(0)));
+                else if (type.equals("double"))
+                    f.setDouble(o, Double.parseDouble(value));
+                else if (type.equals("java.lang.Double"))
+                    f.set(o, Double.valueOf(value));
+                else if (type.equals("float"))
+                    f.setFloat(o, Float.parseFloat(value));
+                else if (type.equals("java.lang.Float"))
+                    f.set(o, Float.valueOf(value));
+                else if (type.equals("long"))
+                    f.setLong(o, Long.parseLong(value));
+                else if (type.equals("java.lang.Long"))
+                    f.set(o, Long.valueOf(value));
+                else if (type.equals("short"))
+                    f.setShort(o, Short.parseShort(value));
+                else if (type.equals("java.lang.Short"))
+                    f.set(o, Short.valueOf(value));
+                else if (type.equals("java.lang.String"))
+                    f.set(o, value);
+                else {
+                    Main.debug("Error putValue: unsupported type: " + type);
+                    fail();
+                    return;
+                }
+            } catch (Exception e) {
+                Main.debug("Exception in putValue: " + e.getMessage());
+                fail();
+                return;
+            }
+            Main.protocol.sendPutMember( context.getID(), call_id, true ); 
+        }
+        public void fail() {
+            Main.protocol.sendPutMember( context.getID(), call_id, false ); 
+        }
+    }
+    private class GetAction implements AppletAction {
+        int call_id;
+        int objid;
+        String name;
+        GetAction(int cid, int oid, String n) {
+            call_id = cid;
+            objid = oid;
+            name = n;
+        }
+        public void apply() {
+            Main.debug("getMember: " + name);
+            StringBuffer value = new StringBuffer();
+            int ret[] = { JError, objid };
+            Hashtable jsRefs = loader.getJSReferencedObjects();
+            Object o = objid==0 ? getApplet() : jsRefs.get(new Integer(objid));
+            if (o == null) {
+                fail();
+                return;
+            }
+            Class c = o.getClass();
+            try {
+                Field field = c.getField(name);
+                ret = getJSTypeValue(jsRefs, field.get(o), objid, value);
+            } catch (Exception ex) {
+                Method [] m = c.getMethods();
+                for (int i = 0; i < m.length; i++)
+                    if (m[i].getName().equals(name)) {
+                        ret[0] = JFunction;
+                        break;
+                    }
+            }
+            Main.protocol.sendMemberValue(context.getID(), KJASProtocolHandler.GetMember, call_id, ret[0], ret[1], value.toString()); 
+        }
+        public void fail() {
+            Main.protocol.sendMemberValue(context.getID(), KJASProtocolHandler.GetMember, call_id, -1, 0, ""); 
+        }
+    }
+    private class CallAction implements AppletAction {
+        int call_id;
+        int objid;
+        String name;
+        java.util.List args;
+        CallAction(int cid, int oid, String n, java.util.List a) {
+            call_id = cid;
+            objid = oid;
+            name = n;
+            args = a;
+        }
+        public void apply() {
+            StringBuffer value = new StringBuffer();
+            Hashtable jsRefs = loader.getJSReferencedObjects();
+            int [] ret = { JError, objid };
+            Object o = objid==0 ? getApplet() : jsRefs.get(new Integer(objid));
+            if (o == null) {
+                fail();
+                return;
+            }
+
+            try {
+                Main.debug("callMember: " + name);
+                Object obj;
+                Class c = o.getClass();
+                String type;
+                Class [] argcls = new Class[args.size()];
+                for (int i = 0; i < args.size(); i++)
+                    argcls[i] = name.getClass(); // String for now, will be updated by findMethod
+                Method m = findMethod(c, (String) name, argcls);
+                Main.debug("Found Method: " + m);
+                if (m != null) {
+                    Object [] argobj = new Object[args.size()];
+                    for (int i = 0; i < args.size(); i++) {
+                        argobj[i] = cast(args.get(i), argcls[i]);
+                    }
+                    Object retval =  m.invoke(o, argobj);
+                    if (retval == null)
+                        ret[0] = JVoid;
+                    else
+                        ret = getJSTypeValue(jsRefs, retval, objid, value);
+                }
+            } catch (Exception e) {
+                Main.debug("callMember threw exception: " + e.toString());
+            }
+            Main.protocol.sendMemberValue(context.getID(), KJASProtocolHandler.CallMember, call_id, ret[0], ret[1], value.toString()); 
+        }
+        public void fail() {
+            Main.protocol.sendMemberValue(context.getID(), KJASProtocolHandler.CallMember, call_id, -1, 0, ""); 
+        }
+    }
+    boolean putMember(int callid, int objid, String name, String val) {
+        if (runThread == null)
+            return false;
+        runThread.requestAction( new PutAction( callid, objid, name, val) );
+        return true;
+    }
+    boolean getMember(int cid, int oid, String name) {
+        if (runThread == null)
+            return false;
+        runThread.requestAction( new GetAction( cid, oid, name) );
+        return true;
+    }
+    boolean callMember(int cid, int oid, String name, java.util.List args) {
+        if (runThread == null)
+            return false;
+        runThread.requestAction( new CallAction( cid, oid, name, args) );
+        return true;
+    }
     /*************************************************************************
      ********************** AppletStub Interface *****************************
      *************************************************************************/
diff -urN -x CVS kdelibs.orig/khtml/java/org/kde/kjas/server/KJASProtocolHandler.java kdelibs/khtml/java/org/kde/kjas/server/KJASProtocolHandler.java
--- kdelibs.orig/khtml/java/org/kde/kjas/server/KJASProtocolHandler.java	Fri Oct  8 10:33:11 2004
+++ kdelibs/khtml/java/org/kde/kjas/server/KJASProtocolHandler.java	Mon Nov 29 21:53:24 2004
@@ -28,8 +28,8 @@
     private static final int URLDataCode         = 13;
     private static final int ShutdownServerCode  = 14;
     private static final int JavaScriptEvent     = 15;
-    private static final int GetMember           = 16;
-    private static final int CallMember          = 17;
+    static final int GetMember                   = 16;
+    static final int CallMember                  = 17;
     private static final int PutMember           = 18;
     private static final int DerefObject         = 19;
 
@@ -249,28 +249,14 @@
         } else
         if (cmd_code_value == GetMember)
         {
-            new Thread("GetMember") {
-                int ticketnr, objid;
-                String contextID, appletID, name;
-                public void run() {
-                    int [] ret_type_obj = { -1, 0 };
-                    StringBuffer value = new StringBuffer();
-                    int type = 0;
-                    KJASAppletContext context = (KJASAppletContext) contexts.get( contextID );
-                    if ( context != null )
-                        ret_type_obj = context.getMember(appletID, objid, name, value);
-                    Main.debug( "GetMember " + name + "=" + value.toString());
-                    sendMemberValue(contextID, GetMember, ticketnr, ret_type_obj[0], ret_type_obj[1], value.toString()); 
-                }
-                void startIt(byte [] cmd) {
-                    ticketnr = Integer.parseInt( getArg( cmd ) );
-                    contextID = getArg( cmd );
-                    appletID  = getArg( cmd );
-                    objid  = Integer.parseInt( getArg( cmd ) );
-                    name  = getArg( cmd );
-                    start();
-                }
-            }.startIt(command);
+            int ticketnr = Integer.parseInt( getArg( command ) );
+            String contextID = getArg( command );
+            String appletID  = getArg( command );
+            int objid  = Integer.parseInt( getArg( command ) );
+            String name  = getArg( command );
+            KJASAppletContext context = (KJASAppletContext) contexts.get( contextID );
+            if ( context == null || !context.getMember(appletID, ticketnr, objid, name))
+                sendMemberValue(contextID, GetMember, ticketnr, -1, 0, ""); 
         } else
         if (cmd_code_value == PutMember)
         {
@@ -282,48 +268,28 @@
             String value  = getArg( command );
             boolean ret = false;
             KJASAppletContext context = (KJASAppletContext) contexts.get( contextID );
-            if ( context != null )
-                ret = context.putMember(appletID, objid, name, value);
-            Main.debug( "PutMember " + name + "=" + value);
-            sendPutMember(contextID, ticketnr, ret); 
+            if (context == null || !context.putMember(appletID, ticketnr, objid, name, value))
+                sendPutMember(contextID, ticketnr, false); 
         } else
         if (cmd_code_value == CallMember)
         {
-            new Thread("CallMember") {
-                int ticketnr, objid;
-                String contextID, appletID, name;
-                java.util.List args = new java.util.Vector();
-                public void run() {
-                    int [] ret_type_obj = { -1, 0 };
-                    StringBuffer value = new StringBuffer();
-                    int type = 0;
-
-                    KJASAppletContext context = (KJASAppletContext) contexts.get( contextID );
-                    if ( context != null )
-                        ret_type_obj = context.callMember(appletID, objid, name, value, args);
-                    Main.debug( "CallMember " + name + "=" + value.toString());
-                    sendMemberValue(contextID, CallMember, ticketnr, ret_type_obj[0], ret_type_obj[1], value.toString()); 
-                }
-                void startIt(byte [] cmd) {
-                    ticketnr = Integer.parseInt( getArg( cmd ) );
-                    contextID = getArg( cmd );
-                    appletID  = getArg( cmd );
-                    objid  = Integer.parseInt( getArg( cmd ) );
-                    name  = getArg( cmd );
-                    try { // fix getArg
-                        String param = getArg(cmd);
-                        while (param != null) {
-                            args.add(param);
-                            param = getArg(cmd);
-                        }
-                    } catch (Exception e) {}
-                    start();
+            int ticketnr = Integer.parseInt( getArg( command ) );
+            String contextID = getArg( command );
+            String appletID  = getArg( command );
+            int objid  = Integer.parseInt( getArg( command ) );
+            String name  = getArg( command );
+            java.util.List args = new java.util.Vector();
+            try { // fix getArg
+                String param = getArg(command);
+                while (param != null) {
+                    args.add(param);
+                    param = getArg(command);
                 }
-            }.startIt(command);
-        /*    if ( context != null )
-                ret_type_obj = context.callMember(appletID, objid, name, value, args);
-            Main.debug( "CallMember " + name + "=" + value.toString());
-            sendMemberValue(contextID, CallMember, ret_type_obj[0], ret_type_obj[1], value.toString()); */
+            } catch (Exception e) {}
+
+            KJASAppletContext context = (KJASAppletContext) contexts.get( contextID );
+            if ( context == null || !context.callMember(appletID, ticketnr, objid, name, args))
+                Main.protocol.sendMemberValue(contextID, CallMember, ticketnr, -1, 0, ""); 
         } else
         if (cmd_code_value == DerefObject)
         {
@@ -332,7 +298,7 @@
             String objid  = getArg( command );
             KJASAppletContext context = (KJASAppletContext) contexts.get( contextID );
             if ( context != null )
-                context.derefObject(Integer.parseInt(objid));
+                context.derefObject(appletID, Integer.parseInt(objid));
             Main.debug( "DerefObject " + objid);
         } else
         if (cmd_code_value == SecurityConfirmCode)
diff -urN -x CVS kdelibs.orig/khtml/java/org/kde/kjas/server/Main.java kdelibs/khtml/java/org/kde/kjas/server/Main.java
--- kdelibs.orig/khtml/java/org/kde/kjas/server/Main.java	Tue Jan 13 21:40:45 2004
+++ kdelibs/khtml/java/org/kde/kjas/server/Main.java	Mon Nov 29 21:53:25 2004
@@ -1,4 +1,4 @@
-    package org.kde.kjas.server;
+package org.kde.kjas.server;
 
 import java.io.*;
 import java.security.*;
@@ -15,15 +15,15 @@
 {
     //We need to save a reference to the original stdout
     //for sending messages back
-    public  static final KJASProtocolHandler protocol;
+    static final KJASProtocolHandler         protocol;
     private static       Console             console = null;
     private static final boolean             show_console;
     public  static final boolean             Debug;
     public  static final boolean             log;
     static final boolean                     cacheImages;
     static float                             java_version = (float) 0.0;
-    public static String                     proxyHost = null;
-    public static int                        proxyPort = 0;
+    static String                            proxyHost = null;
+    static int                               proxyPort = 0;
     private static boolean                   good_jdk = true;
 
     /**************************************************************************
@@ -100,7 +100,8 @@
         System.err.println( msg );
         t.printStackTrace();
     }
-
+    private Main() {
+    }
 
     /**************************************************************************
      * Main- create the command loop
diff -urN -x CVS kdelibs.orig/khtml/khtml.desktop kdelibs/khtml/khtml.desktop
--- kdelibs.orig/khtml/khtml.desktop	Tue Aug 31 09:21:23 2004
+++ kdelibs/khtml/khtml.desktop	Thu Nov 11 08:50:25 2004
@@ -35,11 +35,12 @@
 Comment[ko]=끼워넣는 HTML 보기 구성 요소
 Comment[lt]=Įdedamas HTML peržiūros komponentas
 Comment[lv]=Iegultā HTML skatīšanas komponente
-Comment[mk]=Вградлива компонента за гледање HTML
+Comment[mk]=Вгнездлива компонента за гледање HTML
 Comment[mn]=Суулгаж болох HTML харах бүрэлдхүүн хэсэг
 Comment[ms]=Komponen pelihat HTML boleh-serta
 Comment[mt]=Komponent integrat għall-wiri tal-HTML
 Comment[nb]=Inkluderbar komponent for HTML-visning
+Comment[nds]=Inbettbor HTML-Kieker-Komponent
 Comment[nl]=Ingebed HTML-weergavecomponent
 Comment[nn]=Inkluderbart komponent for HTML-vising
 Comment[nso]=Seripa seo se robatsegago sa pono ya HTML
@@ -73,7 +74,6 @@
 MimeType=text/html;text/xml;application/xhtml+xml;
 Icon=konqueror
 Name=KHTML
-Name[af]=Khtml
 Name[hi]=केएचटीएमएल (KHTML)
 ServiceTypes=KParts/ReadOnlyPart,Browser/View
 X-KDE-Library=libkhtmlpart
diff -urN -x CVS kdelibs.orig/khtml/khtml_caret.cpp kdelibs/khtml/khtml_caret.cpp
--- kdelibs.orig/khtml/khtml_caret.cpp	Tue Sep  7 14:31:35 2004
+++ kdelibs/khtml/khtml_caret.cpp	Wed Nov 10 10:00:14 2004
@@ -412,6 +412,7 @@
 {
   if (node->nodeType() == Node::TEXT_NODE) {
     outside = false;
+    outsideEnd = false;
     r = node->renderer();
     r_ofs = offset;
   } else if (node->nodeType() == Node::ELEMENT_NODE || node->nodeType() == Node::DOCUMENT_NODE) {
@@ -445,7 +446,7 @@
 	  r = child->renderer();
 	}
       }/*end if*/
-      
+
       // BRs cause troubles. Returns the previous render object instead,
       // giving it the attributes outside, outside end.
       if (r && r->isBR()) {
@@ -456,6 +457,7 @@
     } else {
       // Element has no children, treat offset to be inside the node.
       outside = false;
+      outsideEnd = false;
       r = node->renderer();
       r_ofs = 0;	// only offset 0 possible
     }
@@ -881,13 +883,15 @@
     // ### regard direction
     switch (s->textAlign()) {
       case LEFT:
+      case KHTML_LEFT:
       case TAAUTO:	// ### find out what this does
       case JUSTIFY:
         break;
       case CENTER:
-      case KONQ_CENTER:
+      case KHTML_CENTER:
         _x += cb->contentWidth() / 2;
         break;
+      case KHTML_RIGHT:
       case RIGHT:
         _x += cb->contentWidth();
         break;
@@ -1671,7 +1675,7 @@
     eff_r = node->renderer();
     Q_ASSERT(eff_r);	// this is a hard requirement
   }
-  
+
   bool result = globallyNavigable || eff_r->style()->userInput() == UI_ENABLED;
 #if DEBUG_CARETMODE > 0
   kdDebug(6200) << result << endl;
@@ -1937,11 +1941,8 @@
       }/*end if*/
     }/*end if*/
 
-#if 0
-    bool adjacent = ebit.isAdjacent();
-#endif
-
 #if DEBUG_CARETMODE > 0
+    bool adjacent = ebit.isAdjacent();
     kdDebug(6200) << "adjacent " << adjacent << " _peekNext " << _peekNext << " _peekNext->isInlineTextBox: " << (_peekNext ? _peekNext->isInlineTextBox() : false) << " !((*ebit)->isInlineTextBox): " << (*ebit ? !(*ebit)->isInlineTextBox() : true) << endl;
 #endif
 #if 0
diff -urN -x CVS kdelibs.orig/khtml/khtml_ext.cpp kdelibs/khtml/khtml_ext.cpp
--- kdelibs.orig/khtml/khtml_ext.cpp	Tue Oct  5 20:50:06 2004
+++ kdelibs/khtml/khtml_ext.cpp	Wed Nov 10 10:00:14 2004
@@ -30,6 +30,9 @@
 #include "khtmlview.h"
 #include "khtml_pagecache.h"
 #include "rendering/render_form.h"
+#include "rendering/render_image.h"
+#include "html/html_imageimpl.h"
+#include "misc/loader.h"
 #include "dom/html_form.h"
 #include "dom/html_image.h"
 #include <qclipboard.h>
@@ -85,13 +88,13 @@
 
 void KHTMLPartBrowserExtension::saveState( QDataStream &stream )
 {
-  kdDebug( 6050 ) << "saveState!" << endl;
+  //kdDebug( 6050 ) << "saveState!" << endl;
   m_part->saveState( stream );
 }
 
 void KHTMLPartBrowserExtension::restoreState( QDataStream &stream )
 {
-  kdDebug( 6050 ) << "restoreState!" << endl;
+  //kdDebug( 6050 ) << "restoreState!" << endl;
   m_part->restoreState( stream );
 }
 
@@ -342,6 +345,7 @@
   KHTMLPart *m_khtml;
   KURL m_url;
   KURL m_imageURL;
+  QString m_suggestedFilename;
 };
 
 
@@ -361,6 +365,13 @@
   if ( !e.isNull() && (e.elementId() == ID_IMG ||
                        (e.elementId() == ID_INPUT && !static_cast<DOM::HTMLInputElement>(e).src().isEmpty())))
   {
+    if (e.elementId() == ID_IMG) {
+      DOM::HTMLImageElementImpl *ie = static_cast<DOM::HTMLImageElementImpl*>(e.handle());
+      khtml::RenderImage *ri = dynamic_cast<khtml::RenderImage*>(ie->renderer());
+      if (ri && ri->contentObject()) {
+        d->m_suggestedFilename = static_cast<khtml::CachedImage*>(ri->contentObject())->suggestedFilename();
+      }
+    }
     isImage=true;
   }
 
@@ -376,7 +387,7 @@
       KConfig config("kuriikwsfilterrc");
       config.setGroup("General");
       QString engine = config.readEntry("DefaultSearchEngine");
-        
+
       // search text
       QString selectedText = khtml->selectedText();
       if ( selectedText.length()>18 ) {
@@ -487,7 +498,7 @@
     new KAction( i18n( "Copy Image Location" ), 0, this, SLOT( slotCopyImageLocation() ),
                  actionCollection(), "copyimagelocation" );
     QString name = KStringHandler::csqueeze(d->m_imageURL.fileName()+d->m_imageURL.query(), 25);
-    new KAction( i18n( "View Image (%1)" ).arg(name.replace("&", "&&")), 0, this, SLOT( slotViewImage() ),
+    new KAction( i18n( "View Image (%1)" ).arg(d->m_suggestedFilename.isEmpty() ? name.replace("&", "&&") : d->m_suggestedFilename.replace("&", "&&")), 0, this, SLOT( slotViewImage() ),
                  actionCollection(), "viewimage" );
   }
 
@@ -529,21 +540,23 @@
 {
   KIO::MetaData metaData;
   metaData["referrer"] = d->m_khtml->referrer();
-  saveURL( d->m_khtml->widget(), i18n( "Save Image As" ), d->m_imageURL, metaData );
+  saveURL( d->m_khtml->widget(), i18n( "Save Image As" ), d->m_imageURL, metaData, QString::null, 0, d->m_suggestedFilename );
 }
 
 void KHTMLPopupGUIClient::slotCopyLinkLocation()
 {
+  KURL safeURL(d->m_url);
+  safeURL.setPass(QString::null);
 #ifndef QT_NO_MIMECLIPBOARD
   // Set it in both the mouse selection and in the clipboard
   KURL::List lst;
-  lst.append( d->m_url );
+  lst.append( safeURL );
   QApplication::clipboard()->setSelectionMode(true);
   QApplication::clipboard()->setData( new KURLDrag( lst ) );
   QApplication::clipboard()->setSelectionMode(false);
   QApplication::clipboard()->setData( new KURLDrag( lst ) );
 #else
-  QApplication::clipboard()->setText( d->m_url.url() ); //FIXME(E): Handle multiple entries
+  QApplication::clipboard()->setText( safeURL.url() ); //FIXME(E): Handle multiple entries
 #endif
 }
 
@@ -554,16 +567,18 @@
 
 void KHTMLPopupGUIClient::slotCopyImageLocation()
 {
+  KURL safeURL(d->m_imageURL);
+  safeURL.setPass(QString::null);
 #ifndef QT_NO_MIMECLIPBOARD
   // Set it in both the mouse selection and in the clipboard
   KURL::List lst;
-  lst.append( d->m_imageURL);
+  lst.append( safeURL );
   QApplication::clipboard()->setSelectionMode(true);
   QApplication::clipboard()->setData( new KURLDrag( lst ) );
   QApplication::clipboard()->setSelectionMode(false);
   QApplication::clipboard()->setData( new KURLDrag( lst ) );
 #else
-  QApplication::clipboard()->setText(d->m_imageURL.url()); //FIXME(E): Handle multiple entries
+  QApplication::clipboard()->setText( safeURL.url() ); //FIXME(E): Handle multiple entries
 #endif
 }
 
@@ -630,7 +645,7 @@
         if( info.exists() ) {
           // TODO: use KIO::RenameDlg (shows more information)
           query = KMessageBox::warningYesNo( parent, i18n( "A file named \"%1\" already exists. " "Are you sure you want to overwrite it?" ).arg( info.fileName() ), i18n( "Overwrite File?" ), i18n( "Overwrite" ), KStdGuiItem::cancel() );
-       }
+        }
        }
    } while ( query == KMessageBox::No );
 
@@ -747,7 +762,7 @@
 }
 
 void KHTMLPartBrowserHostExtension::virtual_hook( int id, void *data )
-{ 
+{
   if (id == VIRTUAL_FIND_FRAME_PARENT)
   {
     FindFrameParentParams *param = static_cast<FindFrameParentParams*>(data);
diff -urN -x CVS kdelibs.orig/khtml/khtml_part.cpp kdelibs/khtml/khtml_part.cpp
--- kdelibs.orig/khtml/khtml_part.cpp	Thu Oct  7 14:34:20 2004
+++ kdelibs/khtml/khtml_part.cpp	Wed Nov 17 14:46:56 2004
@@ -35,6 +35,7 @@
 #include "dom/dom_element.h"
 #include "html/html_documentimpl.h"
 #include "html/html_baseimpl.h"
+#include "html/html_objectimpl.h"
 #include "html/html_miscimpl.h"
 #include "html/html_imageimpl.h"
 #include "html/html_objectimpl.h"
@@ -146,14 +147,52 @@
     };
 }
 
+void khtml::ChildFrame::liveConnectEvent(const unsigned long, const QString & event, const KParts::LiveConnectExtension::ArgList & args)
+{
+    if (!m_part || !m_frame || !m_liveconnect)
+        // hmmm
+        return;
+
+    QString script;
+    script.sprintf("%s(", event.latin1());
+
+    KParts::LiveConnectExtension::ArgList::const_iterator i = args.begin();
+    const KParts::LiveConnectExtension::ArgList::const_iterator argsBegin = i;
+    const KParts::LiveConnectExtension::ArgList::const_iterator argsEnd = args.end();
+
+    for ( ; i != argsEnd; ++i) {
+        if (i != argsBegin)
+            script += ",";
+        if ((*i).first == KParts::LiveConnectExtension::TypeString) {
+            script += "\"";
+            script += QString((*i).second).replace('\\', "\\\\").replace('"', "\\\"");
+            script += "\"";
+        } else
+            script += (*i).second;
+    }
+    script += ")";
+    kdDebug(6050) << "khtml::ChildFrame::liveConnectEvent " << script << endl;
+
+    KHTMLPart * part = ::qt_cast<KHTMLPart *>(m_part->parent());
+    if (!part)
+        return;
+    if (!m_jscript)
+        part->framejScript(m_part);
+    if (m_jscript) {
+        // we have a jscript => a part in an iframe
+        KJS::Completion cmp;
+        m_jscript->evaluate(QString::null, 1, script, 0L, &cmp);
+    } else
+        part->executeScript(m_frame->element(), script);
+}
 
 KHTMLFrameList::Iterator KHTMLFrameList::find( const QString &name )
 {
     Iterator it = begin();
-    Iterator e = end();
+    const Iterator e = end();
 
     for (; it!=e; ++it )
-        if ( (*it).m_name==name )
+        if ( (*it)->m_name==name )
             break;
 
     return it;
@@ -191,7 +230,7 @@
   setWidget( d->m_view );
 
   d->m_guiProfile = prof;
-  d->m_extension = new KHTMLPartBrowserExtension( this );
+  d->m_extension = new KHTMLPartBrowserExtension( this, "KHTMLBrowserExtension" );
   d->m_hostExtension = new KHTMLPartBrowserHostExtension( this );
   d->m_statusBarExtension = new KParts::StatusBarExtension( this );
   d->m_statusBarIconLabel = 0L;
@@ -445,6 +484,8 @@
   delete d->m_jsedlg;
   d->m_jsedlg = 0;
 
+  if (!parentPart()) // only delete d->m_frame if the top khtml_part closes
+      delete d->m_frame;
   delete d; d = 0;
   KHTMLFactory::deregisterPart( this );
 }
@@ -524,6 +565,7 @@
   }
 
   KParts::URLArgs args( d->m_extension->urlArgs() );
+
   // in case we have a) no frameset (don't test m_frames.count(), iframes get in there)
   // b) the url is identical with the currently
   // displayed one (except for the htmlref!) , c) the url request is not a POST
@@ -535,7 +577,7 @@
       HTMLDocumentImpl* htmlDoc = static_cast<HTMLDocumentImpl*>(d->m_doc);
       isFrameSet = htmlDoc->body() && (htmlDoc->body()->id() == ID_FRAMESET);
   }
-  
+
   if ( url.hasRef() && !isFrameSet )
   {
 
@@ -547,28 +589,25 @@
         kdDebug( 6050 ) << "KHTMLPart::openURL, jumping to anchor. m_url = " << url.url() << endl;
         m_url = url;
         emit started( 0L );
-        
+
         if ( !gotoAnchor( url.encodedHtmlRef()) )
           gotoAnchor( url.htmlRef() );
-        
+
         d->m_bComplete = true;
         if (d->m_doc)
         d->m_doc->setParsing(false);
-        
+
         kdDebug( 6050 ) << "completed..." << endl;
         emit completed();
         return true;
     }
-    //jump to the anchor AFTER layouting is done, otherwise the position of the
-    //anchor is not known and we have no clue to which coordinates to jump
-    else
-    {
-        disconnect(d->m_view, SIGNAL(finishedLayout()), this, SLOT(gotoAnchor()));
-        if ( !url.encodedHtmlRef().isEmpty() )
-          connect(d->m_view, SIGNAL(finishedLayout()), this, SLOT(gotoAnchor()));
-    }
   }
 
+  //jump to the anchor AFTER layouting is done, otherwise the position of the
+  //anchor is not known and we have no clue to which coordinates to jump
+  disconnect(d->m_view, SIGNAL(finishedLayout()), this, SLOT(gotoAnchor()));
+  connect(d->m_view, SIGNAL(finishedLayout()), this, SLOT(gotoAnchor()));
+
   // Save offset of viewport when page is reloaded to be compliant
   // to every other capable browser out there.
   if (args.reload) {
@@ -697,6 +736,8 @@
   d->m_bLoadEventEmitted = true; // don't want that one either
   d->m_cachePolicy = KProtocolManager::cacheControl(); // reset cache policy
 
+  disconnect(d->m_view, SIGNAL(finishedLayout()), this, SLOT(restoreScrollPosition()));
+
   KHTMLPageCache::self()->cancelFetch(this);
   if ( d->m_doc && d->m_doc->parsing() )
   {
@@ -718,22 +759,27 @@
     khtml::Cache::loader()->cancelRequests( d->m_doc->docLoader() );
 
   // tell all subframes to stop as well
-  ConstFrameIt it = d->m_frames.begin();
-  ConstFrameIt end = d->m_frames.end();
-  for (; it != end; ++it )
   {
-    if ( (*it).m_run )
-      (*it).m_run->abort();
-    if ( !( *it ).m_part.isNull() )
-      ( *it ).m_part->closeURL();
+    ConstFrameIt it = d->m_frames.begin();
+    const ConstFrameIt end = d->m_frames.end();
+    for (; it != end; ++it )
+    {
+      if ( (*it)->m_run )
+        (*it)->m_run->abort();
+      if ( !( *it )->m_part.isNull() )
+        ( *it )->m_part->closeURL();
+    }
   }
   // tell all objects to stop as well
-  for (it = d->m_objects.begin(); it != d->m_objects.end(); ++it )
   {
-    if ( !( *it ).m_part.isNull() )
-      ( *it ).m_part->closeURL();
+    ConstFrameIt it = d->m_objects.begin();
+    const ConstFrameIt end = d->m_objects.end();
+    for (; it != end; ++it)
+    {
+      if ( !( *it )->m_part.isNull() )
+        ( *it )->m_part->closeURL();
+    }
   }
-
   // Stop any started redirections as well!! (DA)
   if ( d && d->m_redirectionTimer.isActive() )
     d->m_redirectionTimer.stop();
@@ -797,8 +843,8 @@
 
 void KHTMLPart::setJScriptEnabled( bool enable )
 {
-  if ( !enable && jScriptEnabled() && d->m_jscript ) {
-    d->m_jscript->clear();
+  if ( !enable && jScriptEnabled() && d->m_frame && d->m_frame->m_jscript ) {
+    d->m_frame->m_jscript->clear();
   }
   d->m_bJScriptForce = enable;
   d->m_bJScriptOverride = true;
@@ -833,41 +879,63 @@
 #define DIRECT_LINKAGE_TO_ECMA
 
 #ifdef DIRECT_LINKAGE_TO_ECMA
-extern "C" { KJSProxy *kjs_html_init(KHTMLPart *khtmlpart); }
+extern "C" { KJSProxy *kjs_html_init(khtml::ChildFrame * childframe); }
 #endif
 
-KJSProxy *KHTMLPart::jScript()
+static bool createJScript(khtml::ChildFrame *frame)
 {
-  if (!jScriptEnabled()) return 0;
-
-  if ( !d->m_jscript )
-  {
 #ifndef DIRECT_LINKAGE_TO_ECMA
-    KLibrary *lib = KLibLoader::self()->library("kjs_html");
-    if ( !lib ) {
-      setJScriptEnabled( false );
-      return 0;
-    }
-    // look for plain C init function
-    void *sym = lib->symbol("kjs_html_init");
-    if ( !sym ) {
-      lib->unload();
-      setJScriptEnabled( false );
-      return 0;
-    }
-    typedef KJSProxy* (*initFunction)(KHTMLPart *);
-    initFunction initSym = (initFunction) sym;
-    d->m_jscript = (*initSym)(this);
-    d->m_kjs_lib = lib;
+  KLibrary *lib = KLibLoader::self()->library("kjs_html");
+  if ( !lib ) {
+    setJScriptEnabled( false );
+    return false;
+  }
+  // look for plain C init function
+  void *sym = lib->symbol("kjs_html_init");
+  if ( !sym ) {
+    lib->unload();
+    setJScriptEnabled( false );
+    return false;
+  }
+  typedef KJSProxy* (*initFunction)(khtml::ChildFrame *);
+  initFunction initSym = (initFunction) sym;
+  frame->m_jscript = (*initSym)(d->m_frame);
+  frame->m_kjs_lib = lib;
 #else
-    d->m_jscript = kjs_html_init(this);
-    // d->m_kjs_lib remains 0L.
+  frame->m_jscript = kjs_html_init(frame);
+  // frame->m_kjs_lib remains 0L.
 #endif
-    if (d->m_bJScriptDebugEnabled)
-        d->m_jscript->setDebugEnabled(true);
+  return true;
+}
+
+KJSProxy *KHTMLPart::jScript()
+{
+  if (!jScriptEnabled()) return 0;
+
+  if ( !d->m_frame ) {
+      KHTMLPart * p = parentPart();
+      if (!p) {
+          d->m_frame = new khtml::ChildFrame;
+          d->m_frame->m_part = this;
+      } else {
+          ConstFrameIt it = p->d->m_frames.begin();
+          const ConstFrameIt end = p->d->m_frames.end();
+          for (; it != end; ++it)
+              if ((*it)->m_part.operator->() == this) {
+                  d->m_frame = *it;
+                  break;
+              }
+      }
+      if ( !d->m_frame )
+        return 0;
   }
+  if ( !d->m_frame->m_jscript )
+    if (!createJScript(d->m_frame))
+      return 0;
+  if (d->m_bJScriptDebugEnabled)
+    d->m_frame->m_jscript->setDebugEnabled(true);
 
-  return d->m_jscript;
+  return d->m_frame->m_jscript;
 }
 
 QVariant KHTMLPart::crossFrameExecuteScript(const QString& target,  const QString& script)
@@ -981,7 +1049,8 @@
 QVariant KHTMLPart::executeScript(const QString& filename, int baseLine, const DOM::Node& n, const QString& script)
 {
 #ifdef KJS_VERBOSE
-  kdDebug(6070) << "executeScript: caller='" << name() << "' filename=" << filename << " baseLine=" << baseLine << " script=" << script << endl;
+  // The script is now printed by KJS's Parser::parse
+  kdDebug(6070) << "executeScript: caller='" << name() << "' filename=" << filename << " baseLine=" << baseLine /*<< " script=" << script*/ << endl;
 #endif
   KJSProxy *proxy = jScript();
 
@@ -1014,16 +1083,16 @@
 QVariant KHTMLPart::executeScript( const DOM::Node &n, const QString &script )
 {
 #ifdef KJS_VERBOSE
-  kdDebug(6070) << "KHTMLPart::executeScript caller='" << name() << "' node=" << n.nodeName().string().latin1() << "(" << (n.isNull() ? 0 : n.nodeType()) << ") " << script << endl;
+  kdDebug(6070) << "KHTMLPart::executeScript caller='" << name() << "' node=" << n.nodeName().string().latin1() << "(" << (n.isNull() ? 0 : n.nodeType()) << ") " /* << script */ << endl;
 #endif
   KJSProxy *proxy = jScript();
 
   if (!proxy || proxy->paused())
     return QVariant();
-  d->m_runningScripts++;
+  ++(d->m_runningScripts);
   KJS::Completion comp;
-  QVariant ret = proxy->evaluate( QString::null, 1, script, n, &comp );
-  d->m_runningScripts--;
+  const QVariant ret = proxy->evaluate( QString::null, 1, script, n, &comp );
+  --(d->m_runningScripts);
 
   /*
    *  Error handling
@@ -1113,10 +1182,26 @@
   return d->m_bPluginsEnabled;
 }
 
+static int s_DOMTreeIndentLevel = 0;
+
 void KHTMLPart::slotDebugDOMTree()
 {
   if ( d->m_doc && d->m_doc->firstChild() )
     qDebug("%s", d->m_doc->firstChild()->toString().string().latin1());
+
+  // Now print the contents of the frames that contain HTML
+
+  const int indentLevel = s_DOMTreeIndentLevel++;
+
+  ConstFrameIt it = d->m_frames.begin();
+  const ConstFrameIt end = d->m_frames.end();
+  for (; it != end; ++it )
+    if ( !( *it )->m_part.isNull() && (*it)->m_part->inherits( "KHTMLPart" ) ) {
+      KParts::ReadOnlyPart* const p = ( *it )->m_part;
+      kdDebug(6050) << QString().leftJustify(s_DOMTreeIndentLevel*4,' ') << "FRAME " << p->name() << " " << endl;
+      static_cast<KHTMLPart*>( p )->slotDebugDOMTree();
+    }
+  s_DOMTreeIndentLevel = indentLevel;
 }
 
 void KHTMLPart::slotDebugScript()
@@ -1187,23 +1272,23 @@
 
   {
     ConstFrameIt it = d->m_frames.begin();
-    ConstFrameIt end = d->m_frames.end();
+    const ConstFrameIt end = d->m_frames.end();
     for(; it != end; ++it )
     {
       // Stop HTMLRun jobs for frames
-      if ( (*it).m_run )
-        (*it).m_run->abort();
+      if ( (*it)->m_run )
+        (*it)->m_run->abort();
     }
   }
 
   {
-    QValueList<khtml::ChildFrame>::ConstIterator it = d->m_objects.begin();
-    QValueList<khtml::ChildFrame>::ConstIterator end = d->m_objects.end();
+    ConstFrameIt it = d->m_objects.begin();
+    const ConstFrameIt end = d->m_objects.end();
     for(; it != end; ++it )
     {
       // Stop HTMLRun jobs for objects
-      if ( (*it).m_run )
-        (*it).m_run->abort();
+      if ( (*it)->m_run )
+        (*it)->m_run->abort();
     }
   }
 
@@ -1216,8 +1301,8 @@
     d->m_doc->detach();
 
   // Moving past doc so that onUnload works.
-  if ( d->m_jscript )
-    d->m_jscript->clear();
+  if ( d->m_frame && d->m_frame->m_jscript )
+    d->m_frame->m_jscript->clear();
 
   // stopping marquees
   if (d->m_doc && d->m_doc->renderer() && d->m_doc->renderer()->layer())
@@ -1238,17 +1323,24 @@
 
   {
     ConstFrameIt it = d->m_frames.begin();
-    ConstFrameIt end = d->m_frames.end();
+    const ConstFrameIt end = d->m_frames.end();
     for(; it != end; ++it )
     {
-      if ( (*it).m_part )
+      if ( (*it)->m_part )
       {
-        partManager()->removePart( (*it).m_part );
-        delete (KParts::ReadOnlyPart *)(*it).m_part;
+        partManager()->removePart( (*it)->m_part );
+        delete (KParts::ReadOnlyPart *)(*it)->m_part;
       }
+      delete *it;
     }
   }
+  {
+    ConstFrameIt oi = d->m_objects.begin();
+    const ConstFrameIt oiEnd = d->m_objects.end();
 
+    for (; oi != oiEnd; ++oi )
+      delete *oi;
+  }
   d->m_frames.clear();
   d->m_objects.clear();
 
@@ -1442,13 +1534,13 @@
         d->m_lastModified = QString::null; // done on-demand by lastModified()
 
     // Reset contents position
-    d->m_view->setContentsPos( 0, 0 );
+    connect(d->m_view, SIGNAL(finishedLayout()), this, SLOT(restoreScrollPosition()));
   }
 
   KHTMLPageCache::self()->addData(d->m_cacheId, data);
   write( data.data(), data.size() );
-  if (d->m_jscript)
-    d->m_jscript->dataReceived();
+  if (d->m_frame && d->m_frame->m_jscript)
+    d->m_frame->m_jscript->dataReceived();
 }
 
 void KHTMLPart::slotRestoreData(const QByteArray &data )
@@ -1633,8 +1725,8 @@
   //kdDebug( 6050 ) << "slotFinished" << endl;
 
   KHTMLPageCache::self()->endData(d->m_cacheId);
-  if (d->m_jscript)
-    d->m_jscript->dataReceived();
+  if (d->m_frame && d->m_frame->m_jscript)
+    d->m_frame->m_jscript->dataReceived();
 
   if ( d->m_doc && d->m_doc->docLoader()->expireDate() && m_url.protocol().lower().startsWith("http"))
       KIO::http_update_cache(m_url, false, d->m_doc->docLoader()->expireDate());
@@ -1652,7 +1744,6 @@
   d->m_cacheId = 0;
   d->m_bComplete = false;
   d->m_bLoadEventEmitted = false;
-  d->m_bWalletOpened = false;
 
   if(url.isValid()) {
       QString urlString = url.url();
@@ -1694,11 +1785,16 @@
   else
     emit setWindowCaption( i18n( "[Untitled]" ) );
 
+  bool servedAsXHTML = args.serviceType == "application/xhtml+xml";
+  bool servedAsXML = KMimeType::mimeType(args.serviceType)->is( "text/xml" );
   // ### not sure if XHTML documents served as text/xml should use DocumentImpl or HTMLDocumentImpl
-  if (args.serviceType == "text/xml")
+  if ( servedAsXML && !servedAsXHTML ) { // any XML derivative, except XHTML
     d->m_doc = DOMImplementationImpl::instance()->createDocument( d->m_view );
-  else
+  } else {
     d->m_doc = DOMImplementationImpl::instance()->createHTMLDocument( d->m_view );
+    // HTML or XHTML? (#86446)
+    static_cast<HTMLDocumentImpl *>(d->m_doc)->setHTMLRequested( !servedAsXHTML );
+  }
 #ifndef KHTML_NO_CARET
 //  d->m_view->initCaret();
 #endif
@@ -1711,7 +1807,7 @@
   // about to load a new page.
   d->m_doc->setBaseURL( baseurl );
   d->m_doc->docLoader()->setShowAnimations( KHTMLFactory::defaultHTMLSettings()->showAnimations() );
-  emit docCreated(); // so that the parent can set the domain
+  emit docCreated();
 
   d->m_paUseStylesheet->setItems(QStringList());
   d->m_paUseStylesheet->setEnabled( false );
@@ -1821,10 +1917,10 @@
     d->m_doc->docLoader()->setShowAnimations( KHTMLSettings::KAnimationDisabled );
 
   ConstFrameIt it = d->m_frames.begin();
-  ConstFrameIt end = d->m_frames.end();
+  const ConstFrameIt end = d->m_frames.end();
   for (; it != end; ++it )
-    if ( !( *it ).m_part.isNull() && ( *it ).m_part->inherits( "KHTMLPart" ) ) {
-      KParts::ReadOnlyPart* p = ( *it ).m_part;
+    if ( !(*it)->m_part.isNull() && (*it)->m_part->inherits( "KHTMLPart" ) ) {
+      KParts::ReadOnlyPart* const p = ( *it )->m_part;
       static_cast<KHTMLPart*>( p )->stopAnimations();
     }
 }
@@ -1837,10 +1933,6 @@
 
   if (!d->m_view)
     return; // We are probably being destructed.
-  // check if the scrollbars are really needed for the content
-  // if not, remove them, relayout, and repaint
-
-  d->m_view->restoreScrollBar();
 
   checkCompleted();
 }
@@ -1850,8 +1942,8 @@
   if ( obj && obj->type() == khtml::CachedObject::Image && d->m_doc && d->m_doc->docLoader() == dl ) {
     KHTMLPart* p = this;
     while ( p ) {
-      KHTMLPart* op = p;
-      p->d->m_totalObjectCount++;
+      KHTMLPart* const op = p;
+      ++(p->d->m_totalObjectCount);
       p = p->parentPart();
       if ( !p && op->d->m_loadedObjects <= op->d->m_totalObjectCount
         && !op->d->m_progressUpdateTimer.isActive())
@@ -1865,8 +1957,8 @@
   if ( obj && obj->type() == khtml::CachedObject::Image && d->m_doc && d->m_doc->docLoader() == dl ) {
     KHTMLPart* p = this;
     while ( p ) {
-      KHTMLPart* op = p;
-      p->d->m_loadedObjects++;
+      KHTMLPart* const op = p;
+      ++(p->d->m_loadedObjects);
       p = p->parentPart();
       if ( !p && op->d->m_loadedObjects <= op->d->m_totalObjectCount && op->d->m_jobPercent <= 100
         && !op->d->m_progressUpdateTimer.isActive())
@@ -1932,7 +2024,7 @@
 
   const UDSEntry entry = dynamic_cast<KIO::StatJob *>( _job )->statResult();
   UDSEntry::ConstIterator it = entry.begin();
-  UDSEntry::ConstIterator end = entry.end();
+  const UDSEntry::ConstIterator end = entry.end();
   for ( ; it != end; ++it ) {
     if ( ( *it ).m_uds == UDS_MODIFICATION_TIME ) {
      break;
@@ -1970,23 +2062,27 @@
   bool bPendingChildRedirection = false;
   // Any frame that hasn't completed yet ?
   ConstFrameIt it = d->m_frames.begin();
-  ConstFrameIt end = d->m_frames.end();
+  const ConstFrameIt end = d->m_frames.end();
   for (; it != end; ++it ) {
-    if ( !(*it).m_bCompleted )
+    if ( !(*it)->m_bCompleted )
     {
-      //kdDebug( 6050 ) << this << " is waiting for " << ( *it ).m_part << endl;
+      //kdDebug( 6050 ) << this << " is waiting for " << (*it)->m_part << endl;
       return;
     }
     // Check for frames with pending redirections
-    if ( (*it).m_bPendingRedirection )
+    if ( (*it)->m_bPendingRedirection )
       bPendingChildRedirection = true;
   }
 
   // Any object that hasn't completed yet ?
-  for (it = d->m_objects.begin(); it != d->m_objects.end(); ++it )
-    if ( !(*it).m_bCompleted )
-      return;
+  {
+    ConstFrameIt oi = d->m_objects.begin();
+    const ConstFrameIt oiEnd = d->m_objects.end();
 
+    for (; oi != oiEnd; ++oi )
+      if ( !(*oi)->m_bCompleted )
+        return;
+  }
   // Are we still parsing - or have we done the completed stuff already ?
   if ( d->m_bComplete || (d->m_doc && d->m_doc->parsing()) )
     return;
@@ -2025,25 +2121,32 @@
       d->m_view->setContentsPos( d->m_extension->urlArgs().xOffset,
                                  d->m_extension->urlArgs().yOffset );
 
-  d->m_view->complete();
+  bool pendingAction = false;
 
   if ( !d->m_redirectURL.isEmpty() )
   {
-    // Do not start redirection for frames here! That action is
+    // DA: Do not start redirection for frames here! That action is
     // deferred until the parent emits a completed signal.
-    if ( parentPart() == 0 )
+    if ( parentPart() == 0 ) {
+      //kdDebug(6050) << this << " starting redirection timer" << endl;
       d->m_redirectionTimer.start( 1000 * d->m_delayRedirect, true );
+    } else {
+      //kdDebug(6050) << this << " not toplevel -> not starting redirection timer. Waiting for slotParentCompleted." << endl;
+    }
 
-    emit completed( true );
+    pendingAction = true;
   }
-  else
+  else if ( bPendingChildRedirection )
   {
-    if ( bPendingChildRedirection )
-      emit completed( true );
-    else
-      emit completed();
+    pendingAction = true;
   }
 
+  // the view will emit completed on our behalf,
+  // either now or at next repaint if one is pending
+
+  //kdDebug(6050) << this << " asks the view to emit completed. pendingAction=" << pendingAction << endl;
+  d->m_view->complete( pendingAction );
+
   // find the alternate stylesheets
   QStringList sheets;
   if (d->m_doc)
@@ -2070,13 +2173,16 @@
   if ( d->m_bLoadEventEmitted || !d->m_doc || d->m_doc->parsing() ) return;
 
   ConstFrameIt it = d->m_frames.begin();
-  ConstFrameIt end = d->m_frames.end();
+  const ConstFrameIt end = d->m_frames.end();
   for (; it != end; ++it )
-    if ( !(*it).m_bCompleted ) // still got a frame running -> too early
+    if ( !(*it)->m_bCompleted ) // still got a frame running -> too early
       return;
 
-  for (it = d->m_objects.begin(); it != d->m_objects.end(); ++it )
-    if ( !(*it).m_bCompleted ) // still got a object running -> too early
+  ConstFrameIt oi = d->m_objects.begin();
+  const ConstFrameIt oiEnd = d->m_objects.end();
+
+  for (; oi != oiEnd; ++oi )
+    if ( !(*oi)->m_bCompleted ) // still got a object running -> too early
       return;
 
   // Still waiting for images/scripts from the loader ?
@@ -2144,7 +2250,7 @@
 
 void KHTMLPart::slotRedirect()
 {
-  kdDebug() << k_funcinfo << endl;
+  kdDebug(6050) << this << " slotRedirect()" << endl;
   QString u = d->m_redirectURL;
   d->m_delayRedirect = 0;
   d->m_redirectURL = QString::null;
@@ -2259,7 +2365,8 @@
     disconnect(d->m_view, SIGNAL(finishedLayout()), this, SLOT(gotoAnchor()));
   }
 
-  if ( !gotoAnchor(m_url.encodedHtmlRef()) )
+  if ( m_url.hasRef() )
+    if ( !gotoAnchor(m_url.encodedHtmlRef()) )
       gotoAnchor(m_url.htmlRef());
 }
 
@@ -2364,20 +2471,25 @@
   this->*flag = value;
 
   // descend into child frames recursively
-  QValueList<khtml::ChildFrame>::Iterator it = m_frames.begin();
-  for (; it != m_frames.end(); ++it) {
-    KHTMLPart *part = static_cast<KHTMLPart *>((KParts::ReadOnlyPart *)(*it).m_part);
-    if (part->inherits("KHTMLPart"))
-      part->d->setFlagRecursively(flag, value);
-  }/*next it*/
-
+  {
+    QValueList<khtml::ChildFrame*>::Iterator it = m_frames.begin();
+    const QValueList<khtml::ChildFrame*>::Iterator itEnd = m_frames.end();
+    for (; it != itEnd; ++it) {
+      KHTMLPart* const part = static_cast<KHTMLPart *>((KParts::ReadOnlyPart *)(*it)->m_part);
+      if (part->inherits("KHTMLPart"))
+        part->d->setFlagRecursively(flag, value);
+    }/*next it*/
+  }
   // do the same again for objects
-  it = m_objects.begin();
-  for (; it != m_objects.end(); ++it) {
-    KHTMLPart *part = static_cast<KHTMLPart *>((KParts::ReadOnlyPart *)(*it).m_part);
-    if (part->inherits("KHTMLPart"))
-      part->d->setFlagRecursively(flag, value);
-  }/*next it*/
+  {
+    QValueList<khtml::ChildFrame*>::Iterator it = m_objects.begin();
+    const QValueList<khtml::ChildFrame*>::Iterator itEnd = m_objects.end();
+    for (; it != itEnd; ++it) {
+      KHTMLPart* const part = static_cast<KHTMLPart *>((KParts::ReadOnlyPart *)(*it)->m_part);
+      if (part->inherits("KHTMLPart"))
+        part->d->setFlagRecursively(flag, value);
+    }/*next it*/
+  }
 }
 
 void KHTMLPart::setCaretMode(bool enable)
@@ -2923,14 +3035,15 @@
 {
   //kdDebug(6050) << "slotHighlight index=" << index << " length=" << length << endl;
   QValueList<KHTMLPartPrivate::StringPortion>::Iterator it = d->m_stringPortions.begin();
+  const QValueList<KHTMLPartPrivate::StringPortion>::Iterator itEnd = d->m_stringPortions.end();
   QValueList<KHTMLPartPrivate::StringPortion>::Iterator prev = it;
   // We stop at the first portion whose index is 'greater than', and then use the previous one
-  while ( it != d->m_stringPortions.end() && (*it).index <= index )
+  while ( it != itEnd && (*it).index <= index )
   {
     prev = it;
     ++it;
   }
-  Q_ASSERT ( prev != d->m_stringPortions.end() );
+  Q_ASSERT ( prev != itEnd );
   DOM::NodeImpl* node = (*prev).node;
   Q_ASSERT( node );
 
@@ -2973,12 +3086,12 @@
   }
   // Now look for end node
   it = prev; // no need to start from beginning again
-  while ( it != d->m_stringPortions.end() && (*it).index < index + length )
+  while ( it != itEnd && (*it).index < index + length )
   {
     prev = it;
     ++it;
   }
-  Q_ASSERT ( prev != d->m_stringPortions.end() );
+  Q_ASSERT ( prev != itEnd );
 
   d->m_selectionEnd = (*prev).node;
   d->m_endOffset = index + length - (*prev).index;
@@ -3162,11 +3275,11 @@
 
     // Strip leading LFs
     while ((start < end) && (text[start] == '\n'))
-       start++;
+       ++start;
 
     // Strip excessive trailing LFs
     while ((start < (end-1)) && (text[end-1] == '\n') && (text[end-2] == '\n'))
-       end--;
+       --end;
 
     return text.mid(start, end-start);
 }
@@ -3183,7 +3296,7 @@
 
 DOM::Range KHTMLPart::selection() const
 {
-    DOM::Range r = document().createRange();DOM::Range();
+    DOM::Range r = document().createRange();
     r.setStart( d->m_selectionStart, d->m_startOffset );
     r.setEnd( d->m_selectionEnd, d->m_endOffset );
     return r;
@@ -3199,16 +3312,22 @@
 
 void KHTMLPart::setSelection( const DOM::Range &r )
 {
-    d->m_selectionStart = r.startContainer();
-    d->m_startOffset = r.startOffset();
-    d->m_selectionEnd = r.endContainer();
-    d->m_endOffset = r.endOffset();
-    d->m_doc->setSelection(d->m_selectionStart.handle(),d->m_startOffset,
-                           d->m_selectionEnd.handle(),d->m_endOffset);
+    // Quick-fix: a collapsed range shouldn't select the whole node.
+    // The real problem is in RenderCanvas::setSelection though (when index==0 the whole node is selected).
+    if ( r.collapsed() )
+        slotClearSelection();
+    else {
+        d->m_selectionStart = r.startContainer();
+        d->m_startOffset = r.startOffset();
+        d->m_selectionEnd = r.endContainer();
+        d->m_endOffset = r.endOffset();
+        d->m_doc->setSelection(d->m_selectionStart.handle(),d->m_startOffset,
+                               d->m_selectionEnd.handle(),d->m_endOffset);
 #ifndef KHTML_NO_CARET
-    bool v = d->m_view->placeCaret();
-    emitCaretPositionChanged(v ? d->caretNode() : 0, d->caretOffset());
+        bool v = d->m_view->placeCaret();
+        emitCaretPositionChanged(v ? d->caretNode() : 0, d->caretOffset());
 #endif
+    }
 }
 
 void KHTMLPart::slotClearSelection()
@@ -3351,7 +3470,9 @@
       QString mailtoMsg /* = QString::fromLatin1("<img src=%1>").arg(locate("icon", QString::fromLatin1("locolor/16x16/actions/mail_send.png")))*/;
       mailtoMsg += i18n("Email to: ") + KURL::decode_string(u.path());
       QStringList queries = QStringList::split('&', u.query().mid(1));
-      for (QStringList::Iterator it = queries.begin(); it != queries.end(); ++it)
+      QStringList::Iterator it = queries.begin();
+      const QStringList::Iterator itEnd = queries.end();
+      for (; it != itEnd; ++it)
         if ((*it).startsWith(QString::fromLatin1("subject=")))
           mailtoMsg += i18n(" - Subject: ") + KURL::decode_string((*it).mid(8));
         else if ((*it).startsWith(QString::fromLatin1("cc=")))
@@ -3398,7 +3519,6 @@
 //
 void KHTMLPart::urlSelected( const QString &url, int button, int state, const QString &_target, KParts::URLArgs args )
 {
-  kdDebug() << k_funcinfo << url << endl;
   bool hasTarget = false;
 
   QString target = _target;
@@ -3422,7 +3542,7 @@
     // ### ERROR HANDLING
     return;
 
-  kdDebug( 6000 ) << "urlSelected: complete URL:" << cURL.url() << " target = " << target << endl;
+  kdDebug(6050) << this << "urlSelected: complete URL:" << cURL.url() << " target=" << target << endl;
 
   if ( state & ControlButton )
   {
@@ -3464,7 +3584,7 @@
   if (args.redirectedRequest() && parentPart())
       args.metaData().insert("cross-domain", toplevelURL().url());
 
-  if ( hasTarget )
+  if ( hasTarget && target != "_self" && target != "_top" && target != "_blank" && target != "_parent" )
   {
     // unknown frame names should open in a new window.
     khtml::ChildFrame *frame = recursiveFrameRequest( this, cURL, args, false );
@@ -3524,7 +3644,7 @@
 {
   KHTMLInfoDlg *dlg = new KHTMLInfoDlg(NULL, "KHTML Page Info Dialog", false, WDestructiveClose);
   dlg->_close->setGuiItem(KStdGuiItem::close());
-  
+
   if (d->m_doc)
      dlg->_title->setText(d->m_doc->title().string());
 
@@ -3549,10 +3669,13 @@
     dlg->_lastModified->setText(lastModified());
 
   /* populate the list view now */
-  QStringList headers = QStringList::split("\n", d->m_httpHeaders);
+  const QStringList headers = QStringList::split("\n", d->m_httpHeaders);
 
-  for (QStringList::Iterator it = headers.begin(); it != headers.end(); ++it) {
-    QStringList header = QStringList::split(QRegExp(":[ ]+"), *it);
+  QStringList::ConstIterator it = headers.begin();
+  const QStringList::ConstIterator itEnd = headers.end();
+
+  for (; it != itEnd; ++it) {
+    const QStringList header = QStringList::split(QRegExp(":[ ]+"), *it);
     if (header.count() != 2)
        continue;
     new QListViewItem(dlg->_headers, header[0], header[1]);
@@ -3650,12 +3773,14 @@
     KSSLCertificate *x = KSSLCertificate::fromString(d->m_ssl_peer_certificate.local8Bit());
     if (x) {
        // Set the chain back onto the certificate
-       QStringList cl = QStringList::split(QString("\n"), d->m_ssl_peer_chain);
+       const QStringList cl = QStringList::split(QString("\n"), d->m_ssl_peer_chain);
        QPtrList<KSSLCertificate> ncl;
 
        ncl.setAutoDelete(true);
-       for (QStringList::Iterator it = cl.begin(); it != cl.end(); ++it) {
-          KSSLCertificate *y = KSSLCertificate::fromString((*it).local8Bit());
+       QStringList::ConstIterator it = cl.begin();
+       const QStringList::ConstIterator itEnd = cl.end();
+       for (; it != itEnd; ++it) {
+          KSSLCertificate* const y = KSSLCertificate::fromString((*it).local8Bit());
           if (y) ncl.append(y);
        }
 
@@ -3717,10 +3842,10 @@
 {
   bool frames = false;
 
-  QValueList<khtml::ChildFrame>::ConstIterator it = d->m_frames.begin();
-  QValueList<khtml::ChildFrame>::ConstIterator end = d->m_frames.end();
+  QValueList<khtml::ChildFrame*>::ConstIterator it = d->m_frames.begin();
+  const QValueList<khtml::ChildFrame*>::ConstIterator end = d->m_frames.end();
   for (; it != end; ++it )
-      if ( (*it).m_type == khtml::ChildFrame::Frame )
+      if ( (*it)->m_type == khtml::ChildFrame::Frame )
       {
           frames = true;
           break;
@@ -3767,15 +3892,14 @@
   d->m_paSaveBackground->setEnabled( !bgURL.isEmpty() );
 
   if ( d->m_paDebugScript )
-    d->m_paDebugScript->setEnabled( d->m_jscript );
+    d->m_paDebugScript->setEnabled( d->m_frame ? d->m_frame->m_jscript : 0L );
 }
 
 KParts::LiveConnectExtension *KHTMLPart::liveConnectExtension( const khtml::RenderPart *frame) const {
-    QValueList<khtml::ChildFrame>::ConstIterator it = d->m_objects.begin();
-    QValueList<khtml::ChildFrame>::ConstIterator end = d->m_objects.end();
-    for(; it != end; ++it )
-        if ((*it).m_frame == frame)
-            return (*it).m_liveconnect;
+    const ConstFrameIt end = d->m_objects.end();
+    for(ConstFrameIt it = d->m_objects.begin(); it != end; ++it )
+        if ((*it)->m_frame == frame)
+            return (*it)->m_liveconnect;
     return 0L;
 }
 
@@ -3786,15 +3910,15 @@
   FrameIt it = d->m_frames.find( frameName );
   if ( it == d->m_frames.end() )
   {
-    khtml::ChildFrame child;
+    khtml::ChildFrame * child = new khtml::ChildFrame;
     //kdDebug( 6050 ) << "inserting new frame into frame map " << frameName << endl;
-    child.m_name = frameName;
+    child->m_name = frameName;
     it = d->m_frames.append( child );
   }
 
-  (*it).m_type = isIFrame ? khtml::ChildFrame::IFrame : khtml::ChildFrame::Frame;
-  (*it).m_frame = frame;
-  (*it).m_params = params;
+  (*it)->m_type = isIFrame ? khtml::ChildFrame::IFrame : khtml::ChildFrame::Frame;
+  (*it)->m_frame = frame;
+  (*it)->m_params = params;
 
   // Support for <frame src="javascript:string">
   if ( url.find( QString::fromLatin1( "javascript:" ), 0, false ) == 0 )
@@ -3804,10 +3928,10 @@
       myurl.setProtocol("javascript");
       if ( res.type() == QVariant::String )
 	myurl.setPath(res.asString());
-      return processObjectRequest(&(*it), myurl, QString("text/html") );
+      return processObjectRequest(*it, myurl, QString("text/html") );
   }
   KURL u = url.isEmpty() ? KURL() : completeURL( url );
-  return requestObject( &(*it), u );
+  return requestObject( *it, u );
 }
 
 QString KHTMLPart::requestFrameName()
@@ -3818,17 +3942,17 @@
 bool KHTMLPart::requestObject( khtml::RenderPart *frame, const QString &url, const QString &serviceType,
                                const QStringList &params )
 {
-    kdDebug( 6005 ) << "KHTMLPart::requestObject " << this << " frame=" << frame << endl;
-  khtml::ChildFrame child;
-  QValueList<khtml::ChildFrame>::Iterator it = d->m_objects.append( child );
-  (*it).m_frame = frame;
-  (*it).m_type = khtml::ChildFrame::Object;
-  (*it).m_params = params;
+  //kdDebug( 6005 ) << "KHTMLPart::requestObject " << this << " frame=" << frame << endl;
+  khtml::ChildFrame *child = new khtml::ChildFrame;
+  FrameIt it = d->m_objects.append( child );
+  (*it)->m_frame = frame;
+  (*it)->m_type = khtml::ChildFrame::Object;
+  (*it)->m_params = params;
 
   KParts::URLArgs args;
   args.serviceType = serviceType;
-  if (!requestObject( &(*it), completeURL( url ), args ) && !(*it).m_run) {
-      (*it).m_bCompleted = true;
+  if (!requestObject( *it, completeURL( url ), args ) && !(*it)->m_run) {
+      (*it)->m_bCompleted = true;
       return false;
   }
   return true;
@@ -3851,6 +3975,8 @@
     return true;
   }
 
+  //kdDebug(6005) << "KHTMLPart::requestObject child=" << child << " child->m_part=" << child->m_part << endl;
+
   KParts::URLArgs args( _args );
 
   if ( child->m_run )
@@ -3950,25 +4076,19 @@
 
         checkEmitLoadEvent();
         return false;
-    } else if (child->m_frame) {
-        child->m_liveconnect = KParts::LiveConnectExtension::childObject(part);
-        DOM::NodeImpl* elm = child->m_frame->element();
-        if (elm)
-            switch (child->m_frame->element()->id()) {
-                case ID_APPLET:
-                case ID_EMBED:
-                case ID_OBJECT:
-                    static_cast<HTMLObjectBaseElementImpl*>(elm)->setLiveConnect(child->m_liveconnect);
-                default:
-                    break;
-            }
     }
 
     //CRITICAL STUFF
     if ( child->m_part )
     {
+      if (!::qt_cast<KHTMLPart*>(child->m_part) && child->m_jscript)
+          child->m_jscript->clear();
       partManager()->removePart( (KParts::ReadOnlyPart *)child->m_part );
       delete (KParts::ReadOnlyPart *)child->m_part;
+      if (child->m_liveconnect) {
+        disconnect(child->m_liveconnect, SIGNAL(partEvent(const unsigned long, const QString &, const KParts::LiveConnectExtension::ArgList &)), child, SLOT(liveConnectEvent(const unsigned long, const QString&, const KParts::LiveConnectExtension::ArgList &)));
+        child->m_liveconnect = 0L;
+      }
     }
 
     child->m_serviceType = mimetype;
@@ -3981,29 +4101,33 @@
 //      kdDebug(6005) << "AH! NO FRAME!!!!!" << endl;
 
     child->m_part = part;
-    assert( ((void*) child->m_part) != 0);
+
+    if (::qt_cast<KHTMLPart*>(part)) {
+      static_cast<KHTMLPart*>(part)->d->m_frame = child;
+    } else if (child->m_frame) {
+      child->m_liveconnect = KParts::LiveConnectExtension::childObject(part);
+      if (child->m_liveconnect)
+        connect(child->m_liveconnect, SIGNAL(partEvent(const unsigned long, const QString &, const KParts::LiveConnectExtension::ArgList &)), child, SLOT(liveConnectEvent(const unsigned long, const QString&, const KParts::LiveConnectExtension::ArgList &)));
+    }
 
     connect( part, SIGNAL( started( KIO::Job *) ),
              this, SLOT( slotChildStarted( KIO::Job *) ) );
     connect( part, SIGNAL( completed() ),
              this, SLOT( slotChildCompleted() ) );
-    if ( child->m_type != khtml::ChildFrame::Object )
-    {
-      connect( part, SIGNAL( completed(bool) ),
-               this, SLOT( slotChildCompleted(bool) ) );
-      connect( part, SIGNAL( setStatusBarText( const QString & ) ),
-               this, SIGNAL( setStatusBarText( const QString & ) ) );
-      if ( part->inherits( "KHTMLPart" ) )
-      {
-          connect( this, SIGNAL( completed() ),
-                   part, SLOT( slotParentCompleted() ) );
-          connect( this, SIGNAL( completed(bool) ),
-                   part, SLOT( slotParentCompleted() ) );
-          // As soon as the child's document is created, we need to set its domain
-          // (but we do so only once, so it can't be simply done in the child)
-          connect( part, SIGNAL( docCreated() ),
-                   this, SLOT( slotChildDocCreated() ) );
-      }
+    connect( part, SIGNAL( completed(bool) ),
+             this, SLOT( slotChildCompleted(bool) ) );
+    connect( part, SIGNAL( setStatusBarText( const QString & ) ),
+                this, SIGNAL( setStatusBarText( const QString & ) ) );
+    if ( part->inherits( "KHTMLPart" ) )
+    {
+      connect( this, SIGNAL( completed() ),
+               part, SLOT( slotParentCompleted() ) );
+      connect( this, SIGNAL( completed(bool) ),
+               part, SLOT( slotParentCompleted() ) );
+      // As soon as the child's document is created, we need to set its domain
+      // (but we do so only once, so it can't be simply done in the child)
+      connect( part, SIGNAL( docCreated() ),
+               this, SLOT( slotChildDocCreated() ) );
     }
 
     child->m_extension = KParts::BrowserExtension::childObject( part );
@@ -4122,15 +4246,23 @@
 
   KTrader::OfferList offers = KTrader::self()->query( mimetype, "KParts/ReadOnlyPart", constr, QString::null );
 
-  if ( offers.isEmpty() )
-    return 0L;
+  if ( offers.isEmpty() ) {
+    int pos = mimetype.find( "-plugin" );
+    if (pos < 0)
+        return 0L;
+    QString stripped_mime = mimetype.left( pos );
+    offers = KTrader::self()->query( stripped_mime, "KParts/ReadOnlyPart", constr, QString::null );
+    if ( offers.isEmpty() )
+        return 0L;
+  }
 
-  KTrader::OfferList::Iterator it = offers.begin();
-  for (  ; it != offers.end() ; ++it )
+  KTrader::OfferList::ConstIterator it = offers.begin();
+  const KTrader::OfferList::ConstIterator itEnd = offers.end();
+  for ( ; it != itEnd; ++it )
   {
     KService::Ptr service = (*it);
 
-    KLibFactory *factory = KLibLoader::self()->factory( QFile::encodeName(service->library()) );
+    KLibFactory* const factory = KLibLoader::self()->factory( QFile::encodeName(service->library()) );
     if ( factory ) {
       KParts::ReadOnlyPart *res = 0L;
 
@@ -4306,13 +4438,23 @@
       QStringList nvps = QStringList::split("&", q);
       bool triedToAttach = false;
 
-      for (QStringList::Iterator nvp = nvps.begin(); nvp != nvps.end(); ++nvp) {
-         QStringList pair = QStringList::split("=", *nvp);
+      QStringList::Iterator nvp = nvps.begin();
+      const QStringList::Iterator nvpEnd = nvps.end();
+
+// cannot be a for loop as if something is removed we don't want to do ++nvp, as
+// remove returns an iterator pointing to the next item
+
+      while (nvp != nvpEnd) {
+         const QStringList pair = QStringList::split("=", *nvp);
          if (pair.count() >= 2) {
             if (pair.first().lower() == "attach") {
                nvp = nvps.remove(nvp);
                triedToAttach = true;
+            } else {
+               ++nvp;
             }
+         } else {
+            ++nvp;
          }
       }
 
@@ -4424,9 +4566,10 @@
 
 void KHTMLPart::slotParentCompleted()
 {
+  //kdDebug(6050) << this << " slotParentCompleted()" << endl;
   if ( !d->m_redirectURL.isEmpty() && !d->m_redirectionTimer.isActive() )
   {
-    // kdDebug(6050) << this << ": Child redirection -> " << d->m_redirectURL << endl;
+    //kdDebug(6050) << this << ": starting timer for child redirection -> " << d->m_redirectURL << endl;
     d->m_redirectionTimer.start( 1000 * d->m_delayRedirect, true );
   }
 }
@@ -4558,17 +4701,19 @@
 khtml::ChildFrame *KHTMLPart::frame( const QObject *obj )
 {
     assert( obj->inherits( "KParts::ReadOnlyPart" ) );
-    const KParts::ReadOnlyPart *part = static_cast<const KParts::ReadOnlyPart *>( obj );
+    const KParts::ReadOnlyPart* const part = static_cast<const KParts::ReadOnlyPart *>( obj );
 
     FrameIt it = d->m_frames.begin();
-    FrameIt end = d->m_frames.end();
+    const FrameIt end = d->m_frames.end();
     for (; it != end; ++it )
-      if ( (KParts::ReadOnlyPart *)(*it).m_part == part )
-        return &(*it);
+      if ( (KParts::ReadOnlyPart *)(*it)->m_part == part )
+        return *it;
 
-    for (it = d->m_objects.begin(); it != d->m_objects.end(); ++it )
-      if ( (KParts::ReadOnlyPart *)(*it).m_part == part )
-        return &(*it);
+    FrameIt oi = d->m_objects.begin();
+    const FrameIt oiEnd = d->m_objects.end();
+    for (; oi != oiEnd; ++oi )
+      if ( (KParts::ReadOnlyPart *)(*oi)->m_part == part )
+        return *oi;
 
     return 0L;
 }
@@ -4616,30 +4761,30 @@
   kdDebug(6050) << "KHTMLPart::findFrameParent: this = " << this << " URL = " << m_url << " findFrameParent( " << f << " )" << endl;
 #endif
   // Check access
-  KHTMLPart *callingHtmlPart = dynamic_cast<KHTMLPart *>(callingPart);
-  
+  KHTMLPart* const callingHtmlPart = dynamic_cast<KHTMLPart *>(callingPart);
+
   if (!checkFrameAccess(callingHtmlPart))
      return 0;
 
   FrameIt it = d->m_frames.find( f );
-  FrameIt end = d->m_frames.end();
+  const FrameIt end = d->m_frames.end();
   if ( it != end )
   {
 #ifdef DEBUG_FINDFRAME
      kdDebug(6050) << "KHTMLPart::findFrameParent: FOUND!" << endl;
 #endif
      if (childFrame)
-        *childFrame = &(*it);
+        *childFrame = *it;
      return this;
   }
-     
+
   it = d->m_frames.begin();
   for (; it != end; ++it )
   {
-    KParts::ReadOnlyPart *p = (*it).m_part;
+    KParts::ReadOnlyPart* const p = (*it)->m_part;
     if ( p && p->inherits( "KHTMLPart" ))
     {
-      KHTMLPart *frameParent = static_cast<KHTMLPart*>(p)->findFrameParent(callingPart, f, childFrame);
+      KHTMLPart* const frameParent = static_cast<KHTMLPart*>(p)->findFrameParent(callingPart, f, childFrame);
       if (frameParent)
          return frameParent;
     }
@@ -4661,6 +4806,12 @@
   return 0;
 }
 
+KParts::ReadOnlyPart *KHTMLPart::findFramePart(const QString &f)
+{
+  khtml::ChildFrame *childFrame;
+  return findFrameParent(this, f, &childFrame) ? static_cast<KParts::ReadOnlyPart *>(childFrame->m_part) : 0L;
+}
+
 KParts::ReadOnlyPart *KHTMLPart::currentFrame() const
 {
   KParts::ReadOnlyPart* part = (KParts::ReadOnlyPart*)(this);
@@ -4685,7 +4836,25 @@
   // WABA: We only return true if the child actually has a frame
   // set. Otherwise we might find our preloaded-selve.
   // This happens when we restore the frameset.
-  return (!(*it).m_frame.isNull());
+  return (!(*it)->m_frame.isNull());
+}
+
+KJSProxy *KHTMLPart::framejScript(KParts::ReadOnlyPart *framePart)
+{
+  KHTMLPart* const kp = ::qt_cast<KHTMLPart*>(framePart);
+  if (kp)
+    return kp->jScript();
+
+  FrameIt it = d->m_frames.begin();
+  const FrameIt itEnd = d->m_frames.end();
+
+  for (; it != itEnd; ++it)
+    if (framePart == (*it)->m_part) {
+      if (!(*it)->m_jscript)
+        createJScript(*it);
+      return (*it)->m_jscript;
+    }
+  return 0L;
 }
 
 KHTMLPart *KHTMLPart::parentPart()
@@ -4696,19 +4865,19 @@
   return (KHTMLPart *)parent();
 }
 
-khtml::ChildFrame *KHTMLPart::recursiveFrameRequest( KHTMLPart *callingHtmlPart, const KURL &url, 
+khtml::ChildFrame *KHTMLPart::recursiveFrameRequest( KHTMLPart *callingHtmlPart, const KURL &url,
                                                      const KParts::URLArgs &args, bool callParent )
 {
 #ifdef DEBUG_FINDFRAME
   kdDebug( 6050 ) << "KHTMLPart::recursiveFrameRequest this = " << this << ", frame = " << args.frameName << ", url = " << url << endl;
-#endif  
+#endif
   khtml::ChildFrame *childFrame;
   KHTMLPart *childPart = findFrameParent(callingHtmlPart, args.frameName, &childFrame);
   if (childPart)
   {
      if (childPart == this)
         return childFrame;
-     
+
      childPart->requestObject( childFrame, url, args );
      return 0;
   }
@@ -4724,9 +4893,17 @@
   return 0L;
 }
 
+#ifndef NDEBUG
+static int s_saveStateIndentLevel = 0;
+#endif
+
 void KHTMLPart::saveState( QDataStream &stream )
 {
-  kdDebug( 6050 ) << "KHTMLPart::saveState this = " << this << " saving URL " << m_url.url() << endl;
+#ifndef NDEBUG
+  QString indent = QString().leftJustify( s_saveStateIndentLevel * 4, ' ' );
+  const int indentLevel = s_saveStateIndentLevel++;
+  kdDebug( 6050 ) << indent << "saveState this=" << this << " '" << name() << "' saving URL " << m_url.url() << endl;
+#endif
 
   stream << m_url << (Q_INT32)d->m_view->contentsX() << (Q_INT32)d->m_view->contentsY()
          << (Q_INT32) d->m_view->contentsWidth() << (Q_INT32) d->m_view->contentsHeight() << (Q_INT32) d->m_view->marginWidth() << (Q_INT32) d->m_view->marginHeight();
@@ -4778,22 +4955,22 @@
   QValueList<QByteArray> frameStateBufferLst;
 
   ConstFrameIt it = d->m_frames.begin();
-  ConstFrameIt end = d->m_frames.end();
+  const ConstFrameIt end = d->m_frames.end();
   for (; it != end; ++it )
   {
-    if ( !(*it).m_part )
+    if ( !(*it)->m_part )
        continue;
 
-    frameNameLst << (*it).m_name;
-    frameServiceTypeLst << (*it).m_serviceType;
-    frameServiceNameLst << (*it).m_serviceName;
-    frameURLLst << (*it).m_part->url();
+    frameNameLst << (*it)->m_name;
+    frameServiceTypeLst << (*it)->m_serviceType;
+    frameServiceNameLst << (*it)->m_serviceName;
+    frameURLLst << (*it)->m_part->url();
 
     QByteArray state;
     QDataStream frameStream( state, IO_WriteOnly );
 
-    if ( (*it).m_extension )
-      (*it).m_extension->saveState( frameStream );
+    if ( (*it)->m_extension )
+      (*it)->m_extension->saveState( frameStream );
 
     frameStateBufferLst << state;
   }
@@ -4801,6 +4978,9 @@
   // Save frame data
   stream << (Q_UINT32) frameNameLst.count();
   stream << frameNameLst << frameServiceTypeLst << frameServiceNameLst << frameURLLst << frameStateBufferLst;
+#ifndef NDEBUG
+  s_saveStateIndentLevel = indentLevel;
+#endif
 }
 
 void KHTMLPart::restoreState( QDataStream &stream )
@@ -4862,7 +5042,7 @@
   d->m_bComplete = false;
   d->m_bLoadEventEmitted = false;
 
-//   kdDebug( 6050 ) << "restoreStakte() docState.count() = " << docState.count() << endl;
+//   kdDebug( 6050 ) << "restoreState() docState.count() = " << docState.count() << endl;
 //   kdDebug( 6050 ) << "m_url " << m_url.url() << " <-> " << u.url() << endl;
 //   kdDebug( 6050 ) << "m_frames.count() " << d->m_frames.count() << " <-> " << frameCount << endl;
 
@@ -4872,10 +5052,10 @@
     d->m_redirectionTimer.stop();
 
     FrameIt fIt = d->m_frames.begin();
-    FrameIt fEnd = d->m_frames.end();
+    const FrameIt fEnd = d->m_frames.end();
 
     for (; fIt != fEnd; ++fIt )
-        (*fIt).m_bCompleted = false;
+        (*fIt)->m_bCompleted = false;
 
     fIt = d->m_frames.begin();
 
@@ -4887,7 +5067,7 @@
 
     for (; fIt != fEnd; ++fIt, ++fNameIt, ++fServiceTypeIt, ++fServiceNameIt, ++fURLIt, ++fBufferIt )
     {
-      khtml::ChildFrame *child = &(*fIt);
+      khtml::ChildFrame* const child = *fIt;
 
 //      kdDebug( 6050 ) <<  *fNameIt  << " ---- " <<  *fServiceTypeIt << endl;
 
@@ -4898,7 +5078,6 @@
         child->m_serviceName = *fServiceNameIt;
         processObjectRequest( child, *fURLIt, *fServiceTypeIt );
       }
-
       if ( child->m_part )
       {
         child->m_bCompleted = false;
@@ -4935,7 +5114,7 @@
     d->m_sheetUsed = sheetUsed;
 
     QStringList::ConstIterator fNameIt = frameNames.begin();
-    QStringList::ConstIterator fNameEnd = frameNames.end();
+    const QStringList::ConstIterator fNameEnd = frameNames.end();
 
     QStringList::ConstIterator fServiceTypeIt = frameServiceTypes.begin();
     QStringList::ConstIterator fServiceNameIt = frameServiceNames.begin();
@@ -4944,29 +5123,29 @@
 
     for (; fNameIt != fNameEnd; ++fNameIt, ++fServiceTypeIt, ++fServiceNameIt, ++fURLIt, ++fBufferIt )
     {
-      khtml::ChildFrame newChild;
-      newChild.m_bPreloaded = true;
-      newChild.m_name = *fNameIt;
-      newChild.m_serviceName = *fServiceNameIt;
+      khtml::ChildFrame* const newChild = new khtml::ChildFrame;
+      newChild->m_bPreloaded = true;
+      newChild->m_name = *fNameIt;
+      newChild->m_serviceName = *fServiceNameIt;
 
 //      kdDebug( 6050 ) << *fNameIt << " ---- " << *fServiceTypeIt << endl;
 
-      FrameIt childFrame = d->m_frames.append( newChild );
+      const FrameIt childFrame = d->m_frames.append( newChild );
 
-      processObjectRequest( &(*childFrame), *fURLIt, *fServiceTypeIt );
+      processObjectRequest( *childFrame, *fURLIt, *fServiceTypeIt );
 
-      (*childFrame).m_bPreloaded = true;
+      (*childFrame)->m_bPreloaded = true;
 
-      if ( (*childFrame).m_part )
+      if ( (*childFrame)->m_part )
       {
-        if ( (*childFrame).m_extension )
-        if ( (*childFrame).m_extension && !(*fBufferIt).isEmpty() )
+        if ( (*childFrame)->m_extension )
+        if ( (*childFrame)->m_extension && !(*fBufferIt).isEmpty() )
         {
           QDataStream frameStream( *fBufferIt, IO_ReadOnly );
-          (*childFrame).m_extension->restoreState( frameStream );
+          (*childFrame)->m_extension->restoreState( frameStream );
         }
         else
-          (*childFrame).m_part->openURL( *fURLIt );
+          (*childFrame)->m_part->openURL( *fURLIt );
       }
     }
 
@@ -4975,8 +5154,7 @@
     args.yOffset = yOffset;
     args.docState = docState;
 
-    d->m_view->resizeContents( wContents,  hContents);
-    d->m_view->setContentsPos( xOffset, yOffset );
+    connect(d->m_view, SIGNAL(finishedLayout()), this, SLOT(restoreScrollPosition()));
 
     d->m_extension->setURLArgs( args );
     if (!KHTMLPageCache::self()->isComplete(d->m_cacheId))
@@ -5105,10 +5283,10 @@
   }
 
   ConstFrameIt it = d->m_frames.begin();
-  ConstFrameIt end = d->m_frames.end();
+  const ConstFrameIt end = d->m_frames.end();
   for (; it != end; ++it )
-    if ( !( *it ).m_part.isNull() && ( *it ).m_part->inherits( "KHTMLPart" ) ) {
-      KParts::ReadOnlyPart* p = ( *it ).m_part;
+    if ( !( *it )->m_part.isNull() && (*it)->m_part->inherits( "KHTMLPart" ) ) {
+      KParts::ReadOnlyPart* const p = ( *it )->m_part;
       static_cast<KHTMLPart*>( p )->setZoomFactor(d->m_zoomFactor);
     }
 
@@ -5215,10 +5393,10 @@
     d->m_doc->docLoader()->setAutoloadImages( !d->m_doc->docLoader()->autoloadImages() );
 
   ConstFrameIt it = d->m_frames.begin();
-  ConstFrameIt end = d->m_frames.end();
+  const ConstFrameIt end = d->m_frames.end();
   for (; it != end; ++it )
-    if ( !( *it ).m_part.isNull() && ( *it ).m_part->inherits( "KHTMLPart" ) ) {
-      KParts::ReadOnlyPart* p = ( *it ).m_part;
+    if ( !( *it )->m_part.isNull() && (*it)->m_part->inherits( "KHTMLPart" ) ) {
+      KParts::ReadOnlyPart* const p = ( *it )->m_part;
       static_cast<KHTMLPart*>( p )->slotLoadImages();
     }
 }
@@ -5254,10 +5432,10 @@
   QStringList res;
 
   ConstFrameIt it = d->m_frames.begin();
-  ConstFrameIt end = d->m_frames.end();
+  const ConstFrameIt end = d->m_frames.end();
   for (; it != end; ++it )
-    if (!(*it).m_bPreloaded)
-      res += (*it).m_name;
+    if (!(*it)->m_bPreloaded)
+      res += (*it)->m_name;
 
   return res;
 }
@@ -5267,10 +5445,10 @@
   QPtrList<KParts::ReadOnlyPart> res;
 
   ConstFrameIt it = d->m_frames.begin();
-  ConstFrameIt end = d->m_frames.end();
+  const ConstFrameIt end = d->m_frames.end();
   for (; it != end; ++it )
-    if (!(*it).m_bPreloaded)
-      res.append( (*it).m_part );
+    if (!(*it)->m_bPreloaded)
+      res.append( (*it)->m_part );
 
   return res;
 }
@@ -5287,7 +5465,7 @@
   if ( !urlArgs.lockHistory() )
       emit d->m_extension->openURLNotify();
 
-  requestObject( &(*it), url, urlArgs );
+  requestObject( *it, url, urlArgs );
 
   return true;
 }
@@ -5346,9 +5524,10 @@
 {
     for (khtml::RenderObject *n = renderNode; n; n = n->nextSibling()) {
         if (n->isText()) {
-            khtml::RenderText *textRenderer = static_cast<khtml::RenderText *>(n);
+            khtml::RenderText* const textRenderer = static_cast<khtml::RenderText *>(n);
             const khtml::InlineTextBoxArray &runs = textRenderer->inlineTextBoxes();
-            for (unsigned i = 0; i != runs.count(); i++) {
+	    const unsigned lim = runs.count();
+            for (unsigned i = 0; i != lim; ++i) {
                 if (runs[i]->m_y == y) {
                     startNode = textRenderer->element();
                     startOffset = runs[i]->m_start;
@@ -5387,9 +5566,9 @@
         }
 
         if (n->isText()) {
-            khtml::RenderText *textRenderer =  static_cast<khtml::RenderText *>(n);
+            khtml::RenderText* const textRenderer =  static_cast<khtml::RenderText *>(n);
             const khtml::InlineTextBoxArray &runs = textRenderer->inlineTextBoxes();
-            for (int i = (int)runs.count()-1; i >= 0; i--) {
+            for (int i = (int)runs.count()-1; i >= 0; --i) {
                 if (runs[i]->m_y == y) {
                     endNode = textRenderer->element();
                     endOffset = runs[i]->m_start + runs[i]->m_len;
@@ -5637,12 +5816,12 @@
     if ( right )
     {
       Q_ASSERT( offset < len-1 );
-      offset++;
+      ++offset;
     }
     else
     {
       Q_ASSERT( offset > 0 );
-      offset--;
+      --offset;
     }
 
     // Test that char
@@ -5651,7 +5830,7 @@
   } while ( !ch.isSpace() && !ch.isPunct() );
 
   // make offset point after last char
-  if (right) selectionOffset++;
+  if (right) ++selectionOffset;
 }
 
 #ifndef KHTML_NO_SELECTION
@@ -5780,6 +5959,8 @@
       pix = KMimeType::pixmapForURL(u, 0, KIcon::Desktop, KIcon::SizeMedium);
     }
 
+    u.setPass(QString::null);
+
     KURLDrag* urlDrag = new KURLDrag( u, img ? 0 : d->m_view->viewport() );
     if ( !d->m_referrer.isEmpty() )
       urlDrag->metaData()["referrer"] = d->m_referrer;
@@ -5798,7 +5979,7 @@
 
     stopAutoScroll();
     if(drag)
-        drag->drag();
+      drag->drag();
 
     // when we finish our drag, we need to undo our mouse press
     d->m_bMousePressed = false;
@@ -6422,10 +6603,6 @@
 void KHTMLPart::restoreScrollPosition()
 {
   KParts::URLArgs args = d->m_extension->urlArgs();
-  if (!args.reload) {
-    disconnect(d->m_view, SIGNAL(finishedLayout()), this, SLOT(restoreScrollPosition()));
-    return;	// should not happen
-  }
 
   // Check whether the viewport has become large enough to encompass the stored
   // offsets. If the document has been fully loaded, force the new coordinates,
@@ -6438,14 +6615,138 @@
   }
 }
 
-KWallet::Wallet* KHTMLPart::wallet()
+
+void KHTMLPart::openWallet(DOM::HTMLFormElementImpl *form)
 {
-  // ### close wallet after a certain timeout period automatically
-  //      No - KWallet already does this based on user preferences. (GS)
-  // ### close wallet after screensaver was enabled
-  //      No - KWalletD should do this, if anything. (GS)
+  KHTMLPart *p;
 
-  KHTMLPart* p;
+  for (p = parentPart(); p && p->parentPart(); p = p->parentPart()) {
+  }
+
+  if (p) {
+    p->openWallet(form);
+    return;
+  }
+
+  if (onlyLocalReferences()) { // avoid triggering on local apps, thumbnails
+    return;
+  }
+
+  if (d->m_wallet) {
+    if (d->m_bWalletOpened) {
+      if (d->m_wallet->isOpen()) {
+        form->walletOpened(d->m_wallet);
+        return;
+      }
+      d->m_wallet->deleteLater();
+      d->m_wallet = 0L;
+      d->m_bWalletOpened = false;
+    }
+  }
+
+  if (!d->m_wq) {
+    KWallet::Wallet *wallet = KWallet::Wallet::openWallet(KWallet::Wallet::NetworkWallet(), widget() ? widget()->topLevelWidget()->winId() : 0, KWallet::Wallet::Asynchronous);
+    d->m_wq = new KHTMLWalletQueue(this);
+    d->m_wq->wallet = wallet;
+    connect(wallet, SIGNAL(walletOpened(bool)), d->m_wq, SLOT(walletOpened(bool)));
+    connect(d->m_wq, SIGNAL(walletOpened(KWallet::Wallet*)), this, SLOT(walletOpened(KWallet::Wallet*)));
+  }
+  assert(form);
+  d->m_wq->callers.append(KHTMLWalletQueue::Caller(form, form->getDocument()));
+}
+
+
+void KHTMLPart::saveToWallet(const QString& key, const QMap<QString,QString>& data)
+{
+  KHTMLPart *p;
+
+  for (p = parentPart(); p && p->parentPart(); p = p->parentPart()) {
+  }
+
+  if (p) {
+    p->saveToWallet(key, data);
+    return;
+  }
+
+  if (d->m_wallet) {
+    if (d->m_bWalletOpened) {
+      if (d->m_wallet->isOpen()) {
+        if (!d->m_wallet->hasFolder(KWallet::Wallet::FormDataFolder())) {
+          d->m_wallet->createFolder(KWallet::Wallet::FormDataFolder());
+        }
+        d->m_wallet->setFolder(KWallet::Wallet::FormDataFolder());
+        d->m_wallet->writeMap(key, data);
+        return;
+      }
+      d->m_wallet->deleteLater();
+      d->m_wallet = 0L;
+      d->m_bWalletOpened = false;
+    }
+  }
+
+  if (!d->m_wq) {
+    KWallet::Wallet *wallet = KWallet::Wallet::openWallet(KWallet::Wallet::NetworkWallet(), widget() ? widget()->topLevelWidget()->winId() : 0, KWallet::Wallet::Asynchronous);
+    d->m_wq = new KHTMLWalletQueue(this);
+    d->m_wq->wallet = wallet;
+    connect(wallet, SIGNAL(walletOpened(bool)), d->m_wq, SLOT(walletOpened(bool)));
+    connect(d->m_wq, SIGNAL(walletOpened(KWallet::Wallet*)), this, SLOT(walletOpened(KWallet::Wallet*)));
+  }
+  d->m_wq->savers.append(qMakePair(key, data));
+}
+
+
+void KHTMLPart::dequeueWallet(DOM::HTMLFormElementImpl *form) {
+  KHTMLPart *p;
+
+  for (p = parentPart(); p && p->parentPart(); p = p->parentPart()) {
+  }
+
+  if (p) {
+    p->dequeueWallet(form);
+    return;
+  }
+
+  if (d->m_wq) {
+    d->m_wq->callers.remove(KHTMLWalletQueue::Caller(form, form->getDocument()));
+  }
+}
+
+
+void KHTMLPart::walletOpened(KWallet::Wallet *wallet) {
+  assert(!d->m_wallet);
+  assert(d->m_wq);
+
+  d->m_wq->deleteLater(); // safe?
+  d->m_wq = 0L;
+
+  if (!wallet) {
+    d->m_bWalletOpened = false;
+    return;
+  }
+
+  d->m_wallet = wallet;
+  d->m_bWalletOpened = true;
+  connect(d->m_wallet, SIGNAL(walletClosed()), SLOT(slotWalletClosed()));
+
+  if (!d->m_statusBarWalletLabel) {
+    d->m_statusBarWalletLabel = new KURLLabel(d->m_statusBarExtension->statusBar());
+    d->m_statusBarWalletLabel->setFixedHeight(instance()->iconLoader()->currentSize(KIcon::Small));
+    d->m_statusBarWalletLabel->setSizePolicy(QSizePolicy(QSizePolicy::Fixed, QSizePolicy::Fixed));
+    d->m_statusBarWalletLabel->setUseCursor(false);
+    d->m_statusBarExtension->addStatusBarItem(d->m_statusBarWalletLabel, 0, false);
+    d->m_statusBarWalletLabel->setPixmap(SmallIcon("wallet_open", instance()));
+    connect(d->m_statusBarWalletLabel, SIGNAL(leftClickedURL()), SLOT(launchWalletManager()));
+    connect(d->m_statusBarWalletLabel, SIGNAL(rightClickedURL()), SLOT(walletMenu()));
+  } else {
+    QToolTip::remove(d->m_statusBarWalletLabel);
+  }
+  QToolTip::add(d->m_statusBarWalletLabel, i18n("The wallet '%1' is open and being used for form data and passwords.").arg(KWallet::Wallet::NetworkWallet()));
+}
+
+
+KWallet::Wallet *KHTMLPart::wallet()
+{
+  KHTMLPart *p;
 
   for (p = parentPart(); p && p->parentPart(); p = p->parentPart())
     ;
@@ -6453,29 +6754,10 @@
   if (p)
     return p->wallet();
 
-  if (!d->m_wallet && !d->m_bWalletOpened) {
-    d->m_wallet = KWallet::Wallet::openWallet(KWallet::Wallet::NetworkWallet(), widget() ? widget()->topLevelWidget()->winId() : 0);
-    d->m_bWalletOpened = true;
-    if (d->m_wallet) {
-      connect(d->m_wallet, SIGNAL(walletClosed()), SLOT(slotWalletClosed()));
-      d->m_statusBarWalletLabel = new KURLLabel(d->m_statusBarExtension->statusBar());
-      d->m_statusBarWalletLabel->setFixedHeight(instance()->iconLoader()->currentSize(KIcon::Small));
-      d->m_statusBarWalletLabel->setSizePolicy(QSizePolicy(QSizePolicy::Fixed, QSizePolicy::Fixed));
-      d->m_statusBarWalletLabel->setUseCursor(false);
-      d->m_statusBarExtension->addStatusBarItem(d->m_statusBarWalletLabel, 0, false);
-      QToolTip::add(d->m_statusBarWalletLabel, i18n("The wallet '%1' is open and being used for form data and passwords.").arg(KWallet::Wallet::NetworkWallet()));
-      d->m_statusBarWalletLabel->setPixmap(SmallIcon("wallet_open", instance()));
-      connect(d->m_statusBarWalletLabel, SIGNAL(leftClickedURL()), SLOT(launchWalletManager()));
-      connect(d->m_statusBarWalletLabel, SIGNAL(rightClickedURL()), SLOT(walletMenu()));
-    } else if (d->m_statusBarWalletLabel) {
-      d->m_statusBarExtension->removeStatusBarItem(d->m_statusBarWalletLabel);
-      delete d->m_statusBarWalletLabel;
-      d->m_statusBarWalletLabel = 0L;
-    }
-  }
   return d->m_wallet;
 }
 
+
 void KHTMLPart::slotWalletClosed()
 {
   if (d->m_wallet) {
@@ -6548,7 +6830,7 @@
     if (!d->m_paDebugScript) {
       d->m_paDebugScript = new KAction( i18n( "JavaScript &Debugger" ), 0, this, SLOT( slotDebugScript() ), actionCollection(), "debugScript" );
     }
-    d->m_paDebugScript->setEnabled( d->m_jscript );
+    d->m_paDebugScript->setEnabled( d->m_frame ? d->m_frame->m_jscript : 0L );
     QPtrList<KAction> lst;
     lst.append( d->m_paDebugScript );
     plugActionList( "debugScriptList", lst );
@@ -6558,3 +6840,4 @@
 
 using namespace KParts;
 #include "khtml_part.moc"
+#include "khtmlpart_p.moc"
diff -urN -x CVS kdelibs.orig/khtml/khtml_part.h kdelibs/khtml/khtml_part.h
--- kdelibs.orig/khtml/khtml_part.h	Thu Oct  7 14:34:20 2004
+++ kdelibs/khtml/khtml_part.h	Wed Nov 10 10:00:14 2004
@@ -179,7 +179,6 @@
  *
  * @short HTML Browser Widget
  * @author Lars Knoll (knoll@kde.org)
- * @version $Id$
  *
  */
 class KHTMLPart : public KParts::ReadOnlyPart
@@ -225,7 +224,7 @@
   Q_PROPERTY( bool onlyLocalReferences READ onlyLocalReferences WRITE setOnlyLocalReferences )
   Q_PROPERTY( QCString dcopObjectId READ dcopObjectId )
   Q_PROPERTY( bool modified READ isModified )
-  
+
 public:
   enum GUIProfile { DefaultGUI, BrowserViewGUI /* ... */ };
 
@@ -867,7 +866,7 @@
   KHTMLPart *findFrame( const QString &f );
 
   /**
-   * Recursively finds the part containing the frame with name @p f 
+   * Recursively finds the part containing the frame with name @p f
    * and checks if it is accessible by @p callingPart
    * Returns 0L if no suitable frame can't be found.
    * Returns parent part if a suitable frame was found and
@@ -891,8 +890,16 @@
    */
   bool frameExists( const QString &frameName );
 
+  /**
+   * Returns child frame framePart its script interpreter
+   */
+  KJSProxy *framejScript(KParts::ReadOnlyPart *framePart);
 
   /**
+   * Finds a frame by name. Returns 0L if frame can't be found.
+   */
+  KParts::ReadOnlyPart *findFramePart( const QString &f );
+  /**
    * Called by KJS.
    * Sets the StatusBarText assigned
    * via window.status
@@ -980,7 +987,7 @@
   /**
    * Checks whether the page contains unsubmitted form changes.
    *
-   * @return true if form changes exist 
+   * @return true if form changes exist
    * @since 3.3
    */
   bool isModified() const;
@@ -1451,6 +1458,8 @@
    */
   void restoreScrollPosition();
 
+  void walletOpened(KWallet::Wallet*);
+
 private:
 
   KJSErrorDlg *jsErrorExtension();
@@ -1471,6 +1480,10 @@
 
   KWallet::Wallet* wallet();
 
+  void openWallet(DOM::HTMLFormElementImpl*);
+  void saveToWallet(const QString& key, const QMap<QString,QString>& data);
+  void dequeueWallet(DOM::HTMLFormElementImpl*);
+
   /**
    * @internal
    */
diff -urN -x CVS kdelibs.orig/khtml/khtml_printsettings.cpp kdelibs/khtml/khtml_printsettings.cpp
--- kdelibs.orig/khtml/khtml_printsettings.cpp	Wed Jun 16 11:09:45 2004
+++ kdelibs/khtml/khtml_printsettings.cpp	Mon Nov 15 10:58:36 2004
@@ -22,17 +22,62 @@
 #include <klocale.h>
 #include <qcheckbox.h>
 #include <qlayout.h>
+#include <qwhatsthis.h>
 
 KHTMLPrintSettings::KHTMLPrintSettings(QWidget *parent, const char *name)
 : KPrintDialogPage(parent, name)
 {
+	//WhatsThis strings.... (added by pfeifle@kde.org)
+	QString whatsThisPrintImages = i18n( "<qt>"
+		"<p><strong>'Print images'</strong></p>"
+		"<p>"
+		"If this checkbox is enabled, images contained in the HTML page will "
+		"be printed. Printing may take longer and use more ink or toner."
+		"</p>"
+		"<p>"
+		"If this checkbox is disabled, only the text of the HTML page will be "
+		"printed, without the included images. Printing will be faster and use "
+		"less ink or toner."
+		"</p>"
+						" </qt>" );
+	QString whatsThisPrintHeader = i18n( "<qt>"
+		"<p><strong>'Print header'</strong></p>"
+		"<p>"
+		"If this checkbox is enabled, the printout of the HTML document will "
+		"contain a header line at the top of each page. This header contains "
+		"the current date, the location URL of the printed page and the page "
+		"number."
+		"</p>"
+		"<p>"
+		"If this checkbox is disabled, the printout of the HTML document will "
+		"not contain such a header line."
+		"</p>"
+						" </qt>" );
+	QString whatsThisPrinterFriendlyMode = i18n( "<qt>"
+		"<p><strong>'Printerfriendly mode'</strong></p>"
+		"<p>"
+		"If this checkbox is enabled, the printout of the HTML document will "
+		"be black and white only, and all colored background will be converted "
+		"into white. Printout will be faster and use less ink or toner."
+		"</p>"
+		"<p>"
+		"If this checkbox is disabled, the printout of the HTML document will "
+		"happen in the original color settings as you see in your application. "
+		"This may result in areas of full-page color (or grayscale, if you use "
+		"a black+white printer). Printout will possibly happen slower and will "
+		"certainly use much more toner or ink."
+		"</p>"
+						" </qt>" );
 	setTitle(i18n("HTML Settings"));
 
 	m_printfriendly = new QCheckBox(i18n("Printer friendly mode (black text, no background)"), this);
+	QWhatsThis::add(m_printfriendly, whatsThisPrinterFriendlyMode);
 	m_printfriendly->setChecked(true);
 	m_printimages = new QCheckBox(i18n("Print images"), this);
+	QWhatsThis::add(m_printimages, whatsThisPrintImages);
 	m_printimages->setChecked(true);
 	m_printheader = new QCheckBox(i18n("Print header"), this);
+	QWhatsThis::add(m_printheader, whatsThisPrintHeader);
 	m_printheader->setChecked(true);
 
 	QVBoxLayout	*l0 = new QVBoxLayout(this, 0, 10);
diff -urN -x CVS kdelibs.orig/khtml/khtml_settings.cc kdelibs/khtml/khtml_settings.cc
--- kdelibs.orig/khtml/khtml_settings.cc	Sat Sep 11 02:32:34 2004
+++ kdelibs/khtml/khtml_settings.cc	Wed Nov 10 10:00:14 2004
@@ -106,7 +106,7 @@
   if (domain.isEmpty()) {
     kdWarning() << "setup_per_domain_policy: domain is empty" << endl;
   }
-  QString ldomain = domain.lower();
+  const QString ldomain = domain.lower();
   PolicyMap::iterator it = d->domainPolicy.find(ldomain);
   if (it == d->domainPolicy.end()) {
     // simply copy global domain settings (they should have been initialized
@@ -410,15 +410,16 @@
     bool check_old_java_settings = true;
     // merge all domains into one list
     QMap<QString,int> domainList;	// why can't Qt have a QSet?
-    for (unsigned i = 0; i < sizeof domain_keys/sizeof domain_keys[0]; i++) {
+    for (unsigned i = 0; i < sizeof domain_keys/sizeof domain_keys[0]; ++i) {
       if ( reset || config->hasKey(domain_keys[i]) ) {
         if (i == 0) check_old_ecma_settings = false;
 	else if (i == 1) check_old_java_settings = false;
-        QStringList dl = config->readListEntry( domain_keys[i] );
-	QMap<QString,int>::Iterator notfound = domainList.end();
-	QStringList::ConstIterator it;
-	for (it = dl.begin(); it != dl.end(); ++it) {
-	  QString domain = (*it).lower();
+        const QStringList dl = config->readListEntry( domain_keys[i] );
+	const QMap<QString,int>::Iterator notfound = domainList.end();
+	QStringList::ConstIterator it = dl.begin();
+	const QStringList::ConstIterator itEnd = dl.end();
+	for (; it != itEnd; ++it) {
+	  const QString domain = (*it).lower();
 	  QMap<QString,int>::Iterator pos = domainList.find(domain);
 	  if (pos == notfound) domainList.insert(domain,0);
 	}/*next it*/
@@ -429,15 +430,18 @@
       d->domainPolicy.clear();
 
     QString js_group_save = config->group();
-    for ( QMap<QString,int>::ConstIterator it = domainList.begin();
-                it != domainList.end(); ++it)
     {
-      QString domain = it.key();
-      config->setGroup(domain);
-      readDomainSettings(config,reset,false,d->domainPolicy[domain]);
+      QMap<QString,int>::ConstIterator it = domainList.begin();
+      const QMap<QString,int>::ConstIterator itEnd = domainList.end();
+      for ( ; it != itEnd; ++it)
+      {
+        const QString domain = it.key();
+        config->setGroup(domain);
+        readDomainSettings(config,reset,false,d->domainPolicy[domain]);
 #ifdef DEBUG_SETTINGS
-      d->domainPolicy[domain].dump("init "+domain);
+        d->domainPolicy[domain].dump("init "+domain);
 #endif
+      }
     }
     config->setGroup(js_group_save);
 
@@ -446,9 +450,10 @@
     	&& check_old_java_settings )
     {
       check_old_java = false;
-      QStringList domainList = config->readListEntry( "JavaDomainSettings" );
-      for ( QStringList::ConstIterator it = domainList.begin();
-                it != domainList.end(); ++it)
+      const QStringList domainList = config->readListEntry( "JavaDomainSettings" );
+      QStringList::ConstIterator it = domainList.begin();
+      const QStringList::ConstIterator itEnd = domainList.end();
+      for ( ; it != itEnd; ++it)
       {
         QString domain;
         KJavaScriptAdvice javaAdvice;
@@ -467,9 +472,10 @@
 	&& check_old_ecma_settings )
     {
       check_old_ecma = false;
-      QStringList domainList = config->readListEntry( "ECMADomainSettings" );
-      for ( QStringList::ConstIterator it = domainList.begin();
-                it != domainList.end(); ++it)
+      const QStringList domainList = config->readListEntry( "ECMADomainSettings" );
+      QStringList::ConstIterator it = domainList.begin();
+      const QStringList::ConstIterator itEnd = domainList.end();
+      for ( ; it != itEnd; ++it)
       {
         QString domain;
         KJavaScriptAdvice javaAdvice;
@@ -487,9 +493,10 @@
              && ( check_old_java || check_old_ecma )
 	     && ( check_old_ecma_settings || check_old_java_settings ) )
     {
-      QStringList domainList = config->readListEntry( "JavaScriptDomainAdvice" );
-      for ( QStringList::ConstIterator it = domainList.begin();
-                it != domainList.end(); ++it)
+      const QStringList domainList = config->readListEntry( "JavaScriptDomainAdvice" );
+      QStringList::ConstIterator it = domainList.begin();
+      const QStringList::ConstIterator itEnd = domainList.end();
+      for ( ; it != itEnd; ++it)
       {
         QString domain;
         KJavaScriptAdvice javaAdvice;
@@ -558,7 +565,7 @@
     return d->global;
   }
 
-  PolicyMap::const_iterator notfound = d->domainPolicy.end();
+  const PolicyMap::const_iterator notfound = d->domainPolicy.end();
 
   // First check whether there is a perfect match.
   PolicyMap::const_iterator it = d->domainPolicy.find(hostname);
@@ -711,7 +718,10 @@
         QRegExp foundryExp(" \\[.+\\]");
 
         //remove foundry info
-        for ( QStringList::Iterator f = families.begin(); f != families.end(); ++f ) {
+        QStringList::Iterator f = families.begin();
+        const QStringList::Iterator fEnd = families.end();
+
+        for ( ; f != fEnd; ++f ) {
                 (*f).replace( foundryExp, "");
                 if (!s.contains(*f))
                         s << *f;
diff -urN -x CVS kdelibs.orig/khtml/khtmlimage.desktop kdelibs/khtml/khtmlimage.desktop
--- kdelibs.orig/khtml/khtmlimage.desktop	Tue Aug 31 09:21:23 2004
+++ kdelibs/khtml/khtmlimage.desktop	Thu Nov 11 08:50:25 2004
@@ -21,6 +21,7 @@
 Comment[fa]=بخش نمایشگر تصویر نهفته
 Comment[fi]=Upotettava kuviennäyttökomponentti
 Comment[fr]=Composant d'affichage d'images intégrable
+Comment[ga]=Comhpháirt inleabaithe amharctha íomhá
 Comment[gl]=Compoñente de visualización de imaxes embebible
 Comment[he]=רכיב בר-הטבעה להצגת תמונות
 Comment[hi]=अंतर्निहित योग्य छवि दर्शक घटक
@@ -33,11 +34,12 @@
 Comment[ko]=끼워넣는 그림 보기 구성 요소
 Comment[lt]=Įdedamas piešinių peržiūros komponentas
 Comment[lv]=Iegultā Attēlu Skatīšanas Komponente
-Comment[mk]=Вградлива компонента за гледање слики
+Comment[mk]=Вгнездлива компонента за гледање слики
 Comment[mn]=Суулгаж болох Зураг Харагч Бүрэл хэсэг
 Comment[ms]=Komponen Pelihat Imej Boleh-serta
 Comment[mt]=Komponent integrat għall wiri tal-istampi
 Comment[nb]=Innebyggbar bildevisningskomponent
+Comment[nds]=Inbettbor Bild-Kieker-Komponent
 Comment[nl]=Ingebed afbeeldingenweergavecomponent
 Comment[nn]=Inkluderbart komponent for biletvising
 Comment[nso]=Seripa seo se Robatsegsgo sa Pono ya Ponagalo
@@ -106,6 +108,7 @@
 Name[ms]=Pelihat Imej Boleh-serta
 Name[mt]=Werrej integrat tal-istampi
 Name[nb]=Bildeviser for innebyggbare bilder
+Name[nds]=Inbettbor Bild-Kieker
 Name[nl]=Ingebedde afbeeldingenweergave
 Name[nn]=Innebygd biletvisar
 Name[nso]=Molebeledi yo a Robatsegago wa Ponagalo
diff -urN -x CVS kdelibs.orig/khtml/khtmlpart_p.h kdelibs/khtml/khtmlpart_p.h
--- kdelibs.orig/khtml/khtmlpart_p.h	Sun Jun 13 13:50:18 2004
+++ kdelibs/khtml/khtmlpart_p.h	Wed Nov 10 10:00:14 2004
@@ -32,9 +32,15 @@
 #include <kaction.h>
 #include <kparts/partmanager.h>
 #include <kparts/statusbarextension.h>
+#include <kparts/browserextension.h>
 #include <kwallet.h>
+
+#include <qguardedptr.h>
+#include <qmap.h>
 #include <qtimer.h>
+#include <qvaluelist.h>
 
+#include "html/html_formimpl.h"
 #include "khtml_run.h"
 #include "khtml_factory.h"
 #include "khtml_events.h"
@@ -64,16 +70,25 @@
 
 namespace khtml
 {
-  struct ChildFrame
+  class ChildFrame : public QObject
   {
+      Q_OBJECT
+  public:
       enum Type { Frame, IFrame, Object };
 
-      ChildFrame() {
+      ChildFrame() : QObject (0L, "khtml_child_frame") {
+          m_jscript = 0L;
+          m_kjs_lib = 0;
           m_bCompleted = false; m_bPreloaded = false; m_type = Frame; m_bNotify = false;
           m_bPendingRedirection = false;
       }
 
-      ~ChildFrame() { if (m_run) m_run->abort(); }
+      ~ChildFrame() {
+          if (m_run) m_run->abort();
+          delete m_jscript;
+          if ( m_kjs_lib)
+              m_kjs_lib->unload();
+      }
 
     QGuardedPtr<khtml::RenderPart> m_frame;
     QGuardedPtr<KParts::ReadOnlyPart> m_part;
@@ -81,6 +96,8 @@
     QGuardedPtr<KParts::LiveConnectExtension> m_liveconnect;
     QString m_serviceName;
     QString m_serviceType;
+    KJSProxy *m_jscript;
+    KLibrary *m_kjs_lib;
     bool m_bCompleted;
     QString m_name;
     KParts::URLArgs m_args;
@@ -91,11 +108,13 @@
     QStringList m_params;
     bool m_bNotify;
     bool m_bPendingRedirection;
+  protected slots:
+    void liveConnectEvent(const unsigned long, const QString&, const KParts::LiveConnectExtension::ArgList&);
   };
 
 }
 
-struct KHTMLFrameList : public QValueList<khtml::ChildFrame>
+struct KHTMLFrameList : public QValueList<khtml::ChildFrame*>
 {
     Iterator find( const QString &name ) KDE_NO_EXPORT;
 };
@@ -105,18 +124,67 @@
 
 static int khtml_part_dcop_counter = 0;
 
+
+class KHTMLWalletQueue : public QObject
+{
+  Q_OBJECT
+  public:
+    KHTMLWalletQueue(QObject *parent) : QObject(parent) {
+      wallet = 0L;
+    }
+
+    virtual ~KHTMLWalletQueue() {
+      delete wallet;
+      wallet = 0L;
+    }
+
+    KWallet::Wallet *wallet;
+    typedef QPair<DOM::HTMLFormElementImpl*, QGuardedPtr<DOM::DocumentImpl> > Caller;
+    typedef QValueList<Caller> CallerList;
+    CallerList callers;
+    QValueList<QPair<QString, QMap<QString, QString> > > savers;
+
+  signals:
+    void walletOpened(KWallet::Wallet*);
+
+  public slots:
+    void walletOpened(bool success) {
+      if (!success) {
+        delete wallet;
+        wallet = 0L;
+      }
+      emit walletOpened(wallet);
+      if (wallet) {
+        if (!wallet->hasFolder(KWallet::Wallet::FormDataFolder())) {
+          wallet->createFolder(KWallet::Wallet::FormDataFolder());
+        }
+        for (CallerList::Iterator i = callers.begin(); i != callers.end(); ++i) {
+          if ((*i).first && (*i).second) {
+            (*i).first->walletOpened(wallet);
+          }
+        }
+        wallet->setFolder(KWallet::Wallet::FormDataFolder());
+        for (QValueList<QPair<QString, QMap<QString, QString> > >::Iterator i = savers.begin(); i != savers.end(); ++i) {
+          wallet->writeMap((*i).first, (*i).second);
+        }
+      }
+      callers.clear();
+      savers.clear();
+      wallet = 0L; // gave it away
+    }
+};
+
 class KHTMLPartPrivate
 {
+  KHTMLPartPrivate(const KHTMLPartPrivate & other);
 public:
   KHTMLPartPrivate(QObject* parent)
   {
     m_doc = 0L;
     m_decoder = 0L;
-    m_jscript = 0L;
     m_wallet = 0L;
     m_bWalletOpened = false;
     m_runningScripts = 0;
-    m_kjs_lib = 0;
     m_job = 0L;
     m_bComplete = true;
     m_bLoadEventEmitted = true;
@@ -205,8 +273,10 @@
     m_jobspeed = 0;
     m_dcop_counter = ++khtml_part_dcop_counter;
     m_statusBarWalletLabel = 0L;
+    m_statusBarUALabel = 0L;
     m_statusBarJSErrorLabel = 0L;
     m_userStyleSheetLastModified = 0;
+    m_wq = 0;
   }
   ~KHTMLPartPrivate()
   {
@@ -214,17 +284,15 @@
     delete m_statusBarExtension;
     delete m_extension;
     delete m_settings;
-    delete m_jscript;
     delete m_wallet;
-    if ( m_kjs_lib)
-       m_kjs_lib->unload();
 #ifndef Q_WS_QWS
     //delete m_javaContext;
 #endif
   }
 
+  QGuardedPtr<khtml::ChildFrame> m_frame;
   KHTMLFrameList m_frames;
-  QValueList<khtml::ChildFrame> m_objects;
+  KHTMLFrameList m_objects;
 
   QGuardedPtr<KHTMLView> m_view;
   KHTMLPartBrowserExtension *m_extension;
@@ -232,6 +300,7 @@
   KHTMLPartBrowserHostExtension *m_hostExtension;
   KURLLabel* m_statusBarIconLabel;
   KURLLabel* m_statusBarWalletLabel;
+  KURLLabel* m_statusBarUALabel;
   KURLLabel* m_statusBarJSErrorLabel;
   DOM::DocumentImpl *m_doc;
   khtml::Decoder *m_decoder;
@@ -241,9 +310,7 @@
   QString scheduledScript;
   DOM::Node scheduledScriptNode;
 
-  KJSProxy *m_jscript;
   KWallet::Wallet* m_wallet;
-  KLibrary *m_kjs_lib;
   int m_runningScripts;
   bool m_bOpenMiddleClick :1;
   bool m_bBackRightClick :1;
@@ -471,6 +538,8 @@
   }
 
   time_t m_userStyleSheetLastModified;
+
+  KHTMLWalletQueue *m_wq;
 };
 
 #endif
diff -urN -x CVS kdelibs.orig/khtml/khtmlview.cpp kdelibs/khtml/khtmlview.cpp
--- kdelibs.orig/khtml/khtmlview.cpp	Sat Aug 28 16:05:09 2004
+++ kdelibs/khtml/khtmlview.cpp	Mon Nov 22 10:11:44 2004
@@ -5,6 +5,7 @@
  *                     1999 Antti Koivisto <koivisto@kde.org>
  *                     2000-2004 Dirk Mueller <mueller@kde.org>
  *                     2003 Leo Savernik <l.savernik@aon.at>
+ *                     2003 Apple Computer, Inc.
  *
  * This library is free software; you can redistribute it and/or
  * modify it under the terms of the GNU Library General Public
@@ -112,7 +113,7 @@
         m_view = view;
         m_viewprivate = vp;
     };
-    
+
 protected:
     virtual void maybeTip(const QPoint &);
 
@@ -133,6 +134,12 @@
 	PFBottom
     };
 
+    enum CompletedState {
+        CSNone = 0,
+        CSFull,
+        CSActionPending
+    };
+
     KHTMLViewPrivate()
         : underMouse( 0 ), underMouseNonShared( 0 )
     {
@@ -149,6 +156,7 @@
         prevScrollbarVisible = true;
 	tooltip = 0;
         possibleTripleClick = false;
+        emitCompletedAfterRepaint = CSNone;
     }
     ~KHTMLViewPrivate()
     {
@@ -193,6 +201,7 @@
         repaintbooth = 0;
 #endif
         scrollBarMoved = false;
+        contentsMoving = false;
         ignoreWheelEvents = false;
 	borderX = 30;
 	borderY = 30;
@@ -214,6 +223,7 @@
         firstRelayout = true;
         dirtyLayout = false;
         layoutSchedulingEnabled = true;
+        painting = false;
         updateRegion = QRegion();
         m_dialogsAllowed = true;
 #ifndef KHTML_NO_CARET
@@ -227,6 +237,7 @@
 #endif // KHTML_NO_TYPE_AHEAD_FIND
 	accessKeysActivated = false;
 	accessKeysPreActivate = false;
+        emitCompletedAfterRepaint = CSNone;
     }
     void newScrollTimer(QWidget *view, int tid)
     {
@@ -296,6 +307,7 @@
     bool lastTabbingDirection:1;
     PseudoFocusNodes pseudoFocusNode:2;
     bool scrollBarMoved:1;
+    bool contentsMoving:1;
 
     QScrollView::ScrollBarMode vmode;
     QScrollView::ScrollBarMode hmode;
@@ -317,14 +329,15 @@
 
     int repaintTimerId;
     int scrollTimerId;
-    bool scrollSuspended;
-    bool scrollSuspendPreActivate;
     int scrollTiming;
     int scrollBy;
     ScrollDirection scrollDirection;
+    bool scrollSuspended;
+    bool scrollSuspendPreActivate;
     bool complete;
     bool firstRelayout;
     bool layoutSchedulingEnabled;
+    bool painting;
     bool possibleTripleClick;
     bool dirtyLayout;
     bool m_dialogsAllowed;
@@ -343,6 +356,7 @@
 #endif // KHTML_NO_TYPE_AHEAD_FIND
     bool accessKeysActivated;
     bool accessKeysPreActivate;
+    CompletedState emitCompletedAfterRepaint;
 };
 
 #ifndef QT_NO_TOOLTIP
@@ -583,27 +597,33 @@
         return;
     }
 
+    if (d->painting) {
+        kdDebug( 6000 ) << "WARNING: drawContents reentered! " << endl;
+        return;
+    }
+    d->painting = true;
+
     QPoint pt = contentsToViewport(QPoint(ex, ey));
     QRegion cr = QRect(pt.x(), pt.y(), ew, eh);
 //     kdDebug(6000) << "clip rect: " << QRect(pt.x(), pt.y(), ew, eh) << endl;
     for (QPtrDictIterator<QWidget> it(d->visibleWidgets); it.current(); ++it) {
 	QWidget *w = it.current();
 	RenderWidget* rw = static_cast<RenderWidget*>( it.currentKey() );
-	QScrollView *sv = ::qt_cast<QScrollView *>(w);
-	if (sv || !rw->isFormElement()) {
-// 	    kdDebug(6000) << "    removing scrollview " << sv;
-	    int x, y;
-	    rw->absolutePosition(x, y);
-	    contentsToViewport(x, y, x, y);
-	    cr -= QRect(x, y, rw->width(), rw->height());
-	}
+        if (strcmp(w->name(), "__khtml")) {
+            int x, y;
+            rw->absolutePosition(x, y);
+            contentsToViewport(x, y, x, y);
+            cr -= QRect(x, y, rw->width(), rw->height());
+        }
     }
 
 #if 0
     // this is commonly the case with framesets. we still do
     // want to paint them, otherwise the widgets don't get placed.
-    if (cr.isEmpty())
+    if (cr.isEmpty()) {
+        d->painting = false;
 	return;
+    }
 #endif
 
 #ifndef DEBUG_NO_PAINT_BUFFER
@@ -669,7 +689,8 @@
 
     khtml::DrawContentsEvent event( p, ex, ey, ew, eh );
     QApplication::sendEvent( m_part, &event );
-
+    
+    d->painting = false;
 }
 
 void KHTMLView::setMarginWidth(int w)
@@ -699,7 +720,7 @@
              if(body && body->renderer() && body->id() == ID_FRAMESET) {
                  QScrollView::setVScrollBarMode(AlwaysOff);
                  QScrollView::setHScrollBarMode(AlwaysOff);
-                 body->renderer()->setLayouted(false);
+                 body->renderer()->setNeedsLayout(true);
 //                  if (d->tooltip) {
 //                      delete d->tooltip;
 //                      d->tooltip = 0;
@@ -713,8 +734,7 @@
         _width = visibleWidth();
         //QTime qt;
         //qt.start();
-        root->setMinMaxKnown(false);
-        root->setLayouted(false);
+        root->setNeedsLayoutAndMinMaxRecalc();
         root->layout();
 
         emit finishedLayout();
@@ -1235,7 +1255,7 @@
 		return;
 	}
 #endif // KHTML_NO_TYPE_AHEAD_FIND
-	
+
     int offs = (clipper()->height() < 30) ? clipper()->height() : 30;
     if (_ke->state() & Qt::ShiftButton)
       switch(_ke->key())
@@ -1446,7 +1466,7 @@
 	    d->accessKeysPreActivate = false;
 	}
 	else if (d->accessKeysActivated) accessKeysTimeout();
-	
+
     if( d->scrollSuspendPreActivate && _ke->key() != Key_Shift )
         d->scrollSuspendPreActivate = false;
     if( _ke->key() == Key_Shift && d->scrollSuspendPreActivate && _ke->state() == Qt::ShiftButton
@@ -1460,7 +1480,7 @@
         _ke->accept();
         return;
     }
-    
+
     QScrollView::keyReleaseEvent(_ke);
 }
 
@@ -1592,15 +1612,16 @@
 		    if (!strcmp(w->name(), "__khtml")) {
 			w->installEventFilter(this);
 			w->unsetCursor();
-			w->setBackgroundMode( QWidget::NoBackground );
+			if (!::qt_cast<QFrame*>(w))
+			    w->setBackgroundMode( QWidget::NoBackground );
 			static_cast<HackWidget *>(w)->setNoErase();
 			if (w->children()) {
 			    QObjectListIterator it(*w->children());
 			    for (; it.current(); ++it) {
 				QWidget *widget = ::qt_cast<QWidget *>(it.current());
-				if (widget && !widget->isTopLevel()
-				    && !::qt_cast<QScrollView *>(widget)) {
-				    widget->setBackgroundMode( QWidget::NoBackground );
+				if (widget && !widget->isTopLevel()) {
+				    if (!::qt_cast<QFrame*>(w))
+				        widget->setBackgroundMode( QWidget::NoBackground );
 				    static_cast<HackWidget *>(widget)->setNoErase();
 				    widget->installEventFilter(this);
 				}
@@ -1636,8 +1657,17 @@
 		    }
 		    viewportToContents( x, y, x, y );
 		    QPaintEvent *pe = static_cast<QPaintEvent *>(e);
- 		    scheduleRepaint(x + pe->rect().x(), y + pe->rect().y(),
- 				    pe->rect().width(), pe->rect().height());
+		    bool asap = !d->contentsMoving && ::qt_cast<QScrollView *>(c);
+		    
+		    // QScrollView needs fast repaints
+		    if ( asap && !d->painting && m_part->xmlDocImpl() && m_part->xmlDocImpl()->renderer() &&
+		         !static_cast<khtml::RenderCanvas *>(m_part->xmlDocImpl()->renderer())->needsLayout() ) {
+		        repaintContents(x + pe->rect().x(), y + pe->rect().y(),
+	                                        pe->rect().width(), pe->rect().height(), true);
+                    } else {
+ 		        scheduleRepaint(x + pe->rect().x(), y + pe->rect().y(),
+ 				    pe->rect().width(), pe->rect().height(), asap);
+                    }
 		}
 		break;
 	    case QEvent::MouseMove:
@@ -1770,7 +1800,7 @@
 {
     // Sets the focus node of the document to be the node after (or if
     // next is false, before) the current focus node.  Only nodes that
-    // are selectable (i.e. for which isSelectable() returns true) are
+    // are selectable (i.e. for which isFocusable() returns true) are
     // taken into account, and the order used is that specified in the
     // HTML spec (see DocumentImpl::nextFocusNode() and
     // DocumentImpl::previousFocusNode() for details).
@@ -1798,7 +1828,7 @@
 
 	while (toFocus && toFocus != oldFocusNode)
 	{
-	    
+
 	    QRect focusNodeRect = toFocus->getRect();
 	    if ((focusNodeRect.left() > contentsX()) && (focusNodeRect.right() < contentsX() + visibleWidth()) &&
 		(focusNodeRect.top() > contentsY()) && (focusNodeRect.bottom() < contentsY() + visibleHeight())) {
@@ -1925,7 +1955,7 @@
         if( n->isElementNode()) {
             ElementImpl* en = static_cast< ElementImpl* >( n );
             DOMString s = en->getAttribute( ATTR_ACCESSKEY );
-            if( s.length() == 1) {	    
+            if( s.length() == 1) {
 	        QRect rec=en->getRect();
 	        QLabel *lab=new QLabel(s.string(),viewport(),0,Qt::WDestructiveClose);
 	        connect( this, SIGNAL(hideAccessKeys()), lab, SLOT(close()) );
@@ -2015,7 +2045,7 @@
     ensureVisible( r.left(), r.top());
 
     Node guard( node );
-    if( node->isSelectable()) {
+    if( node->isFocusable()) {
 	if (node->id()==ID_LABEL) {
 	    // if Accesskey is a label, give focus to the label's referrer.
 	    node=static_cast<ElementImpl *>(static_cast< HTMLLabelElementImpl* >( node )->getFormElement());
@@ -2131,8 +2161,7 @@
         m_part->xmlDocImpl()->styleSelector()->computeFontSizes(&metrics, 100);
         m_part->xmlDocImpl()->updateStyleSelector();
         root->setPrintImages( printer->option("app-khtml-printimages") == "true");
-        root->setMinMaxKnown( false );
-        root->setLayouted( false );
+        root->setNeedsLayoutAndMinMaxRecalc();
         root->layout();
         khtml::RenderWidget::flushWidgetResizes(); // make sure widgets have their final size
 
@@ -2199,6 +2228,8 @@
 
         int top = 0;
         int page = 1;
+        int bottom = 0;
+        int oldbottom = 0;
         while(top < root->docHeight()) {
             if(top > 0) printer->newPage();
             if (printHeader)
@@ -2220,13 +2251,19 @@
 #endif
             p->translate(0, headerHeight-top);
 
-            root->setTruncatedAt(top+pageHeight);
+            oldbottom = top+pageHeight;
+            root->setTruncatedAt(oldbottom);
 
             root->layer()->paint(p, QRect(0, top, pageWidth, pageHeight));
-            if (top + pageHeight >= root->docHeight())
+            bottom = root->bestTruncatedAt();
+            kdDebug(6000) << "printed: page " << page <<" truncatedAt = " << oldbottom
+                          << " bestTruncatedAt = " << bottom << endl;
+            if (bottom == 0) bottom = oldbottom;
+
+            if (bottom >= root->docHeight())
                 break; // Stop if we have printed everything
 
-            top = root->truncatedAt();
+            top = bottom;
             p->resetXForm();
             page++;
         }
@@ -2437,9 +2474,9 @@
 	default:
 	    break;
     }
-    if (d->accessKeysPreActivate && button!=-1) 
+    if (d->accessKeysPreActivate && button!=-1)
     	d->accessKeysPreActivate=false;
-	
+
     bool ctrlKey = (_mouse->state() & ControlButton);
     bool altKey = (_mouse->state() & AltButton);
     bool shiftKey = (_mouse->state() & ShiftButton);
@@ -2507,7 +2544,7 @@
         me->deref();
 
         if (eventId == EventImpl::MOUSEDOWN_EVENT) {
-            if (targetNode->isSelectable())
+            if (targetNode->isFocusable())
                 m_part->xmlDocImpl()->setFocusNode(targetNode);
             else
                 m_part->xmlDocImpl()->setFocusNode(0);
@@ -2649,8 +2686,21 @@
 
 void KHTMLView::slotScrollBarMoved()
 {
-    if (!d->scrollingSelf)
+    if ( !d->firstRelayout && !d->complete && m_part->xmlDocImpl() &&
+          d->layoutSchedulingEnabled) {
+        // contents scroll while we are not complete: we need to check our layout *now*
+        khtml::RenderCanvas* root = static_cast<khtml::RenderCanvas *>( m_part->xmlDocImpl()->renderer() );
+        if (root && root->needsLayout()) {
+            unscheduleRelayout();
+            layout();
+        }
+    }
+    if (!d->scrollingSelf) {
         d->scrollBarMoved = true;
+        d->contentsMoving = true;
+        // ensure quick reset of contentsMoving flag
+        scheduleRepaint(0, 0, 0, 0);
+    }
 }
 
 void KHTMLView::timerEvent ( QTimerEvent *e )
@@ -2707,11 +2757,12 @@
     }
 #endif
 
+    d->contentsMoving = false;
     if( m_part->xmlDocImpl() ) {
 	DOM::DocumentImpl *document = m_part->xmlDocImpl();
 	khtml::RenderCanvas* root = static_cast<khtml::RenderCanvas *>(document->renderer());
 
-	if ( root && !root->layouted() ) {
+	if ( root && root->needsLayout() ) {
 	    killTimer(d->repaintTimerId);
 	    d->repaintTimerId = 0;
 	    scheduleRelayout();
@@ -2767,6 +2818,13 @@
                 addChild(w, 0, -500000);
     }
     if (d->accessKeysActivated) emit repaintAccessKeys();
+    if (d->emitCompletedAfterRepaint) {
+        if (d->emitCompletedAfterRepaint == KHTMLViewPrivate::CSFull)
+            emit m_part->completed();
+        else
+            emit m_part->completed(true);
+        d->emitCompletedAfterRepaint = KHTMLViewPrivate::CSNone;
+    }
 }
 
 void KHTMLView::scheduleRelayout(khtml::RenderObject * /*clippedObj*/)
@@ -2796,14 +2854,14 @@
     d->repaintTimerId = 0;
 }
 
-void KHTMLView::scheduleRepaint(int x, int y, int w, int h)
+void KHTMLView::scheduleRepaint(int x, int y, int w, int h, bool asap)
 {
     bool parsing = !m_part->xmlDocImpl() || m_part->xmlDocImpl()->parsing();
 
 //     kdDebug() << "parsing " << parsing << endl;
 //     kdDebug() << "complete " << d->complete << endl;
 
-    int time = parsing ? 300 : ( !d->complete ? 100 : 20 );
+    int time = parsing ? 300 : (!asap ? ( !d->complete ? 100 : 20 ) : 0);
 
 #ifdef DEBUG_FLICKER
     QPainter p;
@@ -2816,6 +2874,9 @@
 #endif
 
     d->updateRegion = d->updateRegion.unite(QRect(x,y,w,h));
+    
+    if (asap && !parsing)
+        unscheduleRelayout();
 
     if ( !d->repaintTimerId )
         d->repaintTimerId = startTimer( time );
@@ -2823,7 +2884,7 @@
 //     kdDebug() << "starting timer " << time << endl;
 }
 
-void KHTMLView::complete()
+void KHTMLView::complete( bool pendingAction )
 {
 //     kdDebug() << "KHTMLView::complete()" << endl;
 
@@ -2836,6 +2897,8 @@
         // do it now
         killTimer(d->layoutTimerId);
         d->layoutTimerId = startTimer( 0 );
+        d->emitCompletedAfterRepaint = pendingAction ?
+            KHTMLViewPrivate::CSActionPending : KHTMLViewPrivate::CSFull;
     }
 
     // is there a repaint pending?
@@ -2845,7 +2908,18 @@
         // do it now
         killTimer(d->repaintTimerId);
         d->repaintTimerId = startTimer( 20 );
+        d->emitCompletedAfterRepaint = pendingAction ?
+            KHTMLViewPrivate::CSActionPending : KHTMLViewPrivate::CSFull;
+    }
+
+    if (!d->emitCompletedAfterRepaint)
+    {
+        if (!pendingAction)
+            emit m_part->completed();
+        else
+            emit m_part->completed(true);
     }
+
 }
 
 #ifndef KHTML_NO_CARET
diff -urN -x CVS kdelibs.orig/khtml/khtmlview.h kdelibs/khtml/khtmlview.h
--- kdelibs.orig/khtml/khtmlview.h	Fri Jul 30 20:46:18 2004
+++ kdelibs/khtml/khtmlview.h	Wed Nov 10 10:00:15 2004
@@ -220,7 +220,7 @@
     void scheduleRelayout(khtml::RenderObject* clippedObj=0);
     void unscheduleRelayout();
 
-    void scheduleRepaint(int x, int y, int w, int h);
+    void scheduleRepaint(int x, int y, int w, int h, bool asap=false);
     void unscheduleRepaint();
 
     void closeChildDialogs();
@@ -280,7 +280,7 @@
     bool dispatchKeyEvent( QKeyEvent *_ke );
     bool dispatchKeyEventHelper( QKeyEvent *_ke, bool generate_keypress );
 
-    void complete();
+    void complete( bool pendingAction );
 
 #ifndef KHTML_NO_TYPE_AHEAD_FIND
     void findAhead(bool increase);
diff -urN -x CVS kdelibs.orig/khtml/kmultipart/kmultipart.desktop kdelibs/khtml/kmultipart/kmultipart.desktop
--- kdelibs.orig/khtml/kmultipart/kmultipart.desktop	Mon Oct  4 15:25:03 2004
+++ kdelibs/khtml/kmultipart/kmultipart.desktop	Fri Nov 12 08:27:51 2004
@@ -3,6 +3,7 @@
 Type=Service
 MimeType=multipart/mixed;multipart/x-mixed-replace
 Name=Embeddable Component for multipart/mixed
+Name[af]=Inlegbare Komponent vir multideel/gemeng
 Name[bg]=Компонент за вграждане за преглед на съобщения multipart/mixed
 Name[bn]=multipart/mixed-এর জন্য অভ্যন্তরীণ উপাদান
 Name[bs]=Ugradiva komponenta za multipart/mixed
@@ -20,7 +21,10 @@
 Name[is]=Ívefjanleg eining fyrir MIME multipart/mixed
 Name[it]=Componente integrabile per multipart/mixed
 Name[ja]=マルチパート/混合 の埋め込み可能なコンポーネント
+Name[lt]=Įdedamas komponentas multipart/mixed tipui
+Name[mk]=Вгнездлива компонента за multipart/mixed
 Name[nb]=Innebyggbar komponent for multipart/mixed
+Name[nds]=Inbettbor Komponent för den MIME-Typ "multipart/mixed"
 Name[nl]=Inbedbaar component voor multipart/mixed
 Name[nn]=Inkluderbar komponent for multipart/mixed
 Name[pa]=ਬਹੁਭਾਗੀ/ਰਲਵੇਂ ਲਈ ਸ਼ਾਮਿਲ ਭਾਗ
@@ -28,6 +32,7 @@
 Name[pt]=Componente Embebido para multipart/mixed
 Name[pt_BR]=Componente embutido para multipart/mixed
 Name[ro]=Componentă înglobată pentru tip MIME multipart/mixed
+Name[ru]=Встраиваемый компонент для вложений multipart/mixed
 Name[se]=Vuojuhanláhkái oassi multipart/mixed:a várás
 Name[sk]=Vložiteľný komponent pre multipart/mixed
 Name[sr]=Уградива компонента за „multipart/mixed“
@@ -36,6 +41,7 @@
 Name[ta]=பலப்பகுதி/கலக்கப்பட்ட பகுதிக்குரிய உட்பொதிந்த பகுதி
 Name[tg]=Компоненти дарунсохт барои қисматҳои зиёд/омезишшуда
 Name[uk]=Вбудовна компонента для повідомлень multipart/mixed
+Name[uz]=Multipart/mixed учун ичига ўрнатиб бўладиган компонент
 Name[zh_CN]=可嵌入的 multipart/mixed 组件
 ServiceTypes=KParts/ReadOnlyPart
 X-KDE-Library=libkmultipart
diff -urN -x CVS kdelibs.orig/khtml/misc/decoder.cpp kdelibs/khtml/misc/decoder.cpp
--- kdelibs.orig/khtml/misc/decoder.cpp	Tue Mar  2 14:43:14 2004
+++ kdelibs/khtml/misc/decoder.cpp	Wed Nov 17 14:43:03 2004
@@ -23,7 +23,6 @@
 //----------------------------------------------------------------------------
 //
 // KDE HTML Widget -- decoder for input stream
-// $Id$
 
 #undef DECODE_DEBUG
 //#define DECODE_DEBUG
diff -urN -x CVS kdelibs.orig/khtml/misc/decoder.h kdelibs/khtml/misc/decoder.h
--- kdelibs.orig/khtml/misc/decoder.h	Tue Feb  3 13:37:15 2004
+++ kdelibs/khtml/misc/decoder.h	Wed Nov 17 14:43:03 2004
@@ -18,7 +18,6 @@
     the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
     Boston, MA 02111-1307, USA.
 
-    $Id$
 */
 #ifndef KHTMLDECODER_H
 #define KHTMLDECODER_H
@@ -30,7 +29,7 @@
 namespace khtml {
 
 class JapaneseCode;
-    
+
 /**
  * @internal
  */
diff -urN -x CVS kdelibs.orig/khtml/misc/helper.cpp kdelibs/khtml/misc/helper.cpp
--- kdelibs.orig/khtml/misc/helper.cpp	Sun May 18 00:12:58 2003
+++ kdelibs/khtml/misc/helper.cpp	Wed Nov 17 14:43:03 2004
@@ -18,7 +18,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #include "helper.h"
 #include "khtmllayout.h"
diff -urN -x CVS kdelibs.orig/khtml/misc/helper.h kdelibs/khtml/misc/helper.h
--- kdelibs.orig/khtml/misc/helper.h	Wed Nov 19 18:44:25 2003
+++ kdelibs/khtml/misc/helper.h	Wed Nov 17 14:43:03 2004
@@ -18,7 +18,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #ifndef html_helper_h
 #define html_helper_h
diff -urN -x CVS kdelibs.orig/khtml/misc/loader.cpp kdelibs/khtml/misc/loader.cpp
--- kdelibs.orig/khtml/misc/loader.cpp	Sat May 29 18:18:41 2004
+++ kdelibs/khtml/misc/loader.cpp	Wed Nov 10 10:00:24 2004
@@ -414,13 +414,7 @@
 
 static QString buildAcceptHeader()
 {
-    QString result = KImageIO::mimeTypes( KImageIO::Reading ).join(", ");
-    if (result.endsWith(", "))
-        result.truncate(result.length()-2);
-    if ( !result.isEmpty() )
-        result += ";q=0.5";
-    result += ",*/*;q=0.1";
-    return result;
+    return "image/png, image/jpeg, video/x-mng, image/jp2, image/gif;q=0.5,*/*;q=0.1";
 }
 
 // -------------------------------------------------------------------------------------
@@ -587,14 +581,17 @@
     if(m)
     {
         if(m->framePixmap().size() != m->getValidRect().size())
-        {
+        {   
             // pixmap is not yet completely loaded, so we
             // return a clipped version. asserting here
             // that the valid rect is always from 0/0 to fullwidth/ someheight
-            if(!pixPart) pixPart = new QPixmap(m->getValidRect().size());
+            if(!pixPart) pixPart = new QPixmap();
 
             (*pixPart) = m->framePixmap();
-            pixPart->resize(m->getValidRect().size());
+            if (m->getValidRect().size().isValid())
+                pixPart->resize(m->getValidRect().size());
+            else
+                pixPart->resize(0, 0);
             return *pixPart;
         }
         else
@@ -769,6 +766,8 @@
         assert(!eof);
 
         formatType = QImageDecoder::formatName( (const uchar*)_buffer.buffer().data(), _buffer.size());
+        if ( formatType && strcmp( formatType, "PNG" ) == 0 )
+            formatType = 0; // Some png files contain multiple images, we want to show only the first one
 
         typeChecked = true;
 
diff -urN -x CVS kdelibs.orig/khtml/misc/loader_client.h kdelibs/khtml/misc/loader_client.h
--- kdelibs.orig/khtml/misc/loader_client.h	Sat Jun 21 11:14:52 2003
+++ kdelibs/khtml/misc/loader_client.h	Wed Nov 17 14:43:03 2004
@@ -1,5 +1,3 @@
-// $Id$
-
 #ifndef LOADER_CLIENT_H
 #define LOADER_CLIENT_H
 
diff -urN -x CVS kdelibs.orig/khtml/misc/stringit.h kdelibs/khtml/misc/stringit.h
--- kdelibs.orig/khtml/misc/stringit.h	Sun May 18 00:12:58 2003
+++ kdelibs/khtml/misc/stringit.h	Wed Nov 17 14:59:17 2004
@@ -21,7 +21,6 @@
 //----------------------------------------------------------------------------
 //
 // KDE HTML Widget -- String class
-// $Id$
 
 #ifndef KHTMLSTRING_H
 #define KHTMLSTRING_H
diff -urN -x CVS kdelibs.orig/khtml/rendering/bidi.cpp kdelibs/khtml/rendering/bidi.cpp
--- kdelibs.orig/khtml/rendering/bidi.cpp	Tue Jul  6 20:35:56 2004
+++ kdelibs/khtml/rendering/bidi.cpp	Wed Nov 24 15:01:00 2004
@@ -2,6 +2,7 @@
  * This file is part of the html renderer for KDE.
  *
  * Copyright (C) 2000-2003 Lars Knoll (knoll@kde.org)
+ *           (C) 2003-2004 Apple Computer, Inc.
  *
  * This library is free software; you can redistribute it and/or
  * modify it under the terms of the GNU Library General Public
@@ -18,7 +19,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #include "rendering/bidi.h"
 #include "rendering/break_lines.h"
@@ -26,56 +26,82 @@
 #include "rendering/render_text.h"
 #include "rendering/render_arena.h"
 #include "rendering/render_layer.h"
-using namespace khtml;
+#include "xml/dom_docimpl.h"
 
-#include <kdebug.h>
-#include <kglobal.h>
-#include <qdatetime.h>
-#include <qfontmetrics.h>
+#include "kdebug.h"
+#include "qdatetime.h"
+#include "qfontmetrics.h"
 
 #define BIDI_DEBUG 0
 //#define DEBUG_LINEBREAKS
 
-#if BIDI_DEBUG > 1
+namespace khtml {
+
+
+// an iterator which goes through a BidiParagraph
+struct BidiIterator
+{
+    BidiIterator() : par(0), obj(0), pos(0) {}
+    BidiIterator(RenderBlock *_par, RenderObject *_obj, unsigned int _pos) : par(_par), obj(_obj), pos(_pos) {}
 
-// the ones from the QChar class
-static const char *directions[] = {
-    "DirL", "DirR", "DirEN", "DirES", "DirET", "DirAN", "DirCS", "DirB", "DirS", "DirWS", "DirON",
-    "DirLRE", "DirLRO", "DirAL", "DirRLE", "DirRLO", "DirPDF", "DirNSM", "DirBN"
+    void increment( BidiState &bidi );
+
+    bool atEnd() const;
+
+    const QChar &current() const;
+    QChar::Direction direction() const;
+
+    RenderBlock *par;
+    RenderObject *obj;
+    unsigned int pos;
 };
 
-inline kdbgstream &operator<<(kdbgstream &stream, QChar::Direction d) {
-    return (stream << directions[d]);
-}
 
+struct BidiStatus {
+    BidiStatus() : eor(QChar::DirON), lastStrong(QChar::DirON), last(QChar::DirON) {}
 
-#endif
+    QChar::Direction eor;
+    QChar::Direction lastStrong;
+    QChar::Direction last;
+};
 
-inline BidiIterator::BidiIterator()
-{
-    par = 0;
-    obj = 0;
-    pos = 0;
-}
+struct BidiState {
+    BidiState() : context(0) {}
 
-static BidiIterator sor;
-static BidiIterator eor;
-static BidiIterator last;
-static BidiIterator current;
-static BidiContext *context;
-static BidiStatus status;
-static QPtrList<BidiRun> *sruns = 0;
+    BidiIterator sor;
+    BidiIterator eor;
+    BidiIterator last;
+    BidiIterator current;
+    BidiContext *context;
+    BidiStatus status;
+};
+
+// Used to track a list of chained bidi runs.
+static BidiRun* sFirstBidiRun;
+static BidiRun* sLastBidiRun;
+static int sBidiRunCount;
+static BidiRun* sCompactFirstBidiRun;
+static BidiRun* sCompactLastBidiRun;
+static int sCompactBidiRunCount;
+static bool sBuildingCompactRuns;
+
+// Midpoint globals.  The goal is not to do any allocation when dealing with
+// these midpoints, so we just keep an array around and never clear it.  We track
+// the number of items and position using the two other variables.
+static QMemArray<BidiIterator> *smidpoints;
+static uint sNumMidpoints;
+static uint sCurrMidpoint;
+static bool betweenMidpoints;
+
+static bool isLineEmpty = true;
+static bool previousLineBrokeAtBR = true;
 static QChar::Direction dir;
-static bool adjustEmbeddding = false;
+static bool adjustEmbedding;
 static bool emptyRun = true;
 static int numSpaces;
 
-static void embed( QChar::Direction d );
-static void appendRun();
-
-#ifndef NDEBUG
-static bool inBidiIteratorDetach;
-#endif
+static void embed( QChar::Direction d, BidiState &bidi );
+static void appendRun( BidiState &bidi );
 
 static int getBPMWidth(int childValue, Length cssUnit)
 {
@@ -103,7 +129,7 @@
 {
     int extraWidth = 0;
     RenderObject* parent = child->parent();
-    while (parent->isInline() && !parent->isReplacedBlock()) {
+    while (parent->isInline() && !parent->isInlineBlockOrInlineTable()) {
         if (start && parent->firstChild() == child)
             extraWidth += getBorderPaddingMargin(parent, false);
         if (end && parent->lastChild() == child)
@@ -114,33 +140,54 @@
     return extraWidth;
 }
 
-void BidiIterator::detach(RenderArena* renderArena)
+#ifndef NDEBUG
+static bool inBidiRunDetach;
+#endif
+
+void BidiRun::detach(RenderArena* renderArena)
 {
 #ifndef NDEBUG
-    inBidiIteratorDetach = true;
+    inBidiRunDetach = true;
 #endif
     delete this;
 #ifndef NDEBUG
-    inBidiIteratorDetach = false;
+    inBidiRunDetach = false;
 #endif
 
     // Recover the size left there for us by operator delete and free the memory.
     renderArena->free(*(size_t *)this, this);
 }
 
-void* BidiIterator::operator new(size_t sz, RenderArena* renderArena) throw()
+void* BidiRun::operator new(size_t sz, RenderArena* renderArena) throw()
 {
     return renderArena->allocate(sz);
 }
 
-void BidiIterator::operator delete(void* ptr, size_t sz)
+void BidiRun::operator delete(void* ptr, size_t sz)
 {
-    assert(inBidiIteratorDetach);
+    assert(inBidiRunDetach);
 
     // Stash size where detach can find it.
     *(size_t*)ptr = sz;
 }
 
+static void deleteBidiRuns(RenderArena* arena)
+{
+    if (!sFirstBidiRun)
+        return;
+
+    BidiRun* curr = sFirstBidiRun;
+    while (curr) {
+        BidiRun* s = curr->nextRun;
+        curr->detach(arena);
+        curr = s;
+    }
+
+    sFirstBidiRun = 0;
+    sLastBidiRun = 0;
+    sBidiRunCount = 0;
+}
+
 // ---------------------------------------------------------------------
 
 /* a small helper class used internally to resolve Bidi embedding levels.
@@ -191,35 +238,36 @@
     return false;
 }
 
-static inline RenderObject *Bidinext(RenderObject *par, RenderObject *current, bool skipInlines = true)
+static inline RenderObject *Bidinext(RenderObject *par, RenderObject *current, BidiState &bidi,
+                                     bool skipInlines = true)
 {
     RenderObject *next = 0;
+
     while(current != 0)
     {
         //kdDebug( 6040 ) << "current = " << current << endl;
-	if (!current->isFloating() && !current->isReplaced() && !current->isPositioned()) {
-	    next = current->firstChild();
-	    if ( next && adjustEmbeddding ) {
-		EUnicodeBidi ub = next->style()->unicodeBidi();
-		if ( ub != UBNormal && !emptyRun ) {
-		    EDirection dir = next->style()->direction();
-// 		    qDebug("element: unicode-bidi=%d, dir=%d", ub, dir);
-		    QChar::Direction d = ( ub == Embed ? ( dir == RTL ? QChar::DirRLE : QChar::DirLRE )
-					: ( dir == RTL ? QChar::DirRLO : QChar::DirLRO ) );
-		    embed( d );
-		}
-	    }
-	}
-	if (!next) {
-	    while (current && current != par) {
-		next = current->nextSibling();
-		if (next) break;
-		if ( adjustEmbeddding && current->style()->unicodeBidi() != UBNormal && !emptyRun ) {
-		    embed( QChar::DirPDF );
-		}
-		current = current->parent();
-	    }
-	}
+        if (!current->isFloating() && !current->isReplaced() && !current->isPositioned()) {
+            next = current->firstChild();
+            if ( next && adjustEmbedding ) {
+                EUnicodeBidi ub = next->style()->unicodeBidi();
+                if ( ub != UBNormal && !emptyRun ) {
+                    EDirection dir = next->style()->direction();
+                    QChar::Direction d = ( ub == Embed ? ( dir == RTL ? QChar::DirRLE : QChar::DirLRE )
+                                        : ( dir == RTL ? QChar::DirRLO : QChar::DirLRO ) );
+                    embed( d, bidi );
+                }
+            }
+        }
+        if (!next) {
+            while (current && current != par) {
+                next = current->nextSibling();
+                if (next) break;
+                if ( adjustEmbedding && current->style()->unicodeBidi() != UBNormal && !emptyRun ) {
+                    embed( QChar::DirPDF, bidi );
+                }
+                current = current->parent();
+            }
+        }
 
         if (!next) break;
 
@@ -232,89 +280,35 @@
     return next;
 }
 
-static RenderObject *first( RenderObject *par, bool skipInlines = true )
+static RenderObject *first( RenderObject *par, BidiState &bidi, bool skipInlines = true )
 {
     if(!par->firstChild()) return 0;
     RenderObject *o = par->firstChild();
 
     if (o->isInlineFlow()) {
         if (skipInlines && o->firstChild())
-            o = Bidinext( par, o, skipInlines );
+            o = Bidinext( par, o, bidi, skipInlines );
         else
             return o; // Never skip empty inlines.
     }
 
-    if(o && !o->isText() && !o->isBR() && !o->isReplaced() && !o->isFloating() && !o->isPositioned())
-        o = Bidinext( par, o );
-
+    if (o && !o->isText() && !o->isBR() && !o->isReplaced() && !o->isFloating() && !o->isPositioned())
+        o = Bidinext( par, o, bidi, skipInlines );
     return o;
 }
 
-BidiIterator::BidiIterator(RenderFlow *_par)
-{
-    par = _par;
-    if ( par && adjustEmbeddding ) {
-	EUnicodeBidi ub = par->style()->unicodeBidi();
-	if ( ub != UBNormal ) {
-	    EDirection dir = par->style()->direction();
-// 	    qDebug("element: unicode-bidi=%d, dir=%d", ub, dir);
-	    QChar::Direction d = ( ub == Embed ? ( dir == RTL ? QChar::DirRLE : QChar::DirLRE )
-				   : ( dir == RTL ? QChar::DirRLO : QChar::DirLRO ) );
-	    embed( d );
-	}
-    }
-    obj = first( par );
-    isText = obj ? obj->isText() : false;
-    pos = 0;
-    //kdDebug(6041) << "bidiiterator init: pos " << pos << endl;
-}
-
-inline BidiIterator::BidiIterator(const BidiIterator &it)
-{
-    par = it.par;
-    obj = it.obj;
-    pos = it.pos;
-    isText = obj ? obj->isText() : false;
-}
-
-inline BidiIterator::BidiIterator(RenderFlow *_par, RenderObject *_obj, int _pos)
-{
-    par = _par;
-    obj = _obj;
-    isText = obj ? obj->isText() : false;
-    pos = _pos;
-    //kdDebug(6041) << "bidiiterator init(2): pos " << pos << endl;
-}
-
-inline BidiIterator &BidiIterator::operator = (const BidiIterator &it)
-{
-    obj = it.obj;
-    pos = it.pos;
-    par = it.par;
-    isText = obj ? obj->isText() : false;
-    return *this;
-}
-
-inline void BidiIterator::operator ++ ()
+inline void BidiIterator::increment (BidiState &bidi)
 {
     if(!obj) return;
-    if(isText) {
+    if(obj->isText()) {
         pos++;
         if(pos >= static_cast<RenderText *>(obj)->stringLength()) {
-            obj = Bidinext( par, obj );
-            while (obj && obj->isText() && !static_cast<RenderText *>(obj)->stringLength())
-                obj = Bidinext( par, obj);
-	    isText = obj ? obj->isText() : false;
+            obj = Bidinext( par, obj, bidi );
             pos = 0;
-//kdDebug(6041) << "bidiiterator ++(1): pos " << pos << endl;
         }
     } else {
-        obj = Bidinext( par, obj);
-        while (obj && obj->isText() && !static_cast<RenderText *>(obj)->stringLength())
-            obj = Bidinext( par, obj);
-	isText = obj ? obj->isText() : false;
+        obj = Bidinext( par, obj, bidi );
         pos = 0;
-//kdDebug(6041) << "bidiiterator ++(2): pos " << pos << endl;
     }
 }
 
@@ -324,17 +318,23 @@
     return false;
 }
 
-static const QChar nbsp = QChar(0xA0);
-
-inline const QChar &BidiIterator::current() const
+const QChar &BidiIterator::current() const
 {
-    if( !isText ) return nbsp; // non breaking space
-    return static_cast<RenderText *>(obj)->text()[pos];
+    static QChar nonBreakingSpace(0xA0);
+
+    if (!obj || !obj->isText())
+      return nonBreakingSpace;
+
+    RenderText* text = static_cast<RenderText*>(obj);
+    if (!text->text())
+        return nonBreakingSpace;
+
+    return text->text()[pos];
 }
 
 inline QChar::Direction BidiIterator::direction() const
 {
-    if( !isText ) return QChar::DirON;
+    if(!obj || !obj->isText() ) return QChar::DirON;
 
     RenderText *renderTxt = static_cast<RenderText *>( obj );
     if ( pos >= renderTxt->stringLength() )
@@ -344,67 +344,206 @@
 
 // -------------------------------------------------------------------------------------------------
 
-static void appendRun()
+static void addRun(BidiRun* bidiRun)
+{
+    if (!sFirstBidiRun)
+        sFirstBidiRun = sLastBidiRun = bidiRun;
+    else {
+        sLastBidiRun->nextRun = bidiRun;
+        sLastBidiRun = bidiRun;
+    }
+    sBidiRunCount++;
+    bidiRun->compact = sBuildingCompactRuns;
+
+    // Compute the number of spaces in this run,
+    if (bidiRun->obj && bidiRun->obj->isText()) {
+        RenderText* text = static_cast<RenderText*>(bidiRun->obj);
+        if (text->text()) {
+            for (int i = bidiRun->start; i < bidiRun->stop; i++) {
+                const QChar c = text->text()[i];
+                if (c.category() == QChar::Separator_Space || c == '\n')
+                    numSpaces++;
+            }
+        }
+    }
+}
+
+static void reverseRuns(int start, int end)
+{
+    if (start >= end)
+        return;
+
+    assert(start >= 0 && end < sBidiRunCount);
+
+    // Get the item before the start of the runs to reverse and put it in
+    // |beforeStart|.  |curr| should point to the first run to reverse.
+    BidiRun* curr = sFirstBidiRun;
+    BidiRun* beforeStart = 0;
+    int i = 0;
+    while (i < start) {
+        i++;
+        beforeStart = curr;
+        curr = curr->nextRun;
+    }
+
+    BidiRun* startRun = curr;
+    while (i < end) {
+        i++;
+        curr = curr->nextRun;
+    }
+    BidiRun* endRun = curr;
+    BidiRun* afterEnd = curr->nextRun;
+
+    i = start;
+    curr = startRun;
+    BidiRun* newNext = afterEnd;
+    while (i <= end) {
+        // Do the reversal.
+        BidiRun* next = curr->nextRun;
+        curr->nextRun = newNext;
+        newNext = curr;
+        curr = next;
+        i++;
+    }
+
+    // Now hook up beforeStart and afterEnd to the newStart and newEnd.
+    if (beforeStart)
+        beforeStart->nextRun = endRun;
+    else
+        sFirstBidiRun = endRun;
+
+    startRun->nextRun = afterEnd;
+    if (!afterEnd)
+        sLastBidiRun = startRun;
+}
+
+static void checkMidpoints(BidiIterator& lBreak, BidiState &bidi)
+{
+    // Check to see if our last midpoint is a start point beyond the line break.  If so,
+    // shave it off the list, and shave off a trailing space if the previous end point isn't
+    // white-space: pre.
+    if (lBreak.obj && sNumMidpoints && sNumMidpoints%2 == 0) {
+        BidiIterator* midpoints = smidpoints->data();
+        BidiIterator& endpoint = midpoints[sNumMidpoints-2];
+        const BidiIterator& startpoint = midpoints[sNumMidpoints-1];
+        BidiIterator currpoint = endpoint;
+        while (!currpoint.atEnd() && currpoint != startpoint && currpoint != lBreak)
+            currpoint.increment( bidi );
+        if (currpoint == lBreak) {
+            // We hit the line break before the start point.  Shave off the start point.
+            sNumMidpoints--;
+            if (endpoint.obj->style()->whiteSpace() != PRE)
+                endpoint.pos--;
+        }
+    }
+}
+
+static void addMidpoint(const BidiIterator& midpoint)
+{
+    if (!smidpoints)
+        return;
+
+    if (smidpoints->size() <= sNumMidpoints)
+        smidpoints->resize(sNumMidpoints+10);
+
+    BidiIterator* midpoints = smidpoints->data();
+    midpoints[sNumMidpoints++] = midpoint;
+}
+
+static void appendRunsForObject(int start, int end, RenderObject* obj, BidiState &bidi)
+{
+    if (start > end || obj->isFloating() ||
+        (obj->isPositioned() && !obj->hasStaticX() && !obj->hasStaticY()))
+        return;
+
+    bool haveNextMidpoint = (smidpoints && sCurrMidpoint < sNumMidpoints);
+    BidiIterator nextMidpoint;
+    if (haveNextMidpoint)
+        nextMidpoint = smidpoints->at(sCurrMidpoint);
+    if (betweenMidpoints) {
+        if (!(haveNextMidpoint && nextMidpoint.obj == obj))
+            return;
+        // This is a new start point. Stop ignoring objects and
+        // adjust our start.
+        betweenMidpoints = false;
+        start = nextMidpoint.pos;
+        sCurrMidpoint++;
+        if (start < end)
+            return appendRunsForObject(start, end, obj, bidi);
+    }
+    else {
+        if (!smidpoints || !haveNextMidpoint || (obj != nextMidpoint.obj)) {
+            addRun(new (obj->renderArena()) BidiRun(start, end, obj, bidi.context, dir));
+            return;
+        }
+
+        // An end midpoint has been encountered within our object.  We
+        // need to go ahead and append a run with our endpoint.
+        if (int(nextMidpoint.pos+1) <= end) {
+            betweenMidpoints = true;
+            sCurrMidpoint++;
+            if (nextMidpoint.pos != UINT_MAX) { // UINT_MAX means stop at the object and don't include any of it.
+                addRun(new (obj->renderArena())
+                    BidiRun(start, nextMidpoint.pos+1, obj, bidi.context, dir));
+                return appendRunsForObject(nextMidpoint.pos+1, end, obj, bidi);
+            }
+        }
+        else
+           addRun(new (obj->renderArena()) BidiRun(start, end, obj, bidi.context, dir));
+    }
+}
+
+static void appendRun( BidiState &bidi )
 {
     if ( emptyRun ) return;
 #if BIDI_DEBUG > 1
     kdDebug(6041) << "appendRun: dir="<<(int)dir<<endl;
 #endif
 
-    bool b = adjustEmbeddding;
-    adjustEmbeddding = false;
+    bool b = adjustEmbedding;
+    adjustEmbedding = false;
 
-    int start = sor.pos;
-    RenderObject *obj = sor.obj;
-    while( obj && obj != eor.obj ) {
-        if(!obj->isHidden()) {
-#if BIDI_DEBUG > 1
-            kdDebug(6041) << "appendRun: "<< start << "/" << obj->length() <<endl;
-#endif
-            sruns->append( new BidiRun(start, obj->length(), obj, context, dir) );
-        }
-        obj = Bidinext( sor.par, obj );
+    int start = bidi.sor.pos;
+    RenderObject *obj = bidi.sor.obj;
+    while( obj && obj != bidi.eor.obj ) {
+        appendRunsForObject(start, obj->length(), obj, bidi);
         start = 0;
+        obj = Bidinext( bidi.sor.par, obj, bidi );
     }
-    if( obj && !obj->isHidden()) {
-#if BIDI_DEBUG > 1
-        kdDebug(6041) << "appendRun: "<< start << "/" << eor.pos <<endl;
-#endif
-	//for text DOM::Nodes, if length() == 0, set the end of the bidiRun at 0. Needed for Quanta's VPL.
-	sruns->append( new BidiRun(start, (obj->length() ? eor.pos+1 : 0), obj, context, dir) );
-    }
+    if (obj)
+        appendRunsForObject(start, bidi.eor.pos+1, obj, bidi);
 
-    ++eor;
-    sor = eor;
+    bidi.eor.increment( bidi );
+    bidi.sor = bidi.eor;
     dir = QChar::DirON;
-    status.eor = QChar::DirON;
-    adjustEmbeddding = b;
+    bidi.status.eor = QChar::DirON;
+    adjustEmbedding = b;
 }
 
-static void embed( QChar::Direction d )
+static void embed( QChar::Direction d, BidiState &bidi )
 {
 #if BIDI_DEBUG > 1
     qDebug("*** embed dir=%d emptyrun=%d", d, emptyRun );
 #endif
-    bool b = adjustEmbeddding ;
-    adjustEmbeddding = false;
+    bool b = adjustEmbedding ;
+    adjustEmbedding = false;
     if ( d == QChar::DirPDF ) {
-	BidiContext *c = context->parent;
-	if(c && sruns) {
-	    if ( eor != last ) {
-		appendRun();
-		eor = last;
+	BidiContext *c = bidi.context->parent;
+	if (c) {
+	    if ( bidi.eor != bidi.last ) {
+		appendRun( bidi );
+		bidi.eor = bidi.last;
 	    }
-	    appendRun();
+	    appendRun( bidi );
 	    emptyRun = true;
-	    status.last = context->dir;
-	    context->deref();
-	    context = c;
-	    if(context->override)
-		dir = context->dir;
+	    bidi.status.last = bidi.context->dir;
+	    bidi.context->deref();
+	    bidi.context = c;
+	    if(bidi.context->override)
+		dir = bidi.context->dir;
 	    else
 		dir = QChar::DirON;
-	    status.lastStrong = context->dir;
+	    bidi.status.lastStrong = bidi.context->dir;
 	}
     } else {
 	QChar::Direction runDir;
@@ -418,7 +557,7 @@
 	else
 	    override = false;
 
-	unsigned char level = context->level;
+	unsigned char level = bidi.context->level;
 	if ( runDir == QChar::DirR ) {
 	    if(level%2) // we have an odd level
 		level += 2;
@@ -432,24 +571,22 @@
 	}
 
 	if(level < 61) {
-	    if ( sruns ) {
-		if ( eor != last ) {
-		    appendRun();
-		    eor = last;
-		}
-		appendRun();
-		emptyRun = true;
+	    if ( bidi.eor != bidi.last ) {
+                appendRun( bidi );
+                bidi.eor = bidi.last;
+            }
+            appendRun( bidi );
+            emptyRun = true;
 
-	    }
-	    context = new BidiContext(level, runDir, context, override);
-	    context->ref();
+	    bidi.context = new BidiContext(level, runDir, bidi.context, override);
+	    bidi.context->ref();
 	    if ( override )
 		dir = runDir;
-	    status.last = runDir;
-	    status.lastStrong = runDir;
+	    bidi.status.last = runDir;
+	    bidi.status.lastStrong = runDir;
 	}
     }
-    adjustEmbeddding = b;
+    adjustEmbedding = b;
 }
 
 InlineFlowBox* RenderBlock::createLineBoxes(RenderObject* obj)
@@ -468,6 +605,8 @@
     // as well.  In this situation our inline has actually been split in two on
     // the same line (this can happen with very fancy language mixtures).
     if (!box || box->isConstructed() || box->nextOnLine()) {
+        // We need to make a new box for this render object.  Once
+        // made, we need to place it at the end of the current line.
         InlineBox* newBox = obj->createInlineBox(false, obj == this);
         KHTMLAssert(newBox->isInlineFlowBox());
         box = static_cast<InlineFlowBox*>(newBox);
@@ -488,12 +627,11 @@
 
 InlineFlowBox* RenderBlock::constructLine(const BidiIterator &start, const BidiIterator &end)
 {
-    if (!sruns)
+    if (!sFirstBidiRun)
         return 0; // We had no runs. Don't make a root inline box at all. The line is empty.
 
     InlineFlowBox* parentBox = 0;
-    QPtrListIterator<BidiRun> it(*sruns);
-    for (BidiRun *r; (r = it.current()); ++it) {
+    for (BidiRun* r = sFirstBidiRun; r; r = r->nextRun) {
         // Create a box for our object.
         r->box = r->obj->createInlineBox(r->obj->isPositioned(), false);
 
@@ -529,12 +667,12 @@
     return lastLineBox();
 }
 
-void RenderBlock::computeHorizontalPositionsForLine(InlineFlowBox* lineBox, BidiContext* endEmbed)
+void RenderBlock::computeHorizontalPositionsForLine(InlineFlowBox* lineBox, BidiState &bidi)
 {
     // First determine our total width.
     int totWidth = lineBox->getFlowSpacingWidth();
-    QPtrListIterator<BidiRun> it(*sruns);
-    for (BidiRun *r; (r = it.current()); ++it) {
+    BidiRun* r = 0;
+    for (r = sFirstBidiRun; r; r = r->nextRun) {
         if (r->obj->isPositioned())
             continue; // Positioned objects are only participating to figure out their
                       // correct static x position.  They have no effect on the width.
@@ -543,13 +681,9 @@
         else if (!r->obj->isInlineFlow()) {
             r->obj->calcWidth();
             r->box->setWidth(r->obj->width());
-            if (r->obj->style()->display() != COMPACT)
-                totWidth += r->obj->marginLeft() + r->obj->marginRight();
+            totWidth += r->obj->marginLeft() + r->obj->marginRight();
         }
-
-        // Compacts don't contribute to the width of the line, since they are placed in the margin.
-        if (r->obj->style()->display() != COMPACT)
-            totWidth += r->box->width();
+        totWidth += r->box->width();
     }
 
     // Armed with the total width of the line (without justification),
@@ -560,23 +694,25 @@
     int availableWidth = lineWidth(m_height);
     switch(style()->textAlign()) {
         case LEFT:
+        case KHTML_LEFT:
             numSpaces = 0;
             break;
         case JUSTIFY:
-            if (numSpaces != 0 && !current.atEnd() && !current.obj->isBR() )
+            if (numSpaces != 0 && !bidi.current.atEnd() && !bidi.current.obj->isBR() )
                 break;
             // fall through
         case TAAUTO:
             numSpaces = 0;
             // for right to left fall through to right aligned
-            if (endEmbed->basicDir == QChar::DirL)
+            if (bidi.context->basicDir == QChar::DirL)
                 break;
         case RIGHT:
+        case KHTML_RIGHT:
             x += availableWidth - totWidth;
             numSpaces = 0;
             break;
         case CENTER:
-        case KONQ_CENTER:
+        case KHTML_CENTER:
             int xd = (availableWidth - totWidth)/2;
             x += xd >0 ? xd : 0;
             numSpaces = 0;
@@ -584,15 +720,16 @@
     }
 
     if (numSpaces > 0) {
-        QPtrListIterator<BidiRun> it(*sruns);
-        for (BidiRun *r; (r = it.current()); ++it) {
+        for (r = sFirstBidiRun; r; r = r->nextRun) {
             int spaceAdd = 0;
-            if (numSpaces > 0 && r->obj->isText() && r->obj->style()->display() != COMPACT) {
+            if (numSpaces > 0 && r->obj->isText()) {
                 // get the number of spaces in the run
                 int spaces = 0;
-                for ( int i = r->start; i < r->stop; i++ )
-                    if ( static_cast<RenderText *>(r->obj)->text()[i].category() == QChar::Separator_Space )
+                for ( int i = r->start; i < r->stop; i++ ) {
+                    const QChar c = static_cast<RenderText *>(r->obj)->text()[i];
+                    if (c.category() == QChar::Separator_Space || c == '\n')
                         spaces++;
+                }
 
                 KHTMLAssert(spaces <= numSpaces);
 
@@ -617,6 +754,7 @@
 void RenderBlock::computeVerticalPositionsForLine(InlineFlowBox* lineBox)
 {
     lineBox->verticallyAlignBoxes(m_height);
+//    lineBox->setBlockHeight(m_height);
 
     // See if the line spilled out.  If so set overflow height accordingly.
     int bottomOfLine = lineBox->bottomOverflow();
@@ -624,8 +762,7 @@
         m_overflowHeight = bottomOfLine;
 
     // Now make sure we place replaced render objects correctly.
-    QPtrListIterator<BidiRun> it(*sruns);
-    for (BidiRun *r; (r = it.current()); ++it) {
+    for (BidiRun* r = sFirstBidiRun; r; r = r->nextRun) {
         // Align positioned boxes with the top of the line box.  This is
         // a reasonable approximation of an appropriate y position.
         if (r->obj->isPositioned())
@@ -633,24 +770,28 @@
 
         // Position is used to properly position both replaced elements and
         // to update the static normal flow x/y of positioned elements.
-        // FIXME: update of static X/Y isn't merged, see RenderBox::position
         r->obj->position(r->box, r->start, r->stop - r->start, r->level%2);
     }
 }
 
 // collects one line of the paragraph and transforms it to visual order
-void RenderBlock::bidiReorderLine(const BidiIterator &start, const BidiIterator &end)
+void RenderBlock::bidiReorderLine(const BidiIterator &start, const BidiIterator &end, BidiState &bidi)
 {
     if ( start == end ) {
-	if ( start.current() == '\n' ) {
-	    m_height += lineHeight( m_firstLine );
-	}
-	return;
+        if ( start.current() == '\n' ) {
+            m_height += lineHeight( m_firstLine );
+        }
+        return;
     }
+
 #if BIDI_DEBUG > 1
     kdDebug(6041) << "reordering Line from " << start.obj << "/" << start.pos << " to " << end.obj << "/" << end.pos << endl;
 #endif
 
+    sFirstBidiRun = 0;
+    sLastBidiRun = 0;
+    sBidiRunCount = 0;
+
     //    context->ref();
 
     dir = QChar::DirON;
@@ -658,41 +799,29 @@
 
     numSpaces = 0;
 
-    current = start;
-    last = current;
+    bidi.current = start;
+    bidi.last = bidi.current;
     bool atEnd = false;
     while( 1 ) {
 
         QChar::Direction dirCurrent;
-        if(atEnd ) {
+        if (atEnd) {
             //kdDebug(6041) << "atEnd" << endl;
-            BidiContext *c = context;
-	    if ( current.atEnd())
-		while ( c->parent )
-		    c = c->parent;
+            BidiContext *c = bidi.context;
+            if ( bidi.current.atEnd())
+                while ( c->parent )
+                    c = c->parent;
             dirCurrent = c->dir;
         } else {
-            dirCurrent = current.direction();
-	}
+            dirCurrent = bidi.current.direction();
+        }
 
 #ifndef QT_NO_UNICODETABLES
 
-	if ( context->override &&
-	     dirCurrent != QChar::DirRLE &&
-	     dirCurrent != QChar::DirLRE &&
-	     dirCurrent != QChar::DirRLO &&
-	     dirCurrent != QChar::DirLRO &&
-	     dirCurrent != QChar::DirPDF ) {
-	    eor = current;
-	    goto skipbidi;
-	}
-
 #if BIDI_DEBUG > 1
-        kdDebug(6041) << "pos=" << current.pos << " sor=" << sor.pos << " directions: dir=" << dir << " current=" << dirCurrent
-                      << " last=" << status.last << " eor=" << eor.pos << "/" << status.eor
-                      << " lastStrong=" << status.lastStrong << " embedding=" << (int)context->dir
-                      << " level =" << (int)context->level << endl;
+        kdDebug(6041) << "directions: dir=" << (int)dir << " current=" << (int)dirCurrent << " last=" << status.last << " eor=" << status.eor << " lastStrong=" << status.lastStrong << " embedding=" << (int)context->dir << " level =" << (int)context->level << endl;
 #endif
+
         switch(dirCurrent) {
 
             // embedding and overrides (X1-X9 in the Bidi specs)
@@ -701,23 +830,23 @@
         case QChar::DirRLO:
         case QChar::DirLRO:
         case QChar::DirPDF:
-	    eor = last;
-	    embed( dirCurrent );
-	    break;
+            bidi.eor = bidi.last;
+            embed( dirCurrent, bidi );
+            break;
 
             // strong types
         case QChar::DirL:
             if(dir == QChar::DirON)
                 dir = QChar::DirL;
-            switch(status.last)
+            switch(bidi.status.last)
                 {
                 case QChar::DirL:
-                    eor = current; status.eor = QChar::DirL; break;
+                    bidi.eor = bidi.current; bidi.status.eor = QChar::DirL; break;
                 case QChar::DirR:
                 case QChar::DirAL:
                 case QChar::DirEN:
                 case QChar::DirAN:
-                    appendRun();
+                    appendRun( bidi );
                     break;
                 case QChar::DirES:
                 case QChar::DirET:
@@ -727,50 +856,49 @@
                 case QChar::DirS:
                 case QChar::DirWS:
                 case QChar::DirON:
-                    if(dir != QChar::DirL) {
+                     if( bidi.status.eor != QChar::DirL ) {
                         //last stuff takes embedding dir
-                        if( context->dir == QChar::DirR ) {
-                            if(!(status.eor == QChar::DirR)) {
-                                // AN or EN
-                                appendRun();
-                                dir = QChar::DirR;
-                            }
-                            else
-                                eor = last;
-                            appendRun();
-			    dir = QChar::DirL;
-			    status.eor = QChar::DirL;
+                        if(bidi.context->dir == QChar::DirL || bidi.status.lastStrong == QChar::DirL) {
+                            if ( bidi.status.eor != QChar::DirEN && bidi.status.eor != QChar::DirAN && bidi.status.eor != QChar::DirON )
+                                appendRun( bidi );
+                            dir = QChar::DirL;
+                            bidi.eor = bidi.current;
+                            bidi.status.eor = QChar::DirL;
                         } else {
-                            if(status.eor == QChar::DirR) {
-                                appendRun();
-                                dir = QChar::DirL;
-                            } else {
-                                eor = current; status.eor = QChar::DirL; break;
+                            if ( bidi.status.eor == QChar::DirEN || bidi.status.eor == QChar::DirAN )
+                            {
+                                dir = bidi.status.eor;
+                                appendRun( bidi );
                             }
+                            dir = QChar::DirR;
+                            bidi.eor = bidi.last;
+                            appendRun( bidi );
+                            dir = QChar::DirL;
+                            bidi.status.eor = QChar::DirL;
                         }
                     } else {
-                        eor = current; status.eor = QChar::DirL;
+                        bidi.eor = bidi.current; bidi.status.eor = QChar::DirL;
                     }
                 default:
                     break;
                 }
-            status.lastStrong = QChar::DirL;
+            bidi.status.lastStrong = QChar::DirL;
             break;
         case QChar::DirAL:
         case QChar::DirR:
             if(dir == QChar::DirON) dir = QChar::DirR;
-            switch(status.last)
+            switch(bidi.status.last)
                 {
                 case QChar::DirR:
                 case QChar::DirAL:
-                    eor = current; status.eor = QChar::DirR; break;
+                    bidi.eor = bidi.current; bidi.status.eor = QChar::DirR; break;
                 case QChar::DirL:
                 case QChar::DirEN:
                 case QChar::DirAN:
-                    appendRun();
+                    appendRun( bidi );
 		    dir = QChar::DirR;
-		    eor = current;
-		    status.eor = QChar::DirR;
+		    bidi.eor = bidi.current;
+		    bidi.status.eor = QChar::DirR;
                     break;
                 case QChar::DirES:
                 case QChar::DirET:
@@ -780,27 +908,28 @@
                 case QChar::DirS:
                 case QChar::DirWS:
                 case QChar::DirON:
-                    if( !(status.eor == QChar::DirR) && !(status.eor == QChar::DirAL) ) {
+                    if( !(bidi.status.eor == QChar::DirR) && !(bidi.status.eor == QChar::DirAL) ) {
                         //last stuff takes embedding dir
-                        if(context->dir == QChar::DirR
-                           || status.lastStrong == QChar::DirR || status.lastStrong == QChar::DirAL) {
-                            appendRun();
+                        if(bidi.context->dir == QChar::DirR || bidi.status.lastStrong == QChar::DirR
+                            || bidi.status.lastStrong == QChar::DirAL) {
+                            appendRun( bidi );
                             dir = QChar::DirR;
-                            eor = current;
-			    status.eor = QChar::DirR;
+                            bidi.eor = bidi.current;
+                            bidi.status.eor = QChar::DirR;
                         } else {
-                            eor = last;
-                            appendRun();
+                            dir = QChar::DirL;
+                            bidi.eor = bidi.last;
+                            appendRun( bidi );
                             dir = QChar::DirR;
-			    status.eor = QChar::DirR;
+                            bidi.status.eor = QChar::DirR;
                         }
                     } else {
-                        eor = current; status.eor = QChar::DirR;
+                        bidi.eor = bidi.current; bidi.status.eor = QChar::DirR;
                     }
                 default:
                     break;
                 }
-            status.lastStrong = dirCurrent;
+            bidi.status.lastStrong = dirCurrent;
             break;
 
             // weak types:
@@ -809,66 +938,62 @@
             // ### if @sor, set dir to dirSor
             break;
         case QChar::DirEN:
-            if(!(status.lastStrong == QChar::DirAL)) {
+            if(!(bidi.status.lastStrong == QChar::DirAL)) {
                 // if last strong was AL change EN to AN
                 if(dir == QChar::DirON) {
-                    if(status.lastStrong == QChar::DirAL)
-                        dir = QChar::DirAN;
-                    else
-                        dir = QChar::DirL;
+                    dir = QChar::DirL;
                 }
-                switch(status.last)
+                switch(bidi.status.last)
                     {
                     case QChar::DirET:
-			if ( status.lastStrong == QChar::DirR || status.lastStrong == QChar::DirAL ) {
-			    appendRun();
-			    dir = QChar::DirEN;
-			    status.eor = QChar::DirEN;
+			if ( bidi.status.lastStrong == QChar::DirR || bidi.status.lastStrong == QChar::DirAL ) {
+			    appendRun( bidi );
+                            dir = QChar::DirEN;
+                            bidi.status.eor = QChar::DirEN;
 			}
 			// fall through
                     case QChar::DirEN:
                     case QChar::DirL:
-                        eor = current;
-                        status.eor = dirCurrent;
+                        bidi.eor = bidi.current;
+                        bidi.status.eor = dirCurrent;
                         break;
                     case QChar::DirR:
                     case QChar::DirAL:
                     case QChar::DirAN:
-                        appendRun();
-			status.eor = QChar::DirEN;
-                        dir = QChar::DirEN;
-			break;
+                        appendRun( bidi );
+			bidi.status.eor = QChar::DirEN;
+                        dir = QChar::DirEN; break;
                     case QChar::DirES:
                     case QChar::DirCS:
-                        if(status.eor == QChar::DirEN) {
-                            eor = current; break;
+                        if(bidi.status.eor == QChar::DirEN) {
+                            bidi.eor = bidi.current; break;
                         }
                     case QChar::DirBN:
                     case QChar::DirB:
                     case QChar::DirS:
                     case QChar::DirWS:
                     case QChar::DirON:
-                        if(status.eor == QChar::DirR) {
+                        if(bidi.status.eor == QChar::DirR) {
                             // neutrals go to R
-                            eor = last;
-                            appendRun();
+                            bidi.eor = bidi.last;
+                            appendRun( bidi );
                             dir = QChar::DirEN;
-			    status.eor = QChar::DirEN;
+                            bidi.status.eor = QChar::DirEN;
                         }
-                        else if( status.eor == QChar::DirL ||
-                                 (status.eor == QChar::DirEN && status.lastStrong == QChar::DirL)) {
-                            eor = current; status.eor = dirCurrent;
+                        else if( bidi.status.eor == QChar::DirL ||
+                                 (bidi.status.eor == QChar::DirEN && bidi.status.lastStrong == QChar::DirL)) {
+                            bidi.eor = bidi.current; bidi.status.eor = dirCurrent;
                         } else {
                             // numbers on both sides, neutrals get right to left direction
                             if(dir != QChar::DirL) {
-                                appendRun();
-                                eor = last;
+                                appendRun( bidi );
+                                bidi.eor = bidi.last;
                                 dir = QChar::DirR;
-                                appendRun();
+                                appendRun( bidi );
                                 dir = QChar::DirEN;
-				status.eor = QChar::DirEN;
+                                bidi.status.eor = QChar::DirEN;
                             } else {
-                                eor = current; status.eor = dirCurrent;
+                                bidi.eor = bidi.current; bidi.status.eor = dirCurrent;
                             }
                         }
                     default:
@@ -879,20 +1004,20 @@
         case QChar::DirAN:
             dirCurrent = QChar::DirAN;
             if(dir == QChar::DirON) dir = QChar::DirAN;
-            switch(status.last)
+            switch(bidi.status.last)
                 {
                 case QChar::DirL:
                 case QChar::DirAN:
-                    eor = current; status.eor = QChar::DirAN; break;
+                    bidi.eor = bidi.current; bidi.status.eor = QChar::DirAN; break;
                 case QChar::DirR:
                 case QChar::DirAL:
                 case QChar::DirEN:
-                    appendRun();
-		    dir = QChar::DirAN; status.eor = QChar::DirAN;
+                    appendRun( bidi );
+                    dir = QChar::DirAN; bidi.status.eor = QChar::DirAN;
                     break;
                 case QChar::DirCS:
-                    if(status.eor == QChar::DirAN) {
-                        eor = current; break;
+                    if(bidi.status.eor == QChar::DirAN) {
+                        bidi.eor = bidi.current; bidi.status.eor = QChar::DirR; break;
                     }
                 case QChar::DirES:
                 case QChar::DirET:
@@ -901,26 +1026,26 @@
                 case QChar::DirS:
                 case QChar::DirWS:
                 case QChar::DirON:
-                    if(status.eor == QChar::DirR) {
+                    if(bidi.status.eor == QChar::DirR) {
                         // neutrals go to R
-                        eor = last;
-                        appendRun();
+                        bidi.eor = bidi.last;
+                        appendRun( bidi );
                         dir = QChar::DirAN;
-			status.eor = QChar::DirAN;
-                    } else if( status.eor == QChar::DirL ||
-                               (status.eor == QChar::DirEN && status.lastStrong == QChar::DirL)) {
-                        eor = current; status.eor = dirCurrent;
+                        bidi.status.eor = QChar::DirAN;
+                    } else if( bidi.status.eor == QChar::DirL ||
+                               (bidi.status.eor == QChar::DirEN && bidi.status.lastStrong == QChar::DirL)) {
+                        bidi.eor = bidi.current; bidi.status.eor = dirCurrent;
                     } else {
                         // numbers on both sides, neutrals get right to left direction
                         if(dir != QChar::DirL) {
-                            appendRun();
-                            eor = last;
+                            appendRun( bidi );
+                            bidi.eor = bidi.last;
                             dir = QChar::DirR;
-                            appendRun();
+                            appendRun( bidi );
                             dir = QChar::DirAN;
-			    status.eor = QChar::DirAN;
+                            bidi.status.eor = QChar::DirAN;
                         } else {
-                            eor = current; status.eor = dirCurrent;
+                            bidi.eor = bidi.current; bidi.status.eor = dirCurrent;
                         }
                     }
                 default:
@@ -931,9 +1056,9 @@
         case QChar::DirCS:
             break;
         case QChar::DirET:
-            if(status.last == QChar::DirEN) {
+            if(bidi.status.last == QChar::DirEN) {
                 dirCurrent = QChar::DirEN;
-                eor = current; status.eor = dirCurrent;
+                bidi.eor = bidi.current; bidi.status.eor = dirCurrent;
                 break;
             }
             break;
@@ -949,22 +1074,16 @@
             // ### implement rule L1
             break;
         case QChar::DirWS:
+            break;
         case QChar::DirON:
             break;
         default:
             break;
         }
 
-    // we can't rely on the direction to count spaces (we want also nbsp's...)
-    // check the Zs category instead (see http://www.unicode.org/Public/UNIDATA/PropList.txt)
-    if(current.current().category() == QChar::Separator_Space && current.direction() != QChar::DirON && !(current == end))
-        numSpaces++;
-
-    skipbidi:
         //cout << "     after: dir=" << //        dir << " current=" << dirCurrent << " last=" << status.last << " eor=" << status.eor << " lastStrong=" << status.lastStrong << " embedding=" << context->dir << endl;
 
-        if(current.atEnd())
-	    break;
+        if(bidi.current.atEnd()) break;
 
         // set status.last as needed.
         switch(dirCurrent)
@@ -975,50 +1094,49 @@
             case QChar::DirS:
             case QChar::DirWS:
             case QChar::DirON:
-                switch(status.last)
+                switch(bidi.status.last)
                     {
                     case QChar::DirL:
                     case QChar::DirR:
                     case QChar::DirAL:
                     case QChar::DirEN:
                     case QChar::DirAN:
-                        status.last = dirCurrent;
+                        bidi.status.last = dirCurrent;
                         break;
                     default:
-                        status.last = QChar::DirON;
+                        bidi.status.last = QChar::DirON;
                     }
                 break;
             case QChar::DirNSM:
             case QChar::DirBN:
                 // ignore these
                 break;
-	    case QChar::DirEN:
-		if ( status.last == QChar::DirL ) {
-		    status.last = QChar::DirL;
-		    break;
-		}
-		// fall through
+            case QChar::DirEN:
+                if ( bidi.status.last == QChar::DirL ) {
+                    break;
+                }
+                // fall through
             default:
-                status.last = dirCurrent;
+                bidi.status.last = dirCurrent;
             }
 #endif
 
 	if ( atEnd ) break;
-        last = current;
+        bidi.last = bidi.current;
 
 	if ( emptyRun ) {
-	    sor = current;
-	    eor = current;
+	    bidi.sor = bidi.current;
+	    bidi.eor = bidi.current;
 	    emptyRun = false;
 	}
 
 	// this causes the operator ++ to open and close embedding levels as needed
 	// for the CSS unicode-bidi property
-	adjustEmbeddding = true;
-        ++current;
-	adjustEmbeddding = false;
+	adjustEmbedding = true;
+        bidi.current.increment( bidi );
+	adjustEmbedding = false;
 
-	if ( current == end ) {
+	if ( bidi.current == end ) {
 	    if ( emptyRun )
 		break;
 	    atEnd = true;
@@ -1029,30 +1147,23 @@
     kdDebug(6041) << "reached end of line current=" << current.obj << "/" << current.pos
 		  << ", eor=" << eor.obj << "/" << eor.pos << endl;
 #endif
-    if ( !emptyRun && sor != current ) {
-	    eor = last;
-	    appendRun();
+    if ( !emptyRun && bidi.sor != bidi.current ) {
+	    bidi.eor = bidi.last;
+	    appendRun( bidi );
     }
 
-    BidiContext *endEmbed = context;
-    // both commands below together give a noop...
-    //endEmbed->ref();
-    //context->deref();
-
     // reorder line according to run structure...
 
     // first find highest and lowest levels
     uchar levelLow = 128;
     uchar levelHigh = 0;
-    BidiRun *r = sruns->first();
-
+    BidiRun *r = sFirstBidiRun;
     while ( r ) {
-        //paintf("level = %d\n", r->level);
         if ( r->level > levelHigh )
             levelHigh = r->level;
         if ( r->level < levelLow )
             levelLow = r->level;
-        r = sruns->next();
+        r = r->nextRun;
     }
 
     // implements reordering of the line (L2 according to Bidi spec):
@@ -1065,36 +1176,31 @@
 #if BIDI_DEBUG > 0
     kdDebug(6041) << "lineLow = " << (uint)levelLow << ", lineHigh = " << (uint)levelHigh << endl;
     kdDebug(6041) << "logical order is:" << endl;
-    QPtrListIterator<BidiRun> it2(*sruns);
+    QPtrListIterator<BidiRun> it2(runs);
     BidiRun *r2;
     for ( ; (r2 = it2.current()); ++it2 )
         kdDebug(6041) << "    " << r2 << "  start=" << r2->start << "  stop=" << r2->stop << "  level=" << (uint)r2->level << endl;
 #endif
 
-    int count = sruns->count() - 1;
+    int count = sBidiRunCount - 1;
 
     // do not reverse for visually ordered web sites
     if(!style()->visuallyOrdered()) {
         while(levelHigh >= levelLow) {
             int i = 0;
+            BidiRun* currRun = sFirstBidiRun;
             while ( i < count ) {
-                while(i < count && sruns->at(i)->level < levelHigh)
+                while(i < count && currRun && currRun->level < levelHigh) {
                     i++;
+                    currRun = currRun->nextRun;
+                }
                 int start = i;
-                while(i <= count && sruns->at(i)->level >= levelHigh)
+                while(i <= count && currRun && currRun->level >= levelHigh) {
                     i++;
-                int end = i-1;
-
-                if(start != end) {
-                    //kdDebug(6041) << "reversing from " << start << " to " << end << endl;
-                    for(int j = 0; j < (end-start+1)/2; j++)
-                        {
-                            BidiRun *first = sruns->take(start+j);
-                            BidiRun *last = sruns->take(end-j-1);
-                            sruns->insert(start+j, last);
-                            sruns->insert(end-j, first);
-                        }
+                    currRun = currRun->nextRun;
                 }
+                int end = i-1;
+                reverseRuns(start, end);
                 i++;
                 if(i >= count) break;
             }
@@ -1104,17 +1210,54 @@
 
 #if BIDI_DEBUG > 0
     kdDebug(6041) << "visual order is:" << endl;
-    QPtrListIterator<BidiRun> it3(*sruns);
-    BidiRun *r3;
-    for ( ; (r3 = it3.current()); ++it3 )
-    {
-        kdDebug(6041) << "    " << r3 << endl;
-    }
+    for (BidiRun* curr = sFirstRun; curr; curr = curr->nextRun)
+        kdDebug(6041) << "    " << curr << endl;
 #endif
 }
 
-void RenderBlock::layoutInlineChildren( bool relayoutChildren )
+#ifdef APPLE_CHANGES    // KDE handles compact blocks differently
+static void buildCompactRuns(RenderObject* compactObj, BidiState &bidi)
+{
+    sBuildingCompactRuns = true;
+    if (!compactObj->isRenderBlock()) {
+        // Just append a run for our object.
+        isLineEmpty = false;
+        addRun(new (compactObj->renderArena()) BidiRun(0, compactObj->length(), compactObj, bidi.context, dir));
+    }
+    else {
+        // Format the compact like it is its own single line.  We build up all the runs for
+        // the little compact and then reorder them for bidi.
+        RenderBlock* compactBlock = static_cast<RenderBlock*>(compactObj);
+        adjustEmbedding = true;
+        BidiIterator start(compactBlock, first(compactBlock, bidi), 0);
+        adjustEmbedding = false;
+        BidiIterator end = start;
+
+        betweenMidpoints = false;
+        isLineEmpty = true;
+        previousLineBrokeAtBR = true;
+
+        end = compactBlock->findNextLineBreak(start, bidi);
+        if (!isLineEmpty)
+            compactBlock->bidiReorderLine(start, end, bidi);
+    }
+
+
+    sCompactFirstBidiRun = sFirstBidiRun;
+    sCompactLastBidiRun = sLastBidiRun;
+    sCompactBidiRunCount = sBidiRunCount;
+
+    sNumMidpoints = 0;
+    sCurrMidpoint = 0;
+    betweenMidpoints = false;
+    sBuildingCompactRuns = false;
+}
+#endif
+
+void RenderBlock::layoutInlineChildren(bool relayoutChildren)
 {
+    BidiState bidi;
+
     m_overflowHeight = 0;
 
     invalidateVerticalPositions();
@@ -1126,20 +1269,18 @@
 #if BIDI_DEBUG > 1 || defined( DEBUG_LINEBREAKS )
     kdDebug(6041) << " ------- bidi start " << this << " -------" << endl;
 #endif
-    int toAdd = borderBottom();
-    m_height = borderTop();
-
-    emptyRun = true;
 
-    m_height += paddingTop();
-    toAdd += paddingBottom();
+    m_height = borderTop() + paddingTop();
+    int toAdd = borderBottom() + paddingBottom();
+    if (m_layer && style()->scrollsOverflow() && style()->height().isVariable())
+        toAdd += m_layer->horizontalScrollbarHeight();
 
     // Clear out our line boxes.
     deleteInlineBoxes();
 
-    if(firstChild()) {
+    if (firstChild()) {
         // layout replaced elements
-        RenderObject *o = first( this, false /*skipInlines*/ );
+        RenderObject *o = first( this, bidi, false );
         while ( o ) {
             if (o->isReplaced() || o->isFloating() || o->isPositioned()) {
                 // clear the placeHolderBox
@@ -1148,87 +1289,122 @@
 
                 //kdDebug(6041) << "layouting replaced or floating child" << endl;
                 if (relayoutChildren || o->style()->width().isPercent() || o->style()->height().isPercent())
-                    o->setLayouted(false);
-                if( !o->layouted() )
-                    o->layout();
-                if ( o->isPositioned() )
-                    o->containingBlock()->insertPositionedObject(  o );
-            } else {
-               o->deleteInlineBoxes();
+                    o->setChildNeedsLayout(true, false);
+                if (o->isPositioned())
+                    o->containingBlock()->insertPositionedObject(o);
+                else
+                    o->layoutIfNeeded();
             }
-            o = Bidinext( this, o, false /*skipInlines*/ );
+            else {
+                o->deleteInlineBoxes();
+                o->setNeedsLayout(false);
+            }
+            o = Bidinext( this, o, bidi, false );
         }
 
         BidiContext *startEmbed;
-        status = BidiStatus();
         if( style()->direction() == LTR ) {
             startEmbed = new BidiContext( 0, QChar::DirL );
-            status.eor = QChar::DirL;
+            bidi.status.eor = QChar::DirL;
         } else {
             startEmbed = new BidiContext( 1, QChar::DirR );
-            status.eor = QChar::DirR;
+            bidi.status.eor = QChar::DirR;
         }
         startEmbed->ref();
 
-        context = startEmbed;
-	adjustEmbeddding = true;
-        BidiIterator start(this);
-	adjustEmbeddding = false;
-        BidiIterator end(this);
+	bidi.status.lastStrong = QChar::DirON;
+	bidi.status.last = QChar::DirON;
+
+        bidi.context = startEmbed;
+        adjustEmbedding = true;
+        BidiIterator start(this, first(this, bidi), 0);
+        adjustEmbedding = false;
+        BidiIterator end = start;
 
         m_firstLine = true;
-        while( !end.atEnd() ) {
-            QPtrList<BidiRun> runs;
-            runs.setAutoDelete(true);
-            sruns = &runs;
 
-            start = end;
+        if (!smidpoints)
+            smidpoints = new QMemArray<BidiIterator>;
 
-            end = findNextLineBreak(start);
+        sNumMidpoints = 0;
+        sCurrMidpoint = 0;
+        sCompactFirstBidiRun = sCompactLastBidiRun = 0;
+        sCompactBidiRunCount = 0;
+
+        previousLineBrokeAtBR = true;
+
+        while( !end.atEnd() ) {
+            start = end;
+            betweenMidpoints = false;
+            isLineEmpty = true;
+#ifdef APPLE_CHANGES    // KDE handles compact blocks differently
+            if (m_firstLine && firstChild() && firstChild()->isCompact()) {
+                buildCompactRuns(firstChild(), bidi);
+                start.obj = firstChild()->nextSibling();
+                end = start;
+            }
+#endif
+            end = findNextLineBreak(start, bidi);
             if( start.atEnd() ) break;
-	    bidiReorderLine(start, end);
+            if (!isLineEmpty) {
+                bidiReorderLine(start, end, bidi);
+
+                // Now that the runs have been ordered, we create the line boxes.
+                // At the same time we figure out where border/padding/margin should be applied for
+                // inline flow boxes.
+                if (sCompactFirstBidiRun) {
+                    // We have a compact line sharing this line.  Link the compact runs
+                    // to our runs to create a single line of runs.
+                    sCompactLastBidiRun->nextRun = sFirstBidiRun;
+                    sFirstBidiRun = sCompactFirstBidiRun;
+                    sBidiRunCount += sCompactBidiRunCount;
+                }
 
-	    {
-                if (sruns && sruns->count() > 0) {
+                if (sBidiRunCount) {
                     InlineFlowBox* lineBox = constructLine(start, end);
                     if (lineBox) {
-                        // Now we position all of our text boxes horizontally.
-                        computeHorizontalPositionsForLine(lineBox, context);
+                        // Now we position all of our text runs horizontally.
+                        computeHorizontalPositionsForLine(lineBox, bidi);
 
-                        // Now position our text boxes vertically.
-			computeVerticalPositionsForLine(lineBox);
+                        // Now position our text runs vertically.
+                        computeVerticalPositionsForLine(lineBox);
 
-			// FIXME: needs porting of sruns to s*BidiRun stuff
-                        //deleteBidiRuns(renderArena());
+                        deleteBidiRuns(renderArena());
                     }
                 }
-	    }
 
-            if( end == start || (end.obj && end.obj->isBR() && !start.obj->isBR() ) ) {
-		adjustEmbeddding = true;
-                ++end;
-		adjustEmbeddding = false;
-	    } else if(m_pre && end.current() == QChar('\n') ) {
-		adjustEmbeddding = true;
-                ++end;
-		adjustEmbeddding = false;
-            }
-
-            newLine();
-            m_firstLine = false;
-        }
-	sruns = 0;
-
-	// clean up
-	while ( context ) {
-	    BidiContext *parent = context->parent;
-	    delete context;
-	    context = parent;
-	}
+                if( end == start || (end.obj && end.obj->isBR() && !start.obj->isBR() ) ) {
+                    adjustEmbedding = true;
+                    end.increment(bidi);
+                    adjustEmbedding = false;
+                } else if (end.obj && end.obj->style()->whiteSpace() == PRE && end.current() == QChar('\n')) {
+                    adjustEmbedding = true;
+                    end.increment(bidi);
+                    adjustEmbedding = false;
+                }
+
+                m_firstLine = false;
+                newLine();
+            }
+
+            sNumMidpoints = 0;
+            sCurrMidpoint = 0;
+            sCompactFirstBidiRun = sCompactLastBidiRun = 0;
+            sCompactBidiRunCount = 0;
+        }
+        startEmbed->deref();
+        //embed->deref();
     }
+
+    sNumMidpoints = 0;
+    sCurrMidpoint = 0;
+
     // in case we have a float on the last line, it might not be positioned up to now.
+    // This has to be done before adding in the bottom border/padding, or the float will
+    // include the padding incorrectly. -dwh
     positionNewFloats();
 
+    // Now add in the bottom border/padding.
     m_height += toAdd;
 
     // Always make sure this is at least our height.
@@ -1242,20 +1418,20 @@
     //kdDebug(6040) << "height = " << m_height <<endl;
 }
 
-BidiIterator RenderBlock::findNextLineBreak(BidiIterator &start)
+BidiIterator RenderBlock::findNextLineBreak(BidiIterator &start, BidiState &bidi)
 {
     int width = lineWidth(m_height);
     int w = 0;
     int tmpW = 0;
 #ifdef DEBUG_LINEBREAKS
-    kdDebug(6041) << "RenderFlow::findNextLineBreak: " << this << endl;
     kdDebug(6041) << "findNextLineBreak: line at " << m_height << " line width " << width << endl;
     kdDebug(6041) << "sol: " << start.obj << " " << start.pos << endl;
 #endif
 
-
-    // remove leading spaces
-    while(!start.atEnd() && ( start.obj->isInlineFlow() || ( start.obj->style()->whiteSpace() != PRE &&
+    // eliminate spaces at beginning of line
+    // remove leading spaces.  Any inline flows we encounter will be empty and should also
+    // be skipped.
+    while (!start.atEnd() && (start.obj->isInlineFlow() || (start.obj->style()->whiteSpace() != PRE && !start.obj->isBR() &&
 #ifndef QT_NO_UNICODETABLES
         ( (start.current().unicode() == (ushort)0x0020) || // ASCII space
           (start.current().unicode() == (ushort)0x0009) || // ASCII tab
@@ -1263,33 +1439,46 @@
           (start.current().unicode() == (ushort)0x200B) || // Zero-width space
           start.obj->isFloatingOrPositioned() )
 #else
-	      ( start.current() == ' ' || start.obj->isFloatingOrPositioned() )
+	      ( start.current() == ' ' || start.current() == '\n' || start.obj->isFloatingOrPositioned() )
 #endif
-          ))) {
-        RenderObject *o = start.obj;
-        // add to floating objects...
-        if(o->isFloating()) {
-            insertFloatingObject(o);
-            positionNewFloats();
-            width = lineWidth(m_height);
-        }
-        else if (o->isPositioned()) {
-            if (o->hasStaticX())
-                static_cast<RenderBox*>(o)->setStaticX(style()->direction() == LTR ?
-                              borderLeft()+paddingLeft() :
-                              borderRight()+paddingRight());
-            if (o->hasStaticY())
-                static_cast<RenderBox*>(o)->setStaticY(m_height);
-        }
-
-        adjustEmbeddding = true;
-        ++start;
-        adjustEmbeddding = false;
+            ))) {
+        if( start.obj->isFloatingOrPositioned() ) {
+            RenderObject *o = start.obj;
+            // add to special objects...
+            if (o->isFloating()) {
+                insertFloatingObject(o);
+                positionNewFloats();
+                width = lineWidth(m_height);
+            }
+            else if (o->isBox() && o->isPositioned()) {
+                if (o->hasStaticX())
+                    static_cast<RenderBox*>(o)->setStaticX(style()->direction() == LTR ?
+                                  borderLeft()+paddingLeft() :
+                                  borderRight()+paddingRight());
+                if (o->hasStaticY())
+                    static_cast<RenderBox*>(o)->setStaticY(m_height);
+            }
+        }
+
+        adjustEmbedding = true;
+        start.increment(bidi);
+        adjustEmbedding = false;
     }
-    if ( start.atEnd() )
+
+    if ( start.atEnd() ){
         return start;
+    }
 
+    // This variable is used only if whitespace isn't set to PRE, and it tells us whether
+    // or not we are currently ignoring whitespace.
+    bool ignoringSpaces = false;
+    BidiIterator ignoreStart;
+
+    // This variable tracks whether the very last character we saw was a space.  We use
+    // this to detect when we encounter a second space so we know we have to terminate
+    // a run.
     bool currentCharacterIsSpace = false;
+    RenderObject* trailingSpaceObject = 0;
 
     BidiIterator lBreak = start;
 
@@ -1297,106 +1486,81 @@
     RenderObject *last = o;
     int pos = start.pos;
 
+    bool prevLineBrokeCleanly = previousLineBrokeAtBR;
+    previousLineBrokeAtBR = false;
+
     while( o ) {
 #ifdef DEBUG_LINEBREAKS
-        kdDebug(6041) << "new "<< o->renderName() << "@"<< o <<" width = " << w <<" tmpw = " << tmpW << endl;
+        kdDebug(6041) << "new object "<< o <<" width = " << w <<" tmpw = " << tmpW << endl;
 #endif
         if(o->isBR()) {
             if( w + tmpW <= width ) {
-                lBreak = o;
-                //check the clear status
-                m_clearStatus =  (EClear) (m_clearStatus | o->style()->clear());
+                lBreak.obj = o;
+                lBreak.pos = 0;
+//                lBreak.increment(bidi);
+
+                // A <br> always breaks a line, so don't let the line be collapsed
+                // away. Also, the space at the end of a line with a <br> does not
+                // get collapsed away.  It only does this if the previous line broke
+                // cleanly.  Otherwise the <br> has no effect on whether the line is
+                // empty or not.
+                if (prevLineBrokeCleanly)
+                    isLineEmpty = false;
+                trailingSpaceObject = 0;
+                previousLineBrokeAtBR = true;
+
+                if (!isLineEmpty) {
+                    // only check the clear status for non-empty lines.
+                    EClear clear = o->style()->clear();
+                    if(clear != CNONE)
+                        m_clearStatus = (EClear) (m_clearStatus | clear);
+                }
             }
             goto end;
-        } else if(o->isFloating()) {
-            insertFloatingObject(o);
-            // check if it fits in the current line.
-            // If it does, position it now, otherwise, position
-            // it after moving to next line (in newLine() func)
-            if (o->width()+o->marginLeft()+o->marginRight()+w+tmpW <= width) {
-                positionNewFloats();
-                width = lineWidth(m_height);
+        }
+        if( o->isFloatingOrPositioned() ) {
+            // add to special objects...
+            if(o->isFloating()) {
+                insertFloatingObject(o);
+                // check if it fits in the current line.
+                // If it does, position it now, otherwise, position
+                // it after moving to next line (in newLine() func)
+                if (o->width()+o->marginLeft()+o->marginRight()+w+tmpW <= width) {
+                    positionNewFloats();
+                    width = lineWidth(m_height);
+                }
             }
-        } else if(o->isPositioned()) {
-            // ignore
-        } else if ( o->isText() ) {
-	    RenderText *t = static_cast<RenderText *>(o);
-	    int strlen = t->stringLength();
-	    int len = strlen - pos;
-	    QChar *str = t->text();
-            bool appliedStartWidth = ( pos > 0 );
-
-            if (style()->whiteSpace() == NOWRAP || t->style()->whiteSpace() == NOWRAP) {
-                tmpW += t->maxWidth();
-                pos = strlen;
-                len = 0;
-            } else {
-                const Font *f = t->htmlFont( m_firstLine );
-                // proportional font, needs a bit more work.
-                int lastSpace = pos;
-                bool isPre = style()->whiteSpace() == PRE;
-
-                while(len) {
-                    currentCharacterIsSpace = str[pos] == ' ' || (!isPre && str[pos] == '\n');
-                    if( (isPre && str[pos] == '\n') ||
-                        (!isPre && isBreakable( str, pos, strlen ) ) ) {
-
-                        tmpW += t->width(lastSpace, pos - lastSpace, f);
-
-                        if ( !appliedStartWidth ) {
-                            tmpW += inlineWidth( o, true, false );
-                            appliedStartWidth = true;
-                        }
-#ifdef DEBUG_LINEBREAKS
-                        kdDebug(6041) << "found space: '" << QString( str, pos ).latin1() << "' +" << tmpW << " -> w = " << w << endl;
-#endif
-                        if ( !isPre && w + tmpW > width && w == 0 ) {
-                            int fb = nearestFloatBottom(m_height);
-                            int newLineWidth = lineWidth(fb);
-                            int lastFloatBottom = m_height;
-                            while ( lastFloatBottom < fb && tmpW > newLineWidth ) {
-                                lastFloatBottom = fb;
-                                fb = nearestFloatBottom( fb );
-                                newLineWidth = lineWidth( fb );
-                            }
-
-                            if(!w && m_height < fb && width < newLineWidth) {
-                                m_height = fb;
-                                width = newLineWidth;
-#ifdef DEBUG_LINEBREAKS
-                                kdDebug() << "RenderBlock::findNextLineBreak new position at " << m_height << " newWidth " << width << endl;
-#endif
-                            }
-                        }
-
-                        if ( w + tmpW > width && o->style()->whiteSpace() == NORMAL )
-                            goto end;
-
-                        if ( isPre && str[pos] == '\n' ) {
-                            lBreak.obj = o;
-                            lBreak.pos = pos;
-                            return lBreak;
-                        }
+            else if (o->isPositioned()) {
+                // If our original display wasn't an inline type, then we can
+                // go ahead and determine our static x position now.
+                bool isInlineType = o->style()->isOriginalDisplayInlineType();
+                bool needToSetStaticX = o->hasStaticX();
+                if (o->hasStaticX() && !isInlineType && o->isBox()) {
+                    static_cast<RenderBox*>(o)->setStaticX(o->parent()->style()->direction() == LTR ?
+                                  borderLeft()+paddingLeft() :
+                                  borderRight()+paddingRight());
+                    needToSetStaticX = false;
+                }
 
-                        if ( o->style()->whiteSpace() == NORMAL ) {
-                            w += tmpW;
-                            tmpW = 0;
-                            lBreak.obj = o;
-                            lBreak.pos = pos;
-                        }
+                // If our original display was an INLINE type, then we can go ahead
+                // and determine our static y position now.
+                bool needToSetStaticY = o->hasStaticY();
+                if (o->hasStaticY() && isInlineType && o->isBox()) {
+                    static_cast<RenderBox*>(o)->setStaticY(m_height);
+                    needToSetStaticY = false;
+                }
 
-                        lastSpace = pos;
+                // If we're ignoring spaces, we have to stop and include this object and
+                // then start ignoring spaces again.
+                if (needToSetStaticX || needToSetStaticY) {
+                    trailingSpaceObject = 0;
+                    ignoreStart.obj = o;
+                    ignoreStart.pos = 0;
+                    if (ignoringSpaces) {
+                        addMidpoint(ignoreStart); // Stop ignoring spaces.
+                        addMidpoint(ignoreStart); // Start ignoring again.
                     }
-                    pos++;
-                    len--;
                 }
-                // IMPORTANT: pos is > length here!
-                tmpW += t->width(lastSpace, pos - lastSpace, f);
-                if ( !appliedStartWidth )
-                    tmpW += inlineWidth(o, true, false );
-                tmpW += inlineWidth(o, false, true );
-                if (!isPre && w + tmpW < width && pos && str[pos-1] != nbsp)
-                    lBreak =  Bidinext( start.par, o );
             }
         } else if (o->isInlineFlow()) {
             // Only empty inlines matter.  We treat those similarly to replaced elements.
@@ -1421,18 +1585,193 @@
             // like characters in a word, and require spaces between the replaced elements in order
             // to break.
             if (currWS == NORMAL || lastWS == NORMAL) {
-                 w += tmpW;
-                 tmpW = 0;
-                 lBreak = o;
-             }
+                w += tmpW;
+                tmpW = 0;
+                lBreak.obj = o;
+                lBreak.pos = 0;
+            }
+
+            tmpW += o->width()+o->marginLeft()+o->marginRight()+inlineWidth(o);
+            if (ignoringSpaces) {
+                BidiIterator startMid( 0, o, 0 );
+                addMidpoint(startMid);
+            }
+            isLineEmpty = false;
+            ignoringSpaces = false;
+            currentCharacterIsSpace = false;
+            trailingSpaceObject = 0;
+
+            if (o->isListMarker() && o->style()->listStylePosition() == OUTSIDE) {
+                // The marker must not have an effect on whitespace at the start
+                // of the line.  We start ignoring spaces to make sure that any additional
+                // spaces we see will be discarded.
+                //
+                // Optimize for a common case. If we can't find whitespace after the list
+                // item, then this is all moot. -dwh
+                RenderObject* next = Bidinext( start.par, o, bidi );
+                if (!m_pre && next && next->isText() && static_cast<RenderText*>(next)->stringLength() > 0 &&
+                     (static_cast<RenderText*>(next)->text()[0].category() == QChar::Separator_Space ||
+                      static_cast<RenderText*>(next)->text()[0] == '\n')) {
+                    currentCharacterIsSpace = true;
+                    ignoringSpaces = true;
+                    BidiIterator endMid( 0, o, 0 );
+                    addMidpoint(endMid);
+                }
+            }
+        } else if ( o->isText() ) {
+            RenderText *t = static_cast<RenderText *>(o);
+            int strlen = t->stringLength();
+            int len = strlen - pos;
+            QChar *str = t->text();
+
+            const Font *f = t->htmlFont( m_firstLine );
+            // proportional font, needs a bit more work.
+            int lastSpace = pos;
+            bool isPre = o->style()->whiteSpace() == PRE;
+#ifdef APPLE_CHANGES
+            int wordSpacing = o->style()->wordSpacing();
+#endif
+            bool appliedStartWidth = pos > 0; // If the span originated on a previous line,
+                                              // then assume the start width has been applied.
+            bool appliedEndWidth = false;
+
+            while(len) {
+                bool previousCharacterIsSpace = currentCharacterIsSpace;
+                const QChar c = str[pos];
+                currentCharacterIsSpace = c == ' ' || (!isPre && c == '\n');
+
+                if (isPre || !currentCharacterIsSpace)
+                    isLineEmpty = false;
+
+#ifdef APPLE_CHANGES    // KDE applies wordspacing differently
+                bool applyWordSpacing = false;
+#endif
+                if ( (isPre && c == '\n') || (!isPre && isBreakable( str, pos, strlen )) ) {
+                    if (ignoringSpaces) {
+                        if (!currentCharacterIsSpace) {
+                            // Stop ignoring spaces and begin at this
+                            // new point.
+                            ignoringSpaces = false;
+                            lastSpace = pos; // e.g., "Foo    goo", don't add in any of the ignored spaces.
+                            BidiIterator startMid ( 0, o, pos );
+                            addMidpoint(startMid);
+                        }
+                        else {
+                            // Just keep ignoring these spaces.
+                            pos++;
+                            len--;
+                            continue;
+                        }
+                    }
+
+                    tmpW += t->width(lastSpace, pos - lastSpace, f);
+                    if (!appliedStartWidth) {
+                        tmpW += inlineWidth(o, true, false);
+                        appliedStartWidth = true;
+                    }
+#ifdef APPLE_CHANGES
+                    applyWordSpacing = (wordSpacing && currentCharacterIsSpace && !previousCharacterIsSpace &&
+                        !t->containsOnlyWhitespace(pos+1, strlen-(pos+1)));
+#endif
+#ifdef DEBUG_LINEBREAKS
+                    kdDebug(6041) << "found space at " << pos << " in string '" << QString( str, strlen ).latin1() << "' adding " << tmpW << " new width = " << w << endl;
+#endif
+                    if ( !isPre && w + tmpW > width && w == 0 ) {
+                        int fb = nearestFloatBottom(m_height);
+                        int newLineWidth = lineWidth(fb);
+                        // See if |tmpW| will fit on the new line.  As long as it does not,
+                        // keep adjusting our float bottom until we find some room.
+                        int lastFloatBottom = m_height;
+                        while (lastFloatBottom < fb && tmpW > newLineWidth) {
+                            lastFloatBottom = fb;
+                            fb = nearestFloatBottom(fb);
+                            newLineWidth = lineWidth(fb);
+                        }
+
+                        if(!w && m_height < fb && width < newLineWidth) {
+                            m_height = fb;
+                            width = newLineWidth;
+#ifdef DEBUG_LINEBREAKS
+                            kdDebug() << "RenderBlock::findNextLineBreak new position at " << m_height << " newWidth " << width << endl;
+#endif
+                        }
+                    }
+
+                    if (w + tmpW > width && o->style()->whiteSpace() == NORMAL) {
+                        goto end;
+                    }
+
+                    if( *(str+pos) == '\n' && isPre) {
+                        lBreak.obj = o;
+                        lBreak.pos = pos;
+
+#ifdef DEBUG_LINEBREAKS
+                        kdDebug(6041) << "forced break sol: " << start.obj << " " << start.pos << "   end: " << lBreak.obj << " " << lBreak.pos << "   width=" << w << endl;
+#endif
+                        return lBreak;
+                    }
+
+                    if (o->style()->whiteSpace() == NORMAL) {
+                        w += tmpW;
+                        tmpW = 0;
+                        lBreak.obj = o;
+                        lBreak.pos = pos;
+                    }
 
-             tmpW += o->width()+o->marginLeft()+o->marginRight()+inlineWidth(o);
+                    lastSpace = pos;
+#ifdef APPLE_CHANGES
+                    if (applyWordSpacing)
+                        w += wordSpacing;
+#endif
+                    if (!ignoringSpaces && !isPre) {
+                        // If we encounter a newline, or if we encounter a
+                        // second space, we need to go ahead and break up this
+                        // run and enter a mode where we start collapsing spaces.
+                        if (currentCharacterIsSpace && previousCharacterIsSpace) {
+                            ignoringSpaces = true;
+
+                            // We just entered a mode where we are ignoring
+                            // spaces. Create a midpoint to terminate the run
+                            // before the second space.
+                            addMidpoint(ignoreStart);
+                            lastSpace = pos;
+                        }
+                    }
+                }
+                else if (ignoringSpaces) {
+                    // Stop ignoring spaces and begin at this
+                    // new point.
+                    ignoringSpaces = false;
+                    lastSpace = pos; // e.g., "Foo    goo", don't add in any of the ignored spaces.
+                    BidiIterator startMid ( 0, o, pos );
+                    addMidpoint(startMid);
+                }
+
+                if (currentCharacterIsSpace && !previousCharacterIsSpace) {
+                    ignoreStart.obj = o;
+                    ignoreStart.pos = pos;
+                }
+
+                if (!isPre && currentCharacterIsSpace && !ignoringSpaces)
+                    trailingSpaceObject = o;
+                else if (isPre || !currentCharacterIsSpace)
+                    trailingSpaceObject = 0;
+
+                pos++;
+                len--;
+            }
 
-             currentCharacterIsSpace = false;
+            // IMPORTANT: pos is > length here!
+            if (!ignoringSpaces)
+                tmpW += t->width(lastSpace, pos - lastSpace, f);
+            if (!appliedStartWidth)
+                tmpW += inlineWidth(o, true, false);
+            if (!appliedEndWidth)
+                tmpW += inlineWidth(o, false, true);
         } else
             KHTMLAssert( false );
 
-        RenderObject* next = Bidinext(start.par, o );
+        RenderObject* next = Bidinext(start.par, o, bidi);
         bool isNormal = o->style()->whiteSpace() == NORMAL;
         bool checkForBreak = isNormal;
         if (w && w + tmpW > width+1 && lBreak.obj && o->style()->whiteSpace() == NOWRAP)
@@ -1466,13 +1805,15 @@
             }
         }
 
-        if(checkForBreak && ( w + tmpW > width+1 ) ) {
-//             kdDebug() << " too wide w=" << w << " tmpW = " << tmpW << " width = " << width << endl;
-//  	    kdDebug() << "start=" << start.obj << " current=" << o << endl;
+        if (checkForBreak && (w + tmpW > width+1)) {
+            //kdDebug() << " too wide w=" << w << " tmpW = " << tmpW << " width = " << width << endl;
+            //kdDebug() << "start=" << start.obj << " current=" << o << endl;
+            // if we have floats, try to get below them.
+            if (currentCharacterIsSpace && !ignoringSpaces && o->style()->whiteSpace() != PRE)
+                trailingSpaceObject = 0;
 
             int fb = nearestFloatBottom(m_height);
-	    int newLineWidth = lineWidth(fb);
-
+            int newLineWidth = lineWidth(fb);
             // See if |tmpW| will fit on the new line.  As long as it does not,
             // keep adjusting our float bottom until we find some room.
             int lastFloatBottom = m_height;
@@ -1494,38 +1835,52 @@
             // the end label if we still don't fit on the line. -dwh
             if (w + tmpW > width+1)
                 goto end;
-
         }
 
         last = o;
-        o = Bidinext( start.par, o );
+        o = next;
 
         if (!last->isFloatingOrPositioned() && last->isReplaced() && last->style()->whiteSpace() == NORMAL) {
             // Go ahead and add in tmpW.
             w += tmpW;
             tmpW = 0;
-            lBreak = o;
+            lBreak.obj = o;
+            lBreak.pos = 0;
         }
 
+        // Clear out our character space bool, since inline <pre>s don't collapse whitespace
+        // with adjacent inline normal/nowrap spans.
+        if (last->style()->whiteSpace() == PRE)
+            currentCharacterIsSpace = false;
+
         pos = 0;
     }
 
 #ifdef DEBUG_LINEBREAKS
     kdDebug( 6041 ) << "end of par, width = " << width << " linewidth = " << w + tmpW << endl;
 #endif
-    if( w + tmpW <= width || (last && last->style()->whiteSpace() == NOWRAP))
-        lBreak = 0;
+    if( w + tmpW <= width || (last && last->style()->whiteSpace() == NOWRAP)) {
+        lBreak.obj = 0;
+        lBreak.pos = 0;
+    }
 
  end:
 
     if( lBreak == start && !lBreak.obj->isBR() ) {
         // we just add as much as possible
-        if ( m_pre )
-            lBreak = pos ? Bidinext(start.par, o) : o;
-        else if ( lBreak.obj ) {
-            if ( last != o ) {
-                // better break between object boundaries than in the middle of a word
-                lBreak = o;
+        if ( m_pre ) {
+            if(pos != 0) {
+                lBreak.obj = o;
+                lBreak.pos = pos - 1;
+            } else {
+                lBreak.obj = last;
+                lBreak.pos = last->isText() ? last->length() : 0;
+            }
+        } else if( lBreak.obj ) {
+            if( last != o ) {
+                // better to break between object boundaries than in the middle of a word
+                lBreak.obj = o;
+                lBreak.pos = 0;
             } else {
                 // Don't ever break in the middle of a word if we can help it.
                 // There's no room at all. We just have to be on this line,
@@ -1538,20 +1893,43 @@
 
     // make sure we consume at least one char/object.
     if( lBreak == start )
-        ++lBreak;
+        lBreak.increment(bidi);
+
+#ifdef DEBUG_LINEBREAKS
+    kdDebug(6041) << "regular break sol: " << start.obj << " " << start.pos << "   end: " << lBreak.obj << " " << lBreak.pos << "   width=" << w << endl;
+#endif
+
+    // Sanity check our midpoints.
+    checkMidpoints(lBreak, bidi);
+
+    if (trailingSpaceObject) {
+        // This object is either going to be part of the last midpoint, or it is going
+        // to be the actual endpoint.  In both cases we just decrease our pos by 1 level to
+        // exclude the space, allowing it to - in effect - collapse into the newline.
+        if (sNumMidpoints%2==1) {
+            BidiIterator* midpoints = smidpoints->data();
+            midpoints[sNumMidpoints-1].pos--;
+        }
+        //else if (lBreak.pos > 0)
+        //    lBreak.pos--;
+        else if (lBreak.obj == 0 && trailingSpaceObject->isText()) {
+            // Add a new end midpoint that stops right at the very end.
+            RenderText* text = static_cast<RenderText *>(trailingSpaceObject);
+            unsigned pos = text->length() >=2 ? text->length() - 2 : UINT_MAX;
+            BidiIterator endMid ( 0, trailingSpaceObject, pos );
+            addMidpoint(endMid);
+        }
+    }
 
     // We might have made lBreak an iterator that points past the end
     // of the object. Do this adjustment to make it point to the start
     // of the next object instead to avoid confusing the rest of the
     // code.
-    if ( lBreak.obj && lBreak.pos >= lBreak.obj->length() ) {
-        lBreak.obj = Bidinext( start.par, lBreak.obj );
-        lBreak.pos = 0;
+    if (lBreak.pos > 0) {
+        lBreak.pos--;
+        lBreak.increment(bidi);
     }
 
-#ifdef DEBUG_LINEBREAKS
-    kdDebug(6041) << "regular break sol: " << start.obj << " " << start.pos << "   end: " << lBreak.obj << " " << lBreak.pos << "   width=" << w << "/" << width << endl;
-#endif
     return lBreak;
 }
 
@@ -1559,3 +1937,5 @@
 #undef BIDI_DEBUG
 #undef DEBUG_LINEBREAKS
 #undef DEBUG_LAYOUT
+
+}
diff -urN -x CVS kdelibs.orig/khtml/rendering/bidi.h kdelibs/khtml/rendering/bidi.h
--- kdelibs.orig/khtml/rendering/bidi.h	Fri Oct  3 16:33:29 2003
+++ kdelibs/khtml/rendering/bidi.h	Wed Nov 17 14:43:03 2004
@@ -2,6 +2,7 @@
  * This file is part of the html renderer for KDE.
  *
  * Copyright (C) 2000 Lars Knoll (knoll@kde.org)
+ * Copyright (C) 2003 Apple Computer, Inc.
  *
  * This library is free software; you can redistribute it and/or
  * modify it under the terms of the GNU Library General Public
@@ -18,7 +19,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #ifndef BIDI_H
 #define BIDI_H
@@ -26,9 +26,9 @@
 #include <qstring.h>
 
 namespace khtml {
-    class RenderFlow;
-    class RenderObject;
     class RenderArena;
+    class RenderBlock;
+    class RenderObject;
     class InlineBox;
 
     class BidiContext {
@@ -53,8 +53,7 @@
 
     struct BidiRun {
 	BidiRun(int _start, int _stop, RenderObject *_obj, BidiContext *context, QChar::Direction dir)
-	    :  vertical( 0 ),
-	       start( _start ), stop( _stop ), obj( _obj ), box(0)
+	    :  start( _start ), stop( _stop ), obj( _obj ), box(0), nextRun(0)
 	{
 	    if(dir == QChar::DirON) dir = context->dir;
 
@@ -62,76 +61,45 @@
 
 	    // add level of run (cases I1 & I2)
 	    if( level % 2 ) {
-		if(dir == QChar::DirL || dir == QChar::DirAN || dir == QChar::DirEN )
+		if(dir == QChar::DirL || dir == QChar::DirAN || dir == QChar::DirEN)
 		    level++;
 	    } else {
 		if( dir == QChar::DirR )
 		    level++;
-		else if( dir == QChar::DirAN || dir == QChar::DirEN )
+		else if( dir == QChar::DirAN || dir == QChar::DirEN)
 		    level += 2;
 	    }
 	}
 
-	int vertical;
+        void detach(RenderArena* renderArena);
+
+        // Overloaded new operator.
+        void* operator new(size_t sz, RenderArena* renderArena) throw();
+
+        // Overridden to prevent the normal delete from being called.
+        void operator delete(void* ptr, size_t sz);
+
+private:
+        // The normal operator new is disallowed.
+        void* operator new(size_t sz) throw();
 
+public:
 	int start;
 	int stop;
-	RenderObject *obj;
+
+        RenderObject *obj;
         InlineBox* box;
 
 	// explicit + implicit levels here
 	uchar level;
-    };
-
-    // an iterator which goes through a BidiParagraph
-    class BidiIterator
-    {
-    public:
-	BidiIterator();
-	BidiIterator(RenderFlow *par);
-	BidiIterator(RenderFlow *par, RenderObject *_obj, int _pos = 0);
-
-	BidiIterator(const BidiIterator &it);
-	BidiIterator &operator = (const BidiIterator &it);
-        void operator= (RenderObject* _obj) {
-            obj = _obj; pos = 0;
-            // ### isText ?
-        }
 
-	void operator ++ ();
+        bool compact : 1;
 
-	bool atEnd() const;
-
-	const QChar &current() const;
-	QChar::Direction direction() const;
-
-	void detach(khtml::RenderArena* renderArena);
-
-	void* operator new(size_t sz, khtml::RenderArena* renderArena) throw();
-	void operator delete(void* ptr, size_t sz);
-
-    private:
-	// The normal operator new is disallowed.
-	void* operator new(size_t sz) throw();
-
-    public:
-
-	RenderFlow *par;
-	RenderObject *obj;
-	bool isText : 1;
-	unsigned int pos : 30;
+        BidiRun* nextRun;
     };
 
-    struct BidiStatus {
-	BidiStatus() {
-	    eor = QChar::DirON;
-	    lastStrong = QChar::DirON;
-	    last = QChar:: DirON;
-	}
-	QChar::Direction eor 		: 5;
-	QChar::Direction lastStrong 	: 5;
-	QChar::Direction last		: 5;
-    };
+    struct BidiIterator;
+    struct BidiState;
 
 }
 
diff -urN -x CVS kdelibs.orig/khtml/rendering/font.cpp kdelibs/khtml/rendering/font.cpp
--- kdelibs.orig/khtml/rendering/font.cpp	Tue Sep  7 18:58:02 2004
+++ kdelibs/khtml/rendering/font.cpp	Wed Nov 17 14:59:17 2004
@@ -20,7 +20,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 
 #include "config.h"
@@ -112,12 +111,12 @@
 
 	int numSpaces = 0;
 	if ( toAdd ) {
-	    for( int i = 0; i < len; i++ )
+	    for( int i = 0; i < len; ++i )
 		if ( str[i+pos].category() == QChar::Separator_Space )
-		    numSpaces++;
-	}  
+		    ++numSpaces;
+	}
 
-	int totWidth = width( str, slen, pos, len );
+	const int totWidth = width( str, slen, pos, len );
 	if ( d == QPainter::RTL ) {
 	    x += totWidth + toAdd;
 	}
@@ -145,11 +144,11 @@
 	if (mode == Whole) {	// most likely variant is treated extra
 
 	    if (to < 0) to = len;
-	    QConstString cstr(str + pos, len);
-	    QConstString segStr(str + pos + from, to - from);
-	    int preSegmentWidth = fm.width(cstr.string(), from);
-	    int segmentWidth = fm.width(segStr.string());
-	    int eff_x = d == QPainter::RTL ? x - preSegmentWidth - segmentWidth
+	    const QConstString cstr(str + pos, len);
+	    const QConstString segStr(str + pos + from, to - from);
+	    const int preSegmentWidth = fm.width(cstr.string(), from);
+	    const int segmentWidth = fm.width(segStr.string());
+	    const int eff_x = d == QPainter::RTL ? x - preSegmentWidth - segmentWidth
 					: x + preSegmentWidth;
 
 	    // draw whole string segment, with optional background
@@ -167,18 +166,18 @@
 	// For each letter in the text box, save the width of the character.
 	// When word-wise, only the first letter contains the width, but of the
 	// whole word.
-        short *widthList = (short *)alloca(to*sizeof(short));
+        short* const widthList = (short *)alloca(to*sizeof(short));
 
 	// First pass: gather widths
 	int preSegmentWidth = 0;
 	int segmentWidth = 0;
         int lastWordBegin = 0;
 	bool onSegment = from == 0;
-	for( int i = 0; i < to; i++ ) {
+	for( int i = 0; i < to; ++i ) {
 	    if (i == from) {
                 // Also close words on visibility boundary
 	        if (mode == WordWise) {
-	            int width = closeWordAndGetWidth(fm, str, pos, lastWordBegin, i);
+	            const int width = closeWordAndGetWidth(fm, str, pos, lastWordBegin, i);
 
 		    if (lastWordBegin < i) {
 		        widthList[lastWordBegin] = (short)width;
@@ -189,7 +188,7 @@
 		onSegment = true;
 	    }
 
-	    QChar ch = str[pos+i];
+	    const QChar ch = str[pos+i];
 	    bool lowercase = (ch.category() == QChar::Letter_Lowercase);
 	    bool is_space = (ch.category() == QChar::Separator_Space);
 	    int chw = 0;
@@ -197,20 +196,20 @@
 		chw += letterSpacing;
 	    if ( (wordSpacing || toAdd) && is_space ) {
 	        if (mode == WordWise) {
-		    int width = closeWordAndGetWidth(fm, str, pos, lastWordBegin, i);
+		    const int width = closeWordAndGetWidth(fm, str, pos, lastWordBegin, i);
 		    if (lastWordBegin < i) {
 		        widthList[lastWordBegin] = (short)width;
 			lastWordBegin = i;
 		        (onSegment ? segmentWidth : preSegmentWidth) += width;
 		    }
-		    lastWordBegin++;		// ignore this space
+		    ++lastWordBegin;		// ignore this space
 		}
 		chw += wordSpacing;
 		if ( numSpaces ) {
-		    int a = toAdd/numSpaces;
+		    const int a = toAdd/numSpaces;
 		    chw += a;
 		    toAdd -= a;
-		    numSpaces--;
+		    --numSpaces;
 		}
 	    }
 	    if (is_space || mode == CharacterWise) {
@@ -231,26 +230,26 @@
         if (d == QPainter::RTL) x -= preSegmentWidth;
 	else x += preSegmentWidth;
 
-        int startx = d == QPainter::RTL ? x-segmentWidth : x;
-        
+        const int startx = d == QPainter::RTL ? x-segmentWidth : x;
+
 	// optionally draw background
 	if ( bg.isValid() )
 	    p->fillRect( startx, uy, segmentWidth, h, bg );
 
 	// second pass: do the actual drawing
         lastWordBegin = from;
-	for( int i = from; i < to; i++ ) {
-	    QChar ch = str[pos+i];
+	for( int i = from; i < to; ++i ) {
+	    const QChar ch = str[pos+i];
 	    bool lowercase = (ch.category() == QChar::Letter_Lowercase);
 	    bool is_space = ch.category() == QChar::Separator_Space;
 	    if ( is_space ) {
 	        if (mode == WordWise) {
 		    closeAndDrawWord(p, d, x, y, widthList, str, pos, lastWordBegin, i);
-		    lastWordBegin++;	// jump over space
+		    ++lastWordBegin;	// jump over space
 		}
 	    }
 	    if (is_space || mode == CharacterWise) {
-	        int chw = widthList[i];
+	        const int chw = widthList[i];
 	        if (d == QPainter::RTL)
 		    x -= chw;
 
@@ -280,15 +279,15 @@
 
 int Font::width( QChar *chs, int, int pos, int len ) const
 {
-    QConstString cstr(chs+pos, len);
+    const QConstString cstr(chs+pos, len);
     int w = 0;
 
-    QString qstr = cstr.string();
+    const QString qstr = cstr.string();
     if ( scFont ) {
-	QString upper = qstr.upper();
+	const QString upper = qstr.upper();
 	const QChar *uc = qstr.unicode();
-	QFontMetrics sc_fm( *scFont );
-	for ( int i = 0; i < len; i++ ) {
+	const QFontMetrics sc_fm( *scFont );
+	for ( int i = 0; i < len; ++i ) {
 	    if ( (uc+i)->category() == QChar::Letter_Lowercase )
 		w += sc_fm.charWidth( upper, i );
 	    else
@@ -304,7 +303,7 @@
 
     if ( wordSpacing )
 	// add amount
-	for( int i = 0; i < len; i++ ) {
+	for( int i = 0; i < len; ++i ) {
 	    if( chs[i+pos].category() == QChar::Separator_Space )
 		w += wordSpacing;
 	}
@@ -320,7 +319,7 @@
 	    str[pos] = chs[pos].upper();
 	    w = QFontMetrics( *scFont ).charWidth( str, pos );
 	} else {
-	    QConstString cstr( chs, slen );
+	    const QConstString cstr( chs, slen );
 	    w = fm.charWidth( cstr.string(), pos );
 	}
     if ( letterSpacing )
@@ -341,21 +340,25 @@
     QFontDatabase db;
 
     int size = fontDef.size;
-    int lDpiY = kMax(devMetrics->logicalDpiY(), 96);
+    const int lDpiY = kMax(devMetrics->logicalDpiY(), 96);
 
     // ok, now some magic to get a nice unscaled font
     // all other font properties should be set before this one!!!!
     if( !db.isSmoothlyScalable(f.family(), db.styleString(f)) )
     {
-        QValueList<int> pointSizes = db.smoothSizes(f.family(), db.styleString(f));
+        const QValueList<int> pointSizes = db.smoothSizes(f.family(), db.styleString(f));
         // lets see if we find a nice looking font, which is not too far away
         // from the requested one.
         // kdDebug(6080) << "khtml::setFontSize family = " << f.family() << " size requested=" << size << endl;
 
-        QValueList<int>::Iterator it;
+
         float diff = 1; // ### 100% deviation
         float bestSize = 0;
-        for( it = pointSizes.begin(); it != pointSizes.end(); ++it )
+
+        QValueList<int>::ConstIterator it = pointSizes.begin();
+        const QValueList<int>::ConstIterator itEnd = pointSizes.end();
+
+        for( ; it != itEnd; ++it )
         {
             float newDiff = ((*it)*(lDpiY/72.) - float(size))/float(size);
             //kdDebug( 6080 ) << "smooth font size: " << *it << " diff=" << newDiff << endl;
@@ -397,8 +400,8 @@
 {
     Q_UNUSED(height);
     // thick lines on small fonts look ugly
-    int thickness = fm.height() > 20 ? fm.lineWidth() : 1;
-    QBrush brush = pt->pen().color();
+    const int thickness = fm.height() > 20 ? fm.lineWidth() : 1;
+    const QBrush brush = pt->pen().color();
     if (deco & UNDERLINE) {
         int underlineOffset = ( fm.height() + baseline ) / 2;
         if (underlineOffset <= baseline) underlineOffset = baseline+1;
diff -urN -x CVS kdelibs.orig/khtml/rendering/font.h kdelibs/khtml/rendering/font.h
--- kdelibs.orig/khtml/rendering/font.h	Wed Oct  8 20:55:31 2003
+++ kdelibs/khtml/rendering/font.h	Wed Nov 17 14:43:03 2004
@@ -20,7 +20,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 
 #ifndef KHTMLFONT_H
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_applet.cpp kdelibs/khtml/rendering/render_applet.cpp
--- kdelibs.orig/khtml/rendering/render_applet.cpp	Fri Oct  3 16:33:29 2003
+++ kdelibs/khtml/rendering/render_applet.cpp	Wed Nov 17 14:59:17 2004
@@ -18,7 +18,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #include <config.h>
 #include <klocale.h>
@@ -90,7 +89,7 @@
 {
     //kdDebug(6100) << "RenderApplet::layout" << endl;
 
-    KHTMLAssert( !layouted() );
+    KHTMLAssert( needsLayout() );
     KHTMLAssert( minMaxKnown() );
 
     calcWidth();
@@ -115,7 +114,7 @@
         tmp->showApplet();
     }
 
-    setLayouted();
+    setNeedsLayout(false);
 }
 
 void RenderApplet::processArguments(const QMap<QString, QString> &args)
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_applet.h kdelibs/khtml/rendering/render_applet.h
--- kdelibs.orig/khtml/rendering/render_applet.h	Sun May 18 00:12:58 2003
+++ kdelibs/khtml/rendering/render_applet.h	Wed Nov 17 14:43:03 2004
@@ -18,7 +18,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #ifndef render_applet_h
 #define render_applet_h
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_block.cpp kdelibs/khtml/rendering/render_block.cpp
--- kdelibs.orig/khtml/rendering/render_block.cpp	Sat Oct  2 14:33:08 2004
+++ kdelibs/khtml/rendering/render_block.cpp	Wed Nov 24 15:01:00 2004
@@ -5,6 +5,7 @@
  *           (C) 1999-2003 Antti Koivisto (koivisto@kde.org)
  *           (C) 2002-2003 Dirk Mueller (mueller@kde.org)
  *           (C) 2003 Apple Computer, Inc.
+ *           (C) 2004 Germain Garand (germain@ebooksfrance.org)
  *
  * This library is free software; you can redistribute it and/or
  * modify it under the terms of the GNU Library General Public
@@ -92,65 +93,91 @@
     // Update pseudos for :before and :after now.
     updatePseudoChild(RenderStyle::BEFORE, firstChild());
     updatePseudoChild(RenderStyle::AFTER, lastChild());
+
+    // handled by close() during parsing
+    if (!document()->parsing())
+        updateFirstLetter();
 }
 
-void RenderBlock::addChildToFlow(RenderObject* newChild, RenderObject* beforeChild)
+void RenderBlock::updateFirstLetter()
 {
-    // Make sure we don't append things after :after-generated content if we have it.
-    if ( !beforeChild && lastChild() && lastChild()->style()->styleType() == RenderStyle::AFTER )
-        beforeChild = lastChild();
+    // FIXME: We need to destroy the first-letter object if it is no longer the first child.  Need to find
+    // an efficient way to check for that situation though before implementing anything.
+
+    RenderStyle * pseudoStyle;
+    if ( isTable() || !(pseudoStyle = style()->getPseudoStyle(RenderStyle::FIRST_LETTER)) )
+        return;
 
-    setLayouted(false);
+    // Drill into inlines looking for our first text child.
+    RenderObject* currChild = firstChild();
+    while (currChild && currChild->needsLayout() && !currChild->isReplaced() && !currChild->isText())
+        currChild = currChild->firstChild();
+
+   if (currChild && currChild->isText() && !currChild->isBR()) {
+
+        bool update = (currChild->parent()->style()->styleType() == RenderStyle::FIRST_LETTER);
+        RenderObject* firstLetterContainer = update ? currChild->parent()->parent() : currChild->parent();
+        RenderText* textObj = static_cast<RenderText*>(currChild);
+
+        // Force inline display (except for floating first-letters)
+        pseudoStyle->setDisplay( pseudoStyle->isFloating() ? BLOCK : INLINE);
+        pseudoStyle->setPosition( STATIC ); // CSS2 says first-letter can't be positioned.
 
-    bool madeBoxesNonInline = FALSE;
+        if (update) {
+            firstLetterContainer->firstChild()->setStyle( pseudoStyle );
+            RenderStyle* newStyle = new RenderStyle();
+            newStyle->inheritFrom( pseudoStyle );
+            currChild->setStyle( newStyle );
+            return;
+        }
 
-    RenderStyle* pseudoStyle=0;
-    if ((!firstChild() || firstChild() == beforeChild) &&
-         (newChild->isInline() || newChild->isText()) &&
-         (pseudoStyle=style()->getPseudoStyle(RenderStyle::FIRST_LETTER)))
-    {
-        // Drill into inlines looking for our first text child.
-        RenderObject* textChild = newChild;
-        while (textChild && !( textChild->isText() && !textChild->isBR()) )
-            textChild = textChild->firstChild();
-
-        if (textChild) {
-            RenderObject* firstLetterContainer = textChild->parent();
-            if (!firstLetterContainer)
-                firstLetterContainer = this;
-
-            RenderText* newTextChild = static_cast<RenderText*>(textChild);
-
-            // Force inline display (except for floating first-letters)
-            pseudoStyle->setDisplay( pseudoStyle->isFloating() ? BLOCK : INLINE);
-            pseudoStyle->setPosition( STATIC ); // CSS2 says first-letter can't be positioned.
-
-            RenderObject* firstLetter = RenderFlow::createFlow(document() /* anonymous*/, pseudoStyle, renderArena() );
-            firstLetterContainer->addChild(firstLetter, firstLetterContainer->firstChild());
-
-            DOMStringImpl* oldText = newTextChild->string();
-
-            if(oldText->l >= 1) {
-                oldText->ref();
-                unsigned int length = 0;
-                while ( length < oldText->l &&
-                        ( (oldText->s+length)->isSpace() || (oldText->s+length)->isPunct() ) )
-                    length++;
+        RenderObject* firstLetter = RenderFlow::createFlow(document() /* anonymous*/, pseudoStyle, renderArena() );
+        firstLetterContainer->addChild(firstLetter, firstLetterContainer->firstChild());
+
+        // The original string is going to be either a generated content string or a DOM node's
+        // string.  We want the original string before it got transformed in case first-letter has
+        // no text-transform or a different text-transform applied to it.
+        DOMStringImpl* oldText = textObj->originalString();
+        if (!oldText)
+            oldText = textObj->string();
+
+        if(oldText->l >= 1) {
+            oldText->ref();
+            unsigned int length = 0;
+            while ( length < oldText->l &&
+                    ( (oldText->s+length)->isSpace() || (oldText->s+length)->isPunct() ) )
                 length++;
-                kdDebug( 6040 ) << "letter= '" << DOMString(oldText->substring(0,length)).string() << "'" << endl;
-                newTextChild->setText( oldText->l > length ?
-                                       oldText->substring(length,oldText->l-length) : new DOMStringImpl(""));
-                NodeImpl* letterElement = newTextChild->element() ? (NodeImpl*) newTextChild->element() : (NodeImpl*) document();
-                RenderText* letter = new (renderArena()) RenderText(letterElement, oldText->substring(0,length));
-                RenderStyle* newStyle = new RenderStyle();
-                newStyle->inheritFrom(pseudoStyle);
-                letter->setStyle(newStyle);
-                firstLetter->addChild(letter);
-                oldText->deref();
-            }
-            firstLetter->close();
+            if (!( (oldText->s+length)->isSpace() || (oldText->s+length)->isPunct() ))
+                length++;
+            RenderTextFragment* remainingText =
+                new (renderArena()) RenderTextFragment(textObj->node(), oldText, length, oldText->l-length);
+            remainingText->setStyle(textObj->style());
+            if (remainingText->element())
+                remainingText->element()->setRenderer(remainingText);
+
+            RenderObject* nextObj = textObj->nextSibling();
+            firstLetterContainer->removeChild(textObj);
+            firstLetterContainer->addChild(remainingText, nextObj);
+
+            RenderTextFragment* letter =
+                new (renderArena()) RenderTextFragment(remainingText->node(), oldText, 0, length);
+            RenderStyle* newStyle = new RenderStyle();
+            newStyle->inheritFrom(pseudoStyle);
+            letter->setStyle(newStyle);
+            firstLetter->addChild(letter);
+            oldText->deref();
         }
+        firstLetter->close();
     }
+}
+
+void RenderBlock::addChildToFlow(RenderObject* newChild, RenderObject* beforeChild)
+{
+    // Make sure we don't append things after :after-generated content if we have it.
+    if ( !beforeChild && lastChild() && lastChild()->style()->styleType() == RenderStyle::AFTER )
+        beforeChild = lastChild();
+
+    bool madeBoxesNonInline = FALSE;
 
     // If the requested beforeChild is not one of our children, then this is most likely because
     // there is an anonymous block box within this object that contains the beforeChild. So
@@ -162,8 +189,7 @@
 
         if (newChild->isInline()) {
             beforeChild->parent()->addChild(newChild,beforeChild);
-            newChild->setLayouted( false );
-            newChild->setMinMaxKnown( false );
+//            newChild->setNeedsLayoutAndMinMaxRecalc();
             return;
         }
         else if (beforeChild->parent()->firstChild() != beforeChild)
@@ -202,18 +228,18 @@
         // a new one is created and inserted into our list of children in the appropriate position.
         if (newChild->isInline()) {
             if (beforeChild) {
-                if (beforeChild->previousSibling() && beforeChild->previousSibling()->isAnonymous()) {
+                if ( beforeChild->previousSibling() && beforeChild->previousSibling()->isAnonymous() &&
+                     beforeChild->previousSibling()->style()->styleType() == RenderStyle::NOPSEUDO ) {
                     beforeChild->previousSibling()->addChild(newChild);
-                    newChild->setLayouted( false );
-                    newChild->setMinMaxKnown( false );
+//                    newChild->setNeedsLayoutAndMinMaxRecalc();
                     return;
                 }
             }
             else {
-                if (m_last && m_last->isAnonymous()) {
+                if ( m_last && m_last->isAnonymous() &&
+                     m_last->style()->styleType() == RenderStyle::NOPSEUDO ) {
                     m_last->addChild(newChild);
-                    newChild->setLayouted( false );
-                    newChild->setMinMaxKnown( false );
+//                    newChild->setNeedsLayoutAndMinMaxRecalc();
                     return;
                 }
             }
@@ -223,8 +249,7 @@
             RenderBox::addChild(newBox,beforeChild);
             newBox->addChild(newChild);
             newBox->setPos(newBox->xPos(), -500000);
-            newChild->setLayouted( false );
-            newChild->setMinMaxKnown( false );
+//            newChild->setNeedsLayoutAndMinMaxRecalc();
             return;
         }
         else {
@@ -240,9 +265,6 @@
     RenderBox::addChild(newChild,beforeChild);
     // ### care about aligned stuff
 
-    newChild->setLayouted( false );
-    newChild->setMinMaxKnown( false );
-
     if ( madeBoxesNonInline )
         removeLeftoverAnonymousBoxes();
 }
@@ -318,10 +340,8 @@
         box->appendChildNode(removeChildNode(inlineRunEnd));
         box->close();
         box->setPos(box->xPos(), -500000);
-        box->setLayouted( false );
     }
 
-    setLayouted( false );
 }
 
 void RenderBlock::removeChild(RenderObject *oldChild)
@@ -342,11 +362,9 @@
             RenderObject* no = o;
             o = no->nextSibling();
             prev->appendChildNode(next->removeChildNode(no));
-            no->setMinMaxKnown( false );
-            no->setLayouted( false );
+            no->setNeedsLayoutAndMinMaxRecalc();
         }
-        prev->setMinMaxKnown( false );
-        prev->setLayouted( false );
+        prev->setNeedsLayoutAndMinMaxRecalc();
 
         // Nuke the now-empty block.
         next->detach();
@@ -367,11 +385,8 @@
             RenderObject* no = o;
             o = no->nextSibling();
             appendChildNode(anonBlock->removeChildNode(no));
-            no->setMinMaxKnown( false );
-            no->setLayouted( false );
+            no->setNeedsLayoutAndMinMaxRecalc();
         }
-        setMinMaxKnown( false );
-        setLayouted( false );
 
         // Nuke the now-empty block.
         anonBlock->detach();
@@ -422,16 +437,22 @@
 void RenderBlock::layoutBlock(bool relayoutChildren)
 {
     if (isInline() && !isReplacedBlock()) {
-        setLayouted();
+        setNeedsLayout(false);
         return;
     }
-
     //    kdDebug( 6040 ) << renderName() << " " << this << "::layoutBlock() start" << endl;
     //     QTime t;
     //     t.start();
-    KHTMLAssert( !layouted() );
+    KHTMLAssert( needsLayout() );
     KHTMLAssert( minMaxKnown() );
 
+    if (!relayoutChildren && posChildNeedsLayout() && !normalChildNeedsLayout() && !selfNeedsLayout()) {
+        // All we have to is lay out our positioned objects.
+        layoutPositionedObjects(relayoutChildren);
+        setNeedsLayout(false);
+        return;
+    }
+
     int oldWidth = m_width;
 
     calcWidth();
@@ -445,7 +466,7 @@
     //                     << overhangingContents() << "," << isPositioned() << endl;
 
 #ifdef DEBUG_LAYOUT
-    kdDebug( 6040 ) << renderName() << "(RenderBlock) " << this << " ::layout() width=" << m_width << ", layouted=" << layouted() << endl;
+    kdDebug( 6040 ) << renderName() << "(RenderBlock) " << this << " ::layout() width=" << m_width << ", needsLayout=" << needsLayout() << endl;
     if(containingBlock() == static_cast<RenderObject *>(this))
         kdDebug( 6040 ) << renderName() << ": containingBlock == this" << endl;
 #endif
@@ -489,7 +510,7 @@
         // does painting or event handling.
         m_layer->moveScrollbarsAside();
     }
-
+ 
     // A quirk that has become an unfortunate standard.  Positioned elements, floating elements
     // and table cells don't ever collapse their margins with either themselves or their
     // children.
@@ -502,8 +523,11 @@
         layoutBlockChildren( relayoutChildren );
 
     // Expand our intrinsic height to encompass floats.
+    int toAdd = borderBottom() + paddingBottom();
+    if (m_layer && style()->scrollsOverflow() && style()->height().isVariable())
+        toAdd += m_layer->horizontalScrollbarHeight();                
     if ( hasOverhangingFloats() && (isInlineBlockOrInlineTable() || isFloatingOrPositioned() || style()->hidesOverflow()) )
-        m_height = floatBottom() + borderBottom() + paddingBottom();
+        m_height = floatBottom() + toAdd;
 
     int oldHeight = m_height;
     calcHeight();
@@ -567,7 +591,15 @@
     if (style()->hidesOverflow() && m_layer)
         m_layer->checkScrollbarsAfterLayout();
 
-    setLayouted();
+    setNeedsLayout(false);
+}
+
+static inline bool isAnonymousWhitespace( RenderObject* o ) {
+    if (!o->isAnonymous())
+        return false;
+    RenderObject *fc = o->firstChild();
+    return fc && fc == o->lastChild() && fc->isText() && static_cast<RenderText *>(fc)->stringLength() == 1 &&
+           static_cast<RenderText *>(fc)->text()[0].unicode() == ' ';
 }
 
 void RenderBlock::layoutBlockChildren( bool relayoutChildren )
@@ -581,6 +613,9 @@
         xPos = m_width - paddingRight() - borderRight();
 
     int toAdd = borderBottom() + paddingBottom();
+    if (m_layer && style()->scrollsOverflow() && style()->height().isVariable())
+        toAdd += m_layer->horizontalScrollbarHeight();
+
     m_height = borderTop() + paddingTop();
 
     // Fieldsets need to find their legend and position it inside the border of the object.
@@ -629,6 +664,10 @@
     // be pushed down below a float.
     int clearOccurred = false;
 
+    // If our last normal flow child was a self-collapsing block that cleared a float,
+    // we track it in this variable.
+    bool selfCollapsingBlockClearedFloat = false;
+
     int oldPosMargin = prevPosMargin;
     int oldNegMargin = prevNegMargin;
 
@@ -658,8 +697,10 @@
         }
 
         // make sure we relayout children if we need it.
-        if ( relayoutChildren || (child->isReplaced() && (child->style()->width().isPercent() || child->style()->height().isPercent())))
-            child->setLayouted( false );
+        if (relayoutChildren || floatBottom() > m_y ||
+            (child->isReplaced() && (child->style()->width().isPercent() || child->style()->height().isPercent())) ||
+            (child->isRenderBlock() && child->style()->height().isPercent()))
+            child->setChildNeedsLayout(true);
 
         //         kdDebug( 6040 ) << "   " << child->renderName() << " loop " << child << ", " << child->isInline() << ", " << child->needsLayout() << endl;
         //         kdDebug( 6040 ) << t.elapsed() << endl;
@@ -670,26 +711,33 @@
             child->containingBlock()->insertPositionedObject(child);
             RenderStyle* s = child->style();
 
-            if ( child->isBox() &&
-                 ( ( s->left().isVariable() && s->right().isVariable() ) ||
-                 s->left().isStatic() || s->right().isStatic() ) ) {
+            if ( child->isBox() && child->hasStaticX()) {
                 if (style()->direction() == LTR)
                     static_cast<RenderBox*>( child )->setStaticX(xPos);
                 else
                     static_cast<RenderBox*>( child )->setStaticX(borderRight()+paddingRight());
             }
-            if ( child->isBox() &&
-                 ( ( s->top().isVariable() && s->bottom().isVariable() ) ||
-                 s->top().isStatic() ) ) {
-                int yPosEstimate = m_height;
-                if (prevFlow)
-                    yPosEstimate += prevFlow->collapsedMarginBottom();
+            if ( child->isBox() && child->hasStaticY()) {
+                int marginOffset = 0;
+                bool shouldSynthesizeCollapse = (!topMarginContributor || !canCollapseTopWithChildren);
+                if (shouldSynthesizeCollapse) {
+                    int collapsedTopPos = prevPosMargin;
+                    int collapsedTopNeg = prevNegMargin;
+                    bool posMargin = child->marginTop() >= 0;
+                    if (posMargin && child->marginTop() > collapsedTopPos)
+                        collapsedTopPos = child->marginTop();
+                    else if (!posMargin && child->marginTop() > collapsedTopNeg)
+                        collapsedTopNeg = child->marginTop();
+                    marginOffset += (collapsedTopPos - collapsedTopNeg) - child->marginTop();
+                }
+
+                int yPosEstimate = m_height + marginOffset;
                 static_cast<RenderBox*>( child )->setStaticY( yPosEstimate );
             }
             child = child->nextSibling();
             continue;
-        } else if (child->isReplaced() && !child->layouted())
-            child->layout();
+        } else if (child->isReplaced())
+            child->layoutIfNeeded();
 
         if ( child->isFloating() ) {
             insertFloatingObject( child );
@@ -720,9 +768,9 @@
             // Get the next non-positioned/non-floating RenderBlock.
             RenderObject* next = child->nextSibling();
             RenderObject* curr = next;
-            while (curr && curr->isFloatingOrPositioned())
+            while (curr && (curr->isFloatingOrPositioned() || isAnonymousWhitespace(curr)) )
                 curr = curr->nextSibling();
-            if (curr && curr->isRenderBlock() && !curr->isAnonymous() &&
+            if (curr && curr->isRenderBlock() &&
                 curr->style()->display() != COMPACT &&
                 curr->style()->display() != RUN_IN) {
                 curr->calcWidth(); // So that horizontal margins are correct.
@@ -741,17 +789,14 @@
                 else {
                     blockForCompactChild = curr;
                     compactChild = child;
-                    child->setInline(true);
+                    child->layoutIfNeeded();
+                    int off = prevPosMargin - prevNegMargin;
+                    m_height += off + curr->marginTop() < child->marginTop() ?
+                                child->marginTop() - curr->marginTop() -off: 0;
+
                     child->setPos(0,0); // This position will be updated to reflect the compact's
                                         // desired position and the line box for the compact will
                                         // pick that position up.
-
-                    // Remove the child.
-                    RenderObject* next = child->nextSibling();
-                    removeChildNode(child);
-
-                    // Now insert the child under |curr|.
-                    curr->insertChildNode(child, curr->firstChild());
                     child = next;
                     continue;
                 }
@@ -764,7 +809,7 @@
         if (child->style()->display() == RUN_IN && (child->childrenInline() || child->isReplaced())) {
             // Get the next non-positioned/non-floating RenderBlock.
             RenderObject* curr = child->nextSibling();
-            while (curr && curr->isFloatingOrPositioned())
+            while (curr && (curr->isFloatingOrPositioned() || isAnonymousWhitespace(curr)))
                 curr = curr->nextSibling();
             if (curr && (curr->isRenderBlock() && !curr->isAnonymous() && curr->childrenInline() &&
                          curr->style()->display() != COMPACT &&
@@ -788,17 +833,19 @@
         // Note this occurs after the test for positioning and floating above, since
         // we want to ensure that we don't artificially increase our height because of
         // a positioned or floating child.
-        if ( (child->style()->hidesOverflow() || child->style()->flowAroundFloats())
-             && !child->isFloating() &&
-             style()->width().isFixed() && child->minWidth() > lineWidth( m_height ) ) {
-            m_height = kMax( m_height, floatBottom() );
-            shouldCollapseChild = false;
-            clearOccurred = true;
+        int fb = floatBottom();
+        if ( child->flowAroundFloats() && style()->width().isFixed() && child->minWidth() > lineWidth( m_height ) ) {
+            if (fb > m_height) {
+                m_height = fb;
+                shouldCollapseChild = false;
+                clearOccurred = true;
+                prevFlow = 0;
+            }
         }
 
         // take care in case we inherited floats
-        if (floatBottom() > m_height)
-            child->setLayouted(false);
+        if (fb > m_height)
+            child->setChildNeedsLayout(true);
 
         child->calcVerticalMargins();
 
@@ -812,7 +859,7 @@
         {
             yPosEstimate += kMax(prevFlow->collapsedMarginBottom(), child->marginTop());
             if (prevFlow->yPos()+prevFlow->floatBottom() > yPosEstimate)
-                child->setLayouted( false );
+                child->setChildNeedsLayout(true);
             else
                 prevFlow=0;
         }
@@ -821,8 +868,7 @@
 
         // Go ahead and position the child as though it didn't collapse with the top.
         child->setPos(child->xPos(), yPosEstimate);
-        if ( !child->layouted() )
-            child->layout();
+        child->layoutIfNeeded();
 
         // Now determine the correct ypos based off examination of collapsing margin
         // values.
@@ -903,34 +949,47 @@
                 if (prevPosMargin-prevNegMargin) {
                     bottomChildQuirk = child->isBottomMarginQuirk();
                 }
+                selfCollapsingBlockClearedFloat = false;
             }
 
             child->setPos(child->xPos(), ypos);
             if (ypos != yPosEstimate) {
-                if (child->style()->htmlHacks() && child->style()->flowAroundFloats() &&
-                    child->style()->width().isPercent())
-                    // The child's width can be a percentage width and if it has the
-                    // quirky flowAroundFloats
-                    // property set, when the child shifts to clear an item, its width can
+                if (child->style()->width().isPercent() && child->usesLineWidth())
+                    // If the child shifts to clear an item, its width can
                     // change (because it has more available line width).
                     // So go ahead an mark the item as dirty.
-                    child->setLayouted( false );
+                    child->setChildNeedsLayout(true);
 
                 if (child->hasFloats() || hasFloats())
                     child->markAllDescendantsWithFloatsForLayout();
 
                 // Our guess was wrong. Make the child lay itself out again.
-                if ( !child->layouted() ) child->layout();
+                child->layoutIfNeeded();
             }
         }
+        else
+            selfCollapsingBlockClearedFloat = false;
 
         // Now check for clear.
-        if (checkClear(child)) {
+        int heightIncrease = getClearDelta(child);
+        if (heightIncrease) {
             // The child needs to be lowered.  Move the child so that it just clears the float.
-            child->setPos(child->xPos(), m_height);
+            child->setPos(child->xPos(), child->yPos() + heightIncrease);
             clearOccurred = true;
 
-            if (topMarginContributor) {
+            // Increase our height by the amount we had to clear.
+            if (!child->isSelfCollapsingBlock())
+                m_height += heightIncrease;
+            else {
+                // For self-collapsing blocks that clear, they may end up collapsing
+                // into the bottom of the parent block.  We simulate this behavior by
+                // setting our positive margin value to compensate for the clear.
+                prevPosMargin = kMax(0, child->yPos() - m_height);
+                prevNegMargin = 0;
+                selfCollapsingBlockClearedFloat = true;
+            }
+            
+            if (topMarginContributor && canCollapseTopWithChildren) {
                 // We can no longer collapse with the top of the block since a clear
                 // occurred.  The empty blocks collapse into the cleared block.
                 // XXX This isn't quite correct.  Need clarification for what to do
@@ -938,22 +997,17 @@
                 // margins involved. -dwh
                 m_maxTopPosMargin = oldPosMargin;
                 m_maxTopNegMargin = oldNegMargin;
+                topMarginContributor = false;
             }
 
             // If our value of clear caused us to be repositioned vertically to be
             // underneath a float, we might have to do another layout to take into account
             // the extra space we now have available.
-            if (child->style()->htmlHacks() && child->style()->flowAroundFloats() &&
-                child->style()->width().isPercent())
-                // The child's width can be a percentage width and if it has the
-                // quirky flowAroundFloats
-                // property set, when the child shifts to clear an item, its width can
-                // change (because it has more available line width).
-                // So go ahead an mark the item as dirty.
-                child->setLayouted( false );
+            if (!child->style()->width().isFixed() && child->usesLineWidth())
+                child->setChildNeedsLayout(true);
             if (child->hasFloats())
                 child->markAllDescendantsWithFloatsForLayout();
-            if ( !child->layouted() ) child->layout();
+            child->layoutIfNeeded();
         }
 
         // Reset the top margin contributor to false if we encountered
@@ -962,15 +1016,19 @@
         if (topMarginContributor && !child->isSelfCollapsingBlock())
             topMarginContributor = false;
 
-        int chPos = xPos + child->marginLeft();
+        int chPos = xPos;
 
         if (style()->direction() == LTR) {
+            chPos += child->marginLeft();
             // html blocks flow around floats
-            if (child->style()->hidesOverflow() ||
-                 (( style()->htmlHacks() || child->isTable() ) && child->style()->flowAroundFloats()))
+            if (child->flowAroundFloats())
             {
                 int leftOff = leftOffset(m_height);
-                if (leftOff != xPos) {
+                if (style()->textAlign() != KHTML_CENTER && !child->style()->marginLeft().isVariable()) {
+                    if (child->marginLeft() < 0)
+                        leftOff += child->marginLeft();
+                    chPos = kMax(chPos, leftOff); // Let the float sit in the child's margin if it can fit.
+                } else if (leftOff != xPos) {
                     // The object is shifting right. The object might be centered, so we need to
                     // recalculate our horizontal margins. Note that the containing block content
                     // width computation will take into account the delta between |leftOff| and |xPos|
@@ -980,14 +1038,30 @@
                     int cw = lineWidth( child->yPos() );
                     static_cast<RenderBox*>(child)->calcHorizontalMargins
                         ( child->style()->marginLeft(), child->style()->marginRight(), cw);
-                    chPos = leftOff + child->marginLeft();
+                    
                 }
             }
         } else {
             chPos -= child->width() + child->marginRight();
-            if (child->style()->hidesOverflow() ||
-                ((style()->htmlHacks() || child->isTable()) && child->style()->flowAroundFloats()))
-                chPos -= leftOffset(m_height);
+            if (child->flowAroundFloats()) {
+                int rightOff = rightOffset(m_height);
+                if (style()->textAlign() != KHTML_CENTER && !child->style()->marginRight().isVariable()) {
+                    if (child->marginRight() < 0)
+                        rightOff -= child->marginRight();
+                    chPos = kMin(chPos, rightOff - child->width()); // Let the float sit in the child's margin if it can fit.
+                } else if (rightOff != xPos) {
+                    // The object is shifting left. The object might be centered, so we need to
+                    // recalculate our horizontal margins. Note that the containing block content
+                    // width computation will take into account the delta between |rightOff| and |xPos|
+                    // so that we can just pass the content width in directly to the |calcHorizontalMargins|
+                    // function.
+                    // -dwh
+                    int cw = lineWidth( child->yPos() );
+                    static_cast<RenderBox*>(child)->calcHorizontalMargins
+                        ( child->style()->marginLeft(), child->style()->marginRight(), cw);
+                    chPos = rightOff - child->marginRight() - child->width();
+                }
+            }
         }
 
         child->setPos(chPos, child->yPos());
@@ -1011,8 +1085,7 @@
         else
             overflowDelta += child->overflowHeight();
 
-        int rightChildPos = child->xPos() + kMax(child->effectiveWidth(),
-                                                 child->width() + child->marginRight());
+        int rightChildPos = child->xPos() + kMax(child->effectiveWidth(), (int)child->width());
         if (child->isRelPositioned()) {
             // CSS 2.1-9.4.3 - allow access to relatively positioned content
             // ### left overflow support
@@ -1034,14 +1107,37 @@
             blockForCompactChild = 0;
             if (compactChild) {
                 // We have a compact child to squeeze in.
-                int compactXPos = xPos+compactChild->marginLeft();
-                if (style()->direction() == RTL) {
+                int compactXPos = xPos;
+                if (style()->direction() == LTR)
+                    compactXPos += compactChild->marginLeft();
+                else {
                     compactChild->calcWidth(); // have to do this because of the capped maxwidth
-                    compactXPos = width() - borderRight() - paddingRight() - marginRight() -
-                        compactChild->width() - compactChild->marginRight();
+                    compactXPos -= compactChild->width() - compactChild->marginRight();
                 }
-                compactXPos -= child->xPos(); // Put compactXPos into the child's coordinate space.
-                compactChild->setPos(compactXPos, compactChild->yPos()); // Set the x position.
+
+                int compactYPos = child->yPos() + child->borderTop() + child->paddingTop()
+                                  - compactChild->paddingTop() - compactChild->borderTop();
+                int adj = 0;
+                KHTMLAssert(child->isRenderBlock());
+                InlineRunBox *b = static_cast<RenderBlock*>(child)->firstLineBox();
+                InlineRunBox *c = static_cast<RenderBlock*>(compactChild)->firstLineBox();
+                if (b && c) {
+                    // adjust our vertical position
+                    int vpos = compactChild->getVerticalPosition( true, child );
+                    if (vpos == PositionBottom)
+                        adj = b->height() > c->height() ? (b->height() + b->yPos() - c->height() - c->yPos()) : 0;
+                    else if (vpos == PositionTop)
+                        adj = b->yPos() - c->yPos();
+                    else
+                        adj = vpos;
+                    compactYPos += adj;
+                }
+                Length newLineHeight( kMax(compactChild->lineHeight(true)+adj, (int)child->lineHeight(true)),
+                                      khtml::Fixed);
+                child->style()->setLineHeight( newLineHeight );
+                child->setNeedsLayout( true );
+                child->layout();
+                compactChild->setPos(compactXPos, compactYPos); // Set the x position.
                 compactChild = 0;
             }
         }
@@ -1063,6 +1159,11 @@
     bool canCollapseBottomWithChildren = canCollapseWithChildren && (toAdd == 0) &&
         (style()->height().isVariable() && style()->height().value() == 0);
 
+    // If our last flow was a self-collapsing block that cleared a float, then we don't
+    // collapse it with the bottom of the block.
+    if (selfCollapsingBlockClearedFloat)
+        canCollapseBottomWithChildren = false;
+
     // If we can't collapse with children then go ahead and add in the bottom margins.
     if (!canCollapseBottomWithChildren
         && (strictMode || !quirkContainer || !bottomChildQuirk))
@@ -1098,7 +1199,7 @@
             m_bottomMarginQuirk = true;
     }
 
-    setLayouted();
+    setNeedsLayout(false);
 }
 
 void RenderBlock::layoutPositionedObjects(bool relayoutChildren)
@@ -1111,9 +1212,8 @@
         for ( ; (r = it.current()); ++it ) {
             //kdDebug(6040) << "   have a positioned object" << endl;
             if ( relayoutChildren )
-                r->setLayouted( false );
-            if ( !r->layouted() )
-                r->layout();
+                r->setChildNeedsLayout(true);
+            r->layoutIfNeeded();
             if (adjOverflow && r->style()->position() == ABSOLUTE) {
                 if (r->xPos() + r->effectiveWidth() > m_overflowWidth)
                     m_overflowWidth = r->xPos() + r->effectiveWidth();
@@ -1160,6 +1260,7 @@
 
     // If we're a repositioned run-in, don't paint background/borders.
     bool inlineFlow = isInlineFlow();
+    bool isPrinting = (pI.p->device()->devType() == QInternal::Printer);
 
     // 1. paint background, borders etc
     if (!inlineFlow &&
@@ -1178,11 +1279,29 @@
     // 2. paint contents
     int scrolledX = _tx;
     int scrolledY = _ty;
+    int _y = pI.r.y();
+    int _h = pI.r.height();
     if (style()->hidesOverflow() && m_layer)
         m_layer->subtractScrollOffset(scrolledX, scrolledY);
-    for( RenderObject *child = firstChild(); child; child = child->nextSibling() )
+    for(RenderObject *child = firstChild(); child; child = child->nextSibling()) {
+        // Check for page-break-before: always, and if it's set, break and bail.
+        if (isPrinting && !childrenInline() && child->style()->pageBreakBefore() == PBALWAYS &&
+            inRootBlockContext() && (_ty + child->yPos()) > _y && (_ty + child->yPos()) < _y + _h) {
+            canvas()->setBestTruncatedAt(_ty + child->yPos(), this, true);
+            return;
+        }
+
         if(!child->layer() && !child->isFloating())
             child->paint(pI, scrolledX, scrolledY);
+
+        // Check for page-break-after: always, and if it's set, break and bail.
+        if (isPrinting && !childrenInline() && child->style()->pageBreakAfter() == PBALWAYS &&
+            inRootBlockContext() && (_ty + child->yPos() + child->height()) > _y &&
+            (_ty + child->yPos() + child->height()) < _y + _h) {
+            canvas()->setBestTruncatedAt(_ty + child->yPos() + child->height() + child->collapsedMarginBottom(), this, true);
+            return;
+        }
+    }
     paintLineBoxDecorations(pI, scrolledX, scrolledY);
 
     // 3. paint floats.
@@ -1305,8 +1424,7 @@
     FloatingObject *newObj;
     if (o->isFloating()) {
         // floating object
-        if ( !o->layouted() )
-            o->layout();
+        o->layoutIfNeeded();
 
         if(o->style()->floating() == FLEFT)
             newObj = new FloatingObject(FloatingObject::FloatLeft);
@@ -1378,7 +1496,7 @@
         int _height = o->height() + o->marginTop() + o->marginBottom();
 
         int ro = rightOffset(); // Constant part of right offset.
-        int lo = leftOffset(); // Constat part of left offset.
+        int lo = leftOffset(); // Constant part of left offset.
         int fwidth = f->width; // The width we look for.
                                //kdDebug( 6040 ) << " Object width: " << fwidth << " available width: " << ro - lo << endl;
         if (ro - lo < fwidth)
@@ -1526,7 +1644,7 @@
         int cw=0;
         if (style()->textIndent().isPercent())
             cw = containingBlock()->contentWidth();
-        right += style()->textIndent().minWidth(cw);
+        right -= style()->textIndent().minWidth(cw);
     }
 
     //kdDebug( 6040 ) << "rightOffset(" << y << ") = " << right << endl;
@@ -1537,7 +1655,8 @@
 RenderBlock::lineWidth(int y) const
 {
     //kdDebug( 6040 ) << "lineWidth(" << y << ")=" << rightOffset(y) - leftOffset(y) << endl;
-    return rightOffset(y) - leftOffset(y);
+    int result = rightOffset(y) - leftOffset(y);
+    return (result < 0) ? 0 : result;
 }
 
 int
@@ -1711,21 +1830,17 @@
     if (m_floatingObjects)
         m_floatingObjects->clear();
 
-    if (isFloating() || isPositioned() || isInlineBlockOrInlineTable()) return;
+    // we are done if the element defines a new block formatting context
+    if (flowAroundFloats() || isRoot() || isCanvas() || isFloatingOrPositioned() || isTableCell()) return;
 
     RenderObject *prev = previousSibling();
 
     // find the element to copy the floats from
     // pass non-flows
-    // pass fAF's unless they contain overhanging stuff
+    // pass fAF's
     bool parentHasFloats = false;
     while (prev) {
-        if (!prev->isRenderBlock() || prev->isFloating() || prev->isPositioned() ||
-            prev->style()->hidesOverflow() ||
-            (prev->style()->flowAroundFloats() &&
-             // A <table> or <ul> can have a height of 0, so its ypos may be the same
-             // as m_y.  That's why we have a <= and not a < here. -dwh
-             (static_cast<RenderBlock *>(prev)->floatBottom()+prev->yPos() <= m_y ))) {
+        if (!prev->isRenderBlock() || prev->isFloatingOrPositioned() || prev->flowAroundFloats()) {
             if ( prev->isFloating() && parent()->isRenderBlock() ) {
                 parentHasFloats = true;
             }
@@ -1754,9 +1869,6 @@
     if(!prev->isRenderBlock()) return;
     RenderBlock * flow = static_cast<RenderBlock *>(prev);
     if(!flow->m_floatingObjects) return;
-    if (style()->hidesOverflow() || (( style()->htmlHacks() || isTable() ) && style()->flowAroundFloats()))
-        return; // these elements don't allow floats from previous blocks to intrude into their space.
-
     if(flow->floatBottom() > offset)
         addOverHangingFloats( flow, xoffset, offset );
 }
@@ -1840,7 +1952,7 @@
 
 void RenderBlock::markAllDescendantsWithFloatsForLayout(RenderObject* floatToRemove)
 {
-    setLayouted( false );
+    setNeedsLayout(true);
 
     if (floatToRemove)
         removeFloatingObject(floatToRemove);
@@ -1850,19 +1962,19 @@
         for (RenderObject* child = firstChild(); child; child = child->nextSibling()) {
             if (isBlockFlow() && !child->isFloatingOrPositioned() &&
                 (floatToRemove ? child->containsFloat(floatToRemove) : child->hasFloats()))
-                child->markAllDescendantsWithFloatsForLayout();
+                child->markAllDescendantsWithFloatsForLayout(floatToRemove);
         }
     }
 }
 
-bool RenderBlock::checkClear(RenderObject *child)
+int RenderBlock::getClearDelta(RenderObject *child)
 {
-    //kdDebug( 6040 ) << "checkClear on child " << child << " oldheight=" << m_height << endl;
+    //kdDebug( 6040 ) << "getClearDelta on child " << child << " oldheight=" << m_height << endl;
     int bottom = 0;
     switch(child->style()->clear())
     {
         case CNONE:
-            return false;
+            return 0;
         case CLEFT:
             bottom = leftBottom();
             break;
@@ -1874,11 +1986,7 @@
             break;
     }
 
-    if (m_height < bottom) {
-        m_height = bottom;
-        return true;
-    }
-    return false;
+    return kMax(0, bottom-(child->yPos()));
 }
 
 bool RenderBlock::isPointInScrollbar(int _x, int _y, int _tx, int _ty)
@@ -2050,9 +2158,9 @@
 
         if (!result) break;
 
-        if (result->isText() || result->isBR() ||
+        if (!result->isPositioned() && (result->isText() || result->isBR() ||
             result->isFloating() || result->isReplaced() ||
-            result->isInlineFlow())
+            result->isInlineFlow()))
             break;
 
         current = result;
@@ -2064,6 +2172,11 @@
     return current;
 }
 
+// bidi.cpp defines the following functions too.
+// Maybe these should not be static, after all...
+
+#ifndef KDE_USE_FINAL
+
 static int getBPMWidth(int childValue, Length cssUnit)
 {
     if (!cssUnit.isVariable())
@@ -2085,6 +2198,7 @@
     result += leftSide ? child->borderLeft() : child->borderRight();
     return result;
 }
+#endif
 
 static void stripTrailingSpace(bool pre,
                                int& inlineMax, int& inlineMin,
@@ -2119,6 +2233,7 @@
 
     InlineMinMaxIterator childIterator(this, this);
     bool addedTextIndent = false; // Only gets added in once.
+    RenderObject* prevFloat = 0;
     while (RenderObject* child = childIterator.next())
     {
         normal = child->style()->whiteSpace() == NORMAL;
@@ -2202,6 +2317,18 @@
                     inlineMin = 0;
                 }
 
+                // Check our "clear" setting.  If we're supposed to clear the previous float, then
+                // go ahead and terminate maxwidth as well.
+                if (child->isFloating()) {
+                    if (prevFloat &&
+                        ((prevFloat->style()->floating() == FLEFT && (child->style()->clear() & CLEFT)) ||
+                         (prevFloat->style()->floating() == FRIGHT && (child->style()->clear() & CRIGHT)))) {
+                        m_maxWidth = kMax(inlineMax, (int)m_maxWidth);
+                        inlineMax = 0;
+                    }
+                    prevFloat = child;
+                }
+
                 // Add in text-indent.  This is added in only once.
                 int ti = 0;
                 if ( !addedTextIndent ) {
@@ -2339,6 +2466,8 @@
     bool nowrap = style()->whiteSpace() == NOWRAP;
 
     RenderObject *child = firstChild();
+    RenderObject* prevFloat = 0;
+    short int floatWidths = 0;
     while(child != 0)
     {
         // positioned children don't affect the minmaxwidth
@@ -2347,6 +2476,13 @@
             continue;
         }
 
+        if (prevFloat && (!child->isFloating() || 
+                          (prevFloat->style()->floating() == FLEFT && (child->style()->clear() & CLEFT)) ||
+                          (prevFloat->style()->floating() == FRIGHT && (child->style()->clear() & CRIGHT)))) {
+            m_maxWidth = kMax(floatWidths, m_maxWidth);
+            floatWidths = 0;
+        }
+
         Length ml = child->style()->marginLeft();
         Length mr = child->style()->marginRight();
 
@@ -2384,6 +2520,11 @@
         w = child->maxWidth() + margin;
 
         if(m_maxWidth < w) m_maxWidth = w;
+        
+        if (child->isFloating())
+            floatWidths += w;
+        else if (m_maxWidth < w)
+            m_maxWidth = w;
 
         // A very specific WinIE quirk.
         // Example:
@@ -2406,16 +2547,18 @@
             if (!cb->isTableCell())
                 m_maxWidth = BLOCK_MAX_WIDTH;
         }
-
+        if (child->isFloating())
+            prevFloat = child;
         child = child->nextSibling();
     }
+    m_maxWidth = kMax(floatWidths, m_maxWidth);
 }
 
 void RenderBlock::close()
 {
     if (lastChild() && lastChild()->isAnonymous())
         lastChild()->close();
-
+    updateFirstLetter();
     RenderFlow::close();
 }
 
@@ -2453,6 +2596,17 @@
     return 0;
 }
 
+bool RenderBlock::inRootBlockContext() const
+{
+    if (isTableCell() || isFloatingOrPositioned() || style()->hidesOverflow())
+        return false;
+
+    if (isRoot() || isCanvas())
+        return true;
+
+    return containingBlock()->inRootBlockContext();
+}
+
 const char *RenderBlock::renderName() const
 {
     if (isFloating())
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_block.h kdelibs/khtml/rendering/render_block.h
--- kdelibs.orig/khtml/rendering/render_block.h	Sun Jun 13 19:08:25 2004
+++ kdelibs/khtml/rendering/render_block.h	Wed Nov 24 14:51:42 2004
@@ -89,6 +89,7 @@
     virtual void removeChild(RenderObject *oldChild);
 
     virtual void setStyle(RenderStyle* _style);
+    void updateFirstLetter();
 
     virtual void layout();
     void layoutBlock( bool relayoutChildren );
@@ -103,11 +104,11 @@
     virtual RenderObject* layoutLegend(bool /*relayoutChildren*/) { return 0; };
 
     // the implementation of the following functions is in bidi.cpp
-    void bidiReorderLine(const BidiIterator &start, const BidiIterator &end);
-    BidiIterator findNextLineBreak(BidiIterator &start);
+    void bidiReorderLine(const BidiIterator &start, const BidiIterator &end, BidiState &bidi );
+    BidiIterator findNextLineBreak(BidiIterator &start, BidiState &info );
     InlineFlowBox* constructLine(const BidiIterator& start, const BidiIterator& end);
     InlineFlowBox* createLineBoxes(RenderObject* obj);
-    void computeHorizontalPositionsForLine(InlineFlowBox* lineBox, BidiContext* endEmbed);
+    void computeHorizontalPositionsForLine(InlineFlowBox* lineBox, BidiState &bidi);
     void computeVerticalPositionsForLine(InlineFlowBox* lineBox);
     // end bidi.cpp functions
 
@@ -121,7 +122,7 @@
     // called from lineWidth, to position the floats added in the last line.
     void positionNewFloats();
     void clearFloats();
-    bool checkClear(RenderObject *child);
+    int getClearDelta(RenderObject *child);
     virtual void markAllDescendantsWithFloatsForLayout(RenderObject* floatToRemove = 0);
 
     virtual bool hasFloats() const { return m_floatingObjects!=0; }
@@ -165,6 +166,8 @@
     virtual bool requiresLayer() const { return isRoot() || (!isTableCell() &&
         (isPositioned() || isRelPositioned() || style()->hidesOverflow())); }
 
+    bool inRootBlockContext() const;
+
 #ifdef ENABLE_DUMP
     virtual void printTree(int indent=0) const;
     virtual void dump(QTextStream &stream, const QString &ind) const;
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_body.cpp kdelibs/khtml/rendering/render_body.cpp
--- kdelibs.orig/khtml/rendering/render_body.cpp	Sun Jun 20 21:40:03 2004
+++ kdelibs/khtml/rendering/render_body.cpp	Wed Nov 17 14:59:17 2004
@@ -18,7 +18,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #include "rendering/render_body.h"
 #include "rendering/render_canvas.h"
@@ -45,8 +44,8 @@
 void RenderBody::setStyle(RenderStyle* style)
 {
 //     qDebug("RenderBody::setStyle()");
-    // ignore position: on body
-    if (style->htmlHacks() && style->position() != STATIC)
+    // ignore position: fixed on body
+    if (style->htmlHacks() && style->position() == FIXED)
         style->setPosition(STATIC);
 
     RenderBlock::setStyle(style);
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_body.h kdelibs/khtml/rendering/render_body.h
--- kdelibs.orig/khtml/rendering/render_body.h	Tue Feb 24 15:21:32 2004
+++ kdelibs/khtml/rendering/render_body.h	Wed Nov 17 14:43:03 2004
@@ -18,7 +18,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #ifndef RENDER_BODY
 #define RENDER_BODY
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_box.cpp kdelibs/khtml/rendering/render_box.cpp
--- kdelibs.orig/khtml/rendering/render_box.cpp	Wed Sep  8 00:20:23 2004
+++ kdelibs/khtml/rendering/render_box.cpp	Wed Nov 24 15:01:00 2004
@@ -3,7 +3,7 @@
  *
  * Copyright (C) 1999-2003 Lars Knoll (knoll@kde.org)
  *           (C) 1999 Antti Koivisto (koivisto@kde.org)
- *           (C) 2002 Apple Computer, Inc.
+ *           (C) 2002-2003 Apple Computer, Inc.
  *
  * This library is free software; you can redistribute it and/or
  * modify it under the terms of the GNU Library General Public
@@ -32,6 +32,7 @@
 #include "rendering/render_replaced.h"
 #include "rendering/render_canvas.h"
 #include "rendering/render_table.h"
+#include "rendering/render_inline.h"
 #include "rendering/render_block.h"
 #include "render_layer.h"
 #include "misc/htmlhashes.h"
@@ -69,8 +70,53 @@
     m_layer = 0;
 }
 
+RenderBlock* RenderBox::createAnonymousBlock()
+{
+    RenderStyle *newStyle = new RenderStyle();
+    newStyle->inheritFrom(style());
+    newStyle->setDisplay(BLOCK);
+
+    RenderBlock *newBox = new (renderArena()) RenderBlock(document() /* anonymous*/);
+    newBox->setStyle(newStyle);
+    return newBox;
+}
+
+void RenderBox::restructureParentFlow() {
+    if (!parent() || parent()->childrenInline() == isInline())
+        return;
+    // We have gone from not affecting the inline status of the parent flow to suddenly
+    // having an impact.  See if there is a mismatch between the parent flow's
+    // childrenInline() state and our state.
+    if (!isInline()) {
+        if (parent()->isRenderInline()) {
+            // We have to split the parent flow.
+            RenderInline* parentInline = static_cast<RenderInline*>(parent());
+            RenderBlock* newBox = parentInline->createAnonymousBlock();
+            
+            RenderFlow* oldContinuation = parent()->continuation();
+            parentInline->setContinuation(newBox);
+
+            RenderObject* beforeChild = nextSibling();
+            parent()->removeChildNode(this);
+            parentInline->splitFlow(beforeChild, newBox, this, oldContinuation);
+        }
+        else if (parent()->isRenderBlock())
+            static_cast<RenderBlock*>(parent())->makeChildrenNonInline();
+    }
+    else {
+        // An anonymous block must be made to wrap this inline.
+        RenderBlock* box = createAnonymousBlock();
+        parent()->insertChildNode(box, this);
+        box->appendChildNode(parent()->removeChildNode(this));
+    }
+}
+ 
 void RenderBox::setStyle(RenderStyle *_style)
 {
+    bool affectsParent = style() && isFloatingOrPositioned() &&
+         (!_style->isFloating() && _style->position() != ABSOLUTE && _style->position() != FIXED) &&
+         parent() && (parent()->isBlockFlow() || parent()->isInlineFlow());
+    
     RenderObject::setStyle(_style);
 
     // The root always paints its background/border.
@@ -84,6 +130,9 @@
     case INLINE_TABLE:
         setInline(true);
         break;
+    case RUN_IN:
+        if (isInline() && parent() && parent()->childrenInline()) 
+            break;
     default:
         setInline(false);
     }
@@ -129,6 +178,8 @@
     // ### outlineSize() and outlineOffset() not merged yet
     if (style()->outlineWidth() > 0 && style()->outlineWidth() > maximalOutlineSize(PaintActionOutline))
         static_cast<RenderCanvas*>(document()->renderer())->setMaximalOutlineSize(style()->outlineWidth());
+    if (affectsParent)
+        restructureParentFlow();
 }
 
 RenderBox::~RenderBox()
@@ -165,6 +216,9 @@
     short w = m_width - style()->borderLeftWidth() - style()->borderRightWidth();
     w -= paddingLeft() + paddingRight();
 
+    if (m_layer && style()->scrollsOverflow())
+        w -= m_layer->verticalScrollbarWidth();
+
     //kdDebug( 6040 ) << "RenderBox::contentWidth(2) = " << w << endl;
     return w;
 }
@@ -174,6 +228,9 @@
     int h = m_height - style()->borderTopWidth() - style()->borderBottomWidth();
     h -= paddingTop() + paddingBottom();
 
+    if (m_layer && style()->scrollsOverflow())
+        h -= m_layer->horizontalScrollbarHeight();
+
     return h;
 }
 
@@ -201,6 +258,23 @@
 {
     m_height = height;
 }
+
+int RenderBox::calcBoxHeight(int h) const
+{
+    if (style()->boxSizing() == CONTENT_BOX)
+        h += borderTop() + borderBottom() + paddingTop() + paddingBottom();
+
+    return h;
+}
+
+int RenderBox::calcBoxWidth(int w) const
+{
+    if (style()->boxSizing() == CONTENT_BOX)
+        w += borderLeft() + borderRight() + paddingLeft() + paddingRight();
+
+    return w;
+}
+
 // --------------------- painting stuff -------------------------------
 
 void RenderBox::paint(PaintInfo& i, int _tx, int _ty)
@@ -338,17 +412,25 @@
                     cx = _tx + xp;
                 else {
                     cx = _tx;
-                    sx = -xp;
-                    cw += xp;
+                    if (pixw == 0)
+                        sx = 0;
+                    else {
+                        sx = -xp;
+                        cw += xp;
+                    }
                 }
+                cx += bleft;
             } else {
-                cw = w-vpab;
+                cw = w;
                 cx = _tx;
-                sx =  pixw ? pixw - ((sptr->backgroundXPosition().minWidth(pw-pixw)) % pixw ) : 0;
+                if (pixw == 0)
+                    sx = 0;
+                else {
+                    sx =  pixw - ((sptr->backgroundXPosition().minWidth(pw-pixw)) % pixw );
+                    sx -= bleft % pixw;
+                }
             }
 
-            cx += bleft;
-
             if( (bgr == NO_REPEAT || bgr == REPEAT_X) && ph > pixh ) {
                 ch = pixh;
                 int yp = sptr->backgroundYPosition().minWidth(ph-pixh);
@@ -356,16 +438,26 @@
                     cy = _ty + yp;
                 else {
                     cy = _ty;
-                    sy = -yp;
-                    ch += yp;
+                    if (pixh == 0) {
+                        sy = 0;
+                    } else {
+                        sy = -yp;
+                        ch += yp;
+                    }
                 }
+
+                cy += borderTop();
             } else {
-                ch = h-hpab;
+                ch = h;
                 cy = _ty;
-                sy = pixh - ((sptr->backgroundYPosition().minWidth(ph-pixh)) % pixh );
+                if (pixh == 0) {
+                    sy = 0;
+                } else {
+                    sy = pixh - ((sptr->backgroundYPosition().minWidth(ph-pixh)) % pixh );
+                    sy -= borderTop() % pixh;
+                }
             }
 
-            cy += borderTop();
 	    if (layer())
 		layer()->scrollOffset(sx, sy);
         }
@@ -498,8 +590,7 @@
 
 void RenderBox::close()
 {
-    setMinMaxKnown(false);
-    setLayouted( false );
+    setNeedsLayoutAndMinMaxRecalc();
 }
 
 short RenderBox::containingBlockWidth() const
@@ -508,8 +599,7 @@
         return canvas()->view()->visibleWidth();
 
     RenderBlock* cb = containingBlock();
-    if ((style()->hidesOverflow() || ((style()->htmlHacks() || isTable()) && style()->flowAroundFloats()))
-            && style()->width().isVariable())
+    if (usesLineWidth())
         return cb->lineWidth(m_y);
     else
         return cb->contentWidth();
@@ -541,11 +631,11 @@
 
 void RenderBox::position(InlineBox* box, int /*from*/, int /*len*/, bool /*reverse*/)
 {
-#ifdef APPLE_CHANGES
     if (isPositioned()) {
         // Cache the x position only if we were an INLINE type originally.
         bool wasInline = style()->originalDisplay() == INLINE ||
                          style()->originalDisplay() == INLINE_TABLE;
+        
         if (wasInline && hasStaticX()) {
             // The value is cached in the xPos of the box.  We only need this value if
             // our object was inline originally, since otherwise it would have ended up underneath
@@ -559,16 +649,9 @@
             // in flow).  This value was cached in the yPos() of the box.
             m_staticY = box->yPos();
         }
-
-        box->detach(renderArena());
     }
-    else
-#endif
-    if (isReplaced()) {
+    else if (isReplaced())
         setPos( box->xPos(), box->yPos() );
-        // This seems wrong
-        // box->detach(renderArena());
-    }
 }
 
 void RenderBox::repaint(bool immediate)
@@ -648,13 +731,7 @@
         Length ml = style()->marginLeft();
         Length mr = style()->marginRight();
 
-        int cw;
-	RenderBlock *cb = containingBlock();
- 	if ( style()->flowAroundFloats() || style()->hidesOverflow() )
- 	    cw = cb->lineWidth( m_y );
- 	else
-	    cw = cb->contentWidth();
-
+	int cw = containingBlockWidth();
         if (cw<0) cw = 0;
 
         m_marginLeft = 0;
@@ -667,10 +744,8 @@
             m_marginRight = mr.minWidth(cw);
             if (treatAsReplaced)
             {
-                m_width = w.width(cw);
-                m_width += paddingLeft() + paddingRight() + style()->borderLeftWidth() + style()->borderRightWidth();
-
-                if(m_width < m_minWidth) m_width = m_minWidth;
+                m_width = calcBoxWidth(w.width(cw));
+                m_width = KMAX(m_width, m_minWidth);
             }
 
             return;
@@ -679,8 +754,7 @@
         {
             LengthType widthType, minWidthType, maxWidthType;
             if (treatAsReplaced) {
-                m_width = w.width(cw);
-                m_width += paddingLeft() + paddingRight() + borderLeft() + borderRight();
+                m_width = calcBoxWidth(w.width(cw));
                 widthType = w.type();
             } else {
                 m_width = calcWidthUsing(Width, cw, widthType);
@@ -712,7 +786,7 @@
 
         if (cw && cw != m_width + m_marginLeft + m_marginRight && !isFloating() && !isInline())
         {
-            if (cb->style()->direction()==LTR)
+            if (containingBlock()->style()->direction()==LTR)
                 m_marginRight = cw - m_width - m_marginLeft;
             else
                 m_marginLeft = cw - m_width - m_marginRight;
@@ -745,16 +819,13 @@
 
         // size to max width?
         if (sizesToMaxWidth()) {
-            if (width < m_minWidth)
-                width = m_minWidth;
-            if (width > m_maxWidth)
-                width = m_maxWidth;
+            width = KMAX(width, (int)m_minWidth);
+            width = KMIN(width, (int)m_maxWidth);
         }
     }
     else
     {
-        width = w.width(cw);
-        width += paddingLeft() + paddingRight() + borderLeft() + borderRight();
+        width = calcBoxWidth(w.width(cw));
     }
 
     return width;
@@ -770,18 +841,23 @@
     else
     {
         if ( (ml.isVariable() && mr.isVariable()) ||
-             (!ml.isVariable() && containingBlock()->style()->textAlign() == KONQ_CENTER ) )
+             (!ml.isVariable() && !mr.isVariable() &&
+                containingBlock()->style()->textAlign() == KHTML_CENTER) )
         {
             m_marginLeft = (cw - m_width)/2;
             if (m_marginLeft<0) m_marginLeft=0;
             m_marginRight = cw - m_width - m_marginLeft;
         }
-        else if (mr.isVariable())
+        else if (mr.isVariable() ||
+                 (!ml.isVariable() && containingBlock()->style()->direction() == RTL &&
+                  containingBlock()->style()->textAlign() == KHTML_LEFT))
         {
             m_marginLeft = ml.width(cw);
             m_marginRight = cw - m_width - m_marginLeft;
         }
-        else if (ml.isVariable())
+        else if (ml.isVariable() ||
+                 (!mr.isVariable() && containingBlock()->style()->direction() == LTR &&
+                  containingBlock()->style()->textAlign() == KHTML_RIGHT))
         {
             m_marginRight = mr.width(cw);
             m_marginLeft = cw - m_width - m_marginRight;
@@ -809,69 +885,156 @@
         calcAbsoluteVertical();
     else
     {
+        calcVerticalMargins();
+
+        // For tables, calculate margins only
+        if (isTable())
+            return;
+
         Length h;
-        if ( isReplaced() && !isBlockFlow() && !isInlineBlockOrInlineTable() )
+        bool treatAsReplaced = isReplaced() && !isInlineBlockOrInlineTable();
+        bool checkMinMaxHeight = false;
+
+        if ( treatAsReplaced )
             h = Length( calcReplacedHeight(), Fixed );
-        else
+        else {
             h = style()->height();
+            checkMinMaxHeight = true;
+        }
 
-        calcVerticalMargins();
+        int height;
+        if (checkMinMaxHeight) {
+            height = calcHeightUsing(style()->height());
+            int minH = calcHeightUsing(style()->minHeight());
+            int maxH = style()->maxHeight().value() == UNDEFINED ? height : calcHeightUsing(style()->maxHeight());
+            height = kMin(maxH, height);
+            height = kMax(minH, height);
+        }
+        else {
+            // The only times we don't check min/max height are when a fixed length has
+            // been given as an override.  Just use that.
+            height = calcBoxHeight(h.value());
+        }
 
-        // for tables, calculate margins only
-        if (isTable())
-            return;
+        if (height<m_height && !overhangingContents() && style()->overflow()==OVISIBLE)
+            setOverhangingContents();
 
-        if (!h.isVariable())
-        {
-            int fh=-1;
-            if (h.isFixed())
-                fh = h.value() + borderTop() + paddingTop() + borderBottom() + paddingBottom();
-            else if (h.isPercent()) {
-                // Handle a common case: nested 100% height <div>s.
-                // This is kind of a one-off hack rather than doing it right.
-                // Makes dbaron's z-index root bg testcases work. Bad dave. - dwh
-                RenderBlock* cb = containingBlock();
-                Length ch = containingBlock()->style()->height();
-                while (cb && !cb->isTableCell() && ch.isPercent() && ch.value() == 100) {
-                    cb = cb->containingBlock();
-                    ch = cb->style()->height();
-                }
+        m_height = height;
+    }
 
-                if (cb->isCanvas()) {
-                    // Don't allow this to affect the canvas' m_height member variable, since this
-                    // can get called while the canvas is still laying out its kids.
-                    // e.g., <html style="height:100%">etc. -dwh
-                    int oldHeight = cb->height();
-                    static_cast<RenderCanvas*>(cb)->calcHeight();
-                    fh = h.width(cb->height()) + borderTop() + paddingTop() + borderBottom() + paddingBottom();
-                    cb->setHeight(oldHeight);
-                }
-                else if (ch.isFixed())
-                    fh = h.width(ch.value()) + borderTop() + paddingTop() + borderBottom() + paddingBottom();
-            }
-            if (fh!=-1)
-            {
-                if (fh<m_height && !overhangingContents() && style()->overflow()==OVISIBLE)
-                    setOverhangingContents();
+    // Unfurling marquees override with the furled height.
+    if (style()->overflow() == OMARQUEE && m_layer && m_layer->marquee() &&
+        m_layer->marquee()->isUnfurlMarquee() && !m_layer->marquee()->isHorizontal()) {
+        m_layer->marquee()->setEnd(m_height);
+        m_height = kMin(m_height, m_layer->marquee()->unfurlPos());
+    }
 
-                m_height = fh;
-            }
+}
+
+int RenderBox::calcHeightUsing(const Length& h)
+{
+    if (!h.isVariable()) {
+        int height = -1;
+        if (h.isFixed())
+            height = h.value();
+        else if (h.isPercent())
+            height = calcPercentageHeight(h);
+        if (height != -1) {
+            height = calcBoxHeight(height);
+            return height;
         }
     }
+    return m_height;
+}
+
+int RenderBox::calcPercentageHeight(const Length& height)
+{
+    int result = -1;
+    RenderBlock* cb = containingBlock();
+    // Table cells violate what the CSS spec says to do with heights.  Basically we
+    // don't care if the cell specified a height or not.  We just always make ourselves
+    // be a percentage of the cell's current content height.
+    if (cb->isTableCell()) {
+        result = static_cast<RenderTableCell*>(cb)->cellPercentageHeight();
+        if (result == 0)
+            return -1;
+
+        // It is necessary to use the border-box to match WinIE's broken
+        // box model.  This is essential for sizing inside
+        // table cells using percentage heights.
+        if (style()->boxSizing() != BORDER_BOX) {
+            result -= (borderTop() + paddingTop() + borderBottom() + paddingBottom());
+            result = kMax(0, result);
+        }
+    }
+
+    // Otherwise we only use our percentage height if our containing block had a specified
+    // height.
+    else if (cb->style()->height().isFixed())
+        result = cb->style()->height().value();
+    else if (cb->style()->height().isPercent())
+        // We need to recur and compute the percentage height for our containing block.
+        result = cb->calcPercentageHeight(cb->style()->height());
+    else if (cb->isCanvas() || ( cb->isBody() && style()->htmlHacks() && 
+                                 cb->style()->height().isVariable() && !cb->isFloatingOrPositioned())) {
+        // Don't allow this to affect the block' m_height member variable, since this
+        // can get called while the block is still laying out its kids.
+        int oldHeight = cb->height();
+        cb->calcHeight();
+        result = cb->contentHeight();
+        cb->setHeight(oldHeight);
+        if (cb->isBody()) {
+            // In quirk mode, percentages of body apply at least to the canvas's visible height (minus pbm)
+            int margins = cb->collapsedMarginTop() + cb->collapsedMarginBottom();
+            int visHeight = canvas()->view()->visibleHeight();
+            RenderObject* p = cb->parent();
+            result = kMax(result, visHeight - 
+                        (margins + p->marginTop() + p->marginBottom() + 
+                         p->borderTop() + p->borderBottom() +
+                         p->paddingTop() + p->paddingBottom()));
+        }
+    }
+    if (result != -1) {
+        result = height.width(result);
+    }
+    return result;
 }
 
 short RenderBox::calcReplacedWidth() const
 {
-    Length w = style()->width();
+    int width = calcReplacedWidthUsing(Width);
+    int minW = calcReplacedWidthUsing(MinWidth);
+    int maxW = style()->maxWidth().value() == UNDEFINED ? width : calcReplacedWidthUsing(MaxWidth);
 
-    switch( w.type() ) {
+    if (width > maxW)
+        width = maxW;
+
+    if (width < minW)
+        width = minW;
+
+    return width;
+}
+
+int RenderBox::calcReplacedWidthUsing(WidthType widthType) const
+{
+    Length w;
+    if (widthType == Width)
+        w = style()->width();
+    else if (widthType == MinWidth)
+        w = style()->minWidth();
+    else
+        w = style()->maxWidth();
+
+    switch (w.type()) {
     case Fixed:
         return w.value();
     case Percent:
     {
         const int cw = containingBlockWidth();
-        if (cw > 0)
-            return w.minWidth(cw);
+        if (cw > 0) {
+            int result = w.minWidth(cw);
+            return result;
+        }
     }
     // fall through
     default:
@@ -881,10 +1044,31 @@
 
 int RenderBox::calcReplacedHeight() const
 {
-    const Length& h = style()->height();
+    int height = calcReplacedHeightUsing(Height);
+    int minH = calcReplacedHeightUsing(MinHeight);
+    int maxH = style()->maxHeight().value() == UNDEFINED ? height : calcReplacedHeightUsing(MaxHeight);
+
+    if (height > maxH)
+        height = maxH;
+
+    if (height < minH)
+        height = minH;
+
+    return height;
+}
+
+int RenderBox::calcReplacedHeightUsing(HeightType heightType) const
+{
+    Length h;
+    if (heightType == Height)
+        h = style()->height();
+    else if (heightType == MinHeight)
+        h = style()->minHeight();
+    else
+        h = style()->maxHeight();
     switch( h.type() ) {
     case Percent:
-        return availableHeight();
+        return availableHeightUsing(h);
     case Fixed:
         return h.value();
     default:
@@ -894,8 +1078,11 @@
 
 int RenderBox::availableHeight() const
 {
-    Length h = style()->height();
+    return availableHeightUsing(style()->height());
+}
 
+int RenderBox::availableHeightUsing(const Length& h) const
+{
     if (h.isFixed())
         return h.value();
 
@@ -912,7 +1099,7 @@
     }
 
     if (h.isPercent())
-        return h.width(containingBlock()->availableHeight());
+       return h.width(containingBlock()->availableHeight());
 
     return containingBlock()->availableHeight();
 }
@@ -952,16 +1139,16 @@
     const int AUTO = -666666;
     int l,r,w,ml,mr,cw;
 
-    RenderObject* cb = containingBlock();
+    RenderObject* cb = container();
     int pab = borderLeft()+ borderRight()+ paddingLeft()+ paddingRight();
 
     l=r=ml=mr=w=AUTO;
-    cw = containingBlock()->width();
+    cw = containingBlockWidth() + cb->paddingLeft() + cb->paddingRight();
 
     if(!style()->left().isVariable())
-        l = style()->left().width(cw) + cb->borderLeft();
+        l = style()->left().width(cw);
     if(!style()->right().isVariable())
-        r = style()->right().width(cw) + cb->borderRight();
+        r = style()->right().width(cw);
     if(!style()->width().isVariable())
         w = style()->width().width(cw);
     else if (isReplaced())
@@ -975,7 +1162,7 @@
     //qDebug("h1: w=%d, l=%d, r=%d, ml=%d, mr=%d",w,l,r,ml,mr);
 
     int static_distance=0;
-    if ((style()->direction()==LTR && (l==AUTO && r==AUTO ))
+    if ((parent()->style()->direction()==LTR && (l==AUTO && r==AUTO ))
             || style()->left().isStatic())
     {
         // calc hypothetical location in the normal flow
@@ -985,24 +1172,22 @@
 
         // all positioned elements are blocks, so that
         // would be at the left edge
+
+        static_distance = m_staticX - cb->borderLeft(); // Should already have been set through layout of the parent().
         for (RenderObject* po = parent(); po && po != cb; po = po->parent())
             static_distance += po->xPos();
 
-        static_distance += parent()->paddingLeft() + parent()->borderLeft();
-
         if (l==AUTO || style()->left().isStatic())
             l = static_distance;
     }
 
-    else if ((style()->direction()==RTL && (l==AUTO && r==AUTO ))
+    else if ((parent()->style()->direction()==RTL && (l==AUTO && r==AUTO ))
             || style()->right().isStatic())
     {
-        static_distance = cw - parent()->width();
-
+        static_distance = m_staticX - cb->borderLeft(); // Should already have been set through layout of the parent().
         for (RenderObject* po = parent(); po && po != cb; po = po->parent())
-            static_distance -= po->xPos();
+            static_distance += po->xPos();
 
-        static_distance -= parent()->paddingRight() + parent()->borderRight();
         if (r==AUTO || style()->right().isStatic())
             r = static_distance;
     }
@@ -1086,7 +1271,7 @@
     m_marginLeft = ml;
     m_marginRight = mr;
     short old_m_x = m_x;
-    m_x = l + ml;
+    m_x = l + ml + cb->borderLeft();
     if ( old_m_x != m_x && m_layer)
         m_layer->updateLayerPosition();
 
@@ -1110,22 +1295,21 @@
 
     int pab = borderTop()+borderBottom()+paddingTop()+paddingBottom();
 
-    RenderObject* cb = containingBlock();
+    RenderObject* cb = container();
 
     Length hl = cb->style()->height();
     if (hl.isFixed())
-        ch = hl.value() + cb->paddingTop() + cb->paddingBottom()
-	     + cb->borderTop() + cb->borderBottom();
+        ch = hl.value() + cb->paddingTop() + cb->paddingBottom();
     else if (cb->isCanvas() || cb->isRoot())
         ch = cb->availableHeight();
     else
-        ch = cb->height();
+        ch = cb->height() - cb->borderTop() - cb->borderBottom();
 
 
     if(!style()->top().isVariable())
-        t = style()->top().width(ch) + cb->borderTop();
+        t = style()->top().width(ch);
     if(!style()->bottom().isVariable())
-        b = style()->bottom().width(ch) + cb->borderBottom();
+        b = style()->bottom().width(ch);
     // for tables "auto" means shrink-to-fit
     if ( isTable() && style()->height().isVariable() )
         h = m_height - pab;
@@ -1134,11 +1318,11 @@
         h = style()->height().width(ch);
 
         if (m_height-pab > h) {
-            if ( isRenderBlock() )
+            if ( isRenderBlock() ) {
               static_cast<RenderBlock*>( this )->setOverflowHeight( m_height + pab - ( paddingBottom() + borderBottom() ) );
-
+            }
+            m_height = h + pab;
         }
-	m_height = h + pab;
     }
     else if (isReplaced())
         h = intrinsicHeight();
@@ -1155,21 +1339,10 @@
         // used for 1) top=static-position
         //          2) top, bottom, height are all auto -> calc top -> 3.
         //          3) precalc for case 2 below
-
-        RenderObject* ro = previousSibling();
-        while ( ro && ro->isPositioned())
-            ro = ro->previousSibling();
-
-        if (ro)
-            static_top = ro->yPos()+ro->marginBottom()+ro->height();
-        else {
-            // we're only dealing with blocklevel positioned elements
-            // currently, so this is easy
-            for (RenderObject* po = parent(); po && po != cb; po = po->parent())
-                static_top += po->yPos();
-
-            static_top += parent()->paddingTop() + parent()->borderTop();
-        }
+        static_top = m_staticY -cb->borderTop(); // Should already have been set through layout of the parent().
+        RenderObject* po = parent();
+        for (; po && po != cb; po = po->parent())
+            static_top += po->yPos();
 
         if (h==AUTO || style()->top().isStatic())
             t = static_top;
@@ -1251,7 +1424,7 @@
 
     m_marginTop = mt;
     m_marginBottom = mb;
-    m_y = t + mt;
+    m_y = t + mt + cb->borderTop();
 
     //qDebug("v: m_height = %d, h=%d, t=%d, b=%d, mt=%d, mb=%d, m_y=%d",m_height,h,t,b,mt,mb,m_y);
 }
@@ -1364,13 +1537,15 @@
         // ### regard direction
 	switch (s->textAlign()) {
 	case LEFT:
+	case KHTML_LEFT:
 	case TAAUTO:	// ### find out what this does
 	case JUSTIFY:
 	    break;
 	case CENTER:
-	case KONQ_CENTER:
+	case KHTML_CENTER:
 	    _x += contentWidth() / 2;
 	    break;
+	case KHTML_RIGHT:
 	case RIGHT:
 	    _x += contentWidth();
 	    break;
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_box.h kdelibs/khtml/rendering/render_box.h
--- kdelibs.orig/khtml/rendering/render_box.h	Tue Jun 22 05:30:53 2004
+++ kdelibs/khtml/rendering/render_box.h	Fri Nov 19 12:23:02 2004
@@ -3,7 +3,7 @@
  *
  * Copyright (C) 1999-2003 Lars Knoll (knoll@kde.org)
  *           (C) 1999 Antti Koivisto (koivisto@kde.org)
- *           (C) 2002 Apple Computer, Inc.
+ *           (C) 2002-2003 Apple Computer, Inc.
  *
  * This library is free software; you can redistribute it and/or
  * modify it under the terms of the GNU Library General Public
@@ -20,7 +20,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #ifndef RENDER_BOX_H
 #define RENDER_BOX_H
@@ -30,6 +29,9 @@
 namespace khtml {
 
 enum WidthType { Width, MinWidth, MaxWidth };
+enum HeightType { Height, MinHeight, MaxHeight };
+
+class RenderBlock;
 
 class RenderBox : public RenderContainer
 {
@@ -52,7 +54,7 @@
 
     virtual InlineBox* createInlineBox(bool makePlaceHolderBox, bool isRootLineBox);
     virtual void deleteInlineBoxes(RenderArena* arena=0);
-    
+
     virtual void detach();
 
     virtual short minWidth() const { return m_minWidth; }
@@ -109,10 +111,18 @@
     virtual void caretPos(int offset, int flags, int &_x, int &_y, int &width, int &height);
 
     void calcHorizontalMargins(const Length& ml, const Length& mr, int cw);
+    RenderBlock* createAnonymousBlock();
 
-private:
+protected:
+    int calcBoxWidth(int w) const;
+    int calcBoxHeight(int h) const;
 
     int calcWidthUsing(WidthType widthType, int cw, LengthType& lengthType);
+    int calcHeightUsing(const Length& height);
+    int calcReplacedWidthUsing(WidthType widthType) const;
+    int calcReplacedHeightUsing(HeightType heightType) const;
+    int calcPercentageHeight(const Length& height);
+    int availableHeightUsing(const Length& h) const;
 
 protected:
     virtual void paintBoxDecorations(PaintInfo& paintInfo, int _tx, int _ty);
@@ -134,6 +144,8 @@
     QRect getOverflowClipRect(int tx, int ty);
     QRect getClipRect(int tx, int ty);
 
+    void restructureParentFlow();
+
 
     // the actual height of the contents + borders + padding
     int m_height;
@@ -169,7 +181,7 @@
      * when its inner content isn't contextually relevant
      * (e.g replaced or positioned elements)
      */
-    InlineBox *m_placeHolderBox; 
+    InlineBox *m_placeHolderBox;
 };
 
 
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_br.cpp kdelibs/khtml/rendering/render_br.cpp
--- kdelibs.orig/khtml/rendering/render_br.cpp	Thu Apr 15 13:53:14 2004
+++ kdelibs/khtml/rendering/render_br.cpp	Wed Nov 17 14:43:03 2004
@@ -18,7 +18,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #include "render_br.h"
 
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_br.h kdelibs/khtml/rendering/render_br.h
--- kdelibs.orig/khtml/rendering/render_br.h	Thu Apr 15 13:53:14 2004
+++ kdelibs/khtml/rendering/render_br.h	Wed Nov 17 14:43:03 2004
@@ -18,7 +18,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #ifndef RENDER_BR_H
 #define RENDER_BR_H
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_canvas.cpp kdelibs/khtml/rendering/render_canvas.cpp
--- kdelibs.orig/khtml/rendering/render_canvas.cpp	Wed Sep  8 15:59:14 2004
+++ kdelibs/khtml/rendering/render_canvas.cpp	Wed Nov 10 10:00:27 2004
@@ -124,8 +124,10 @@
     if (m_printingMode)
        m_minWidth = m_width;
 
+    setChildNeedsLayout(true);
+    setMinMaxKnown(false);
     for(RenderObject* c = firstChild(); c; c = c->nextSibling())
-        c->setLayouted(false);
+        c->setChildNeedsLayout(true);
 
 #ifdef SPEED_DEBUG
     QTime qt;
@@ -201,7 +203,8 @@
 #endif
 
     layer()->resize( kMax( docW,int( m_width ) ), kMax( docH,m_height ) );
-    setLayouted();
+
+    setNeedsLayout(false);
 }
 
 bool RenderCanvas::absolutePosition(int &xPos, int &yPos, bool f)
@@ -287,7 +290,7 @@
         if (immediate) {
             //m_view->resizeContents(docWidth(), docHeight());
             m_view->unscheduleRepaint();
-            if (!layouted()) {
+            if (needsLayout()) {
                 m_view->scheduleRelayout();
                 return;
             }
@@ -648,3 +651,28 @@
 // kdDebug(6040) << "w " << w << " layer(" << layer->renderer()->renderName() << ")->width " << layer->width() << " rm " << (layer->xPos() + layer->width()) << " width() " << layer->renderer()->width() << " rw " << layer->renderer()->effectiveWidth() << endl;
     return w;
 }
+
+// The idea here is to take into account what object is moving the pagination point, and
+// thus choose the best place to chop it.
+void RenderCanvas::setBestTruncatedAt(int y, RenderObject *forRenderer, bool forcedBreak)
+{
+    // Nobody else can set a page break once we have a forced break.
+    if (m_forcedPageBreak) return;
+
+    kdDebug(6040) << "RenderCanvas::setBestTruncatedAt for " << forRenderer->renderName()
+                  << " at " << y << ((forcedBreak) ? " (forced)" : "") << endl;
+
+    // Forced breaks always win over unforced breaks.
+    if (forcedBreak) {
+        m_forcedPageBreak = true;
+        m_bestTruncatedAt = y;
+        return;
+    }
+
+    // prefer the widest object who tries to move the pagination point
+    int width = forRenderer->width();
+    if (width > m_truncatorWidth) {
+        m_truncatorWidth = width;
+        m_bestTruncatedAt = y;
+    }
+}
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_canvas.h kdelibs/khtml/rendering/render_canvas.h
--- kdelibs.orig/khtml/rendering/render_canvas.h	Tue May 25 18:49:52 2004
+++ kdelibs/khtml/rendering/render_canvas.h	Wed Nov 10 10:00:27 2004
@@ -62,19 +62,17 @@
     bool printingMode() const { return m_printingMode; }
     void setPrintImages(bool enable) { m_printImages = enable; }
     bool printImages() const { return m_printImages; }
-#ifdef APPLE_CHANGES
-    void setTruncatedAt(int y) { m_truncatedAt = y; m_bestTruncatedAt = m_truncatorWidth = 0; }
-    void setBestTruncatedAt(int y, RenderObject *forRenderer);
+
+    void setTruncatedAt(int y) { m_truncatedAt = y; m_bestTruncatedAt = m_truncatorWidth = 0; m_forcedPageBreak = false; }
+    void setBestTruncatedAt(int y, RenderObject *forRenderer, bool forcedBreak = false);
+    int truncatedAt() const { return m_truncatedAt; }
     int bestTruncatedAt() const { return m_bestTruncatedAt; }
 private:
     int m_bestTruncatedAt;
     int m_truncatorWidth;
-public:
-#else
-     void setTruncatedAt(int y) { m_truncatedAt = y; }
-#endif
-    int truncatedAt() const { return m_truncatedAt; }
+    bool m_forcedPageBreak;
 
+public:
     virtual void setWidth( int width ) { m_rootWidth = m_width = width; }
     virtual void setHeight( int height ) { m_rootHeight = m_height = height; }
 
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_container.cpp kdelibs/khtml/rendering/render_container.cpp
--- kdelibs.orig/khtml/rendering/render_container.cpp	Mon Feb 16 18:37:42 2004
+++ kdelibs/khtml/rendering/render_container.cpp	Wed Nov 17 14:59:17 2004
@@ -4,7 +4,7 @@
  * Copyright (C) 2001-2003 Lars Knoll (knoll@kde.org)
  *           (C) 2001 Antti Koivisto (koivisto@kde.org)
  *           (C) 2000-2003 Dirk Mueller (mueller@kde.org)
- *           (C) 2002 Apple Computer, Inc.
+ *           (C) 2002-2003 Apple Computer, Inc.
  *
  * This library is free software; you can redistribute it and/or
  * modify it under the terms of the GNU Library General Public
@@ -21,7 +21,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 
 //#define DEBUG_LAYOUT
@@ -106,6 +105,12 @@
             //kdDebug( 6040 ) << "adding cell" << endl;
             if ( !isTableRow() )
                 needsTable = true;
+            // I'm not 100% sure this is the best way to fix this, but without this
+            // change we recurse infinitely when trying to render the CSS2 test page:
+            // http://www.bath.ac.uk/%7Epy8ieh/internet/eviltests/htmlbodyheadrendering2.html.
+            if ( isTableCell() && !firstChild() && !newChild->isTableCell() )
+                needsTable = false;
+
             break;
         case NONE:
             // RenderHtml and some others can have display:none
@@ -136,18 +141,20 @@
 	// just add it...
 	insertChildNode(newChild, beforeChild);
     }
-    newChild->setLayouted( false );
-    newChild->setMinMaxKnown( false );
+//    newChild->setNeedsLayoutAndMinMaxRecalc();
 }
 
 RenderObject* RenderContainer::removeChildNode(RenderObject* oldChild)
 {
     KHTMLAssert(oldChild->parent() == this);
 
+    // So that we'll get the appropriate dirty bit set (either that a normal flow child got yanked or
+    // that a positioned child got yanked).  We also repaint, so that the area exposed when the child
+    // disappears gets repainted properly.
     if ( document()->renderer() ) {
+        oldChild->setNeedsLayoutAndMinMaxRecalc();
+        oldChild->repaint();
 
-        oldChild->setLayouted( false );
-        oldChild->setMinMaxKnown( false );
         // Keep our layer hierarchy updated.
         oldChild->removeLayers(enclosingLayer());
 
@@ -186,8 +193,7 @@
     oldChild->setNextSibling(0);
     oldChild->setParent(0);
 
-    setLayouted( false );
-    setMinMaxKnown( false );
+//    setNeedsLayoutAndMinMaxRecalc();
 
     return oldChild;
 }
@@ -332,8 +338,9 @@
     RenderLayer* layer = enclosingLayer();
     newChild->addLayers(layer, findNextLayer(layer, newChild));
 
-    newChild->setLayouted( false );
-    newChild->setMinMaxKnown( false );
+    newChild->setNeedsLayoutAndMinMaxRecalc(); // Goes up the containing block hierarchy.
+    if (!normalChildNeedsLayout())
+        setChildNeedsLayout(true); // We may supply the static position for an absolute positioned child.
 }
 
 void RenderContainer::insertChildNode(RenderObject* child, RenderObject* beforeChild)
@@ -362,23 +369,23 @@
     RenderLayer* layer = enclosingLayer();
     child->addLayers(layer, findNextLayer(layer, child));
 
-    child->setLayouted( false );
-    child->setMinMaxKnown( false );
+    child->setNeedsLayoutAndMinMaxRecalc();
+    if (!normalChildNeedsLayout())
+        setChildNeedsLayout(true); // We may supply the static position for an absolute positioned child.
 }
 
 
 void RenderContainer::layout()
 {
-    KHTMLAssert( !layouted() );
+    KHTMLAssert( needsLayout() );
     KHTMLAssert( minMaxKnown() );
 
     RenderObject *child = firstChild();
     while( child ) {
-	if( !child->layouted() )
-	    child->layout();
-	child = child->nextSibling();
+        child->layoutIfNeeded();
+        child = child->nextSibling();
     }
-    setLayouted();
+    setNeedsLayout(false);
 }
 
 void RenderContainer::removeLeftoverAnonymousBoxes()
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_container.h kdelibs/khtml/rendering/render_container.h
--- kdelibs.orig/khtml/rendering/render_container.h	Tue Nov 11 04:39:05 2003
+++ kdelibs/khtml/rendering/render_container.h	Wed Nov 17 14:43:03 2004
@@ -18,7 +18,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #ifndef render_container_h
 #define render_container_h
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_flow.cpp kdelibs/khtml/rendering/render_flow.cpp
--- kdelibs.orig/khtml/rendering/render_flow.cpp	Wed Sep  8 00:20:23 2004
+++ kdelibs/khtml/rendering/render_flow.cpp	Wed Nov 10 10:00:27 2004
@@ -235,8 +235,6 @@
 
         // Now invalidate a rectangle.
         int ow = style() ? style()->outlineWidth() : 0;
-        if (style()->display() == COMPACT)
-            left -= m_x;
         containingBlock()->repaintRectangle(-ow+left, -ow+top,
                                             width()+ow*2, height()+ow*2, immediate);
     }
@@ -311,14 +309,3 @@
 
     return left;
 }
-
-RenderBlock* RenderFlow::createAnonymousBlock()
-{
-    RenderStyle *newStyle = new RenderStyle();
-    newStyle->inheritFrom(style());
-    newStyle->setDisplay(BLOCK);
-
-    RenderBlock *newBox = new (renderArena()) RenderBlock(document() /* anonymous*/);
-    newBox->setStyle(newStyle);
-    return newBox;
-}
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_flow.h kdelibs/khtml/rendering/render_flow.h
--- kdelibs.orig/khtml/rendering/render_flow.h	Tue Jun 22 05:30:53 2004
+++ kdelibs/khtml/rendering/render_flow.h	Wed Nov 10 10:00:27 2004
@@ -65,8 +65,6 @@
 
     virtual InlineBox* createInlineBox(bool makePlaceHolderBox, bool isRootLineBox);
 
-    RenderBlock* createAnonymousBlock();
-
     void paintLineBoxBackgroundBorder(PaintInfo& pI, int _tx, int _ty);
     void paintLineBoxDecorations(PaintInfo& p, int _tx, int _ty);
 
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_form.cpp kdelibs/khtml/rendering/render_form.cpp
--- kdelibs.orig/khtml/rendering/render_form.cpp	Sun Oct  3 01:40:29 2004
+++ kdelibs/khtml/rendering/render_form.cpp	Fri Nov 19 11:30:52 2004
@@ -20,7 +20,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 
 #include <kcompletionbox.h>
@@ -35,6 +34,7 @@
 #include <kreplace.h>
 #include <kreplacedialog.h>
 #include <kspell.h>
+#include <kurlcompletion.h>
 #include <kwin.h>
 
 #include <qstyle.h>
@@ -83,7 +83,7 @@
 
 void RenderFormElement::layout()
 {
-    KHTMLAssert( !layouted() );
+    KHTMLAssert( needsLayout() );
     KHTMLAssert( minMaxKnown() );
 
     // minimum height
@@ -97,7 +97,7 @@
                      m_height-borderTop()-borderBottom()-paddingTop()-paddingBottom());
 
     if ( !style()->width().isPercent() )
-        setLayouted();
+        setNeedsLayout(false);
 }
 
 // -------------------------------------------------------------------------
@@ -149,6 +149,10 @@
 void RenderCheckBox::slotStateChanged(int state)
 {
     element()->setChecked(state == 2);
+
+    ref();
+    element()->onChange();
+    deref();
 }
 
 // -------------------------------------------------------------------------------
@@ -159,6 +163,7 @@
     QRadioButton* b = new QRadioButton(view()->viewport(), "__khtml");
     b->setMouseTracking(true);
     setQWidget(b);
+    connect(b,SIGNAL(toggled(bool)),this,SLOT(slotToggled(bool)));
 }
 
 void RenderRadioButton::updateFromElement()
@@ -181,6 +186,13 @@
     RenderButton::calcMinMaxWidth();
 }
 
+void RenderRadioButton::slotToggled(bool)
+{
+    ref();
+    element()->onChange();
+    deref();
+}
+
 // -------------------------------------------------------------------------------
 
 
@@ -245,10 +257,8 @@
     QString oldText = static_cast<QPushButton*>(m_widget)->text();
     QString newText = rawText();
     static_cast<QPushButton*>(m_widget)->setText(newText);
-    if ( oldText != newText ) {
-        setMinMaxKnown(false);
-	setLayouted(false);
-    }
+    if ( oldText != newText )
+        setNeedsLayoutAndMinMaxRecalc();
     RenderFormElement::updateFromElement();
 }
 
@@ -574,9 +584,9 @@
     RenderObject* legend = findLegend();
     if (legend) {
         if (relayoutChildren)
-            legend->setLayouted( false );
-        if ( !legend->layouted() )
-            legend->layout();
+            legend->setNeedsLayout(true);
+        legend->layoutIfNeeded();
+
         int xPos = borderLeft() + paddingLeft() + legend->marginLeft();
         if (style()->direction() == RTL)
             xPos = m_width - paddingRight() - borderRight() - legend->width() - legend->marginRight();
@@ -709,6 +719,9 @@
 {
     KURLRequester* w = new KURLRequester( view()->viewport(), "__khtml" );
 
+    w->setMode(KFile::File | KFile::ExistingOnly);
+    w->completionObject()->setDir(KGlobalSettings::documentPath());
+
     connect(w->lineEdit(), SIGNAL(returnPressed()), this, SLOT(slotReturnPressed()));
     connect(w->lineEdit(), SIGNAL(textChanged(const QString &)),this,SLOT(slotTextChanged(const QString &)));
 
@@ -934,14 +947,14 @@
             else if (listItems[listIndex]->id() == ID_OPTION) {
                 HTMLOptionElementImpl* optElem = static_cast<HTMLOptionElementImpl*>(listItems[listIndex]);
                 QString text = optElem->text().string();
-
-                // Prefer label if set
-                DOMString label = optElem->getAttribute(ATTR_LABEL);
-                if (!label.isEmpty())
-                    text = label.string();
-
                 if (optElem->parentNode()->id() == ID_OPTGROUP)
+                {
+                    // Prefer label if set
+                    DOMString label = optElem->getAttribute(ATTR_LABEL);
+                    if (!label.isEmpty())
+                        text = label.string();
                     text = QString::fromLatin1("    ")+text;
+                }
 
                 if(m_useListBox) {
                     KListBox *l = static_cast<KListBox*>(m_widget);
@@ -963,8 +976,7 @@
             KComboBox *that = static_cast<KComboBox*>(m_widget);
             that->setFont( that->font() );
         }
-        setMinMaxKnown(false);
-        setLayouted(false);
+        setNeedsLayoutAndMinMaxRecalc();
         m_optionsChanged = false;
     }
 
@@ -988,10 +1000,8 @@
 
     // ### ugly HACK FIXME!!!
     setMinMaxKnown();
-    if ( !layouted() )
-        layout();
-    setLayouted( false );
-    setMinMaxKnown( false );
+    layoutIfNeeded();
+    setNeedsLayoutAndMinMaxRecalc();
     // ### end FIXME
 
     RenderFormElement::calcMinMaxWidth();
@@ -999,7 +1009,7 @@
 
 void RenderSelect::layout( )
 {
-    KHTMLAssert(!layouted());
+    KHTMLAssert(needsLayout());
     KHTMLAssert(minMaxKnown());
 
     // ### maintain selection properly between type/size changes, and work
@@ -1018,6 +1028,10 @@
             height = kMax(height, p->height(p->listBox()));
             p = p->next();
         }
+        if ( !height )
+            height = w->fontMetrics().height();
+        if ( !width )
+            width = w->fontMetrics().width( 'x' );
 
         int size = m_size;
         // check if multiple and size was not given or invalid
@@ -1041,7 +1055,7 @@
     }
 
     /// uuh, ignore the following line..
-    setLayouted( false );
+    setNeedsLayout(true);
     RenderFormElement::layout();
 
     // and now disable the widget in case there is no <option> given
@@ -1143,7 +1157,7 @@
 
 KListBox* RenderSelect::createListBox()
 {
-    KListBox *lb = new KListBox(view()->viewport());
+    KListBox *lb = new KListBox(view()->viewport(), "__khtml");
     lb->setSelectionMode(m_multiple ? QListBox::Extended : QListBox::Single);
     // ### looks broken
     //lb->setAutoMask(true);
@@ -1171,7 +1185,7 @@
         KListBox *listBox = static_cast<KListBox*>(m_widget);
         for (i = 0; i < int(listItems.size()); i++)
             listBox->setSelected(i,listItems[i]->id() == ID_OPTION &&
-                                static_cast<HTMLOptionElementImpl*>(listItems[i])->selected());
+                                 static_cast<HTMLOptionElementImpl*>(listItems[i])->selected());
     }
     else {
         bool found = false;
@@ -1198,7 +1212,7 @@
 // -------------------------------------------------------------------------
 
 TextAreaWidget::TextAreaWidget(int wrap, QWidget* parent)
-    : KTextEdit(parent), m_findDlg(0), m_find(0), m_repDlg(0), m_replace(0)
+    : KTextEdit(parent, "__khtml"), m_findDlg(0), m_find(0), m_repDlg(0), m_replace(0)
 {
     setCheckSpellingEnabled( true );
     setTabChangesFocus( true );
@@ -1535,7 +1549,7 @@
     : RenderFormElement(element)
 {
     scrollbarsStyled = false;
-    
+
     TextAreaWidget *edit = new TextAreaWidget(element->wrap(), view());
     setQWidget(edit);
 
@@ -1583,7 +1597,7 @@
 void RenderTextArea::setStyle(RenderStyle* _style)
 {
     bool unsubmittedFormChange = element()->m_unsubmittedFormChange;
-    
+
     RenderFormElement::setStyle(_style);
 
     widget()->blockSignals(true);
@@ -1592,13 +1606,13 @@
     widget()->blockSignals(false);
 
     scrollbarsStyled = false;
-    
+
     element()->m_unsubmittedFormChange = unsubmittedFormChange;
 }
 
 void RenderTextArea::layout()
 {
-    KHTMLAssert( !layouted() );
+    KHTMLAssert( needsLayout() );
 
     RenderFormElement::layout();
 
@@ -1616,13 +1630,16 @@
     TextAreaWidget* w = static_cast<TextAreaWidget*>(m_widget);
     w->setReadOnly(element()->readOnly());
     QString elementText = element()->value().string();
-    if ( elementText != text() )
+    if ( elementText != w->text() )
     {
         w->blockSignals(true);
         int line, col;
         w->getCursorPosition( &line, &col );
+        int cx = w->contentsX();
+        int cy = w->contentsY();
         w->setText( elementText );
         w->setCursorPosition( line, col );
+        w->scrollBy( cx, cy );
         w->blockSignals(false);
     }
     element()->m_dirtyvalue = false;
@@ -1637,38 +1654,38 @@
     RenderFormElement::close();
 }
 
-static QString expandLF(const QString& s) 
-{ 
-    // LF -> CRLF 
-    unsigned crs = s.contains( '\n' ); 
+static QString expandLF(const QString& s)
+{
+    // LF -> CRLF
+    unsigned crs = s.contains( '\n' );
     if (crs == 0)
 	return s;
-    unsigned len = s.length(); 
- 
+    unsigned len = s.length();
+
     QString r;
-    r.reserve(len + crs + 1); 
-    unsigned pos2 = 0; 
-    for(unsigned pos = 0; pos < len; pos++) 
-    { 
-       QChar c = s.at(pos); 
-       switch(c.unicode()) 
-       { 
-         case '\n': 
-           r[pos2++] = '\r'; 
-           r[pos2++] = '\n'; 
-           break; 
- 
-         case '\r': 
-           break; 
- 
-         default: 
-           r[pos2++]= c; 
-           break; 
-       } 
-    } 
+    r.reserve(len + crs + 1);
+    unsigned pos2 = 0;
+    for(unsigned pos = 0; pos < len; pos++)
+    {
+       QChar c = s.at(pos);
+       switch(c.unicode())
+       {
+         case '\n':
+           r[pos2++] = '\r';
+           r[pos2++] = '\n';
+           break;
+
+         case '\r':
+           break;
+
+         default:
+           r[pos2++]= c;
+           break;
+       }
+    }
     r.squeeze();
-    return r; 
-} 
+    return r;
+}
 
 QString RenderTextArea::text()
 {
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_form.h kdelibs/khtml/rendering/render_form.h
--- kdelibs.orig/khtml/rendering/render_form.h	Mon Aug  9 10:58:12 2004
+++ kdelibs/khtml/rendering/render_form.h	Wed Nov 17 14:59:17 2004
@@ -20,7 +20,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #ifndef RENDER_FORM_H
 #define RENDER_FORM_H
@@ -149,6 +148,7 @@
 
 class RenderRadioButton : public RenderButton
 {
+    Q_OBJECT
 public:
     RenderRadioButton(DOM::HTMLInputElementImpl* node);
 
@@ -160,6 +160,9 @@
     virtual bool handleEvent(const DOM::EventImpl&) { return false; }
 
     QRadioButton *widget() const { return static_cast<QRadioButton*>(m_widget); }
+
+public slots:
+    virtual void slotToggled(bool);
 };
 
 // -------------------------------------------------------------------------
@@ -286,7 +289,7 @@
 {
 public:
     RenderFieldset(DOM::HTMLGenericFormElementImpl *element);
-    
+
     virtual const char *renderName() const { return "RenderFieldSet"; }
     virtual RenderObject* layoutLegend(bool relayoutChildren);
     virtual void setStyle(RenderStyle* _style);
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_frames.cpp kdelibs/khtml/rendering/render_frames.cpp
--- kdelibs.orig/khtml/rendering/render_frames.cpp	Sat Oct  2 00:06:43 2004
+++ kdelibs/khtml/rendering/render_frames.cpp	Wed Nov 17 14:59:17 2004
@@ -4,6 +4,7 @@
  * Copyright (C) 1999 Lars Knoll (knoll@kde.org)
  *           (C) 2000 Simon Hausmann <hausmann@kde.org>
  *           (C) 2000 Stefan Schimanski (1Stein@gmx.de)
+ *           (C) 2003 Apple Computer, Inc.
  *
  * This library is free software; you can redistribute it and/or
  * modify it under the terms of the GNU Library General Public
@@ -20,7 +21,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 //#define DEBUG_LAYOUT
 
@@ -99,7 +99,7 @@
 
 void RenderFrameSet::layout( )
 {
-    KHTMLAssert( !layouted() );
+    KHTMLAssert( needsLayout() );
     KHTMLAssert( minMaxKnown() );
 
     if ( !parent()->isFrameSet() ) {
@@ -272,7 +272,7 @@
     }
     RenderContainer::layout();
  end2:
-    setLayouted();
+    setNeedsLayout(false);
 }
 
 void RenderFrameSet::positionFrames()
@@ -302,8 +302,8 @@
       if ((m_gridLayout[1][c] != child->width()) || (m_gridLayout[0][r] != child->height())) {
           child->setWidth( m_gridLayout[1][c] );
           child->setHeight( m_gridLayout[0][r] );
-          child->setLayouted(false);
-	  child->layout();
+          child->setNeedsLayout(true);
+          child->layout();
       }
 
       xPos += m_gridLayout[1][c] + element()->border();
@@ -318,11 +318,11 @@
   }
 
   // all the remaining frames are hidden to avoid ugly
-  // spurious nonlayouted frames
+  // spurious unflowed frames
   while ( child ) {
       child->setWidth( 0 );
       child->setHeight( 0 );
-      child->setLayouted();
+      child->setNeedsLayout(false);
 
       child = child->nextSibling();
   }
@@ -330,7 +330,7 @@
 
 bool RenderFrameSet::userResize( MouseEventImpl *evt )
 {
-    if (!layouted()) return false;
+    if (needsLayout()) return false;
 
   bool res = false;
   int _x = evt->clientX();
@@ -427,7 +427,7 @@
 
     // this just schedules the relayout
     // important, otherwise the moving indicator is not correctly erased
-    setLayouted(false);
+    setNeedsLayout(true);
   }
 
   KHTMLView *view = canvas()->view();
@@ -468,8 +468,8 @@
 
 bool RenderFrameSet::canResize( int _x, int _y )
 {
-    // if we're not layouted, the gridLayout doesn't contain useful data
-    if (!layouted() || !m_gridLayout[0] || !m_gridLayout[1] ) return false;
+    // if we haven't received a layout, then the gridLayout doesn't contain useful data yet
+    if (needsLayout() || !m_gridLayout[0] || !m_gridLayout[1] ) return false;
 
     // check if we're over a horizontal or vertical boundary
     int pos = m_gridLayout[1][0];
@@ -517,13 +517,13 @@
 #ifdef DEBUG_LAYOUT
     kdDebug(6031) << "RenderPart::setWidget()" << endl;
 #endif
+
     setQWidget( widget );
     widget->setFocusPolicy(QWidget::WheelFocus);
     if(widget->inherits("KHTMLView"))
         connect( widget, SIGNAL( cleared() ), this, SLOT( slotViewCleared() ) );
 
-    setLayouted( false );
-    setMinMaxKnown( false );
+    setNeedsLayoutAndMinMaxRecalc();
 
     // make sure the scrollbars are set correctly for restore
     // ### find better fix
@@ -593,14 +593,13 @@
   QString url;
   KHTMLPart *part = m_view->part();
 
-  setMinMaxKnown(false);
-  setLayouted(false);
+  setNeedsLayoutAndMinMaxRecalc();
 
   if (element()->id() == ID_IFRAME) {
 
       HTMLIFrameElementImpl *o = static_cast<HTMLIFrameElementImpl *>(element());
       url = o->url.string();
-      if( !o->getDocument()->isURLAllowed(url) ) return;
+      if (!o->getDocument()->isURLAllowed(url)) return;
       part->requestFrame( this, url, o->name.string(), QStringList(), true );
   // ### this should be constant true - move iframe to somewhere else
   } else {
@@ -667,42 +666,39 @@
           if (!objbase->getAttribute(ATTR_HEIGHT).isEmpty())
               params.append( QString::fromLatin1("HEIGHT=\"%1\"").arg( objbase->getAttribute(ATTR_HEIGHT).string() ) );
 
-          if (url.isEmpty() && objbase->classId.startsWith("java:")) {
-              serviceType = "application/x-java-applet";
-              url = objbase->classId.mid(5);
-          }
           if ( embed ) {
               // render embed object
               url = embed->url;
               serviceType = embed->serviceType;
-          }
-          else {
+          } else if (url.isEmpty() && objbase->classId.startsWith("java:")) {
+              serviceType = "application/x-java-applet";
+              url = objbase->classId.mid(5);
+          } else
               serviceType = objbase->serviceType;
-              if(serviceType.isEmpty() && !objbase->classId.isEmpty()) {
+          if(serviceType.isEmpty() && !objbase->classId.isEmpty()) {
 
-                  // We have a clsid, means this is activex (Niko)
-                  serviceType = "application/x-activex-handler";
+              // We have a clsid, means this is activex (Niko)
+              serviceType = "application/x-activex-handler";
 
-                  if(objbase->classId.contains(QString::fromLatin1("D27CDB6E-AE6D-11cf-96B8-444553540000"))) {
-                      // It is ActiveX, but the nsplugin system handling
-                      // should also work, that's why we don't override the
-                      // serviceType with application/x-activex-handler
-                      // but let the KTrader in khtmlpart::createPart() detect
-                      // the user's preference: launch with activex viewer or
-                      // with nspluginviewer (Niko)
-                      serviceType = "application/x-shockwave-flash";
-                  }
-                  else if(objbase->classId.contains(QString::fromLatin1("CFCDAA03-8BE4-11cf-B84B-0020AFBBCCFA")))
-                      serviceType = "audio/x-pn-realaudio-plugin";
-                  else if(objbase->classId.contains(QString::fromLatin1("8AD9C840-044E-11D1-B3E9-00805F499D93")) ||
-                          objbase->classId.contains(QString::fromLatin1("CAFEEFAC-0014-0000-0000-ABCDEFFEDCBA")))
-                      serviceType = "application/x-java-applet";
+              if(objbase->classId.contains(QString::fromLatin1("D27CDB6E-AE6D-11cf-96B8-444553540000"))) {
+                  // It is ActiveX, but the nsplugin system handling
+                  // should also work, that's why we don't override the
+                  // serviceType with application/x-activex-handler
+                  // but let the KTrader in khtmlpart::createPart() detect
+                  // the user's preference: launch with activex viewer or
+                  // with nspluginviewer (Niko)
+                  serviceType = "application/x-shockwave-flash";
+              }
+              else if(objbase->classId.contains(QString::fromLatin1("CFCDAA03-8BE4-11cf-B84B-0020AFBBCCFA")))
+                  serviceType = "audio/x-pn-realaudio-plugin";
+              else if(objbase->classId.contains(QString::fromLatin1("8AD9C840-044E-11D1-B3E9-00805F499D93")) ||
+                      objbase->classId.contains(QString::fromLatin1("CAFEEFAC-0014-0000-0000-ABCDEFFEDCBA")))
+                  serviceType = "application/x-java-applet";
 
-                  else
-                      kdDebug(6031) << "ActiveX classId " << objbase->classId << endl;
+              else
+                  kdDebug(6031) << "ActiveX classId " << objbase->classId << endl;
 
-                  // TODO: add more plugins here
-              }
+              // TODO: add more plugins here
           }
       }
       if ((url.isEmpty() && !embed) || !document()->isURLAllowed(url) || !part->requestObject( this, url, serviceType, params ))
@@ -829,7 +825,7 @@
 
 void RenderPartObject::layout( )
 {
-    KHTMLAssert( !layouted() );
+    KHTMLAssert( needsLayout() );
     KHTMLAssert( minMaxKnown() );
 
     calcWidth();
@@ -837,7 +833,7 @@
 
     RenderPart::layout();
 
-    setLayouted();
+    setNeedsLayout(false);
 }
 
 void RenderPartObject::slotViewCleared()
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_frames.h kdelibs/khtml/rendering/render_frames.h
--- kdelibs.orig/khtml/rendering/render_frames.h	Mon Aug  9 10:58:12 2004
+++ kdelibs/khtml/rendering/render_frames.h	Wed Nov 17 14:59:17 2004
@@ -19,7 +19,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #ifndef __render_frames_h__
 #define __render_frames_h__
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_image.cpp kdelibs/khtml/rendering/render_image.cpp
--- kdelibs.orig/khtml/rendering/render_image.cpp	Sun May  9 22:42:26 2004
+++ kdelibs/khtml/rendering/render_image.cpp	Wed Nov 17 14:59:17 2004
@@ -4,6 +4,7 @@
  * Copyright (C) 1999-2003 Lars Knoll (knoll@kde.org)
  *           (C) 1999 Antti Koivisto (koivisto@kde.org)
  *           (C) 2000-2003 Dirk Mueller (mueller@kde.org)
+ *           (C) 2003 Apple Computer, Inc.
  *
  * This library is free software; you can redistribute it and/or
  * modify it under the terms of the GNU Library General Public
@@ -20,7 +21,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 //#define DEBUG_LAYOUT
 
@@ -171,10 +171,10 @@
 
     if(needlayout)
     {
-        setMinMaxKnown(false);
-        setLayouted(false);
-//         kdDebug( 6040 ) << "m_width: : " << m_width << " height: " << m_height << endl;
-//         kdDebug( 6040 ) << "Image: size " << m_width << "/" << m_height << endl;
+        if (!selfNeedsLayout())
+            setNeedsLayout(true);
+        if (minMaxKnown())
+            setMinMaxKnown(false);
     }
     else
     {
@@ -350,7 +350,7 @@
 
 void RenderImage::layout()
 {
-    KHTMLAssert(!layouted());
+    KHTMLAssert( needsLayout());
     KHTMLAssert( minMaxKnown() );
 
     short oldwidth = m_width;
@@ -380,7 +380,7 @@
     if ( m_width != oldwidth || m_height != oldheight )
         resizeCache = QPixmap();
 
-    setLayouted();
+    setNeedsLayout(false);
 }
 
 void RenderImage::notifyFinished(CachedObject *finishedObj)
@@ -437,7 +437,11 @@
     if (tempimage && image != tempimage && oimage != tempimage )
         tempimage->deref(this);
 
-    berrorPic = image->isErrorImage();
+    // if the loading finishes we might get an error and then the image is deleted
+    if ( image )
+        berrorPic = image->isErrorImage();
+    else
+        berrorPic = true;
 }
 
 void RenderImage::updateFromElement()
@@ -470,7 +474,7 @@
 {
      // "complete" means that the image has been loaded
      // but also that its width/height (contentWidth(),contentHeight()) have been calculated.
-     return image && image->valid_rect().size() == image->pixmap_size() && layouted();
+     return image && image->valid_rect().size() == image->pixmap_size() && !needsLayout();
 }
 
 short RenderImage::calcReplacedWidth() const
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_image.h kdelibs/khtml/rendering/render_image.h
--- kdelibs.orig/khtml/rendering/render_image.h	Thu Apr 15 13:53:14 2004
+++ kdelibs/khtml/rendering/render_image.h	Wed Nov 17 14:59:17 2004
@@ -19,7 +19,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #ifndef RENDER_IMAGE_H
 #define RENDER_IMAGE_H
@@ -57,6 +56,7 @@
 
     bool complete() const;
 
+    CachedObject *contentObject() { return image; }
     void setContentObject( CachedObject* );
 
     // hook to keep RendeObject::m_inline() up to date
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_inline.cpp kdelibs/khtml/rendering/render_inline.cpp
--- kdelibs.orig/khtml/rendering/render_inline.cpp	Sun May  9 22:42:26 2004
+++ kdelibs/khtml/rendering/render_inline.cpp	Wed Nov 10 10:00:28 2004
@@ -68,8 +68,6 @@
 
 void RenderInline::addChildToFlow(RenderObject* newChild, RenderObject* beforeChild)
 {
-    setLayouted( false );
-
     // Make sure we don't append things after :after-generated content if we have it.
     if (!beforeChild && lastChild() && lastChild()->style()->styleType() == RenderStyle::AFTER)
         beforeChild = lastChild();
@@ -107,8 +105,7 @@
 
     RenderBox::addChild(newChild,beforeChild);
 
-    newChild->setLayouted( false );
-    newChild->setMinMaxKnown( false );
+    newChild->setNeedsLayoutAndMinMaxRecalc();
 }
 
 RenderInline* RenderInline::cloneInline(RenderFlow* src)
@@ -133,9 +130,8 @@
     while (o) {
         RenderObject* tmp = o;
         o = tmp->nextSibling();
-        clone->appendChildNode(removeChildNode(tmp));
-        tmp->setLayouted(false);
-        tmp->setMinMaxKnown(false);
+        clone->addChildToFlow(removeChildNode(tmp), 0);
+        tmp->setNeedsLayoutAndMinMaxRecalc();
     }
 
     // Hook |clone| up as the continuation of the middle block.
@@ -152,7 +148,7 @@
         clone = cloneInline(curr);
 
         // Insert our child clone as the first child.
-        clone->appendChildNode(cloneChild);
+        clone->addChildToFlow(cloneChild, 0);
 
         // Hook the clone up as a continuation of |curr|.
         RenderFlow* oldCont = curr->continuation();
@@ -166,8 +162,7 @@
             RenderObject* tmp = o;
             o = tmp->nextSibling();
             clone->appendChildNode(curr->removeChildNode(tmp));
-            tmp->setLayouted(false);
-            tmp->setMinMaxKnown(false);
+            tmp->setNeedsLayoutAndMinMaxRecalc();
         }
 
         // Keep walking up the chain.
@@ -221,8 +216,7 @@
             RenderObject* no = o;
             o = no->nextSibling();
             pre->appendChildNode(block->removeChildNode(no));
-            no->setLayouted(false);
-            no->setMinMaxKnown(false);
+            no->setNeedsLayoutAndMinMaxRecalc();
         }
     }
 
@@ -242,16 +236,15 @@
     // XXXdwh is any of this even necessary? I don't think it is.
     pre->close();
     pre->setPos(0, -500000);
-    pre->setLayouted(false);
+    pre->setNeedsLayout(true);
     newBlockBox->close();
     newBlockBox->setPos(0, -500000);
-    newBlockBox->setLayouted(false);
+    newBlockBox->setNeedsLayout(true);
     post->close();
     post->setPos(0, -500000);
-    post->setLayouted(false);
+    post->setNeedsLayout(true);
 
-    block->setLayouted(false);
-    block->setMinMaxKnown(false);
+    block->setNeedsLayoutAndMinMaxRecalc();
 }
 
 void RenderInline::paint(PaintInfo& i,
@@ -326,107 +319,497 @@
 }
 #endif
 
+/**
+ * Appends the given coordinate-pair to the point-array if it is not
+ * equal to the last element.
+ * @param pointArray point-array
+ * @param pnt point to append
+ * @return \c true if \c pnt has actually been appended
+ */
+inline static bool appendIfNew(QValueVector<QPoint> &pointArray, const QPoint &pnt)
+{
+//   if (!pointArray.isEmpty()) kdDebug(6040) << "appifnew: " << pointArray.back() << " == " << pnt << ": " << (pointArray.back() == pnt) << endl;
+//   else kdDebug(6040) << "appifnew: " << pnt << " (unconditional)" << endl;
+    if (!pointArray.isEmpty() && pointArray.back() == pnt) return false;
+    pointArray.append(pnt);
+    return true;
+}
+
+/**
+ * Does spike-reduction on the given point-array's stack-top.
+ *
+ * Spikes are path segments of which one goes forward, and the sucessor
+ * goes backward on the predecessor's segment:
+ *
+ * 2      0      1
+ * x------x<-----x
+ * (0 is stack-top in point-array)
+ *
+ * This will be reduced to
+ * 1      0
+ * x------x
+ *
+ * Preconditions:
+ * - No other spikes exist in the whole point-array except at most
+ *   one at the end
+ * - No two succeeding points are ever equal
+ * - For each two succeeding points either p1.x == p2.x or p1.y == p2.y holds
+ *   true
+ * - No such spike exists where 2 is situated between 0 and 1.
+ *
+ * Postcondition:
+ * - No spikes exist in the whole point-array
+ *
+ * If no spike is found, the point-array is left unchanged.
+ * @return \c true if an actual reduction was done
+ */
+inline static bool reduceSpike(QValueVector<QPoint> &pointArray)
+{
+    if (pointArray.size() < 3) return false;
+    QValueVector<QPoint>::Iterator it = pointArray.end();
+    QPoint p0 = *--it;
+    QPoint p1 = *--it;
+    QPoint p2 = *--it;
+
+    bool elide = false;
+
+    if (p0.x() == p1.x() && p1.x() == p2.x()
+        && (p1.y() < p0.y() && p0.y() < p2.y()
+            || p2.y() < p0.y() && p0.y() < p1.y()
+            || p1.y() < p2.y() && p2.y() < p0.y()
+            || p0.y() < p2.y() && p2.y() < p1.y()
+            || (elide = p2.y() == p0.y() && p0.y() < p1.y())
+            || (elide = p1.y() < p0.y() && p0.y() == p2.y()))
+        || p0.y() == p1.y() && p1.y() == p2.y()
+        && (p1.x() < p0.x() && p0.x() < p2.x()
+            || p2.x() < p0.x() && p0.x() < p1.x()
+            || p1.x() < p2.x() && p2.x() < p0.x()
+            || p0.x() < p2.x() && p2.x() < p1.x()
+            || (elide = p2.x() == p0.x() && p0.x() < p1.x())
+            || (elide = p1.x() < p0.x() && p0.x() == p2.x())))
+    {
+//     kdDebug(6040) << "spikered p2" << (elide ? " (elide)" : "") << ": " << p2 << " p1: " << p1 << " p0: " << p0 << endl;
+        pointArray.pop_back(); pointArray.pop_back();
+        if (!elide)
+            pointArray.push_back(p0);
+        return true;
+    }
+    return false;
+}
+
+/**
+ * Reduces segment separators.
+ *
+ * A segment separator separates a segment into two segments, thus causing
+ * two adjacent segment with the same orientation.
+ *
+ * 2       1     0
+ * x-------x---->x
+ * (0 means stack-top)
+ *
+ * Here, 1 is a segment separator. As segment separators not only make
+ * the line drawing algorithm inefficient, but also make the spike-reduction
+ * fail, they must be eliminated:
+ *
+ * 1             0
+ * x------------>x
+ *
+ * Preconditions:
+ * - No other segment separators exist in the whole point-array except
+ *   at most one at the end
+ * - No two succeeding points are ever equal
+ * - For each two succeeding points either p1.x == p2.x or p1.y == p2.y holds
+ *   true
+ * - No such spike exists where 2 is situated between 0 and 1.
+ *
+ * Postcondition:
+ * - No segment separators exist in the whole point-array
+ *
+ * If no segment separator is found at the end of the point-array, it is
+ * left unchanged.
+ * @return \c true if a segment separator was actually reduced.
+ */
+inline static bool reduceSegmentSeparator(QValueVector<QPoint> &pointArray)
+{
+    if (pointArray.size() < 3) return false;
+    QValueVector<QPoint>::Iterator it = pointArray.end();
+    QPoint p0 = *--it;
+    QPoint p1 = *--it;
+    QPoint p2 = *--it;
+//     kdDebug(6040) << "checking p2: " << p2 << " p1: " << p1 << " p0: " << p0 << endl;
+
+    if (p0.x() == p1.x() && p1.x() == p2.x()
+        && (p2.y() < p1.y() && p1.y() < p0.y()
+            || p0.y() < p1.y() && p1.y() < p2.y())
+        || p0.y() == p1.y() && p1.y() == p2.y()
+        && (p2.x() < p1.x() && p1.x() < p0.x()
+            || p0.x() < p1.x() && p1.x() < p2.x()))
+    {
+//     kdDebug(6040) << "segred p2: " << p2 << " p1: " << p1 << " p0: " << p0 << endl;
+        pointArray.pop_back(); pointArray.pop_back();
+        pointArray.push_back(p0);
+        return true;
+    }
+    return false;
+}
+
+/**
+ * Appends the given point to the point-array, doing necessary reductions to
+ * produce a path without spikes and segment separators.
+ */
+static void appendPoint(QValueVector<QPoint> &pointArray, QPoint &pnt)
+{
+  if (!appendIfNew(pointArray, pnt)) return;
+//   kdDebug(6040) << "appendPoint: appended " << pnt << endl;
+  reduceSegmentSeparator(pointArray)
+  || reduceSpike(pointArray);
+}
+
+/**
+ * Traverses the horizontal inline boxes and appends the point coordinates to
+ * the given array.
+ * @param box inline box
+ * @param pointArray array collecting coordinates
+ * @param bottom \c true, collect bottom coordinates, \c false, collect top
+ * 	coordinates.
+ * @param limit lower limit that an y-coordinate must at least reach. Note
+ *	that limit designates the highest y-coordinate for \c bottom, and
+ *	the lowest for !\c bottom.
+ */
+static void collectHorizontalBoxCoordinates(InlineBox *box,
+                                            QValueVector<QPoint> &pointArray,
+                                            bool bottom, int limit = -500000)
+{
+//   kdDebug(6000) << "collectHorizontalBoxCoordinates: " << endl;
+    int y = box->yPos() + bottom*box->height();
+    if (limit != -500000 && (bottom ? y < limit : y > limit))
+        y = limit;
+    int x = box->xPos() + bottom*box->width();
+    QPoint newPnt(x, y);
+    // Add intersection point if point-array not empty.
+    if (!pointArray.isEmpty()) {
+        QPoint lastPnt = pointArray.back();
+        QPoint insPnt(newPnt.x(), lastPnt.y());
+//         kdDebug(6040) << "left: " << lastPnt << " == " << insPnt << ": " << (insPnt == lastPnt) << endl;
+        appendPoint(pointArray, insPnt);
+    }
+    // Insert starting point of box
+    appendPoint(pointArray, newPnt);
+
+    newPnt.rx() += bottom ? -box->width() : box->width();
+
+    if (box->isInlineFlowBox()) {
+        InlineFlowBox *flowBox = static_cast<InlineFlowBox *>(box);
+        for (InlineBox *b = bottom ? flowBox->lastChild() : flowBox->firstChild(); b; b = bottom ? b->prevOnLine() : b->nextOnLine()) {
+            // Don't let boxes smaller than this flow box' height influence
+            // the vertical position of the outline if they have a different
+            // x-coordinate
+            int l2;
+            if (b->xPos() != box->xPos() && b->xPos() + b->width() != box->xPos() + box->width())
+              l2 = y;
+            else
+              l2 = limit;
+            collectHorizontalBoxCoordinates(b, pointArray, bottom, l2);
+        }
+
+        // Add intersection point if flow box contained any children
+        if (flowBox->firstChild()) {
+            QPoint lastPnt = pointArray.back();
+            QPoint insPnt(lastPnt.x(), newPnt.y());
+//             kdDebug(6040) << "right: " << lastPnt << " == " << insPnt << ": " << (insPnt == lastPnt) << endl;
+            appendPoint(pointArray, insPnt);
+        }
+    }
+
+    // Insert ending point of box
+    appendPoint(pointArray, newPnt);
+
+//     kdDebug(6000) << "collectHorizontalBoxCoordinates: " << "ende" << endl;
+}
+
+/**
+ * Checks whether the given line box' extents and the following line box'
+ * extents are disjount (i. e. do not share the same x-coordinate range).
+ * @param line line box
+ * @param toBegin \c true, compare with preceding line box, \c false, with
+ *	succeeding
+ * @return \c true if this and the next box are disjoint
+ */
+inline static bool lineBoxesDisjoint(InlineRunBox *line, bool toBegin)
+{
+  InlineRunBox *next = toBegin ? line->prevLineBox() : line->nextLineBox();
+  return !next || next->xPos() + next->width() < line->xPos()
+               || next->xPos() > line->xPos() + line->width();
+}
+
+/**
+ * Traverses the vertical outer borders of the given render flow's line
+ * boxes and appends the point coordinates to the given point array.
+ * @param line line box to begin traversal
+ * @param pointArray point array
+ * @param left \c true, traverse the left vertical coordinates,
+ *	\c false, traverse the right vertical coordinates.
+ * @param lastline if not 0, returns the pointer to the last line box traversed
+ */
+static void collectVerticalBoxCoordinates(InlineRunBox *line,
+                                          QValueVector<QPoint> &pointArray,
+                                          bool left, InlineRunBox **lastline = 0)
+{
+    InlineRunBox *last = 0;
+    for (InlineRunBox* curr = line; curr && !last; curr = left ? curr->prevLineBox() : curr->nextLineBox()) {
+        InlineBox *root = curr;
+
+        bool isLast = lineBoxesDisjoint(curr, left);
+        if (isLast) last = curr;
+
+        if (root != line && !isLast)
+            while (root->parent()) root = root->parent();
+        QPoint newPnt(curr->xPos() + !left*curr->width(),
+                      left ? root->topOverflow() : root->bottomOverflow());
+        if (!pointArray.isEmpty()) {
+            QPoint lastPnt = pointArray.back();
+            QPoint insPnt(newPnt.x(), lastPnt.y());
+//         kdDebug(6040) << "left: " << lastPnt << " == " << insPnt << ": " << (insPnt == lastPnt) << endl;
+            appendPoint(pointArray, insPnt);
+        }
+        appendPoint(pointArray, newPnt);
+    }
+    if (lastline) *lastline = last;
+}
+
+/**
+ * Links up the end of the given point-array such that the starting point
+ * is not a segment separator.
+ *
+ * To achieve this, improper points are removed from the beginning of
+ * the point-array (by changing the array's starting iterator), and
+ * proper ones appended to the point-array's back.
+ *
+ * @param pointArray point-array
+ * @return actual begin of point array
+ */
+static QPoint *linkEndToBegin(QValueVector<QPoint> &pointArray)
+{
+    uint index = 0;
+    Q_ASSERT(pointArray.size() >= 3);
+
+    // if first and last points match, ignore the last one.
+    bool linkup = false; QPoint linkupPnt;
+    if (pointArray.front() == pointArray.back()) {
+        linkupPnt = pointArray.back();
+        pointArray.pop_back();
+        linkup = true;
+    }
+
+    const QPoint *it = pointArray.begin() + index;
+    QPoint pfirst = *it;
+    QPoint pnext = *++it;
+    QPoint plast = pointArray.back();
+//     kdDebug(6040) << "linkcheck plast: " << plast << " pfirst: " << pfirst << " pnext: " << pnext << endl;
+
+    if (plast.x() == pfirst.x() && pfirst.x() == pnext.x()
+        || plast.y() == pfirst.y() && pfirst.y() == pnext.y()) {
+
+        ++index;
+        appendPoint(pointArray, pfirst);
+        appendPoint(pointArray, pnext);
+    } else if (linkup)
+      pointArray.push_back(linkupPnt);
+    return pointArray.begin() + index;
+}
+
 void RenderInline::paintOutlines(QPainter *p, int _tx, int _ty)
 {
     if (style()->outlineWidth() == 0 || style()->outlineStyle() <= BHIDDEN)
         return;
 
-    QValueVector<QRect> rects;
+    // We may have to draw more than one outline path as they may be
+    // disjoint.
+    for (InlineRunBox *curr = firstLineBox(); curr; curr = curr->nextLineBox()) {
+        QValueVector<QPoint> path;
+
+        // collect topmost outline
+        collectHorizontalBoxCoordinates(curr, path, false);
+        // collect right outline
+        collectVerticalBoxCoordinates(curr, path, false, &curr);
+        // collect bottommost outline
+        collectHorizontalBoxCoordinates(curr, path, true);
+        // collect left outline
+        collectVerticalBoxCoordinates(curr, path, true);
 
-    rects.append(QRect(0,0,0,0));
-    for (InlineRunBox* curr = firstLineBox(); curr; curr = curr->nextLineBox()) {
-        rects.append(QRect(curr->xPos(), curr->yPos(), curr->width(), curr->height()));
+        const QPoint *begin = linkEndToBegin(path);
+
+        // paint the outline
+        paintOutlinePath(p, _tx, _ty, begin, path.end(), BSLeft, -1, BSTop);
     }
-    rects.append(QRect(0,0,0,0));
+}
 
-    for (unsigned int i = 1; i < rects.count() - 1; i++)
-        paintOutline(p, _tx, _ty, rects[i-1], rects[i], rects[i+1]);
+template<class T> inline void kSwap(T &a1, T &a2)
+{
+    T tmp = a2;
+    a2 = a1;
+    a1 = tmp;
 }
 
-void RenderInline::paintOutline(QPainter *p, int tx, int ty, const QRect &lastline, const QRect &thisline, const QRect &nextline)
+enum BSOrientation { BSHorizontal, BSVertical };
+
+/**
+ * Returns the orientation of the given border side.
+ */
+inline BSOrientation bsOrientation(RenderObject::BorderSide bs)
+{
+    switch (bs) {
+    case RenderObject::BSTop:
+    case RenderObject::BSBottom:
+        return BSHorizontal;
+    case RenderObject::BSLeft:
+    case RenderObject::BSRight:
+        return BSVertical;
+    }
+    return BSHorizontal;	// make gcc happy (sigh)
+}
+
+/**
+ * Determines the new border side by evaluating the new direction as determined
+ * by the given coordinates, the old border side, and the relative direction.
+ *
+ * The relative direction specifies whether the old border side meets with the
+ * straight given by the coordinates from below (negative), or above (positive).
+ */
+inline RenderObject::BorderSide newBorderSide(RenderObject::BorderSide oldBS, int direction, const QPoint &last, const QPoint &cur)
+{
+    bool below = direction < 0;
+    if (last.x() == cur.x()) {	// new segment is vertical
+        bool t = oldBS == RenderObject::BSTop;
+        bool b = oldBS == RenderObject::BSBottom;
+        if ((t || b) && last.y() != cur.y())
+            return (cur.y() < last.y()) ^ (t && below || b && !below)
+                    ? RenderObject::BSLeft : RenderObject::BSRight;
+    } else /*if (last.y() == cur.y())*/ {	// new segment is horizontal
+        bool l = oldBS == RenderObject::BSLeft;
+        bool r = oldBS == RenderObject::BSRight;
+        if ((l || r) && last.x() != cur.x())
+            return (cur.x() < last.x()) ^ (l && below || r && !below)
+                    ? RenderObject::BSTop : RenderObject::BSBottom;
+    }
+    return oldBS;			// same direction
+}
+
+/**
+ * Draws an outline segment between the given two points.
+ * @param o render object
+ * @param p painter
+ * @param tx absolute x-coordinate of containing block
+ * @param ty absolute y-coordinate of containing block
+ * @param p1 starting point
+ * @param p2 end point
+ * @param prevBS border side of previous segment
+ * @param curBS border side of this segment
+ * @param nextBS border side of next segment
+ */
+static void paintOutlineSegment(RenderObject *o, QPainter *p, int tx, int ty,
+                                const QPoint &p1, const QPoint &p2,
+                                RenderObject::BorderSide prevBS,
+                                RenderObject::BorderSide curBS,
+                                RenderObject::BorderSide nextBS)
+{
+    int ow = o->style()->outlineWidth();
+    EBorderStyle os = o->style()->outlineStyle();
+    QColor oc = o->style()->outlineColor();
+    int offset = 0;// o->style()->outlineOffset(); ### to be assessed and ported
+
+    int x1 = tx + p1.x() - offset;
+    int y1 = ty + p1.y() - offset;
+    int x2 = tx + p2.x() + offset;
+    int y2 = ty + p2.y() + offset;
+    if (x1 > x2) {
+        kSwap(x1, x2);
+        if (bsOrientation(curBS) == BSHorizontal) kSwap(prevBS, nextBS);
+    }
+    if (y1 > y2) {
+        kSwap(y1, y2);
+        if (bsOrientation(curBS) == BSVertical) kSwap(prevBS, nextBS);
+    }
+
+//     kdDebug(6040) << "segment(" << x1 << "," << y1 << ") - (" << x2 << "," << y2 << ")" << endl;
+/*    p->setPen(Qt::gray);
+    p->drawLine(x1,y1,x2,y2);*/
+    switch (curBS) {
+    case RenderObject::BSLeft:
+    case RenderObject::BSRight:
+/*        p->setPen(QColor("#ffe4dd"));
+        p->drawLine(
+                      x1 - (curBS == RenderObject::BSLeft ? ow : 0),
+                      y1 - (prevBS == RenderObject::BSTop ? ow : 0),
+                      x2 + (curBS == RenderObject::BSRight ? ow : 0),
+                      y2 + (nextBS == RenderObject::BSBottom ? ow : 0)
+                      );*/
+        o->drawBorder(p,
+                      x1 - (curBS == RenderObject::BSLeft ? ow : 0),
+                      y1 - (prevBS == RenderObject::BSTop ? ow : 0),
+                      x2 + (curBS == RenderObject::BSRight ? ow : 0),
+                      y2 + (nextBS == RenderObject::BSBottom ? ow : 0),
+                      curBS, oc, o->style()->color(), os,
+                      prevBS == RenderObject::BSTop ? ow
+                              : prevBS == RenderObject::BSBottom ? -ow : 0,
+                      nextBS == RenderObject::BSTop ? -ow
+                              : nextBS == RenderObject::BSBottom ? ow : 0,
+                      true);
+        break;
+    case RenderObject::BSBottom:
+    case RenderObject::BSTop:
+//       kdDebug(6040) << "BSTop/BSBottom: prevBS " << prevBS << " curBS " << curBS << " nextBS " << nextBS << endl;
+        o->drawBorder(p,
+                      x1 - (prevBS == RenderObject::BSLeft ? ow : 0),
+                      y1 - (curBS == RenderObject::BSTop ? ow : 0),
+                      x2 + (nextBS == RenderObject::BSRight ? ow : 0),
+                      y2 + (curBS == RenderObject::BSBottom ? ow : 0),
+                      curBS, oc, o->style()->color(), os,
+                      prevBS == RenderObject::BSLeft ? ow
+                              : prevBS == RenderObject::BSRight ? -ow : 0,
+                      nextBS == RenderObject::BSLeft ? -ow
+                              : nextBS == RenderObject::BSRight ? ow : 0,
+                      true);
+        break;
+    }
+}
+
+void RenderInline::paintOutlinePath(QPainter *p, int tx, int ty, const QPoint *begin, const QPoint *end, BorderSide bs, int direction, BorderSide endingBS)
 {
     int ow = style()->outlineWidth();
     if (ow == 0 || m_isContinuation) // Continuations get painted by the original inline.
         return;
 
-    EBorderStyle os = style()->outlineStyle();
-    QColor oc = style()->outlineColor();
-
-    int offset = 0;// style()->outlineOffset(); ### to be assessed and ported
+    QPoint last = *begin;
+    BorderSide lastBS = bs;
+    Q_ASSERT(begin != end);
+    ++begin;
+
+//     kdDebug(6040) << "last: " << last << endl;
+
+    bs = newBorderSide(bs, direction, last, *begin);
+//     kdDebug(6040) << "newBorderSide: " << lastBS << " " << direction << "d " << last << " - " << *begin << " => " << bs << endl;
+
+    for (const QPoint *it = begin; it != end; ++it) {
+        QPoint cur = *it;
+//         kdDebug(6040) << "cur: " << cur << endl;
+        BorderSide nextBS;
+        if (it + 1 != end) {
+            QPoint diff = cur - last;
+            direction = diff.x() + diff.y();
+            nextBS = newBorderSide(bs, direction, cur, *(it + 1));
+//             kdDebug(6040) << "newBorderSide*: " << bs << " " << direction << "d " << cur << " - " << *(it + 1) << " => " << nextBS << endl;
+        } else
+            nextBS = endingBS;
+
+        Q_ASSERT(bsOrientation(bs) != bsOrientation(nextBS));
+        paintOutlineSegment(this, p, tx, ty, last, cur,
+                            lastBS, bs, nextBS);
+        lastBS = bs;
+        last = cur;
+        bs = nextBS;
+    }
 
-    int t = ty + thisline.top() - offset;
-    int l = tx + thisline.left() - offset;
-    int b = ty + thisline.bottom() + offset + 1;
-    int r = tx + thisline.right() + offset + 1;
-
-    // left edge
-    drawBorder(p,
-               l - ow,
-               t - (lastline.isEmpty() || thisline.left() < lastline.left() || lastline.right() <= thisline.left() ? ow : 0),
-               l,
-               b + (nextline.isEmpty() || thisline.left() <= nextline.left() || nextline.right() <= thisline.left() ? ow : 0),
-               BSLeft,
-               oc, style()->color(), os,
-               (lastline.isEmpty() || thisline.left() < lastline.left() || lastline.right() <= thisline.left() ? ow : -ow),
-               (nextline.isEmpty() || thisline.left() <= nextline.left() || nextline.right() <= thisline.left() ? ow : -ow),
-               true);
-
-    // right edge
-    drawBorder(p,
-               r,
-               t - (lastline.isEmpty() || lastline.right() < thisline.right() || thisline.right() <= lastline.left() ? ow : 0),
-               r + ow,
-               b + (nextline.isEmpty() || nextline.right() <= thisline.right() || thisline.right() <= nextline.left() ? ow : 0),
-               BSRight,
-               oc, style()->color(), os,
-               (lastline.isEmpty() || lastline.right() < thisline.right() || thisline.right() <= lastline.left() ? ow : -ow),
-               (nextline.isEmpty() || nextline.right() <= thisline.right() || thisline.right() <= nextline.left() ? ow : -ow),
-               true);
-    // upper edge
-    if ( thisline.left() < lastline.left())
-        drawBorder(p,
-                   l - ow,
-                   t - ow,
-                   kMin(r+ow, (lastline.isValid()? tx+lastline.left() : 1000000)),
-                   t ,
-                   BSTop, oc, style()->color(), os,
-                   ow,
-                   (lastline.isValid() && tx+lastline.left()+1<r+ow ? -ow : ow),
-                   true);
-
-    if (lastline.right() < thisline.right())
-        drawBorder(p,
-                   kMax(lastline.isValid()?tx + lastline.right() + 1:-1000000, l - ow),
-                   t - ow,
-                   r + ow,
-                   t ,
-                   BSTop, oc, style()->color(), os,
-                   (lastline.isValid() && l-ow < tx+lastline.right()+1 ? -ow : ow),
-                   ow,
-                   true);
-
-    // lower edge
-    if ( thisline.left() < nextline.left())
-        drawBorder(p,
-                   l - ow,
-                   b,
-                   kMin(r+ow, nextline.isValid()? tx+nextline.left()+1 : 1000000),
-                   b + ow,
-                   BSBottom, oc, style()->color(), os,
-                   ow,
-                   (nextline.isValid() && tx+nextline.left()+1<r+ow? -ow : ow),
-                   true);
-
-    if (nextline.right() < thisline.right())
-        drawBorder(p,
-                   kMax(nextline.isValid()?tx+nextline.right()+1:-1000000 , l-ow),
-                   b,
-                   r + ow,
-                   b + ow,
-                   BSBottom, oc, style()->color(), os,
-                   (nextline.isValid() && l-ow < tx+nextline.right()+1? -ow : ow),
-                   ow,
-                   true);
 }
 
 void RenderInline::calcMinMaxWidth()
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_inline.h kdelibs/khtml/rendering/render_inline.h
--- kdelibs.orig/khtml/rendering/render_inline.h	Sun May  9 22:42:26 2004
+++ kdelibs/khtml/rendering/render_inline.h	Wed Nov 10 10:00:28 2004
@@ -45,6 +45,12 @@
 
     virtual void addChildToFlow(RenderObject* newChild, RenderObject* beforeChild);
 
+    void splitInlines(RenderBlock* fromBlock, RenderBlock* toBlock, RenderBlock* middleBlock,
+                      RenderObject* beforeChild, RenderFlow* oldCont);
+
+    void splitFlow(RenderObject* beforeChild, RenderBlock* newBlockBox,
+                   RenderObject* newChild, RenderFlow* oldCont);
+
     virtual void setStyle(RenderStyle* _style);
 
     virtual void layout() {} // Do nothing for layout()
@@ -78,16 +84,10 @@
 
 protected:
     static RenderInline* cloneInline(RenderFlow* src);
-    void paintOutline(QPainter *p, int tx, int ty, const QRect &prevLine, const QRect &thisLine, const QRect &nextLine);
+    void paintOutlinePath(QPainter *p, int tx, int ty, const QPoint *begin, const QPoint *end, BorderSide startingBS, int initialDirection, BorderSide endingBS);
     void paintOutlines(QPainter *p, int tx, int ty);
 
 private:
-    void splitInlines(RenderBlock* fromBlock, RenderBlock* toBlock, RenderBlock* middleBlock,
-                      RenderObject* beforeChild, RenderFlow* oldCont);
-    void splitFlow(RenderObject* beforeChild, RenderBlock* newBlockBox,
-                   RenderObject* newChild, RenderFlow* oldCont);
-
-private:
     bool m_isContinuation : 1; // Whether or not we're a continuation of an inline.
 
 };
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_layer.cpp kdelibs/khtml/rendering/render_layer.cpp
--- kdelibs.orig/khtml/rendering/render_layer.cpp	Tue Sep  7 16:05:39 2004
+++ kdelibs/khtml/rendering/render_layer.cpp	Wed Nov 10 10:00:28 2004
@@ -568,7 +568,7 @@
         showScrollbar(Qt::Horizontal, needHorizontalBar);
         showScrollbar(Qt::Vertical, needVerticalBar);
 
-        m_object->setLayouted(false);
+        m_object->setNeedsLayout(true);
 	if (m_object->isRenderBlock())
             static_cast<RenderBlock*>(m_object)->layoutBlock(true);
         else
@@ -1299,7 +1299,7 @@
 // Marquee implementation
 
 Marquee::Marquee(RenderLayer* l)
-:m_layer(l), m_currentLoop(0), m_timerId(0), m_start(0), m_end(0), m_speed(0), m_unfurlPos(0), m_reset(false),
+:m_layer(l), m_currentLoop(0), m_totalLoops(0), m_timerId(0), m_start(0), m_end(0), m_speed(0), m_unfurlPos(0), m_reset(false),
  m_suspended(false), m_stopped(false), m_whiteSpace(NORMAL), m_direction(MAUTO)
 {
 }
@@ -1404,9 +1404,7 @@
             bool forward = direction() == MDOWN || direction() == MRIGHT;
             bool isReversed = (forward && m_currentLoop % 2) || (!forward && !(m_currentLoop % 2));
             m_unfurlPos = isReversed ? m_end : m_start;
-//             m_layer->renderer()->setChildNeedsLayout(true);
-            // ### hack
-            m_layer->renderer()->setLayouted(false);
+            m_layer->renderer()->setChildNeedsLayout(true);
         }
         else {
             if (isHorizontal())
@@ -1449,15 +1447,11 @@
         if (isUnfurlMarquee()) {
             if (m_unfurlPos < m_start) {
                 m_unfurlPos = m_start;
-//                 m_layer->renderer()->setChildNeedsLayout(true);
-                // ### hack
-                m_layer->renderer()->setLayouted(false);
+                m_layer->renderer()->setChildNeedsLayout(true);
             }
             else if (m_unfurlPos > m_end) {
                 m_unfurlPos = m_end;
-//                 m_layer->renderer()->setChildNeedsLayout(true);
-                // ### hack
-                m_layer->renderer()->setLayouted(false);
+                m_layer->renderer()->setChildNeedsLayout(true);
             }
         }
         else {
@@ -1509,7 +1503,7 @@
     // Check the loop count to see if we should now stop.
     bool activate = (m_totalLoops <= 0 || m_currentLoop < m_totalLoops);
     if (activate && !m_timerId)
-        m_layer->renderer()->setLayouted(false);
+        m_layer->renderer()->setNeedsLayout(true);
     else if (!activate && m_timerId) {
         // Destroy the timer.
         killTimer(m_timerId);
@@ -1519,7 +1513,7 @@
 
 void Marquee::timerEvent(QTimerEvent* /*evt*/)
 {
-    if (!m_layer->renderer()->layouted())
+    if (m_layer->renderer()->needsLayout())
         return;
 
     if (m_reset) {
@@ -1577,9 +1571,7 @@
 
     if (isUnfurlMarquee()) {
         m_unfurlPos = newPos;
-//         m_layer->renderer()->setChildNeedsLayout(true);
-        // ### hack
-        m_layer->renderer()->setLayouted(false);
+        m_layer->renderer()->setChildNeedsLayout(true);
     }
     else {
         if (isHorizontal())
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_line.cpp kdelibs/khtml/rendering/render_line.cpp
--- kdelibs.orig/khtml/rendering/render_line.cpp	Sun May 23 17:42:28 2004
+++ kdelibs/khtml/rendering/render_line.cpp	Wed Nov 10 10:00:28 2004
@@ -248,17 +248,11 @@
             }
             if (curr->object()->isInlineFlow()) {
                 InlineFlowBox* flow = static_cast<InlineFlowBox*>(curr);
-                if (curr->object()->style()->display() == COMPACT) {
-                    int ignoredX = x;
-                    flow->placeBoxesHorizontally(ignoredX);
-                }
-                else {
-                    x += flow->marginLeft();
-                    x = flow->placeBoxesHorizontally(x);
-                    x += flow->marginRight();
-                }
+                x += flow->marginLeft();
+                x = flow->placeBoxesHorizontally(x);
+                x += flow->marginRight();
             }
-            else if (curr->object()->style()->display() != COMPACT ) {
+            else {
                 x += curr->object()->marginLeft();
                 curr->setXPos(x);
                 x += curr->width() + curr->object()->marginRight();
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_list.cpp kdelibs/khtml/rendering/render_list.cpp
--- kdelibs.orig/khtml/rendering/render_list.cpp	Tue Feb 24 15:21:33 2004
+++ kdelibs/khtml/rendering/render_list.cpp	Wed Nov 10 10:00:28 2004
@@ -237,7 +237,7 @@
 
 void RenderListItem::layout( )
 {
-    KHTMLAssert( !layouted() );
+    KHTMLAssert( needsLayout() );
     KHTMLAssert( minMaxKnown() );
 
     updateMarkerLocation();
@@ -292,10 +292,9 @@
 
 void RenderListMarker::setStyle(RenderStyle *s)
 {
-    if ( s && style() && s->listStylePosition() != style()->listStylePosition() ) {
-	setLayouted( false );
-	setMinMaxKnown( false );
-    }
+    if ( s && style() && s->listStylePosition() != style()->listStylePosition() )
+        setNeedsLayoutAndMinMaxRecalc();
+
     RenderBox::setStyle(s);
 
     if ( m_listImage != style()->listStyleImage() ) {
@@ -371,7 +370,7 @@
         {
             RenderCanvas *rootObj = canvas();
             if (_ty < rootObj->truncatedAt())
-                rootObj->setTruncatedAt(_ty);
+                rootObj->setBestTruncatedAt(_ty, this);
             // Let's paint this on the next page.
             return;
         }
@@ -441,12 +440,12 @@
 
 void RenderListMarker::layout()
 {
-    KHTMLAssert( !layouted() );
+    KHTMLAssert( needsLayout() );
 
     if ( !minMaxKnown() )
         calcMinMaxWidth();
 
-    setLayouted();
+    setNeedsLayout(false);
 }
 
 void RenderListMarker::setPixmap( const QPixmap &p, const QRect& r, CachedImage *o)
@@ -457,10 +456,7 @@
     }
 
     if(m_width != m_listImage->pixmap_size().width() || m_height != m_listImage->pixmap_size().height())
-    {
-        setLayouted(false);
-        setMinMaxKnown(false);
-    }
+        setNeedsLayoutAndMinMaxRecalc();
     else
         repaintRectangle(0, 0, m_width, m_height);
 }
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_list.h kdelibs/khtml/rendering/render_list.h
--- kdelibs.orig/khtml/rendering/render_list.h	Tue Feb 24 15:21:33 2004
+++ kdelibs/khtml/rendering/render_list.h	Wed Nov 17 14:59:17 2004
@@ -19,7 +19,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #ifndef RENDER_LIST_H
 #define RENDER_LIST_H
@@ -97,6 +96,8 @@
 
     virtual void calcWidth();
 
+    virtual bool isListMarker() const { return true; }
+
     RenderListItem* listItem() const { return m_listItem; }
     void setListItem(RenderListItem* listItem) { m_listItem = listItem; }
 
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_object.cpp kdelibs/khtml/rendering/render_object.cpp
--- kdelibs.orig/khtml/rendering/render_object.cpp	Thu Aug  5 02:32:33 2004
+++ kdelibs/khtml/rendering/render_object.cpp	Sun Nov 28 20:36:35 2004
@@ -4,7 +4,7 @@
  * Copyright (C) 1999-2003 Lars Knoll (knoll@kde.org)
  *           (C) 1999 Antti Koivisto (koivisto@kde.org)
  *           (C) 2000-2003 Dirk Mueller (mueller@kde.org)
- *           (C) 2002 Apple Computer, Inc.
+ *           (C) 2002-2003 Apple Computer, Inc.
  *
  * This library is free software; you can redistribute it and/or
  * modify it under the terms of the GNU Library General Public
@@ -157,8 +157,9 @@
       m_previous( 0 ),
       m_next( 0 ),
       m_verticalPosition( PositionUndefined ),
-      m_layouted( false ),
-      m_unused( false ),
+      m_needsLayout( false ),
+      m_normalChildNeedsLayout( false ),
+      m_posChildNeedsLayout( false ),
       m_minMaxKnown( false ),
       m_floating( false ),
 
@@ -229,6 +230,11 @@
         element()->getDocument()->documentElement() == element();
 }
 
+bool RenderObject::isHR() const
+{
+    return element() && element()->id() == ID_HR;
+}
+
 bool RenderObject::isHTMLMarquee() const
 {
     return element() && element()->renderer() == this && element()->id() == ID_MARQUEE;
@@ -247,7 +253,7 @@
 
 void RenderObject::removeChild(RenderObject *o )
 {
-    setLayouted(false);
+    setNeedsLayout(true);
     removeChildNode( o );
 }
 
@@ -465,33 +471,54 @@
     }
 }
 
-void RenderObject::setLayouted(bool b)
+void RenderObject::setNeedsLayout(bool b, bool markParents)
+{
+    m_needsLayout = b;
+    if (b) {
+        if (markParents)
+            markContainingBlocksForLayout();
+    }
+    else {
+        m_posChildNeedsLayout = false;
+        m_normalChildNeedsLayout = false;
+    }
+}
+
+void RenderObject::setChildNeedsLayout(bool b, bool markParents)
+{
+    m_normalChildNeedsLayout = b;
+    if (b) {
+        if (markParents)
+            markContainingBlocksForLayout();
+    }
+    else {
+        m_posChildNeedsLayout = false;
+        m_normalChildNeedsLayout = false;
+    }
+}
+
+void RenderObject::markContainingBlocksForLayout()
 {
-    m_layouted = b;
-    if (!b) {
-        RenderObject *o = container();
-        RenderObject *root = this;
-
-        // If an attempt is made to setLayouted(false) an object
-        // inside a clipped (overflow:hidden) object, we have to make
-        // sure to repaint only the clipped rectangle.  We do this by
-        // passing an argument to scheduleRelayout.  This hint really
-        // shouldn't be needed, and it's unfortunate that it is
-        // necessary.  -dwh
-
-        RenderObject* clippedObj =
-            (style()->hidesOverflow() && !isText()) ? this : 0;
-
-        while( o ) {
-            root = o;
-            o->m_layouted = false;
-            if (o->style()->hidesOverflow() && !clippedObj)
-                clippedObj = o;
-            o = o->container();
+    RenderObject *o = container();
+    RenderObject *last = this;
+
+    while (o) {
+        if (!last->isText() && (last->style()->position() == FIXED || last->style()->position() == ABSOLUTE)) {
+            if (o->m_posChildNeedsLayout)
+                return;
+            o->m_posChildNeedsLayout = true;
+        }
+        else {
+            if (o->m_normalChildNeedsLayout)
+                return;
+            o->m_normalChildNeedsLayout = true;
         }
 
-        root->scheduleRelayout(clippedObj);
+        last = o;
+        o = o->container();
     }
+
+    last->scheduleRelayout();
 }
 
 RenderBlock *RenderObject::containingBlock() const
@@ -512,8 +539,8 @@
                !o->isRoot() && !o->isCanvas())
             o = o->parent();
     } else {
-        while(o && ( ( o->isInline() && !o->isReplaced() ) ||
-              o->isTableRow() || o->isTableSection() || o->isTableCol() ) )
+        while(o && ( ( o->isInline() && !o->isReplaced() ) || o->isTableRow() || o->isTableSection() ||
+                       o->isTableCol() || o->isFrameSet() ) )
             o = o->parent();
     }
     // this is just to make sure we return a valid element.
@@ -1004,7 +1031,7 @@
     if (isPositioned()) ts << "ps ";
     if (isReplaced()) ts << "rp ";
     if (overhangingContents()) ts << "oc ";
-    if (layouted()) ts << "lt ";
+    if (needsLayout()) ts << "nl ";
     if (minMaxKnown()) ts << "mmk ";
     if (m_recalcMinMax) ts << "rmm ";
     if (mouseInside()) ts << "mi ";
@@ -1122,7 +1149,7 @@
     if (isInline()) { ts << " inline"; }
     if (isReplaced()) { ts << " replaced"; }
     if (shouldPaintBackgroundOrBorder()) { ts << " paintBackground"; }
-    if (layouted()) { ts << " layouted"; }
+    if (needsLayout()) { ts << " needsLayout"; }
     if (minMaxKnown()) { ts << " minMaxKnown"; }
     if (overhangingContents()) { ts << " overhangingContents"; }
     if (hasFirstLine()) { ts << " hasFirstLine"; }
@@ -1203,14 +1230,10 @@
                                         m_style->hasBorder() || nb );
     m_hasFirstLine = (style->getPseudoStyle(RenderStyle::FIRST_LINE) != 0);
 
-    if ( d >= RenderStyle::Position && m_parent ) {
-        //qDebug("triggering relayout");
-        setMinMaxKnown(false);
-        setLayouted(false);
-    } else if ( m_parent ) {
-        //qDebug("triggering repaint");
+    if ( d >= RenderStyle::Position && m_parent )
+        setNeedsLayoutAndMinMaxRecalc();
+    else if (!isText() && m_parent && d == RenderStyle::Visible)
         repaint();
-    }
 }
 
 void RenderObject::setOverhangingContents(bool p)
@@ -1327,6 +1350,15 @@
 
 RenderObject *RenderObject::container() const
 {
+    // This method is extremely similar to containingBlock(), but with a few notable
+    // exceptions.
+    // (1) It can be used on orphaned subtrees, i.e., it can be called safely even when
+    // the object is not part of the primary document subtree yet.
+    // (2) For normal flow elements, it just returns the parent.
+    // (3) For absolute positioned elements, it will return a relative positioned inline.
+    // containingBlock() simply skips relpositioned inlines and lets an enclosing block handle
+    // the layout of the positioned object.  This does mean that calcAbsoluteHorizontal and
+    // calcAbsoluteVertical have to use container().
     EPosition pos = m_style->position();
     RenderObject *o = 0;
     if( pos == FIXED ) {
@@ -1397,6 +1429,7 @@
 
 void RenderObject::detach()
 {
+
     deleteInlineBoxes();
     remove();
 
@@ -1532,8 +1565,7 @@
         (( !isRenderBlock() ||
            !static_cast<RenderBlock*>( this )->isPointInScrollbar( _x, _y, _tx, _ty )) &&
         (overhangingContents() || inOverflowRect || isInline() || isRoot() || isCanvas() ||
-        isTableRow() || isTableSection() || inside || mouseInside() ||
-        (childrenInline() && firstChild() && firstChild()->style()->display() == COMPACT )))) {
+        isTableRow() || isTableSection() || inside || mouseInside() ))) {
         if ( hitTestAction == HitTestChildrenOnly )
             inside = false;
         if ( style()->hidesOverflow() && layer() )
@@ -1586,7 +1618,7 @@
 
 }
 
-short RenderObject::getVerticalPosition( bool firstLine ) const
+short RenderObject::getVerticalPosition( bool firstLine, RenderObject* ref ) const
 {
     // vertical align for table cells has a different meaning
     int vpos = 0;
@@ -1599,14 +1631,15 @@
         } else if ( va == LENGTH ) {
             vpos = -style()->verticalAlignLength().width( lineHeight( firstLine ) );
         } else {
-            bool checkParent = parent()->isInline() && !parent()->isReplacedBlock();
-            vpos = checkParent ? parent()->verticalPositionHint( firstLine ) : 0;
+            if (!ref) ref = parent();
+            bool checkParent = ref->isInline() && !ref->isReplacedBlock();
+            vpos = checkParent ? ref->verticalPositionHint( firstLine ) : 0;
             // don't allow elements nested inside text-top to have a different valignment.
             if ( va == BASELINE )
                 return vpos;
 
-            const QFont &f = parent()->font( firstLine );
-            int fontheight = parent()->lineHeight( firstLine );
+            const QFont &f = ref->font( firstLine );
+            int fontheight = ref->lineHeight( firstLine );
             int fontsize = f.pixelSize();
             int halfleading = ( fontheight - fontsize ) / 2;
 
@@ -1617,10 +1650,10 @@
             else if ( va == TEXT_TOP ) {
 //                 qDebug( "got TEXT_TOP vertical pos hint" );
 //                 qDebug( "parent:" );
-//                 qDebug( "CSSLH: %d, CSS_FS: %d, basepos: %d", fontheight, fontsize, parent()->baselinePosition( firstLine ) );
+//                 qDebug( "CSSLH: %d, CSS_FS: %d, basepos: %d", fontheight, fontsize, ref->baselinePosition( firstLine ) );
 //                 qDebug( "this:" );
 //                 qDebug( "CSSLH: %d, CSS_FS: %d, basepos: %d", lineHeight( firstLine ), style()->font().pixelSize(), baselinePosition( firstLine ) );
-                vpos += ( baselinePosition( firstLine ) - parent()->baselinePosition( firstLine ) +
+                vpos += ( baselinePosition( firstLine ) - ref->baselinePosition( firstLine ) +
                         halfleading );
             } else if ( va == MIDDLE ) {
                 QRect b = QFontMetrics(f).boundingRect('x');
@@ -1643,7 +1676,7 @@
     // box, then the fact that we're an inline-block is irrelevant, and we behave
     // just like a block.
 
-    if (isReplaced() && (!isInlineBlockOrInlineTable() || layouted()))
+    if (isReplaced() && (!isInlineBlockOrInlineTable() || !needsLayout()))
         return height()+marginTop()+marginBottom();
 
     Length lh;
@@ -1673,7 +1706,7 @@
     // box, then the fact that we're an inline-block is irrelevant, and we behave
     // just like a block.
 
-    if (isReplaced() && (!isInlineBlockOrInlineTable() || layouted()))
+    if (isReplaced() && (!isInlineBlockOrInlineTable() || !needsLayout()))
         return height()+marginTop()+marginBottom();
 
     const QFontMetrics &fm = fontMetrics( firstLine );
@@ -1811,6 +1844,21 @@
         curr->collectBorders(borderStyles);
 }
 
+bool RenderObject::flowAroundFloats() const
+{
+    return isReplaced() || hasOverflowClip() || style()->flowAroundFloats();
+}
+
+bool RenderObject::usesLineWidth() const
+{
+    // 1. All auto-width objects that avoid floats should always use lineWidth
+    // 2. For objects with a specified width, we match WinIE's behavior:
+    // (a) tables use contentWidth
+    // (b) <hr>s use lineWidth
+    // (c) all other objects use lineWidth in quirks mode and contentWidth in strict mode.
+    return (flowAroundFloats() && (style()->width().isVariable() || isHR() || (style()->htmlHacks() && !isTable())));
+}
+
 #undef RED_LUMINOSITY
 #undef GREEN_LUMINOSITY
 #undef BLUE_LUMINOSITY
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_object.h kdelibs/khtml/rendering/render_object.h
--- kdelibs.orig/khtml/rendering/render_object.h	Wed Sep  8 00:20:23 2004
+++ kdelibs/khtml/rendering/render_object.h	Wed Nov 24 14:51:42 2004
@@ -4,7 +4,7 @@
  * Copyright (C) 2000-2003 Lars Knoll (knoll@kde.org)
  *           (C) 2000 Antti Koivisto (koivisto@kde.org)
  *           (C) 2000-2003 Dirk Mueller (mueller@kde.org)
- *           (C) 2002 Apple Computer, Inc.
+ *           (C) 2002-2003 Apple Computer, Inc.
  *
  * This library is free software; you can redistribute it and/or
  * modify it under the terms of the GNU Library General Public
@@ -21,7 +21,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #ifndef render_object_h
 #define render_object_h
@@ -205,6 +204,7 @@
 
 
     bool isRoot() const;
+    bool isHR() const;
     // some helper functions...
     virtual bool isRenderBlock() const { return false; }
     virtual bool isRenderInline() const { return false; }
@@ -216,6 +216,7 @@
     virtual bool isRenderReplaced() const { return false; }
 
     virtual bool isListItem() const { return false; }
+    virtual bool isListMarker() const { return false; }
     virtual bool isCanvas() const { return false; }
     virtual bool isBR() const { return false; }
     virtual bool isTableCell() const { return false; }
@@ -244,7 +245,10 @@
     bool isReplaced() const { return m_replaced; }
     bool isReplacedBlock() const { return isInline() && isReplaced() && isRenderBlock(); }
     bool shouldPaintBackgroundOrBorder() const { return m_paintBackground; }
-    bool layouted() const   { return m_layouted; }
+    bool needsLayout() const   { return m_needsLayout || m_normalChildNeedsLayout || m_posChildNeedsLayout; }
+    bool selfNeedsLayout() const { return m_needsLayout; }
+    bool posChildNeedsLayout() const { return m_posChildNeedsLayout; }
+    bool normalChildNeedsLayout() const { return m_normalChildNeedsLayout; }
     bool minMaxKnown() const{ return m_minMaxKnown; }
     bool overhangingContents() const { return m_overhangingContents; }
     bool hasFirstLine() const { return m_hasFirstLine; }
@@ -255,6 +259,7 @@
     // don't even think about making this method virtual!
     DOM::DocumentImpl* document() const;
     DOM::NodeImpl* element() const { return isAnonymous() ? 0L : m_node; }
+    DOM::NodeImpl* node() const { return m_node; }
 
    /**
      * returns the object containing this one. can be different from parent for
@@ -263,10 +268,9 @@
     RenderObject *container() const;
 
     void setOverhangingContents(bool p=true);
-    void setLayouted(bool b = true);
-    void setLayoutedLocal(bool b) {
-	m_layouted = b;
-    }
+    void markContainingBlocksForLayout();
+    void setNeedsLayout(bool b, bool markParents = true);
+    void setChildNeedsLayout(bool b, bool markParents = true);
     void setMinMaxKnown(bool b=true) {
 	m_minMaxKnown = b;
 	if ( !b ) {
@@ -279,6 +283,10 @@
 	    }
 	}
     }
+    void setNeedsLayoutAndMinMaxRecalc() {
+        setMinMaxKnown(false);
+        setNeedsLayout(true);
+    }
     void setPositioned(bool b=true)  { m_positioned = b;  }
     void setRelPositioned(bool b=true) { m_relPositioned = b; }
     void setFloating(bool b=true) { m_floating = b; }
@@ -296,6 +304,7 @@
     virtual short lineHeight( bool firstLine ) const;
     virtual short verticalPositionHint( bool firstLine ) const;
     virtual short baselinePosition( bool firstLine ) const;
+    short getVerticalPosition( bool firstLine, RenderObject* ref=0 ) const;
 
     /*
      * Print the object and its children, clipped by (x|y|w|h).
@@ -350,14 +359,17 @@
      * This function should cause the Element to calculate its
      * width and height and the layout of its content
      *
-     * when the Element calls setLayouted(true), layout() is no
+     * when the Element calls setNeedsLayout(false), layout() is no
      * longer called during relayouts, as long as there is no
-     * style sheet change. When that occurs, isLayouted will be
-     * set to false and the Element receives layout() calls
+     * style sheet change. When that occurs, m_needsLayout will be
+     * set to true and the Element receives layout() calls
      * again.
      */
     virtual void layout() = 0;
 
+    /* This function performs a layout only if one is needed. */
+    void layoutIfNeeded() { if (needsLayout()) layout(); }
+
     // used for element state updates that can not be fixed with a
     // repaint and do not need a relayout
     virtual void updateFromElement() {}
@@ -566,6 +578,9 @@
     virtual bool containsFloat(RenderObject* /*o*/) const { return false; }
     virtual void markAllDescendantsWithFloatsForLayout(RenderObject* /*floatToRemove*/ = 0) {}
 
+    bool flowAroundFloats() const;
+    bool usesLineWidth() const;
+
     // positioning of inline children (bidi)
     virtual void position(InlineBox*, int, int, bool) {}
 //    virtual void position(int, int, int, int, int, bool, bool, int) {}
@@ -652,7 +667,7 @@
     virtual QRect viewRect() const;
     void remove();
     void invalidateVerticalPositions();
-    short getVerticalPosition( bool firstLine ) const;
+
 
     virtual void removeLeftoverAnonymousBoxes();
 
@@ -667,13 +682,14 @@
 
     short m_verticalPosition;
 
-    bool m_layouted                  : 1;
-    bool m_unused                    : 1;
+    bool m_needsLayout               : 1;
+    bool m_normalChildNeedsLayout    : 1;
+    bool m_posChildNeedsLayout       : 1;
     bool m_minMaxKnown               : 1;
     bool m_floating                  : 1;
 
     bool m_positioned                : 1;
-    bool m_overhangingContents : 1;
+    bool m_overhangingContents       : 1;
     bool m_relPositioned             : 1;
     bool m_paintBackground           : 1; // if the box has something to paint in the
                                           // background painting phase (background, border, etc)
@@ -684,9 +700,9 @@
     bool m_inline                    : 1;
 
     bool m_replaced                  : 1;
-    bool m_mouseInside : 1;
+    bool m_mouseInside               : 1;
     bool m_hasFirstLine              : 1;
-    bool m_isSelectionBorder          : 1;
+    bool m_isSelectionBorder         : 1;
     // note: do not add unnecessary bitflags, we have 32 bit already!
 
 
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_replaced.cpp kdelibs/khtml/rendering/render_replaced.cpp
--- kdelibs.orig/khtml/rendering/render_replaced.cpp	Mon Aug  9 10:58:12 2004
+++ kdelibs/khtml/rendering/render_replaced.cpp	Wed Nov 17 14:59:17 2004
@@ -3,6 +3,8 @@
  *
  * Copyright (C) 1999-2003 Lars Knoll (knoll@kde.org)
  * Copyright (C) 2000-2003 Dirk Mueller (mueller@kde.org)
+ * Copyright (C) 2003 Apple Computer, Inc.
+ * Copyright (C) 2004 Germain Garand (germain@ebooksfrance.org)
  *
  * This library is free software; you can redistribute it and/or
  * modify it under the terms of the GNU Library General Public
@@ -19,7 +21,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #include "render_replaced.h"
 #include "render_canvas.h"
@@ -35,6 +36,7 @@
 #include <qlineedit.h>
 #include <kglobalsettings.h>
 #include <qobjectlist.h>
+#include <qvaluevector.h>
 
 #include "khtml_ext.h"
 #include "khtmlview.h"
@@ -95,6 +97,7 @@
     assert(!isAnonymous());
     m_view = node->getDocument()->view();
     m_resizePending = false;
+    m_discardResizes = false;
 
     // this is no real reference counting, its just there
     // to make sure that we're not deleted while we're recursed
@@ -157,10 +160,21 @@
     }
 }
 
+void RenderWidget::cancelPendingResize()
+{
+    if (!m_widget)
+        return;
+    m_discardResizes = true;
+    QApplication::sendPostedEvents(this, QWidgetResizeEvent::Type);
+    m_discardResizes = false;
+}
+
 bool RenderWidget::event( QEvent *e )
 {
     if ( m_widget && (e->type() == (QEvent::Type)QWidgetResizeEvent::Type) ) {
         m_resizePending = false;
+        if (m_discardResizes)
+            return true;
         QWidgetResizeEvent *re = static_cast<QWidgetResizeEvent *>(e);
         m_widget->resize( re->w,  re->h );
         repaint();
@@ -191,14 +205,15 @@
             connect( m_widget, SIGNAL( destroyed()), this, SLOT( slotWidgetDestructed()));
             m_widget->installEventFilter(this);
 
-            if ( !strcmp(m_widget->name(), "__khtml"))
+            if ( !strcmp(m_widget->name(), "__khtml") && !::qt_cast<QFrame*>(m_widget))
                 m_widget->setBackgroundMode( QWidget::NoBackground );
 
             if (m_widget->focusPolicy() > QWidget::StrongFocus)
                 m_widget->setFocusPolicy(QWidget::StrongFocus);
-            // if we're already layouted, apply the calculated space to the
-            // widget immediately
-            if (layouted()) {
+            // if we've already received a layout, apply the calculated space to the
+            // widget immediately, but we have to have really been full constructed (with a non-null
+            // style pointer).
+            if (!needsLayout() && style()) {
                 // ugly hack to limit the maximum size of the widget (as X11 has problems if it's bigger)
                 resizeWidget( m_width-borderLeft()-borderRight()-paddingLeft()-paddingRight(),
                               m_height-borderTop()-borderBottom()-paddingTop()-paddingBottom() );
@@ -215,13 +230,13 @@
 
 void RenderWidget::layout( )
 {
-    KHTMLAssert( !layouted() );
+    KHTMLAssert( needsLayout() );
     KHTMLAssert( minMaxKnown() );
     if ( m_widget )
         resizeWidget( m_width-borderLeft()-borderRight()-paddingLeft()-paddingRight(),
                       m_height-borderTop()-borderBottom()-paddingTop()-paddingBottom() );
 
-    setLayouted();
+    setNeedsLayout(false);
 }
 
 void RenderWidget::updateFromElement()
@@ -240,7 +255,7 @@
             if (backgroundColor.isValid()) {
                 if (strcmp(widget()->name(), "__khtml"))
                     widget()->setEraseColor(backgroundColor );
-                for ( int i = 0; i < QPalette::NColorGroups; i++ ) {
+                for ( int i = 0; i < QPalette::NColorGroups; ++i ) {
                     pal.setColor( (QPalette::ColorGroup)i, QColorGroup::Background, backgroundColor );
                     pal.setColor( (QPalette::ColorGroup)i, QColorGroup::Light, backgroundColor.light(highlightVal) );
                     pal.setColor( (QPalette::ColorGroup)i, QColorGroup::Dark, backgroundColor.dark(lowlightVal) );
@@ -309,6 +324,8 @@
     {
         m_widget->setFont(style()->font());
         if (style()->visibility() != VISIBLE) {
+            if (m_view)
+                m_view->setWidgetVisible(this, false);
             m_widget->hide();
         }
     }
@@ -329,8 +346,10 @@
     _tx += m_x;
     _ty += m_y;
 
-    if((_ty > paintInfo.r.bottom()) || (_ty + m_height <= paintInfo.r.top())) return;
-
+    if ( (_ty > paintInfo.r.bottom()) || (_ty + m_height <= paintInfo.r.top()) ||
+         (_tx + m_width <= paintInfo.r.left()) || (_tx > paintInfo.r.right()) )
+        return;
+    
     // add offset for relative positioning
     if(isRelPositioned())
         relativePositionOffset(_tx, _ty);
@@ -338,6 +357,7 @@
     int xPos = _tx+borderLeft()+paddingLeft();
     int yPos = _ty+borderTop()+paddingTop();
 
+    bool khtmlw = !strcmp(m_widget->name(), "__khtml");
     int childw = m_widget->width();
     int childh = m_widget->height();
     if ( (childw == 2000 || childh == 3072) && m_widget->inherits( "KHTMLView" ) ) {
@@ -374,83 +394,168 @@
     m_view->setWidgetVisible(this, true);
     m_view->addChild(m_widget, xPos, yPos );
     m_widget->show();
-    paintWidget(paintInfo, m_widget, _tx, _ty);
+    if (khtmlw)
+        paintWidget(paintInfo, m_widget, _tx, _ty);
 }
 
 #include <private/qinternal_p.h>
 
-static QPixmap copyWidget(int tx, int ty, QPainter *p, QWidget *widget)
+// The PaintBuffer class provides a shared buffer for widget painting.
+// 
+// It will grow to encompass the biggest widget encountered, in order to avoid 
+// constantly resizing.
+// When it grows over maxPixelBuffering, it periodically checks if such a size 
+// is still needed.  If not, it shrinks down to the biggest size < maxPixelBuffering 
+// that was requested during the overflow lapse.
+
+class PaintBuffer: public QObject
+{    
+public:
+    static const int maxPixelBuffering = 320*200;
+    static const int leaseTime = 20*1000;
+  
+    static QPixmap *grab( QSize s = QSize() ) {
+        if (!m_inst) 
+            m_inst = new PaintBuffer;
+        return m_inst->getBuf( s );
+    }
+    static void release() { m_inst->m_grabbed = false; }
+protected:
+    PaintBuffer(): m_overflow(false), m_grabbed(false), 
+                   m_timer(0), m_resetWidth(0), m_resetHeight(0) {};
+    void timerEvent(QTimerEvent* e) { 
+        assert( m_timer == e->timerId() ); 
+        if (m_grabbed) 
+            return;
+        m_buf.resize(m_resetWidth, m_resetHeight);
+        m_resetWidth = m_resetHeight = 0;
+        killTimer( m_timer ); 
+        m_timer = 0;  
+    }
+
+    QPixmap *getBuf( QSize s ) {
+        assert( !m_grabbed );
+        m_grabbed = true;
+        bool cur_overflow = false;
+        if (!s.isEmpty()) {
+            int nw = kMax(m_buf.width(), s.width());
+            int nh = kMax(m_buf.height(), s.height());
+                        
+            if (!m_overflow && (nw*nh > maxPixelBuffering))
+                cur_overflow = true;
+            
+            if (nw != m_buf.width() || nh != m_buf.height())
+                m_buf.resize(nw, nh);
+        }
+        if (cur_overflow) {
+            m_overflow = true;    
+            m_timer = startTimer( leaseTime );
+        } else if (m_overflow) {
+            if( s.width()*s.height() > maxPixelBuffering ) {
+                killTimer( m_timer );
+                m_timer = startTimer( leaseTime );
+            } else {
+                if (s.width() > m_resetWidth)
+                    m_resetWidth = s.width();
+                if (s.height() > m_resetHeight)
+                    m_resetHeight = s.height();
+            }
+        }   
+        return &m_buf;
+    }
+private:    
+    static PaintBuffer* m_inst;
+    QPixmap m_buf; 
+    bool m_overflow;
+    bool m_grabbed;
+    int m_timer;
+    int m_resetWidth;
+    int m_resetHeight;
+};
+
+PaintBuffer *PaintBuffer::m_inst = 0;
+
+static void copyWidget(const QRect& r, QPainter *p, QWidget *widget, int tx, int ty)
 {
-    QPixmap pm = QPixmap(widget->width(), widget->height());
-    if ( p->device()->isExtDev() || ::qt_cast<QLineEdit *>(widget) ) {
+    if (r.isNull() || r.isEmpty() )
+        return;
+    QRegion blit(r);
+    QValueVector<QWidget*> cw;
+    QValueVector<QRect> cr;
+      
+    if (widget->children()) {
+        // build region
+        QObjectListIterator it = *widget->children();
+        for (; it.current(); ++it) {
+            QWidget* const w = ::qt_cast<QWidget *>(it.current());
+	    if ( w && !w->isTopLevel() && !w->isHidden()) {
+	        QRect r2 = w->geometry();
+	        blit.subtract( r2 );
+	        r2 = r2.intersect( r );
+	        r2.moveBy(-w->x(), -w->y());
+	        cr.append(r2);
+	        cw.append(w);
+            }
+        }
+    }
+    QMemArray<QRect> br = blit.rects();
+
+    const int cnt = br.size();
+    const bool external = p->device()->isExtDev();    
+    QPixmap* const pm = PaintBuffer::grab( widget->size() );
+    
+    // fill background
+    if ( external ) {
 	// even hackier!
-	pm.fill(widget->colorGroup().base());
+        QPainter pt( pm );
+        const QColor c = widget->colorGroup().base();
+        for (int i = 0; i < cnt; ++i)
+            pt.fillRect( br[i], c );
     } else {
-	QPoint pt(tx, ty);
-	pt = p->xForm(pt);
-	bitBlt(&pm, 0, 0, p->device(), pt.x(), pt.y());
+        QRect dr;
+        for (int i = 0; i < cnt; ++i ) {
+            dr = br[i];
+	    dr.moveBy( tx, ty );
+	    dr = p->xForm( dr );
+	    bitBlt(pm, br[i].topLeft(), p->device(), dr);
+        }
     }
-    QPainter::redirect(widget, &pm);
-    QPaintEvent e( widget->rect(), false );
+    
+    // send paint event
+    QPainter::redirect(widget, pm);
+    QPaintEvent e( r, false );
     QApplication::sendEvent( widget, &e );
     QPainter::redirect(widget, 0);
-    if (widget->children()) {
-	QObjectListIterator it(*widget->children());
-	for (; it.current(); ++it) {
-	    QWidget *w = ::qt_cast<QWidget *>(it.current());
-	    if (w && !w->isTopLevel()) {
-		QPixmap cp = copyWidget(tx + w->x(), ty + w->y(), p, w);
-		bitBlt(&pm, w->x(), w->y(), &cp, 0, 0);
-	    }
-	}
-    }
-    return pm;
-}
+    
+    // transfer result
+    if ( external )
+        for ( int i = 0; i < cnt; ++i )
+            p->drawPixmap(QPoint(tx+br[i].x(), ty+br[i].y()), *pm, br[i]);
+    else
+        for ( int i = 0; i < cnt; ++i )
+            bitBlt(p->device(), p->xForm( QPoint(tx, ty) + br[i].topLeft() ), pm, br[i]);        
 
+    // cleanup and recurse     
+    PaintBuffer::release();
+    QValueVector<QWidget*>::iterator cwit = cw.begin();
+    QValueVector<QWidget*>::iterator cwitEnd = cw.end();
+    QValueVector<QRect>::const_iterator crit = cr.begin();
+    for (; cwit != cwitEnd; ++cwit, ++crit)
+        copyWidget(*crit, p, *cwit, tx+(*cwit)->x(), ty+(*cwit)->y());
+}
 
 void RenderWidget::paintWidget(PaintInfo& pI, QWidget *widget, int tx, int ty)
 {
-    QPainter* p = pI.p;
-    // We have some problems here, as we can't redirect some of the widgets.
+    QPainter* const p = pI.p;
     allowWidgetPaintEvents = true;
 
-    if (!strcmp(widget->name(), "__khtml")) {
-        bool dsbld = QSharedDoubleBuffer::isDisabled();
-        QSharedDoubleBuffer::setDisabled(true);
-	QPixmap pm = copyWidget(tx, ty, p, widget);
-        QSharedDoubleBuffer::setDisabled(dsbld);
-        p->drawPixmap(tx, ty, pm);
-    } else {
-        // QScrollview is difficult and I currently know of no way to get
-        // the stuff on screen without flicker.
-        //
-        // This still doesn't work nicely for textareas. Probably need
-        // to fix qtextedit for that.
-        // KHTMLView::eventFilter()
-        if (pI.p->device()->isExtDev())
-        {
-           QScrollView *sv = dynamic_cast<QScrollView *>(widget);
-           if (sv && sv->viewport())
-           {
-              QWidget *w = sv->viewport();
-              bool dsbld = QSharedDoubleBuffer::isDisabled();
-              QSharedDoubleBuffer::setDisabled(true);
-              QPixmap pm = copyWidget(tx, ty, p, w);
-              QSharedDoubleBuffer::setDisabled(dsbld);
-              p->drawPixmap(tx, ty, pm);
-              p->setPen(Qt::black);
-              p->setBrush(Qt::NoBrush);
-              p->drawRect(tx, ty, pm.width(), pm.height());
-           }
-        }
-#if 0
-        QPaintEvent e( widget->rect(), false );
-        QApplication::sendEvent( widget, &e );
-        QScrollView *sv = static_cast<QScrollView *>(widget);
-        sv->repaint(true);
-        pm = QPixmap::grabWindow(widget->winId());
-#endif
-    }
+    const bool dsbld = QSharedDoubleBuffer::isDisabled();
+    QSharedDoubleBuffer::setDisabled(true);
+    QRect rr = pI.r;
+    rr.moveBy(-tx, -ty);
+    const QRect r = widget->rect().intersect( rr );
+    copyWidget(r, p, widget, tx, ty);
+    QSharedDoubleBuffer::setDisabled(dsbld);
 
     allowWidgetPaintEvents = false;
 }
@@ -550,14 +655,14 @@
     case EventImpl::MOUSEUP_EVENT:
     case EventImpl::MOUSEMOVE_EVENT: {
         const MouseEventImpl &me = static_cast<const MouseEventImpl &>(ev);
-        QMouseEvent *qme = me.qEvent();
+        QMouseEvent* const qme = me.qEvent();
 
         int absx = 0;
         int absy = 0;
 
         absolutePosition(absx, absy);
 
-        QPoint p(me.clientX() - absx + m_view->contentsX(),
+        const QPoint p(me.clientX() - absx + m_view->contentsX(),
                  me.clientY() - absy + m_view->contentsY());
         QMouseEvent::Type type;
         int button = 0;
@@ -612,7 +717,7 @@
     }
     case EventImpl::KEYDOWN_EVENT:
     case EventImpl::KEYUP_EVENT: {
-        QKeyEvent *ke = static_cast<const TextEventImpl &>(ev).qKeyEvent;
+        QKeyEvent* const ke = static_cast<const TextEventImpl &>(ev).qKeyEvent;
         if (ke)
             static_cast<EventPropagator *>(m_widget)->sendEvent(ke);
         break;
@@ -629,7 +734,7 @@
         //  DOM:   Down     Press   |       Press                             |     Up
         //  Qt:    Press  (nothing) | Release(autorepeat) + Press(autorepeat) |   Release
 
-        QKeyEvent *ke = static_cast<const TextEventImpl &>(ev).qKeyEvent;
+        QKeyEvent* const ke = static_cast<const TextEventImpl &>(ev).qKeyEvent;
         if (ke && ke->isAutoRepeat()) {
             QKeyEvent releaseEv( QEvent::KeyRelease, ke->key(), ke->ascii(), ke->state(),
                                ke->text(), ke->isAutoRepeat(), ke->count() );
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_replaced.h kdelibs/khtml/rendering/render_replaced.h
--- kdelibs.orig/khtml/rendering/render_replaced.h	Mon Aug  9 10:58:12 2004
+++ kdelibs/khtml/rendering/render_replaced.h	Wed Nov 17 14:59:17 2004
@@ -18,7 +18,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #ifndef render_replaced_h
 #define render_replaced_h
@@ -101,6 +100,8 @@
     KHTMLView* view() const { return m_view; }
 
     void deref();
+    
+    void cancelPendingResize();
 
     static void paintWidget(PaintInfo& pI, QWidget *widget, int tx, int ty);
     virtual bool handleEvent(const DOM::EventImpl& ev);
@@ -127,6 +128,7 @@
     KHTMLView* m_view;
 
     bool m_resizePending;
+    bool m_discardResizes;
 
 public:
     class EventPropagator : public QWidget {
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_style.cpp kdelibs/khtml/rendering/render_style.cpp
--- kdelibs.orig/khtml/rendering/render_style.cpp	Sun Jun 13 19:08:25 2004
+++ kdelibs/khtml/rendering/render_style.cpp	Wed Nov 10 10:00:29 2004
@@ -32,7 +32,7 @@
 using namespace khtml;
 using namespace DOM;
 
-/* CSS says Fixde for the default padding value, but we treat variable as 0 padding anyways, and like
+/* CSS says Fixed for the default padding value, but we treat variable as 0 padding anyways, and like
  * this is works fine for table paddings aswell
  */
 StyleSurroundData::StyleSurroundData()
@@ -58,6 +58,7 @@
 {
     min_width = min_height = RenderStyle::initialMinSize();
     max_width = max_height = RenderStyle::initialMaxSize();
+    box_sizing = RenderStyle::initialBoxSizing();
 }
 
 StyleBoxData::StyleBoxData(const StyleBoxData& o )
@@ -65,6 +66,7 @@
       width( o.width ), height( o.height ),
       min_width( o.min_width ), max_width( o.max_width ),
       min_height ( o.min_height ), max_height( o.max_height ),
+      box_sizing( o.box_sizing),
       z_index( o.z_index ), z_auto( o.z_auto )
 {
 }
@@ -78,6 +80,7 @@
 	    max_width == o.max_width &&
 	    min_height == o.min_height &&
 	    max_height == o.max_height &&
+            box_sizing == o.box_sizing &&
 	    z_index == o.z_index &&
             z_auto == o.z_auto;
 }
@@ -176,7 +179,9 @@
       style_image( RenderStyle::initialListStyleImage() ),
       font(), color( RenderStyle::initialColor() ),
       border_hspacing( RenderStyle::initialBorderHorizontalSpacing() ),
-      border_vspacing( RenderStyle::initialBorderVerticalSpacing() )
+      border_vspacing( RenderStyle::initialBorderVerticalSpacing() ),
+      widows( RenderStyle::initialWidows() ), orphans( RenderStyle::initialOrphans() ),
+      page_break_inside( RenderStyle::initialPageBreak() )
 {
 }
 
@@ -189,7 +194,8 @@
       indent( o.indent ), line_height( o.line_height ), style_image( o.style_image ),
       font( o.font ), color( o.color ), decoration_color( o.decoration_color ),
       border_hspacing( o.border_hspacing ),
-      border_vspacing( o.border_vspacing )
+      border_vspacing( o.border_vspacing ),
+      widows(o.widows), orphans(o.orphans), page_break_inside(o.page_break_inside)
 {
 }
 
@@ -203,7 +209,12 @@
 	style_image == o.style_image &&
 	font == o.font &&
 	color == o.color &&
-	decoration_color == o.decoration_color;
+	decoration_color == o.decoration_color &&
+        border_hspacing == o.border_hspacing &&
+        border_vspacing == o.border_vspacing &&
+        widows == o.widows &&
+        orphans == o.orphans &&
+        page_break_inside == o.page_break_inside;
 
     // doesn't work because structs are not packed
     //return memcmp(this, &o, sizeof(*this))==0;
@@ -652,9 +663,9 @@
 QString RenderStyle::createDiff( const RenderStyle &parent ) const
 {
     QString res;
-      if ( parent.color() != color() )
+      if ( color().isValid() && parent.color() != color() )
         res += " [color=" + color().name() + "]";
-    if ( parent.backgroundColor() != backgroundColor() )
+    if ( backgroundColor().isValid() && parent.backgroundColor() != backgroundColor() )
         res += " [bgcolor=" + backgroundColor().name() + "]";
     if ( parent.font() != font() )
         res += " [font=" + describeFont( font() ) + "]";
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_style.h kdelibs/khtml/rendering/render_style.h
--- kdelibs.orig/khtml/rendering/render_style.h	Sun Jun 13 19:08:25 2004
+++ kdelibs/khtml/rendering/render_style.h	Wed Nov 17 14:59:17 2004
@@ -4,7 +4,7 @@
  * Copyright (C) 2000-2003 Lars Knoll (knoll@kde.org)
  *           (C) 2000 Antti Koivisto (koivisto@kde.org)
  *           (C) 2000-2003 Dirk Mueller (mueller@kde.org)
- *           (C) 2002 Apple Computer, Inc.
+ *           (C) 2002-2003 Apple Computer, Inc.
  *
  * This library is free software; you can redistribute it and/or
  * modify it under the terms of the GNU Library General Public
@@ -21,7 +21,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #ifndef RENDERSTYLE_H
 #define RENDERSTYLE_H
@@ -257,7 +256,7 @@
 
     bool hasBorder() const
     {
-    	return left.width || right.width || top.width || bottom.width;
+    	return left.nonZero() || right.nonZero() || top.nonZero() || bottom.nonZero();
     }
 
     bool operator==(const BorderData& o) const
@@ -288,6 +287,10 @@
 //------------------------------------------------
 // Box attributes. Not inherited.
 
+enum EBoxSizing {
+    BORDER_BOX, CONTENT_BOX
+};
+
 class StyleBoxData : public Shared<StyleBoxData>
 {
 public:
@@ -316,6 +319,8 @@
 
     Length vertical_align;
 
+    EBoxSizing box_sizing;
+
     signed int z_index :31;
     bool z_auto        : 1;
 };
@@ -462,7 +467,7 @@
 };
 
 enum ETextAlign {
-    TAAUTO, LEFT, RIGHT, CENTER, JUSTIFY, KONQ_CENTER
+    TAAUTO, LEFT, RIGHT, CENTER, JUSTIFY, KHTML_LEFT, KHTML_RIGHT, KHTML_CENTER
 };
 
 enum ETextTransform {
@@ -477,6 +482,10 @@
     TDNONE = 0x0 , UNDERLINE = 0x1, OVERLINE = 0x2, LINE_THROUGH= 0x4, BLINK = 0x8
 };
 
+enum EPageBreak {
+    PBAUTO, PBALWAYS, PBAVOID
+};
+
 class StyleInheritedData : public Shared<StyleInheritedData>
 {
     StyleInheritedData& operator=(const StyleInheritedData&);
@@ -503,6 +512,11 @@
 
     short border_hspacing;
     short border_vspacing;
+
+    // Paged media properties.
+    short widows;
+    short orphans;
+    EPageBreak page_break_inside : 2;
 };
 
 
@@ -512,7 +526,7 @@
 
 enum ECaptionSide
 {
-    CAPTOP, CAPBOTTOM
+    CAPTOP, CAPBOTTOM, CAPLEFT, CAPRIGHT
 };
 
 
@@ -589,7 +603,7 @@
 
     // inherit
     struct InheritedFlags {
-    // 32 bit inherited, don't add to the struct, or the operator will break.
+    // 64 bit inherited, don't add to the struct, or the operator will break.
 	bool operator==( const InheritedFlags &other ) const
         {    return _iflags ==other._iflags;    }
 	bool operator!=( const InheritedFlags &other ) const
@@ -598,12 +612,12 @@
         union {
             struct {
                 EEmptyCell _empty_cells : 1 ;
-                ECaptionSide _caption_side : 1;
+                ECaptionSide _caption_side : 2;
                 EListStyleType _list_style_type : 5 ;
                 EListStylePosition _list_style_position :1;
 
                 EVisibility _visibility : 2;
-                ETextAlign _text_align : 3;
+                ETextAlign _text_align : 4;
                 ETextTransform _text_transform : 2;
                 unsigned _text_decorations : 4;
                 ECursor _cursor_style : 5;
@@ -615,14 +629,15 @@
                 bool _visuallyOrdered : 1;
                 bool _htmlHacks :1;
                 EUserInput _user_input : 2;
+                unsigned int unused : 30;
             } f;
-            Q_UINT32 _iflags;
+            Q_UINT64 _iflags;
         };
     } inherited_flags;
 
 // don't inherit
     struct NonInheritedFlags {
-    // 32 bit non-inherited, don't add to the struct, or the operator will break.
+    // 64 bit non-inherited, don't add to the struct, or the operator will break.
 	bool operator==( const NonInheritedFlags &other ) const
         {   return _niflags == other._niflags;    }
 	bool operator!=( const NonInheritedFlags &other ) const
@@ -631,6 +646,7 @@
         union {
             struct {
                 EDisplay _display : 5;
+                EDisplay _originalDisplay: 5;
                 EBackgroundRepeat _bg_repeat : 2;
                 bool _bg_attachment : 1;
                 EOverflow _overflow : 4 ;
@@ -641,13 +657,18 @@
                 ETableLayout _table_layout : 1;
                 bool _flowAroundFloats :1;
 
+                EPageBreak _page_break_before : 2;
+                EPageBreak _page_break_after : 2;
+
                 PseudoId _styleType : 3;
 		bool _affectedByHover : 1;
 		bool _affectedByActive : 1;
                 bool _hasClip : 1;
                 EUnicodeBidi _unicodeBidi : 2;
+
+                unsigned int unused : 23;
             } f;
-            Q_UINT32 _niflags;
+            Q_UINT64 _niflags;
         };
     } noninherited_flags;
 
@@ -693,8 +714,12 @@
 	inherited_flags.f._visuallyOrdered = false;
 	inherited_flags.f._htmlHacks=false;
 	inherited_flags.f._user_input = UI_NONE;
+        inherited_flags.f.unused = 0;
 
-        noninherited_flags.f._display = initialDisplay();
+	noninherited_flags._niflags = 0L; // for safety: without this, the equality method sometimes
+	                                  // makes use of uninitialised bits according to valgrind
+
+        noninherited_flags.f._display = noninherited_flags.f._originalDisplay = initialDisplay();
 	noninherited_flags.f._bg_repeat = initialBackgroundRepeat();
 	noninherited_flags.f._bg_attachment = initialBackgroundAttachment();
 	noninherited_flags.f._overflow = initialOverflow();
@@ -704,11 +729,14 @@
 	noninherited_flags.f._floating = initialFloating();
 	noninherited_flags.f._table_layout = initialTableLayout();
 	noninherited_flags.f._flowAroundFloats= initialFlowAroundFloats();
+        noninherited_flags.f._page_break_before = initialPageBreak();
+        noninherited_flags.f._page_break_after = initialPageBreak();
 	noninherited_flags.f._styleType = NOPSEUDO;
 	noninherited_flags.f._affectedByHover = false;
 	noninherited_flags.f._affectedByActive = false;
 	noninherited_flags.f._hasClip = false;
 	noninherited_flags.f._unicodeBidi = initialUnicodeBidi();
+        noninherited_flags.f.unused = 0;
     }
 
 public:
@@ -744,6 +772,7 @@
 // attribute getter methods
 
     EDisplay 	display() const { return noninherited_flags.f._display; }
+    EDisplay    originalDisplay() const { return noninherited_flags.f._originalDisplay; }
 
     Length  	left() const {  return surround->offset.left; }
     Length  	right() const {  return surround->offset.right; }
@@ -864,7 +893,14 @@
 
     ECursor cursor() const { return inherited_flags.f._cursor_style; }
 
+    short widows() const { return inherited->widows; }
+    short orphans() const { return inherited->orphans; }
+    EPageBreak pageBreakInside() const { return inherited->page_break_inside; }
+    EPageBreak pageBreakBefore() const { return noninherited_flags.f._page_break_before; }
+    EPageBreak pageBreakAfter() const { return noninherited_flags.f._page_break_after; }
+
     // CSS3 Getter Methods
+    EBoxSizing boxSizing() const { return box->box_sizing; }
     EUserInput userInput() const { return inherited_flags.f._user_input; }
 
     Length marqueeIncrement() { return css3NonInheritedData->marquee->increment; }
@@ -877,6 +913,7 @@
 // attribute setter methods
 
     void setDisplay(EDisplay v) {  noninherited_flags.f._display = v; }
+    void setOriginalDisplay(EDisplay v) {  noninherited_flags.f._originalDisplay = v; }
     void setPosition(EPosition v) {  noninherited_flags.f._position = v; }
     void setFloating(EFloat v) {  noninherited_flags.f._floating = v; }
 
@@ -1003,7 +1040,14 @@
     bool hasAutoZIndex() const { return box->z_auto; }
     void setHasAutoZIndex() { SET_VAR(box, z_auto, true ); }
 
+    void setWidows(short w) { SET_VAR(inherited, widows, w); }
+    void setOrphans(short o) { SET_VAR(inherited, orphans, o); }
+    void setPageBreakInside(EPageBreak b) { SET_VAR(inherited, page_break_inside, b); }
+    void setPageBreakBefore(EPageBreak b) { noninherited_flags.f._page_break_before = b; }
+    void setPageBreakAfter(EPageBreak b) { noninherited_flags.f._page_break_after = b; }
+
     // CSS3 Setters
+    void setBoxSizing( EBoxSizing b ) { SET_VAR(box,box_sizing,b); }
     void setUserInput(EUserInput ui) { inherited_flags.f._user_input = ui; }
 
     void setMarqueeIncrement(const Length& f) { SET_VAR(css3NonInheritedData.access()->marquee, increment, f); }
@@ -1031,6 +1075,18 @@
     enum Diff { Equal, NonVisible = Equal, Visible, Position, Layout, CbLayout };
     Diff diff( const RenderStyle *other ) const;
 
+    bool isDisplayReplacedType() {
+        return display() == INLINE_BLOCK ||/* display() == INLINE_BOX ||*/ display() == INLINE_TABLE;
+    }
+    bool isDisplayInlineType() {
+        return display() == INLINE || isDisplayReplacedType();
+    }
+    bool isOriginalDisplayInlineType() {
+        return originalDisplay() == INLINE || originalDisplay() == INLINE_BLOCK ||
+               /*originalDisplay() == INLINE_BOX ||*/ originalDisplay() == INLINE_TABLE;
+    }
+
+
 #ifdef ENABLE_DUMP
     QString createDiff( const RenderStyle &parent ) const;
 #endif
@@ -1049,9 +1105,11 @@
     static EListStylePosition initialListStylePosition() { return OUTSIDE; }
     static EListStyleType initialListStyleType() { return DISC; }
     static EOverflow initialOverflow() { return OVISIBLE; }
+    static EPageBreak initialPageBreak() { return PBAUTO; }
     static EPosition initialPosition() { return STATIC; }
     static ETableLayout initialTableLayout() { return TAUTO; }
     static EUnicodeBidi initialUnicodeBidi() { return UBNormal; }
+    static EBoxSizing initialBoxSizing() { return CONTENT_BOX; }
     static ETextTransform initialTextTransform() { return TTNONE; }
     static EVisibility initialVisibility() { return VISIBLE; }
     static EWhiteSpace initialWhiteSpace() { return NORMAL; }
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_table.cpp kdelibs/khtml/rendering/render_table.cpp
--- kdelibs.orig/khtml/rendering/render_table.cpp	Fri May 14 17:15:51 2004
+++ kdelibs/khtml/rendering/render_table.cpp	Wed Nov 24 14:51:42 2004
@@ -29,6 +29,7 @@
 //#define DEBUG_LAYOUT
 //#define BOX_DEBUG
 #include "rendering/render_table.h"
+#include "rendering/render_replaced.h"
 #include "rendering/table_layout.h"
 #include "html/html_tableimpl.h"
 #include "misc/htmltags.h"
@@ -190,8 +191,7 @@
 	    }
         }
         o->addChild(child);
-	child->setLayouted( false );
-	child->setMinMaxKnown( false );
+        child->setNeedsLayoutAndMinMaxRecalc();
         return;
     }
     RenderContainer::addChild(child,beforeChild);
@@ -208,25 +208,29 @@
     RenderBlock *cb = containingBlock();
     int availableWidth = cb->contentWidth();
 
+    // Subtract minimum margins
+    availableWidth -= style()->marginLeft().minWidth(cb->contentWidth());
+    availableWidth -= style()->marginRight().minWidth(cb->contentWidth());
+
     LengthType widthType = style()->width().type();
     if(widthType > Relative && style()->width().value() > 0) {
 	// Percent or fixed table
         m_width = style()->width().minWidth( availableWidth );
         if(m_minWidth > m_width) m_width = m_minWidth;
-	//kdDebug( 6040 ) << "1 width=" << m_width << " minWidth=" << m_minWidth << " availableWidth=" << availableWidth << " " << endl;
     } else {
         m_width = KMIN(short( availableWidth ),m_maxWidth);
     }
 
     // restrict width to what we really have in case we flow around floats
     // EXCEPT percent tables, which are still calculated as above
-    if ( style()->flowAroundFloats() && widthType!=Percent ) {
-	availableWidth = cb->lineWidth( m_y );
-	m_width = KMIN( short( availableWidth ), m_width );
+    if ( flowAroundFloats() && widthType!=Percent ) {
+        availableWidth = cb->lineWidth( m_y );
+        m_width = KMIN( short( availableWidth ), m_width );
     }
 
     m_width = KMAX (m_width, m_minWidth);
 
+    // Finally, with our true width determined, compute our margins for real.
     m_marginRight=0;
     m_marginLeft=0;
 
@@ -235,11 +239,16 @@
 
 void RenderTable::layout()
 {
-    KHTMLAssert( !layouted() );
+    KHTMLAssert( needsLayout() );
     KHTMLAssert( minMaxKnown() );
     KHTMLAssert( !needSectionRecalc );
 
-    //kdDebug( 6040 ) << renderName() << "(Table)"<< this << " ::layout0() width=" << width() << ", layouted=" << layouted() << endl;
+    if (posChildNeedsLayout() && !normalChildNeedsLayout() && !selfNeedsLayout()) {
+        // All we have to is lay out our positioned objects.
+        layoutPositionedObjects(true);
+        setNeedsLayout(false);
+        return;
+    }
 
     m_height = 0;
     initMaxMarginValues();
@@ -266,7 +275,7 @@
 
     RenderObject *child = firstChild();
     while( child ) {
-	if ( !child->layouted() && !(child->element() && child->element()->id() == ID_FORM) )
+	if ( child->needsLayout() && !(child->element() && child->element()->id() == ID_FORM) )
 	    child->layout();
 	if ( child->isTableSection() ) {
 	    static_cast<RenderTableSection *>(child)->calcRowHeight();
@@ -281,39 +290,24 @@
         m_height += tCaption->height() + tCaption->marginTop() + tCaption->marginBottom();
     }
 
-    m_height += borderTop();
+    int bpTop = borderTop();
+    int bpBottom = borderBottom();
 
-    // html tables with percent height are relative to view
-    Length h = style()->height();
-    int th=0;
-    if (h.isFixed())
-        th = h.value();
-    else if (h.isPercent()) {
-        RenderObject* c = containingBlock();
-        for ( ;
-            !c->isCanvas() && !c->isBody() && !c->isTableCell() &&
-		  !c->isPositioned() && c->isFloating();
-             c = c->containingBlock()) {
-            Length ch = c->style()->height();
-            if (ch.isFixed()) {
-                th = h.width(ch.value());
-                break;
-            }
-        }
+    m_height += bpTop;
 
-        if (!c->isTableCell()) {
-            Length ch = c->style()->height();
-	    if (ch.isFixed())
-		th = h.width(ch.value());
-	    else {
-		// we need to substract out the margins of this block. -dwh
-		th = h.width(viewRect().height() - c->marginBottom() - c->marginTop());
-		// not really, but this way the view height change
-		// gets propagated correctly
-		setOverhangingContents();
-	    }
-        }
-    }
+    int oldHeight = m_height;
+    calcHeight();
+    int newHeight = m_height;
+    m_height = oldHeight;
+
+    Length h = style()->height();
+    int th = -(bpTop + bpBottom); // Tables size as though CSS height includes border/padding.
+    if (isPositioned())
+        th = newHeight; // FIXME: Leave this alone for now but investigate later.
+    else if (h.isFixed())
+        th += h.value();
+    else if (h.isPercent())
+        th += calcPercentageHeight(h);
 
     // layout rows
     if ( th > calculatedHeight ) {
@@ -346,8 +340,7 @@
 	m_height += foot->height();
     }
 
-
-    m_height += borderBottom();
+    m_height += bpBottom;
 
     if(tCaption && tCaption->style()->captionSide()==CAPBOTTOM) {
         tCaption->setPos(tCaption->marginLeft(), m_height);
@@ -356,15 +349,11 @@
 
     //kdDebug(0) << "table height: " << m_height << endl;
 
-    calcHeight();
-
-    //kdDebug(0) << "table height: " << m_height << endl;
-
     // table can be containing block of positioned elements.
     // ### only pass true if width or height changed.
     layoutPositionedObjects( true );
 
-    setLayouted();
+    setNeedsLayout(false);
 }
 
 void RenderTable::setCellWidths()
@@ -383,8 +372,7 @@
 
 void RenderTable::paint( PaintInfo& pI, int _tx, int _ty)
 {
-
-    if(!layouted()) return;
+    if(needsLayout()) return;
 
     _tx += xPos();
     _ty += yPos();
@@ -495,8 +483,7 @@
 void RenderTable::close()
 {
 //    kdDebug( 6040 ) << "RenderTable::close()" << endl;
-    setLayouted(false);
-    setMinMaxKnown(false);
+    setNeedsLayoutAndMinMaxRecalc();
 }
 
 int RenderTable::borderTopExtra()
@@ -550,8 +537,7 @@
 	child = child->nextSibling();
     }
     columnPos.resize( numEffCols()+1 );
-    setMinMaxKnown( false );
-    setLayouted( false );
+    setNeedsLayoutAndMinMaxRecalc();
 }
 
 void RenderTable::appendColumn( int span )
@@ -581,8 +567,7 @@
 	child = child->nextSibling();
     }
     columnPos.resize( numEffCols()+1 );
-    setMinMaxKnown( false );
-    setLayouted( false );
+    setNeedsLayoutAndMinMaxRecalc();
 }
 
 RenderTableCol *RenderTable::colElement( int col ) {
@@ -625,7 +610,7 @@
 	case TABLE_CAPTION:
 	    if ( !tCaption) {
 		tCaption = static_cast<RenderBlock*>(child);
-                tCaption->setLayouted(false);
+                tCaption->setNeedsLayout(true);
             }
 	    break;
 	case TABLE_COLUMN:
@@ -665,7 +650,7 @@
 	child = child->nextSibling();
     }
     needSectionRecalc = false;
-    setLayouted( false );
+    setNeedsLayout(true);
 }
 
 RenderObject* RenderTable::removeChildNode(RenderObject* child)
@@ -966,8 +951,7 @@
 	    }
         }
         row->addChild(child);
-	child->setLayouted( false );
-	child->setMinMaxKnown( false );
+        child->setNeedsLayoutAndMinMaxRecalc();
         return;
     }
 
@@ -1138,7 +1122,7 @@
 #endif
 	    int oldWidth = cell->width();
 	    if ( w != oldWidth ) {
-		cell->setLayouted(false);
+		cell->setNeedsLayout(true);
 		cell->setWidth( w );
 	    }
 	}
@@ -1183,9 +1167,15 @@
 	    if ( ( indx = r - cell->rowSpan() + 1 ) < 0 )
 		indx = 0;
 
-	    ch = cell->style()->height().width(0);
-	    if ( cell->height() > ch)
-		ch = cell->height();
+            if (cell->cellPercentageHeight()) {
+                cell->setCellPercentageHeight(0);
+                cell->setChildNeedsLayout(true, false);
+                cell->layoutIfNeeded();
+            }
+
+            ch = cell->style()->height().width(0);
+            if ( cell->height() > ch)
+                ch = cell->height();
 
 	    pos = rowPos[ indx ] + ch + vspacing;
 
@@ -1235,19 +1225,19 @@
     if (toAdd && totalRows && (rowPos[totalRows] || !nextSibling())) {
 
 	int totalHeight = rowPos[totalRows] + toAdd;
-// 	qDebug("layoutRows: totalHeight = %d",  totalHeight );
+//	qDebug("layoutRows: totalHeight = %d",  totalHeight );
 
-        int dh = totalHeight-rowPos[totalRows];
+        int dh = toAdd;
 	int totalPercent = 0;
 	int numVariable = 0;
 	for ( int r = 0; r < totalRows; r++ ) {
-	    if ( grid[r].height.isVariable() )
+            if ( grid[r].height.isVariable() && !emptyRow(r))
 		numVariable++;
 	    else if ( grid[r].height.isPercent() )
 		totalPercent += grid[r].height.value();
 	}
 	if ( totalPercent ) {
-// 	    qDebug("distributing %d over percent rows totalPercent=%d", dh,  totalPercent );
+//	    qDebug("distributing %d over percent rows totalPercent=%d", dh,  totalPercent );
 	    // try to satisfy percent
 	    int add = 0;
 	    if ( totalPercent > 100 )
@@ -1262,7 +1252,7 @@
 		    add += toAdd;
 		    dh -= toAdd;
 		    totalPercent -= grid[r].height.value();
-// 		    qDebug( "adding %d to row %d", toAdd, r );
+//		    qDebug( "adding %d to row %d", toAdd, r );
 		}
 		if ( r < totalRows-1 )
 		    rh = rowPos[r+2] - rowPos[r+1];
@@ -1270,20 +1260,20 @@
 	    }
 	}
 	if ( numVariable ) {
-	    // distribute over variable cols
-// 	    qDebug("distributing %d over variable rows numVariable=%d", dh,  numVariable );
+	    // distribute over non-empty variable rows
+//	    qDebug("distributing %d over variable rows numVariable=%d", dh,  numVariable );
 	    int add = 0;
-	    for ( int r = 0; r < totalRows; r++ ) {
-		if ( numVariable > 0 && grid[r].height.isVariable() ) {
-		    int toAdd = dh/numVariable;
+            int toAdd = dh/numVariable;
+            for ( int r = 0; r < totalRows; r++ ) {
+                if ( grid[r].height.isVariable() && !emptyRow(r)) {
 		    add += toAdd;
-		    dh -= toAdd;
 		}
                 rowPos[r+1] += add;
 	    }
-	}
-        if (dh>0) {
-	    // if some left overs, distribute equally.
+            dh -= add;
+        }
+        if (dh>0 && rowPos[totalRows]) {
+	    // if some left overs, distribute weighted.
             int tot=rowPos[totalRows];
             int add=0;
             int prev=rowPos[0];
@@ -1293,7 +1283,29 @@
                 prev=rowPos[r+1];
                 rowPos[r+1]+=add;
             }
+            dh -= add;
+        }
+        if (dh > totalRows) {
+            // distribute to tables with all empty rows
+            int add=0;
+            int toAdd = dh/totalRows;
+            for ( int r = 0; r < totalRows; r++ ) {
+                add += toAdd;
+                rowPos[r+1] += add;
+            }
+            dh -= add;
         }
+        // Finally distribute round-off values
+        if (dh > 0) {
+            // There is not enough for every row
+            int add=0;
+            for ( int r = 0; r < totalRows; r++ ) {
+                if (add < dh) add++;
+                rowPos[r+1] += add;
+            }
+            dh -= add;
+        }
+        assert (dh == 0);
     }
 
     int leftOffset = borderLeft() + hspacing;
@@ -1325,15 +1337,20 @@
             bool cellChildrenFlex = false;
             RenderObject* o = cell->firstChild();
             while (o) {
-                if (o->style()->height().isPercent()) {
-                    o->setLayouted(false);
+                if (!o->isText() && o->style()->height().isPercent()) {
+                    if (o->isWidget()) {
+                        // cancel resizes from transitory relayouts
+                        static_cast<RenderWidget *>(o)->cancelPendingResize();
+                    }
+                    o->setNeedsLayout(true, false);
+                    cell->setChildNeedsLayout(true, false);
                     cellChildrenFlex = true;
                 }
                 o = o->nextSibling();
             }
             if (cellChildrenFlex) {
                 cell->setCellPercentageHeight(rHeight);
-                if (!cell->layouted()) cell->layout();
+                cell->layoutIfNeeded();
 
                 // Alignment within a cell is based off the calculated
                 // height, which becomes irrelevant once the cell has
@@ -1474,7 +1491,7 @@
 	row = row->nextSibling();
     }
     needCellRecalc = false;
-    setLayouted( false );
+    setNeedsLayout(true);
 }
 
 void RenderTableSection::clearGrid()
@@ -1485,6 +1502,19 @@
     }
 }
 
+bool RenderTableSection::emptyRow(int rowNum) {
+    Row &r = *grid[rowNum].row;
+    const int s = r.size();
+    RenderTableCell *cell;
+    for(int i=0; i<s; i++) {
+        cell = r[i];
+        if (!cell || cell==(RenderTableCell*)-1)
+            continue;
+        return false;
+    }
+    return true;
+}
+
 RenderObject* RenderTableSection::removeChildNode(RenderObject* child)
 {
     setNeedCellRecalc();
@@ -1564,7 +1594,7 @@
 
 //    bool save_last = false;	// true to save last investigated cell
 
-    if (!layouted() || _y < _ty) return SelectionPointBefore;
+    if (needsLayout() || _y < _ty) return SelectionPointBefore;
 //    else if (_y >= _ty + height()) save_last = true;
 
     // bluntly taken from paint (LS)
@@ -1683,8 +1713,7 @@
 	    addChild(cell, beforeChild);
         }
         cell->addChild(child);
-	child->setLayouted( false );
-	child->setMinMaxKnown( false );
+        child->setNeedsLayoutAndMinMaxRecalc();
         return;
     } else
         cell = static_cast<RenderTableCell *>(child);
@@ -1714,19 +1743,14 @@
 
 void RenderTableRow::layout()
 {
-    KHTMLAssert( !layouted() );
+    KHTMLAssert( needsLayout() );
     KHTMLAssert( minMaxKnown() );
 
     RenderObject *child = firstChild();
     while( child ) {
 	if ( child->isTableCell() ) {
             RenderTableCell *cell = static_cast<RenderTableCell *>(child);
-            if ( cell->cellPercentageHeight() ) {
-                cell->setCellPercentageHeight( 0 );
-                if ( cell->layouted() )
-                    cell->setLayouted( false );
-            }
-            if ( !child->layouted() ) {
+            if ( child->needsLayout() ) {
                 cell->calcVerticalMargins();
                 cell->layout();
                 cell->setCellTopExtra(0);
@@ -1735,7 +1759,7 @@
 	}
 	child = child->nextSibling();
     }
-    setLayouted();
+    setNeedsLayout(false);
 }
 
 // -------------------------------------------------------------------------
@@ -2192,10 +2216,10 @@
 {
 
 #ifdef TABLE_PRINT
-    kdDebug( 6040 ) << renderName() << "(layouted: " << layouted() << ")::paint() w/h = (" << width() << "/" << height() << ")" << " _y/_h=" << _y << "/" << _h << endl;
+    kdDebug( 6040 ) << renderName() << "(RenderTableCell)::paint() w/h = (" << width() << "/" << height() << ")" << " _y/_h=" << _y << "/" << _h << endl;
 #endif
 
-    if (!layouted()) return;
+    if (needsLayout()) return;
 
     _tx += m_x;
     _ty += m_y/* + _topExtra*/;
@@ -2205,7 +2229,7 @@
     // check if we need to do anything at all...
     int os = kMax(tbl->currentBorderStyle() ? (tbl->currentBorderStyle()->border->width+1)/2 : 0, 2*maximalOutlineSize(pI.phase));
     if (!overhangingContents() && ((_ty >= pI.r.y() + pI.r.height() + os)
-                                   || (_ty + _topExtra + m_height + _bottomExtra <= pI.r.y() - os))) return;
+         || (_ty + _topExtra + m_height + _bottomExtra <= pI.r.y() - os))) return;
 
     if (pI.phase == PaintActionCollapsedTableBorders && style()->visibility() == VISIBLE) {
         int w = width();
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_table.h kdelibs/khtml/rendering/render_table.h
--- kdelibs.orig/khtml/rendering/render_table.h	Sat Jun 26 15:09:08 2004
+++ kdelibs/khtml/rendering/render_table.h	Fri Nov 19 12:35:38 2004
@@ -6,6 +6,7 @@
  *           (C) 1998 Waldo Bastian (bastian@kde.org)
  *           (C) 1999-2003 Lars Knoll (knoll@kde.org)
  *           (C) 1999 Antti Koivisto (koivisto@kde.org)
+ *           (C) 2003 Apple Computer, Inc.
  *
  * This library is free software; you can redistribute it and/or
  * modify it under the terms of the GNU Library General Public
@@ -22,7 +23,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #ifndef RENDER_TABLE_H
 #define RENDER_TABLE_H
@@ -283,6 +283,7 @@
 protected:
     void ensureRows( int numRows );
     void clearGrid();
+    bool emptyRow(int rowNum);
 
     friend class TableSectionIterator;
 };
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_text.cpp kdelibs/khtml/rendering/render_text.cpp
--- kdelibs.orig/khtml/rendering/render_text.cpp	Tue Sep  7 22:01:00 2004
+++ kdelibs/khtml/rendering/render_text.cpp	Wed Nov 17 14:59:17 2004
@@ -20,7 +20,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 
 //#define DEBUG_LAYOUT
@@ -525,8 +524,11 @@
         RenderObject::setStyle( _style );
         m_lineHeight = RenderObject::lineHeight(false);
 
-        if (changedText && element() && element()->string())
-            setText(element()->string(), changedText);
+        if (changedText) {
+            DOM::DOMStringImpl* textToTransform = originalString();
+            if (textToTransform)
+                setText(textToTransform, true);
+        }
     }
 }
 
@@ -557,6 +559,16 @@
     KHTMLAssert(m_lines.count() == 0);
 }
 
+bool RenderText::isTextFragment() const
+{
+    return false;
+}
+
+DOM::DOMStringImpl* RenderText::originalString() const
+{
+    return element() ? element()->string() : 0;
+}
+
 InlineTextBox * RenderText::findInlineTextBox( int offset, int &pos, bool checkFirstLetter )
 {
     // The text boxes point to parts of the rendertext's str string
@@ -889,7 +901,7 @@
                 {
                    RenderCanvas *rootObj = canvas();
                    if (ty+s->m_y < rootObj->truncatedAt())
-                      rootObj->setTruncatedAt(ty+s->m_y);
+                      rootObj->setBestTruncatedAt(ty+s->m_y, this);
                    // Let's stop here.
                    break;
                 }
@@ -1157,8 +1169,7 @@
     KHTMLAssert(!isBR() || (str->l == 1 && (*str->s) == '\n'));
     KHTMLAssert(!str->l || str->s);
 
-    setLayouted(false);
-    setMinMaxKnown(false);
+    setNeedsLayoutAndMinMaxRecalc();
 #ifdef BIDI_DEBUG
     QConstString cstr(str->s, str->l);
     kdDebug( 6040 ) << "RenderText::setText( " << cstr.string().length() << " ) '" << cstr.string() << "'" << endl;
@@ -1437,5 +1448,46 @@
 }
 #endif
 
+RenderTextFragment::RenderTextFragment(DOM::NodeImpl* _node, DOM::DOMStringImpl* _str,
+                                       int startOffset, int endOffset)
+:RenderText(_node, _str->substring(startOffset, endOffset)),
+m_start(startOffset), m_end(endOffset), m_generatedContentStr(0)
+{}
+
+RenderTextFragment::RenderTextFragment(DOM::NodeImpl* _node, DOM::DOMStringImpl* _str)
+:RenderText(_node, _str), m_start(0)
+{
+    m_generatedContentStr = _str;
+    if (_str) {
+        _str->ref();
+        m_end = _str->l;
+    }
+    else
+        m_end = 0;
+}
+
+RenderTextFragment::~RenderTextFragment()
+{
+    if (m_generatedContentStr)
+        m_generatedContentStr->deref();
+}
+
+bool RenderTextFragment::isTextFragment() const
+{
+    return true;
+}
+
+DOM::DOMStringImpl* RenderTextFragment::originalString() const
+{
+    DOM::DOMStringImpl* result = 0;
+    if (element())
+        result = element()->string();
+    else
+        result = contentString();
+    if (result && (start() > 0 || start() < result->l))
+        result = result->substring(start(), end());
+    return result;
+}
+
 #undef BIDI_DEBUG
 #undef DEBUG_LAYOUT
diff -urN -x CVS kdelibs.orig/khtml/rendering/render_text.h kdelibs/khtml/rendering/render_text.h
--- kdelibs.orig/khtml/rendering/render_text.h	Tue Jun 22 05:30:53 2004
+++ kdelibs/khtml/rendering/render_text.h	Wed Nov 17 14:59:17 2004
@@ -20,7 +20,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #ifndef RENDERTEXT_H
 #define RENDERTEXT_H
@@ -149,6 +148,9 @@
     RenderText(DOM::NodeImpl* node, DOM::DOMStringImpl *_str);
     virtual ~RenderText();
 
+    virtual bool isTextFragment() const;
+    virtual DOM::DOMStringImpl* originalString() const;
+
     virtual const char *renderName() const { return "RenderText"; }
 
     virtual void setStyle(RenderStyle *style);
@@ -295,5 +297,31 @@
 inline RenderText* InlineTextBox::renderText()
 { return static_cast<RenderText*>( object() ); }
 
-}
+// Used to represent a text substring of an element, e.g., for text runs that are split because of
+// first letter and that must therefore have different styles (and positions in the render tree).
+// We cache offsets so that text transformations can be applied in such a way that we can recover
+// the original unaltered string from our corresponding DOM node.
+class RenderTextFragment : public RenderText
+{
+public:
+    RenderTextFragment(DOM::NodeImpl* _node, DOM::DOMStringImpl* _str,
+                       int startOffset, int endOffset);
+    RenderTextFragment(DOM::NodeImpl* _node, DOM::DOMStringImpl* _str);
+    ~RenderTextFragment();
+
+    virtual bool isTextFragment() const;
+    virtual const char *renderName() const { return "RenderTextFragment"; }
+
+    uint start() const { return m_start; }
+    uint end() const { return m_end; }
+
+    DOM::DOMStringImpl* contentString() const { return m_generatedContentStr; }
+    virtual DOM::DOMStringImpl* originalString() const;
+
+private:
+    uint m_start;
+    uint m_end;
+    DOM::DOMStringImpl* m_generatedContentStr;
+};
+} // end namespace
 #endif
diff -urN -x CVS kdelibs.orig/khtml/rendering/table_layout.cpp kdelibs/khtml/rendering/table_layout.cpp
--- kdelibs.orig/khtml/rendering/table_layout.cpp	Mon Oct 20 00:09:25 2003
+++ kdelibs/khtml/rendering/table_layout.cpp	Sun Nov 28 21:27:16 2004
@@ -19,7 +19,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #include "table_layout.h"
 #include "render_table.h"
@@ -51,7 +50,7 @@
     1. A column element with a value other than 'auto' for the 'width'
     property sets the width for that column.
 
-    2.Otherwise, a cell in the first row with a value other than
+    2. Otherwise, a cell in the first row with a value other than
     'auto' for the 'width' property sets the width for that column. If
     the cell spans more than one column, the width is divided over the
     columns.
@@ -88,7 +87,7 @@
 {
 }
 
-int FixedTableLayout::calcWidthArray( int /*tableWidth*/ )
+int FixedTableLayout::calcWidthArray( int tableWidth )
 {
     int usedWidth = 0;
 
@@ -122,7 +121,7 @@
 		}
 #ifdef DEBUG_LAYOUT
 		qDebug("    col element: effCol=%d, span=%d: %d w=%d type=%d",
-		       cCol, span, effWidth,  w.value, w.type);
+                       cCol, span, effWidth,  w.value(), w.type());
 #endif
 		int usedSpan = 0;
 		int i = 0;
@@ -139,7 +138,7 @@
 			usedWidth += effWidth * eSpan;
 #ifdef DEBUG_LAYOUT
 			qDebug("    setting effCol %d (span=%d) to width %d(type=%d)",
-			       cCol+i, eSpan, width[cCol+i].value, width[cCol+i].type );
+                               cCol+i, eSpan, width[cCol+i].value(), width[cCol+i].type() );
 #endif
 		    }
 		    usedSpan += eSpan;
@@ -198,7 +197,7 @@
 			usedWidth += effWidth*eSpan;
 #ifdef DEBUG_LAYOUT
 			qDebug("    setting effCol %d (span=%d) to width %d(type=%d)",
-			       cCol+i, eSpan, width[cCol+i].value, width[cCol+i].type );
+                               cCol+i, eSpan, width[cCol+i].value(), width[cCol+i].type() );
 #endif
 		    }
 #ifdef DEBUG_LAYOUT
@@ -270,7 +269,15 @@
     calcWidth.resize( nEffCols );
     calcWidth.fill( -1 );
 
-    // assign  percent width
+    // first assign fixed width
+    for ( int i = 0; i < nEffCols; i++ ) {
+        if ( width[i].isFixed() ) {
+            calcWidth[i] = width[i].value();
+            available -= width[i].value();
+        }
+    }
+
+    // assign percent width
     if ( available > 0 ) {
 	int totalPercent = 0;
 	for ( int i = 0; i < nEffCols; i++ )
@@ -296,15 +303,7 @@
         }
     }
 
-    // next assign  fixed width
-    for ( int i = 0; i < nEffCols; i++ ) {
-	if ( width[i].isFixed() ) {
-	    calcWidth[i] = width[i].value();
-	    available -= width[i].value();
-	}
-    }
-
-    // assign  variable width
+    // assign variable width
     if ( available > 0 ) {
 	int totalVariable = 0;
 	for ( int i = 0; i < nEffCols; i++ )
@@ -322,7 +321,7 @@
     }
 
     for ( int i = 0; i < nEffCols; i++ )
-	if ( calcWidth[i] <= 0 )
+	if ( calcWidth[i] < 0 )
 	    calcWidth[i] = 0; // IE gives min 1 px...
 
     // spread extra space over columns
@@ -330,7 +329,7 @@
         int total = nEffCols;
         // still have some width to spread
         int i = nEffCols;
-        while (  i-- ) {
+        while ( i-- ) {
             int w = available / total;
             available -= w;
             total--;
@@ -463,7 +462,7 @@
 
     l.maxWidth = kMax(l.maxWidth, l.minWidth);
 #ifdef DEBUG_LAYOUT
-    qDebug("col %d, final min=%d, max=%d, width=%d(%d)", effCol, l.minWidth, l.maxWidth, l.width.value,  l.width.type );
+    qDebug("col %d, final min=%d, max=%d, width=%d(%d)", effCol, l.minWidth, l.maxWidth, l.width.value(),  l.width.type() );
 #endif
 
     // ### we need to add col elements aswell
@@ -499,7 +498,7 @@
 		    w = Length();
 		int cEffCol = table->colToEffCol( cCol );
 #ifdef DEBUG_LAYOUT
-		qDebug("    col element %d (eff=%d): Length=%d(%d), span=%d, effColSpan=%d",  cCol, cEffCol, w.value, w.type, span, table->spanOfEffCol(cEffCol ) );
+		qDebug("    col element %d (eff=%d): Length=%d(%d), span=%d, effColSpan=%d",  cCol, cEffCol, w.value(), w.type(), span, table->spanOfEffCol(cEffCol ) );
 #endif
 		if ( !w.isVariable() && span == 1 && cEffCol < nEffCols ) {
 		    if ( table->spanOfEffCol( cEffCol ) == 1 ) {
@@ -537,7 +536,7 @@
     while (table) {
         Length tw = table->style()->width();
         if ((tw.isVariable() || tw.isPercent()) && !table->isPositioned()) {
-            RenderObject* cb = table->containingBlock();
+            RenderBlock* cb = table->containingBlock();
             while (cb && !cb->isCanvas() && !cb->isTableCell() &&
                 cb->style()->width().isVariable() && !cb->isPositioned())
                 cb = cb->containingBlock();
@@ -589,7 +588,7 @@
 	}
     }
 
-    if (false && shouldScaleColumns(table)) {
+    if (shouldScaleColumns(table)) {
         maxNonPercent = (maxNonPercent * 100 + 50) / kMax(remainingPercent, 1);
 	maxWidth = kMax( maxNonPercent, maxWidth );
 	maxWidth = kMax( maxWidth, maxPercent );
@@ -668,7 +667,7 @@
                     fixedWidth += layoutStruct[lastCol].width.value();
                     allColsArePercent = false;
                     // IE resets effWidth to Variable here, but this breaks the konqueror about page and seems to be some bad
-                    // legacy behavior anyway. mozilla doesn't do this so I decided we don't neither.
+                    // legacy behavior anyway. mozilla doesn't do this so I decided we don't either.
                     break;
                 }
                 // fall through
@@ -676,11 +675,22 @@
 		haveVariable = true;
 		// fall through
 	    default:
-		layoutStruct[lastCol].effWidth = Length();
-		allColsArePercent = false;
-		allColsAreFixed = false;
-	    }
-	    span -= table->spanOfEffCol( lastCol );
+                // If the column is a percentage width, do not let the spanning cell overwrite the
+                // width value.  This caused a mis-rendering on amazon.com.
+                // Sample snippet:
+                // <table border=2 width=100%><
+                //   <tr><td>1</td><td colspan=2>2-3</tr>
+                //   <tr><td>1</td><td colspan=2 width=100%>2-3</td></tr>
+                // </table>
+                if (!layoutStruct[lastCol].effWidth.isPercent()) {
+                    layoutStruct[lastCol].effWidth = Length();
+                    allColsArePercent = false;
+                }
+                else
+                    totalPercent += layoutStruct[lastCol].effWidth.value();
+                allColsAreFixed = false;
+            }
+            span -= table->spanOfEffCol( lastCol );
 	    minWidth += layoutStruct[lastCol].effMinWidth;
 	    maxWidth += layoutStruct[lastCol].effMaxWidth;
 	    lastCol++;
@@ -688,7 +698,7 @@
 	    cMaxWidth -= hspacing;
 	}
 #ifdef DEBUG_LAYOUT
-	qDebug("    colspan cell %p at effCol %d, span %d, type %d, value %d cmin=%d min=%d fixedwidth=%d", cell, col, cSpan, w.type, w.value, cMinWidth, minWidth, fixedWidth );
+	qDebug("    colspan cell %p at effCol %d, span %d, type %d, value %d cmin=%d min=%d fixedwidth=%d", cell, col, cSpan, w.type(), w.value(), cMinWidth, minWidth, fixedWidth );
 #endif
 
 	// adjust table max width if needed
@@ -703,7 +713,7 @@
 #endif
 		tMaxWidth = kMax( tMaxWidth, spanMax * 100 / w.value() );
 
-		// all non percent columns in the span get percent vlaues to sum up correctly.
+		// all non percent columns in the span get percent values to sum up correctly.
 		int percentMissing = w.value() - totalPercent;
 		int totalWidth = 0;
 		for ( unsigned int pos = col; pos < lastCol; pos++ ) {
@@ -751,6 +761,8 @@
 #endif
 		int maxw = maxWidth;
 		int minw = minWidth;
+
+                // Give min to variable first, to fixed second, and to others third.
 		for ( unsigned int pos = col; maxw > 0 && pos < lastCol; pos++ ) {
 		    if ( layoutStruct[pos].width.isFixed() && haveVariable && fixedWidth <= cMinWidth ) {
 			int w = kMax( int( layoutStruct[pos].effMinWidth ), layoutStruct[pos].width.value() );
@@ -857,10 +869,10 @@
     qDebug("    tableWidth=%d,  nEffCols=%d", tableWidth,  nEffCols );
     for ( int i = 0; i < nEffCols; i++ ) {
 	qDebug("    effcol %d is of type %d value %d, minWidth=%d, maxWidth=%d",
-	       i, layoutStruct[i].width.type, layoutStruct[i].width.value,
+               i, layoutStruct[i].width.type(), layoutStruct[i].width.value(),
 	       layoutStruct[i].minWidth, layoutStruct[i].maxWidth );
 	qDebug("        effective: type %d value %d, minWidth=%d, maxWidth=%d",
-	       layoutStruct[i].effWidth.type, layoutStruct[i].effWidth.value,
+               layoutStruct[i].effWidth.type(), layoutStruct[i].effWidth.value(),
 	       layoutStruct[i].effMinWidth, layoutStruct[i].effMaxWidth );
     }
 #endif
@@ -980,41 +992,41 @@
     qDebug("variable satisfied: available is %d",  available );
 #endif
 
-    // spread over percent colums
-    if ( available > 0 && hasPercent && totalPercent < 100) {
-        // still have some width to spread, distribute weighted to percent columns
+    // spread over fixed colums
+    if ( available > 0 && numFixed) {
+        // still have some width to spread, distribute to fixed columns
         for ( int i = 0; i < nEffCols; i++ ) {
             const Length &width = layoutStruct[i].effWidth;
-            if ( width.isPercent() ) {
-                int w = available * width.value() / totalPercent;
+            if ( width.isFixed() ) {
+                int w = available * layoutStruct[i].effMaxWidth / totalFixed;
                 available -= w;
-                totalPercent -= width.value();
+                totalFixed -= layoutStruct[i].effMaxWidth;
                 layoutStruct[i].calcWidth += w;
-                if (!available || !totalPercent) break;
             }
         }
     }
 
 #ifdef DEBUG_LAYOUT
-    qDebug("after percent distribution: available=%d",  available );
+    qDebug("after fixed distribution: available=%d",  available );
 #endif
 
-    // spread over fixed colums
-    if ( available > 0 && numFixed) {
-        // still have some width to spread, distribute to fixed columns
+    // spread over percent colums
+    if ( available > 0 && hasPercent && totalPercent < 100) {
+        // still have some width to spread, distribute weighted to percent columns
         for ( int i = 0; i < nEffCols; i++ ) {
             const Length &width = layoutStruct[i].effWidth;
-            if ( width.isFixed() ) {
-                int w = available * layoutStruct[i].effMaxWidth / totalFixed;
+            if ( width.isPercent() ) {
+                int w = available * width.value() / totalPercent;
                 available -= w;
-                totalFixed -= layoutStruct[i].effMaxWidth;
+                totalPercent -= width.value();
                 layoutStruct[i].calcWidth += w;
+                if (!available || !totalPercent) break;
             }
         }
     }
 
 #ifdef DEBUG_LAYOUT
-    qDebug("after fixed distribution: available=%d",  available );
+    qDebug("after percent distribution: available=%d",  available );
 #endif
 
     // spread over the rest
diff -urN -x CVS kdelibs.orig/khtml/rendering/table_layout.h kdelibs/khtml/rendering/table_layout.h
--- kdelibs.orig/khtml/rendering/table_layout.h	Tue Jan 27 19:49:16 2004
+++ kdelibs/khtml/rendering/table_layout.h	Wed Nov 17 14:43:03 2004
@@ -19,7 +19,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #ifndef TABLE_LAYOUT_H
 #define TABLE_LAYOUT_H
diff -urN -x CVS kdelibs.orig/khtml/test/fixed-background.html kdelibs/khtml/test/fixed-background.html
--- kdelibs.orig/khtml/test/fixed-background.html	Sat Jul 15 23:11:00 2000
+++ kdelibs/khtml/test/fixed-background.html	Wed Nov 17 14:43:04 2004
@@ -17,7 +17,6 @@
 //----------------------------------------------------------------------------
 //
 // KDE HTML Widget -- Debug functions
-// $Id$
 
 #include <stdio.h>
 #include <stdarg.h>
diff -urN -x CVS kdelibs.orig/khtml/test_regression.cpp kdelibs/khtml/test_regression.cpp
--- kdelibs.orig/khtml/test_regression.cpp	Tue Sep  7 17:27:54 2004
+++ kdelibs/khtml/test_regression.cpp	Wed Nov 10 10:00:15 2004
@@ -31,6 +31,7 @@
 #include <signal.h>
 
 #include <kapplication.h>
+#include <qimage.h>
 #include <qfile.h>
 #include "test_regression.h"
 #include <unistd.h>
@@ -63,13 +64,13 @@
 #include <qfileinfo.h>
 #include <qtimer.h>
 
-#include "decoder.h"
+#include "misc/decoder.h"
 #include "dom/dom2_range.h"
 #include "dom/dom_exception.h"
 #include "dom/html_document.h"
-#include "html_document.h"
-#include "htmltokenizer.h"
+#include "html/htmltokenizer.h"
 #include "khtml_part.h"
+#include "khtmlpart_p.h"
 
 #include "khtmlview.h"
 #include "rendering/render_replaced.h"
@@ -100,6 +101,7 @@
     m_completed = false;
     m_ownLoopLevel = 0;
     connect(m_part,SIGNAL(completed()),this,SLOT(partCompleted()));
+    m_timer_waits = 200;
 }
 
 void PartMonitor::waitForCompletion()
@@ -113,10 +115,13 @@
 
 	if (--sm_loopLevel) {
 	    assert(m_previousMonitor);
-	    QTimer::singleShot( visual ? 100 : 20 , m_previousMonitor, SLOT( timeout() ) );
+	    QTimer::singleShot( visual ? 100 : 10 , m_previousMonitor, SLOT( timeout() ) );
 	}
 	sm_highestMonitor = m_previousMonitor;
     }
+
+    QTimer::singleShot( 0, this, SLOT( finishTimers() ) );
+    kapp->enter_loop();
 }
 
 void PartMonitor::timeout()
@@ -124,6 +129,18 @@
     kapp->exit_loop();
 }
 
+void PartMonitor::finishTimers()
+{
+    KJS::Window *w = KJS::Window::retrieveWindow( m_part );
+    --m_timer_waits;
+    if ( m_timer_waits && w && w->winq->hasTimers() ) {
+        // wait a bit
+        QTimer::singleShot( 10, this, SLOT(finishTimers() ) );
+        return;
+    }
+    kapp->exit_loop();
+}
+
 void PartMonitor::partCompleted()
 {
     if (m_ownLoopLevel == 0) {
@@ -132,7 +149,7 @@
     else if (m_ownLoopLevel == sm_loopLevel)
     {
         RenderWidget::flushWidgetResizes();
-        QTimer::singleShot( visual ? 100 : 20, this, SLOT( timeout() ) );
+        QTimer::singleShot( visual ? 100 : 2, this, SLOT( timeout() ) );
     }
     disconnect(m_part,SIGNAL(completed()),this,SLOT(partCompleted()));
 }
@@ -381,7 +398,7 @@
         exit(1);
     }
         
-    QString kh("/var/tmp/%1-khtml_testregression");
+    QString kh("/var/tmp/%1_non_existant");
     kh = kh.arg( pw->pw_name );
     setenv( "KDEHOME", kh.latin1(), 1 );
     setenv( "LC_ALL", "C", 1 );
@@ -682,7 +699,9 @@
 	m_currentCategory = relativeDir;
 	m_currentTest = filename;
         m_known_failures = known_failure;
-	if ( filename.endsWith(".html") || filename.endsWith( ".htm" ) ) {
+	if ( filename.endsWith(".html") || filename.endsWith( ".htm" ) || filename.endsWith( ".xhtml" ) ) {
+            if ( relPath.startsWith( "domts/" ) && !m_runJS )
+                return true;
             if ( m_runHTML )
                 testStaticFile(relPath);
 	}
@@ -837,8 +856,6 @@
     if (ew * eh > 4000 * 4000) // don't DoS us
         return QImage();
 
-#if 1
-
     QImage img( ew, eh, 32 );
     img.fill( 0xff0000 );
     if (!m_paintBuffer )
@@ -861,20 +878,6 @@
                 memcpy( img.scanLine( py+y ) + px*4, chunk.scanLine( y ), kMin( 512, ew-px )*4 );
         }
     }
-#else
-    delete m_paintBuffer;
-    m_paintBuffer = new QPixmap( ew, eh, -1, QPixmap::MemoryOptim );
-    QPainter* tp = new QPainter;
-    tp->begin( m_paintBuffer );
-    tp->fillRect(0, 0, ew, eh, Qt::magenta);
-    // bad idea: this switches KHTML into *printing* mode. no wonder everything
-    // was so broken..
-    m_part->paint( tp, QRect( 0, 0, ew, eh ) );
-    tp->end();
-    delete tp;
-    QImage img = m_paintBuffer->convertToImage();
-
-#endif
 
     assert( img.depth() == 32 );
     return img;
@@ -898,9 +901,9 @@
             for ( int x = 0; x < w; ++x ) {
                 QRgb l = ls[x];
                 QRgb r = rs[x];
-                if ( ( abs( qRed( l ) - qRed(r ) ) < 10 ) &&
-                     ( abs( qGreen( l ) - qGreen(r ) ) < 10 ) &&
-                     ( abs( qBlue( l ) - qBlue(r ) ) < 10 ) )
+                if ( ( abs( qRed( l ) - qRed(r ) ) < 20 ) &&
+                     ( abs( qGreen( l ) - qGreen(r ) ) < 20 ) &&
+                     ( abs( qBlue( l ) - qBlue(r ) ) < 20 ) )
                     continue;
                  kdDebug() << "pixel (" << x << ", " << y << ") is different " << QColor(  lhsi.pixel (  x, y ) ) << " " << QColor(  rhsi.pixel (  x, y ) ) << endl;
                 return false;
@@ -1039,8 +1042,12 @@
         FILE *pipe = popen( QString::fromLatin1( "diff -u baseline/%1-render %3/%2-render" )
                             .arg ( test, test, relOutputDir ).latin1(), "r" );
         QTextIStream *is = new QTextIStream( pipe );
-        for ( int line = 0; line < 100 && !is->eof(); ++line )
-            renderDiff += is->readLine() + "\n";
+        for ( int line = 0; line < 100 && !is->eof(); ++line ) {
+            QString line = is->readLine();
+            line = line.replace( '<', "&lt;" );
+            line = line.replace( '>', "&gt;" );
+            renderDiff += line + "\n";
+        }
         delete is;
         pclose( pipe );
         renderDiff += "</pre>";
@@ -1051,8 +1058,12 @@
         FILE *pipe = popen( QString::fromLatin1( "diff -u baseline/%1-dom %3/%2-dom" )
                             .arg ( test, test, relOutputDir ).latin1(), "r" );
         QTextIStream *is = new QTextIStream( pipe );
-        for ( int line = 0; line < 100 && !is->eof(); ++line )
-            domDiff += is->readLine() + "\n";
+        for ( int line = 0; line < 100 && !is->eof(); ++line ) {
+            QString line = is->readLine();
+            line = line.replace( '<', "&lt;" );
+            line = line.replace( '>', "&gt;" );
+            domDiff += line  + "\n";
+        }
         delete is;
         pclose( pipe );
         domDiff += "</pre>";
@@ -1223,9 +1234,9 @@
 
         if ( m_known_failures & PaintFailure )
             m_known_failures = AllFailure;
-        bool dumped = checkPaintdump(filename);
+        CheckResult dumped = checkPaintdump(filename);
         reportResult( dumped, "PAINT");
-        if (!dumped)
+        if (dumped == Failure)
             failures |= PaintFailure;
 
         doFailureReport(filename, failures );
@@ -1266,7 +1277,7 @@
         } else if ( saw_failure ) {
             if ( !expected_failure )
                 doFailureReport( m_currentCategory + "/" + m_currentTest, JSFailure );
-            reportResult( !expected_failure, "saw 'failed!'" );
+            reportResult( expected_failure, "saw 'failed!'" );
         } else {
             reportResult( !expected_failure, "passed" );
         }
@@ -1286,7 +1297,9 @@
     // note: this is different from the interpreter used by the part,
     // it contains regression test-specific objects & functions
     Object global(new GlobalImp());
-    ScriptInterpreter interp(global,m_part);
+    khtml::ChildFrame frame;
+    frame.m_part = m_part;
+    ScriptInterpreter interp(global,&frame);
     ExecState *exec = interp.globalExec();
 
     global.put(exec, "part", Object(new KHTMLPartObject(exec,m_part)));
@@ -1307,15 +1320,15 @@
     evalJS( interp, m_baseDir + "/tests/"+ filename, true );
 }
 
-bool RegressionTest::checkPaintdump(const QString &filename)
+RegressionTest::CheckResult RegressionTest::checkPaintdump(const QString &filename)
 {
     QString againstFilename( filename + "-dump.png" );
     QString absFilename = QFileInfo(m_baseDir + "/baseline/" + againstFilename).absFilePath();
     if ( cvsIgnored( absFilename ) ) {
         m_known_failures = NoFailure;
-        return true;
+        return Ignored;
     }
-    bool result = false;
+    CheckResult result = Failure;
 
     QImage baseline;
     baseline.load( absFilename, "PNG");
@@ -1327,24 +1340,24 @@
     }
     else {
         ::unlink( QFile::encodeName( m_outputDir + "/" + againstFilename ) );
-        result = true;
+        result = Success;
     }
     return result;
 }
 
-bool RegressionTest::checkOutput(const QString &againstFilename)
+RegressionTest::CheckResult RegressionTest::checkOutput(const QString &againstFilename)
 {
     QString absFilename = QFileInfo(m_baseDir + "/baseline/" + againstFilename).absFilePath();
     if ( cvsIgnored( absFilename ) ) {
         m_known_failures = NoFailure;
-        return true;
+        return Ignored;
     }
 
     bool domOut = againstFilename.endsWith( "-dom" );
     QString data = getPartOutput( domOut ? DOMTree : RenderTree );
     data.remove( char( 13 ) );
 
-    bool result = true;
+    CheckResult result = Success;
 
     // compare result to existing file
     QString outputFilename = QFileInfo(m_outputDir + "/" + againstFilename).absFilePath();
@@ -1368,10 +1381,10 @@
 
         QString fileData = stream.read();
 
-        result = ( fileData == data );
-        if ( !m_genOutput && result ) {
+        result = ( fileData == data ) ? Success : Failure;
+        if ( !m_genOutput && result == Success ) {
             ::unlink( QFile::encodeName( outputFilename ) );
-            return true;
+            return Success;
         }
     }
 
@@ -1392,6 +1405,16 @@
     return result;
 }
 
+bool RegressionTest::reportResult(CheckResult result, const QString & description)
+{
+    if ( result == Ignored ) {
+        //printf("IGNORED: ");
+        //printDescription( description );
+        return true; // no error
+    } else
+        return reportResult( result == Success, description );
+}
+
 bool RegressionTest::reportResult(bool passed, const QString & description)
 {
     if (m_genOutput)
@@ -1417,6 +1440,12 @@
         }
     }
 
+    printDescription( description );
+    return passed;
+}
+
+void RegressionTest::printDescription(const QString& description)
+{
     if (!m_currentCategory.isEmpty())
 	printf("%s/", m_currentCategory.latin1());
 
@@ -1430,7 +1459,6 @@
 
     printf("\n");
     fflush(stdout);
-    return passed;
 }
 
 void RegressionTest::createMissingDirs(const QString & filename)
diff -urN -x CVS kdelibs.orig/khtml/test_regression.h kdelibs/khtml/test_regression.h
--- kdelibs.orig/khtml/test_regression.h	Thu Jul 29 16:09:09 2004
+++ kdelibs/khtml/test_regression.h	Wed Nov 10 10:00:15 2004
@@ -47,9 +47,11 @@
     PartMonitor *m_previousMonitor;
     bool m_completed;
     KHTMLPart *m_part;
+    int m_timer_waits;
 public slots:
     void partCompleted();
     void timeout();
+    void finishTimers();
 };
 
 /**
@@ -135,11 +137,13 @@
     void dumpRenderTree( QTextStream &outputStream, KHTMLPart* part );
     void testStaticFile(const QString& filename);
     void testJSFile(const QString& filename);
-    bool checkOutput(const QString& againstFilename);
-    bool checkPaintdump( const QString& againstFilename);
+    enum CheckResult { Failure = 0, Success = 1, Ignored = 2 };
+    CheckResult checkOutput(const QString& againstFilename);
+    CheckResult checkPaintdump( const QString& againstFilename);
     enum FailureType { NoFailure = 0, AllFailure = 1, RenderFailure = 2, DomFailure = 4, PaintFailure = 8, JSFailure = 16};
     bool runTests(QString relPath = QString::null, bool mustExist = false, int known_failure = NoFailure);
     bool reportResult( bool passed, const QString & description = QString::null );
+    bool reportResult(CheckResult result, const QString & description = QString::null );
     void createMissingDirs(const QString &path);
 
     QImage renderToImage();
@@ -173,6 +177,9 @@
 
     static RegressionTest *curr;
 
+private:
+    void printDescription(const QString& description);
+
     static bool cvsIgnored( const QString &filename );
 
 private:
diff -urN -x CVS kdelibs.orig/khtml/xml/dom2_eventsimpl.h kdelibs/khtml/xml/dom2_eventsimpl.h
--- kdelibs.orig/khtml/xml/dom2_eventsimpl.h	Tue Feb 24 17:11:56 2004
+++ kdelibs/khtml/xml/dom2_eventsimpl.h	Wed Nov 17 14:43:04 2004
@@ -20,7 +20,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 
 #ifndef _DOM_EventsImpl_h_
diff -urN -x CVS kdelibs.orig/khtml/xml/dom2_rangeimpl.h kdelibs/khtml/xml/dom2_rangeimpl.h
--- kdelibs.orig/khtml/xml/dom2_rangeimpl.h	Tue Oct  7 21:31:47 2003
+++ kdelibs/khtml/xml/dom2_rangeimpl.h	Wed Nov 17 14:59:18 2004
@@ -21,7 +21,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 
 #ifndef _DOM2_RangeImpl_h_
@@ -43,7 +42,6 @@
 
     ~RangeImpl();
 
-    // ### remove the get from these methods (i.e. getStartContainer() -> startContainer())
     NodeImpl *startContainer(int &exceptioncode) const;
     long startOffset(int &exceptioncode) const;
     NodeImpl *endContainer(int &exceptioncode) const;
diff -urN -x CVS kdelibs.orig/khtml/xml/dom2_viewsimpl.h kdelibs/khtml/xml/dom2_viewsimpl.h
--- kdelibs.orig/khtml/xml/dom2_viewsimpl.h	Tue Feb 11 02:48:51 2003
+++ kdelibs/khtml/xml/dom2_viewsimpl.h	Wed Nov 17 14:43:04 2004
@@ -18,7 +18,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 
 #ifndef _DOM_ViewsImpl_h_
diff -urN -x CVS kdelibs.orig/khtml/xml/dom_docimpl.cpp kdelibs/khtml/xml/dom_docimpl.cpp
--- kdelibs.orig/khtml/xml/dom_docimpl.cpp	Thu Oct  7 14:35:07 2004
+++ kdelibs/khtml/xml/dom_docimpl.cpp	Wed Nov 10 10:00:35 2004
@@ -4,7 +4,7 @@
  * Copyright (C) 1999 Lars Knoll (knoll@kde.org)
  *           (C) 1999 Antti Koivisto (koivisto@kde.org)
  *           (C) 2001 Dirk Mueller (mueller@kde.org)
- *           (C) 2002 Apple Computer, Inc.
+ *           (C) 2002-2003 Apple Computer, Inc.
  *
  * This library is free software; you can redistribute it and/or
  * modify it under the terms of the GNU Library General Public
@@ -219,7 +219,7 @@
 
 // KHTMLView might be 0
 DocumentImpl::DocumentImpl(DOMImplementationImpl *_implementation, KHTMLView *v)
-    : NodeBaseImpl( new DocumentPtr() )
+    : NodeBaseImpl( new DocumentPtr() ), m_domtree_version(0)
 {
     document->doc = this;
     m_paintDeviceMetrics = 0;
@@ -972,7 +972,7 @@
         //kdDebug() << "DocumentImpl::attach: setting to charset " << settings->charset() << endl;
         _style->setFontDef(fontDef);
 	_style->htmlFont().update( paintDeviceMetrics() );
-        if ( parseMode() != Strict )
+        if ( inCompatMode() )
             _style->setHtmlHacks(true); // enable html specific rendering tricks
 
         StyleChange ch = diff( _style, oldStyle );
@@ -993,12 +993,8 @@
             n->recalcStyle( change );
     //kdDebug( 6020 ) << "TIME: recalcStyle() dt=" << qt.elapsed() << endl;
 
-    // ### should be done by the rendering tree itself,
-    // this way is rather crude and CPU intensive
-    if ( changed() ) {
-	renderer()->setLayouted( false );
-	renderer()->setMinMaxKnown( false );
-    }
+    if (changed() && m_view)
+	m_view->layout();
 
 bail_out:
     setChanged( false );
@@ -1053,8 +1049,8 @@
     updateRendering();
 
     // Only do a layout if changes have occurred that make it necessary.
-    if (m_view && renderer() && !renderer()->layouted())
-        m_view->layout();
+    if (m_view && renderer() && renderer()->needsLayout())
+	m_view->layout();
 
     m_ignorePendingStylesheets = oldIgnore;
 }
@@ -1072,7 +1068,7 @@
     // Create the rendering tree
     assert(!m_styleSelector);
     m_styleSelector = new CSSStyleSelector( this, m_usersheet, m_styleSheets, m_url,
-                                            pMode == Strict );
+                                            !inCompatMode() );
     m_render = new (m_renderArena) RenderCanvas(this, m_view);
     m_styleSelector->computeFontSizes(paintDeviceMetrics(), m_view ? m_view->part()->zoomFactor() : 100);
     recalcStyle( Force );
@@ -1244,42 +1240,6 @@
     kdDebug(6020) << " using strict parseMode" << endl;
 }
 
-// Please see if there`s a possibility to merge that code
-// with the next function and getElementByID().
-NodeImpl *DocumentImpl::findElement( Id id )
-{
-    QPtrStack<NodeImpl> nodeStack;
-    NodeImpl *current = _first;
-
-    while(1)
-    {
-        if(!current)
-        {
-            if(nodeStack.isEmpty()) break;
-            current = nodeStack.pop();
-            current = current->nextSibling();
-        }
-        else
-        {
-            if(current->id() == id)
-                return current;
-
-            NodeImpl *child = current->firstChild();
-            if(child)
-            {
-                nodeStack.push(current);
-                current = child;
-            }
-            else
-            {
-                current = current->nextSibling();
-            }
-        }
-    }
-
-    return 0;
-}
-
 NodeImpl *DocumentImpl::nextFocusNode(NodeImpl *fromNode)
 {
     unsigned short fromTabIndex;
@@ -1290,7 +1250,7 @@
 
 	int lowestTabIndex = 65535;
 	for (n = this; n != 0; n = n->traverseNextNode()) {
-	    if (n->isSelectable()) {
+	    if (n->isTabFocusable()) {
 		if ((n->tabIndex() > 0) && (n->tabIndex() < lowestTabIndex))
 		    lowestTabIndex = n->tabIndex();
 	    }
@@ -1301,7 +1261,7 @@
 
 	// Go to the first node in the document that has the desired tab index
 	for (n = this; n != 0; n = n->traverseNextNode()) {
-	    if (n->isSelectable() && (n->tabIndex() == lowestTabIndex))
+	    if (n->isTabFocusable() && (n->tabIndex() == lowestTabIndex))
 		return n;
 	}
 
@@ -1314,7 +1274,7 @@
     if (fromTabIndex == 0) {
 	// Just need to find the next selectable node after fromNode (in document order) that doesn't have a tab index
 	NodeImpl *n = fromNode->traverseNextNode();
-	while (n && !(n->isSelectable() && n->tabIndex() == 0))
+	while (n && !(n->isTabFocusable() && n->tabIndex() == 0))
 	    n = n->traverseNextNode();
 	return n;
     }
@@ -1328,7 +1288,7 @@
 
 	bool reachedFromNode = false;
 	for (n = this; n != 0; n = n->traverseNextNode()) {
-	    if (n->isSelectable() &&
+	    if (n->isTabFocusable() &&
 		((reachedFromNode && (n->tabIndex() >= fromTabIndex)) ||
 		 (!reachedFromNode && (n->tabIndex() > fromTabIndex))) &&
 		(n->tabIndex() < lowestSuitableTabIndex) &&
@@ -1346,20 +1306,20 @@
 	if (lowestSuitableTabIndex == 65535) {
 	    // No next node with a tab index -> just take first node with tab index of 0
 	    NodeImpl *n = this;
-	    while (n && !(n->isSelectable() && n->tabIndex() == 0))
+	    while (n && !(n->isTabFocusable() && n->tabIndex() == 0))
 		n = n->traverseNextNode();
 	    return n;
 	}
 
 	// Search forwards from fromNode
 	for (n = fromNode->traverseNextNode(); n != 0; n = n->traverseNextNode()) {
-	    if (n->isSelectable() && (n->tabIndex() == lowestSuitableTabIndex))
+	    if (n->isTabFocusable() && (n->tabIndex() == lowestSuitableTabIndex))
 		return n;
 	}
 
 	// The next node isn't after fromNode, start from the beginning of the document
 	for (n = this; n != fromNode; n = n->traverseNextNode()) {
-	    if (n->isSelectable() && (n->tabIndex() == lowestSuitableTabIndex))
+	    if (n->isTabFocusable() && (n->tabIndex() == lowestSuitableTabIndex))
 		return n;
 	}
 
@@ -1380,7 +1340,7 @@
 
 	int highestTabIndex = 0;
 	for (n = lastNode; n != 0; n = n->traversePreviousNode()) {
-	    if (n->isSelectable()) {
+	    if (n->isTabFocusable()) {
 		if (n->tabIndex() == 0)
 		    return n;
 		else if (n->tabIndex() > highestTabIndex)
@@ -1390,7 +1350,7 @@
 
 	// No node with a tab index of 0; just go to the last node with the highest tab index
 	for (n = lastNode; n != 0; n = n->traversePreviousNode()) {
-	    if (n->isSelectable() && (n->tabIndex() == highestTabIndex))
+	    if (n->isTabFocusable() && (n->tabIndex() == highestTabIndex))
 		return n;
 	}
 
@@ -1402,7 +1362,7 @@
 	if (fromTabIndex == 0) {
 	    // Find the previous selectable node before fromNode (in document order) that doesn't have a tab index
 	    NodeImpl *n = fromNode->traversePreviousNode();
-	    while (n && !(n->isSelectable() && n->tabIndex() == 0))
+	    while (n && !(n->isTabFocusable() && n->tabIndex() == 0))
 		n = n->traversePreviousNode();
 	    if (n)
 		return n;
@@ -1410,7 +1370,7 @@
 	    // No previous nodes with a 0 tab index, go to the last node in the document that has the highest tab index
 	    int highestTabIndex = 0;
 	    for (n = this; n != 0; n = n->traverseNextNode()) {
-		if (n->isSelectable() && (n->tabIndex() > highestTabIndex))
+		if (n->isTabFocusable() && (n->tabIndex() > highestTabIndex))
 		    highestTabIndex = n->tabIndex();
 	    }
 
@@ -1418,7 +1378,7 @@
 		return 0;
 
 	    for (n = lastNode; n != 0; n = n->traversePreviousNode()) {
-		if (n->isSelectable() && (n->tabIndex() == highestTabIndex))
+		if (n->isTabFocusable() && (n->tabIndex() == highestTabIndex))
 		    return n;
 	    }
 
@@ -1435,7 +1395,7 @@
 
 	    bool reachedFromNode = false;
 	    for (n = this; n != 0; n = n->traverseNextNode()) {
-		if (n->isSelectable() &&
+		if (n->isTabFocusable() &&
 		    ((!reachedFromNode && (n->tabIndex() <= fromTabIndex)) ||
 		     (reachedFromNode && (n->tabIndex() < fromTabIndex)))  &&
 		    (n->tabIndex() > highestSuitableTabIndex) &&
@@ -1458,12 +1418,12 @@
 
 	    // Search backwards from fromNode
 	    for (n = fromNode->traversePreviousNode(); n != 0; n = n->traversePreviousNode()) {
-		if (n->isSelectable() && (n->tabIndex() == highestSuitableTabIndex))
+		if (n->isTabFocusable() && (n->tabIndex() == highestSuitableTabIndex))
 		    return n;
 	    }
 	    // The previous node isn't before fromNode, start from the end of the document
 	    for (n = lastNode; n != fromNode; n = n->traversePreviousNode()) {
-		if (n->isSelectable() && (n->tabIndex() == highestSuitableTabIndex))
+		if (n->isTabFocusable() && (n->tabIndex() == highestSuitableTabIndex))
 		    return n;
 	    }
 
@@ -1859,10 +1819,8 @@
 
     m_styleSelectorDirty = true;
 #endif
-    if ( renderer() ) {
-        renderer()->setLayouted( false );
-        renderer()->setMinMaxKnown( false );
-    }
+    if ( renderer() )
+        renderer()->setNeedsLayoutAndMinMaxRecalc();
 }
 
 void DocumentImpl::recalcStyleSelector()
@@ -1914,7 +1872,7 @@
                 }
 
             }
-            else if (n->id() == ID_LINK || n->id() == ID_STYLE) {
+            else if (n->isHTMLElement() && ( n->id() == ID_LINK || n->id() == ID_STYLE) ) {
                 QString title;
                 if ( n->id() == ID_LINK ) {
                     HTMLLinkElementImpl* l = static_cast<HTMLLinkElementImpl*>(n);
@@ -1953,7 +1911,7 @@
                         m_availableSheets.append( title );
                 }
             }
-            else if (n->id() == ID_BODY) {
+            else if (n->isHTMLElement() && n->id() == ID_BODY) {
                 // <BODY> element (doesn't contain styles as such but vlink="..." and friends
                 // are treated as style declarations)
                 sheet = static_cast<HTMLBodyElementImpl*>(n)->sheet();
@@ -2002,7 +1960,7 @@
     if ( m_view && m_view->mediaType() == "print" )
 	usersheet += m_printSheet;
     m_styleSelector = new CSSStyleSelector( this, usersheet, m_styleSheets, m_url,
-                                            pMode == Strict );
+                                            !inCompatMode() );
 
     m_styleSelectorDirty = false;
 }
@@ -2132,6 +2090,8 @@
         return new UIEventImpl();
     else if (eventType == "MouseEvents")
         return new MouseEventImpl();
+    else if (eventType == "TextEvents")
+        return new TextEventImpl();
     else if (eventType == "MutationEvents")
         return new MutationEventImpl();
     else if (eventType == "HTMLEvents" || eventType == "Events")
@@ -2257,29 +2217,28 @@
             // ## currentTarget is unimplemented in IE, and is "window" in Mozilla (how? not a DOM node)
             evt->setCurrentTarget(0);
             it.current()->listener->handleEvent(ev);
-	    return;
 	}
     }
 }
 
-void DocumentImpl::setWindowEventListener(int id, EventListener *listener)
+void DocumentImpl::setHTMLWindowEventListener(int id, EventListener *listener)
 {
     // If we already have it we don't want removeWindowEventListener to delete it
     if (listener)
 	listener->ref();
-    removeWindowEventListener(id);
+    removeHTMLWindowEventListener(id);
     if (listener) {
-	RegisteredEventListener *rl = new RegisteredEventListener(static_cast<EventImpl::EventId>(id),listener,false);
-	m_windowEventListeners.append(rl);
+	addWindowEventListener(id, listener, false);
 	listener->deref();
     }
 }
 
-EventListener *DocumentImpl::getWindowEventListener(int id)
+EventListener *DocumentImpl::getHTMLWindowEventListener(int id)
 {
     QPtrListIterator<RegisteredEventListener> it(m_windowEventListeners);
     for (; it.current(); ++it) {
-	if (it.current()->id == id) {
+	if (it.current()->id == id &&
+            it.current()->listener->eventListenerType() == "_khtml_HTMLEventListener") {
 	    return it.current()->listener;
 	}
     }
@@ -2287,17 +2246,56 @@
     return 0;
 }
 
-void DocumentImpl::removeWindowEventListener(int id)
+void DocumentImpl::removeHTMLWindowEventListener(int id)
 {
     QPtrListIterator<RegisteredEventListener> it(m_windowEventListeners);
     for (; it.current(); ++it) {
-	if (it.current()->id == id) {
+	if (it.current()->id == id &&
+            it.current()->listener->eventListenerType() == "_khtml_HTMLEventListener") {
 	    m_windowEventListeners.removeRef(it.current());
 	    return;
 	}
     }
 }
 
+void DocumentImpl::addWindowEventListener(int id, EventListener *listener, const bool useCapture)
+{
+    listener->ref();
+
+    // remove existing identical listener set with identical arguments - the DOM2
+    // spec says that "duplicate instances are discarded" in this case.
+    removeWindowEventListener(id,listener,useCapture);
+
+    RegisteredEventListener *rl = new RegisteredEventListener(static_cast<EventImpl::EventId>(id), listener, useCapture);
+    m_windowEventListeners.append(rl);
+
+    listener->deref();
+}
+
+void DocumentImpl::removeWindowEventListener(int id, EventListener *listener, bool useCapture)
+{
+    RegisteredEventListener rl(static_cast<EventImpl::EventId>(id),listener,useCapture);
+
+    QPtrListIterator<RegisteredEventListener> it(m_windowEventListeners);
+    for (; it.current(); ++it)
+        if (*(it.current()) == rl) {
+            m_windowEventListeners.removeRef(it.current());
+            return;
+        }
+}
+
+bool DocumentImpl::hasWindowEventListener(int id)
+{
+    QPtrListIterator<RegisteredEventListener> it(m_windowEventListeners);
+    for (; it.current(); ++it) {
+	if (it.current()->id == id) {
+	    return true;
+	}
+    }
+
+    return false;
+}
+
 EventListener *DocumentImpl::createHTMLEventListener(QString code, QString name)
 {
     return view() ? view()->part()->createHTMLEventListener(code,name) : 0;
@@ -2316,10 +2314,7 @@
     KHTMLPart *childPart = childView->part();
     if (!childPart)
         return 0;
-    KHTMLPart *parent = childPart->parentPart();
-    if (!parent)
-        return 0;
-    ChildFrame *childFrame = parent->frame(childPart);
+    ChildFrame *childFrame = childPart->d->m_frame;
     if (!childFrame)
         return 0;
     RenderPart *renderPart = childFrame->m_frame;
diff -urN -x CVS kdelibs.orig/khtml/xml/dom_docimpl.h kdelibs/khtml/xml/dom_docimpl.h
--- kdelibs.orig/khtml/xml/dom_docimpl.h	Thu Oct  7 14:35:07 2004
+++ kdelibs/khtml/xml/dom_docimpl.h	Wed Nov 10 10:00:35 2004
@@ -302,7 +302,7 @@
     bool inTransitionalMode() const { return pMode == Transitional; }
     bool inStrictMode() const { return pMode == Strict; }
 
-    void setHTMLMode( HTMLMode m ) { hMode = m; }
+    //void setHTMLMode( HTMLMode m ) { hMode = m; }
     HTMLMode htmlMode() const { return hMode; }
 
     void setParsing(bool b) { m_bParsing = b; }
@@ -315,8 +315,6 @@
     bool designMode() const;
 
     // internal
-    NodeImpl *findElement( Id id );
-
     bool prepareMouseEvent( bool readonly, int x, int y, MouseEvent *ev );
 
     virtual bool childAllowed( NodeImpl *newChild );
@@ -381,11 +379,17 @@
     LocalStyleRefs* localStyleRefs() { return &m_localStyleRefs; }
 
     virtual void defaultEventHandler(EventImpl *evt);
-    virtual void setWindowEventListener(int id, EventListener *listener);
-    EventListener *getWindowEventListener(int id);
-    virtual void removeWindowEventListener(int id);
+    virtual void setHTMLWindowEventListener(int id, EventListener *listener);
+    EventListener *getHTMLWindowEventListener(int id);
+    virtual void removeHTMLWindowEventListener(int id);
     EventListener *createHTMLEventListener(QString code, QString name);
 
+    void addWindowEventListener(int id, EventListener *listener, const bool useCapture);
+    void removeWindowEventListener(int id, EventListener *listener, bool useCapture);
+    bool hasWindowEventListener(int id);
+
+    EventListener *createHTMLEventListener(QString code);
+
     /**
      * Searches through the document, starting from fromNode, for the next selectable element that comes after fromNode.
      * The order followed is as specified in section 17.11.1 of the HTML4 spec, which is elements with tab indexes
@@ -439,6 +443,9 @@
 
     DOMString toString() const;
 
+    void incDOMTreeVersion() { ++m_domtree_version; }
+    unsigned int domTreeVersion() const { return m_domtree_version; }
+
 signals:
     void finishedParsing();
 
@@ -478,6 +485,8 @@
     NodeImpl *m_hoverNode;
     NodeImpl *m_focusNode;
 
+    unsigned int m_domtree_version;
+
     struct IdNameMapping {
         IdNameMapping(unsigned short _start)
             : idStart(_start), count(0) {}
@@ -570,6 +579,8 @@
 
     // Other methods (not part of DOM)
     void setName(const DOMString& n) { m_qualifiedName = n; }
+    void setPublicId(const DOMString& publicId) { m_publicId = publicId; }
+    void setSystemId(const DOMString& systemId) { m_systemId = systemId; }
     DOMImplementationImpl *implementation() const { return m_implementation; }
     void copyFrom(const DocumentTypeImpl&);
 
diff -urN -x CVS kdelibs.orig/khtml/xml/dom_elementimpl.cpp kdelibs/khtml/xml/dom_elementimpl.cpp
--- kdelibs.orig/khtml/xml/dom_elementimpl.cpp	Thu Aug  5 02:32:33 2004
+++ kdelibs/khtml/xml/dom_elementimpl.cpp	Wed Nov 10 10:00:35 2004
@@ -552,7 +552,7 @@
     setHasChangedChild( false );
 }
 
-bool ElementImpl::isSelectable() const
+bool ElementImpl::isFocusable() const
 {
     // Only make editable elements selectable if its parent element
     // is not editable. FIXME: this is not 100% right as non-editable elements
@@ -598,7 +598,7 @@
     m_styleDecls->ref();
     m_styleDecls->setParent(getDocument()->elementSheet());
     m_styleDecls->setNode(this);
-    m_styleDecls->setStrictParsing( getDocument()->parseMode() == DocumentImpl::Strict );
+    m_styleDecls->setStrictParsing( !getDocument()->inCompatMode() );
 }
 
 void ElementImpl::dispatchAttrRemovalEvent(NodeImpl::Id /*id*/, DOMStringImpl */*value*/)
diff -urN -x CVS kdelibs.orig/khtml/xml/dom_elementimpl.h kdelibs/khtml/xml/dom_elementimpl.h
--- kdelibs.orig/khtml/xml/dom_elementimpl.h	Wed Jun  9 16:26:57 2004
+++ kdelibs/khtml/xml/dom_elementimpl.h	Wed Nov 10 10:00:35 2004
@@ -186,7 +186,7 @@
     virtual void recalcStyle( StyleChange = NoChange );
 
     virtual void mouseEventHandler( MouseEvent* /*ev*/, bool /*inside*/ ) {}
-    virtual bool isSelectable() const;
+    virtual bool isFocusable() const;
     virtual bool childAllowed( NodeImpl *newChild );
     virtual bool childTypeAllowed( unsigned short type );
 
diff -urN -x CVS kdelibs.orig/khtml/xml/dom_nodeimpl.cpp kdelibs/khtml/xml/dom_nodeimpl.cpp
--- kdelibs.orig/khtml/xml/dom_nodeimpl.cpp	Thu Oct  7 14:35:07 2004
+++ kdelibs/khtml/xml/dom_nodeimpl.cpp	Wed Nov 10 10:00:35 2004
@@ -428,19 +428,19 @@
 
     // dispatch to the actual target node
     it.toLast();
+    NodeImpl* propagationSentinel = 0;
     if (!evt->propagationStopped()) {
         evt->setEventPhase(Event::AT_TARGET);
         evt->setCurrentTarget(it.current());
         it.current()->handleLocalEvents(evt, true);
         if (!evt->propagationStopped())
             it.current()->handleLocalEvents(evt,false);
+        else
+            propagationSentinel = it.current();
     }
     --it;
 
     if (evt->bubbles()) {
-        evt->stopPropagation(false);
-        NodeImpl* propagationSentinel = 0;
-
         evt->setEventPhase(Event::BUBBLING_PHASE);
         for (; it.current() && !evt->propagationStopped(); --it) {
             if (evt->propagationStopped()) propagationSentinel = it.current();
@@ -476,7 +476,7 @@
 bool NodeImpl::dispatchHTMLEvent(int _id, bool canBubbleArg, bool cancelableArg)
 {
     int exceptioncode = 0;
-    EventImpl *evt = new EventImpl(static_cast<EventImpl::EventId>(_id),canBubbleArg,cancelableArg);
+    EventImpl* const evt = new EventImpl(static_cast<EventImpl::EventId>(_id),canBubbleArg,cancelableArg);
     evt->ref();
     dispatchEvent(evt,exceptioncode,true);
     bool ret = !evt->defaultPrevented();
@@ -487,7 +487,7 @@
 void NodeImpl::dispatchWindowEvent(int _id, bool canBubbleArg, bool cancelableArg)
 {
     int exceptioncode = 0;
-    EventImpl *evt = new EventImpl(static_cast<EventImpl::EventId>(_id),canBubbleArg,cancelableArg);
+    EventImpl* const evt = new EventImpl(static_cast<EventImpl::EventId>(_id),canBubbleArg,cancelableArg);
     evt->setTarget( 0 );
     evt->ref();
     DocumentPtr *doc = document;
@@ -583,7 +583,7 @@
     bool shiftKey = (_mouse->state() & Qt::ShiftButton);
     bool metaKey = false; // ### qt support?
 
-    EventImpl *evt = new MouseEventImpl(evtId,true,cancelable,getDocument()->defaultView(),
+    EventImpl* const evt = new MouseEventImpl(evtId,true,cancelable,getDocument()->defaultView(),
                    detail,screenX,screenY,clientX,clientY,pageX,pageY,ctrlKey,altKey,shiftKey,metaKey,
                    button,0);
     evt->ref();
@@ -602,7 +602,7 @@
         cancelable = true;
 
     int exceptioncode = 0;
-    UIEventImpl *evt = new UIEventImpl(static_cast<EventImpl::EventId>(_id),true,
+    UIEventImpl* const evt = new UIEventImpl(static_cast<EventImpl::EventId>(_id),true,
                                        cancelable,getDocument()->defaultView(),detail);
     evt->ref();
     dispatchEvent(evt,exceptioncode,true);
@@ -613,17 +613,20 @@
 {
     childrenChanged();
     if (!getDocument()->hasListenerType(DocumentImpl::DOMSUBTREEMODIFIED_LISTENER))
-	return;
+        return;
     int exceptioncode = 0;
-    dispatchEvent(new MutationEventImpl(EventImpl::DOMSUBTREEMODIFIED_EVENT,
-			 true,false,0,DOMString(),DOMString(),DOMString(),0),exceptioncode,true);
+    MutationEventImpl* const evt = new MutationEventImpl(EventImpl::DOMSUBTREEMODIFIED_EVENT,true,
+                                                         false,0,DOMString(),DOMString(),DOMString(),0);
+    evt->ref();
+    dispatchEvent(evt,exceptioncode,true);
+    evt->deref();
 }
 
 bool NodeImpl::dispatchKeyEvent(QKeyEvent *key, bool keypress)
 {
     int exceptioncode = 0;
     //kdDebug(6010) << "DOM::NodeImpl: dispatching keyboard event" << endl;
-    TextEventImpl *keyEventImpl = new TextEventImpl(key, keypress, getDocument()->defaultView());
+    TextEventImpl* const keyEventImpl = new TextEventImpl(key, keypress, getDocument()->defaultView());
     keyEventImpl->ref();
     dispatchEvent(keyEventImpl,exceptioncode,true);
     bool r = keyEventImpl->defaultHandled() || keyEventImpl->defaultPrevented();
@@ -843,6 +846,7 @@
         m_render->close();
         m_rendererNeedsClose = false;
     }
+    getDocument()->incDOMTreeVersion();
     m_attached = true;
 }
 
@@ -854,6 +858,7 @@
         m_render->detach();
 
     m_render = 0;
+    getDocument()->incDOMTreeVersion();
     m_attached = false;
 }
 
@@ -1068,6 +1073,10 @@
 
         // If child is already present in the tree, first remove it
         NodeImpl *newParent = child->parentNode();
+	if ( child == next )
+	    next = child->nextSibling();
+	if ( child == prev )
+	    prev = child->previousSibling();
         if(newParent)
             newParent->removeChild( child, exceptioncode );
         if (exceptioncode)
@@ -1157,7 +1166,7 @@
 void NodeBaseImpl::removeChildren()
 {
     NodeImpl *n, *next;
-    for( n = _first; n; n = next )
+    for( n = _first, _first = 0; n; n = next )
     {
         next = n->nextSibling();
         if (n->attached())
@@ -1171,7 +1180,7 @@
             for ( NodeImpl* c = n; c; c = c->traverseNextNode( n ) )
                 c->removedFromDocument();
     }
-    _first = _last = 0;
+    _last = 0;
 }
 
 
@@ -1475,8 +1484,10 @@
 void NodeBaseImpl::dispatchChildInsertedEvents( NodeImpl *child, int &exceptioncode )
 {
     if (getDocument()->hasListenerType(DocumentImpl::DOMNODEINSERTED_LISTENER)) {
-        child->dispatchEvent(new MutationEventImpl(EventImpl::DOMNODEINSERTED_EVENT,
-                                                   true,false,this,DOMString(),DOMString(),DOMString(),0),exceptioncode,true);
+        MutationEventImpl* const evt = new MutationEventImpl(EventImpl::DOMNODEINSERTED_EVENT,true,false,this,DOMString(),DOMString(),DOMString(),0);
+        evt->ref();
+        child->dispatchEvent(evt,exceptioncode,true);
+        evt->deref();
         if (exceptioncode)
             return;
     }
@@ -1491,8 +1502,10 @@
             c->insertedIntoDocument();
 
             if (hasInsertedListeners) {
-                c->dispatchEvent(new MutationEventImpl(EventImpl::DOMNODEINSERTEDINTODOCUMENT_EVENT,
-                                                       false,false,0,DOMString(),DOMString(),DOMString(),0),exceptioncode,true);
+                MutationEventImpl* const evt = new MutationEventImpl(EventImpl::DOMNODEINSERTEDINTODOCUMENT_EVENT,false,false,0,DOMString(),DOMString(),DOMString(),0);
+                evt->ref();
+                c->dispatchEvent(evt,exceptioncode,true);
+                evt->deref();
                 if (exceptioncode)
                     return;
             }
@@ -1505,10 +1518,12 @@
     // Dispatch pre-removal mutation events
     getDocument()->notifyBeforeNodeRemoval(child); // ### use events instead
     if (getDocument()->hasListenerType(DocumentImpl::DOMNODEREMOVED_LISTENER)) {
-	child->dispatchEvent(new MutationEventImpl(EventImpl::DOMNODEREMOVED_EVENT,
-			     true,false,this,DOMString(),DOMString(),DOMString(),0),exceptioncode,true);
-	if (exceptioncode)
-	    return;
+        MutationEventImpl* const evt = new MutationEventImpl(EventImpl::DOMNODEREMOVED_EVENT,true,false,this,DOMString(),DOMString(),DOMString(),0);
+        evt->ref();
+        child->dispatchEvent(evt,exceptioncode,true);
+        evt->deref();
+        if (exceptioncode)
+            return;
     }
 
     bool hasRemovalListeners = getDocument()->hasListenerType(DocumentImpl::DOMNODEREMOVEDFROMDOCUMENT_LISTENER);
@@ -1516,16 +1531,18 @@
     // dispatch the DOMNodeRemovedFromDocument event to all descendants
     NodeImpl *p = this;
     while (p->parentNode())
-	p = p->parentNode();
+        p = p->parentNode();
     if (p->nodeType() == Node::DOCUMENT_NODE) {
-	for (NodeImpl *c = child; c; c = c->traverseNextNode(child)) {
-	    if (hasRemovalListeners) {
-		c->dispatchEvent(new MutationEventImpl(EventImpl::DOMNODEREMOVEDFROMDOCUMENT_EVENT,
-				 false,false,0,DOMString(),DOMString(),DOMString(),0),exceptioncode,true);
-		if (exceptioncode)
-		    return;
-	    }
-	}
+        for (NodeImpl *c = child; c; c = c->traverseNextNode(child)) {
+            if (hasRemovalListeners) {
+                MutationEventImpl* const evt = new MutationEventImpl(EventImpl::DOMNODEREMOVEDFROMDOCUMENT_EVENT,false,false,0,DOMString(),DOMString(),DOMString(),0);
+                evt->ref();
+                c->dispatchEvent(evt,exceptioncode,true);
+                evt->deref();
+                if (exceptioncode)
+                    return;
+            }
+        }
     }
 }
 
diff -urN -x CVS kdelibs.orig/khtml/xml/dom_nodeimpl.h kdelibs/khtml/xml/dom_nodeimpl.h
--- kdelibs.orig/khtml/xml/dom_nodeimpl.h	Wed Jul 28 00:11:50 2004
+++ kdelibs/khtml/xml/dom_nodeimpl.h	Wed Nov 17 14:59:18 2004
@@ -20,7 +20,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 #ifndef _DOM_NodeImpl_h_
 #define _DOM_NodeImpl_h_
@@ -203,10 +202,9 @@
     unsigned short tabIndex() const { return m_tabIndex; }
     void setTabIndex(unsigned short _tabIndex) { m_tabIndex = _tabIndex; }
 
-    /**
-     * whether this node can receive the keyboard focus.
-     */
-    virtual bool isSelectable() const { return false; }
+    virtual bool isFocusable() const { return false; }
+    virtual bool isMouseFocusable() const { return isFocusable(); }
+    virtual bool isTabFocusable() const { return isFocusable(); }
 
     virtual bool isInline() const;
 
@@ -276,6 +274,7 @@
 
     khtml::RenderObject *renderer() const { return m_render; }
     khtml::RenderObject *nextRenderer();
+    void setRenderer(khtml::RenderObject* renderer) { m_render = renderer; }
 
     void checkSetPrefix(const DOMString &_prefix, int &exceptioncode);
     void checkAddChild(NodeImpl *newChild, int &exceptioncode);
diff -urN -x CVS kdelibs.orig/khtml/xml/dom_stringimpl.cpp kdelibs/khtml/xml/dom_stringimpl.cpp
--- kdelibs.orig/khtml/xml/dom_stringimpl.cpp	Sat Apr 19 18:16:52 2003
+++ kdelibs/khtml/xml/dom_stringimpl.cpp	Wed Nov 10 10:00:35 2004
@@ -28,6 +28,7 @@
 #include <kdebug.h>
 
 #include <string.h>
+#include <qstringlist.h>
 
 using namespace DOM;
 using namespace khtml;
@@ -155,7 +156,7 @@
   return new DOMStringImpl(s + pos, len);
 }
 
-static Length parseLength(QChar *s, unsigned int l)
+static Length parseLength(const QChar *s, unsigned int l)
 {
     const QChar* last = s+l-1;
     if (l && *last == QChar('%')) {
@@ -177,6 +178,9 @@
         l--;
     }
 
+    if (l == 0)
+        return Length(0, Variable);
+
     if ( *last == '*') {
         if(last == s)
             return Length(1, Relative);
diff -urN -x CVS kdelibs.orig/khtml/xml/dom_textimpl.cpp kdelibs/khtml/xml/dom_textimpl.cpp
--- kdelibs.orig/khtml/xml/dom_textimpl.cpp	Fri Jun 11 01:32:37 2004
+++ kdelibs/khtml/xml/dom_textimpl.cpp	Wed Nov 10 10:00:35 2004
@@ -228,8 +228,10 @@
     DOMStringImpl *newValue = str->copy();
     newValue->ref();
     int exceptioncode = 0;
-    dispatchEvent(new MutationEventImpl(EventImpl::DOMCHARACTERDATAMODIFIED_EVENT,
-		  true,false,0,prevValue,newValue,DOMString(),0),exceptioncode);
+    MutationEventImpl* const evt = new MutationEventImpl(EventImpl::DOMCHARACTERDATAMODIFIED_EVENT,true,false,0,prevValue,newValue,DOMString(),0);
+    evt->ref();
+    dispatchEvent(evt,exceptioncode);
+    evt->deref();
     newValue->deref();
     dispatchSubtreeModifiedEvent();
 }
diff -urN -x CVS kdelibs.orig/khtml/xml/dom_xmlimpl.h kdelibs/khtml/xml/dom_xmlimpl.h
--- kdelibs.orig/khtml/xml/dom_xmlimpl.h	Wed Jun  9 16:26:57 2004
+++ kdelibs/khtml/xml/dom_xmlimpl.h	Wed Nov 17 14:43:04 2004
@@ -18,7 +18,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 
 #ifndef _DOM_XmlImpl_h_
diff -urN -x CVS kdelibs.orig/khtml/xml/xml_tokenizer.h kdelibs/khtml/xml/xml_tokenizer.h
--- kdelibs.orig/khtml/xml/xml_tokenizer.h	Wed Jun  9 12:35:01 2004
+++ kdelibs/khtml/xml/xml_tokenizer.h	Wed Nov 17 14:43:05 2004
@@ -18,7 +18,6 @@
  * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  * Boston, MA 02111-1307, USA.
  *
- * $Id$
  */
 
 #ifndef _XML_Tokenizer_h_
diff -urN -x CVS kdelibs.orig/kimgio/bmp.kimgio kdelibs/kimgio/bmp.kimgio
--- kdelibs.orig/kimgio/bmp.kimgio	Tue Aug 24 08:29:21 2004
+++ kdelibs/kimgio/bmp.kimgio	Sat Oct 30 08:38:12 2004
@@ -2,6 +2,7 @@
 Type=BMP
 Header=
 Name=BMP Image
+Name[af]=BMP Beeld
 Name[ar]=صورة من نوع BMP
 Name[az]=BMP Rəsmi
 Name[be]=Выява BMP
@@ -34,6 +35,7 @@
 Name[ja]=BMPイメージ
 Name[ko]=BMP 그림
 Name[lt]=BMP paveiksliukas
+Name[mk]=BMP слика
 Name[mn]=BMP Зураг
 Name[ms]=Imej BMP
 Name[nb]=BMP-bilde
diff -urN -x CVS kdelibs.orig/kimgio/dds.kimgio kdelibs/kimgio/dds.kimgio
--- kdelibs.orig/kimgio/dds.kimgio	Sun Sep 12 15:56:01 2004
+++ kdelibs/kimgio/dds.kimgio	Sun Oct 24 09:01:55 2004
@@ -2,6 +2,7 @@
 Type=DDS
 Header=^DDS 
 Name=Direct Draw Surface
+Name[af]=Direct Draw Oppervlakte
 Name[be]=Паверхня Draw Surface
 Name[bg]=Област с директно изчертаване
 Name[bn]=ডাইরেক্ট ড্র সারফেস
@@ -17,6 +18,7 @@
 Name[is]=Direct Draw yfirborð
 Name[it]=Superficie DirectDraw
 Name[nb]=Overflate for direktetegning
+Name[nds]=Böversiet för Direct Draw
 Name[nl]=Direct beeldgeheugen
 Name[nn]=Overflate for direkteteikning
 Name[pa]=ਸਿੱਧਾ ਖਿੱਚਿਆ ਤਲ
@@ -24,11 +26,12 @@
 Name[pt]=Superfície Direct Draw
 Name[pt_BR]=DirectDraw
 Name[ro]=Suprafaţă de desenare directă
+Name[ru]=Поверхность Direct Draw
 Name[se]=Guovlu masa sáhttá sárgut dakkaviđe
 Name[sk]=Povrch Direct Draw
 Name[sl]=Površina Direct Draw
 Name[sr]=Површина за директно цртање
-Name[sr@Latn]=Површина за директно цртање
+Name[sr@Latn]=Površina za direktno crtanje
 Name[sv]=Direktrityta
 Name[ta]=நேரடியாக வரையும் சூழல்
 Name[tg]=Кашидани сатҳи мустақим
diff -urN -x CVS kdelibs.orig/kimgio/eps.kimgio kdelibs/kimgio/eps.kimgio
--- kdelibs.orig/kimgio/eps.kimgio	Tue Aug 24 08:29:21 2004
+++ kdelibs/kimgio/eps.kimgio	Sat Oct 30 08:38:13 2004
@@ -2,6 +2,7 @@
 Type=EPS
 Header=^(?:%c5%d0%d3%c6|%!PS-Adobe)
 Name=Encapsulated PostScript Image
+Name[af]=Geënkapsuleerde Postscript Beeld
 Name[ar]=Encapsulated PostScript صورة
 Name[az]=Encapsulated PostScript Rəsmi
 Name[be]=Выява Encapsulated PostScript
@@ -34,6 +35,7 @@
 Name[ja]=Encapsulated PostScriptイメージ
 Name[ko]=암호화된 포스트스크립트 그림
 Name[lt]=Įsiūtas Postscript paveiksliukas
+Name[mk]=Encapsulated PostScript слика
 Name[mn]=Хайрцагласан PostScript зураг
 Name[ms]=Imej PostScript Terenkapsul
 Name[nb]=Innkapslede PostScript-bilder
diff -urN -x CVS kdelibs.orig/kimgio/exr.kimgio kdelibs/kimgio/exr.kimgio
--- kdelibs.orig/kimgio/exr.kimgio	Sun Sep 12 15:56:01 2004
+++ kdelibs/kimgio/exr.kimgio	Fri Nov 12 08:27:51 2004
@@ -2,6 +2,7 @@
 Type=EXR
 Header=^\x76\x2f\x31\01
 Name=ILM EXR Image Kimgio
+Name[af]=ILM EXR Beeld Kimgio
 Name[bg]=Изображение ILM EXR Kimgio
 Name[ca]=Imatge ILM EXR pel Kimgio
 Name[da]=ILM EXR billede Kimgio
@@ -17,7 +18,10 @@
 Name[is]=ILM EXR mynd Kimgio
 Name[it]=Immagine Kimgio ILM EXR
 Name[ja]=ILM EXR イメージ Kimgio
+Name[lt]=ILM EXR paveiksliukas Kimgio
+Name[mk]=ILM EXR слика Kimgio
 Name[nb]=ILM EXR-bilde Kimgio
+Name[nds]=ILM-EXR-Bild
 Name[nl]=ILM EXR Kimgio-afbeelding
 Name[nn]=ILM EXR-bilete Kimgio
 Name[pa]=ILM EXR ਚਿੱਤਰ ਕੀਮਗੀਓ
@@ -25,10 +29,11 @@
 Name[pt]=Imagem ILM EXR Kimgio
 Name[pt_BR]=Imagem ILM EXR do Kimgio 
 Name[ro]=Imagine ILM EXR
+Name[ru]=Изображение ILM EXR Kimgio
 Name[se]=ILM EXR-govva Kimgio
 Name[sk]=Obrázok ILM EXR KImgio
 Name[sr]=ILM EXR Kimgio слика
-Name[sr@Latn]=ILM EXR Kimgio слика
+Name[sr@Latn]=ILM EXR Kimgio slika
 Name[sv]=ILM EXR-bild Kimgio
 Name[ta]=ILM EXR பிம்ப கிம்ஜியோ
 Name[tg]=Тасвири ILM EXR Kimgio
diff -urN -x CVS kdelibs.orig/kimgio/g3.kimgio kdelibs/kimgio/g3.kimgio
--- kdelibs.orig/kimgio/g3.kimgio	Tue Aug 24 08:29:21 2004
+++ kdelibs/kimgio/g3.kimgio	Fri Nov 12 08:27:51 2004
@@ -2,11 +2,13 @@
 Type=G3
 Header=II
 Name=CCITT G3 Fax
+Name[af]=CCITT G3 Faks
 Name[ar]=فاكس CCITT G3
 Name[az]=CCITT G3 Faks
 Name[be]=CCITT G3 факс
 Name[bg]=Факс CCITT G3
 Name[bn]=CCITT G3 ফ্যাক্স
+Name[br]=Faks CCITT G3
 Name[ca]=Fax G3 CCITT
 Name[cy]=Ffacs G3 CCITT
 Name[de]=CCITT-G3-Fax
@@ -28,6 +30,8 @@
 Name[is]=CCITT G3 fax
 Name[it]=Fax CCITT G3
 Name[ko]=CCITT G3 팩스
+Name[lt]=CCITT G3 faksas
+Name[mk]=CCITT G3 факс
 Name[mn]=CCITT G3 Факс
 Name[ms]=Faks CCITT G3
 Name[nb]=CCITT G3-Faks
diff -urN -x CVS kdelibs.orig/kimgio/gif.kimgio kdelibs/kimgio/gif.kimgio
--- kdelibs.orig/kimgio/gif.kimgio	Tue Aug 24 08:29:21 2004
+++ kdelibs/kimgio/gif.kimgio	Sat Oct 30 08:38:13 2004
@@ -2,6 +2,7 @@
 Type=GIF
 Header=
 Name=GIF Image
+Name[af]=GIF Beeld
 Name[ar]=صورة من نوع GIF
 Name[az]=GIF Rəsmi
 Name[be]=Выява GIF
@@ -34,6 +35,7 @@
 Name[ja]=GIFイメージ
 Name[ko]=GIF 그림
 Name[lt]=GIF paveiksliukas
+Name[mk]=GIF слика
 Name[mn]=GIF-Зураг
 Name[ms]=Imej GIF
 Name[nb]=GIF-bilde
diff -urN -x CVS kdelibs.orig/kimgio/ico.kimgio kdelibs/kimgio/ico.kimgio
--- kdelibs.orig/kimgio/ico.kimgio	Tue Aug 31 09:21:25 2004
+++ kdelibs/kimgio/ico.kimgio	Sat Oct 30 08:38:13 2004
@@ -2,6 +2,7 @@
 Type=ICO
 Header=^\001\001[\001|\002]\001
 Name=Windows Icon
+Name[af]=Windows Ikoon
 Name[ar]=أيقونة ويندوز
 Name[az]=Windows Timsalı
 Name[be]=Піктаграма Windows
@@ -34,6 +35,7 @@
 Name[ja]=Windowsアイコン
 Name[ko]=윈도우즈 아이콘
 Name[lt]=Windows ženkliukas
+Name[mk]=MSWindows икона
 Name[mn]=Windows-Тэмдэг
 Name[ms]=Ikon Tetingkap
 Name[nb]=MS Windows ikoner
diff -urN -x CVS kdelibs.orig/kimgio/jp2.kimgio kdelibs/kimgio/jp2.kimgio
--- kdelibs.orig/kimgio/jp2.kimgio	Tue Aug 24 08:29:21 2004
+++ kdelibs/kimgio/jp2.kimgio	Sat Oct 30 08:38:13 2004
@@ -2,6 +2,7 @@
 Type=jp2
 Header=^\x01\x01\x01\x0C\x6A\x50
 Name=JPEG 2000 Image
+Name[af]=JPEG 2000 Beeld
 Name[ar]=صورة من نوع JPEG
 Name[az]=JPEG 2000 Rəsmi
 Name[be]=Выява JPEG 2000
@@ -34,10 +35,11 @@
 Name[ja]=JPEG 2000イメージ
 Name[ko]=JPEG 2000 그림
 Name[lt]=JPEG 2000 paveiksliukas
+Name[mk]=JPEG 2000 слика
 Name[mn]=JPEG 2000 Зураг
 Name[ms]=Imej JPEG 2000
 Name[nb]=JPEG 2000 bilde
-Name[nds]=JPEG 2000-Bild
+Name[nds]=JPEG2000-Bild
 Name[nl]=JPEG 2000-afbeelding
 Name[nn]=JPEG 2000-bilete
 Name[pa]=JPEG 2000 ਚਿੱਤਰ
diff -urN -x CVS kdelibs.orig/kimgio/jpeg.kimgio kdelibs/kimgio/jpeg.kimgio
--- kdelibs.orig/kimgio/jpeg.kimgio	Tue Aug 24 08:29:21 2004
+++ kdelibs/kimgio/jpeg.kimgio	Sat Oct 30 08:38:13 2004
@@ -2,6 +2,7 @@
 Type=JPEG
 Header=
 Name=JPEG Image
+Name[af]=JPEG Beeld
 Name[ar]=صورة من نوع JPEG
 Name[az]=JPEG Rəsmi
 Name[be]=Выява JPEG
@@ -34,6 +35,7 @@
 Name[ja]=JPEGイメージ
 Name[ko]=JPEG 그림
 Name[lt]=JPEG paveiksliukas
+Name[mk]=JPEG слика
 Name[mn]=JPEG-Зураг
 Name[ms]=Imej JPEG
 Name[nb]=JPEG-bilde
diff -urN -x CVS kdelibs.orig/kimgio/pbm.kimgio kdelibs/kimgio/pbm.kimgio
--- kdelibs.orig/kimgio/pbm.kimgio	Tue Aug 24 08:29:21 2004
+++ kdelibs/kimgio/pbm.kimgio	Sat Oct 30 08:38:13 2004
@@ -2,6 +2,7 @@
 Type=PBM
 Header=
 Name=Portable Bitmap Image
+Name[af]='Portable Bitmap' Beeld
 Name[ar]=صورة قابلة للنقل PNG
 Name[az]=Portable Bitmap Rəsmi
 Name[bg]=Изображение Portable Bitmap Image
@@ -31,9 +32,11 @@
 Name[ja]=ポータブルビットマップイメージ
 Name[ko]=포터블 비트맵 그림
 Name[lt]=Perkeliamas taškinės grafikos (bitmap) bylų formatas
+Name[mk]=Портабилна Bitmap слика
 Name[mn]=Шилжүүлж болох Bitmap-Зураг
 Name[ms]=Imej Bitmap Mudah Alih
 Name[nb]=Portable Bitmap-bilde
+Name[nds]=Porteerbor Bitmap-Bild
 Name[nl]=Portable Bitmap-afbeelding
 Name[nn]=Portable Bitmap-bilete
 Name[pa]=ਪੋਰਟਬਲ ਬਿੱਟਮੈਪ ਚਿੱਤਰ
diff -urN -x CVS kdelibs.orig/kimgio/pcx.kimgio kdelibs/kimgio/pcx.kimgio
--- kdelibs.orig/kimgio/pcx.kimgio	Tue Aug 24 08:29:21 2004
+++ kdelibs/kimgio/pcx.kimgio	Sat Oct 30 08:38:13 2004
@@ -2,6 +2,7 @@
 Type=PCX
 Header=^\012
 Name=PCX Image
+Name[af]='PCX' Beeld
 Name[ar]=صورة من نوع PCX
 Name[az]=PCX Rəsmi
 Name[be]=Выява PCX
@@ -34,6 +35,7 @@
 Name[ja]=PCXイメージ
 Name[ko]=PCX 그림
 Name[lt]=PCX paveiksliukas
+Name[mk]=PCX слика
 Name[mn]=PCX-Зураг
 Name[ms]=Imej PCX
 Name[nb]=PCX-bilde
diff -urN -x CVS kdelibs.orig/kimgio/pgm.kimgio kdelibs/kimgio/pgm.kimgio
--- kdelibs.orig/kimgio/pgm.kimgio	Tue Aug 24 08:29:21 2004
+++ kdelibs/kimgio/pgm.kimgio	Sat Oct 30 08:38:13 2004
@@ -2,6 +2,7 @@
 Type=PGM
 Header=
 Name=Portable Graymap Image
+Name[af]='Portable Graymap' Beeld
 Name[ar]=صورة ثنائية اللون قابلة للنقل
 Name[az]=Portable Graymap Rəsmi
 Name[bg]=Изображение Portable Graymap Image
@@ -32,10 +33,11 @@
 Name[it]=Immagine Portable Graymap
 Name[ja]=ポータブルグレイマップイメージ
 Name[lt]=Perkeliamas pilkų pustonių (greymap) paveiksliukas
+Name[mk]=Портабилна Graymap слика
 Name[mn]=Шилжүүлж болох Greymap-Зураг
 Name[ms]=Imej Graymap Mudah Alih
 Name[nb]=Portable Graymap-bilde
-Name[nds]=Portable Graymap-Bild
+Name[nds]=Porteerbor Graymap-Bild
 Name[nl]=Portable Graymap-afbeelding
 Name[nn]=Portable Graymap-bilete
 Name[pa]=ਪੋਰਟਬਲ ਗਰੇਮੇਪ ਚਿੱਤਰ
diff -urN -x CVS kdelibs.orig/kimgio/png.kimgio kdelibs/kimgio/png.kimgio
--- kdelibs.orig/kimgio/png.kimgio	Tue Aug 24 08:29:21 2004
+++ kdelibs/kimgio/png.kimgio	Sat Oct 30 08:38:13 2004
@@ -2,6 +2,7 @@
 Type=PNG
 Header=
 Name=PNG Image
+Name[af]=Png Beeld
 Name[ar]=صورة من نوع PNG
 Name[az]=PNG Rəsmi
 Name[be]=Выява PNG
@@ -34,6 +35,7 @@
 Name[ja]=PNGイメージ
 Name[ko]=PNG 그림
 Name[lt]=PNG paveiksliukas
+Name[mk]=PNG слика
 Name[mn]=PNG-Зураг
 Name[ms]=Imej PNG
 Name[nb]=PNG-bilde
diff -urN -x CVS kdelibs.orig/kimgio/ppm.kimgio kdelibs/kimgio/ppm.kimgio
--- kdelibs.orig/kimgio/ppm.kimgio	Tue Aug 24 08:29:21 2004
+++ kdelibs/kimgio/ppm.kimgio	Sat Oct 30 08:38:13 2004
@@ -2,6 +2,7 @@
 Type=PPM
 Header=
 Name=Portable Pixmap Image
+Name[af]='Portable Pixmap' Beeld
 Name[ar]=صورة Pixmap قابلة للنقل
 Name[az]=Portable Pixmap Rəsmi
 Name[bg]=Изображение Portable Pixmap Image
@@ -32,9 +33,11 @@
 Name[ja]=ポータブルピックスマップイメージ
 Name[ko]=포터블 픽스맵 그림
 Name[lt]=Perkeliamas taškinės grafikos (pixmap) paveiksliukas
+Name[mk]=Портабилна Pixmap слика
 Name[mn]=Шилжүүлж болох Pixmap-Зураг
 Name[ms]=Imej Pixmap Mudah Alih
 Name[nb]=Portable Pixmap-bilde
+Name[nds]=Porteerbor Pixmap-Bild
 Name[nl]=Portable Pixmap-afbeelding
 Name[nn]=Portable Pixmap-bilete
 Name[pa]=ਪੋਰਟਬਲ ਪਿਕਬਲ ਚਿੱਤਰ
diff -urN -x CVS kdelibs.orig/kimgio/rgb.kimgio kdelibs/kimgio/rgb.kimgio
--- kdelibs.orig/kimgio/rgb.kimgio	Thu Sep 30 16:03:30 2004
+++ kdelibs/kimgio/rgb.kimgio	Fri Nov 12 08:27:51 2004
@@ -2,7 +2,7 @@
 Type=RGB
 Header=^\x01\xda\x01[\x01\x02]
 Name=SGI Image (RGB)
-Name[ar]=صورة من نوع SGI (RGB)
+Name[af]=SGI Beeld (RGB)
 Name[be]=Выява SGI (RGB)
 Name[bg]=Изображение SGI (RGB)
 Name[bn]=এস-জি-আই চিত্র (RGB)
@@ -19,6 +19,7 @@
 Name[et]=SGI pildifail (RGB)
 Name[fi]=SGI-kuva (RGB)
 Name[fr]=Image SGI (RVB)
+Name[ga]=Íomhá SGI (RGB)
 Name[he]=תמונת SGI (RGB)
 Name[hr]=SGI slika (RGB)
 Name[hu]=SGI-kép (RGB)
@@ -26,7 +27,10 @@
 Name[it]=Immagine SGI (RGB)
 Name[ja]=SGI イメージ (RGB)
 Name[ko]=CGI 그림 (RGB)
+Name[lt]=SGI paveiksliukas (RGB)
+Name[mk]=SGI слика (RGB)
 Name[nb]=SGI-bilde (RGB)
+Name[nds]=SGI-Bild (RGB)
 Name[nl]=SGI-afbeelding (RGB)
 Name[nn]=SGI-bilete (RGB)
 Name[pa]=SGI ਚਿੱਤਰ (RGB)
@@ -34,11 +38,12 @@
 Name[pt]=Imagem SGI (RGB)
 Name[pt_BR]=Imagem SGI (RGB)
 Name[ro]=Imagine SGI (RGB)
+Name[ru]=Изображение SGI (RGB)
 Name[se]=SGI-govva (RGB)
 Name[sk]=SGI obrázok (RGB)
 Name[sl]=Slika SGI (RGB)
 Name[sr]=SGI слика (RGB)
-Name[sr@Latn]=SGI слика (RGB)
+Name[sr@Latn]=SGI slika (RGB)
 Name[sv]=SGI-bild (RGB)
 Name[ta]=GIF பிம்பம்
 Name[tg]=Тасвири SGI (RGB)
diff -urN -x CVS kdelibs.orig/kimgio/tga.kimgio kdelibs/kimgio/tga.kimgio
--- kdelibs.orig/kimgio/tga.kimgio	Tue Aug 24 08:29:21 2004
+++ kdelibs/kimgio/tga.kimgio	Sat Oct 30 08:38:13 2004
@@ -2,11 +2,13 @@
 Type=TGA
 Header=^\x01\x01[\x02|\x0a]\x01\x01\x01\x01\x01\x01\x01\x01\x01
 Name=Truevision Targa Image
+Name[af]='Truevision Targa' Beeld
 Name[ar]=صورة Truevision Targa
 Name[az]=Truevision Targa Rəsmi
 Name[be]=Выява Truevision Targa
 Name[bg]=Изображение Truevision Targa Image
 Name[bn]=ট্রুভিশন টার্গা চিত্র
+Name[br]=Skeudenn Truevision Targa
 Name[bs]=Truevision Targa slika
 Name[ca]=Imatge Truevision de Targa
 Name[cs]=Obrázek ve formátu Truevision Targa
@@ -21,6 +23,7 @@
 Name[fa]=تصویر Truevision Targa
 Name[fi]=Truevision Targa -kuva
 Name[fr]=Image Targa Truevision
+Name[ga]=Íomhá Truevision Targa
 Name[gl]=Imaxe Targa Truevisión
 Name[he]=תמונת Truevision Targa
 Name[hi]=ट्रूविजन टाग्रा छवि
@@ -32,6 +35,7 @@
 Name[ja]=トゥルービジョンTargaイメージ
 Name[ko]=트루비전 타가 그림
 Name[lt]=Truevision Targa paveiksliukas
+Name[mk]=Truevision Targa слика
 Name[mn]=Truevision Targa Зураг
 Name[ms]=Imej Truevision Targa
 Name[nb]=Truevision Targa-bilde
diff -urN -x CVS kdelibs.orig/kimgio/tiff.kimgio kdelibs/kimgio/tiff.kimgio
--- kdelibs.orig/kimgio/tiff.kimgio	Tue Aug 24 08:29:21 2004
+++ kdelibs/kimgio/tiff.kimgio	Sat Oct 30 08:38:13 2004
@@ -2,6 +2,7 @@
 Type=TIFF
 Header=[MI][MI]
 Name=TIFF Image
+Name[af]=TIFF Beeld
 Name[ar]=صورة من نوع TIFF
 Name[az]=TIFF Rəsmi
 Name[be]=Выява TIFF
@@ -34,6 +35,7 @@
 Name[ja]=TIFFイメージ
 Name[ko]=TIFF 그림
 Name[lt]=TIFF paveiksliukas
+Name[mk]=TIFF слика
 Name[mn]=TIFF-Зураг
 Name[ms]=Imej TIFF
 Name[nb]=TIFF-bilde
diff -urN -x CVS kdelibs.orig/kimgio/xbm.kimgio kdelibs/kimgio/xbm.kimgio
--- kdelibs.orig/kimgio/xbm.kimgio	Tue Aug 24 08:29:21 2004
+++ kdelibs/kimgio/xbm.kimgio	Sat Oct 30 08:38:13 2004
@@ -2,11 +2,13 @@
 Type=XBM
 Header=
 Name=X BitMap Image
+Name[af]='X BitMap' Beeld
 Name[ar]=صورة من نوع XBitMap
 Name[az]=X BitMap Rəsmi
 Name[be]=Выява X BitMap
 Name[bg]=Изображение X BitMap Image
 Name[bn]=এক্স বিটম্যাপ চিত্র
+Name[br]=Skeudenn X BitMap
 Name[bs]=X BitMap slika
 Name[ca]=Imatge mapa de bits de X
 Name[cs]=Obrázek ve formátu X Bitmap
@@ -33,10 +35,11 @@
 Name[ja]=Xビットマップイメージ
 Name[ko]=X용 비트맵 그림
 Name[lt]=X BitMap paveiksliukas
+Name[mk]=X BitMap слика
 Name[mn]=X Bitmap зураг
 Name[ms]=Imej X BitMap
 Name[nb]=X BitMap-bilde
-Name[nds]=X BitMap-Bild
+Name[nds]=X-Bitmap-Bild
 Name[nl]=X Bitmap-afbeelding
 Name[nn]=X BitMap-bilete
 Name[pa]=X BitMap ਚਿੱਤਰ
diff -urN -x CVS kdelibs.orig/kimgio/xpm.kimgio kdelibs/kimgio/xpm.kimgio
--- kdelibs.orig/kimgio/xpm.kimgio	Tue Aug 24 08:29:21 2004
+++ kdelibs/kimgio/xpm.kimgio	Sat Oct 30 08:38:13 2004
@@ -2,11 +2,13 @@
 Type=XPM
 Header=
 Name=X PixMap Image
+Name[af]='X PixMap' Beeld
 Name[ar]=صورة من نوع X PixMap
 Name[az]=X PixMap Rəsmi
 Name[be]=Выява X PixMap
 Name[bg]=Изображение X PixMap Image
 Name[bn]=এক্স পিক্সম্যাপ চিত্র
+Name[br]=Skeudenn X PixMap
 Name[bs]=X PixMap slika
 Name[ca]=Imatge mapa de píxels de X
 Name[cs]=Obrázek ve formátu X Pixmap
@@ -33,10 +35,11 @@
 Name[ja]=Xピックスマップイメージ
 Name[ko]=X용 픽스맵 그림
 Name[lt]=X PixMap paveiksliukas
+Name[mk]=X PixMap слика
 Name[mn]=X-Bitmap зураг
 Name[ms]=Imej X PixMap
 Name[nb]=X PixMap-bilde
-Name[nds]=X PixMap-Bild
+Name[nds]=X-PixMap-Bild
 Name[nl]=X Pixmap-afbeelding
 Name[nn]=X PixMap-bilete
 Name[pa]=X PixMap ਚਿੱਤਰ
diff -urN -x CVS kdelibs.orig/kimgio/xv.kimgio kdelibs/kimgio/xv.kimgio
--- kdelibs.orig/kimgio/xv.kimgio	Tue Aug 24 08:29:21 2004
+++ kdelibs/kimgio/xv.kimgio	Sat Oct 30 08:38:13 2004
@@ -3,6 +3,7 @@
 Header=^P7 332
 Flags=T
 Name=XView Image
+Name[af]=XView Beeld
 Name[ar]=صورة من نوع XView
 Name[az]=XView Rəsmi
 Name[be]=Выява XView
@@ -35,6 +36,7 @@
 Name[ja]=XViewイメージ
 Name[ko]=XView 그림
 Name[lt]=XView paveiksliukas
+Name[mk]=XView слика
 Name[mn]=XView-Format
 Name[ms]=Imej XView
 Name[nb]=XView-format
diff -urN -x CVS kdelibs.orig/kinit/kinit.cpp kdelibs/kinit/kinit.cpp
--- kdelibs.orig/kinit/kinit.cpp	Thu Sep 23 16:06:34 2004
+++ kdelibs/kinit/kinit.cpp	Sat Nov 13 21:53:33 2004
@@ -4,7 +4,7 @@
  *           (c) 1999 Mario Weilguni <mweilguni@sime.com>
  *           (c) 2001 Lubos Lunak <l.lunak@kde.org>
  *
- * $Id$
+ * $Id$
  *
  * This library is free software; you can redistribute it and/or
  * modify it under the terms of the GNU Library General Public
@@ -59,6 +59,13 @@
 #include <kapplication.h>
 #include <klocale.h>
 
+#ifdef Q_OS_LINUX
+#include <sys/prctl.h>
+#ifndef PR_SET_NAME
+#define PR_SET_NAME 15
+#endif
+#endif
+
 #if defined Q_WS_X11 && ! defined K_WS_QTONLY
 #include <kstartupinfo.h> // schroder
 #endif
@@ -156,6 +163,13 @@
 }
 #endif
 
+/* These are to link libkparts even if 'smart' linker is used */
+#include <kparts/plugin.h>
+extern "C" KParts::Plugin* _kinit_init_kparts() { return new KParts::Plugin(); }
+/* These are to link libkio even if 'smart' linker is used */
+#include <kio/authinfo.h>
+extern "C" KIO::AuthInfo* _kioslave_init_kio() { return new KIO::AuthInfo(); }
+
 /*
  * Close fd's which are only useful for the parent process.
  * Restore default signal handlers.
@@ -492,6 +506,7 @@
           startup_id.setupStartupEnv();
 #endif
      {
+       int r;
        QCString procTitle( name );
        d.argv = (char **) malloc(sizeof(char *) * (argc+1));
        d.argv[0] = (char *) _name;
@@ -506,7 +521,16 @@
        d.argv[argc] = 0;
 
        /** Give the process a new name **/
-       kdeinit_setproctitle( "%s", procTitle.data() );
+#ifdef Q_OS_LINUX
+       /* set the process name, so that killall works like intended */
+       r = prctl(PR_SET_NAME, (unsigned long) name.data(), 0, 0, 0);
+       if ( r == 0 )
+           kdeinit_setproctitle( "%s [kdeinit] %s", name.data(), procTitle.data() );
+       else
+           kdeinit_setproctitle( "kdeinit: %s", procTitle.data() );
+#else
+       kdeinit_setproctitle( "kdeinit: %s", procTitle.data() );
+#endif
      }
 
      d.handle = 0;
@@ -562,8 +586,8 @@
      if (!d.sym )
      {
         d.sym = lt_dlsym( d.handle, "kdemain" );
-        if ( !d.sym ) 
-        { 
+        if ( !d.sym )
+        {
 #if ! KDE_IS_VERSION( 3, 90, 0 )
            d.sym = lt_dlsym( d.handle, "main");
 #endif
@@ -1670,7 +1694,7 @@
 
    /** Prepare to change process name **/
    kdeinit_initsetproctitle(argc, argv, envp);
-   kdeinit_setproctitle("Starting up...");
+   kdeinit_setproctitle("kdeinit Starting up...");
    kdeinit_library_path();
    // don't change envvars before kdeinit_initsetproctitle()
    unsetenv("LD_BIND_NOW");
@@ -1804,7 +1828,7 @@
    }
    free (safe_argv);
 
-   kdeinit_setproctitle("Running...");
+   kdeinit_setproctitle("kdeinit Running...");
 
    if (!keep_running)
       return 0;
diff -urN -x CVS kdelibs.orig/kinit/setproctitle.cpp kdelibs/kinit/setproctitle.cpp
--- kdelibs.orig/kinit/setproctitle.cpp	Mon Feb  9 22:03:15 2004
+++ kdelibs/kinit/setproctitle.cpp	Sat Nov 13 21:48:37 2004
@@ -204,10 +204,6 @@
 
 	p = buf;
 
-	/* print kdeinit: heading for grep */
-	(void) strcpy(p, "kdeinit: ");
-	p += strlen(p);
-
 	/* print the argument string */
 	va_start(ap, fmt);
 	(void) vsnprintf(p, SPACELEFT(buf, p), fmt, ap);
diff -urN -x CVS kdelibs.orig/kio/application.desktop kdelibs/kio/application.desktop
--- kdelibs.orig/kio/application.desktop	Tue Aug 24 08:29:24 2004
+++ kdelibs/kio/application.desktop	Sun Oct 24 09:01:56 2004
@@ -3,7 +3,7 @@
 Type=ServiceType
 X-KDE-ServiceType=Application
 Name=Application
-Name[af]=Aansoek
+Name[af]=Program
 Name[ar]=تطبيق
 Name[az]=Proqram
 Name[be]=Дастасаваньне
diff -urN -x CVS kdelibs.orig/kio/bookmarks/kbookmarkbar.cc kdelibs/kio/bookmarks/kbookmarkbar.cc
--- kdelibs.orig/kio/bookmarks/kbookmarkbar.cc	Sat Aug  7 17:01:21 2004
+++ kdelibs/kio/bookmarks/kbookmarkbar.cc	Tue Oct 26 21:11:27 2004
@@ -309,16 +309,18 @@
     {
         index = tb->itemIndex(b->id());
         QRect r = b->geometry();
-        if (index == 0)
-            atFirst = true;
-        else if (pos.x() < ((r.left() + r.right())/2))
+        if (pos.x() < ((r.left() + r.right())/2))
         {
             // if in first half of button then 
             // we jump to previous index
+            if ( index == 0 )
+                atFirst = true;
+            else {
             index--;
             b = tb->getButton(tb->idAt(index));
         }
     }
+    }
     else if (actions.isEmpty())
     {
         atFirst = true;
@@ -340,6 +342,9 @@
             goto skipact; // TODO - rename
     }
 
+    if ( !b )
+        return QString::null; // TODO Make it works for that case
+
     a = findPluggedAction(actions, tb, b->id());
     Q_ASSERT(a);
     address = a->property("address").toString();
diff -urN -x CVS kdelibs.orig/kio/kcmodule.desktop kdelibs/kio/kcmodule.desktop
--- kdelibs.orig/kio/kcmodule.desktop	Tue Aug 24 08:29:24 2004
+++ kdelibs/kio/kcmodule.desktop	Sat Oct 30 08:38:13 2004
@@ -3,11 +3,13 @@
 Type=ServiceType
 X-KDE-ServiceType=KCModule
 Name=KDE Control Module
+Name[af]=KDE Beheer Module
 Name[ar]=وحدة تحكم كيدي
 Name[az]=KDE İdarə Modulu
 Name[be]=Модуль кіраваньня KDED
 Name[bg]=Контролен модул
 Name[bn]=কে.ডি.ই. নিয়ন্ত্রণ মডিউল
+Name[br]=Mollad ar Kreizenn ren KDE
 Name[bs]=KDE kontrolni modul
 Name[ca]=Mòdul de control del KDE
 Name[cs]=Ovládací modul KDE
@@ -34,10 +36,11 @@
 Name[ja]=KDE コントロールモジュール
 Name[ko]=KDE 제어 모듈
 Name[lt]=KDE valdymo modulis
+Name[mk]=KDE Контролен Модул
 Name[mn]=KDED-Хяналтын Модул
 Name[ms]=Modul Kawalan KDE
 Name[nb]=KDE kontrollsenter-modul
-Name[nds]=KDE Kuntrullmodul
+Name[nds]=KDE-Kuntrullmoduul
 Name[nl]=KDE Configuratiemodule
 Name[nn]=KDE-kontrollmodul
 Name[nso]=Seripa sa Taolo ya KDE
diff -urN -x CVS kdelibs.orig/kio/kcomprfilter.desktop kdelibs/kio/kcomprfilter.desktop
--- kdelibs.orig/kio/kcomprfilter.desktop	Tue Aug 31 09:21:29 2004
+++ kdelibs/kio/kcomprfilter.desktop	Sat Oct 30 08:38:13 2004
@@ -3,7 +3,7 @@
 Type=ServiceType
 X-KDE-ServiceType=KDECompressionFilter
 Name=KDE Compression Filter
-Name[af]=Kde Saampersing Filter
+Name[af]=KDE Kompakteer Filter
 Name[ar]=فلتر ضغط الملفات لكيدي
 Name[az]=KDE Sıxışdırma Filtri
 Name[bg]=Компресиращ филтър
@@ -35,11 +35,12 @@
 Name[ko]=KDE 압축 거르개
 Name[lt]=KDE suspaudimo filtras
 Name[lv]=KDE Kompresijas FIltrs
+Name[mk]=KDE филтер за компресија
 Name[mn]=KDE-шахагчийн шүүлтүүр
 Name[ms]=Penapis Pemadatan KDE
 Name[mt]=Filtru tal-kompressjoni KDE
 Name[nb]=Komprimeringsfilter for KDE
-Name[nds]=KDE-Komprimeerfilter
+Name[nds]=KDE-Filter för't Kumprimeren
 Name[nl]=KDE Compressiefilter
 Name[nn]=KDE Kompresjonsfilter
 Name[nso]=Sesekodi sa Pitleletso ya KDE
diff -urN -x CVS kdelibs.orig/kio/kdatatool.desktop kdelibs/kio/kdatatool.desktop
--- kdelibs.orig/kio/kdatatool.desktop	Tue Aug 24 08:29:24 2004
+++ kdelibs/kio/kdatatool.desktop	Sun Nov 28 09:33:03 2004
@@ -3,7 +3,7 @@
 Type=ServiceType
 X-KDE-ServiceType=KDataTool
 Comment=KDE Data Tool
-Comment[af]=Kde Data Program
+Comment[af]=KDE Data Program
 Comment[ar]=أداة كيدي للبيانات
 Comment[az]=KDE Verilənlər Vasitəsi
 Comment[bn]=কে.ডি.ই তথ্য টুল
@@ -34,11 +34,12 @@
 Comment[ko]=KDE 자료 연장
 Comment[lt]=KDE duomenų priemonė
 Comment[lv]=KDE Datu Rīks
+Comment[mk]=KDE податочна алатка
 Comment[mn]=KDE-Өгөгдөл боловсруулах программ
 Comment[ms]=Alatan Data KDE
 Comment[mt]=Għodda għal data KDE
 Comment[nb]=KDE Dataverktøy
-Comment[nds]=KDE-Datenwarktüüg
+Comment[nds]=KDE-Datenwarktüüch
 Comment[nl]=KDE Data-hulpprogramma
 Comment[nn]=KDE Dataverktøy
 Comment[nso]=Sebereka sa Data ya KDE
@@ -48,7 +49,7 @@
 Comment[pt_BR]=Ferramenta de Dados do KDE
 Comment[ro]=Utilitar de date KDE
 Comment[ru]=Утилита обработки информации KDE
-Comment[se]=KDE dáhtaneavvu
+Comment[se]=KDE dáhtareaidu
 Comment[sk]=Dátový nástroj KDE
 Comment[sl]=Podatkovno orodje za KDE
 Comment[sq]=Vegla për të Dhëna - KDE
diff -urN -x CVS kdelibs.orig/kio/kfile/kfiletreebranch.cpp kdelibs/kio/kfile/kfiletreebranch.cpp
--- kdelibs.orig/kio/kfile/kfiletreebranch.cpp	Wed Aug 11 22:26:22 2004
+++ kdelibs/kio/kfile/kfiletreebranch.cpp	Sun Nov 21 22:16:36 2004
@@ -299,6 +299,11 @@
         }
 
         kdDebug(250) << "Found corresponding KFileTreeViewItem" << endl;
+        if( m_lastFoundURL.equals( it->url(), true ))
+        {
+          m_lastFoundURL = KURL();
+          m_lastFoundItem = 0L;
+        }
         delete( kfti );
     }
     else
diff -urN -x CVS kdelibs.orig/kio/kfile/kicondialog.cpp kdelibs/kio/kfile/kicondialog.cpp
--- kdelibs.orig/kio/kfile/kicondialog.cpp	Sat Jul 31 18:19:04 2004
+++ kdelibs/kio/kfile/kicondialog.cpp	Fri Oct 29 22:34:47 2004
@@ -121,7 +121,7 @@
 #ifdef HAVE_LIBART
     KSVGIconEngine *svgEngine = new KSVGIconEngine();
 #endif
-    
+
     d->m_bLoading = true;
     int i;
     QStringList::ConstIterator it;
@@ -143,7 +143,7 @@
         if ( !d->m_bLoading ) // user clicked on a button that will load another set of icons
             break;
 	QImage img;
-	
+
 	// Use the extension as the format. Works for XPM and PNG, but not for SVG
 	QString path= *it;
 	QString ext = path.right(3).upper();
@@ -155,8 +155,8 @@
 	    if (svgEngine->load(60, 60, *it))
 		img = *svgEngine->painter()->image();
 #endif
-	
-	if (img.isNull()) 
+
+	if (img.isNull())
 	    continue;
 	if (img.width() > 60 || img.height() > 60)
 	{
@@ -258,10 +258,12 @@
     QVBoxLayout *top = new QVBoxLayout(main);
     top->setSpacing( spacingHint() );
 
-    QButtonGroup *bgroup = new QButtonGroup(i18n("Icon Source"), main);
+    QButtonGroup *bgroup = new QButtonGroup(0, Qt::Vertical, i18n("Icon Source"), main);
+    bgroup->layout()->setSpacing(KDialog::spacingHint());
+    bgroup->layout()->setMargin(KDialog::marginHint());
     top->addWidget(bgroup);
     connect(bgroup, SIGNAL(clicked(int)), SLOT(slotButtonClicked(int)));
-    QGridLayout *grid = new QGridLayout(bgroup, 3, 2, marginHint(), spacingHint());
+    QGridLayout *grid = new QGridLayout(bgroup->layout(), 3, 2);
     grid->addRowSpacing(0, 15);
     mpRb1 = new QRadioButton(i18n("&System icons:"), bgroup);
     grid->addWidget(mpRb1, 1, 0);
@@ -331,7 +333,7 @@
     QStringList::Iterator it;
     for( it = filelist.begin(); it != filelist.end(); ++it )
        iconlist.append(new IconPath(*it));
-       
+
     iconlist.sort();
     filelist.clear();
 
diff -urN -x CVS kdelibs.orig/kio/kfile/kpropertiesdialog.cpp kdelibs/kio/kfile/kpropertiesdialog.cpp
--- kdelibs.orig/kio/kfile/kpropertiesdialog.cpp	Fri Sep 17 19:07:08 2004
+++ kdelibs/kio/kfile/kpropertiesdialog.cpp	Wed Nov 10 16:07:45 2004
@@ -275,7 +275,7 @@
 {
   if (d->fileSharePage) {
      showPage( pageIndex( d->fileSharePage));
-  }            
+  }
 }
 
 void KPropertiesDialog::setFileSharingPage(QWidget* page) {
@@ -428,7 +428,8 @@
     insertPlugin (p);
   }
 
-  if ( KFileSharePropsPlugin::supports( m_items ) )
+  if ( kapp->authorizeKAction("sharefile") && 
+       KFileSharePropsPlugin::supports( m_items ) )
   {
     KPropsDlgPlugin *p = new KFileSharePropsPlugin( this );
     insertPlugin (p);
@@ -1020,7 +1021,7 @@
        QPushButton *button = properties->actionButton(KDialogBase::Ok);
        if (button)
           button->setFocus();
-    }    
+    }
   }
 }
 
@@ -1108,7 +1109,7 @@
     m_sizeLabel->setText( i18n("Calculating... %1 (%2)\n%3, %4")
 			  .arg(KIO::convertSize(totalSize))
                          .arg(KGlobal::locale()->formatNumber(totalSize, 0))
-        .arg(i18n("1 file","%n files",totalFiles)) 
+        .arg(i18n("1 file","%n files",totalFiles))
         .arg(i18n("1 sub-folder","%n sub-folders",totalSubdirs)));
 }
 
@@ -1123,8 +1124,8 @@
 	KIO::filesize_t totalSubdirs = static_cast<KDirSize*>(job)->totalSubdirs();
     m_sizeLabel->setText( QString::fromLatin1("%1 (%2)\n%3, %4")
 			  .arg(KIO::convertSize(totalSize))
-			  .arg(KGlobal::locale()->formatNumber(totalSize, 0)) 
-        .arg(i18n("1 file","%n files",totalFiles)) 
+			  .arg(KGlobal::locale()->formatNumber(totalSize, 0))
+        .arg(i18n("1 file","%n files",totalFiles))
         .arg(i18n("1 sub-folder","%n sub-folders",totalSubdirs)));
   }
   m_sizeStopButton->setEnabled(false);
@@ -1207,11 +1208,11 @@
     if ( oldName != n || m_bFromTemplate ) { // true for any from-template file
       KIO::Job * job = 0L;
       KURL oldurl = properties->kurl();
-      
+
       QString newFileName = KIO::encodeFileName(n);
       if (d->bDesktopFile && !newFileName.endsWith(".desktop") && !newFileName.endsWith(".kdelnk"))
          newFileName += ".desktop";
-         
+
       // Tell properties. Warning, this changes the result of properties->kurl() !
       properties->rename( newFileName );
 
@@ -1581,10 +1582,12 @@
 
 
   /**** Group: Ownership ****/
-  gb = new QGroupBox ( i18n("Ownership"), d->m_frame );
+  gb = new QGroupBox ( 0, Qt::Vertical, i18n("Ownership"), d->m_frame );
+  gb->layout()->setSpacing(KDialog::spacingHint());
+  gb->layout()->setMargin(KDialog::marginHint());
   box->addWidget (gb);
 
-  gl = new QGridLayout (gb, 4, 3, KDialog::marginHint(), KDialog::spacingHint());
+  gl = new QGridLayout (gb->layout(), 4, 3);
   gl->addRowSpacing(0, 10);
 
   /*** Set Owner ***/
@@ -1744,10 +1747,12 @@
   QGridLayout *gl;
 
   // Group: Access Permissions
-  gb = new QGroupBox ( i18n("Access Permissions"), &dlg );
+  gb = new QGroupBox ( 0, Qt::Vertical, i18n("Access Permissions"), &dlg );
+  gb->layout()->setSpacing(KDialog::spacingHint());
+  gb->layout()->setMargin(KDialog::marginHint());
   dlg.setMainWidget(gb);
 
-  gl = new QGridLayout (gb, 6, 6, 15);
+  gl = new QGridLayout (gb->layout(), 6, 6);
   gl->addRowSpacing(0, 10);
 
   l = new QLabel(i18n("Class"), gb);
@@ -2834,7 +2839,7 @@
   }
   else
     m_systrayBool = false;
-    
+
   m_origCommandStr = commandStr;
   QString pathStr = config.readPathEntry( "Path" );
   m_terminalBool = config.readBoolEntry( "Terminal" );
diff -urN -x CVS kdelibs.orig/kio/kfile/kpropsdlgplugin.desktop kdelibs/kio/kfile/kpropsdlgplugin.desktop
--- kdelibs.orig/kio/kfile/kpropsdlgplugin.desktop	Mon Oct  4 15:25:07 2004
+++ kdelibs/kio/kfile/kpropsdlgplugin.desktop	Fri Nov 19 08:36:06 2004
@@ -3,7 +3,7 @@
 Type=ServiceType
 X-KDE-ServiceType=KPropsDlg/Plugin
 Comment=Plugin for the Properties Dialog
-Comment[af]=Inplak vir die Eienskappe Dialoog
+Comment[af]=Inprop module vir die Eienskappe Dialoog
 Comment[ar]=ملحق لمربع حوار خصائص
 Comment[az]=Seçənəklər Rabitə Qutusu Üçün Əlavə
 Comment[bg]=Приставка за диалога Информация
@@ -36,12 +36,12 @@
 Comment[ko]=대화창 특성을 위한 플러그인
 Comment[lt]=Priedas savybių dialogui
 Comment[lv]=Īpašību Dialoga Iespraudnis
-Comment[mk]=Плагин за дијалогот за параметри
+Comment[mk]=Приклучок за дијалогот за својства
 Comment[mn]=Шинж чанарууд диалогийн Plugin
 Comment[ms]=Plugmasuk untuk Dialog Ciri-ciri
 Comment[mt]=Plugin għad-djalogu tal-propjetajiet
 Comment[nb]=Programtillegg for dialogvinduet for egenskaper
-Comment[nds]=Plugin för den Eegenschapen Dialoog
+Comment[nds]=Plugin för den Egenschappen-Dialoog
 Comment[nl]=Plugin voor de 'Eigenschappen'-dialoog
 Comment[nn]=Tillegg til eigenskapar-dialogen
 Comment[nso]=Tsenyo ya Poledisano ya Dithoto
@@ -52,7 +52,7 @@
 Comment[pt_BR]=Plug-in para a janela de Propriedades
 Comment[ro]=Modul pentru dialogul de proprietăţi
 Comment[ru]=Модуль для диалога настроек
-Comment[se]=Lassemoduvla iešvuođahtalásaža várás
+Comment[se]=Lassemoduvla iešvuođahtaláseža várás
 Comment[sk]=modul pre  ialóg ílastnosti
 Comment[sl]=Vstavek za pogovorno okno z lastnostmi
 Comment[sq]=Shtojcë për Dialogun e Rekuizitave
diff -urN -x CVS kdelibs.orig/kio/kfileplugin.desktop kdelibs/kio/kfileplugin.desktop
--- kdelibs.orig/kio/kfileplugin.desktop	Mon Oct  4 15:25:07 2004
+++ kdelibs/kio/kfileplugin.desktop	Sat Oct 30 08:38:13 2004
@@ -3,7 +3,7 @@
 Type=ServiceType
 X-KDE-ServiceType=KFilePlugin
 Name=KFile Meta Data Plugin
-Name[af]=Klêer Meta Data Inplak
+Name[af]=Klêer Meta Data Inprop module
 Name[ar]=ملحق KFile Meta Data
 Name[az]=KFile Meta Data Əlavəsi
 Name[bg]=Приставка за мета данни
@@ -35,10 +35,12 @@
 Name[ko]=K파일 메타 자료 플러그인
 Name[lt]=KFile Meta duomenų priedas
 Name[lv]=KFailu Meta Datu Iespraudnis
+Name[mk]=KFile приклучок за мета податоци
 Name[mn]=KFile: Мита өгөгдлийн -Plugin
 Name[ms]=Plug masuk Data Meta KFile
 Name[mt]=Plagin metadata ta' KFile
 Name[nb]=KFile programtillegg for metadata
+Name[nds]=KFile, Metadaten-Plugin
 Name[nn]=KFile-programtillegg for metadata
 Name[nso]=Tsenyo ya Data ya Meta wa KFaele
 Name[pa]=KFile ਮੈਟਾ ਡਾਟਾ ਪਲੱਗਇਨ
diff -urN -x CVS kdelibs.orig/kio/kio/dataprotocol.cpp kdelibs/kio/kio/dataprotocol.cpp
--- kdelibs.orig/kio/kio/dataprotocol.cpp	Tue Oct 28 22:30:29 2003
+++ kdelibs/kio/kio/dataprotocol.cpp	Wed Nov  3 23:17:31 2004
@@ -257,6 +257,7 @@
 /* --------------------------------------------------------------------- */
 
 void DataProtocol::get(const KURL& url) {
+  ref();
   //kdDebug() << "===============================================================================================================================================================================" << endl;
   kdDebug() << "kio_data@"<<this<<"::get(const KURL& url)" << endl ;
 
@@ -311,23 +312,26 @@
   //kdDebug() << "emit sendMetaData@"<<this << endl ;
   sendMetaData();
   //kdDebug() << "^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C^[[C" << endl;
-  //kdDebug() << "queue size " << dispatchQueue.size() << endl;
+//   kdDebug() << "(1) queue size " << dispatchQueue.size() << endl;
   // empiric studies have shown that this shouldn't be queued & dispatched
   /*DISPATCH*/(data(outData));
-  //kdDebug() << "queue size " << dispatchQueue.size() << endl;
+//   kdDebug() << "(2) queue size " << dispatchQueue.size() << endl;
   DISPATCH(data(QByteArray()));
-  //kdDebug() << "queue size " << dispatchQueue.size() << endl;
+//   kdDebug() << "(3) queue size " << dispatchQueue.size() << endl;
   DISPATCH(finished());
-  //kdDebug() << "queue size " << dispatchQueue.size() << endl;
+//   kdDebug() << "(4) queue size " << dispatchQueue.size() << endl;
+  deref();
 }
 
 /* --------------------------------------------------------------------- */
 
 void DataProtocol::mimetype(const KURL &url) {
+  ref();
   DataHeader hdr;
   parseDataHeader(url,hdr);
   mimeType(hdr.mime_type);
   finished();
+  deref();
 }
 
 /* --------------------------------------------------------------------- */
diff -urN -x CVS kdelibs.orig/kio/kio/dataslave.cpp kdelibs/kio/kio/dataslave.cpp
--- kdelibs.orig/kio/kio/dataslave.cpp	Tue Oct 28 22:30:29 2003
+++ kdelibs/kio/kio/dataslave.cpp	Wed Nov  3 23:17:31 2004
@@ -50,12 +50,13 @@
 
 void DataSlave::suspend() {
   _suspended = true;
+  //kdDebug() << this << k_funcinfo << endl;
   timer->stop();
 }
 
 void DataSlave::resume() {
   _suspended = false;
-  kdDebug() << this << k_funcinfo << endl;
+  //kdDebug() << this << k_funcinfo << endl;
   // aarrrgh! This makes the once hyper fast and efficient data protocol
   // implementation slow as molasses. But it wouldn't work otherwise,
   // and I don't want to start messing around with threads
@@ -72,12 +73,7 @@
     case QueueTotalSize:	totalSize(q.size); break;
     case QueueSendMetaData:	sendMetaData(); break;
     case QueueData:		data(q.ba); break;
-    case QueueFinished:
-      finished();
-      kill();			// commit suicide, we don't want to be reused
-      emit slaveDied(this);
-      //delete this;
-      return;
+    case QueueFinished:		finished(); break;
   }/*end switch*/
 
   dispatchQueue.pop_front();
diff -urN -x CVS kdelibs.orig/kio/kio/job.cpp kdelibs/kio/kio/job.cpp
--- kdelibs.orig/kio/kio/job.cpp	Fri Oct  1 22:29:04 2004
+++ kdelibs/kio/kio/job.cpp	Tue Nov  9 01:50:35 2004
@@ -50,6 +50,7 @@
 #include <kmessagebox.h>
 #include <kdatastream.h>
 #include <kmainwindow.h>
+#include <kde_file.h>
 
 #include <errno.h>
 
@@ -2392,6 +2393,15 @@
     }
 }
 
+void CopyJob::skipSrc()
+{
+    m_dest = d->m_globalDest;
+    destinationState = d->m_globalDestinationState;
+    ++m_currentStatSrc;
+    skip( m_currentSrcURL );
+    statCurrentSrc();
+}
+
 void CopyJob::statNextSrc()
 {
     m_dest = d->m_globalDest;
@@ -2539,6 +2549,26 @@
     dirsToRemove.remove( sourceUrl );
 }
 
+bool CopyJob::shouldOverwrite( const QString& path ) const
+{
+    if ( m_bOverwriteAll )
+        return true;
+    QStringList::ConstIterator sit = m_overwriteList.begin();
+    for( ; sit != m_overwriteList.end(); ++sit )
+        if ( path.startsWith( *sit ) )
+            return true;
+    return false;
+}
+
+bool CopyJob::shouldSkip( const QString& path ) const
+{
+    QStringList::ConstIterator sit = m_skipList.begin();
+    for( ; sit != m_skipList.end(); ++sit )
+        if ( path.startsWith( *sit ) )
+            return true;
+    return false;
+}
+
 void CopyJob::slotResultCreatingDirs( Job * job )
 {
     // The dir we are trying to create:
@@ -2553,19 +2583,14 @@
             KURL oldURL = ((SimpleJob*)job)->url();
             // Should we skip automatically ?
             if ( m_bAutoSkip ) {
-                // We dont want to copy files in this directory, so we put it on the skip list
+                // We don't want to copy files in this directory, so we put it on the skip list
                 m_skipList.append( oldURL.path( 1 ) );
                 skip( oldURL );
                 dirs.remove( it ); // Move on to next dir
             } else {
                 // Did the user choose to overwrite already?
-                bool bOverwrite = m_bOverwriteAll;
-                QString destFile = (*it).uDest.path();
-                QStringList::Iterator sit = m_overwriteList.begin();
-                for( ; sit != m_overwriteList.end() && !bOverwrite; sit++ )
-                    if ( *sit == destFile.left( (*sit).length() ) )
-                        bOverwrite = true;
-                if ( bOverwrite ) { // overwrite => just skip
+                const QString destFile = (*it).uDest.path();
+                if ( shouldOverwrite( destFile ) ) { // overwrite => just skip
                     emit copyingDone( this, ( *it ).uSource, ( *it ).uDest, true /* directory */, false /* renamed */ );
                     dirs.remove( it ); // Move on to next dir
                 } else {
@@ -2756,16 +2781,8 @@
         // Is this URL on the skip list or the overwrite list ?
         while( it != dirs.end() && udir.isEmpty() )
         {
-            QString dir = (*it).uDest.path();
-            bool bCreateDir = true; // we'll create it if it's not in any list
-
-            QStringList::Iterator sit = m_skipList.begin();
-            for( ; sit != m_skipList.end() && bCreateDir; sit++ )
-                // Is dir a subdirectory of *sit ?
-                if ( *sit == dir.left( (*sit).length() ) )
-                    bCreateDir = false; // skip this dir
-
-            if ( !bCreateDir ) {
+            const QString dir = (*it).uDest.path();
+            if ( shouldSkip( dir ) ) {
                 dirs.remove( it );
                 it = dirs.begin();
             } else
@@ -2934,10 +2951,10 @@
                 mode = M_OVERWRITE;
         }
 
-        if ( files.count() > 1 ) // Not last one
-            mode = (RenameDlg_Mode) ( mode | M_MULTI | M_SKIP );
-        else
+        if ( m_bSingleFileCopy )
             mode = (RenameDlg_Mode) ( mode | M_SINGLE );
+        else
+            mode = (RenameDlg_Mode) ( mode | M_MULTI | M_SKIP );
 
         res = Observer::self()->open_RenameDlg( this, m_conflictError == ERR_FILE_ALREADY_EXIST ?
                                 i18n("File Already Exists") : i18n("Already Exists as Folder"),
@@ -3021,16 +3038,9 @@
     // Is this URL on the skip list ?
     while (it != files.end() && !bCopyFile)
     {
-        bCopyFile = true;
-        QString destFile = (*it).uDest.path();
-
-        QStringList::Iterator sit = m_skipList.begin();
-        for( ; sit != m_skipList.end() && bCopyFile; sit++ )
-            // Is destFile in *sit (or a subdirectory of *sit) ?
-            if ( *sit == destFile.left( (*sit).length() ) )
-                bCopyFile = false; // skip this file
-
-        if (!bCopyFile) {
+        const QString destFile = (*it).uDest.path();
+        bCopyFile = !shouldSkip( destFile );
+        if ( !bCopyFile ) {
             files.remove( it );
             it = files.begin();
         }
@@ -3039,19 +3049,13 @@
     if (bCopyFile) // any file to create, finally ?
     {
         // Do we set overwrite ?
-        bool bOverwrite = m_bOverwriteAll; // yes if overwrite all
-        QString destFile = (*it).uDest.path();
+        bool bOverwrite;
+        const QString destFile = (*it).uDest.path();
         kdDebug(7007) << "copying " << destFile << endl;
         if ( (*it).uDest == (*it).uSource )
             bOverwrite = false;
         else
-        {
-            // or if on the overwrite list
-            QStringList::Iterator sit = m_overwriteList.begin();
-            for( ; sit != m_overwriteList.end() && !bOverwrite; sit++ )
-                if ( *sit == destFile.left( (*sit).length() ) )
-                    bOverwrite = true;
-        }
+            bOverwrite = shouldOverwrite( destFile );
 
         m_bCurrentOperationIsLink = false;
         KIO::Job * newjob = 0L;
@@ -3118,7 +3122,9 @@
                            KSimpleConfig config( path );
                            config.setDesktopGroup();
                            config.writePathEntry( QString::fromLatin1("URL"), (*it).uSource.url() );
-                           config.writeEntry( QString::fromLatin1("Name"), (*it).uSource.url() );
+                           KURL urlName = (*it).uSource;
+                           urlName.setPass( "" );
+                           config.writeEntry( QString::fromLatin1("Name"), urlName.url() );
                            config.writeEntry( QString::fromLatin1("Type"), QString::fromLatin1("Link") );
                            QString protocol = (*it).uSource.protocol();
                            if ( protocol == QString::fromLatin1("ftp") )
@@ -3296,150 +3302,201 @@
     deleteNextDir();
 }
 
-void CopyJob::slotResult( Job *job )
+void CopyJob::slotResultRenaming( Job* job )
 {
-    //kdDebug(7007) << "CopyJob::slotResult() state=" << (int) state << endl;
-    // In each case, what we have to do is :
-    // 1 - check for errors and treat them
-    // 2 - subjobs.remove(job);
-    // 3 - decide what to do next
-
-    switch ( state ) {
-        case STATE_STATING: // We were trying to stat a src url or the dest
-            slotResultStating( job );
-            break;
-        case STATE_RENAMING: // We were trying to do a direct renaming, before even stat'ing
-        {
-            int err = job->error();
-            subjobs.remove( job );
-            assert ( subjobs.isEmpty() );
-            // Determine dest again
-            KURL dest = m_dest;
-            if ( destinationState == DEST_IS_DIR && !m_asMethod )
-                dest.addPath( m_currentSrcURL.fileName() );
-            if ( err )
+    int err = job->error();
+    subjobs.remove( job );
+    assert ( subjobs.isEmpty() );
+    // Determine dest again
+    KURL dest = m_dest;
+    if ( destinationState == DEST_IS_DIR && !m_asMethod )
+        dest.addPath( m_currentSrcURL.fileName() );
+    if ( err )
+    {
+        // Direct renaming didn't work. Try renaming to a temp name,
+        // this can help e.g. when renaming 'a' to 'A' on a VFAT partition.
+        // In that case it's the _same_ dir, we don't want to copy+del (data loss!)
+        if ( m_currentSrcURL.isLocalFile() && m_currentSrcURL.url(-1) != dest.url(-1) &&
+             m_currentSrcURL.url(-1).lower() == dest.url(-1).lower() &&
+             ( err == ERR_FILE_ALREADY_EXIST || err == ERR_DIR_ALREADY_EXIST ) )
+        {
+            kdDebug(7007) << "Couldn't rename directly, dest already exists. Detected special case of lower/uppercase renaming in same dir, try with 2 rename calls" << endl;
+            QCString _src( QFile::encodeName(m_currentSrcURL.path()) );
+            QCString _dest( QFile::encodeName(dest.path()) );
+            KTempFile tmpFile( m_currentSrcURL.directory(false) );
+            QCString _tmp( QFile::encodeName(tmpFile.name()) );
+            kdDebug(7007) << "CopyJob::slotResult KTempFile status:" << tmpFile.status() << " using " << _tmp << " as intermediary" << endl;
+            tmpFile.unlink();
+            if ( ::rename( _src, _tmp ) == 0 )
             {
-                // Direct renaming didn't work. Try renaming to a temp name,
-                // this can help e.g. when renaming 'a' to 'A' on a VFAT partition.
-                // In that case it's the _same_ dir, we don't want to copy+del (data loss!)
-                if ( m_currentSrcURL.isLocalFile() && m_currentSrcURL.url(-1) != dest.url(-1) &&
-                     m_currentSrcURL.url(-1).lower() == dest.url(-1).lower() &&
-                     ( err == ERR_FILE_ALREADY_EXIST || err == ERR_DIR_ALREADY_EXIST ) )
+                if ( !QFile::exists( _dest ) && ::rename( _tmp, _dest ) == 0 )
                 {
-                    kdDebug(7007) << "Couldn't rename directly, dest already exists. Detected special case of lower/uppercase renaming in same dir, try with 2 rename calls" << endl;
-                    QCString _src( QFile::encodeName(m_currentSrcURL.path()) );
-                    QCString _dest( QFile::encodeName(dest.path()) );
-                    KTempFile tmpFile( m_currentSrcURL.directory(false) );
-                    QCString _tmp( QFile::encodeName(tmpFile.name()) );
-                    kdDebug(7007) << "CopyJob::slotResult KTempFile status:" << tmpFile.status() << " using " << _tmp << " as intermediary" << endl;
-                    tmpFile.unlink();
-                    if ( ::rename( _src, _tmp ) == 0 )
-                    {
-                        if ( !QFile::exists( _dest ) && ::rename( _tmp, _dest ) == 0 )
-                        {
-                            kdDebug(7007) << "Success." << endl;
-                            err = 0;
-                        }
-                        else
-                        {
-                            // Revert back to original name!
-                            if ( ::rename( _tmp, _src ) != 0 ) {
-                                kdError(7007) << "Couldn't rename " << tmpFile.name() << " back to " << _src << " !" << endl;
-                                // Severe error, abort
-                                Job::slotResult( job ); // will set the error and emit result(this)
-                                return;
-                            }
-                        }
+                    kdDebug(7007) << "Success." << endl;
+                    err = 0;
+                }
+                else
+                {
+                    // Revert back to original name!
+                    if ( ::rename( _tmp, _src ) != 0 ) {
+                        kdError(7007) << "Couldn't rename " << tmpFile.name() << " back to " << _src << " !" << endl;
+                        // Severe error, abort
+                        Job::slotResult( job ); // will set the error and emit result(this)
+                        return;
                     }
                 }
             }
-            if ( err )
-            {
-                // This code is similar to CopyJob::slotResultConflictCopyingFiles
-                // but here it's about the base src url being moved/renamed
-                // (*m_currentStatSrc) and its dest (m_dest), not about a single file.
-                // It also means we already stated the dest, here.
-                // On the other hand we haven't stated the src yet (we skipped doing it
-                // to save time, since it's not necessary to rename directly!)...
+        }
+    }
+    if ( err )
+    {
+        // This code is similar to CopyJob::slotResultConflictCopyingFiles
+        // but here it's about the base src url being moved/renamed
+        // (*m_currentStatSrc) and its dest (m_dest), not about a single file.
+        // It also means we already stated the dest, here.
+        // On the other hand we haven't stated the src yet (we skipped doing it
+        // to save time, since it's not necessary to rename directly!)...
 
-                Q_ASSERT( m_currentSrcURL == *m_currentStatSrc );
+        Q_ASSERT( m_currentSrcURL == *m_currentStatSrc );
 
-                // Existing dest?
-                if ( err == ERR_DIR_ALREADY_EXIST || err == ERR_FILE_ALREADY_EXIST )
-                {
-                    if (m_reportTimer)
-                        m_reportTimer->stop();
+        // Existing dest?
+        if ( err == ERR_DIR_ALREADY_EXIST || err == ERR_FILE_ALREADY_EXIST )
+        {
+            if (m_reportTimer)
+                m_reportTimer->stop();
+
+            // Should we skip automatically ?
+            if ( m_bAutoSkip ) {
+                // Move on to next file
+                skipSrc();
+                return;
+            } else if ( m_bOverwriteAll ) {
+                ; // nothing to do, stat+copy+del will overwrite
+            } else {
+                QString newPath;
+                // Offer overwrite only if the existing thing is a file
+                // If src==dest, use "overwrite-itself"
+                RenameDlg_Mode mode = (RenameDlg_Mode)
+                                      ( ( err == ERR_DIR_ALREADY_EXIST ? 0 :
+                                          ( m_currentSrcURL == dest ) ? M_OVERWRITE_ITSELF : M_OVERWRITE ) );
 
-                    QString newPath;
-                    // Offer overwrite only if the existing thing is a file
-                    // If src==dest, use "overwrite-itself"
-                    RenameDlg_Mode mode = (RenameDlg_Mode)
-                        ( ( err == ERR_DIR_ALREADY_EXIST ? 0 :
-                            ( m_currentSrcURL == dest ) ? M_OVERWRITE_ITSELF : M_OVERWRITE ) );
-                    // I won't use M_MULTI or M_SKIP there. It's too ambiguous:
-                    // we are in the middle of the stat phase, so it's hard to know
-                    // if it will apply to the already-stated-dirs that will be copied later,
-                    // and/oor to the to-be-stated src urls that might be in the same case...
+                if ( m_srcList.count() > 1 )
+                    mode = (RenameDlg_Mode) ( mode | M_MULTI | M_SKIP );
+                else
                     mode = (RenameDlg_Mode) ( mode | M_SINGLE );
-                    // we lack mtime info for both the src (not stated)
-                    // and the dest (stated but this info wasn't stored)
-                    RenameDlg_Result r = Observer::self()->open_RenameDlg( this,
-                                         err == ERR_FILE_ALREADY_EXIST ? i18n("File Already Exists") : i18n("Already Exists as Folder"),
-                                         m_currentSrcURL.prettyURL(0, KURL::StripFileProtocol),
-                                         dest.prettyURL(0, KURL::StripFileProtocol),
-                                         mode, newPath );
-                    if (m_reportTimer)
-                        m_reportTimer->start(REPORT_TIMEOUT,false);
 
-                    switch ( r )
-                    {
-                        case R_CANCEL:
-                        {
-                            m_error = ERR_USER_CANCELED;
-                            emitResult();
-                            return;
-                        }
-                        case R_RENAME:
-                        {
-                            // Set m_dest to the chosen destination
-                            // This is only for this src url; the next one will revert to d->m_globalDest
-                            m_dest.setPath( newPath );
-                            KIO::Job* job = KIO::stat( m_dest, false, 2, false );
-                            state = STATE_STATING;
-                            destinationState = DEST_NOT_STATED;
-                            addSubjob(job);
-                            return;
-                        }
-                        case R_OVERWRITE:
-                            // Add to overwrite list
-                            // Note that we add dest, not m_dest.
-                            // This ensures that when moving several urls into a dir (m_dest),
-                            // we only overwrite for the current one, not for all.
-                            // When renaming a single file (m_asMethod), it makes no difference.
-                            kdDebug(7007) << "adding to overwrite list: " << dest.path() << endl;
-                            m_overwriteList.append( dest.path() );
-                            break;
-                        default:
-                            //assert( 0 );
-                            break;
-                    }
+                // we lack mtime info for both the src (not stated)
+                // and the dest (stated but this info wasn't stored)
+                // Let's do it for local files, at least
+                KIO::filesize_t sizeSrc = (KIO::filesize_t) -1;
+                KIO::filesize_t sizeDest = (KIO::filesize_t) -1;
+                time_t ctimeSrc = (time_t) -1;
+                time_t ctimeDest = (time_t) -1;
+                time_t mtimeSrc = (time_t) -1;
+                time_t mtimeDest = (time_t) -1;
+
+                KDE_struct_stat stat_buf;
+                if ( m_currentSrcURL.isLocalFile() &&
+                     KDE_stat(QFile::encodeName(m_currentSrcURL.path()), &stat_buf) == 0 ) {
+                    sizeSrc = stat_buf.st_size;
+                    ctimeSrc = stat_buf.st_ctime;
+                    mtimeSrc = stat_buf.st_mtime;
+                }
+                if ( dest.isLocalFile() &&
+                     KDE_stat(QFile::encodeName(dest.path()), &stat_buf) == 0 ) {
+                    sizeDest = stat_buf.st_size;
+                    ctimeDest = stat_buf.st_ctime;
+                    mtimeDest = stat_buf.st_mtime;
                 }
 
-                kdDebug(7007) << "Couldn't rename, reverting to normal way, starting with stat" << endl;
-                //kdDebug(7007) << "KIO::stat on " << m_currentSrcURL << endl;
-                KIO::Job* job = KIO::stat( m_currentSrcURL, true, 2, false );
-                state = STATE_STATING;
-                addSubjob(job);
-                m_bOnlyRenames = false;
-            }
-            else
-            {
-                //kdDebug(7007) << "Renaming succeeded, move on" << endl;
-                emit copyingDone( this, *m_currentStatSrc, dest, true, true );
-                statNextSrc();
+                RenameDlg_Result r = Observer::self()->open_RenameDlg(
+                    this,
+                    err == ERR_FILE_ALREADY_EXIST ? i18n("File Already Exists") : i18n("Already Exists as Folder"),
+                    m_currentSrcURL.prettyURL(0, KURL::StripFileProtocol),
+                    dest.prettyURL(0, KURL::StripFileProtocol),
+                    mode, newPath,
+                    sizeSrc, sizeDest,
+                    ctimeSrc, ctimeDest,
+                    mtimeSrc, mtimeDest );
+                if (m_reportTimer)
+                    m_reportTimer->start(REPORT_TIMEOUT,false);
+
+                switch ( r )
+                {
+                case R_CANCEL:
+                {
+                    m_error = ERR_USER_CANCELED;
+                    emitResult();
+                    return;
+                }
+                case R_RENAME:
+                {
+                    // Set m_dest to the chosen destination
+                    // This is only for this src url; the next one will revert to d->m_globalDest
+                    m_dest.setPath( newPath );
+                    KIO::Job* job = KIO::stat( m_dest, false, 2, false );
+                    state = STATE_STATING;
+                    destinationState = DEST_NOT_STATED;
+                    addSubjob(job);
+                    return;
+                }
+                case R_AUTO_SKIP:
+                    m_bAutoSkip = true;
+                    // fall through
+                case R_SKIP:
+                    // Move on to next file
+                    skipSrc();
+                    return;
+                case R_OVERWRITE_ALL:
+                    m_bOverwriteAll = true;
+                    break;
+                case R_OVERWRITE:
+                    // Add to overwrite list
+                    // Note that we add dest, not m_dest.
+                    // This ensures that when moving several urls into a dir (m_dest),
+                    // we only overwrite for the current one, not for all.
+                    // When renaming a single file (m_asMethod), it makes no difference.
+                    kdDebug(7007) << "adding to overwrite list: " << dest.path() << endl;
+                    m_overwriteList.append( dest.path() );
+                    break;
+                default:
+                    //assert( 0 );
+                    break;
+                }
             }
         }
+
+        kdDebug(7007) << "Couldn't rename, reverting to normal way, starting with stat" << endl;
+        //kdDebug(7007) << "KIO::stat on " << m_currentSrcURL << endl;
+        KIO::Job* job = KIO::stat( m_currentSrcURL, true, 2, false );
+        state = STATE_STATING;
+        addSubjob(job);
+        m_bOnlyRenames = false;
+    }
+    else
+    {
+        //kdDebug(7007) << "Renaming succeeded, move on" << endl;
+        emit copyingDone( this, *m_currentStatSrc, dest, true, true );
+        statNextSrc();
+    }
+}
+
+void CopyJob::slotResult( Job *job )
+{
+    //kdDebug(7007) << "CopyJob::slotResult() state=" << (int) state << endl;
+    // In each case, what we have to do is :
+    // 1 - check for errors and treat them
+    // 2 - subjobs.remove(job);
+    // 3 - decide what to do next
+
+    switch ( state ) {
+        case STATE_STATING: // We were trying to stat a src url or the dest
+            slotResultStating( job );
         break;
+        case STATE_RENAMING: // We were trying to do a direct renaming, before even stat'ing
+        {
+            slotResultRenaming( job );
+            break;
+        }
         case STATE_LISTING: // recursive listing finished
             //kdDebug(7007) << "totalSize: " << (unsigned int) m_totalSize << " files: " << files.count() << " dirs: " << dirs.count() << endl;
             // Was there an error ?
diff -urN -x CVS kdelibs.orig/kio/kio/job.h kdelibs/kio/kio/job.h
--- kdelibs.orig/kio/kio/job.h	Tue Jun 15 12:18:38 2004
+++ kdelibs/kio/kio/job.h	Tue Nov 23 11:02:17 2004
@@ -347,6 +347,7 @@
 
     /**
      * The same as the previous method, but recurses subdirectories.
+     * Directory links are not followed.
      *
      * "." and ".." are returned but only for the toplevel directory.
      * Filter them out if you don't want them.
diff -urN -x CVS kdelibs.orig/kio/kio/jobclasses.h kdelibs/kio/kio/jobclasses.h
--- kdelibs.orig/kio/kio/jobclasses.h	Tue May 25 17:49:18 2004
+++ kdelibs/kio/kio/jobclasses.h	Thu Oct 28 12:39:09 2004
@@ -1571,6 +1571,12 @@
         void slotResultDeletingDirs( KIO::Job * job );
         void deleteNextDir();
         void skip( const KURL & sourceURL );
+        void slotResultRenaming(  KIO::Job * job );
+    private:
+        void startRenameJob( const KURL &slave_url );
+        bool shouldOverwrite(  const QString& path ) const;
+        bool shouldSkip(  const QString& path ) const;
+        void skipSrc();
 
     protected slots:
         void slotStart();
diff -urN -x CVS kdelibs.orig/kio/kio/kmimetype.cpp kdelibs/kio/kio/kmimetype.cpp
--- kdelibs.orig/kio/kio/kmimetype.cpp	Mon Mar 29 11:43:34 2004
+++ kdelibs/kio/kio/kmimetype.cpp	Tue Oct 19 00:27:08 2004
@@ -16,7 +16,7 @@
  *  the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
  *  Boston, MA 02111-1307, USA.
  **/
-// $Id$
+// $Id$
 
 #include <config.h>
 
@@ -612,11 +612,21 @@
       dp = opendir( QFile::encodeName(_url.path()) );
       if ( dp )
       {
-        ep=readdir( dp );
-        ep=readdir( dp );      // ignore '.' and '..' dirent
+        QValueList<QCString> entries;
+        // Note that readdir isn't guaranteed to return "." and ".." first (#79826)
+        ep=readdir( dp ); if ( ep ) entries.append( ep->d_name );
+        ep=readdir( dp ); if ( ep ) entries.append( ep->d_name );
         if ( (ep=readdir( dp )) == 0L ) // third file is NULL entry -> empty directory
           isempty = true;
-        // if third file is .directory and no fourth file -> empty directory
+        else {
+          entries.append( ep->d_name );
+          if ( readdir( dp ) == 0 ) { // only three
+            // check if we got "." ".." and ".directory"
+            isempty = entries.find( "." ) != entries.end() &&
+                      entries.find( ".." ) != entries.end() &&
+                      entries.find( ".directory" ) != entries.end();
+          }
+        }
         if (!isempty && !strcmp(ep->d_name, ".directory"))
           isempty = (readdir(dp) == 0L);
         closedir( dp );
diff -urN -x CVS kdelibs.orig/kio/kio/slaveinterface.cpp kdelibs/kio/kio/slaveinterface.cpp
--- kdelibs.orig/kio/kio/slaveinterface.cpp	Sun Jun 27 12:43:57 2004
+++ kdelibs/kio/kio/slaveinterface.cpp	Tue Nov 23 13:26:25 2004
@@ -520,9 +520,12 @@
 
     emit needProgressId();
     kdDebug(7007) << "SlaveInterface::messageBox m_progressId=" << m_progressId << endl;
+    QGuardedPtr<SlaveInterface> me = this;
+    m_pConnection->suspend();
     int result = Observer::/*self()->*/messageBox( m_progressId, type, text, caption, buttonYes, buttonNo, dontAskAgainName );
-    if ( m_pConnection ) // Don't do anything if deleted meanwhile
+    if ( me && m_pConnection ) // Don't do anything if deleted meanwhile
     {
+        m_pConnection->resume();
         kdDebug(7007) << this << " SlaveInterface result=" << result << endl;
         stream << result;
         m_pConnection->sendnow( CMD_MESSAGEBOXANSWER, packedArgs );
diff -urN -x CVS kdelibs.orig/kio/kpasswdserver/kpasswdserver.cpp kdelibs/kio/kpasswdserver/kpasswdserver.cpp
--- kdelibs.orig/kio/kpasswdserver/kpasswdserver.cpp	Tue Oct 21 13:27:55 2003
+++ kdelibs/kio/kpasswdserver/kpasswdserver.cpp	Fri Nov 26 14:00:44 2004
@@ -20,7 +20,7 @@
 //----------------------------------------------------------------------------
 //
 // KDE Password Server
-// $Id$
+// $Id$
 
 #include <time.h>
 
@@ -274,8 +274,10 @@
                info.password = dlg.password();
                info.keepPassword = dlg.keepPassword();
 
-               // When the user checks "keep password", that means both in the cache (kpasswdserver process)
-               // and in the wallet, if enabled.
+               // When the user checks "keep password", that means:
+               // * if the wallet is enabled, store it there for long-term, and in kpasswdserver
+               // only for the duration of the window (#92928)
+               // * otherwise store in kpasswdserver for the duration of the KDE session.
                if ( info.keepPassword ) {
                    if ( !wallet )
                        wallet = KWallet::Wallet::openWallet(
@@ -292,6 +294,8 @@
                            map.insert( "login", info.username );
                            map.insert( "password", info.password );
                            wallet->writeMap( request->key, map );
+                           // password is in wallet, don't keep it in memory after window is closed
+                           info.keepPassword = false;
                        }
                    }
                }
@@ -386,8 +390,11 @@
 
 QString KPasswdServer::createCacheKey( const KIO::AuthInfo &info )
 {
-    if( !info.url.isValid() )
+    if( !info.url.isValid() ) {
+        // Note that a null key will break findAuthInfoItem later on...
+        kdWarning(130) << "createCacheKey: invalid URL " << info.url << endl;
         return QString::null;
+    }
 
     // Generate the basic key sequence.
     QString key = info.url.protocol();
diff -urN -x CVS kdelibs.orig/kio/kpasswdserver.desktop kdelibs/kio/kpasswdserver.desktop
--- kdelibs.orig/kio/kpasswdserver.desktop	Mon Oct  4 15:25:07 2004
+++ kdelibs/kio/kpasswdserver.desktop	Fri Nov 12 08:27:52 2004
@@ -2,7 +2,7 @@
 Encoding=UTF-8
 Type=Service
 Name=KDED Password Module
-Name[af]=Kded Wagwoord Module
+Name[af]=KDED Wagwoord Module
 Name[ar]=وحدة كلمة سر KDED
 Name[az]=KDED Şifrə Modulu
 Name[be]=Модуль пароляў KDED
@@ -34,11 +34,12 @@
 Name[ja]=KDED パスワードモジュール
 Name[ko]=KDED 열쇠글 모듈
 Name[lt]=KDED slaptažodžių modulis
+Name[mk]=KDED модул за лозинка
 Name[mn]=KDED-Тест модул
 Name[ms]=Modul Kata laluan KDED
 Name[mt]=Modulu tal-passwords KDED
 Name[nb]=KDED Passordmodul
-Name[nds]=KDED Passwoordmodul
+Name[nds]=KDED-Passwoortmoduul
 Name[nl]=KDED-wachtwoordmodule
 Name[nn]=KDED-passordmodul
 Name[nso]=Seripa sa Lentsuphetiso la KDED
@@ -67,6 +68,7 @@
 Name[zh_TW]=KDED 密碼模組
 Name[zu]=Ingxenye Yegama lokudlula le-KDED
 Comment=Password caching support
+Comment[af]=Wagwoord Kasberging ondersteuning
 Comment[bg]=Кеширане на пароли
 Comment[bn]=পাসওয়ার্ড ক্যাশ-এ রাখা সমর্থন করে
 Comment[bs]=Podrška za keširanje šifre
@@ -83,7 +85,10 @@
 Comment[is]=Skyndiminni fyrir lykilorð
 Comment[it]=Supporto per la memorizzazione temporanea delle password
 Comment[ja]=パスワードキャッシュサポート
+Comment[lt]=Slaptažodžių krepšio palaikymas
+Comment[mk]=Поддршка за кеширање на лозинки
 Comment[nb]=Støtte for passordlagring
+Comment[nds]=Ünnerstütten för't Twischenspiekern vun Passwöör
 Comment[nl]=Ondersteuning voor het tussentijds bewaren van wachtwoorden
 Comment[nn]=Støtte for passordlagring
 Comment[pa]=ਗੁਪਤ-ਕੋਡ ਕੈਚੇਇੰਗ ਸਹਾਇਤਾ
@@ -91,6 +96,7 @@
 Comment[pt]=Suporte a 'cache' de senhas
 Comment[pt_BR]=Suporte de cache das senhas
 Comment[ro]=Suport pentru memorarea parolelor
+Comment[ru]=Поддержка кэширования паролей
 Comment[se]=Beassansáni gaskarádjama doarjja
 Comment[sk]=Podpora ukladania hesiel
 Comment[sl]=Podpora prepomnjenju gesel
@@ -100,6 +106,7 @@
 Comment[ta]=கடவுச்சொல் சேமிக்க ஆதரவு
 Comment[tg]=Дастгирии Ҳофизаи Гузарвожа
 Comment[uk]=Підтримка кешування паролів
+Comment[uz]=Махфий сўзларни кэшда сақлаш
 Comment[zh_CN]=密码缓存支持
 ServiceTypes=KDEDModule
 X-KDE-ModuleType=Library
diff -urN -x CVS kdelibs.orig/kio/kscan.desktop kdelibs/kio/kscan.desktop
--- kdelibs.orig/kio/kscan.desktop	Tue Aug 24 08:29:24 2004
+++ kdelibs/kio/kscan.desktop	Sun Oct 24 09:01:56 2004
@@ -3,7 +3,6 @@
 Type=ServiceType
 X-KDE-ServiceType=KScan/KScanDialog
 Name=KScan
-Name[af]=Kskandeer
 Name[bn]=কে-স্ক্যান
 Name[cy]=KSgan
 Name[eo]=Bildciferecigo
diff -urN -x CVS kdelibs.orig/kio/kurifilterplugin.desktop kdelibs/kio/kurifilterplugin.desktop
--- kdelibs.orig/kio/kurifilterplugin.desktop	Mon Oct  4 15:25:07 2004
+++ kdelibs/kio/kurifilterplugin.desktop	Sat Oct 30 08:38:13 2004
@@ -3,7 +3,7 @@
 Type=ServiceType
 X-KDE-ServiceType=KURIFilter/Plugin
 Name=Enhanced Browsing Plugin
-Name[af]=Verbeterde Blaaiïng Inplak
+Name[af]=Verbeterde Blaaiïng Inprop module
 Name[ar]=ملحقات التصفح المحسن
 Name[az]=Təkmilləşmiş Səyyah Əlavəsi
 Name[bg]=Разширена приставка за преглед
@@ -35,11 +35,11 @@
 Name[ko]=더 나은 찾아가기 플러그인
 Name[lt]=Išplėstinio naršymo priedas
 Name[lv]=Uzlabotas Pārlūkošanas Iespraudnis
-Name[mk]=Плагин за напредно разгледување
 Name[mn]=Өргөтгөсөн Хөтлөгчийн Plugin
 Name[ms]=Plug masuk Pelayar Ekstra
 Name[mt]=Plagin għal browsing estiż
 Name[nb]=Programtillegg for utvidet nettlesing
+Name[nds]=Verwiedert Stövern
 Name[nl]=Verbeterd Browsen Plugin
 Name[nn]=Programtillegg for forbetring av nettlesaren
 Name[nso]=Tsenyo yeo e Hlohleleditswego ya Boinyakisi
diff -urN -x CVS kdelibs.orig/kio/misc/kio_uiserver.desktop kdelibs/kio/misc/kio_uiserver.desktop
--- kdelibs.orig/kio/misc/kio_uiserver.desktop	Tue Aug 31 09:21:29 2004
+++ kdelibs/kio/misc/kio_uiserver.desktop	Sat Oct 30 08:38:14 2004
@@ -5,6 +5,7 @@
 Name[de]=Server der graphischen Oberfläche
 Name[ja]=kio_uiサーバ
 Name[mn]=График гадаргуугийн сервер
+Name[nds]=Server för de graafsche Böversiet
 Name[nl]=Kio_uiserver
 Name[nso]=kio_uiseabi
 Name[ro]=Kio_uiserver
@@ -12,6 +13,7 @@
 Name[ta]=kio_uiசேவையகம்
 Exec=kio_uiserver
 Comment=KDE's Progress Info UI server
+Comment[af]=KDE se vordering inligting UI bediener
 Comment[ar]=خادم معلومات تقدم واجهة كيدي
 Comment[az]=KDE'nin İrəliləmə Bilgisi İstifadaçi Ara Üz Vericisi
 Comment[bg]=Сървър за отчитане на прогреса (KDE's Progress Info UI server)
@@ -42,11 +44,12 @@
 Comment[ko]=KDE에서 보다 발전된 정보 UI 서버
 Comment[lt]=KDE eigos informacijos UI serveris
 Comment[lv]=KDE Progresa Info UI serveris
-Comment[mk]=KDE опслужувач за информации за прогресот
+Comment[mk]=KDE сервер за информации за прогресот
 Comment[mn]=Прогресс мэдээллээр дүрслэгдсэн хэрэглэгчийн харьцах хэсгийн сервер
 Comment[ms]=Pelayan Info UI KDE
 Comment[mt]=Server tal-progress tal-UI KDE
 Comment[nb]=KDE UI-tjener for framgangsinfo
+Comment[nds]=Server för graafsche Vörankamen-Informatschonen
 Comment[nl]=KDE's server voor informatie over de voortgang.
 Comment[nn]=KDE UI-tenar for framgangsinfo
 Comment[nso]=Seabi sa UI ya Tshedimoso ya Tswelopele ya KDE
diff -urN -x CVS kdelibs.orig/kio/misc/kpac/eventsrc kdelibs/kio/misc/kpac/eventsrc
--- kdelibs.orig/kio/misc/kpac/eventsrc	Tue Aug 31 09:21:30 2004
+++ kdelibs/kio/misc/kpac/eventsrc	Mon Nov 15 08:54:58 2004
@@ -1,6 +1,8 @@
 [!Global!]
 IconName=proxy
 Comment=Automatic Proxy Configuration
+Comment[af]=Outomatiese Proksie Opstelling
+Comment[ar]=تهيئة آلية للخادم الوكيل
 Comment[az]=Avtomatik Vəkil Quraşdırılması
 Comment[bg]=Автоматично конфигуриране на прокси сървъра
 Comment[bn]=স্বয়ংক্রিয় প্রক্সি কনফিগারেশন
@@ -26,9 +28,10 @@
 Comment[id]=Konfigurasi Proxi Otomatis
 Comment[is]=Sjálfvirkar stillingar vefsels
 Comment[it]=Configurazione automatica proxy
-Comment[ja]=自動プロキシー設定
+Comment[ja]=自動プロキシ設定
 Comment[ko]=스스로 프록시 설정
 Comment[lt]=Automatinis proxy derinimas
+Comment[mk]=Автоматска конфигурација на прокси
 Comment[mn]=Автомат итгэмжилэгчийн тохиргоо
 Comment[ms]=Penyelarasan Proksi Automatik
 Comment[nb]=Automatisk mellomtjenerinstilling
@@ -59,6 +62,8 @@
 
 [script-error]
 Name=Invalid proxy script
+Name[af]=Ongeldige proksie skrip
+Name[ar]=نص برمجي غير صالح
 Name[az]=Hökmsüz vəkil skripti
 Name[bg]=Невалиден скрипт за прокси сървъра
 Name[bn]=অবৈধ প্রক্সি স্ক্রিপ্ট
@@ -84,12 +89,14 @@
 Name[id]=Skrip proxi tidak sah
 Name[is]=Ógild selskrifta
 Name[it]=Script proxy non valido
-Name[ja]=無効なプロキシースクリプト
+Name[ja]=無効なプロキシスクリプト
 Name[ko]=올바르지 않은 프록시 스크립트
 Name[lt]=Blogas proxy skriptas
+Name[mk]=Невалидна прокси скрипта
 Name[mn]=Хүчингүй итгэмжилэгч скрипт
 Name[ms]=Skrip proksi tidak sah
 Name[nb]=Ugyldig mellomtjenerskript
+Name[nds]=Proxy-Skript löppt nich
 Name[nl]=Ongeldig proxyscript
 Name[nn]=Ugyldig mellomtenarskript
 Name[pa]=ਗਲਤ ਪਰਾਕਸੀ ਸਕ੍ਰਿਪਟ
@@ -113,6 +120,8 @@
 Name[zh_CN]=无效的代理脚本
 Name[zh_TW]=不合法 proxy 命令稿檔案
 Comment=The downloaded proxy configuration script is invalid
+Comment[af]=Die proksie skipt wat afgelaai was is foutief.
+Comment[ar]=النص البرمجي الذي تم تنزيله غير صالح
 Comment[az]=Endirilən vəkil quraşdırma skripti kökmsüzdür
 Comment[bg]=Изтегленият скрипт за конфигуриране на прокси сървъра е невалиден
 Comment[bn]=ডাউনলোড করা প্রক্সি কনফিগারেশন স্ক্রিপ্টটি অবৈধ
@@ -137,13 +146,14 @@
 Comment[hu]=A letöltött proxybeállító szkript érvénytelen
 Comment[is]=Sótt stillingaforrit sels er ógilt
 Comment[it]=Lo script di configurazione proxy scaricato non è valido
-Comment[ja]=ダウンロードされたプロキシー設定スクリプトは無効です。
+Comment[ja]=ダウンロードされたプロキシ設定スクリプトは無効です。
 Comment[ko]=내려받은 프록시 설정 스크립트가 올바르지 않습니다.
 Comment[lt]=Atsisiųstas proxy derinimo skriptas yra blogas
+Comment[mk]=Симнатата скрипта за конфигурација на прокси е навалидна
 Comment[mn]=Татагдсан итгэмжилэгч тохируулгын скрипт хүчингүй
 Comment[ms]=Skrip penyelarasan proksi yang dimuat turun tidak sah
 Comment[nb]=Det nedlastede skriptet for mellomtjener-innstillinger er ugyldig
-Comment[nds]=Dat weer keen Skript för't Instellen vun de Proxy
+Comment[nds]=Dat weer keen Skript för't Instellen vun den Proxy
 Comment[nl]=Het opgehaalde proxyconfiguratiescript is ongeldig
 Comment[nn]=Det nedlasta skriptet for mellomtenaroppsett er ugyldig
 Comment[pa]=ਡਾਊਨਲੋਡ ਪਰਾਕਸੀ ਸੰਰਚਨਾ ਸਕ੍ਰਿਪਟ ਜਾਇਜ਼ ਨਹੀਂ ਹੈ
@@ -170,6 +180,8 @@
 
 [download-error]
 Name=Script download error
+Name[af]=Skrip aflaai fout
+Name[ar]=خطأ أثناء تنزيل النص البرمجي
 Name[az]=Skript endirmə xətası
 Name[bg]=Грешка при изтегляне на скрипта
 Name[bn]=স্ক্রিপ্ট ডাউনলোডে সমস্যা
@@ -198,10 +210,11 @@
 Name[ja]=スクリプトダウンロード エラー
 Name[ko]=스크립트 내려받기 오류
 Name[lt]=Skripto atsisiuntimo klaida
+Name[mk]=Грешка при симнување на скрипта
 Name[mn]=Скрипт татахад алдаа
 Name[ms]=Ralat muat turun skrip 
 Name[nb]=Skript nedlastingsfeil
-Name[nds]=Fehler bi't runnerladen vun'n Skript
+Name[nds]=Fehler bi't daalladen vun'n Skript
 Name[nl]=Fout bij downloaden van script
 Name[nn]=Feil ved skriptnedlasting
 Name[pa]=ਸਕ੍ਰਿਪਟ ਡਾਊਨਲੋਡ ਗਲਤੀ
@@ -225,6 +238,8 @@
 Name[zh_CN]=脚本下载错误
 Name[zh_TW]=Script 下載錯誤
 Comment=The proxy configuration script could not be downloaded
+Comment[af]=Die proksie opstelling skrip kon nie afgelaai word nie
+Comment[ar]=تعذر تنزيل النص البرمجي لإعداد الخادم الوكيل
 Comment[az]=VƏkil qurğuları skripti endirilə bilmədi
 Comment[bg]=Скриптът за конфигуриране на прокси сървъра не може да бъде изтеглен
 Comment[bn]=প্রক্সি কনফিগারেশন স্ক্রিপ্ট ডাউনলোড করা যায়নি
@@ -249,13 +264,14 @@
 Comment[hu]=A proxybeállító szkript letöltése nem sikerült
 Comment[is]=Gat ekki sótt stillingaforrit sels
 Comment[it]=Impossibile scaricare lo script di configurazione proxy
-Comment[ja]=プロキシー設定スクリプトをダウンロードすることができないかもしれません。
+Comment[ja]=プロキシ設定スクリプトをダウンロードすることができないかもしれません。
 Comment[ko]=프록시 설정 스크립트를 내려받지 못합니다
 Comment[lt]=Proxy derinimo skriptas negali būti atsisiųstas
+Comment[mk]=Скриптата за конфигурација на прокси не можеше да се симне
 Comment[mn]=Итгэмжилэгч тохиргооны скрипт татагдахгүй байна
 Comment[ms]=Skrip penyelarasan proksi tidak boleh dimuat turun
 Comment[nb]=Klarte ikke å laste ned skiptet for mellomtjener-innstillinger
-Comment[nds]=Dat Skript för't Instellen vun de Proxy laat sik nich runnerladen
+Comment[nds]=Dat Skript för't Instellen vun den Proxy laat sik nich daalladen
 Comment[nl]=Het proxyconfiguratiescript kon niet worden opgehaald
 Comment[nn]=Klarte ikkje lasta ned skript for mellomtenaroppsett
 Comment[pa]=ਪਰਾਕਸੀ ਸੰਰਚਨਾ ਸਕ੍ਰਿਪਟ ਨੂੰ ਲੋਡ ਨਹੀਂ ਕੀਤਾ ਜਾ ਸਕਦਾ ਹੈ
@@ -282,6 +298,8 @@
 
 [evaluation-error]
 Name=Script evaluation error
+Name[af]=Skrip evaluasie fout
+Name[ar]=خطأ في تقييم النص البرمجي
 Name[az]=Skript icra xətası
 Name[bg]=Грешка при обработка на скрипта
 Name[bn]=স্ক্রিপ্ট চালানোয় সমস্যা
@@ -310,10 +328,11 @@
 Name[ja]=スクリプト評価エラー
 Name[ko]=스크립트 평가 오류
 Name[lt]=Skripto analizės klaida
+Name[mk]=Грешка при евалуација на скрипта
 Name[mn]=Скрипт үнэлэхэд алдаа
 Name[ms]=Ralat penilaian skrip
 Name[nb]=Skript evalueringsfeil
-Name[nds]=Fehler bi't utföhren vun'n Skript
+Name[nds]=Fehler bi't Pröven vun'n Skript
 Name[nl]=Fout bij evalueren van script
 Name[nn]=Feil ved skriptevaluering
 Name[pa]=ਸਕ੍ਰਿਪਟ ਏਵੂਲੇਸ਼ਨ ਗਲਤੀ
@@ -336,6 +355,7 @@
 Name[zh_CN]=脚本求值错误
 Name[zh_TW]=Script 執行錯誤
 Comment=There was an error executing the proxy configuration script
+Comment[af]=Daar was 'n fout met die uitvoer van die proksie opstell skrip
 Comment[ar]=لقد حصل خطأ كبير أدى الى خروج البرنامج
 Comment[az]=Vəkil qurğuları skripti işə salınırkən xəta baş verdi
 Comment[bg]=Грешка по време на изпълнение на скрипта за конфигуриране на прокси сървъра
@@ -361,13 +381,14 @@
 Comment[hu]=Hiba történt a proxybeállító szkript végrehajtása közben
 Comment[is]=Það kom upp villa við keyrslu stillingaforrits sels
 Comment[it]=Si è verificato un errore durante l'esecuzione dello script di configurazione proxy
-Comment[ja]=プロキシー設定スクリプトを実行中エラーがありました
+Comment[ja]=プロキシ設定スクリプトを実行中エラーがありました
 Comment[ko]=프록시 설정 스크리트를 실행하는데 문제가 있습니다
 Comment[lt]=Paleidžiant proxy derinimo skriptą įvyko klaida
+Comment[mk]=Имаше грешка при извршувањето на скриптата за конфигурација на прокси
 Comment[mn]=итгэмжилэгч тохируулгын скрипт ажиллуулж байхад алдаа
 Comment[ms]=Terdapat ralat melaksanakan skrip penyelarasan proksi
 Comment[nb]=Det oppsto en alvorlig feil under kjøringen av skriptet for mellomtjener-innstillinger
-Comment[nds]=Dor weer'n Fehler bi't Utföhren vun dat Skript för't Instellen vun de Proxy
+Comment[nds]=Bi't Utföhren vun dat Proxy-Instellenskript hett dat'n Fehler geven
 Comment[nl]=Er deed zich een fout voor tijdens het uitvoeren van het proxyconfiguratiescript
 Comment[nn]=Feil ved køyring av skript for mellomtenaroppsett
 Comment[pa]=ਪਰਾਕਸੀ ਸੰਰਚਨਾ ਸਕ੍ਰਿਪਟ ਚਲਾਉਣ ਵਿੱਚ ਗਲਤੀ ਆਈ ਹੈ
diff -urN -x CVS kdelibs.orig/kio/misc/kpac/proxyscout.desktop kdelibs/kio/misc/kpac/proxyscout.desktop
--- kdelibs.orig/kio/misc/kpac/proxyscout.desktop	Mon Oct  4 15:25:08 2004
+++ kdelibs/kio/misc/kpac/proxyscout.desktop	Mon Nov 15 08:54:58 2004
@@ -2,6 +2,7 @@
 Encoding=UTF-8
 Type=Service
 Name=Proxy Scout
+Name[af]=Proksie Verkenner
 Name[az]=Vəkil Skout
 Name[bg]=Проучване на прокси сървъри
 Name[bn]=প্রক্সি স্কাউট
@@ -38,6 +39,7 @@
 Name[uz]=Прокси скаут
 Name[zh_CN]=代理搜索
 Comment=Automatic proxy configuration
+Comment[af]=Outomatiese proksie opstelling
 Comment[bg]=Автоматично конфигуриране на прокси сървъра
 Comment[bn]=স্বয়ংক্রিয় প্রক্সি কনফিগারেশন
 Comment[bs]=Automatsko podešavanje proxy-ja
@@ -53,8 +55,11 @@
 Comment[hu]=Automatikus proxybeállítás
 Comment[is]=Sjálfvirkar stillingar vefsels
 Comment[it]=Configurazione automatica proxy
-Comment[ja]=自動プロキシー設定
+Comment[ja]=自動プロキシ設定
+Comment[lt]=Automatinis proxy derinimas
+Comment[mk]=Автоматска конфигурација на прокси
 Comment[nb]=Automatisk mellomtjeneroppsett
+Comment[nds]=Proxy automaatsch instellen
 Comment[nl]=Automatische proxyconfiguratie
 Comment[nn]=Automatisk mellomtenaroppsett
 Comment[pa]=ਸਵੈ-ਚਾਲਿਤ ਪਰਾਕਸੀ ਸੰਰਚਨਾ
@@ -62,6 +67,7 @@
 Comment[pt]=Configuração automática de 'proxy'
 Comment[pt_BR]=Configuração automática do proxy
 Comment[ro]=Configurare automată pentru proxy
+Comment[ru]=Автонастройка прокси
 Comment[se]=Automáhtalaš gaskabálváheiveheapmi
 Comment[sk]=Automatická konfigurácia proxy
 Comment[sl]=Samodejne nastavitve posrednika
@@ -71,6 +77,7 @@
 Comment[ta]=தானியக்க பதிலாள் வடிவமைப்பு
 Comment[tg]=Танзими прокси бо автоматикӣ
 Comment[uk]=Автоматичне визначення проксі сервера
+Comment[uz]=Проксини автоматик равишда мослаш
 Comment[zh_CN]=自动代理配置
 ServiceTypes=KDEDModule
 X-KDE-ModuleType=Library
diff -urN -x CVS kdelibs.orig/kio/misc/kssld/kssld.desktop kdelibs/kio/misc/kssld/kssld.desktop
--- kdelibs.orig/kio/misc/kssld/kssld.desktop	Mon Oct  4 15:25:08 2004
+++ kdelibs/kio/misc/kssld/kssld.desktop	Fri Nov 12 08:27:52 2004
@@ -42,7 +42,7 @@
 Name[ms]=Modul Daemon KSSL
 Name[mt]=Modulu daemon KSSL
 Name[nb]=KSSL nisse-modul
-Name[nds]=KSSL Daemon Modul
+Name[nds]=KSSL-Dämoon-Moduul
 Name[nl]=KSSL daemon-module
 Name[nn]=KSSL-nissemodul
 Name[nso]=Seripa sa Daemon ya KSSL
@@ -71,6 +71,7 @@
 Name[zh_TW]=KSSL 伺服程式模組
 Name[zu]=Ingxenye ye-daemon ye-KSSL
 Comment=KSSL daemon module for KDED
+Comment[af]=KSSL bediener module vir KDED
 Comment[bg]=Модул демон за KSSL за KDED
 Comment[bn]=KDED-র জন্য KSSL ডিমন মডিউল 
 Comment[bs]=KSSL Daemon Module za KDED
@@ -87,7 +88,10 @@
 Comment[is]=KSSL þjónseining fyrir KDED
 Comment[it]=Modulo demone KSSL per KDED
 Comment[ja]=KDED用のKSSLデーモンモジュール
+Comment[lt]=KSSL tarnybos modulis, skirtas KDED
+Comment[mk]=KSSL даемон модул за KDED
 Comment[nb]=KSSL nissemodul for KDED
+Comment[nds]=KSSL-Dämoon för KDED
 Comment[nl]=KSSL daemon-module voor KDED
 Comment[nn]=KSSL-nissemodul for KDED
 Comment[pa]=KDED ਲਈ KSSL ਪੇਸ਼ਕਾਰੀ
@@ -95,6 +99,7 @@
 Comment[pt]=Módulo servidor de KSSL para o KDED
 Comment[pt_BR]=Módulo de serviço KSSL para o KDE
 Comment[ro]=Modul demon KSSL pentru KDED
+Comment[ru]=Модуль демона KSSL для KDED
 Comment[se]=KDED:a KSSL-bálvámoduvla
 Comment[sk]=Modul démona KSSL pre KDED
 Comment[sl]=Strežniški modul KSSL za KDED
@@ -104,4 +109,5 @@
 Comment[ta]=KDEDக்கான KSSL டெமான் பகுதி
 Comment[tg]=Модули Демон KSSL брои KDED
 Comment[uk]=Модуль демону KSSL для KDED
+Comment[uz]=KDED учун KSSL хизматининг модули
 Comment[zh_CN]=KDED 的 KSSL 守护进程模块
diff -urN -x CVS kdelibs.orig/kio/misc/kwalletd/kwalletd.cpp kdelibs/kio/misc/kwalletd/kwalletd.cpp
--- kdelibs.orig/kio/misc/kwalletd/kwalletd.cpp	Wed Jul  7 16:16:00 2004
+++ kdelibs/kio/misc/kwalletd/kwalletd.cpp	Fri Nov 12 22:00:34 2004
@@ -1,7 +1,7 @@
 /*
    This file is part of the KDE libraries
 
-   Copyright (c) 2002-2003 George Staikos <staikos@kde.org>
+   Copyright (c) 2002-2004 George Staikos <staikos@kde.org>
 
    This library is free software; you can redistribute it and/or
    modify it under the terms of the GNU Library General Public
@@ -71,7 +71,7 @@
 		DCOPClient *client;
 		DCOPClientTransaction *transaction;
 		Type tType;
-		QCString returnObject;
+		QCString rawappid, returnObject;
 		QCString appid;
 		uint wId;
 		QString wallet;
@@ -81,6 +81,7 @@
 KWalletD::KWalletD(const QCString &name)
 : KDEDModule(name), _failed(0) {
 	srand(time(0));
+	_showingFailureNotify = false;
 	_transactions.setAutoDelete(true);
 	_timeouts = new KTimeout(17);
 	_closeIdle = false;
@@ -109,61 +110,119 @@
 
 
 int KWalletD::generateHandle() {
-int rc;
+	int rc;
 
 	// ASSUMPTION: RAND_MAX is fairly large.
 	do {
 		rc = rand();
-	} while (_wallets.find(rc));
+	} while (_wallets.find(rc) || rc == 0);
 
-return rc;
+	return rc;
 }
 
 
 void KWalletD::processTransactions() {
+	static bool processing = false;
+
+	if (processing) {
+		return;
+	}
+
+	processing = true;
+
 	// Process remaining transactions
-	for (KWalletTransaction *xact = _transactions.first(); xact; /**/) {
+	KWalletTransaction *xact;
+	while (!_transactions.isEmpty()) {
+		xact = _transactions.first();
 		QCString replyType;
 		int res;
 
 		assert(xact->tType != KWalletTransaction::Unknown);
 
 		switch (xact->tType) {
-		case KWalletTransaction::Open:
-			res = doTransactionOpen(xact->appid, xact->wallet, xact->wId);
-			replyType = "int";
-			break;
-		case KWalletTransaction::OpenFail:
-			res = -1;
-			replyType = "int";
-			break;
-		case KWalletTransaction::ChangePassword:
-			doTransactionChangePassword(xact->appid, xact->wallet, xact->wId);
-			// fall through - no return
-		default:
-			KWalletTransaction *tmp = xact;
-			xact = _transactions.next();
-			_transactions.removeRef(tmp);
-			continue;
-		}
-
-		QByteArray replyData;
-		QDataStream stream(replyData, IO_WriteOnly);
-		stream << res;
-		xact->client->endTransaction(xact->transaction, replyType, replyData);
-		KWalletTransaction *tmp = xact;
-		xact = _transactions.next();
-		_transactions.removeRef(tmp);
+			case KWalletTransaction::Open:
+				res = doTransactionOpen(xact->appid, xact->wallet, xact->wId);
+				replyType = "int";
+				if (!xact->returnObject.isEmpty()) {
+					DCOPRef(xact->rawappid, xact->returnObject).send("walletOpenResult", res);
+				}
+
+				// multiple requests from the same client
+				// should not produce multiple password
+				// dialogs on a failure
+				if (res < 0) {
+					QPtrListIterator<KWalletTransaction> it(_transactions);
+					KWalletTransaction *x;
+					while ((x = it.current()) && x != xact) {
+						++it;
+					}
+					if (x) {
+						++it;
+					}
+					while ((x = it.current())) {
+						if (xact->appid == x->appid && x->tType == KWalletTransaction::Open && x->wallet == xact->wallet && x->wId == xact->wId)
+							x->tType = KWalletTransaction::OpenFail;
+					}
+				}
+				break;
+			case KWalletTransaction::OpenFail:
+				res = -1;
+				replyType = "int";
+				if (!xact->returnObject.isEmpty()) {
+					DCOPRef(xact->rawappid, xact->returnObject).send("walletOpenResult", res);
+				}
+				break;
+			case KWalletTransaction::ChangePassword:
+				doTransactionChangePassword(xact->appid, xact->wallet, xact->wId);
+				// fall through - no return
+			default:
+				_transactions.removeRef(xact);
+				continue;
+		}
+
+		if (xact->returnObject.isEmpty() && xact->tType != KWalletTransaction::ChangePassword) {
+			QByteArray replyData;
+			QDataStream stream(replyData, IO_WriteOnly);
+			stream << res;
+			xact->client->endTransaction(xact->transaction, replyType, replyData);
+		}
+		_transactions.removeRef(xact);
 	}
+
+	processing = false;
 }
 
+
 void KWalletD::openAsynchronous(const QString& wallet, const QCString& returnObject, uint wId) {
 	DCOPClient *dc = callingDcopClient();
-	if (!dc) return;
+	if (!dc) {
+		return;
+	}
+
 	QCString appid = dc->senderId();
+	if (!_enabled ||
+		!QRegExp("^[A-Za-z0-9]+[A-Za-z0-9\\s\\-_]*$").exactMatch(wallet)) {
+		DCOPRef(appid, returnObject).send("walletOpenResult", -1);
+		return;
+	}
+
+	QCString peerName = friendlyDCOPPeerName();
+
+	KWalletTransaction *xact = new KWalletTransaction;
+
+	xact->appid = peerName;
+	xact->rawappid = appid;
+	xact->client = callingDcopClient();
+	xact->wallet = wallet;
+	xact->wId = wId;
+	xact->tType = KWalletTransaction::Open;
+	xact->returnObject = returnObject;
+	_transactions.append(xact);
 
-	int rc = open(wallet, wId);
-	DCOPRef(appid, returnObject).send("walletOpenResult", rc);
+	kdDebug() << "OpenAsynch " << peerName << " " << wallet << endl;
+	DCOPRef(appid, returnObject).send("walletOpenResult", 0);
+
+	QTimer::singleShot(0, this, SLOT(processTransactions()));
 }
 
 
@@ -173,7 +232,8 @@
 	}
 
 	// FIXME: setup transaction
-	return internalOpen(friendlyDCOPPeerName(), path, true, wId);
+	int rc = internalOpen(friendlyDCOPPeerName(), path, true, wId);
+	return rc;
 }
 
 
@@ -263,7 +323,8 @@
 		cfg.sync();
 	}
 
-	return internalOpen(appid, wallet, false, wId);
+	int rc = internalOpen(appid, wallet, false, wId);
+	return rc;
 }
 
 
@@ -271,6 +332,7 @@
 	int rc = -1;
 	bool brandNew = false;
 
+	kdDebug() << "Internal Open " << appid << " " << wallet << endl;
 	for (QIntDictIterator<KWallet::Backend> i(_wallets); i.current(); ++i) {
 		if (i.current()->walletName() == wallet) {
 			rc = i.currentKey();
@@ -286,7 +348,7 @@
 
 		KWallet::Backend *b = new KWallet::Backend(wallet, isPath);
 		KPasswordDialog *kpd;
-		if ((isPath || QFile::exists(wallet)) || KWallet::Backend::exists(wallet)) {
+		if ((isPath && QFile::exists(wallet)) || (!isPath && KWallet::Backend::exists(wallet))) {
 			kpd = new KPasswordDialog(KPasswordDialog::Password, false, 0);
 			if (appid.isEmpty()) {
 				kpd->setPrompt(i18n("<qt>KDE has requested to open the wallet '<b>%1</b>'. Please enter the password for this wallet below.").arg(QStyleSheet::escape(wallet)));
@@ -322,6 +384,7 @@
 		while (!b->isOpen()) {
 			XSetTransientForHint(qt_xdisplay(), kpd->winId(), w);
 			KWin::setState( kpd->winId(), NET::KeepAbove );
+			KWin::setOnAllDesktops(kpd->winId(), true);
 			if (kpd->exec() == KDialog::Accepted) {
 				p = kpd->password();
 				int rc = b->open(QByteArray().duplicate(p, strlen(p)));
@@ -367,7 +430,12 @@
 	} else {
 		int response = KMessageBox::Yes;
 
-		if (_openPrompt && !_handles[appid].contains(rc) && !implicitAllow(wallet, appid)) {
+		QCString thisApp = appid;
+		if (thisApp.isEmpty()) {
+			thisApp = "KDE System";
+		}
+
+		if (_openPrompt && !_handles[appid].contains(rc) && !implicitAllow(wallet, thisApp)) {
 			if (appid.isEmpty()) {
 				response = KMessageBox::questionYesNoCancel(0L, i18n("<qt>KDE has requested access to the open wallet '<b>%1</b>'.").arg(QStyleSheet::escape(wallet)),
                                                             i18n("KDE Wallet Service"), i18n("Allow &Once"), i18n("Allow &Always"));
@@ -383,9 +451,13 @@
 				KConfig cfg("kwalletrc");
 				cfg.setGroup("Auto Allow");
 				QStringList apps = cfg.readListEntry(wallet);
-				if (!apps.contains(appid)) {
-					apps += appid;
-					_implicitAllowMap[wallet] += appid;
+				QCString thisApp = appid;
+				if (thisApp.isEmpty()) {
+					thisApp = "KDE System";
+				}
+				if (!apps.contains(thisApp)) {
+					apps += thisApp;
+					_implicitAllowMap[wallet] += thisApp;
 					cfg.writeEntry(wallet, apps);
 					cfg.sync();
 				}
@@ -395,7 +467,7 @@
 		}
 	}
 
-return rc;
+	return rc;
 }
 
 
@@ -412,7 +484,7 @@
 		return 0;
 	}
 
-return -1;
+	return -1;
 }
 
 
@@ -420,31 +492,24 @@
 	QCString appid = friendlyDCOPPeerName();
 
 	KWalletTransaction *xact = new KWalletTransaction;
-	_transactions.append(xact);
 
-	if (_transactions.count() > 1) {
-		xact->appid = appid;
-		xact->client = callingDcopClient();
-		xact->transaction = xact->client->beginTransaction();
-		xact->wallet = wallet;
-		xact->wId = wId;
-		xact->tType = KWalletTransaction::ChangePassword;
-		return; // process later
-	}
+	xact->appid = appid;
+	xact->client = callingDcopClient();
+	xact->wallet = wallet;
+	xact->wId = wId;
+	xact->tType = KWalletTransaction::ChangePassword;
 
-	doTransactionChangePassword(appid, wallet, wId);
-
-	_transactions.remove(xact);
+	_transactions.append(xact);
 
-	processTransactions();
+	QTimer::singleShot(0, this, SLOT(processTransactions()));
 }
 
 
 void KWalletD::doTransactionChangePassword(const QCString& appid, const QString& wallet, uint wId) {
-QIntDictIterator<KWallet::Backend> it(_wallets);
-KWallet::Backend *w = 0L;
-int handle = -1;
-bool reclose = false;
+	QIntDictIterator<KWallet::Backend> it(_wallets);
+	KWallet::Backend *w = 0L;
+	int handle = -1;
+	bool reclose = false;
 
 	for (; it.current(); ++it) {
 		if (it.current()->walletName() == wallet) {
@@ -502,8 +567,8 @@
 
 
 int KWalletD::close(const QString& wallet, bool force) {
-int handle = -1;
-KWallet::Backend *w = 0L;
+	int handle = -1;
+	KWallet::Backend *w = 0L;
 
 	for (QIntDictIterator<KWallet::Backend> it(_wallets);
 						it.current();
@@ -515,7 +580,7 @@
 		}
 	}
 
-return closeWallet(w, handle, force);
+	return closeWallet(w, handle, force);
 }
 
 
@@ -540,14 +605,14 @@
 		return 1;
 	}
 
-return -1;
+	return -1;
 }
 
 
 int KWalletD::close(int handle, bool force) {
-QCString appid = friendlyDCOPPeerName();
-KWallet::Backend *w = _wallets.find(handle);
-bool contains = false;
+	QCString appid = friendlyDCOPPeerName();
+	KWallet::Backend *w = _wallets.find(handle);
+	bool contains = false;
 
 	if (w) { // the handle is valid
 		if (_handles.contains(appid)) { // we know this app
@@ -582,7 +647,7 @@
 		return 1; // not closed
 	}
 
-return -1; // not open to begin with, or other error
+	return -1; // not open to begin with, or other error
 }
 
 
@@ -594,30 +659,32 @@
 			return true;
 		}
 	}
-return false;
+	return false;
 }
 
 
 bool KWalletD::isOpen(int handle) {
+	if (handle == 0) {
+		return false;
+	}
+
 	KWallet::Backend *rc = _wallets.find(handle);
 
 	if (rc == 0 && ++_failed > 5) {
-		// FIXME: Make this part of a transaction or offload it from
-		//        the main execution path somehow.
-		KMessageBox::information(0, i18n("There have been repeated failed attempts to gain access to a wallet. An application may be misbehaving."), i18n("KDE Wallet Service"));
 		_failed = 0;
+		QTimer::singleShot(0, this, SLOT(notifyFailures()));
 	} else if (rc != 0) {
 		_failed = 0;
 	}
 
-return rc != 0;
+	return rc != 0;
 }
 
 
 QStringList KWalletD::wallets() const {
-QString path = KGlobal::dirs()->saveLocation("kwallet");
-QDir dir(path, "*.kwl");
-QStringList rc;
+	QString path = KGlobal::dirs()->saveLocation("kwallet");
+	QDir dir(path, "*.kwl");
+	QStringList rc;
 
 	dir.setFilter(QDir::Files | QDir::NoSymLinks);
 
@@ -632,12 +699,12 @@
 		rc += fn;
 		++it;
 	}
-return rc;
+	return rc;
 }
 
 
 void KWalletD::sync(int handle) {
-KWallet::Backend *b;
+	KWallet::Backend *b;
 
 	if ((b = getWallet(friendlyDCOPPeerName(), handle))) {
 		QByteArray p;
@@ -650,29 +717,29 @@
 
 
 QStringList KWalletD::folderList(int handle) {
-KWallet::Backend *b;
+	KWallet::Backend *b;
 
 	if ((b = getWallet(friendlyDCOPPeerName(), handle))) {
 		return b->folderList();
 	}
 
-return QStringList();
+	return QStringList();
 }
 
 
 bool KWalletD::hasFolder(int handle, const QString& f) {
-KWallet::Backend *b;
+	KWallet::Backend *b;
 
 	if ((b = getWallet(friendlyDCOPPeerName(), handle))) {
 		return b->hasFolder(f);
 	}
 
-return false;
+	return false;
 }
 
 
 bool KWalletD::removeFolder(int handle, const QString& f) {
-KWallet::Backend *b;
+	KWallet::Backend *b;
 
 	if ((b = getWallet(friendlyDCOPPeerName(), handle))) {
 		bool rc = b->removeFolder(f);
@@ -683,12 +750,12 @@
 		return rc;
 	}
 
-return false;
+	return false;
 }
 
 
 bool KWalletD::createFolder(int handle, const QString& f) {
-KWallet::Backend *b;
+	KWallet::Backend *b;
 
 	if ((b = getWallet(friendlyDCOPPeerName(), handle))) {
 		bool rc = b->createFolder(f);
@@ -699,12 +766,12 @@
 		return rc;
 	}
 
-return false;
+	return false;
 }
 
 
 QByteArray KWalletD::readMap(int handle, const QString& folder, const QString& key) {
-KWallet::Backend *b;
+	KWallet::Backend *b;
 
 	if ((b = getWallet(friendlyDCOPPeerName(), handle))) {
 		b->setFolder(folder);
@@ -714,12 +781,34 @@
 		}
 	}
 
-return QByteArray();
+	return QByteArray();
+}
+
+
+QMap<QString,QByteArray> KWalletD::readMapList(int handle, const QString& folder, const QString& key) {
+	KWallet::Backend *b;
+
+	if ((b = getWallet(friendlyDCOPPeerName(), handle))) {
+		b->setFolder(folder);
+		QPtrList<KWallet::Entry> e = b->readEntryList(key);
+		QMap<QString, QByteArray> rc;
+		QPtrListIterator<KWallet::Entry> it(e);
+		KWallet::Entry *entry;
+		while ((entry = it.current())) {
+			if (entry->type() == KWallet::Wallet::Map) {
+				rc.insert(entry->key(), entry->map());
+			}
+			++it;
+		}
+		return rc;
+	}
+
+	return QMap<QString, QByteArray>();
 }
 
 
 QByteArray KWalletD::readEntry(int handle, const QString& folder, const QString& key) {
-KWallet::Backend *b;
+	KWallet::Backend *b;
 
 	if ((b = getWallet(friendlyDCOPPeerName(), handle))) {
 		b->setFolder(folder);
@@ -729,24 +818,44 @@
 		}
 	}
 
-return QByteArray();
+	return QByteArray();
+}
+
+
+QMap<QString, QByteArray> KWalletD::readEntryList(int handle, const QString& folder, const QString& key) {
+	KWallet::Backend *b;
+
+	if ((b = getWallet(friendlyDCOPPeerName(), handle))) {
+		b->setFolder(folder);
+		QPtrList<KWallet::Entry> e = b->readEntryList(key);
+		QMap<QString, QByteArray> rc;
+		QPtrListIterator<KWallet::Entry> it(e);
+		KWallet::Entry *entry;
+		while ((entry = it.current())) {
+			rc.insert(entry->key(), entry->value());
+			++it;
+		}
+		return rc;
+	}
+
+	return QMap<QString, QByteArray>();
 }
 
 
 QStringList KWalletD::entryList(int handle, const QString& folder) {
-KWallet::Backend *b;
+	KWallet::Backend *b;
 
 	if ((b = getWallet(friendlyDCOPPeerName(), handle))) {
 		b->setFolder(folder);
 		return b->entryList();
 	}
 
-return QStringList();
+	return QStringList();
 }
 
 
 QString KWalletD::readPassword(int handle, const QString& folder, const QString& key) {
-KWallet::Backend *b;
+	KWallet::Backend *b;
 
 	if ((b = getWallet(friendlyDCOPPeerName(), handle))) {
 		b->setFolder(folder);
@@ -756,12 +865,34 @@
 		}
 	}
 
-return QString::null;
+	return QString::null;
+}
+
+
+QMap<QString, QString> KWalletD::readPasswordList(int handle, const QString& folder, const QString& key) {
+	KWallet::Backend *b;
+
+	if ((b = getWallet(friendlyDCOPPeerName(), handle))) {
+		b->setFolder(folder);
+		QPtrList<KWallet::Entry> e = b->readEntryList(key);
+		QMap<QString, QString> rc;
+		QPtrListIterator<KWallet::Entry> it(e);
+		KWallet::Entry *entry;
+		while ((entry = it.current())) {
+			if (entry->type() == KWallet::Wallet::Password) {
+				rc.insert(entry->key(), entry->password());
+			}
+			++it;
+		}
+		return rc;
+	}
+
+	return QMap<QString, QString>();
 }
 
 
 int KWalletD::writeMap(int handle, const QString& folder, const QString& key, const QByteArray& value) {
-KWallet::Backend *b;
+	KWallet::Backend *b;
 
 	if ((b = getWallet(friendlyDCOPPeerName(), handle))) {
 		b->setFolder(folder);
@@ -774,12 +905,12 @@
 		return 0;
 	}
 
-return -1;
+	return -1;
 }
 
 
 int KWalletD::writeEntry(int handle, const QString& folder, const QString& key, const QByteArray& value, int entryType) {
-KWallet::Backend *b;
+	KWallet::Backend *b;
 
 	if ((b = getWallet(friendlyDCOPPeerName(), handle))) {
 		b->setFolder(folder);
@@ -792,12 +923,12 @@
 		return 0;
 	}
 
-return -1;
+	return -1;
 }
 
 
 int KWalletD::writeEntry(int handle, const QString& folder, const QString& key, const QByteArray& value) {
-KWallet::Backend *b;
+	KWallet::Backend *b;
 
 	if ((b = getWallet(friendlyDCOPPeerName(), handle))) {
 		b->setFolder(folder);
@@ -810,12 +941,12 @@
 		return 0;
 	}
 
-return -1;
+	return -1;
 }
 
 
 int KWalletD::writePassword(int handle, const QString& folder, const QString& key, const QString& value) {
-KWallet::Backend *b;
+	KWallet::Backend *b;
 
 	if ((b = getWallet(friendlyDCOPPeerName(), handle))) {
 		b->setFolder(folder);
@@ -828,12 +959,12 @@
 		return 0;
 	}
 
-return -1;
+	return -1;
 }
 
 
 int KWalletD::entryType(int handle, const QString& folder, const QString& key) {
-KWallet::Backend *b;
+	KWallet::Backend *b;
 
 	if ((b = getWallet(friendlyDCOPPeerName(), handle))) {
 		if (!b->hasFolder(folder)) {
@@ -845,12 +976,12 @@
 		}
 	}
 
-return KWallet::Wallet::Unknown;
+	return KWallet::Wallet::Unknown;
 }
 
 
 bool KWalletD::hasEntry(int handle, const QString& folder, const QString& key) {
-KWallet::Backend *b;
+	KWallet::Backend *b;
 
 	if ((b = getWallet(friendlyDCOPPeerName(), handle))) {
 		if (!b->hasFolder(folder)) {
@@ -860,12 +991,12 @@
 		return b->hasEntry(key);
 	}
 
-return false;
+	return false;
 }
 
 
 int KWalletD::removeEntry(int handle, const QString& folder, const QString& key) {
-KWallet::Backend *b;
+	KWallet::Backend *b;
 
 	if ((b = getWallet(friendlyDCOPPeerName(), handle))) {
 		if (!b->hasFolder(folder)) {
@@ -877,7 +1008,7 @@
 		return rc ? 0 : -3;
 	}
 
-return -1;
+	return -1;
 }
 
 
@@ -906,7 +1037,11 @@
 
 
 KWallet::Backend *KWalletD::getWallet(const QCString& appid, int handle) {
-KWallet::Backend *w = _wallets.find(handle);
+	if (handle == 0) {
+		return 0L;
+	}
+
+	KWallet::Backend *w = _wallets.find(handle);
 
 	if (w) { // the handle is valid
 		if (_handles.contains(appid)) { // we know this app
@@ -922,13 +1057,20 @@
 	}
 
 	if (++_failed > 5) {
-		// FIXME: Make this part of a transaction or offload it from
-		//        the main execution path somehow.
-		KMessageBox::information(0, i18n("There have been repeated failed attempts to gain access to a wallet. An application may be misbehaving."), i18n("KDE Wallet Service"));
 		_failed = 0;
+		QTimer::singleShot(0, this, SLOT(notifyFailures()));
 	}
 
-return 0L;
+	return 0L;
+}
+
+
+void KWalletD::notifyFailures() {
+	if (!_showingFailureNotify) {
+		_showingFailureNotify = true;
+		KMessageBox::information(0, i18n("There have been repeated failed attempts to gain access to a wallet. An application may be misbehaving."), i18n("KDE Wallet Service"));
+		_showingFailureNotify = false;
+	}
 }
 
 
@@ -950,7 +1092,7 @@
 
 
 int KWalletD::renameEntry(int handle, const QString& folder, const QString& oldName, const QString& newName) {
-KWallet::Backend *b;
+	KWallet::Backend *b;
 
 	if ((b = getWallet(friendlyDCOPPeerName(), handle))) {
 		b->setFolder(folder);
@@ -959,12 +1101,12 @@
 		return rc;
 	}
 
-return -1;
+	return -1;
 }
 
 
 QStringList KWalletD::users(const QString& wallet) const {
-QStringList rc;
+	QStringList rc;
 
 	for (QIntDictIterator<KWallet::Backend> it(_wallets);
 						it.current();
@@ -979,7 +1121,7 @@
 		}
 	}
 
-return rc;
+	return rc;
 }
 
 
@@ -1010,7 +1152,7 @@
 		}
 	}
 
-return false;
+	return false;
 }
 
 
diff -urN -x CVS kdelibs.orig/kio/misc/kwalletd/kwalletd.desktop kdelibs/kio/misc/kwalletd/kwalletd.desktop
--- kdelibs.orig/kio/misc/kwalletd/kwalletd.desktop	Mon Oct  4 15:25:08 2004
+++ kdelibs/kio/misc/kwalletd/kwalletd.desktop	Fri Nov 12 08:27:52 2004
@@ -8,6 +8,8 @@
 X-KDE-Kded-autoload=false
 X-KDE-Kded-load-on-demand=true
 Name=KWallet Daemon Module
+Name[af]=KBeursie Bediener Module
+Name[ar]=مراقب وحدة KWallet
 Name[az]=KWallet Demon Modulu
 Name[bg]=Демон Портфейл
 Name[bn]=কে-ওয়ালেট ডিমন মডিউল
@@ -38,6 +40,7 @@
 Name[mn]=KWallet Daemon Модул
 Name[ms]=Modul Daemon KWallet
 Name[nb]=KWallet nisseprogramtillegg
+Name[nds]=KWallet-Dämoon-Moduul
 Name[nl]=KWallet daemon-module
 Name[nn]=KWallet-nissemodul
 Name[pa]=KWallet ਪੇਸ਼ਕਾਰੀ ਮੈਡੀਊਲ
@@ -61,6 +64,7 @@
 Name[zh_CN]=KWallet 守护进程模块
 Name[zh_TW]=KWAllet 服務程式模組
 Comment=KWallet daemon module for KDED
+Comment[af]=KBeursie bediener bodule vir KDED
 Comment[bg]=Модул демон за системата Портфейл за KDED
 Comment[bn]=KDED-র জন্য কে-ওয়ালেট ডিমন মডিউল 
 Comment[bs]=KWallet daemon modul za KDED
@@ -77,7 +81,10 @@
 Comment[is]=KWallet þjónseining fyrir KDED
 Comment[it]=Modulo demone KWallet per KDED
 Comment[ja]=KDED用のKWallet デーモンモジュール
+Comment[lt]=KWallet tarnybos modulis skirtas KDED
+Comment[mk]=KWallet даемон модул за KDED
 Comment[nb]=KWallet nissemodul for KDED
+Comment[nds]=KWallet-Dämoon för KDED
 Comment[nl]=KWallet daemon-module voor KDED
 Comment[nn]=KWallet-nissemodul for KDED
 Comment[pa]=KDED ਲਈ KWallet ਪੇਸ਼ਕਾਰੀ ਮੈਡੀਊਲ
@@ -85,6 +92,7 @@
 Comment[pt]=Módulo servidor do KWallet para o KDED
 Comment[pt_BR]=Módulo do serviço de carteira para o KDE
 Comment[ro]=Modul demon KWallet pentru KDED
+Comment[ru]=Модуль демона KWallet для KDED
 Comment[se]=KDED:a KWallet-bálvámoduvla
 Comment[sk]=Modul démona KWallet pre KDED
 Comment[sl]=Modul KWallet demon za KDED
@@ -94,4 +102,5 @@
 Comment[ta]=KDEDக்கான KWallet Daemon  தொகுதி
 Comment[tg]=Модули Демон KWallet барои KDED
 Comment[uk]=Модуль демону торбинок KWallet для KDED
+Comment[uz]=KDED учун KWallet хизматининг модули
 Comment[zh_CN]=KDED 的 KWallet 守护进程模块
diff -urN -x CVS kdelibs.orig/kio/misc/kwalletd/kwalletd.h kdelibs/kio/misc/kwalletd/kwalletd.h
--- kdelibs.orig/kio/misc/kwalletd/kwalletd.h	Thu Jun 17 03:37:35 2004
+++ kdelibs/kio/misc/kwalletd/kwalletd.h	Wed Nov 10 15:08:32 2004
@@ -1,7 +1,7 @@
 /*
    This file is part of the KDE libraries
 
-   Copyright (c) 2002-2003 George Staikos <staikos@kde.org>
+   Copyright (c) 2002-2004 George Staikos <staikos@kde.org>
 
    This library is free software; you can redistribute it and/or
    modify it under the terms of the GNU Library General Public
@@ -105,6 +105,9 @@
 		virtual QByteArray readEntry(int handle, const QString& folder, const QString& key);
 		virtual QByteArray readMap(int handle, const QString& folder, const QString& key);
 		virtual QString readPassword(int handle, const QString& folder, const QString& key);
+		virtual QMap<QString, QByteArray> readEntryList(int handle, const QString& folder, const QString& key);
+		virtual QMap<QString, QByteArray> readMapList(int handle, const QString& folder, const QString& key);
+		virtual QMap<QString, QString> readPasswordList(int handle, const QString& folder, const QString& key);
 
 		// Rename an entry.  rc=0 on success.
 		virtual int renameEntry(int handle, const QString& folder, const QString& oldName, const QString& newName);
@@ -143,9 +146,12 @@
 		void slotAppUnregistered(const QCString& app);
 		void emitWalletListDirty();
 		void timedOut(int);
+		void notifyFailures();
+		void processTransactions();
 
 	private:
 		int internalOpen(const QCString& appid, const QString& wallet, bool isPath = false, WId w = 0);
+		bool isAuthorizedApp(const QCString& appid, const QString& wallet, WId w);
 		// This also validates the handle.  May return NULL.
 		KWallet::Backend* getWallet(const QCString& appid, int handle);
 		// Generate a new unique handle.
@@ -159,9 +165,9 @@
 		int closeWallet(KWallet::Backend *w, int handle, bool force);
 		// Implicitly allow access for this application
 		bool implicitAllow(const QString& wallet, const QCString& app);
+		bool implicitDeny(const QString& wallet, const QCString& app);
 		QCString friendlyDCOPPeerName();
 
-		void processTransactions();
 		void doTransactionChangePassword(const QCString& appid, const QString& wallet, uint wId);
 		int doTransactionOpen(const QCString& appid, const QString& wallet, uint wId);
 
@@ -171,9 +177,10 @@
 		KDirWatch *_dw;
 		int _failed;
 
-		bool _leaveOpen, _closeIdle, _launchManager, _enabled, _openPrompt, _firstUse;
+		bool _leaveOpen, _closeIdle, _launchManager, _enabled;
+	       	bool _openPrompt, _firstUse, _showingFailureNotify;
 		int _idleTime;
-		QMap<QString,QStringList> _implicitAllowMap;
+		QMap<QString,QStringList> _implicitAllowMap, _implicitDenyMap;
 		KTimeout *_timeouts;
 
 		QPtrList<KWalletTransaction> _transactions;
diff -urN -x CVS kdelibs.orig/kio/renamedlgplugin.desktop kdelibs/kio/renamedlgplugin.desktop
--- kdelibs.orig/kio/renamedlgplugin.desktop	Mon Oct  4 15:25:07 2004
+++ kdelibs/kio/renamedlgplugin.desktop	Fri Nov 19 08:36:06 2004
@@ -35,10 +35,12 @@
 Comment[ko]=이름 바꾸기 대화창용 플러그인
 Comment[lt]=Priedas pervardinimo dialogui
 Comment[lv]=Iespraudnis Pārsaukšanas Dialogam
+Comment[mk]=Приклучок за дијалогот за преименување
 Comment[mn]=Нэр өөрчилөх-Диалогийн Plugin
 Comment[ms]=Plug masuk untuk namakan semula Dialog
 Comment[mt]=Plugin għad-djalogu biex tbiddel l-isem
 Comment[nb]=Programtillegg for omnavningsdialogen
+Comment[nds]=Plugin för den Ümnömen-Dialoog
 Comment[nl]=Plugin voor de 'Hernoemen'-dialoog
 Comment[nn]=Tillegg til dialogen for namnebyte
 Comment[nso]=Tsenyo ya Poledisano ya Theoleswa
@@ -48,7 +50,7 @@
 Comment[pt_BR]=Plug-in para o Diálogo Renomear
 Comment[ro]=Modul pentru dialogul de redenumire
 Comment[ru]=Модуль для диалога переименования
-Comment[se]=Lassemoduvla nammarievdadanlásaža várás
+Comment[se]=Lassemoduvla nammarievdadanláseža várás
 Comment[sk]=Modul pre premenovací dialóg
 Comment[sl]=Vstavek za pogovorno okno za preimenovanje
 Comment[sq]=Shtojca për Dialogun Riemrim
diff -urN -x CVS kdelibs.orig/kioslave/bzip2/kbzip2filter.desktop kdelibs/kioslave/bzip2/kbzip2filter.desktop
--- kdelibs.orig/kioslave/bzip2/kbzip2filter.desktop	Tue Aug 31 09:21:32 2004
+++ kdelibs/kioslave/bzip2/kbzip2filter.desktop	Sat Oct 30 08:38:15 2004
@@ -34,10 +34,12 @@
 Name[ko]=BZip2 거르개
 Name[lt]=BZip2 filtras
 Name[lv]=BZip2 Filtrs
+Name[mk]=BZip2 филтер
 Name[mn]=BZip2-Filter
 Name[ms]=Penapis BZip2
 Name[mt]=Filtru BZip2
 Name[nb]=BZip2-filter
+Name[nds]=BZip2-Filter
 Name[nl]=BZip2-filter
 Name[nn]=BZip2-filter
 Name[nso]=Sesekodi sa BZip2 
diff -urN -x CVS kdelibs.orig/kioslave/gzip/kgzipfilter.desktop kdelibs/kioslave/gzip/kgzipfilter.desktop
--- kdelibs.orig/kioslave/gzip/kgzipfilter.desktop	Tue Aug 31 09:21:33 2004
+++ kdelibs/kioslave/gzip/kgzipfilter.desktop	Sat Oct 30 08:38:16 2004
@@ -34,10 +34,12 @@
 Name[ko]=GZip 거르개
 Name[lt]=GZip filtras
 Name[lv]=GZip Filtrs
+Name[mk]=GZip филтер
 Name[mn]=GZip-Filter
 Name[ms]=Penapis GZip
 Name[mt]=Filtru GZip
 Name[nb]=GZip-filter
+Name[nds]=GZip-Filter
 Name[nl]=GZip-filter
 Name[nn]=GZip-filter
 Name[nso]=Sesekodi sa GZip
diff -urN -x CVS kdelibs.orig/kioslave/http/http_cache_cleaner.desktop kdelibs/kioslave/http/http_cache_cleaner.desktop
--- kdelibs.orig/kioslave/http/http_cache_cleaner.desktop	Tue Aug 24 08:29:29 2004
+++ kdelibs/kioslave/http/http_cache_cleaner.desktop	Sat Oct 30 08:38:16 2004
@@ -40,6 +40,7 @@
 Name[ms]=Pembersih Penyimpan HTTP
 Name[mt]=Tindif tal-cache HTTP
 Name[nb]=HTTP Mellomlagerrenser
+Name[nds]=Reenmaker för den HTTP-Twischenspieker
 Name[nl]=HTTP Cache opschonen
 Name[nn]=HTTP-mellomlageropprensking
 Name[nso]=Sehlwekisi sa Polokelo ya HTTP
@@ -104,11 +105,12 @@
 Comment[ko]=HTTP 캐시에서 오래된 것들을 정리합니다
 Comment[lt]=Išvalo senus įrašus iš HTTP krepšio
 Comment[lv]=Iztīra vecos ierakstus no HTTP keša
-Comment[mk]=Бришење на стари работи од HTTP касата
+Comment[mk]=Ги брише старите работи од HTTP кешот
 Comment[mn]=HTTP-завсрын хадгалагчаас хуучин бичлэгийг устгах
 Comment[ms]=Membersihkan masukan lama daripada penyimpan HTTP
 Comment[mt]=Ineħħi fajls antiki mill-cache tal-HTTP
 Comment[nb]=Fjerner gamle oppføringer fra hurtiglageret for HTTP
+Comment[nds]=Smitt ole Indrääg ut den HTTP-Twischenspieker rut
 Comment[nl]=Verwijdert oude ingangen uit de HTTP-cache
 Comment[nn]=Reinskar opp i gamle oppføringar i HTTP-mellomlageret
 Comment[nso]=E hlwekisa ditsenyo tsa kgale gotswa polokelong ya HTTP
diff -urN -x CVS kdelibs.orig/kioslave/http/kcookiejar/kcookiejar.desktop kdelibs/kioslave/http/kcookiejar/kcookiejar.desktop
--- kdelibs.orig/kioslave/http/kcookiejar/kcookiejar.desktop	Mon Sep 20 15:53:24 2004
+++ kdelibs/kioslave/http/kcookiejar/kcookiejar.desktop	Fri Nov 12 08:27:53 2004
@@ -34,6 +34,7 @@
 Name[ms]=Modul Balang Cecikut KDED
 Name[mt]=Modulu tal-"cookies" KDED
 Name[nb]=KDEDs modul for informasjonskapsler (Cookie Jar)
+Name[nds]=KDED-Moduul för dat Plegen vun Kookjes
 Name[nl]=KDED-module voor het opslaan van cookies
 Name[nn]=KDED-informasjonskapselmodul
 Name[nso]=Seripa sa Jar ya Cookie ya KDED
@@ -61,6 +62,7 @@
 Name[zh_TW]=KDED Cookie Jar 模組
 Name[zu]=Ingxenye Yojeke ye-Cookie ye-KDED
 Comment=Keeps track of all cookies in the system
+Comment[af]=Hou tred van al die koekies in die stelsel
 Comment[bg]=Контрол над всички кукита в системата
 Comment[bn]=সিস্টেমে সমস্ত কুকি-র খোঁজখবর রাখে
 Comment[bs]=Prati sve kolačiće (cookije) na sistemu
@@ -77,7 +79,10 @@
 Comment[is]=Heldur utanum allar smákökur í kerfinu
 Comment[it]=Tiene traccia di tutti i cookie del sistema
 Comment[ja]=システムのすべてのクッキーの残します
+Comment[lt]=Seka visus slapukus sistemoje
+Comment[mk]=Води сметка за сите колачиња во системот
 Comment[nb]=Holder rede på alle informasjonskapsler i systemet
+Comment[nds]=Passt op all Kookjes in't Systeem
 Comment[nl]=Houdt alle cookies in het systeem bij
 Comment[nn]=Held greie på informasjonskapslane
 Comment[pa]=ਸਿਸਟਮ ਦੇ ਸਾਰੇ ਕੂਕੀਜ਼ ਦਾ ਰਿਕਾਰਡ ਰੱਖੋ
@@ -85,15 +90,17 @@
 Comment[pt]=Mantem um registo de todos os 'cookies' no sistema
 Comment[pt_BR]=Mantém informações sobre todos os cookies do sistema
 Comment[ro]=Administrează toate "cookie"-urile din sistem
+Comment[ru]=Ведёт учет всех cookie в системе
 Comment[se]=Halddaša buot diehtočoahkuid
 Comment[sk]=Sleduje všetky cookie v systéme
 Comment[sl]=Opazuje vse piškotke v sistemu
 Comment[sr]=Води евиденцију о свим колачићима на систему
-Comment[sr@Latn]=Води евиденцију о свим колачићима на систему
+Comment[sr@Latn]=Vodi evidenciju o svim kolačićima na sistemu
 Comment[sv]=Håller ordning på alla kakor i systemet
 Comment[ta]=கணினியின் எல்லா தற்காலிக நினைவகங்களையும் கண்காணிக்கிறது
 Comment[tg]=Гузаргоҳи ҳамаша Cookies дар система муҳофизат кунед
 Comment[uk]=Стежить за всіма куками в системі
+Comment[uz]=Тизимдаги ҳамма кукиларни кузатади
 Comment[zh_CN]=将全部 cookies 的记录保存在系统中
 ServiceTypes=KDEDModule
 Exec=kcookiejar
diff -urN -x CVS kdelibs.orig/kjs/ChangeLog kdelibs/kjs/ChangeLog
--- kdelibs.orig/kjs/ChangeLog	Sat Oct  2 13:19:05 2004
+++ kdelibs/kjs/ChangeLog	Wed Nov 10 09:56:07 2004
@@ -1,3 +1,21 @@
+2004-11-07  Harri Porten  <porten@kde.org>
+
+	* date_object.cpp: fix conversion of Date(value) argument, fixed
+	getDay() for out-of-normal-range dates
+
+2004-10-13  Harri Porten  <porten@kde.org>
+
+	* regexp.cpp: support \u escape sequences in regular expressions 
+
+2004-10-11  Harri Porten  <porten@kde.org>
+
+	* date_object.cpp: make the Date object work outside of the
+	typical Unix range (1900-2038) by shifting other dates into this
+	range. Might still have some bugs with e.g. leap days but this is
+	a big step forward to ECMA compliancy.
+
+	* date_object.cpp: fixed cut-off date in Date.setYear()
+
 2004-10-02  Harri Porten  <porten@kde.org>
 
 	* lexer.cpp: parse function expressions with identifier as
diff -urN -x CVS kdelibs.orig/kjs/Makefile.am kdelibs/kjs/Makefile.am
--- kdelibs.orig/kjs/Makefile.am	Tue Oct  5 10:32:39 2004
+++ kdelibs/kjs/Makefile.am	Wed Nov 10 09:56:07 2004
@@ -68,36 +68,34 @@
 CREATE_HASH_TABLE = $(srcdir)/create_hash_table
 
 lexer.lut.h: $(srcdir)/keywords.table $(CREATE_HASH_TABLE)
-	$(PERL) $(CREATE_HASH_TABLE) $< -i > $@
+	$(PERL) $(CREATE_HASH_TABLE) $(srcdir)/keywords.table -i > $@
 lexer.lo: lexer.lut.h
 
 # Can't use %.lut.h: %.cpp, it's not portable.
 
 array_object.lut.h : $(srcdir)/array_object.cpp $(CREATE_HASH_TABLE)
-	$(PERL) $(CREATE_HASH_TABLE) $< -i > $@
+	$(PERL) $(CREATE_HASH_TABLE) $(srcdir)/array_object.cpp -i > $@
 array_object.lo: array_object.lut.h
 math_object.lut.h : $(srcdir)/math_object.cpp $(CREATE_HASH_TABLE)
-	$(PERL) $(CREATE_HASH_TABLE) $< -i > $@
+	$(PERL) $(CREATE_HASH_TABLE) $(srcdir)/math_object.cpp -i > $@
 math_object.lo: math_object.lut.h
 date_object.lut.h : $(srcdir)/date_object.cpp $(CREATE_HASH_TABLE)
-	$(PERL) $(CREATE_HASH_TABLE) $< -i > $@
+	$(PERL) $(CREATE_HASH_TABLE) $(srcdir)/date_object.cpp -i > $@
 date_object.lo: date_object.lut.h
 number_object.lut.h : $(srcdir)/number_object.cpp $(CREATE_HASH_TABLE)
-	$(PERL) $(CREATE_HASH_TABLE) $< -i > $@
+	$(PERL) $(CREATE_HASH_TABLE) $(srcdir)/number_object.cpp -i > $@
 number_object.lo: number_object.lut.h
 string_object.lut.h : $(srcdir)/string_object.cpp $(CREATE_HASH_TABLE)
-	$(PERL) $(CREATE_HASH_TABLE) $< -i > $@
+	$(PERL) $(CREATE_HASH_TABLE) $(srcdir)/string_object.cpp -i > $@
 string_object.lo: string_object.lut.h
 
 CLEANFILES = $(LUT_FILES)
 
 ## test program (in one program for easier profiling/memory debugging)
-EXTRA_PROGRAMS = testkjs_static testavl
+EXTRA_PROGRAMS = testkjs_static
 testkjs_static_SOURCES = testkjs.cpp 
 testkjs_static_LDADD = $(LIBPCRE) libkjs.la
 testkjs_static_LDFLAGS = -static
-testavl_SOURCES = testavl.cpp 
-testavl_LDADD = $(LIBPCRE) libkjs.la
 
 ## test program (linked to libkjs)
 check_PROGRAMS = testkjs
@@ -106,3 +104,6 @@
 
 DOXYGEN_REFERENCES = kdecore
 include ../admin/Doxyfile.am
+
+.PHONY: parser
+
diff -urN -x CVS kdelibs.orig/kjs/date_object.cpp kdelibs/kjs/date_object.cpp
--- kdelibs.orig/kjs/date_object.cpp	Sat Oct  2 13:19:05 2004
+++ kdelibs/kjs/date_object.cpp	Wed Nov 10 09:56:07 2004
@@ -51,6 +51,7 @@
 #include <stdlib.h>
 #include <locale.h>
 #include <ctype.h>
+#include <assert.h>
 
 #include "date_object.h"
 #include "error_object.h"
@@ -58,9 +59,92 @@
 
 #include "date_object.lut.h"
 
+using namespace KJS;
+
+// come constants
 const time_t invalidDate = -1;
+const double hoursPerDay = 24;
+const double minutesPerHour = 60;
+const double secondsPerMinute = 60;
+const double msPerSecond = 1000;
+const double msPerMinute = msPerSecond * secondsPerMinute;
+const double msPerHour = msPerMinute * minutesPerHour;
+const double msPerDay = msPerHour * hoursPerDay;
 
-using namespace KJS;
+static int day(double t)
+{
+  return int(floor(t / msPerDay));
+}
+
+static double dayFromYear(int year)
+{
+  return 365.0 * (year - 1970)
+    + floor((year - 1969) / 4.0)
+    - floor((year - 1901) / 100.0)
+    + floor((year - 1601) / 400.0);
+}
+
+// depending on whether it's a leap year or not
+static int daysInYear(int year)
+{
+  if (year % 4 != 0)
+    return 365;
+  else if (year % 400 == 0)
+    return 366;
+  else if (year % 100 == 0)
+    return 365;
+  else
+    return 366;
+}
+
+// time value of the start of a year
+double timeFromYear(int year)
+{
+  return msPerDay * dayFromYear(year);
+}
+
+// year determined by time value
+int yearFromTime(double t)
+{
+  // ### there must be an easier way
+  // initial guess
+  int y = 1970 + int(t / (365.25 * msPerDay));
+  // adjustment
+  if (timeFromYear(y) > t) {
+    do {
+      --y;
+    } while (timeFromYear(y) > t);
+  } else {
+    while (timeFromYear(y + 1) < t)
+      ++y;
+  }
+
+  return y;
+}
+
+// 0: Sunday, 1: Monday, etc.
+int weekDay(double t)
+{
+  int wd = (day(t) + 4) % 7;
+  if (wd < 0)
+    wd += 7;
+  return wd;
+}
+
+static double timeZoneOffset(const struct tm *t)
+{
+#if defined BSD || defined(__linux__) || defined(__APPLE__)
+  return -(t->tm_gmtoff / 60);
+#else
+#  if defined(__BORLANDC__)
+// FIXME consider non one-hour DST change
+#error please add daylight savings offset here!
+  return _timezone / 60 - (t->tm_isdst > 0 ? 60 : 0);
+#  else
+  return timezone / 60 - (t->tm_isdst > 0 ? 60 : 0 );
+#  endif
+#endif
+}
 
 // ------------------------------ DateInstanceImp ------------------------------
 
@@ -208,41 +292,39 @@
       return Number(NaN);
     }
   }
+
+  // check whether time value is outside time_t's usual range
+  // make the necessary transformations if necessary
+  int realYearOffset = 0;
+  double milliOffset = 0.0;
+  if (milli < 0 || milli >= timeFromYear(2038)) {
+    // ### ugly and probably not very precise
+    int realYear = yearFromTime(milli);
+    int y0 = (realYear / 100) * 100;
+    int base = 1900;
+    if (realYear % 100 == 0)
+      base += 100;
+    milliOffset = timeFromYear(base) - timeFromYear(y0);
+    milli += milliOffset;
+    realYearOffset = realYear - yearFromTime(milli);
+  }
+
   time_t tv = (time_t) floor(milli / 1000.0);
   int ms = int(milli - tv * 1000.0);
 
-  // As long as we're using time_t we need to 'truncate' to avoid 'wrapping'.
-  // Real long term solutions include: writing our own 64-bit-based date/time class,
-  // using wxWindow's datetime.cpp (in wxBase), using QDateTime... or shifting
-  // to a time_t range by substracting a big enough number of years....
-  if (sizeof(time_t) == 4)
-  {
-    // If time_t is signed, the bigger it can be is 2^31-1
-    if ( (time_t)-1 < 0 ) {
-      if ( floor(milli / 1000.0) > ((double)((uint)1<<31)-1) ) {
-#ifdef KJS_VERBOSE
-        fprintf(stderr, "date above time_t limit. Year seems to be %d\n", (int)(milli/(1000.0*365.25*86400)+1970));
-#endif
-        tv = ((uint)1<<31)-1;
-        ms = 0;
-      }
-    }
-    else
-      // time_t is unsigned, the bigger it can be is 2^32-1, aka (uint)-1
-      if ( floor(milli / 1000.0) > ((double)(uint)-1) ) {
-#ifdef KJS_VERBOSE
-        fprintf(stderr, "date above time_t limit. Year seems to be %d\n", (int)(milli/(1000.0*365.25*86400)+1970));
-#endif
-        tv = (uint)-1;
-        ms = 0;
-      }
-  }
+  struct tm *t = utc ? gmtime(&tv) : localtime(&tv);
 
-  struct tm *t;
-  if (utc)
-    t = gmtime(&tv);
-  else
-    t = localtime(&tv);
+  // we had an out of range year. use that one (plus/minus offset
+  // found by calculating tm_year) and fix the week day calculation
+  if (realYearOffset != 0) {
+    t->tm_year += realYearOffset;
+    milli -= milliOffset;
+    // our own weekday calculation. beware of need for local time.
+    double m = milli;
+    if (!utc)
+      m -= timeZoneOffset(t) * msPerMinute;
+    t->tm_wday = weekDay(m);
+  }
 
   // trick gcc. We don't want the Y2K warnings.
   const char xFormat[] = "%x";
@@ -316,17 +398,7 @@
     result = Number(ms);
     break;
   case GetTimezoneOffset:
-#if defined BSD || defined(__linux__) || defined(__APPLE__)
-    result = Number(-(t->tm_gmtoff / 60) );
-#else
-#  if defined(__BORLANDC__)
-// FIXME consider non one-hour DST change
-#error please add daylight savings offset here!
-    result = Number(_timezone / 60 - (t->tm_isdst > 0 ? 60 : 0));
-#  else
-    result = Number((timezone / 60 - (t->tm_isdst > 0 ? 60 : 0 )));
-#  endif
-#endif
+    result = Number(timeZoneOffset(t));
     break;
   case SetTime:
     milli = roundValue(exec,args[0]);
@@ -372,15 +444,19 @@
     if (args.size() >= 3)
       t->tm_mday = args[2].toInt32(exec);
     break;
-  case SetYear:
-    t->tm_year = args[0].toInt32(exec) >= 1900 ? args[0].toInt32(exec) - 1900 : args[0].toInt32(exec);
+  case SetYear: {
+    int a0 = args[0].toInt32(exec);
+    if (a0 >= 0 && a0 <= 99)
+      a0 += 1900;
+    t->tm_year = a0 - 1900;
     break;
   }
+  }
 
   if (id == SetYear || id == SetMilliSeconds || id == SetSeconds ||
       id == SetMinutes || id == SetHours || id == SetDate ||
       id == SetMonth || id == SetFullYear ) {
-    result = makeTime(t, ms, utc);
+    result = Number(makeTime(t, ms, utc));
     thisObj.setInternalValue(result);
   }
 
@@ -423,7 +499,7 @@
 #ifdef KJS_VERBOSE
   fprintf(stderr,"DateObjectImp::construct - %d args\n", numArgs);
 #endif
-  Value value;
+  double value;
 
   if (numArgs == 0) { // new Date() ECMA 15.9.3.3
 #if HAVE_SYS_TIMEB_H
@@ -440,14 +516,13 @@
     gettimeofday(&tv, 0L);
     double utc = floor((double)tv.tv_sec * 1000.0 + (double)tv.tv_usec / 1000.0);
 #endif
-    value = Number(utc);
+    value = utc;
   } else if (numArgs == 1) {
-    UString s = args[0].toString(exec);
-    double d = s.toDouble();
-    if (isNaN(d))
-      value = parseDate(s);
+    Value prim = args[0].toPrimitive(exec);
+    if (prim.isA(StringType))
+      value = parseDate(prim.toString(exec));
     else
-      value = Number(d);
+      value = prim.toNumber(exec);
   } else {
     struct tm t;
     memset(&t, 0, sizeof(t));
@@ -466,7 +541,7 @@
 
   Object proto = exec->interpreter()->builtinDatePrototype();
   Object ret(new DateInstanceImp(proto.imp()));
-  ret.setInternalValue(timeClip(value));
+  ret.setInternalValue(Number(timeClip(value)));
   return ret;
 }
 
@@ -507,7 +582,7 @@
 Value DateObjectFuncImp::call(ExecState *exec, Object &/*thisObj*/, const List &args)
 {
   if (id == Parse) {
-    return parseDate(args[0].toString(exec));
+    return Number(parseDate(args[0].toString(exec)));
   } else { // UTC
     struct tm t;
     memset(&t, 0, sizeof(t));
@@ -521,14 +596,14 @@
     t.tm_min = (n >= 5) ? args[4].toInt32(exec) : 0;
     t.tm_sec = (n >= 6) ? args[5].toInt32(exec) : 0;
     int ms = (n >= 7) ? args[6].toInt32(exec) : 0;
-    return makeTime(&t, ms, true);
+    return Number(makeTime(&t, ms, true));
   }
 }
 
 // -----------------------------------------------------------------------------
 
 
-Value KJS::parseDate(const UString &u)
+double KJS::parseDate(const UString &u)
 {
 #ifdef KJS_VERBOSE
   fprintf(stderr,"KJS::parseDate %s\n",u.ascii());
@@ -551,7 +626,7 @@
   }
 #endif
 
-  return Number(seconds == -1 ? NaN : seconds * 1000.0);
+  return seconds == -1 ? NaN : seconds * 1000.0;
 }
 
 ///// Awful duplication from krfcdate.cpp - we don't link to kdecore
@@ -593,7 +668,7 @@
     { { 0, 0, 0, 0 }, 0 }
 };
 
-Number KJS::makeTime(struct tm *t, int ms, bool utc)
+double KJS::makeTime(struct tm *t, int ms, bool utc)
 {
     int utcOffset;
     if (utc) {
@@ -616,7 +691,21 @@
 	t->tm_isdst = -1;
     }
 
-    return Number( ( mktime(t) + utcOffset ) * 1000.0 + ms );
+    double yearOffset = 0.0;
+    if (t->tm_year < (1970 - 1900) || t->tm_year > (2038 - 1900)) {
+      // we'll fool mktime() into believing that this year is within
+      // its normal, portable range (1970-2038) by setting tm_year to
+      // 2000 or 2001 and adding the difference in milliseconds later.
+      // choice between offset will depend on whether the year is a
+      // leap year or not.
+      int y = t->tm_year + 1900;
+      int baseYear = daysInYear(y) == 365 ? 2001 : 2000;
+      const double baseTime = timeFromYear(baseYear);
+      yearOffset = timeFromYear(y) - baseTime;
+      t->tm_year = baseYear - 1900;
+    }
+
+    return (mktime(t) + utcOffset) * 1000.0 + ms + yearOffset;
 }
 
 double KJS::KRFCDate_parseDate(const UString &_date)
@@ -907,7 +996,7 @@
        return mktime(&t);
      }
 
-       offset *= 60;
+     offset *= 60;
 
      result = ymdhms_to_seconds(year, month+1, day, hour, minute, second);
 
@@ -926,9 +1015,10 @@
 }
 
 
-Value KJS::timeClip(const Value &t)
+double KJS::timeClip(double t)
 {
-  /* TODO */
+  if (isInf(t) || fabs(t) > 8.64E15)
+    return NaN;
   return t;
 }
 
diff -urN -x CVS kdelibs.orig/kjs/date_object.h kdelibs/kjs/date_object.h
--- kdelibs.orig/kjs/date_object.h	Sun Oct  3 21:23:49 2004
+++ kdelibs/kjs/date_object.h	Wed Nov 10 09:56:07 2004
@@ -117,10 +117,10 @@
   };
 
   // helper functions
-  Value parseDate(const UString &u);
+  double parseDate(const UString &u);
   double KRFCDate_parseDate(const UString &_date);
-  Value timeClip(const Value &t);
-  Number makeTime(struct tm *t, int milli, bool utc);
+  double timeClip(double t);
+  double makeTime(struct tm *t, int milli, bool utc);
 
 } // namespace
 
diff -urN -x CVS kdelibs.orig/kjs/nodes.cpp kdelibs/kjs/nodes.cpp
--- kdelibs.orig/kjs/nodes.cpp	Tue May 11 18:35:43 2004
+++ kdelibs/kjs/nodes.cpp	Fri Oct 29 15:47:07 2004
@@ -646,8 +646,8 @@
 Reference AccessorNode2::evaluateReference(ExecState *exec) const
 {
   Value v = expr->evaluate(exec);
-  assert(v.isValid());
   KJS_CHECKEXCEPTIONREFERENCE
+  assert(v.isValid());
 #ifndef NDEBUG
   // catch errors before being caught in toObject(). better error message.
   if (v.isA(UndefinedType) || v.isA(NullType)) {
diff -urN -x CVS kdelibs.orig/kjs/regexp.cpp kdelibs/kjs/regexp.cpp
--- kdelibs.orig/kjs/regexp.cpp	Tue Jun  8 15:46:22 2004
+++ kdelibs/kjs/regexp.cpp	Wed Nov 10 09:56:07 2004
@@ -21,6 +21,7 @@
 
 #include "regexp.h"
 
+#include "lexer.h"
 #include <stdio.h>
 #include <stdlib.h>
 #include <string.h>
@@ -30,6 +31,43 @@
 RegExp::RegExp(const UString &p, int f)
   : pattern(p), flgs(f), m_notEmpty(false)
 {
+  // JS regexps can contain Unicode escape sequences (\uxxxx) which
+  // are rather uncommon elsewhere. As our regexp libs don't understand
+  // them we do the unescaping ourselves internally.
+  UString intern;
+  if (p.find('\\') >= 0) {
+    bool escape = false;
+    for (int i = 0; i < p.size(); ++i) {
+      UChar c = p[i];
+      if (escape) {
+        escape = false;
+        // we only care about \uxxxx
+        if (c == 'u' && i + 4 < p.size()) {
+          int c0 = p[i+1].unicode();
+          int c1 = p[i+2].unicode();
+          int c2 = p[i+3].unicode();
+          int c3 = p[i+4].unicode();
+          if (Lexer::isHexDigit(c0) && Lexer::isHexDigit(c1) &&
+              Lexer::isHexDigit(c2) && Lexer::isHexDigit(c3)) {
+            c = Lexer::convertUnicode(c0, c1, c2, c3);
+            intern += UString(&c, 1);
+            i += 4;
+            continue;
+          }
+        }
+        intern += UString('\\');
+        intern += UString(&c, 1);
+      } else {
+        if (c == '\\')
+          escape = true;
+        else
+          intern += UString(&c, 1);
+      }
+    }
+  } else {
+    intern = p;
+  }
+
 #ifdef HAVE_PCREPOSIX
   int pcreflags = 0;
   const char *perrormsg;
@@ -41,7 +79,7 @@
   if (flgs & Multiline)
     pcreflags |= PCRE_MULTILINE;
 
-  pcregex = pcre_compile(p.ascii(), pcreflags,
+  pcregex = pcre_compile(intern.ascii(), pcreflags,
 			 &perrormsg, &errorOffset, NULL);
 #ifndef NDEBUG
   if (!pcregex)
@@ -72,7 +110,7 @@
   //    ;
   // Note: the Global flag is already handled by RegExpProtoFunc::execute
 
-  if (regcomp(&preg, p.ascii(), regflags) != 0) {
+  if (regcomp(&preg, intern.ascii(), regflags) != 0) {
     /* TODO: throw JS exception */
     regcomp(&preg, "", regflags);
   }
@@ -121,7 +159,9 @@
       // We set m_notEmpty ourselves, to look for a non-empty match
       // (see man pcretest or pcretest.c for details).
       // So we don't stop here, we want to try again at i+1.
+#ifndef NDEBUG
       fprintf(stderr, "No match after m_notEmpty. +1 and keep going.\n");
+#endif
       m_notEmpty = 0;
       if (pcre_exec(pcregex, NULL, buffer.c_str(), bufferSize, i+1, 0,
                     ovector ? *ovector : 0L, ovecsize) == PCRE_ERROR_NOMATCH)
diff -urN -x CVS kdelibs.orig/kjs/testavl.cpp kdelibs/kjs/testavl.cpp
--- kdelibs.orig/kjs/testavl.cpp	Thu Jun 26 00:32:16 2003
+++ kdelibs/kjs/testavl.cpp	Thu Jan  1 01:00:00 1970
@@ -1,176 +0,0 @@
-// -*- c-basic-offset: 2 -*-
-/*
- *  This file is part of the KDE libraries
- *  Copyright (C) 2001 Peter Kelly (pmk@post.com)
- *
- *  This library is free software; you can redistribute it and/or
- *  modify it under the terms of the GNU Lesser General Public
- *  License as published by the Free Software Foundation; either
- *  version 2 of the License, or (at your option) any later version.
- *
- *  This library is distributed in the hope that it will be useful,
- *  but WITHOUT ANY WARRANTY; without even the implied warranty of
- *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
- *  Lesser General Public License for more details.
- *
- *  You should have received a copy of the GNU Lesser General Public License
- *  along with this library; see the file COPYING.LIB.  If not, write to
- *  the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
- *  Boston, MA 02111-1307, USA.
- *
- *  $Id$
- */
-
-#include "value.h"
-#include "property_map.h"
-#include "internal.h"
-#include "ustring.h"
-
-#include <stdio.h>
-#include <stdlib.h>
-#include <time.h>
-#include <assert.h>
-
-using namespace KJS;
-
-bool testInsertDelete(int numInsert, int numDelete, int delOffset, int randSeed) {
-
-  srand(randSeed);
-  char str[20];
-  bool result = true;
-
-  assert(numDelete >= 0 && numDelete < numInsert);
-  assert(delOffset >= 0 && delOffset+numDelete <= numInsert);
-  PropertyMap map;
-
-  // add some random numbers
-  int *nums = (int*)malloc(numInsert*sizeof(int));
-  int i;
-  for (i = 0; i < numInsert; i++) {
-    nums[i] = int(1000.0*rand()/RAND_MAX);
-
-    Value val = Number(nums[i]);
-    ValueImp *v = val.imp();
-    v->ref();
-
-    sprintf(str,"%05d-%05d",nums[i],i); // ensure uniqueness
-    map.put(str,v,0);
-    map.checkTree();
-  }
-
-  // check to ensure they're all there
-  for (i = 0; i < numInsert; i++) {
-    sprintf(str,"%05d-%05d",nums[i],i);
-    ValueImp *v = map.get(str);
-    if (v == 0 || v->type() != NumberType ||
-        static_cast<NumberImp*>(v)->value() != nums[i]) {
-      result = false;
-    }
-    map.checkTree();
-  }
-
-  // delete some
-  for (i = delOffset; i < delOffset+numDelete; i++) {
-    sprintf(str,"%05d-%05d",nums[i],i);
-    map.remove(str);
-    map.checkTree();
-  }
-
-  // make sure the deletes ones aren't there any more, and the others are
-  for (i = 0; i < numInsert; i++) {
-    sprintf(str,"%05d-%05d",nums[i],i);
-    ValueImp *v = map.get(str);
-
-    if (i >= delOffset && i < delOffset+numDelete) {
-      // should have been deleted
-      if (v)
-        result = false;
-    }
-    else {
-      // should not have been deleted
-      if (v == 0 || v->type() != NumberType ||
-          static_cast<NumberImp*>(v)->value() != nums[i]) {
-        result = false;
-      }
-    }
-    map.checkTree();
-  }
-
-  // check that first() and next() work
-  PropertyMapNode *it = map.first();
-  int itcount = 0;
-  while (it) {
-    itcount++;
-    PropertyMapNode *prev = it;
-    it = it->next();
-    if (it) {
-      if (uscompare(prev->name,it->name) >= 0)
-        result = false;
-    }
-  }
-  if (itcount != numInsert-numDelete)
-    result = false;
-
-  if (result)
-    printf("PASS: Insert %d, delete %d-%d, seed %d\n",numInsert,delOffset,
-           delOffset+numDelete-1,randSeed);
-  else
-    printf("FAIL: Insert %d, delete %d-%d, seed %d\n",numInsert,delOffset,
-           delOffset+numDelete-1,randSeed);
-
-  return result;
-}
-
-void testMisc() {
-  PropertyMap *map;
-
-  // test remove() doesn't crash with empty list
-  map = new PropertyMap();
-  map->remove("nonexistent");
-  delete map;
-  printf("PASS: remove() doesn't crash with empty list\n");
-
-  // test get() doesn't crash with empty list
-  map = new PropertyMap();
-  map->get("nonexistent");
-  delete map;
-  printf("PASS: get() doesn't crash with empty list\n");
-
-  // test get() returns 0 on an empty list
-  map = new PropertyMap();
-  if (map->get("nonexistent") == 0)
-    printf("PASS: get() returns 0 on an empty list\n");
-  else
-    printf("FAIL: get() returns 0 on an empty list\n");
-  delete map;
-}
-
-int main()
-{
-  PropertyMap map;
-
-  testMisc();
-
-  int randomSeed = 4;
-  int numTests = 100;
-
-  srand(randomSeed);
-
-  int *numInserts = (int*)malloc(numTests*sizeof(int));
-  int *numDeletes = (int*)malloc(numTests*sizeof(int));
-  int *delOffsets = (int*)malloc(numTests*sizeof(int));
-  int i;
-  for (i = 0; i < numTests; i++) {
-    numInserts[i] = int(1000.0*rand()/RAND_MAX);
-    numDeletes[i] = int(float(numInserts[i])*rand()/RAND_MAX);
-    delOffsets[i] = int(float(numInserts[i]-numDeletes[i])*rand()/RAND_MAX);
-  }
-
-  for (i = 0; i < numTests; i++) {
-    testInsertDelete(numInserts[i],numDeletes[i],delOffsets[i],4);
-  }
-
-
-
-  return 0;
-}
diff -urN -x CVS kdelibs.orig/knewstuff/knewstuffgeneric.cpp kdelibs/knewstuff/knewstuffgeneric.cpp
--- kdelibs.orig/knewstuff/knewstuffgeneric.cpp	Sat Feb 21 00:42:38 2004
+++ kdelibs/knewstuff/knewstuffgeneric.cpp	Sat Oct 23 11:31:54 2004
@@ -44,7 +44,6 @@
 
 KNewStuffGeneric::~KNewStuffGeneric()
 {
-  delete mConfig;
 }
 
 bool KNewStuffGeneric::install( const QString &fileName )
diff -urN -x CVS kdelibs.orig/kparts/browserview.desktop kdelibs/kparts/browserview.desktop
--- kdelibs.orig/kparts/browserview.desktop	Tue Aug 24 08:29:31 2004
+++ kdelibs/kparts/browserview.desktop	Tue Nov  9 08:35:28 2004
@@ -35,11 +35,11 @@
 Name[ko]=탐색기 보기
 Name[lt]=Rodyti naršyklėje
 Name[lv]=Pārlūka Skatījums
-Name[mk]=Разгледување
 Name[mn]=Хөтөч Харах
 Name[ms]=Pelihat Pelayar
 Name[mt]=Dehra Browser
 Name[nb]=Nettleservisning
+Name[nds]=Nettkieker-Ansicht
 Name[nl]=Browserweergave
 Name[nn]=Nettlesarvising
 Name[nso]=Pono ya Seinyakisi
@@ -58,7 +58,7 @@
 Name[sr@Latn]=Pretraživačev prikaz
 Name[sv]=Surfvy
 Name[ta]=உலாவிக் காட்சி
-Name[tg]=Намуди Хониши Парешон
+Name[tg]=Намоиши ҷустуҷукунанда
 Name[tr]=Tarayıcı Görünümü
 Name[uk]=Вигляд "Навігація"
 Name[uz]=Браузернинг кўриниши
diff -urN -x CVS kdelibs.orig/kparts/kpart.desktop kdelibs/kparts/kpart.desktop
--- kdelibs.orig/kparts/kpart.desktop	Tue Aug 31 09:21:35 2004
+++ kdelibs/kparts/kpart.desktop	Sun Oct 24 09:02:00 2004
@@ -41,6 +41,7 @@
 Comment[ms]=Komponen KDE
 Comment[mt]=Komponent tal-KDE
 Comment[nb]=KDE-komponent
+Comment[nds]=KDE-Komponent
 Comment[nl]=KDE-component
 Comment[nn]=KDE-komponent
 Comment[nso]=Seripa sa KDE
diff -urN -x CVS kdelibs.orig/kparts/krop.desktop kdelibs/kparts/krop.desktop
--- kdelibs.orig/kparts/krop.desktop	Tue Aug 31 09:21:35 2004
+++ kdelibs/kparts/krop.desktop	Sun Oct 24 09:02:00 2004
@@ -42,6 +42,7 @@
 Comment[ms]=Komponen KDE
 Comment[mt]=Komponent tal-KDE
 Comment[nb]=KDE-komponent
+Comment[nds]=KDE-Komponent
 Comment[nl]=KDE-component
 Comment[nn]=KDE-komponent
 Comment[nso]=Seripa sa KDE
diff -urN -x CVS kdelibs.orig/kparts/krwp.desktop kdelibs/kparts/krwp.desktop
--- kdelibs.orig/kparts/krwp.desktop	Tue Aug 31 09:21:35 2004
+++ kdelibs/kparts/krwp.desktop	Sun Oct 24 09:02:00 2004
@@ -42,6 +42,7 @@
 Comment[ms]=Komponen KDE
 Comment[mt]=Komponent tal-KDE
 Comment[nb]=KDE-komponent
+Comment[nds]=KDE-Komponent
 Comment[nl]=KDE-component
 Comment[nn]=KDE-komponent
 Comment[nso]=Seripa sa KDE
diff -urN -x CVS kdelibs.orig/kparts/tests/notepad.desktop kdelibs/kparts/tests/notepad.desktop
--- kdelibs.orig/kparts/tests/notepad.desktop	Tue Aug 24 08:29:31 2004
+++ kdelibs/kparts/tests/notepad.desktop	Sun Oct 24 09:02:00 2004
@@ -38,6 +38,7 @@
 Name[ms]=Notepad (contoh)
 Name[mt]=Notepad (eżempju)
 Name[nb]=Notisblokk (eksempel)
+Name[nds]=Notizzeddel (Bispeel)
 Name[nl]=Kladblok (voorbeeld)
 Name[nn]=Notisblokk (døme)
 Name[nso]=Notepad (mohlala)
diff -urN -x CVS kdelibs.orig/kresources/kresources.desktop kdelibs/kresources/kresources.desktop
--- kdelibs.orig/kresources/kresources.desktop	Sun Sep 12 15:56:08 2004
+++ kdelibs/kresources/kresources.desktop	Fri Nov 12 08:27:53 2004
@@ -11,6 +11,8 @@
 X-KDE-HasReadOnlyMode=false
 
 Name=KDE Resources Configuration
+Name[af]=KDE Hulpbron Opstelling
+Name[ar]=إعدادت مصادر كيدي
 Name[az]=KDE Ehtiyatlar Qurğuları
 Name[be]=Канфігурацыя рэсурсаў KDE
 Name[bg]=Ресурси
@@ -29,6 +31,7 @@
 Name[fa]=تنظیمات منابع KDE
 Name[fi]=KDE:n resurssiasetukset
 Name[fr]=Configuration des ressources de KDE
+Name[ga]=Cumraíocht Acmhainní KDE
 Name[gl]=Configuración dos Recursos de KDE
 Name[he]=תצורת משאבים של KDE
 Name[hi]=केडीई संसाधन कॉन्फ़िगुरेशन
@@ -40,9 +43,11 @@
 Name[ja]=KDE リソース設定
 Name[ko]=KDE 자원 설정
 Name[lt]=KDE resursų derinimas
+Name[mk]=KDE конфигурација на ресурси
 Name[mn]=КДЭ нөөцийн тохиргоо
 Name[ms]=Penyelarasan Sumber KDE
 Name[nb]=KDE ressursinnstilling
+Name[nds]=KDE-Ressourcen
 Name[nl]=KDE-hulpbronnenconfiguratie
 Name[nn]=Oppsett av KDE-ressursar
 Name[pa]=KDE ਸਰੋਤ ਸੰਰਚਨਾ
@@ -68,6 +73,7 @@
 Name[zh_TW]=KDE 資源組態
 
 Comment=Configure KDE Resources
+Comment[af]=Stel KDE Hulpbronne op
 Comment[be]=Настроіць рэсурсы KDE
 Comment[bg]=Настройки на ресурсите на КДЕ
 Comment[bn]=কে.ডি.ই. রিসোর্সসমূহ কনফিগার করো
@@ -81,12 +87,16 @@
 Comment[et]=KDE ressurside seadistamine
 Comment[fi]=Muokkaa KDE:n resursseja
 Comment[fr]=Configure les ressources de KDE
+Comment[ga]=Cumraigh Acmhainní KDE
 Comment[he]=תצורת משאבים של KDE
 Comment[hu]=A KDE-s erőforrások beállítása
 Comment[is]=Stilla KDE auðlindir
 Comment[it]=Configura le risorse di KDE
 Comment[ja]=KDE リソースの設定
+Comment[lt]=Derinti KDE resursus
+Comment[mk]=Ги конфигурира KDE ресурсите
 Comment[nb]=Sett opp KDE-ressurser
+Comment[nds]=KDE-Ressourcen instellen
 Comment[nl]=KDE-hulpbronnen instellen
 Comment[nn]=Set opp KDE-ressursar
 Comment[pa]=KDE ਸਰੋਤਾਂ ਦੀ ਸੰਰਚਨਾ
@@ -94,11 +104,12 @@
 Comment[pt]=Configurar Recursos do KDE
 Comment[pt_BR]=Configura Recursos do KDE
 Comment[ro]=Configurează resursele KDE
+Comment[ru]=Параметры ресурсов KDE
 Comment[se]=Heivet KDE-resurssaid
 Comment[sk]=Nastavenie zdrojov KDE
 Comment[sl]=Nastavi vire KDE
 Comment[sr]=Подешавање KDE-ових ресурса
-Comment[sr@Latn]=Подешавање KDE-ових ресурса
+Comment[sr@Latn]=Podešavanje KDE-ovih resursa
 Comment[sv]=Anpassa KDE-resurser
 Comment[ta]=KDE மூலங்களை கட்டமை
 Comment[tg]=Танзими манбаъи истифодашуда тавассути китоби адрес
@@ -107,9 +118,11 @@
 Comment[zh_CN]=配置 KDE 资源
 
 Keywords=resources,konnector resource,contact resource,calendar resource,notes resource,imap
+Keywords[af]=hulpbronne,konnector hulpbron,kontak hulpbron,kalender hulpbron, notas hulpbron, imap
 Keywords[bg]=ресурс, ресурси, настройки, бележки, адресна, адресник, книга, календар, resources, konnector resource, contact resource, calendar resource, notes resource, imap
 Keywords[bs]=resources,konnector resource,contact resource,calendar resource,notes resource,imap,resursi,konektor resurs,kontakt resurs,kalendar resurs,bilješke resurs
 Keywords[ca]=recursos,recurs konnector,recurs de contacte,recurs de calendari,recurs de notes,imap
+Keywords[cs]=zdroje,konektor,kontakty,kalendář,poznámky,IMAP
 Keywords[da]=ressourcer,konnector ressource,kontakt resource,kalender ressource,noter ressource,imap
 Keywords[de]=Ressourcen,Kontakt-Ressource,Kalender-Ressource,Notizen-Ressource,IMAP
 Keywords[eo]=risurcoj,kontakrisurco,kalendarrisurco,notrisuroco
@@ -121,7 +134,9 @@
 Keywords[hu]=erőforrások,csatoló-erőforrás,névjegy-erőforrás,naptár-erőforrás,feljegyzés-erőforrás,IMAP
 Keywords[it]=risorse,risorsa konnector,risorsa contatti, risorsa calendario,risorsa note,imap
 Keywords[ja]=リソース,konnector resource, コネクターリソース,コンタクトリソース,カレンダーリソース, ノートリソース,imap
+Keywords[lt]=resursai,konnector resursas,kontaktų resursas,kalendoriaus resursas,priminimų resursas,imap
 Keywords[nb]=ressurser,konnector-ressurs,kontaktressurs,kalenderressurs, notatressurs,imap
+Keywords[nds]=Ressourcen,konnector-Ressource,Kontakt-Ressource,Kalenner-Ressource,Notiz-Ressource,IMAP
 Keywords[nl]=hulpbron,verbindingshulpbron,contact-hulpbron,kalender-hulpbron,notities-hulpbron,imap,contact,kalender,notitie,verbinding
 Keywords[nn]=ressursar,konnector-ressurs,kontaktressurs,kalenderressurs,notatressurs,imap
 Keywords[pl]=zasoby,konnector,zasoby wizytówek,zasoby kalendarze,zasoby notatek,imap
@@ -130,7 +145,7 @@
 Keywords[ro]=resurse,konnector,contact,calendar,notiţe,imap
 Keywords[sk]=zdroje,zdroj pre konnector,zdroj kontaktov,zdroj kalendára,zdroj poznámok,imap
 Keywords[sr]=resources,konnector resource,contact resource,calendar resource,notes resource,imap,ресурси,ресурс,повезивач,контакт ресурс, календарски ресурс
-Keywords[sr@Latn]=resources,konnector resource,contact resource,calendar resource,notes resource,imap,ресурси,ресурс,повезивач,контакт ресурс, календарски ресурс
+Keywords[sr@Latn]=resources,konnector resource,contact resource,calendar resource,notes resource,imap,resursi,resurs,povezivač,kontakt resurs, kalendarski resurs
 Keywords[sv]=resurser,konnector-resurs,kontaktresurs,kalenderresurs,anteckningsresurs,IMAP
 Keywords[ta]=மூலங்கள்,இணைப்பு மூலம்,தொடர்பு மூலம்,நாள்காட்டி மூலம்,குறிப்புகள் மூலம்e,imap
 Keywords[uk]=ресурси,ресурс для konnector,ресурс контактів,ресурс календаря,ресурс приміток,imap
diff -urN -x CVS kdelibs.orig/kresources/kresources_plugin.desktop kdelibs/kresources/kresources_plugin.desktop
--- kdelibs.orig/kresources/kresources_plugin.desktop	Tue Aug 24 08:29:33 2004
+++ kdelibs/kresources/kresources_plugin.desktop	Sat Oct 30 08:38:17 2004
@@ -3,6 +3,7 @@
 Type=ServiceType
 X-KDE-ServiceType=KResources/Plugin
 Comment=KResource Framework Plugin
+Comment[af]=KHulpbron Raamwerk Inprop module
 Comment[az]=KResource Əlavəsi
 Comment[bg]=Приставка за ресурсната системата KResource Framework
 Comment[bn]=কে-রিসোর্স ফ্রেম-ওয়ার্ক প্লাগ-ইন
@@ -30,6 +31,7 @@
 Comment[ja]=K リソース・フレームワーク・プラグイン
 Comment[ko]=K자원 프레임워크 플러그인
 Comment[lt]=KResource struktūros priedas
+Comment[mk]=KResource рамковен приклучок
 Comment[mn]=Нөөц Тодорхойлох-Файлын плугин (RDF)
 Comment[ms]=Plug masuk Kerangka KResource
 Comment[nb]=KRessursrammeverk tilleggsprogram
@@ -45,7 +47,7 @@
 Comment[sl]=Vstavek za ogrodje KResource
 Comment[sq]=Shtojca KResource Framework
 Comment[sr]=Прикључак KResource Framework-а
-Comment[sr@Latn]=Dodatak KResource Framework-a
+Comment[sr@Latn]=Priključak KResource Framework-a
 Comment[sv]=Insticksprogram för resursramverk
 Comment[ta]=கேவழிமுறை கட்டமைப்பு சொருகுபொருள்
 Comment[tg]=Мутассалкунандаи қолабгар барои KResource
diff -urN -x CVS kdelibs.orig/ksmartcard/kardimpl/kcardgemsafe.desktop kdelibs/ksmartcard/kardimpl/kcardgemsafe.desktop
--- kdelibs.orig/ksmartcard/kardimpl/kcardgemsafe.desktop	Mon Sep 20 15:53:26 2004
+++ kdelibs/ksmartcard/kardimpl/kcardgemsafe.desktop	Fri Nov 12 08:27:53 2004
@@ -9,6 +9,7 @@
 X-KDE-Smartcard-SubType=gem2
 X-KDE-Smartcard-SubSubType=gem3
 Name=GemSafe Card Implementation
+Name[af]=Gemsafe Kaart implementering
 Name[bg]=Реализация на карта GemSafe
 Name[bn]=জেম-সেফ কার্ড ইমপ্লিমেন্টেশন
 Name[bs]=GemSafe Card implementacija
@@ -26,7 +27,10 @@
 Name[is]=GemSafe Kortameðhöndlun
 Name[it]=Implementazione schede GemSafe
 Name[ja]=GemSafeカードインプリメンテーション
+Name[lt]=GemSafe kortos realizacija
+Name[mk]=GemSafe Card имплементација
 Name[nb]=GemSafe kortimplementasjon
+Name[nds]=Ünnerstütten för GemSafe-Koorten
 Name[nl]=GemSafe kaartimplementatie
 Name[nn]=GemSafe-kortimplementasjon
 Name[pa]=GemSafe ਕਾਰਡ ਸਥਾਪਨ
@@ -34,11 +38,12 @@
 Name[pt]=Implementação da Placa GemSafe
 Name[pt_BR]=Implementação da Placa GemSafe
 Name[ro]=Implementare card GemSafe
+Name[ru]=Реализация GemSafe Card
 Name[se]=GemSafe-goarta implementašuvdna
 Name[sk]=Implementácia karty GemSafe
 Name[sl]=Implementacija kartice GemSafe
 Name[sr]=Имплементација GemSafe картице
-Name[sr@Latn]=Имплементација GemSafe картице
+Name[sr@Latn]=Implementacija GemSafe kartice
 Name[sv]=GemSafe-kortimplementation
 Name[ta]=GemSafe அட்டை அமலாக்கம்
 Name[tg]=Пиёдасозии корти GemSafe
diff -urN -x CVS kdelibs.orig/ksmartcard/kardimpl/kcardgsm.desktop kdelibs/ksmartcard/kardimpl/kcardgsm.desktop
--- kdelibs.orig/ksmartcard/kardimpl/kcardgsm.desktop	Mon Sep 20 15:53:26 2004
+++ kdelibs/ksmartcard/kardimpl/kcardgsm.desktop	Fri Nov 12 08:27:53 2004
@@ -9,6 +9,7 @@
 X-KDE-Smartcard-SubType=gsm2
 X-KDE-Smartcard-SubSubType=gsm3
 Name=GSM Card Implementation
+Name[af]=GSM Kaart implementering
 Name[bg]=Реализация на карта GSM
 Name[bn]=জি-এস-এম কার্ড ইমপ্লিমেন্টেশন
 Name[bs]=GSM Card implementacija
@@ -26,7 +27,10 @@
 Name[is]=GSM korttenging
 Name[it]=Implementazione schede GSM
 Name[ja]=GSMカードインプリメンテーション
+Name[lt]=GSM kortos realizacija
+Name[mk]=GSM Card имплементација
 Name[nb]=GSM kortimplementasjon
+Name[nds]=Ünnerstütten för GSM-Koorten
 Name[nl]=GSM-kaartimplementatie
 Name[nn]=GSM-kortimplementasjon
 Name[pa]=GSM ਕਾਰਡ ਸਥਾਪਨ
@@ -34,11 +38,12 @@
 Name[pt]=Implementação da Placa GSM
 Name[pt_BR]=Implementação da Placa GSM
 Name[ro]=Implementare card GSM
+Name[ru]=Реализация GSM Card
 Name[se]=GSM-goarta implementašuvdna
 Name[sk]=Implementácia karty GSM
 Name[sl]=Implementacija kartice GSM
 Name[sr]=Имплементација GSM картице
-Name[sr@Latn]=Имплементација GSM картице
+Name[sr@Latn]=Implementacija GSM kartice
 Name[sv]=GSM-kortimplementation
 Name[ta]=GSM அட்டை அமலாக்கம்
 Name[tg]=Пиёдасозии корти GSM
diff -urN -x CVS kdelibs.orig/ksmartcard/kardsvc/kardsvc.desktop kdelibs/ksmartcard/kardsvc/kardsvc.desktop
--- kdelibs.orig/ksmartcard/kardsvc/kardsvc.desktop	Tue Aug 31 09:21:39 2004
+++ kdelibs/ksmartcard/kardsvc/kardsvc.desktop	Sat Oct 30 08:38:17 2004
@@ -36,9 +36,11 @@
 Name[ko]=KDE 스마트카드 서비스
 Name[lt]=KDE gudrių kortelių tarnyba
 Name[lv]=KDE Smartkaršu Serviss
+Name[mk]=KDE сервис за паметни картички
 Name[ms]=Servis Kad Pintar KDE
 Name[mt]=Servizz KDE tal-ismartcards
 Name[nb]=KDE smartkorttjeneste
+Name[nds]=KDE Smartcard-Deenst
 Name[nl]=KDE Chipkaart Service
 Name[nn]=KDE Smartkortteneste
 Name[nso]=Tirelo ya Karata ye Botsana ya KDE
@@ -100,10 +102,12 @@
 Comment[ko]=KDE와 KDE 응용 프로그램을 위한 스마트카드 서비스
 Comment[lt]=Gudrių kortelių tarnybos, skirtos KDE bei taikomosioms KDE programoms
 Comment[lv]=Smartkaršu Servisi priekš KDE un KDE Aplikācijām
+Comment[mk]=Сервиси за паметни картички за KDE и KDE апликации
 Comment[mn]=KDE болон KDE программын Smartcard-Services
 Comment[ms]=Servis Kad Pintar KDE dan Aplikasi KDE
 Comment[mt]=Servizzi ta' smartcards għall-KDE u programmi tiegħu
 Comment[nb]=Smartkorttjeneste for KDE og KDE-programmer
+Comment[nds]=Smartcard-Deensten för KDE un KDE-Programmen
 Comment[nl]=Chipkaartenservices voor KDE en KDE-toepassingen
 Comment[nn]=Smartkorttenester for KDE og KDE-program
 Comment[nso]=Ditirelo tsa KDE tsa Karata ye Botsana le Ditshomiso tsa KDE
diff -urN -x CVS kdelibs.orig/kspell2/kspellclient.desktop kdelibs/kspell2/kspellclient.desktop
--- kdelibs.orig/kspell2/kspellclient.desktop	Sun Sep 12 15:56:12 2004
+++ kdelibs/kspell2/kspellclient.desktop	Fri Nov 12 08:27:53 2004
@@ -4,6 +4,7 @@
 X-KDE-ServiceType=KSpell/Client
 X-KDE-Derived=KPluginInfo
 Comment=KSpell Client
+Comment[af]=KSpel Klient
 Comment[be]=Кліент KSpell
 Comment[bg]=Клиент на KSpell
 Comment[bn]=কে-স্পেল ক্লায়েন্ট
@@ -18,23 +19,28 @@
 Comment[et]=KSpelli klient
 Comment[fi]=KSpell-asiakasohjelma
 Comment[fr]=Client KSpell
+Comment[ga]=Cliant KSpell
 Comment[he]=לקוח KSpell
 Comment[hu]=KSpell-kliens
 Comment[is]=KSpell biðlarinn
 Comment[it]=Client KSpell
 Comment[ja]=KSpell クライアント
+Comment[lt]=KSpell klientas
+Comment[mk]=KSpell клиент
 Comment[nb]=KSpell-klient
+Comment[nds]=KSpell-Deenstprogramm
 Comment[nn]=KSpell-klient
 Comment[pa]=KSpell ਕਲਾਂਇਟ
 Comment[pl]=Klient KSpell
 Comment[pt]=Cliente do KSpell
 Comment[pt_BR]=Cliente KSpell
 Comment[ro]=Client KSpell
+Comment[ru]=Клиент KSpell
 Comment[se]=KSpell-klienta
 Comment[sk]=Klient KSpell
 Comment[sl]=Odjemnik KSpell
 Comment[sr]=KSpell-ов клијент
-Comment[sr@Latn]=KSpell-ов клијент
+Comment[sr@Latn]=KSpell-ov klijent
 Comment[sv]=Kspell-klient
 Comment[ta]=ஓட்டு எழுத்தாக்கம்
 Comment[tg]=Клиенти KSpell
diff -urN -x CVS kdelibs.orig/kstyles/keramik/keramik.cpp kdelibs/kstyles/keramik/keramik.cpp
--- kdelibs.orig/kstyles/keramik/keramik.cpp	Thu Jul 29 18:46:20 2004
+++ kdelibs/kstyles/keramik/keramik.cpp	Sun Nov 28 18:00:50 2004
@@ -31,7 +31,7 @@
    Boston, MA 02111-1307, USA.
 */
 
-// $Id$
+// $Id$
 
 #include <qbitmap.h>
 #include <qcheckbox.h>
@@ -290,9 +290,8 @@
 
 	if (animateProgressBar)
 	{
-		QTimer* timer = new QTimer( this );
-		timer->start(50, false);
-		connect(timer, SIGNAL(timeout()), this, SLOT(updateProgressPos()));
+		animationTimer = new QTimer( this );
+		connect( animationTimer, SIGNAL(timeout()), this, SLOT(updateProgressPos()) );
 	}
 	
 	firstComboPopupRelease = false;
@@ -302,6 +301,7 @@
 {
 	//Update the registered progressbars.
 	QMap<QProgressBar*, int>::iterator iter;
+	bool visible = false;
 	for (iter = progAnimWidgets.begin(); iter != progAnimWidgets.end(); iter++)
 	{
 		QProgressBar* pbar = iter.key(); 
@@ -313,7 +313,12 @@
 				iter.data() = 0;
 			iter.key()->update();
 		}
+		if (iter.key()->isVisible())
+			visible = true;
+		
 	}
+	if (!visible)
+		animationTimer->stop();
 }
 
 KeramikStyle::~KeramikStyle()
@@ -360,8 +365,11 @@
 
 	if (animateProgressBar && ::qt_cast<QProgressBar*>(widget))
 	{
+		widget->installEventFilter(this);
 		progAnimWidgets[static_cast<QProgressBar*>(widget)] = 0;
 		connect(widget, SIGNAL(destroyed(QObject*)), this, SLOT(progressBarDestroyed(QObject*)));
+		if (!animationTimer->isActive())
+			animationTimer->start( 50, false );
 	}
 
 	KStyle::polish(widget);
@@ -2912,6 +2920,14 @@
 		return true;
 
 	}
+	// Track show events for progress bars
+	if ( animateProgressBar && ::qt_cast<QProgressBar*>(object) )
+	{
+		if ((event->type() == QEvent::Show) && !animationTimer->isActive())
+		{
+			animationTimer->start( 50, false );
+		}
+	}
 	return false;
 }
 
diff -urN -x CVS kdelibs.orig/kstyles/keramik/keramik.h kdelibs/kstyles/keramik/keramik.h
--- kdelibs.orig/kstyles/keramik/keramik.h	Thu Jul 29 18:44:11 2004
+++ kdelibs/kstyles/keramik/keramik.h	Sat Nov 27 18:44:42 2004
@@ -27,7 +27,7 @@
    Boston, MA 02111-1307, USA.
 */
 
-// $Id$
+// $Id$
 
 #ifndef __keramik_h__
 #define __keramik_h__
@@ -190,6 +190,9 @@
 
 
 	bool kickerMode;
+	
+	// For progress bar animation
+	QTimer *animationTimer;
 
 	QRect subRect(SubRect r, const QWidget *widget) const;
 
diff -urN -x CVS kdelibs.orig/kstyles/riscos/riscos.themerc kdelibs/kstyles/riscos/riscos.themerc
--- kdelibs.orig/kstyles/riscos/riscos.themerc	Tue Aug 24 08:29:40 2004
+++ kdelibs/kstyles/riscos/riscos.themerc	Sat Oct 30 08:38:18 2004
@@ -277,10 +277,12 @@
 Comment[ko]=리스크 OS 같은 테마
 Comment[lt]=Panašus į RISC OS stilius
 Comment[lv]=RISC OS-līdzīga tēma
+Comment[mk]=Тема што личи на RISC OS
 Comment[mn]=RISC OS-той төсөөтэй хэлбэр
 Comment[ms]=Tema ala RISC OS
 Comment[mt]=Tema bħar-RISC OS
 Comment[nb]=RISCO OS-lignende tema
+Comment[nds]=Muster as in't RISC OS
 Comment[nl]=RISC OS-achtig thema
 Comment[nn]=RISC OS-aktig tema
 Comment[nso]=Molaetsa wago swana le RISC OS
diff -urN -x CVS kdelibs.orig/kstyles/themes/b3.themerc kdelibs/kstyles/themes/b3.themerc
--- kdelibs.orig/kstyles/themes/b3.themerc	Tue Aug 24 08:29:40 2004
+++ kdelibs/kstyles/themes/b3.themerc	Sat Oct 30 08:38:18 2004
@@ -4,7 +4,6 @@
 Name[bn]=বি-৩/কে.ডি.ই.
 Name[fr]=B3 / KDE
 Name[hi]=B3/केडीई 
-Name[mk]=Б3/KDE
 Name[ta]=B3/கேடிஇ
 Comment=B3/Modification of B2
 Comment[af]=B3/Verandering van B2
@@ -38,11 +37,12 @@
 Comment[ja]=B3 B2の改良版
 Comment[lt]=B3 – B2 modifikacija
 Comment[lv]=B2 B3/Modifikācija
-Comment[mk]=Б3/Модификација на Б2
+Comment[mk]=B3/Модификација на B2
 Comment[mn]=B3: B2-н нэгэн хувилбар
 Comment[ms]=B3/Ubahsuaian B2
 Comment[mt]=B3/modifikazzjoni ta' B2
 Comment[nb]=B3/Endring av B2
+Comment[nds]=B3 is en ännert B2
 Comment[nl]=B3/modificatie van B2
 Comment[nn]=B3 / Endring av B2
 Comment[nso]=B3/Kaonafatso ya B2
diff -urN -x CVS kdelibs.orig/kstyles/themes/beos.themerc kdelibs/kstyles/themes/beos.themerc
--- kdelibs.orig/kstyles/themes/beos.themerc	Tue Aug 24 08:29:40 2004
+++ kdelibs/kstyles/themes/beos.themerc	Sat Oct 30 08:38:18 2004
@@ -4,6 +4,8 @@
 Name[hi]=बीईओएस (BeOS)
 Name[th]=ระบบปฏิบัติการ BeOS
 Comment=Unthemed BeOS-like style
+Comment[af]=Onbenoemde BeOS-tipe styl
+Comment[ar]=مظهر مشابه لBeOS
 Comment[az]=Örtüksüz BeOS bənzəri tərz
 Comment[be]=Стыль падобны на BeOS (бяз тэм)
 Comment[bg]=Стил без тема, подобен на BeOS
@@ -21,6 +23,7 @@
 Comment[fa]=سبک شبیه Beos بدون طرح
 Comment[fi]=Teemoittamaton BeOS:n kaltainen tyyli
 Comment[fr]=Style sans thème similaire à BeOS
+Comment[ga]=Stíl gan téama, cosúil le BeOS
 Comment[gl]=Estilo tipo Beos sen tema
 Comment[he]=סגנון דומה ל-BeOS ללא ערכה
 Comment[hi]=अनथीम्ड बीईओएस जैसी शैली
@@ -31,9 +34,11 @@
 Comment[ja]=テーマでないBeOSのようなスタイル
 Comment[ko]=BeOS와 같은 꼴을 가진 테마
 Comment[lt]=Betemis BeOS tipo stilius
+Comment[mk]=Beos стил (без тема)
 Comment[mn]=BeOS-хэлбэрийн агшаалт
 Comment[ms]=Gaya BeOS
 Comment[nb]=Innebygget BeOS-liknende stil
+Comment[nds]=Stil as in't BeOS (ahn Muster)
 Comment[nl]=Themaloze BeOS-achtige stijl
 Comment[nn]=BeOS-aktig stil utan tema
 Comment[pa]=BeOS-ਵਰਗੀ ਸ਼ੈਲੀ
diff -urN -x CVS kdelibs.orig/kstyles/themes/default.themerc kdelibs/kstyles/themes/default.themerc
--- kdelibs.orig/kstyles/themes/default.themerc	Tue Aug 24 08:29:40 2004
+++ kdelibs/kstyles/themes/default.themerc	Sat Oct 30 08:38:18 2004
@@ -1,5 +1,7 @@
 [Misc]
 Name=KDE Classic
+Name[af]=KDE Klassiek
+Name[ar]=كيدي كلاسيكي
 Name[az]=KDE Klassik
 Name[be]=Клясычны KDE
 Name[bn]=কে.ডি.ই. ক্লাসিক
@@ -26,6 +28,7 @@
 Name[ja]=KDE クラシック
 Name[ko]=KDE 기본
 Name[lt]=Klasikinė KDE
+Name[mk]=KDE класично
 Name[mn]=KDE-сонгодог
 Name[ms]=KDE Klasik
 Name[nb]=KDE-klassisk
@@ -52,6 +55,8 @@
 Name[zh_CN]=KDE 经典
 Name[zh_TW]=KDE 預設
 Comment=Classic KDE style
+Comment[af]=Klassieke KDE styl
+Comment[ar]=مظهر كيدي الكلاسيكي
 Comment[az]=Klassik KDE tərzi
 Comment[be]=Клясычны стыль KDE
 Comment[bg]=Класически стил на КДЕ
@@ -83,10 +88,11 @@
 Comment[ja]=クラシックKDEスタイル
 Comment[ko]=KDE에서 기본으로 쓰는 모양새
 Comment[lt]=Klasikinis KDE stilius
+Comment[mk]=Класичен KDE стил
 Comment[mn]=KDE-сонгодог хэлбэр
 Comment[ms]=Gaya KDE Klasik
 Comment[nb]=Klassisk KDE-stil
-Comment[nds]=De klasssche KDE-Stil
+Comment[nds]=De klassche KDE-Stil
 Comment[nl]=Klassieke KDE-stijl
 Comment[nn]=Klassisk KDE-stil
 Comment[pa]=ਟਕਸਾਲੀ KDE ਸ਼ੈਲੀ
diff -urN -x CVS kdelibs.orig/kstyles/themes/highcolor.themerc kdelibs/kstyles/themes/highcolor.themerc
--- kdelibs.orig/kstyles/themes/highcolor.themerc	Tue Aug 24 08:29:40 2004
+++ kdelibs/kstyles/themes/highcolor.themerc	Sat Oct 30 08:38:18 2004
@@ -1,5 +1,7 @@
 [Misc]
 Name=HighColor Classic
+Name[af]=Hoë-kontras Klassiek
+Name[ar]=كلاسيكي عالي الألوان
 Name[az]=Zəngin Rəngli Klassik
 Name[bn]=হাই-কালার ক্লাসিক
 Name[br]=Livioù uhel dre ziouer
@@ -28,6 +30,7 @@
 Name[ja]=ハイカラークラシック
 Name[ko]=기본 많은 색
 Name[lt]=Klasikinis aukštos spalvų gebos
+Name[mk]=Високобојно класично
 Name[mn]=64000 өнгөт сонгодог
 Name[ms]=Klasik Warna Cerah
 Name[nb]=Mangefarget klassisk
@@ -53,6 +56,8 @@
 Name[zh_CN]=高色彩经典
 Name[zh_TW]=預設的高彩
 Comment=Highcolor version of the classic style
+Comment[af]=Hoë-kontras weergawe van die klassieke styl
+Comment[ar]=نسخة عالية الألوان من المظهر الكلاسيكي
 Comment[az]=Klassik tərzin zəngin rəngli buraxılışı
 Comment[bg]=Класически стил на КДЕ с високо качество на цветовете
 Comment[bn]=ক্লাসিক স্টাইলের হাই-কালার সংস্করণ
@@ -83,10 +88,11 @@
 Comment[ja]=クラシックスタイルのハイカラーバージョン
 Comment[ko]=기본 모양새를 많은 색으로 만든 것
 Comment[lt]=Klasikinio stiliaus aukštos spalvų gebos versija
+Comment[mk]=Високобојна верзија на класичниот стил
 Comment[mn]=64000-Өнгөт-сонгодог хэлбэрийн хувилбар
 Comment[ms]=Versi warna cerah untuk gaya klasik
 Comment[nb]=Mangefarget-versjon av klassisk stil
-Comment[nds]=Highcolor-Verschoon vun de klasssche Stil
+Comment[nds]=Highcolor-Verschoon vun den klasschen Stil
 Comment[nl]=Hoge-kleuren-versie van de klassieke stijl
 Comment[nn]=Klassisk stil med mange fargar
 Comment[pa]=ਜਿਆਦਾ ਗੂੜੇ ਰੰਗਾਂ ਵਾਲ ਟਕਸਾਲੀ ਸ਼ੈਲੀ
diff -urN -x CVS kdelibs.orig/kstyles/themes/keramik.themerc kdelibs/kstyles/themes/keramik.themerc
--- kdelibs.orig/kstyles/themes/keramik.themerc	Tue Aug 24 08:29:40 2004
+++ kdelibs/kstyles/themes/keramik.themerc	Sat Oct 30 08:38:18 2004
@@ -9,6 +9,7 @@
 Name[hi]=केरमिक
 Name[ko]=K세라믹
 Name[lv]=Keramika
+Name[mk]=Керамик
 Name[mn]=Керамик
 Name[nn]=Keramikk
 Name[pa]=ਕੀਰਾਮਿਕ
@@ -23,6 +24,8 @@
 Name[uz]=Керамика
 ConfigPage=kstyle_keramik_config
 Comment=The default style using alphablending
+Comment[af]=Die standaard styl wat alfa vermenging gebruik
+Comment[ar]=المظهر الإفتراضي باستعمال alphablending
 Comment[az]=Alfa şəffaflıq işlədən ön qurğulu tərz
 Comment[bg]=Стандартния стил, използващ алфа сливане
 Comment[bn]= ডিফল্ট ধরন,স্টাইল
@@ -51,6 +54,7 @@
 Comment[ja]=アルファブレンディングを使用した標準スタイル
 Comment[ko]=알파 블렌딩을 쓰는 기본 꼴
 Comment[lt]=Numatytas stilius, naudojantis alfa spalvų maišymą
+Comment[mk]=Стандардниот стил кој користи алфа-мешање
 Comment[mn]=Стандарт alphablending хэрэглэдэг хэлбэр
 Comment[ms]=Gaya default menggunakan cerai-alfa
 Comment[nb]=En standard stil som bruker alfablending
diff -urN -x CVS kdelibs.orig/kstyles/themes/kstep.themerc kdelibs/kstyles/themes/kstep.themerc
--- kdelibs.orig/kstyles/themes/kstep.themerc	Tue Aug 31 09:21:41 2004
+++ kdelibs/kstyles/themes/kstep.themerc	Sun Oct 24 09:02:03 2004
@@ -60,6 +60,7 @@
 Comment[ms]=Gaya Next
 Comment[mt]=Stil bla tema simili għan-Next
 Comment[nb]=Innebygget Next-lignende stil
+Comment[nds]=Stil as Next (ahn Muster)
 Comment[nl]=Themaloze Next-stijl
 Comment[nn]=Next-aktig stil utan tema
 Comment[nso]=Mokgwa wo osenago molaetsa wago swana le Latelago
diff -urN -x CVS kdelibs.orig/kstyles/themes/light-v2.themerc kdelibs/kstyles/themes/light-v2.themerc
--- kdelibs.orig/kstyles/themes/light-v2.themerc	Tue Aug 24 08:29:40 2004
+++ kdelibs/kstyles/themes/light-v2.themerc	Sat Oct 30 08:38:18 2004
@@ -29,10 +29,11 @@
 Name[ko]=가벼운 꼴, 두번째 판
 Name[lt]=Lengvas stilius, 2-as variantas
 Name[lv]=Gaismas Stils, 2-ā revīzija
+Name[mk]=Лесен стил, 2-ра ревизија
 Name[mn]=Хөнгөн хэлбэр, 2. үзлэг
 Name[mt]=Stil ħafif, 2ni reviżjoni
 Name[nb]=Lett stil, 2. utgave
-Name[nds]=Light Style, 2. Revischoon
+Name[nds]=Light-Stil, 2. Överarbeiden
 Name[nl]=Light Style, 2e herziening
 Name[nn]=Lett-stil, 2. utgåve
 Name[nso]=Mokgwa wo Bofefo, ponoleswa ya bobedi
@@ -90,10 +91,12 @@
 Comment[ko]=뽐 내지 않고 멋진 '가벼운' 위젯 꼴, 두번째 판.
 Comment[lt]=Paprasto ir elegantiško „lengvo“ valdiklio stiliaus antras variantas.
 Comment[lv]= Vienkāršā un elegantā 'Gaismas' vidžeta stila otrā revīzija.
+Comment[mk]=Втора ревизија на едноставниот и елегантен „Лесен“ стил.
 Comment[mn]=Энгийн ухаалаг "Хөнгөн хэлбэрүүд"-н хоёрдугаар хувилбар
 Comment[ms]=Revisi kedua untuk gaya wijet 'Light' yang ringkas dan elegan.
 Comment[mt]=It-tieni reviżjoni tal-istil sempliċi u eleganti "Light"
 Comment[nb]=Andre utgave av den enkle og elegante elementstilen «Lett».
+Comment[nds]=Tweet Överarbeiden vun den eenfachen un smucken 'Light'-Stil.
 Comment[nl]=Tweede herziening van de eenvoudige en elegante widgetstijl 'Light'
 Comment[nn]=Andre utgåva av den enkle og elegante stilen «Lett».
 Comment[nso]=Ponoleswa ya bobedi ya mokgwa wa widget wo bonolo wo botsana ebile wo 'Bofefo'.
diff -urN -x CVS kdelibs.orig/kstyles/themes/light-v3.themerc kdelibs/kstyles/themes/light-v3.themerc
--- kdelibs.orig/kstyles/themes/light-v3.themerc	Tue Aug 24 08:29:40 2004
+++ kdelibs/kstyles/themes/light-v3.themerc	Sat Oct 30 08:38:18 2004
@@ -29,10 +29,11 @@
 Name[ko]=가벼운 꼴, 세번째 판
 Name[lt]=Lengvas stilius, 3-ias variantas
 Name[lv]=Gaismas Stils, 3-ā revīzija
+Name[mk]=Лесен стил, 3-та ревизија
 Name[mn]=Хөнгөн хэлбэр, 3. үзлэг
 Name[mt]=Stil ħafif, 3et reviżjoni
 Name[nb]=Lett stil, 3.utgave
-Name[nds]=Light Style, (3. Revischoon)
+Name[nds]=Light-Stil, 3. Överarbeiden
 Name[nl]=Light Style, 3e herziening
 Name[nn]=Lett-stil, 3. utgåve
 Name[nso]=Mokgwa wo Bofefo, ponoleswa ya boraro
@@ -90,10 +91,12 @@
 Comment[ko]=뽐 내지 않고 멋진 '가벼운' 위젯 꼴, 세번째 판.
 Comment[lt]=Paprasto ir elegantiško „lengvo“ valdiklio stiliaus trečias variantas.
 Comment[lv]= Vienkāršā un elegantā 'Gaismas' vidžeta stila trešā revīzija.
+Comment[mk]=Трета ревизија на едноставниот и елегантен „Лесен“ стил.
 Comment[mn]=Энгийн ухаалаг "Хөнгөн хэлбэрүүд"-н гуравдугаар хувилбар
 Comment[ms]=Revisi ketiga untuk gaya wijet 'Light' yang ringkas dan elegan.
 Comment[mt]=It-tielet reviżjoni tal-istil sempliċi u eleganti "Light"
 Comment[nb]=Tredje utgave av den enkle og elegante elementstilen «Lett».
+Comment[nds]=Drütt Överarbeiden vun den eenfachen un smucken 'Light'-Stil.
 Comment[nl]=Derde herziening van de eenvoudige en elegante widgetstijl 'Light'
 Comment[nn]=Tredje utgåva av den enkle og elegante stilen «Lett».
 Comment[nso]=Ponoleswa ya boraro ya mokgwa wa widget wo bonolo wo mmotsana ebile wo 'Bofefo'.
diff -urN -x CVS kdelibs.orig/kstyles/themes/marble.themerc kdelibs/kstyles/themes/marble.themerc
--- kdelibs.orig/kstyles/themes/marble.themerc	Tue Aug 24 08:29:40 2004
+++ kdelibs/kstyles/themes/marble.themerc	Sat Oct 30 08:38:18 2004
@@ -241,11 +241,12 @@
 Comment[ko]=밝은 대리석 테마 꼴
 Comment[lt]=Teminis šviesaus marmuro stilius
 Comment[lv]=Stils ar gaišā marmora tēmu
-Comment[mk]=Стил со светол мермер
+Comment[mk]=Лесен стил со светол мермер
 Comment[mn]=Гэгээтэй Гантиг хэлбэр
 Comment[ms]=Gaya tema marmar cerah
 Comment[mt]=Stil b'tema ta' rħam
 Comment[nb]=Lett marmor-stil med tema
+Comment[nds]=Stil un Muster as hellen Marmor
 Comment[nl]=Thema met een lichtgemarmerde stijl
 Comment[nn]=Lett marmorstil med tema
 Comment[nso]=Mokgwa wo onago le molaetsa wa mmabolo wo bofefo
diff -urN -x CVS kdelibs.orig/kstyles/themes/mega.themerc kdelibs/kstyles/themes/mega.themerc
--- kdelibs.orig/kstyles/themes/mega.themerc	Tue Aug 24 08:29:40 2004
+++ kdelibs/kstyles/themes/mega.themerc	Sat Oct 30 08:38:18 2004
@@ -25,10 +25,12 @@
 Name[ja]=MegaGradient ハイカラースタイル
 Name[lt]=MegaGradient aukštos spalvų gebos stilius
 Name[lv]=MegaGradient augstkrāsu stils
+Name[mk]=MegaGradient високобоен стил
 Name[mn]=МигаГрадиент (64000-Өнгө-Хэлбэр)
 Name[ms]=Gaya MegaGradient warna cerah
 Name[mt]=Stil MegaGradient
 Name[nb]=MegaGradient mangefargestil
+Name[nds]=MegaGradient-Stil (Highcolor)
 Name[nl]=MegaGradiënt hogekleurenstijl
 Name[nn]=MegaGradient-stil med mange fargar
 Name[nso]=Mokgwa wa kholoro ya godimo ya MegaGradient
diff -urN -x CVS kdelibs.orig/kstyles/themes/qtcde.themerc kdelibs/kstyles/themes/qtcde.themerc
--- kdelibs.orig/kstyles/themes/qtcde.themerc	Tue Aug 24 08:29:40 2004
+++ kdelibs/kstyles/themes/qtcde.themerc	Sun Oct 24 09:02:03 2004
@@ -41,6 +41,7 @@
 Comment[ms]=Gaya CDE bina dalam
 Comment[mt]=Stil bla tema CDE
 Comment[nb]=Innebygget CDE-stil uten tema
+Comment[nds]=Inbuut CDE-Stil (ahn Muster)
 Comment[nl]=Ingebouwde, themaloze CDE-stijl
 Comment[nn]=Innebygd CDE-stil utan tema
 Comment[nso]=Mokgwa wa CDE wa kagelogare wo osenago molaetsa
diff -urN -x CVS kdelibs.orig/kstyles/themes/qtmotif.themerc kdelibs/kstyles/themes/qtmotif.themerc
--- kdelibs.orig/kstyles/themes/qtmotif.themerc	Tue Aug 24 08:29:40 2004
+++ kdelibs/kstyles/themes/qtmotif.themerc	Sun Oct 24 09:02:03 2004
@@ -45,6 +45,7 @@
 Comment[ms]=Gaya Motif bina dalam
 Comment[mt]=Stil bla tema Motif
 Comment[nb]=Innebygget Motif-stil uten tema
+Comment[nds]=Inbuut Motif-Stil (ahn Muster)
 Comment[nl]=Ingebouwde, themaloze Motifstijl
 Comment[nn]=Innebygd Motif-stil utan tema
 Comment[nso]=Mokgwa wa Motif wa kagelogare wo osenago molaetsa
diff -urN -x CVS kdelibs.orig/kstyles/themes/qtmotifplus.themerc kdelibs/kstyles/themes/qtmotifplus.themerc
--- kdelibs.orig/kstyles/themes/qtmotifplus.themerc	Tue Aug 24 08:29:41 2004
+++ kdelibs/kstyles/themes/qtmotifplus.themerc	Sat Oct 30 08:38:18 2004
@@ -45,11 +45,12 @@
 Comment[ko]=더 나은 모티프와 같은 꼴을 가진 붙박이 테마
 Comment[lt]=Įtaisytas išplėstas Motif stilius
 Comment[lv]=Iebūvēts uzlabots Motif stils
-Comment[mk]=Вграден напреднат Motif стил
+Comment[mk]=Вграден напреден Motif стил
 Comment[mn]=Агшаалттай суулгасан Motif-хэлбэр
 Comment[ms]=Gaya Motif bina dalam lanjut
 Comment[mt]=Stil Motif estiż
 Comment[nb]=Innebygget utvidet Motif-stil
+Comment[nds]=Inbuut verwiedert Motif-Stil
 Comment[nl]=Ingebouwde verbeterde Motifstijl
 Comment[nn]=Innebygd forbetra Motif-stil
 Comment[nso]=Mokgwa wa kagelogare wo o hlohloleditswego wa Motif
diff -urN -x CVS kdelibs.orig/kstyles/themes/qtplatinum.themerc kdelibs/kstyles/themes/qtplatinum.themerc
--- kdelibs.orig/kstyles/themes/qtplatinum.themerc	Tue Aug 24 08:29:41 2004
+++ kdelibs/kstyles/themes/qtplatinum.themerc	Sun Oct 24 09:02:03 2004
@@ -57,6 +57,7 @@
 Comment[ms]=Gaya Platinum bina dalam
 Comment[mt]=Stil Platinum bla tema
 Comment[nb]=Innebygget Platinum-stil
+Comment[nds]=Inbuut Platin-Stil (ahn Muster)
 Comment[nl]=Ingebouwde themaloze Platinum-stijl
 Comment[nn]=Innebygd Platinum-stil utan tema
 Comment[nso]=Mokgwa wa Platinum wa kagelogare wo osenago molaetsa
diff -urN -x CVS kdelibs.orig/kstyles/themes/qtsgi.themerc kdelibs/kstyles/themes/qtsgi.themerc
--- kdelibs.orig/kstyles/themes/qtsgi.themerc	Tue Aug 24 08:29:41 2004
+++ kdelibs/kstyles/themes/qtsgi.themerc	Sun Oct 24 09:02:03 2004
@@ -42,6 +42,7 @@
 Comment[ms]=Gaya SGI bina dalam
 Comment[mt]=Stil SGI
 Comment[nb]=Innebygget SGI-stil
+Comment[nds]=Inbuut SGI-Stil
 Comment[nl]=Ingebouwde SGI-stijl
 Comment[nn]=Innebygd SGI-stil
 Comment[nso]=Mokgwa wa Kagelo gare wa SGI
diff -urN -x CVS kdelibs.orig/kstyles/themes/qtwindows.themerc kdelibs/kstyles/themes/qtwindows.themerc
--- kdelibs.orig/kstyles/themes/qtwindows.themerc	Tue Aug 31 09:21:41 2004
+++ kdelibs/kstyles/themes/qtwindows.themerc	Sat Oct 30 08:38:18 2004
@@ -43,11 +43,12 @@
 Comment[ko]=윈도우즈 9X와 비슷한 꼴을 가진 붙박이 테마
 Comment[lt]=Įtaisytas betemis Windows 9x stilius
 Comment[lv]=Iebūvēts beztēmas Windows 9x stils
-Comment[mk]=Вграден Windows стил (без тема)
+Comment[mk]=Вграден Windows 9x стил (без тема)
 Comment[mn]=Агшаалттай суулгасан Windows-9x-Хэлбэр
 Comment[ms]=Gaya Windows 9x bina dalam
 Comment[mt]=Stil bla tema Windows 9x
 Comment[nb]=Innebygget Windows 9x-stil
+Comment[nds]=Inbuut Windows 9x-Stil (ahn Muster)
 Comment[nl]=Ingebouwde, themaloze MS-Windows-9x-stijl
 Comment[nn]=Innebygd Windows 9x-stil utan tema
 Comment[nso]=Mokgwa wa Windows 9x wo o agetswego kagare wo osenago molaetsa
diff -urN -x CVS kdelibs.orig/kstyles/themes/system.themerc kdelibs/kstyles/themes/system.themerc
--- kdelibs.orig/kstyles/themes/system.themerc	Tue Aug 24 08:29:41 2004
+++ kdelibs/kstyles/themes/system.themerc	Sat Oct 30 08:38:18 2004
@@ -279,11 +279,12 @@
 Comment[ko]=시스템 운영체제와 같은 꼴을 가진 테마
 Comment[lt]=Sistemos teminis stilius
 Comment[lv]=Stils par sistēmas tēmu
-Comment[mk]=Системски стил (со тема)
+Comment[mk]=Стил Систем (со тема)
 Comment[mn]=Суулгасан System-хэлбэр
 Comment[ms]=Gaya tema System
 Comment[mt]=Stil b'tema tas-sistema
 Comment[nb]=System-stil med tema
+Comment[nds]=Systeemstil
 Comment[nl]=Systeem-thema-stijl
 Comment[nn]=Systemstil
 Comment[nso]=Mokgwa wo o filwego molaetsa ka system
diff -urN -x CVS kdelibs.orig/kstyles/themes/systemalt.themerc kdelibs/kstyles/themes/systemalt.themerc
--- kdelibs.orig/kstyles/themes/systemalt.themerc	Tue Aug 24 08:29:41 2004
+++ kdelibs/kstyles/themes/systemalt.themerc	Sat Oct 30 08:38:18 2004
@@ -249,11 +249,12 @@
 Name[lt]=Sistemos stiliai
 Name[lv]=Sistēmas-Sērijas
 Name[mi]=Huinga-Pünaha
-Name[mk]=Системски стил 001
+Name[mk]=Систем-Серии
 Name[mn]=Систем-Цуваа
 Name[ms]=Siri System
 Name[mt]=Serje Sistema
 Name[nb]=System-serier
+Name[nds]=Systeem-Serie
 Name[nl]=Systeemseries
 Name[nn]=Systemserie
 Name[nso]=Tatelano ya System
@@ -315,7 +316,7 @@
 Comment[ms]=Gaya Sistem 001
 Comment[mt]=Stil sistema 001
 Comment[nb]=System-stil 001
-Comment[nds]=Systemstil 001
+Comment[nds]=Systeemstil 001
 Comment[nl]=Systeemstijl 001
 Comment[nn]=Systemstil 001
 Comment[nso]=Mokgwa wa system 001
diff -urN -x CVS kdelibs.orig/kstyles/web/web.themerc kdelibs/kstyles/web/web.themerc
--- kdelibs.orig/kstyles/web/web.themerc	Tue Aug 24 08:29:42 2004
+++ kdelibs/kstyles/web/web.themerc	Tue Nov  9 08:35:29 2004
@@ -29,10 +29,12 @@
 Name[ko]=웹 꼴
 Name[lt]=Žiniatinklio stilius
 Name[lv]=Web stils
+Name[mk]=Web стил
 Name[mn]=Вэб хэлбэр
 Name[ms]=Gaya Web
 Name[mt]=Stil web
 Name[nb]=Vevstil
+Name[nds]=Web-Stil
 Name[nl]=Webstijl
 Name[nn]=Vevstil
 Name[nso]=Mokgwa wa web
@@ -50,7 +52,7 @@
 Name[sr@Latn]=Veb stil
 Name[sv]=Webbstil
 Name[ta]=வலைப் பாணி
-Name[tg]=Сабки Вэб
+Name[tg]=Услуби Вэб
 Name[th]=รูปแบบเว็บ
 Name[tr]=Web stili
 Name[uk]=Стиль "Тенета"
@@ -91,10 +93,12 @@
 Comment[ko]=웹 위젯 꼴
 Comment[lt]=Žiniatinklio valdiklių stilius
 Comment[lv]=Web vidžeta stils
+Comment[mk]=Стил со елементи како за на веб
 Comment[mn]=Вэбтэй төстэй хэлбэр
 Comment[ms]=Gaya wijet Web 
 Comment[mt]=Stil tal-widgets tal-web
 Comment[nb]=Elementstilen «vev»
+Comment[nds]=Web-Stil för Bedeenelementen
 Comment[nl]=Web widgetstijl
 Comment[nn]=Elementstilen «vev»
 Comment[nso]=Mokgwa wa widget wa web
diff -urN -x CVS kdelibs.orig/kutils/kplugininfo.desktop kdelibs/kutils/kplugininfo.desktop
--- kdelibs.orig/kutils/kplugininfo.desktop	Tue Aug 24 08:29:44 2004
+++ kdelibs/kutils/kplugininfo.desktop	Sat Oct 30 08:38:19 2004
@@ -3,6 +3,8 @@
 Type=ServiceType
 X-KDE-ServiceType=KPluginInfo
 Name=KDE Plugin Information
+Name[af]=KDE Inprop module Informasie
+Name[ar]=معلومات ملحقات كيدي
 Name[az]=KDE Əlavə Mə'lumatı
 Name[be]=Інфармацыя аб дапаўненьні KDE
 Name[bg]=Информация за приставките в КДЕ
@@ -31,8 +33,10 @@
 Name[ja]=KDE プラグイン情報
 Name[ko]=KDE 플러그인 정보
 Name[lt]=KDE priedų informacija
+Name[mk]=KDE Информација за приклучок
 Name[mn]=КДЭ плугин мэдээлэл
 Name[nb]=KDEs informasjon om tilleggsprogram
+Name[nds]=Plugin-Informatschoon
 Name[nl]=KDE-plugininformatie
 Name[nn]=Informasjon om KDE-programtillegg
 Name[pa]=KDE ਪਲੱਗਇਨ ਜਾਣਕਾਰੀ
diff -urN -x CVS kdelibs.orig/kwallet/backend/kwalletbackend.cc kdelibs/kwallet/backend/kwalletbackend.cc
--- kdelibs.orig/kwallet/backend/kwalletbackend.cc	Mon Jul 12 00:31:59 2004
+++ kdelibs/kwallet/backend/kwalletbackend.cc	Sat Nov 27 16:58:10 2004
@@ -1,6 +1,6 @@
 /* This file is part of the KDE project
  *
- * Copyright (C) 2001-2003 George Staikos <staikos@kde.org>
+ * Copyright (C) 2001-2004 George Staikos <staikos@kde.org>
  *
  * This library is free software; you can redistribute it and/or
  * modify it under the terms of the GNU Library General Public
@@ -31,6 +31,8 @@
 
 #include <qfile.h>
 #include <qfileinfo.h>
+#include <qregexp.h>
+
 #include "blowfish.h"
 #include "sha1.h"
 #include "cbc.h"
@@ -262,6 +264,7 @@
 			return i18n("Error validating wallet integrity. Possibly corrupted.");
 		case -5:
 		case -7:
+		case -9:
 			return i18n("Read error - possibly incorrect password.");
 		case -6:
 			return i18n("Decryption error.");
@@ -338,6 +341,7 @@
 		MD5Digest ba;
 		QMap<MD5Digest,QValueList<MD5Digest> >::iterator it;
 		Q_UINT32 fsz;
+		if (hds.atEnd()) return -43;
 		hds.readRawBytes(reinterpret_cast<char *>(d), 16);
 		hds >> fsz;
 		ba.duplicate(reinterpret_cast<char *>(d), 16);
@@ -401,7 +405,7 @@
 	if (fsize < 0 || fsize > long(encrypted.size()) - blksz - 4) {
 		//kdDebug() << "fsize: " << fsize << " encrypted.size(): " << encrypted.size() << " blksz: " << blksz << endl;
 		encrypted.fill(0);
-		return -7;         // file structure error.
+		return -9;         // file structure error.
 	}
 
 	// compute the hash ourself
@@ -522,22 +526,13 @@
 		hashStream << static_cast<Q_UINT32>(i.data().count());
 
 		for (EntryMap::ConstIterator j = i.data().begin(); j != i.data().end(); ++j) {
-			switch (j.data()->type()) {
-			case KWallet::Wallet::Password:
-			case KWallet::Wallet::Stream:
-			case KWallet::Wallet::Map:
-				dStream << j.key();
-				dStream << static_cast<Q_INT32>(j.data()->type());
-				dStream << j.data()->value();
-
-				md5.reset();
-				md5.update(j.key().utf8());
-				hashStream.writeRawBytes(reinterpret_cast<const char*>(&(md5.rawDigest()[0])), 16);
-				break;
-			default:
-				assert(0);
-				break;
-			}
+			dStream << j.key();
+			dStream << static_cast<Q_INT32>(j.data()->type());
+			dStream << j.data()->value();
+
+			md5.reset();
+			md5.update(j.key().utf8());
+			hashStream.writeRawBytes(reinterpret_cast<const char*>(&(md5.rawDigest()[0])), 16);
 		}
 	}
 
@@ -672,12 +667,36 @@
 }
 
 
+QPtrList<Entry> Backend::readEntryList(const QString& key) {
+	QPtrList<Entry> rc;
+
+	if (!_open) {
+		return rc;
+	}
+
+	QRegExp re(key, true, true);
+
+	const EntryMap& map = _entries[_folder];
+	for (EntryMap::ConstIterator i = map.begin(); i != map.end(); ++i) {
+		if (re.exactMatch(i.key())) {
+			rc.append(i.data());
+		}
+	}
+	return rc;
+}
+
+
 bool Backend::createFolder(const QString& f) {
 	if (_entries.contains(f)) {
 		return false;
 	}
 
 	_entries.insert(f, EntryMap());
+
+	KMD5 folderMd5;
+	folderMd5.update(f.utf8());
+	_hashes.insert(MD5Digest(folderMd5.rawDigest()), QValueList<MD5Digest>());
+
 return true;
 }
 
@@ -691,6 +710,18 @@
 		Entry *e = oi.data();
 		emap.remove(oi);
 		emap[newName] = e;
+
+		KMD5 folderMd5;
+		folderMd5.update(_folder.utf8());
+
+		HashMap::iterator i = _hashes.find(MD5Digest(folderMd5.rawDigest()));
+		if (i != _hashes.end()) {
+			KMD5 oldMd5, newMd5;
+			oldMd5.update(oldName.utf8());
+			newMd5.update(newName.utf8());
+			i.data().remove(MD5Digest(oldMd5.rawDigest()));
+			i.data().append(MD5Digest(newMd5.rawDigest()));
+		}
 		return 0;
 	}
 
@@ -706,6 +737,16 @@
 		_entries[_folder][e->key()] = new Entry;
 	}
 	_entries[_folder][e->key()]->copy(e);
+
+	KMD5 folderMd5;
+	folderMd5.update(_folder.utf8());
+
+	HashMap::iterator i = _hashes.find(MD5Digest(folderMd5.rawDigest()));
+	if (i != _hashes.end()) {
+		KMD5 md5;
+		md5.update(e->key().utf8());
+		i.data().append(MD5Digest(md5.rawDigest()));
+	}
 }
 
 
@@ -725,6 +766,15 @@
 	if (fi != _entries.end() && ei != fi.data().end()) {
 		delete ei.data();
 		fi.data().remove(ei);
+		KMD5 folderMd5;
+		folderMd5.update(_folder.utf8());
+
+		HashMap::iterator i = _hashes.find(MD5Digest(folderMd5.rawDigest()));
+		if (i != _hashes.end()) {
+			KMD5 md5;
+			md5.update(key.utf8());
+			i.data().remove(MD5Digest(md5.rawDigest()));
+		}
 		return true;
 	}
 
@@ -749,6 +799,10 @@
 		}
 
 		_entries.remove(fi);
+
+		KMD5 folderMd5;
+		folderMd5.update(f.utf8());
+		_hashes.erase(MD5Digest(folderMd5.rawDigest()));
 		return true;
 	}
 
diff -urN -x CVS kdelibs.orig/kwallet/backend/kwalletbackend.h kdelibs/kwallet/backend/kwalletbackend.h
--- kdelibs.orig/kwallet/backend/kwalletbackend.h	Wed May  5 19:07:20 2004
+++ kdelibs/kwallet/backend/kwalletbackend.h	Wed Nov 10 14:41:24 2004
@@ -1,6 +1,6 @@
 /* This file is part of the KDE project
  *
- * Copyright (C) 2001-2003 George Staikos <staikos@kde.org>
+ * Copyright (C) 2001-2004 George Staikos <staikos@kde.org>
  *
  * This library is free software; you can redistribute it and/or
  * modify it under the terms of the GNU Library General Public
@@ -76,6 +76,10 @@
 
 		// Look up an entry.  Returns null if it doesn't exist.
 		Entry *readEntry(const QString& key);
+		
+		// Look up a list of entries.  Supports wildcards.
+		// You delete the list.
+		QPtrList<Entry> readEntryList(const QString& key);
 
 		// Store an entry.
 		void writeEntry(Entry *e);
diff -urN -x CVS kdelibs.orig/kwallet/client/Makefile.am kdelibs/kwallet/client/Makefile.am
--- kdelibs.orig/kwallet/client/Makefile.am	Sat Aug 30 01:48:34 2003
+++ kdelibs/kwallet/client/Makefile.am	Wed Nov 10 14:41:24 2004
@@ -10,5 +10,5 @@
 
 libkwalletclient_la_METASOURCES = AUTO
 
-include_HEADERS = kwallet.h
+include_HEADERS = kwallet.h kwallettypes.h
 
diff -urN -x CVS kdelibs.orig/kwallet/client/kwallet.cc kdelibs/kwallet/client/kwallet.cc
--- kdelibs.orig/kwallet/client/kwallet.cc	Thu Jan 15 10:31:52 2004
+++ kdelibs/kwallet/client/kwallet.cc	Wed Nov 10 14:41:24 2004
@@ -1,6 +1,6 @@
 /* This file is part of the KDE project
  *
- * Copyright (C) 2002-2003 George Staikos <staikos@kde.org>
+ * Copyright (C) 2002-2004 George Staikos <staikos@kde.org>
  *
  * This library is free software; you can redistribute it and/or
  * modify it under the terms of the GNU Library General Public
@@ -18,6 +18,7 @@
  * Boston, MA 02111-1307, USA.
  */
 
+#include "kwallettypes.h"
 #include "kwallet.h"
 #include <kconfig.h>
 #include <kdebug.h>
@@ -29,8 +30,6 @@
 
 #include <assert.h>
 
-inline const char* dcopTypeName(const QByteArray&) { return "QByteArray"; }
-
 using namespace KWallet;
 
 
@@ -400,6 +399,23 @@
 }
 
 
+int Wallet::readEntryList(const QString& key, QMap<QString, QByteArray>& value) {
+	int rc = -1;
+
+	if (_handle == -1) {
+		return rc;
+	}
+
+	DCOPReply r = _dcopRef->call("readEntryList", _handle, _folder, key);
+	if (r.isValid()) {
+		r.get(value);
+		rc = 0;
+	}
+
+	return rc;
+}
+
+
 int Wallet::renameEntry(const QString& oldName, const QString& newName) {
 	int rc = -1;
 
@@ -438,6 +454,32 @@
 }
 
 
+int Wallet::readMapList(const QString& key, QMap<QString, QMap<QString, QString> >& value) {
+	int rc = -1;
+
+	if (_handle == -1) {
+		return rc;
+	}
+
+	DCOPReply r = _dcopRef->call("readMapList", _handle, _folder, key);
+	if (r.isValid()) {
+		QMap<QString,QByteArray> unparsed;
+		r.get(unparsed);
+		for (QMap<QString,QByteArray>::ConstIterator i = unparsed.begin(); i != unparsed.end(); ++i) {
+			if (!i.data().isEmpty()) {
+				QDataStream ds(i.data(), IO_ReadOnly);
+				QMap<QString,QString> v;
+				ds >> v;
+				value.insert(i.key(), v);
+			}
+		}
+		rc = 0;
+	}
+
+	return rc;
+}
+
+
 int Wallet::readPassword(const QString& key, QString& value) {
 	int rc = -1;
 
@@ -455,6 +497,23 @@
 }
 
 
+int Wallet::readPasswordList(const QString& key, QMap<QString, QString>& value) {
+	int rc = -1;
+
+	if (_handle == -1) {
+		return rc;
+	}
+
+	DCOPReply r = _dcopRef->call("readPasswordList", _handle, _folder, key);
+	if (r.isValid()) {
+		r.get(value);
+		rc = 0;
+	}
+
+	return rc;
+}
+
+
 int Wallet::writeEntry(const QString& key, const QByteArray& value, EntryType entryType) {
 	int rc = -1;
 
@@ -606,12 +665,12 @@
 		return;
 	}
 
-	if (id >= 0) {
+	if (id > 0) {
 		_handle = id;
 		emit walletOpened(true);
-	} else {
+	} else if (id < 0) {
 		emit walletOpened(false);
-	}
+	} // id == 0 => wait
 }
 
 
diff -urN -x CVS kdelibs.orig/kwallet/client/kwallet.h kdelibs/kwallet/client/kwallet.h
--- kdelibs.orig/kwallet/client/kwallet.h	Mon Oct 20 20:46:44 2003
+++ kdelibs/kwallet/client/kwallet.h	Wed Nov 10 14:41:24 2004
@@ -1,6 +1,6 @@
 /* This file is part of the KDE project
  *
- * Copyright (C) 2002-2003 George Staikos <staikos@kde.org>
+ * Copyright (C) 2002-2004 George Staikos <staikos@kde.org>
  *
  * This library is free software; you can redistribute it and/or
  * modify it under the terms of the GNU Library General Public
@@ -22,6 +22,9 @@
 #ifndef _KWALLET_H
 #define _KWALLET_H
 
+#include <qglobal.h>
+#ifdef Q_OS_UNIX
+
 #include <qstring.h>
 #include <qstringlist.h>
 #include <qobject.h>
@@ -301,6 +304,46 @@
 		virtual int readPassword(const QString& key, QString& value);
 
 		/**
+		 *  Read the entries matching @p key from the current folder.
+		 *  The entry format is unknown except that it is either a
+		 *  QByteArray or a QDataStream, which effectively means that
+		 *  it is anything.
+		 *  @param key The key of the entry to read.  Wildcards
+		 *             are supported.
+		 *  @param value A buffer to fill with the value.  The key in
+		 *               the map is the entry key.
+		 *  @return Returns 0 on success, non-zero on error.
+		 *  @since 3.4
+		 */
+		int readEntryList(const QString& key, QMap<QString, QByteArray>& value);
+
+		/**
+		 *  Read the map entry @p key from the current folder.
+		 *  @param key The key of the entry to read.  Wildcards
+		 *             are supported.
+		 *  @param value A buffer to fill with the value.  The key in
+		 *               the map is the entry key.
+		 *  @return Returns 0 on success, non-zero on error.  Will
+		 *          return an error if the key was not originally
+		 *          written as a map.
+		 *  @since 3.4
+		 */
+		int readMapList(const QString& key, QMap<QString, QMap<QString, QString> >& value);
+
+		/**
+		 *  Read the password entry @p key from the current folder.
+		 *  @param key The key of the entry to read.  Wildcards
+		 *             are supported.
+		 *  @param value A buffer to fill with the value.  The key in
+		 *               the map is the entry key.
+		 *  @return Returns 0 on success, non-zero on error.  Will
+		 *          return an error if the key was not originally
+		 *          written as a password.
+		 *  @since 3.4
+		 */
+		int readPasswordList(const QString& key, QMap<QString, QString>& value);
+
+		/**
 		 *  Write @p key = @p value as a binary entry to the current
 		 *  folder.  Be careful with this, it could cause inconsistency
 		 *  in the future since you can put an arbitrary entry type in
@@ -470,5 +513,7 @@
 
 }
 
-#endif
+#endif //Q_OS_UNIX
+
+#endif //_KWALLET_H
 
diff -urN -x CVS kdelibs.orig/kwallet/client/kwallettypes.h kdelibs/kwallet/client/kwallettypes.h
--- kdelibs.orig/kwallet/client/kwallettypes.h	Thu Jan  1 01:00:00 1970
+++ kdelibs/kwallet/client/kwallettypes.h	Wed Nov 10 14:41:24 2004
@@ -0,0 +1,32 @@
+/* This file is part of the KDE project
+ *
+ * Copyright (C) 2004 George Staikos <staikos@kde.org>
+ *
+ * This library is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU Library General Public
+ * License as published by the Free Software Foundation; either
+ * version 2 of the License, or (at your option) any later version.
+ *
+ * This library is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ * Library General Public License for more details.
+ *
+ * You should have received a copy of the GNU Library General Public License
+ * along with this library; see the file COPYING.LIB.  If not, write to
+ * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
+ * Boston, MA 02111-1307, USA.
+ */ 
+
+#ifndef KWALLET_TYPES_H
+#define KWALLET_TYPES_H
+
+#include <qmap.h>
+
+class QString;
+
+inline const char* dcopTypeName(const QByteArray&) { return "QByteArray"; }
+inline const char* dcopTypeName(const QMap<QString,QString>&) { return "QMap<QString,QString>"; }
+inline const char* dcopTypeName(const QMap<QString,QByteArray>&) { return "QMap<QString,QByteArray>"; }
+
+#endif
diff -urN -x CVS kdelibs.orig/kwallet/tests/kwalletboth.cpp kdelibs/kwallet/tests/kwalletboth.cpp
--- kdelibs.orig/kwallet/tests/kwalletboth.cpp	Mon Feb  2 18:58:49 2004
+++ kdelibs/kwallet/tests/kwalletboth.cpp	Wed Nov 10 14:41:25 2004
@@ -34,10 +34,27 @@
 	QTimer::singleShot( 30000, qApp, SLOT( quit() ) );
 	int ret = qApp->exec();
 
+
 	if ( ret == 0 )
 		_out << "Timed out!" << endl;
 	else
 		_out << "Success!" << endl;
+
+	QMap<QString,QString> p;
+	ret = wallet->readPasswordList("*", p);
+	_out << "readPasswordList returned: " << ret << endl;
+	_out << "readPasswordList returned " << p.keys().count() << " entries" << endl;
+	QMap<QString, QMap<QString, QString> > q;
+	ret = wallet->readMapList("*", q);
+	_out << "readMapList returned: " << ret << endl;
+	_out << "readMapList returned " << q.keys().count() << " entries" << endl;
+
+	QMap<QString, QByteArray> s;
+	ret = wallet->readEntryList("*", s);
+	_out << "readEntryList returned: " << ret << endl;
+	_out << "readEntryList returned " << s.keys().count() << " entries" << endl;
+
+	delete wallet;
 }
 
 void WalletReceiver::walletOpened( bool got )
diff -urN -x CVS kdelibs.orig/mimetypes/all.desktop kdelibs/mimetypes/all.desktop
--- kdelibs.orig/mimetypes/all.desktop	Tue Aug 31 09:21:44 2004
+++ kdelibs/mimetypes/all.desktop	Sat Oct 30 08:38:20 2004
@@ -3,6 +3,8 @@
 Type=MimeType
 MimeType=all/all
 Comment=All Files and Folders
+Comment[af]=Alle Lêers en Gidse
+Comment[ar]=كل الملفات واﻷدلة
 Comment[az]=Bütün Fayl və Qovluqlar
 Comment[be]=Усе файлы і тэчкі
 Comment[bg]=Всички файлове и директории
@@ -21,6 +23,7 @@
 Comment[fa]=تمام پرونده‌ها و پوشه‌ها
 Comment[fi]=Kaikki tiedostot ja kansiot
 Comment[fr]=Tous les fichiers et dossiers
+Comment[ga]=Gach Comhad agus Comhadlann
 Comment[gl]=Tódolos Ficheiros e Cartafois
 Comment[he]=כל הקבצים והתיקיות
 Comment[hi]=सभी फ़ाइलें और फ़ोल्डर
@@ -31,9 +34,10 @@
 Comment[ja]=全てのファイルとディレクトリ
 Comment[ko]=모든 파일과 자료방
 Comment[lt]=Visos bylos ir aplankai
+Comment[mk]=Сите датотеки и папки
 Comment[mn]=Бүх файл болон лавлахууд
 Comment[nb]=Alle filer og kataloger
-Comment[nds]=Alle Dateien un Ordner
+Comment[nds]=All Dateien un Orner
 Comment[nl]=Alle bestanden en mappen
 Comment[nn]=Alle filer og katalogar
 Comment[pa]=ਸਾਰੀਆਂ ਫਾਇਲਾਂ ਤੇ ਫੋਲਡਰ
diff -urN -x CVS kdelibs.orig/mimetypes/allfiles.desktop kdelibs/mimetypes/allfiles.desktop
--- kdelibs.orig/mimetypes/allfiles.desktop	Tue Aug 24 08:29:47 2004
+++ kdelibs/mimetypes/allfiles.desktop	Sat Oct 30 08:38:20 2004
@@ -9,7 +9,7 @@
 Comment[be]=Усе файлы
 Comment[bg]=Всички файлове
 Comment[bn]=সব ফাইল
-Comment[br]=Restroù holl
+Comment[br]=An holl restroù
 Comment[bs]=Sve datoteke
 Comment[ca]=Tots els fitxers
 Comment[cs]=Všechny soubory
@@ -35,11 +35,12 @@
 Comment[ja]=全てのファイル
 Comment[ko]=모든 파일
 Comment[lt]=Visos bylos
+Comment[mk]=Сите датотеки
 Comment[mn]=TcL-Программ
 Comment[ms]=Semua Fail
 Comment[mt]=Fajls kollha
 Comment[nb]=Alle filer
-Comment[nds]=Alle Dateien
+Comment[nds]=All Dateien
 Comment[nl]=Alle bestanden
 Comment[nn]=Alle filer
 Comment[nso]=Difaele Kamoka
diff -urN -x CVS kdelibs.orig/mimetypes/application/Makefile.am kdelibs/mimetypes/application/Makefile.am
--- kdelibs.orig/mimetypes/application/Makefile.am	Wed Sep 29 21:40:16 2004
+++ kdelibs/mimetypes/application/Makefile.am	Wed Nov 10 09:54:28 2004
@@ -48,7 +48,8 @@
 	vnd.sun.xml.calc.template.desktop vnd.sun.xml.writer.template.desktop \
 	vnd.sun.xml.impress.template.desktop vnd.sun.xml.draw.template.desktop \
 	vnd.stardivision.chart.desktop vnd.stardivision.draw.desktop \
-	vnd.stardivision.math.desktop vnd.stardivision.writer-global.desktop vnd.sun.xml.writer.master.desktop
+	vnd.stardivision.math.desktop vnd.stardivision.writer-global.desktop \
+	vnd.sun.xml.writer.master.desktop java.desktop xml.desktop
 
 mimetypeapplicationdatadir = $(kde_mimedir)/application
 
diff -urN -x CVS kdelibs.orig/mimetypes/application/illustrator.desktop kdelibs/mimetypes/application/illustrator.desktop
--- kdelibs.orig/mimetypes/application/illustrator.desktop	Tue Aug 24 08:29:47 2004
+++ kdelibs/mimetypes/application/illustrator.desktop	Sat Oct 30 08:38:20 2004
@@ -38,6 +38,7 @@
 Comment[ko]=어도비 일러스트레이터 문서
 Comment[lt]=Adobe Illustrator dokumentas
 Comment[lv]=Adobe Ilustratora Dokuments
+Comment[mk]=Adobe Illustrator документ
 Comment[mn]=Adobe Illustrator-Баримт
 Comment[ms]=Dokumen Adobe Illustrator
 Comment[mt]=Dokument Adobe Illustrator
diff -urN -x CVS kdelibs.orig/mimetypes/application/java.desktop kdelibs/mimetypes/application/java.desktop
--- kdelibs.orig/mimetypes/application/java.desktop	Thu Jan  1 01:00:00 1970
+++ kdelibs/mimetypes/application/java.desktop	Thu Nov 11 08:50:26 2004
@@ -0,0 +1,75 @@
+[Desktop Entry]
+Encoding=UTF-8
+Type=MimeType
+MimeType=application/java
+Icon=source_java
+Comment=Java Class
+Comment[af]=Java Klas
+Comment[ar]=برنامج جافا
+Comment[az]=Java Sinifi
+Comment[be]=Кляса Java
+Comment[bg]=Клас на Java
+Comment[bn]=জাভা ক্লাস
+Comment[bs]=Java klasa
+Comment[ca]=Classe Java
+Comment[cs]=Java třída
+Comment[cy]=Dosbarth Java
+Comment[da]=Java-klasse
+Comment[de]=Java-Klasse
+Comment[el]=Κλάση Java
+Comment[eo]=Javo-klaso
+Comment[es]=Clase Java
+Comment[et]=Java klass
+Comment[eu]=Java Klasea
+Comment[fa]=طبقه‌ي Java
+Comment[fi]=Java-luokka
+Comment[fr]=Classe Java
+Comment[ga]=Aicme Java
+Comment[gl]=Clase de Java
+Comment[he]=מחלקת Java
+Comment[hi]=जावा क्लास
+Comment[hr]=Java razred
+Comment[hu]=Java-osztály
+Comment[id]=Class Java
+Comment[is]=Java klasi
+Comment[it]=Classe Java
+Comment[ja]=Java クラス
+Comment[ko]=자바 클래스
+Comment[lt]=Java klasė
+Comment[lv]=Java Klase
+Comment[mk]=Java класа
+Comment[mn]=Java-Анги
+Comment[mt]=Klassi Java
+Comment[nb]=Java-klasse
+Comment[nds]=Java-Klass
+Comment[nl]=Java-klasse
+Comment[nn]=Java-klasse
+Comment[nso]=Maemo a Java
+Comment[oc]=Classa Java
+Comment[pa]=ਜਾਵਾ(Java) ਕਲਾਸ
+Comment[pl]=Klasa Javy
+Comment[pt]=Classe Java
+Comment[pt_BR]=Classe Java
+Comment[ro]=Clasă Java
+Comment[ru]=Класс Java
+Comment[se]=Java-luohkká
+Comment[sk]=Java trieda
+Comment[sl]=Razred jave
+Comment[sq]=JAVA Klasë
+Comment[sr]=Java класа
+Comment[sr@Latn]=Java klasa
+Comment[ss]=Liklilasi le Java 
+Comment[sv]=Javaklass
+Comment[ta]=ஜாவா வகுப்பு
+Comment[tg]=Синфи Java
+Comment[th]=คลาสจาวา
+Comment[tr]=Java Sınıfı
+Comment[uk]=Клас Java
+Comment[uz]=Java синфи
+Comment[ven]=Kilasi ya Java
+Comment[vi]=Lớp Java 
+Comment[wa]=Classe Java
+Comment[xh]=Uhlobo lwe Java
+Comment[zh_CN]=Java 类
+Comment[zu]=Ikilasi lwe-Java
+X-KDE-IsAlso=application/x-java
diff -urN -x CVS kdelibs.orig/mimetypes/application/mathml+xml.desktop kdelibs/mimetypes/application/mathml+xml.desktop
--- kdelibs.orig/mimetypes/application/mathml+xml.desktop	Tue Aug 24 08:29:47 2004
+++ kdelibs/mimetypes/application/mathml+xml.desktop	Sat Oct 30 08:38:20 2004
@@ -6,6 +6,8 @@
 Hidden=false
 X-KDE-IsAlso=text/xml
 Comment=MathML Document
+Comment[af]=MathML Dokument
+Comment[ar]=مستند MathML
 Comment[az]=MathML Sənədi
 Comment[be]=Дакумэнт MathML
 Comment[bg]=Документ MathML
@@ -25,6 +27,7 @@
 Comment[fa]=سند MathML
 Comment[fi]=MathML-asiakirja
 Comment[fr]=Document MathML
+Comment[ga]=Cáipéis MathML
 Comment[gl]=Documento MathML
 Comment[he]=מסמך MathML
 Comment[hi]=मैथएमएल (MathML) दस्तावेज़
@@ -35,10 +38,11 @@
 Comment[ja]=MathML ドキュメント
 Comment[ko]=MathML 문서
 Comment[lt]=MathML dokumentas
+Comment[mk]=MathML документ
 Comment[mn]=MathML-Баримт
 Comment[ms]=Dokumen MathML
 Comment[nb]=MathML-dokument
-Comment[nds]=Dokment vun MathML
+Comment[nds]=MathML-Dokment
 Comment[nl]=MathML-document
 Comment[nn]=MathML-dokument
 Comment[pa]=MathML ਦਸਤਾਵੇਜ਼
diff -urN -x CVS kdelibs.orig/mimetypes/application/msexcel.desktop kdelibs/mimetypes/application/msexcel.desktop
--- kdelibs.orig/mimetypes/application/msexcel.desktop	Tue Aug 24 08:29:47 2004
+++ kdelibs/mimetypes/application/msexcel.desktop	Sat Oct 30 08:38:20 2004
@@ -12,6 +12,7 @@
 Comment[be]=Электронная табліца Microsoft Excel
 Comment[bg]=Документ на Microsoft Excel
 Comment[bn]=মাইক্রোসফট এক্সসেল নথী
+Comment[br]=Loger Microsoft Excel
 Comment[bs]=Microsoft Excel proračunska tablica
 Comment[ca]=Fulla de càlcul de Microsoft Excel
 Comment[cs]=Tabulka programu Microsoft Excel
@@ -37,6 +38,7 @@
 Comment[ja]=Microsoft Excel スプレッドシート
 Comment[ko]=마이크로소프트 엑셀 스프레드시트
 Comment[lt]=Microsoft Excel elektroninė lentelė
+Comment[mk]=Microsoft Excel табела
 Comment[mn]=MS-Excel-Хүснэгт
 Comment[ms]=Hamparan helaian Microsoft Excel
 Comment[mt]=Spreadsheet Microsoft Excel
diff -urN -x CVS kdelibs.orig/mimetypes/application/mspowerpoint.desktop kdelibs/mimetypes/application/mspowerpoint.desktop
--- kdelibs.orig/mimetypes/application/mspowerpoint.desktop	Tue Aug 24 08:29:47 2004
+++ kdelibs/mimetypes/application/mspowerpoint.desktop	Sat Oct 30 08:38:20 2004
@@ -5,6 +5,8 @@
 Icon=presentation
 Patterns=*.ppz;*.PPZ;*.ppt;*.PPT;*.pps;*.PPS;
 Comment=Microsoft PowerPoint Presentation
+Comment[af]=Microsoft Powerpoint Voorlegging
+Comment[ar]=مستند مايكروسوفت باوربوينت
 Comment[az]=Microsoft PowerPoint Sənədi
 Comment[be]=Прэзэнтацыя Microsoft PowerPoint
 Comment[bg]=Документ на Microsoft PowerPoint
@@ -23,6 +25,7 @@
 Comment[fa]=نمایش مایکروسافت پاور پوینت
 Comment[fi]=Microsoft PowerPoint -esitys
 Comment[fr]=Présentation Microsoft PowerPoint
+Comment[ga]=Cáipéis Microsoft PowerPoint
 Comment[gl]=Presentación de Microsoft PowerPoint
 Comment[he]=מצגת Microsoft PowerPoint
 Comment[hi]=माइक्रोसाफ्ट पावरपाइंट प्रेजेंटेशन
@@ -33,9 +36,11 @@
 Comment[ja]=Microsoft PowerPoint プレゼンテーション
 Comment[ko]=마이크로소프트 파워포인트 프리젠테이션
 Comment[lt]=Microsoft PowerPoint pristatymas
+Comment[mk]=Microsoft PowerPoint презентација
 Comment[mn]=MS-PowerPoint-Үзүүлэн
 Comment[ms]=Persembahan Microsoft PowerPoint
 Comment[nb]=Microsoft PowerPoint-dokument
+Comment[nds]=Microsoft PowerPoint Presentatschoon
 Comment[nl]=Microsoft PowerPoint-presentatie
 Comment[nn]=Microsoft PowerPoint-presentasjon
 Comment[pa]=ਮਾਈਕਰੋਸਾਫਟ PowerPoint ਪੇਸ਼ਕਾਰੀ
diff -urN -x CVS kdelibs.orig/mimetypes/application/msword.desktop kdelibs/mimetypes/application/msword.desktop
--- kdelibs.orig/mimetypes/application/msword.desktop	Tue Aug 24 08:29:47 2004
+++ kdelibs/mimetypes/application/msword.desktop	Sat Oct 30 08:38:20 2004
@@ -39,6 +39,7 @@
 Comment[ja]=Microsoft Word ドキュメント
 Comment[ko]=마이크로소프트 글틀 문서
 Comment[lt]=Microsoft Word dokumentas
+Comment[mk]=Microsoft Word документ
 Comment[mn]=MS-Word-Баримт
 Comment[ms]=Dokumen Microsoft Word
 Comment[mt]=Dokument Microsoft Word
diff -urN -x CVS kdelibs.orig/mimetypes/application/ogg.desktop kdelibs/mimetypes/application/ogg.desktop
--- kdelibs.orig/mimetypes/application/ogg.desktop	Tue Aug 31 09:21:44 2004
+++ kdelibs/mimetypes/application/ogg.desktop	Sat Oct 30 08:38:20 2004
@@ -36,6 +36,7 @@
 Comment[ja]=Ogg マルチメディア
 Comment[ko]=Ogg 멀티미디어
 Comment[lt]=Ogg multimedija
+Comment[mk]=Ogg мултимедија
 Comment[mn]=Ogg Мултимедиа
 Comment[ms]=Multimedia Ogg
 Comment[mt]=Awdjo OGG
diff -urN -x CVS kdelibs.orig/mimetypes/application/pdf.desktop kdelibs/mimetypes/application/pdf.desktop
--- kdelibs.orig/mimetypes/application/pdf.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/pdf.desktop	Sat Oct 30 08:38:20 2004
@@ -38,6 +38,7 @@
 Comment[ja]=PDF ドキュメント
 Comment[ko]=PDF 문서
 Comment[lt]=PDF dokumentas
+Comment[mk]=PDF документ
 Comment[mn]=PDF-Баримт
 Comment[ms]=Dokumen PDF
 Comment[mt]=Dokument PDF
diff -urN -x CVS kdelibs.orig/mimetypes/application/pgp-encrypted.desktop kdelibs/mimetypes/application/pgp-encrypted.desktop
--- kdelibs.orig/mimetypes/application/pgp-encrypted.desktop	Tue Aug 31 09:21:44 2004
+++ kdelibs/mimetypes/application/pgp-encrypted.desktop	Sat Oct 30 08:38:20 2004
@@ -35,10 +35,12 @@
 Comment[ja]=PGP/MIME 符号化されたメッセージヘッダー
 Comment[ko]=PGP/마임으로 암호화한 메세지 머리글
 Comment[lt]=PGP/MIME šifruotos žinutės antraštė
+Comment[mk]=PGP/MIME Криптирано заглавие на порака
 Comment[mn]=PGP/MIME түлхүүрлэгдсэн мэдээний толгой
 Comment[ms]=Pengepala Mesej Dienkrip PGP/MIME
 Comment[mt]=Ras ta' messaġġ iċċifrat PGP/MIME
 Comment[nb]=PGP/MIME-kryptert meldingshode
+Comment[nds]=Verslötelt Narichtenkopp (PGP/MIME)
 Comment[nl]=PGP/MIME-versleuteld berichthoofd
 Comment[nn]=PGP/MIME-kryptert meldingshovud
 Comment[nso]=Sehlogo sa Molaetsa seo se Sirilwego sa PGP/MIME
diff -urN -x CVS kdelibs.orig/mimetypes/application/pgp-keys.desktop kdelibs/mimetypes/application/pgp-keys.desktop
--- kdelibs.orig/mimetypes/application/pgp-keys.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/pgp-keys.desktop	Sat Oct 30 08:38:20 2004
@@ -5,6 +5,7 @@
 Icon=certificate
 Patterns=*.pgp;*.gpg;*.asc
 Comment=OpenPGP Key Bundle
+Comment[af]=OpenPGP Sleutel Bundel
 Comment[az]=OpenPGP Açar Düyünü
 Comment[bg]=Пакет с ключове за OpenPGP
 Comment[bn]=ওপেন-পি.জি.পি কী (Key) সংকলন
@@ -28,6 +29,7 @@
 Comment[it]=Mazzo di chiavi OpenPGP
 Comment[ja]=OpenPGP キーバンドル
 Comment[lt]=OpenPGP raktų ryšulys
+Comment[mk]=OpenPGP Збирка од клучеви
 Comment[mn]=OpenPGP түлхүүр боодол
 Comment[ms]=Gugusan Kunci OpenPGP
 Comment[nb]=OpenPGP-nøkkelsamling
diff -urN -x CVS kdelibs.orig/mimetypes/application/pgp-signature.desktop kdelibs/mimetypes/application/pgp-signature.desktop
--- kdelibs.orig/mimetypes/application/pgp-signature.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/pgp-signature.desktop	Sat Oct 30 08:38:20 2004
@@ -34,10 +34,12 @@
 Comment[ja]=切り離されたOpenPGP署名
 Comment[ko]=나눠진 오픈PGP 서명
 Comment[lt]=Atskiras OpenPGP parašas
+Comment[mk]=Издвоена OpenPGP сигнатура
 Comment[mn]=OpenPGP-Signature
 Comment[ms]=Lekang Tandatangan OpenPGP
 Comment[mt]=Firma OpenPGP mhux mehmuża
 Comment[nb]=Frakoblet OpenPGP-signatur
+Comment[nds]=Aftrennt OpenPGP-Ünnerschrift
 Comment[nl]=Losgekoppelde OpenPGP-signatuur
 Comment[nn]=Fråkopla OpenPGP-signatur
 Comment[nso]=Mosaeno wa BulaPGP wo o Loketswego
diff -urN -x CVS kdelibs.orig/mimetypes/application/pgp.desktop kdelibs/mimetypes/application/pgp.desktop
--- kdelibs.orig/mimetypes/application/pgp.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/pgp.desktop	Sat Oct 30 08:38:20 2004
@@ -4,6 +4,7 @@
 MimeType=application/pgp
 Icon=encrypted
 Comment=PGP Encrypted or Signed Message
+Comment[af]=PGP Geënkripteerde of Getekende Boodskap
 Comment[az]=PGP ilə Şifrələnmiş ya da İmzalanmış İsmarış
 Comment[be]=Зашыфраванае PGP ці падпісанае паведамленьне
 Comment[bg]=Шифровано или подписано съобщение PGP
@@ -32,10 +33,11 @@
 Comment[ja]=PGP 符号化された又は、署名されたメッセージ
 Comment[ko]=PGP로 암호화하거나 서명한 메세지
 Comment[lt]=PGP šifruotos ar pasirašytos žinutės antraštė
+Comment[mk]=PGP Криптирана или потпишана порака
 Comment[mn]=PGP түлхүүрлэгдсэн эсвэл орсон мэдээ
 Comment[ms]=Mesej ditandatangani atau dienrip PGP
 Comment[nb]=PGP-kryptert eller signert melding
-Comment[nds]=PGP-verslötelt oder PGP-unnerschreben Naricht
+Comment[nds]=PGP-verslötelt oder -ünnerschreven Naricht
 Comment[nl]=PGP-versleuteld of -ondertekend bericht
 Comment[nn]=PGP-kryptert eller -signert melding
 Comment[pa]=PGP ਇੰਕ੍ਰਿਪਟਡ ਜਾਂ ਦਸਤਖਤੀ ਸੁਨੇਹਾ
diff -urN -x CVS kdelibs.orig/mimetypes/application/pkcs10.desktop kdelibs/mimetypes/application/pkcs10.desktop
--- kdelibs.orig/mimetypes/application/pkcs10.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/pkcs10.desktop	Sat Oct 30 08:38:20 2004
@@ -5,6 +5,7 @@
 Icon=certificate
 Patterns=*.p10;*.P10
 Comment=S/MIME Certification Request
+Comment[af]=S/MIME Sertifikaat Aanvraag
 Comment[ar]=طلب شهادة S/MIME
 Comment[az]=S/MIME Vəsiqələndirmə İstəyi
 Comment[bg]=Заявка за удостоверение S/MIME
@@ -34,9 +35,11 @@
 Comment[ja]=S/MIME 証明書要求
 Comment[ko]=S/마임 증명 요청
 Comment[lt]=S/MIME sertifikavimo paklausimas
+Comment[mk]=S/MIME Барање за сертификат
 Comment[ms]=Permintaan Sijil S/MIME
 Comment[mt]=Rikjesta għal ċertifikat S/MIME
 Comment[nb]=S/MIME sertifiseringsforespørsel
+Comment[nds]=Anfraag för'n S/MIME-Zertifikaat
 Comment[nl]=S/MIME-certificaatverzoek
 Comment[nn]=S/MIME-sertifiseringsførespurnad
 Comment[nso]=Kgopelo ya Kgonthisiso ya S/MIME
diff -urN -x CVS kdelibs.orig/mimetypes/application/pkcs7-mime.desktop kdelibs/mimetypes/application/pkcs7-mime.desktop
--- kdelibs.orig/mimetypes/application/pkcs7-mime.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/pkcs7-mime.desktop	Sat Oct 30 08:38:20 2004
@@ -35,6 +35,7 @@
 Comment[ja]=PKCS#7 (S/MIME) フォーマットデータ
 Comment[ko]=PKCS#7 (S/마임) 형식 자료
 Comment[lt]=PKCS#7 (S/MIME) formatuoti duomenys
+Comment[mk]=PKCS#7 (S/MIME) форматирани податоци
 Comment[mn]=PKCS#7 (S/MIME) Хэлбэржсэн өгөгдөл
 Comment[ms]=Data Diformat PKCS#7 (S/MIME)
 Comment[mt]=Data fformattjata PKCS#7 (S/MIME)
diff -urN -x CVS kdelibs.orig/mimetypes/application/pkcs7-signature.desktop kdelibs/mimetypes/application/pkcs7-signature.desktop
--- kdelibs.orig/mimetypes/application/pkcs7-signature.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/pkcs7-signature.desktop	Sat Oct 30 08:38:20 2004
@@ -35,10 +35,12 @@
 Comment[ja]=切り離されたS/MIME 署名
 Comment[ko]=나눠진 S/마임 서명
 Comment[lt]=Atskiras S/MIME parašas
+Comment[mk]=Издвоена S/MIME сигнатура
 Comment[mn]=Салангид S/MIME-гарын үсэг
 Comment[ms]=Lekang Tandatangan S/MIME
 Comment[mt]=Firma S/MIME mhux mehmuża
 Comment[nb]=Frakoblet S/MIME-signatur
+Comment[nds]=Aftrennt S/MIME-Ünnerschrift
 Comment[nl]=losgekoppelde S/MIME-handtekening
 Comment[nn]=Fråkopla S/MIME-signatur
 Comment[nso]=Mosaeno wa S/MIME wo o Loketswego
diff -urN -x CVS kdelibs.orig/mimetypes/application/sieve.desktop kdelibs/mimetypes/application/sieve.desktop
--- kdelibs.orig/mimetypes/application/sieve.desktop	Tue Aug 31 09:21:44 2004
+++ kdelibs/mimetypes/application/sieve.desktop	Sat Oct 30 08:38:20 2004
@@ -4,6 +4,7 @@
 MimeType=application/sieve
 Patterns=*.sieve;*.siv
 Comment=SIEVE Mail Filter Script
+Comment[af]=SIEVE Pos Filter Skrip
 Comment[ar]=نص برمجي لمرشح بريد SIEVE
 Comment[az]=SIEVE Poçt Filtr Skripti
 Comment[bg]=Скрипт за филтриране на е-поща
@@ -32,11 +33,12 @@
 Comment[ja]=SIEVEメールフィルタスクリプト
 Comment[ko]=SIEVE 편지 거르개 스크립트
 Comment[lt]=SIEVE pašto filtro skriptas
+Comment[mk]=SIEVE филтер скрипта за пошта
 Comment[mn]=Sieve-скрипт: Захиа шүүлтүүр
 Comment[ms]=Skrip Penapis Mel SIEVE
 Comment[mt]=Skritt ta' filtri tal-imejl SIEVE
 Comment[nb]=SIEVE postfilterskript
-Comment[nds]=Filterskript för SIEVE Mail
+Comment[nds]=Filterskript för SIEVE-Mail
 Comment[nl]=Filtercript voor SIEVE Mail
 Comment[nn]=SIEVE e-postfilterskript
 Comment[nso]=Thswaelo ya Sesekodi sa Poso ya SIEVE
diff -urN -x CVS kdelibs.orig/mimetypes/application/vnd.mozilla.xul+xml.desktop kdelibs/mimetypes/application/vnd.mozilla.xul+xml.desktop
--- kdelibs.orig/mimetypes/application/vnd.mozilla.xul+xml.desktop	Mon Sep 20 15:53:29 2004
+++ kdelibs/mimetypes/application/vnd.mozilla.xul+xml.desktop	Fri Nov 12 08:27:54 2004
@@ -6,6 +6,7 @@
 Icon=netscape_doc
 Patterns=*.xul;*.XUL;
 Comment=Mozilla XUL File
+Comment[af]=Mozilla XUL Lêer
 Comment[be]=Файл Mozilla XUL
 Comment[bg]=Файл XUL на Мозила
 Comment[bn]=মোজিলা এক্স-ইউ-এল ফাইল
@@ -23,7 +24,10 @@
 Comment[is]=Mozilla XUL skrá
 Comment[it]=File XUL Mozilla
 Comment[ja]=Mozilla XUL ファイル
+Comment[lt]=Mozilla XUL byla
+Comment[mk]=Mozilla XUL датотека
 Comment[nb]=Mozilla XUL-fil
+Comment[nds]=Mozilla XUL-Datei
 Comment[nl]=Mozilla XUL-bestand
 Comment[nn]=Mozilla XUL-fil
 Comment[pa]=ਮੌਜੀਲਾ XUL ਫਾਇਲ
@@ -31,11 +35,12 @@
 Comment[pt]=Ficheiro XUL do Mozilla
 Comment[pt_BR]=Arquivo XUL do Mozilla
 Comment[ro]=Fişier XUL Mozilla
+Comment[ru]=Файл Mozilla XUL
 Comment[se]=Mozilla XUL-fiila
 Comment[sk]=Súbor Mozilla XUL
 Comment[sl]=Datoteka Mozilla XUL
 Comment[sr]=Mozilla XUL фајл
-Comment[sr@Latn]=Mozilla XUL фајл
+Comment[sr@Latn]=Mozilla XUL fajl
 Comment[sv]=Mozilla XUL-fil
 Comment[ta]=மோசில்லா XUL ஆவணம்
 Comment[tg]=Файли Mozilla XUL 
diff -urN -x CVS kdelibs.orig/mimetypes/application/vnd.ms-asf.desktop kdelibs/mimetypes/application/vnd.ms-asf.desktop
--- kdelibs.orig/mimetypes/application/vnd.ms-asf.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/vnd.ms-asf.desktop	Tue Nov  9 08:35:29 2004
@@ -8,6 +8,7 @@
 Comment[az]=ASF Mediyası
 Comment[bg]=Медия ASF
 Comment[bn]=এ-এস-এফ মিডিয়া
+Comment[br]=Media ASF
 Comment[bs]=ASF medija
 Comment[ca]=Medi ASF
 Comment[cs]=ASF média
@@ -29,9 +30,11 @@
 Comment[it]=File multimediale ASF
 Comment[ja]=ASF メディア
 Comment[ko]=ASF 파일
+Comment[mk]=ASF медиум
 Comment[mn]=ASF Медиа
 Comment[ms]=Media ASF
 Comment[mt]=Media ASF
+Comment[nds]=ASF-Medien
 Comment[nl]=ASF-media
 Comment[nn]=ASF-media
 Comment[nso]=Media wa ASF
@@ -50,6 +53,7 @@
 Comment[ss]=Tindzaba te ASF 
 Comment[sv]=ASF-media
 Comment[ta]=ASF ஊடகம்
+Comment[tg]=Медияи ASF 
 Comment[th]=แฟ้มสื่อ ASF
 Comment[tr]=ASF dosyası
 Comment[uk]=Носій ASF
diff -urN -x CVS kdelibs.orig/mimetypes/application/vnd.ms-excel.desktop kdelibs/mimetypes/application/vnd.ms-excel.desktop
--- kdelibs.orig/mimetypes/application/vnd.ms-excel.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/vnd.ms-excel.desktop	Sat Oct 30 08:38:20 2004
@@ -10,6 +10,7 @@
 Comment[be]=Электронная табліца Microsoft Excel
 Comment[bg]=Документ на Microsoft Excel
 Comment[bn]=মাইক্রোসফট এক্সসেল নথী
+Comment[br]=Loger Microsoft Excel
 Comment[bs]=Microsoft Excel proračunska tablica
 Comment[ca]=Fulla de càlcul de Microsoft Excel
 Comment[cs]=Tabulka programu Microsoft Excel
@@ -35,6 +36,7 @@
 Comment[ja]=Microsoft Excel スプレッドシート
 Comment[ko]=마이크로소프트 엑셀 스프레드시트
 Comment[lt]=Microsoft Excel elektroninė lentelė
+Comment[mk]=Microsoft Excel табела
 Comment[mn]=MS-Excel-Хүснэгт
 Comment[ms]=Hamparan helaian Microsoft Excel
 Comment[mt]=Spreadsheet Microsoft Excel
diff -urN -x CVS kdelibs.orig/mimetypes/application/vnd.ms-word.desktop kdelibs/mimetypes/application/vnd.ms-word.desktop
--- kdelibs.orig/mimetypes/application/vnd.ms-word.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/vnd.ms-word.desktop	Sat Oct 30 08:38:20 2004
@@ -36,6 +36,7 @@
 Comment[ja]=Microsoft Word ドキュメント
 Comment[ko]=마이크로소프트 글틀 문서
 Comment[lt]=Microsoft Word dokumentas
+Comment[mk]=Microsoft Word документ
 Comment[mn]=MS-Word-Баримт
 Comment[ms]=Dokumen Microsoft Word
 Comment[mt]=Dokument Microsoft Word
diff -urN -x CVS kdelibs.orig/mimetypes/application/vnd.palm.desktop kdelibs/mimetypes/application/vnd.palm.desktop
--- kdelibs.orig/mimetypes/application/vnd.palm.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/vnd.palm.desktop	Sat Oct 30 08:38:20 2004
@@ -4,6 +4,7 @@
 Icon=wordprocessing
 Patterns=*.pdb;*.PDB;*.prc;*.PRC;
 Comment=Palm Document
+Comment[af]=Palm Dokument
 Comment[ar]=مستند Palm
 Comment[az]=Palm Sənədi
 Comment[be]=Дакумэнт Palm
@@ -35,6 +36,7 @@
 Comment[ja]=Palm ドキュメント
 Comment[ko]=팜 문서
 Comment[lt]=Palm dokumentas
+Comment[mk]=Palm документ
 Comment[mn]=Palm Баримт
 Comment[ms]=Dokumen Palm
 Comment[nb]=Palm-dokument
diff -urN -x CVS kdelibs.orig/mimetypes/application/vnd.rn-realmedia.desktop kdelibs/mimetypes/application/vnd.rn-realmedia.desktop
--- kdelibs.orig/mimetypes/application/vnd.rn-realmedia.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/vnd.rn-realmedia.desktop	Tue Nov  9 08:35:29 2004
@@ -5,6 +5,7 @@
 Icon=video
 Patterns=*.rm;*.RM;
 Comment=RealMedia File
+Comment[af]=RealMedia Lêer
 Comment[ar]=وسيط RealMedia
 Comment[az]=RealMedia Faylı
 Comment[be]=Файл RealMedia
@@ -25,6 +26,7 @@
 Comment[fa]=پرونده‌ی RealMedia
 Comment[fi]=RealMedia-tiedosto
 Comment[fr]=Fichier RealMedia
+Comment[ga]=Comhad RealMedia
 Comment[gl]=Ficheiro RealMedia
 Comment[he]=קובץ RealMedia
 Comment[hi]=रीयलमीडिया फ़ाइल
@@ -35,6 +37,7 @@
 Comment[ja]=リアルメディア ファイル
 Comment[ko]=리얼미디어 파일
 Comment[lt]=RealMedia byla
+Comment[mk]=RealMedia датотека
 Comment[mn]=RealMedia Файл
 Comment[nb]=RealMedia-fil
 Comment[nds]=RealMedia-Datei
@@ -54,7 +57,7 @@
 Comment[sr@Latn]=Fajl RealMedia-e
 Comment[sv]=Realmedia-fil
 Comment[ta]=RealMedia கோப்பு
-Comment[tg]=Файли Медия Аслӣ
+Comment[tg]=Файли Медия Ҳақиқӣ
 Comment[th]=แฟ้ม RealMedia
 Comment[tr]=RealMedia Dosyası
 Comment[uk]=Файл RealMedia
diff -urN -x CVS kdelibs.orig/mimetypes/application/vnd.stardivision.calc.desktop kdelibs/mimetypes/application/vnd.stardivision.calc.desktop
--- kdelibs.orig/mimetypes/application/vnd.stardivision.calc.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/vnd.stardivision.calc.desktop	Sat Oct 30 08:38:20 2004
@@ -5,11 +5,13 @@
 Patterns=*.sdc;*.SDC;
 Icon=spreadsheet
 Comment=StarOffice Calc Spreadsheet
+Comment[af]=StarOffice Calc Spreiblad
 Comment[ar]=مستند StarOffice Calc
 Comment[az]=StarOffice Calc Sənədi
 Comment[be]=Электронная табліца StarOffice Calc
 Comment[bg]=Документ на StarOffice Calc
 Comment[bn]=স্টার-অফিস ক্যাল্ক নথী
+Comment[br]=Loger StarOffice Calc
 Comment[bs]=StarOffice Calc spreadsheet
 Comment[ca]=Fulla de càlcul de l'StarOffice
 Comment[cs]=Tabulka aplikace StarOffice Calc
@@ -35,10 +37,11 @@
 Comment[ja]=StarOffice Calc  スプレッドシート
 Comment[ko]=스타오피스 계산기 스프레드시트
 Comment[lt]=StarOffice Calc elektroninė lentelė
+Comment[mk]=StarOffice Calc табела
 Comment[mn]=StarOffice-Хүснэгтэн Боловсруулагч
 Comment[ms]=Hamparan helaian StarOffice Calc
 Comment[nb]=StarCalc regneark
-Comment[nds]=Tabell vun StarOffice Calc
+Comment[nds]=Tabell vun Calc (StarOffice)
 Comment[nl]=StarOffice Calc-spreadsheet
 Comment[nn]=StarOffice Calc-rekneark
 Comment[nso]=Letlakala la Phatlalatso la Calc StarOffice
diff -urN -x CVS kdelibs.orig/mimetypes/application/vnd.stardivision.chart.desktop kdelibs/mimetypes/application/vnd.stardivision.chart.desktop
--- kdelibs.orig/mimetypes/application/vnd.stardivision.chart.desktop	Thu Sep 30 16:03:33 2004
+++ kdelibs/mimetypes/application/vnd.stardivision.chart.desktop	Fri Nov 12 08:27:54 2004
@@ -5,6 +5,7 @@
 Patterns=*.sds;*.SDS;
 Icon=kchart_chrt
 Comment=StarOffice Chart
+Comment[af]=StarOffice Kaart
 Comment[bg]=Документ на StarOffice Chart
 Comment[bn]=স্টার-অফিস চার্ট
 Comment[bs]=StarOffice grafikon
@@ -22,18 +23,22 @@
 Comment[it]=Diagramma StarOffice
 Comment[ja]=StarOffice チャート
 Comment[ko]=스타오피스 도표
+Comment[lt]=StarOffice grafikas
+Comment[mk]=StarOffice график
 Comment[nb]=StarOffice-diagram
+Comment[nds]=StarOffice-Diagramm
 Comment[nn]=StarOffice-diagram
 Comment[pa]=ਸਟਾਰਆਫਿਸ Chart
 Comment[pl]=Wykres StarOffice
 Comment[pt]=Gráfico do StarOffice
 Comment[pt_BR]=Gráficos do StarOffice
 Comment[ro]=Hartă StarOffice
+Comment[ru]=Диаграмма StarOffice
 Comment[se]=StarOffice Calc-diagrámma
 Comment[sk]=Graf StarOffice
 Comment[sl]=Preglednica StarOffice
 Comment[sr]=StarOffice-ов графикон
-Comment[sr@Latn]=StarOffice-ов графикон
+Comment[sr@Latn]=StarOffice-ov grafikon
 Comment[sv]=StarOffice diagram
 Comment[ta]=ஸ்டார்ஆபீஸ் வரைபடம்
 Comment[uk]=Діаграма StarOffice
diff -urN -x CVS kdelibs.orig/mimetypes/application/vnd.stardivision.draw.desktop kdelibs/mimetypes/application/vnd.stardivision.draw.desktop
--- kdelibs.orig/mimetypes/application/vnd.stardivision.draw.desktop	Thu Sep 30 16:03:33 2004
+++ kdelibs/mimetypes/application/vnd.stardivision.draw.desktop	Fri Nov 12 08:27:54 2004
@@ -5,6 +5,7 @@
 Patterns=*.sda;*.SDA;
 Icon=image
 Comment=StarOffice Drawing
+Comment[af]=StarOffice Tekening
 Comment[be]=Малюнак StarOffice
 Comment[bg]=Изображение на StarOffice Drawing
 Comment[bn]=স্টার-অফিস ড্রয়িং
@@ -25,18 +26,22 @@
 Comment[it]=Disegno StarOffice
 Comment[ja]=StarOffice 図形描画
 Comment[ko]=스타오피스 그림
+Comment[lt]=StarOffice piešinys
+Comment[mk]=StarOffice цртеж
 Comment[nb]=StarOffice-teigning
+Comment[nds]=StarOffice-Teken
 Comment[nn]=StarOffice-teikning
 Comment[pa]=ਸਟਾਰਆਫਿਸ Drawing
 Comment[pl]=Rysunek StarOffice
 Comment[pt]=Desenho do StarOffice
 Comment[pt_BR]=Desenho do StarOffice
 Comment[ro]=Desen vectorial StarOffice
+Comment[ru]=Рисунок StarOffice
 Comment[se]=StarOffice-sárgun
 Comment[sk]=Kresba StarOffice
 Comment[sl]=Risanje StarOffice
 Comment[sr]=StarOffice-ов цртеж
-Comment[sr@Latn]=StarOffice-ов цртеж
+Comment[sr@Latn]=StarOffice-ov crtež
 Comment[sv]=StarOffice teckning
 Comment[ta]=மைக்ரோசாப்ட் ஆபிஸ் சித்திரம்
 Comment[tg]=Расмкашӣ Microsoft Office
diff -urN -x CVS kdelibs.orig/mimetypes/application/vnd.stardivision.impress.desktop kdelibs/mimetypes/application/vnd.stardivision.impress.desktop
--- kdelibs.orig/mimetypes/application/vnd.stardivision.impress.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/vnd.stardivision.impress.desktop	Mon Nov 22 09:34:04 2004
@@ -5,6 +5,7 @@
 Patterns=*.sdd;*.SDD;
 Icon=presentation
 Comment=StarOffice Impress Presentation
+Comment[af]=StarOffice Impress Voorlegging
 Comment[ar]=عرض StarOffice Impress
 Comment[az]=StarOffice Impress Sənədi
 Comment[be]=Прэзэнтацыя StarOffice Impress
@@ -34,10 +35,11 @@
 Comment[it]=Presentazione StarOffice Impress
 Comment[ja]=StarOffice Impress プレゼンテーション
 Comment[lt]=StarOffice Impress pristatymas
+Comment[mk]=StarOffice Impress презентација
 Comment[mn]=StarOffice Сэтгэлд Хоногшсон Үзүүлэнгүүд
 Comment[ms]=Persembahan StarOffice Impress
 Comment[nb]=StarOffice Impress presentasjon
-Comment[nds]=Präsentatschoon vun Star Office Impress
+Comment[nds]=Presentatschoon vun Impress (StarOffice)
 Comment[nn]=StarOffice Impress-presentasjon
 Comment[nso]=Pontsho ya Kgahlego ya StarOffice
 Comment[pa]=ਸਟਾਰਆਫਿਸ Impress ਪੇਸ਼ਕਾਰ
@@ -54,6 +56,7 @@
 Comment[sr@Latn]=StarOffice Impress-ova prezentacija
 Comment[sv]=StarOffice Impress-presentation
 Comment[ta]=ஸ்டார்ஆபீஸ் இம்ப்ரெஸ் அளிக்கை
+Comment[tg]=Намоиши StarOffice Impress Presentation
 Comment[tr]=StarOffice Impress Sunumu
 Comment[uk]=Презентація StarOffice Impress
 Comment[uz]=StarOffice Impress намойиши
diff -urN -x CVS kdelibs.orig/mimetypes/application/vnd.stardivision.math.desktop kdelibs/mimetypes/application/vnd.stardivision.math.desktop
--- kdelibs.orig/mimetypes/application/vnd.stardivision.math.desktop	Thu Sep 30 16:03:33 2004
+++ kdelibs/mimetypes/application/vnd.stardivision.math.desktop	Fri Nov 12 08:27:54 2004
@@ -5,6 +5,7 @@
 Patterns=*.sdf;*.SDF;
 Icon=kformula_kfo
 Comment=StarOffice Math Document
+Comment[af]=StarOffice Wiskunde Dokument
 Comment[be]=Дакумэнт StarOffice Math
 Comment[bg]=Документ на StarOffice Math
 Comment[bn]=স্টার-অফিস ম্যাথ নথী
@@ -24,7 +25,10 @@
 Comment[is]=StarOffice Math skjal
 Comment[it]=Documento matematico StarOffice
 Comment[ja]=StarOffice Math ドキュメント
+Comment[lt]=StarOffice Math dokumentas
+Comment[mk]=StarOffice Math документ
 Comment[nb]=StarOffice-formel
+Comment[nds]=Mathemaatsch Dokment vun StarOffice
 Comment[nl]=StarOffice Math-document
 Comment[nn]=StarOffice-formel
 Comment[pa]=ਸਟਾਰਆਫਿਸ Math ਦਸਤਾਵੇਜ਼
@@ -32,11 +36,12 @@
 Comment[pt]=Documento Matemático do StarOffice
 Comment[pt_BR]=Funções Matemáticas do StarOffice
 Comment[ro]=Document matematic StarOffice
+Comment[ru]=Документ математики StarOffice
 Comment[se]=StarOffice Math-dokumeanta
 Comment[sk]=Dokument StarOffice Math
 Comment[sl]=Dokument StarOffice Math
 Comment[sr]=StarOffice-ов математички документ
-Comment[sr@Latn]=StarOffice-ов математички документ
+Comment[sr@Latn]=StarOffice-ov matematički dokument
 Comment[sv]=StarOffice matematikdokument
 Comment[ta]=ஸ்டார்ஆபீஸ் ரைட்டர் ஆவணம்
 Comment[tg]=Санади математикии StarOffice
diff -urN -x CVS kdelibs.orig/mimetypes/application/vnd.stardivision.writer-global.desktop kdelibs/mimetypes/application/vnd.stardivision.writer-global.desktop
--- kdelibs.orig/mimetypes/application/vnd.stardivision.writer-global.desktop	Thu Sep 30 16:03:33 2004
+++ kdelibs/mimetypes/application/vnd.stardivision.writer-global.desktop	Fri Nov 12 08:27:54 2004
@@ -5,6 +5,7 @@
 Patterns=*.sgl;*.SGL;
 Icon=wordprocessing
 Comment=StarOffice Writer Master Document
+Comment[af]=StarOffice Writer Meester Dokument
 Comment[bg]=Главен документ на StarOffice Writer
 Comment[bn]=স্টার-অফিস রাইটার মাস্টার নথী
 Comment[bs]=StarOffice Writer glavni dokument
@@ -24,7 +25,9 @@
 Comment[it]=Documento master StarOffice Writer
 Comment[ja]=StarOffice Writer マスタードキュメント
 Comment[ko]=스타오피스 글틀 기본 문서
+Comment[lt]=StarOffice Writer „master“ dokumentas
 Comment[nb]=StarOffice Writer-hovuddokument
+Comment[nds]=Vörlaag-Dokment vun Writer (StarOffice)
 Comment[nl]=StarOffice Writer-hoofddocument
 Comment[nn]=StarOffice Writer-hovuddokument
 Comment[pa]=ਸਟਾਰਆਫਿਸ Writer ਮਾਸਟਰ ਦਸਤਾਵੇਜ਼
@@ -32,11 +35,12 @@
 Comment[pt]=Documento Mestre do Writer do StarOffice
 Comment[pt_BR]=Documento Texto Mestre do StarOffice
 Comment[ro]=Document master StarOffice Writer
+Comment[ru]=Мастер-документ StarOffice Writer
 Comment[se]=StarOffice Writer-váldodokumeanta
 Comment[sk]=Hlavný dokument StarOffice Writer
 Comment[sl]=Glavni dokument StarOffice Writer
 Comment[sr]=StarOffice Writer-ов главни документ
-Comment[sr@Latn]=StarOffice Writer-ов главни документ
+Comment[sr@Latn]=StarOffice Writer-ov glavni dokument
 Comment[sv]=StarOffice Writer-huvuddokument
 Comment[ta]=ஸ்டார்ஆபீஸ் ரைட்டர் மூல ஆவணம்
 Comment[tg]=Санади устоди нависаи StarOffice
diff -urN -x CVS kdelibs.orig/mimetypes/application/vnd.stardivision.writer.desktop kdelibs/mimetypes/application/vnd.stardivision.writer.desktop
--- kdelibs.orig/mimetypes/application/vnd.stardivision.writer.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/vnd.stardivision.writer.desktop	Sat Oct 30 08:38:20 2004
@@ -5,6 +5,7 @@
 Patterns=*.sdw;*.SDW;
 Icon=wordprocessing
 Comment=StarOffice Writer Document
+Comment[af]=StarOffice Writer Dokument
 Comment[ar]=مستند StarOffice Writer
 Comment[az]=StarOffice Writer Sənədi
 Comment[be]=Дакумэнт StarOffice Writer
@@ -36,10 +37,11 @@
 Comment[ja]=StarOffice Writer ドキュメント
 Comment[ko]=스타오피스 글틀 문서
 Comment[lt]=StarOffice Writer Dokumentas
+Comment[mk]=StarOffice Writer документ
 Comment[mn]=StarOffice-Баримт-Бичээч
 Comment[ms]=Dokumen StarOffice Writer
 Comment[nb]=StarOffice Writer-dokument
-Comment[nds]=Dokment vun StarOffice Writer
+Comment[nds]=Dokment vun Writer (StarOffice)
 Comment[nl]=StarOffice Writer-document
 Comment[nn]=StarOffice Writer-dokument
 Comment[nso]=Tokomane ya Sengwadi sa StarOffice
diff -urN -x CVS kdelibs.orig/mimetypes/application/vnd.sun.xml.calc.desktop kdelibs/mimetypes/application/vnd.sun.xml.calc.desktop
--- kdelibs.orig/mimetypes/application/vnd.sun.xml.calc.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/vnd.sun.xml.calc.desktop	Sat Oct 30 08:38:20 2004
@@ -1,11 +1,13 @@
 [Desktop Entry]
 Encoding=UTF-8
 Comment=OpenOffice.org Spreadsheet
+Comment[af]=OpenOffice.org Spreiblad
 Comment[ar]=مستند OpenOffice.org Spreasheet
 Comment[az]=OpenOffice.org Hesab Cədvəli
 Comment[be]=Электронная табліца OpenOffice.org
 Comment[bg]=Документ на OpenOffice.org Calc
 Comment[bn]=ওপেন-অফিস.অর্গ স্প্রেডশিট
+Comment[br]=Loger OpenOffice.org
 Comment[bs]=OpenOffice.org proračunska tablica
 Comment[ca]=Fulla de càlcul d'OpenOffice.org
 Comment[cs]=Tabulka OpenOffice.org
@@ -30,10 +32,11 @@
 Comment[ja]=OpenOffice.org スプレッドシート
 Comment[ko]=Openoffice.org 스프레드시트
 Comment[lt]=OpenOffice.org elektroninė lentelė
+Comment[mk]=OpenOffice.org табела
 Comment[mn]=OpenOffice.org Хүснэгтэн боловсруулагч
 Comment[ms]=Hamparan helaian OpenOffice.org 
 Comment[nb]=OpenOffice regneark
-Comment[nds]=Tabell vun OpenOffice.org
+Comment[nds]=Tabell vun OpenOffice
 Comment[nn]=OpenOffice.org-rekneark
 Comment[pa]=OpenOffice.org ਸਾਰਣੀਕਾਰ
 Comment[pl]=Arkusz OpenOffice.org
diff -urN -x CVS kdelibs.orig/mimetypes/application/vnd.sun.xml.calc.template.desktop kdelibs/mimetypes/application/vnd.sun.xml.calc.template.desktop
--- kdelibs.orig/mimetypes/application/vnd.sun.xml.calc.template.desktop	Thu Sep 30 16:03:33 2004
+++ kdelibs/mimetypes/application/vnd.sun.xml.calc.template.desktop	Fri Nov 12 08:27:54 2004
@@ -1,6 +1,7 @@
 [Desktop Entry]
 Encoding=UTF-8
 Comment=OpenOffice.org Spreadsheet Template
+Comment[af]=OpenOffice.org Spreiblad Voorbeeld
 Comment[be]=Шаблён электроннай табліцы OpenOffice.org
 Comment[bg]=Шаблон на OpenOffice.org Spreadsheet
 Comment[bn]=ওপেন-অফিস.অর্গ স্প্রেডশিট টেম্‌প্লেট
@@ -21,7 +22,10 @@
 Comment[it]=Modello di foglio di calcolo OpenOffice.org
 Comment[ja]=OpenOffice.org スプレッドシートテンプレート
 Comment[ko]=Openoffice.org 스프레드시트 본
+Comment[lt]=OpenOffice.org elektroninė lentelė
+Comment[mk]=OpenOffice.org шаблон за табела
 Comment[nb]=OpenOffice.org-regnearkmal
+Comment[nds]=Tabell-Vörlaag vun OpenOffice
 Comment[nl]=OpenOffice.org Spreadsheet-sjabloon
 Comment[nn]=OpenOffice.org-reknearkmal
 Comment[pa]=OpenOffice.org ਸਾਰਣੀਕਾਰ ਨਮੂਨਾ
@@ -29,11 +33,12 @@
 Comment[pt]=Modelo de Folha de Cálculo do OpenOffice.org
 Comment[pt_BR]=Modelo de Planilha do OpenOffice.org
 Comment[ro]=Model foaie de calcul tabelar OpenOffice.org
+Comment[ru]=Шаблон таблицы OpenOffice.org
 Comment[se]=OpenOffice.org rehkenastinárkamálle
 Comment[sk]=Šablóna tabuľky OpenOffice.org
 Comment[sl]=Predloga preglednice OpenOffice.org
 Comment[sr]=OpenOffice.org-ов шаблон табеле
-Comment[sr@Latn]=OpenOffice.org-ов шаблон табеле
+Comment[sr@Latn]=OpenOffice.org-ov šablon tabele
 Comment[sv]=OpenOffice.org kalkylarksmall
 Comment[ta]=ழ-ஓப்பன்ஆபீஸ் விரிதாள்
 Comment[tg]=Ҷадвали OpenOffice.org
diff -urN -x CVS kdelibs.orig/mimetypes/application/vnd.sun.xml.draw.desktop kdelibs/mimetypes/application/vnd.sun.xml.draw.desktop
--- kdelibs.orig/mimetypes/application/vnd.sun.xml.draw.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/vnd.sun.xml.draw.desktop	Mon Nov 22 09:34:04 2004
@@ -1,6 +1,7 @@
 [Desktop Entry]
 Encoding=UTF-8
 Comment=OpenOffice.org Drawing
+Comment[af]=OpenOffice.org Tekening
 Comment[ar]=مستند OpenOffice.org Drawing
 Comment[az]=OpenOffice.org Rəsmi
 Comment[be]=Малюнак OpenOffice.org
@@ -27,11 +28,13 @@
 Comment[hu]=OpenOffice.org-rajz
 Comment[is]=OpenOffice.org teikning
 Comment[it]=Disegno OpenOffice.org
-Comment[ja]=OpenOffice.org ドローイング
+Comment[ja]=OpenOffice.org ドロー
 Comment[ko]=OpenOffice.org 그림
 Comment[lt]=OpenOffice.org piešinys
+Comment[mk]=OpenOffice.org цртеж
 Comment[mn]=OpenOffice.org Зураглал
 Comment[nb]=OpenOffice tegning
+Comment[nds]=OpenOffice-Teken
 Comment[nn]=OpenOffice.org-teikning
 Comment[pa]=OpenOffice.org ਚਿੱਤਰਕਾਰੀ
 Comment[pl]=Rysunek OpenOffice.org
@@ -47,6 +50,7 @@
 Comment[sr@Latn]=OpenOffice.org-ov crtež
 Comment[sv]=OpenOffice.org teckning
 Comment[ta]=ழ-ஓப்பன்ஆபீஸ் வரைபடம்
+Comment[tg]=Кашидани OpenOffice.org 
 Comment[tr]=OpenOffice.org Çizimi
 Comment[uk]=Малюнок OpenOffice.org
 Comment[uz]=OpenOffice.org чизма
diff -urN -x CVS kdelibs.orig/mimetypes/application/vnd.sun.xml.draw.template.desktop kdelibs/mimetypes/application/vnd.sun.xml.draw.template.desktop
--- kdelibs.orig/mimetypes/application/vnd.sun.xml.draw.template.desktop	Thu Sep 30 16:03:33 2004
+++ kdelibs/mimetypes/application/vnd.sun.xml.draw.template.desktop	Mon Nov 15 08:54:58 2004
@@ -1,6 +1,7 @@
 [Desktop Entry]
 Encoding=UTF-8
 Comment=OpenOffice.org Drawing Template
+Comment[af]=OpenOffice.org Tekening Voorbeeld
 Comment[be]=Шаблён малюнку OpenOffice.org
 Comment[bg]=Шаблон на OpenOffice.org Drawing
 Comment[bn]=ওপেন-অফিস.অর্গ ড্রয়িং টেম্‌প্লেট
@@ -19,9 +20,12 @@
 Comment[hu]=OpenOffice.org-rajzsablon
 Comment[is]=OpenOffice.org teikningarsniðmát
 Comment[it]=Modello di disegno OpenOffice.org
-Comment[ja]=OpenOffice.org ドローイングテンプレート
+Comment[ja]=OpenOffice.org ドローテンプレート
 Comment[ko]=OpenOffice.org 그림 본
+Comment[lt]=OpenOffice.org piešinio šablonas
+Comment[mk]=OpenOffice.org шаблон за цртеж
 Comment[nb]=OpenOffice.org-tegnemal
+Comment[nds]=Teken-Vörlaag vun OpenOffice
 Comment[nl]=OpenOffice.org Drawing-sjabloon
 Comment[nn]=OpenOffice.org-teikningsmal
 Comment[pa]=OpenOffice.org ਚਿੱਤਰਕਾਰੀ ਨਮੂਨਾ
@@ -29,11 +33,12 @@
 Comment[pt]=Modelo de Desenho do OpenOffice.org
 Comment[pt_BR]=Modelo de Desenhos do OpenOffice.org
 Comment[ro]=Model desen vectorial OpenOffice.org
+Comment[ru]=Шаблон рисунка OpenOffice.org
 Comment[se]=OpenOffice.org-sárgunmálle
 Comment[sk]=Šablóna kresby OpenOffice.org
 Comment[sl]=Predloga risanja OpenOffice.org
 Comment[sr]=OpenOffice.org-ов шаблон цртежа
-Comment[sr@Latn]=OpenOffice.org-ов шаблон цртежа
+Comment[sr@Latn]=OpenOffice.org-ov šablon crteža
 Comment[sv]=OpenOffice.org teckningsmall
 Comment[ta]=ழ-ஓப்பன்ஆபீஸ் வரைபடம்
 Comment[tg]=Нақши OpenOffice.org
diff -urN -x CVS kdelibs.orig/mimetypes/application/vnd.sun.xml.impress.desktop kdelibs/mimetypes/application/vnd.sun.xml.impress.desktop
--- kdelibs.orig/mimetypes/application/vnd.sun.xml.impress.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/vnd.sun.xml.impress.desktop	Mon Nov 22 09:34:04 2004
@@ -1,6 +1,7 @@
 [Desktop Entry]
 Encoding=UTF-8
 Comment=OpenOffice.org Presentation
+Comment[af]=OpenOffice.org Voorlegging
 Comment[ar]=مستند OpenOffice.org Presentation
 Comment[az]=OpenOffice.org Təqdimatı
 Comment[be]=Прэзэнтацыя OpenOffice.org
@@ -31,10 +32,11 @@
 Comment[ja]=OpenOffice.org プレゼンテーション
 Comment[ko]=OpenOffice.org 프리젠테이션
 Comment[lt]=OpenOffice.org pristatymas
+Comment[mk]=OpenOffice.org презентација
 Comment[mn]=OpenOffice.org Үзүүлэн
 Comment[ms]=Persembahan OpenOffice.org
 Comment[nb]=OpenOffice presentasjon
-Comment[nds]=Präsentatschoon vun OpenOffice.org
+Comment[nds]=Presentatschoon vun OpenOffice
 Comment[nn]=OpenOffice.org-presentasjon
 Comment[pa]=OpenOffice.org ਪੇਸ਼ਕਾਰੀ
 Comment[pl]=Prezentacja OpenOffice.org
@@ -50,6 +52,7 @@
 Comment[sr@Latn]=OpenOffice.org-ova prezentacija
 Comment[sv]=OpenOffice.org presentation
 Comment[ta]=ழ-ஓப்பன்ஆபீஸ் அளிக்கை
+Comment[tg]=Намоиши OpenOffice.org
 Comment[tr]=OpenOffice.org Sunumu
 Comment[uk]=Презентація OpenOffice.org
 Comment[uz]=OpenOffice.org Намойиш
diff -urN -x CVS kdelibs.orig/mimetypes/application/vnd.sun.xml.impress.template.desktop kdelibs/mimetypes/application/vnd.sun.xml.impress.template.desktop
--- kdelibs.orig/mimetypes/application/vnd.sun.xml.impress.template.desktop	Thu Sep 30 16:03:33 2004
+++ kdelibs/mimetypes/application/vnd.sun.xml.impress.template.desktop	Fri Nov 12 08:27:54 2004
@@ -1,6 +1,7 @@
 [Desktop Entry]
 Encoding=UTF-8
 Comment=OpenOffice.org Presentation Template
+Comment[af]=OpenOffice.org Voorlegging 
 Comment[be]=Шаблён прэзэнтацыі OpenOffice.org
 Comment[bg]=Шаблон на OpenOffice.org Presentation
 Comment[bn]=ওপেন-অফিস.অর্গ প্রেসেন্টেশন টেম্‌প্লেট
@@ -21,7 +22,10 @@
 Comment[it]=Modello di presentazione OpenOffice.org
 Comment[ja]=OpenOffice.org プレゼンテーションテンプレート
 Comment[ko]=OpenOffice.org 프리젠테이션 본
+Comment[lt]=OpenOffice.org pristatymo šablonas
+Comment[mk]=OpenOffice.org шаблон за презентација
 Comment[nb]=OpenOffice.org-presentasjonsmal
+Comment[nds]=Presentatschoon-Vörlaag vun OpenOffice
 Comment[nl]=OpenOffice.org Presentation-sjabloon
 Comment[nn]=OpenOffice.org-presentasjonsmal
 Comment[pa]=OpenOffice.org ਪੇਸ਼ਕਾਰੀ ਨਮੂਨਾ
@@ -29,11 +33,12 @@
 Comment[pt]=Modelo de Apresentação do OpenOffice.org
 Comment[pt_BR]=Modelo de Apresentações do OpenOffice.org
 Comment[ro]=Model prezentare OpenOffice.org
+Comment[ru]=Шаблон презентации OpenOffice.org
 Comment[se]=OpenOffice.org presentašuvdnamálle
 Comment[sk]=Šablóna prezentácie OpenOffice.org
 Comment[sl]=Predloga predstavitve OpenOffice.org
 Comment[sr]=OpenOffice.org-ов шаблон презентације
-Comment[sr@Latn]=OpenOffice.org-ов шаблон презентације
+Comment[sr@Latn]=OpenOffice.org-ov šablon prezentacije
 Comment[sv]=OpenOffice.org presentationsmall
 Comment[ta]=ழ-ஓப்பன்ஆபீஸ் அளிக்கை
 Comment[tg]=Тақдимоти OpenOffice.org
diff -urN -x CVS kdelibs.orig/mimetypes/application/vnd.sun.xml.writer.desktop kdelibs/mimetypes/application/vnd.sun.xml.writer.desktop
--- kdelibs.orig/mimetypes/application/vnd.sun.xml.writer.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/vnd.sun.xml.writer.desktop	Sat Oct 30 08:38:20 2004
@@ -1,6 +1,7 @@
 [Desktop Entry]
 Encoding=UTF-8
 Comment=OpenOffice.org Text Document
+Comment[af]=OpenOffice.org Teks Dokument
 Comment[ar]=مستند نصَي OpenOffice.org 
 Comment[az]=OpenOffice.org Mətn Sənədi
 Comment[be]=Тэкставы дакумэнт OpenOffice.org
@@ -32,10 +33,11 @@
 Comment[ja]=OpenOffice.org テキストドキュメント
 Comment[ko]=Openoffice.org 글월 문서
 Comment[lt]=OpenOffice.org teksto dokumentas
+Comment[mk]=OpenOffice.org текст документ
 Comment[mn]=OpenOffice.org Текст баримт
 Comment[ms]=Dokumen Teks OpenOffice.org
 Comment[nb]=OpenOffice tekstdokument
-Comment[nds]=Textdokment vun OpenOffice.org
+Comment[nds]=Textdokment vun OpenOffice
 Comment[nl]=OpenOffice.org Text-document
 Comment[nn]=OpenOffice.org-tekstdokument
 Comment[pa]=OpenOffice.org ਪਾਠ ਦਸਤਾਵੇਜ਼
diff -urN -x CVS kdelibs.orig/mimetypes/application/vnd.sun.xml.writer.master.desktop kdelibs/mimetypes/application/vnd.sun.xml.writer.master.desktop
--- kdelibs.orig/mimetypes/application/vnd.sun.xml.writer.master.desktop	Thu Sep 30 16:03:33 2004
+++ kdelibs/mimetypes/application/vnd.sun.xml.writer.master.desktop	Fri Nov 12 08:27:54 2004
@@ -1,6 +1,7 @@
 [Desktop Entry]
 Encoding=UTF-8
 Comment=OpenOffice.org Master Text Document
+Comment[af]=OpenOffice.org Meester Teks Dokument
 Comment[bg]=Главен документ на OpenOffice.org Writer
 Comment[bn]=ওপেন-অফিস.অর্গ মাস্টার টেক্সট নথী
 Comment[bs]=OpenOffice.org glavni tekst dokument
@@ -19,7 +20,10 @@
 Comment[is]=OpenOffice.org yfirtextaskjal
 Comment[it]=Documento di testo master OpenOffice.org
 Comment[ja]=OpenOffice.org マスターテキストドキュメント
+Comment[lt]=OpenOffice.org teksto dokumentas
+Comment[mk]=OpenOffice.org главен текст документ
 Comment[nb]=OpenOffice.org-hovedtekstdokument
+Comment[nds]=Textvörlaag vun OpenOffice
 Comment[nl]=OpenOffice.org Text-hoofddocument
 Comment[nn]=OpenOffice.org-hovudtekstdokument
 Comment[pa]=OpenOffice.org ਮਾਸਟਰ ਪਾਠ ਦਸਤਾਵੇਜ਼
@@ -27,11 +31,12 @@
 Comment[pt]=Documento Mestre de Texto do OpenOffice.org
 Comment[pt_BR]=Documento Mestre de Texto do OpenOffice
 Comment[ro]=Document master OpenOffice.org
+Comment[ru]=Мастер-документ OpenOffice.org (текстовый)
 Comment[se]=OpenOffice.org-váldoteakstadokumeanta
 Comment[sk]=Hlavný textový dokument OpenOffice.org
 Comment[sl]=Glavni besedilni dokument OpenOffice.org
 Comment[sr]=OpenOffice.org-ов главни текстуални документ
-Comment[sr@Latn]=OpenOffice.org-ов главни текстуални документ
+Comment[sr@Latn]=OpenOffice.org-ov glavni tekstualni dokument
 Comment[sv]=OpenOffice.org huvudtextdokument
 Comment[ta]=OpenOffice.org ஆசிரியர் உரை ஆவணம்
 Comment[tg]=Устоди санади OpenOffice.org
diff -urN -x CVS kdelibs.orig/mimetypes/application/vnd.sun.xml.writer.template.desktop kdelibs/mimetypes/application/vnd.sun.xml.writer.template.desktop
--- kdelibs.orig/mimetypes/application/vnd.sun.xml.writer.template.desktop	Thu Sep 30 16:03:33 2004
+++ kdelibs/mimetypes/application/vnd.sun.xml.writer.template.desktop	Fri Nov 12 08:27:54 2004
@@ -1,6 +1,7 @@
 [Desktop Entry]
 Encoding=UTF-8
 Comment=OpenOffice.org Text Document Template
+Comment[af]=OpenOffice.org Teks Dokument Voorbeeld
 Comment[be]=Шаблён тэкставы дакумэнт OpenOffice.org
 Comment[bg]=Шаблон на OpenOffice.org Text Document
 Comment[bn]=ওপেন-অফিস.অর্গ টেক্সট নথী টেম্‌প্লেট
@@ -21,7 +22,10 @@
 Comment[it]=Modello di documento di testo OpenOffice.org
 Comment[ja]=OpenOffice.org テキストドキュメントテンプレート
 Comment[ko]=OpenOffice.org 글월 문서 본
+Comment[lt]=OpenOffice.org teksto dokumento šablonas
+Comment[mk]=OpenOffice.org шаблон за текст документ
 Comment[nb]=OpenOffice.org-tekstdokumentmal
+Comment[nds]=Textdokment-Vörlaag vun OpenOffice
 Comment[nl]=OpenOffice.org Text-sjabloon
 Comment[nn]=OpenOffice.org-tekstdokumentmal
 Comment[pa]=OpenOffice.org ਪਾਠ ਦਸਤਾਵੇਜ਼ ਨਮੂਨਾ
@@ -29,11 +33,12 @@
 Comment[pt]=Modelo de Documento de Texto do OpenOffice.org
 Comment[pt_BR]=Modelo de Documento de Texto do OpenOffice
 Comment[ro]=Model document text OpenOffice.org
+Comment[ru]=Шаблон текстового документа OpenOffice.org
 Comment[se]=OpenOffice.org-teakstadokumeantamálle
 Comment[sk]=Šablóna textového dokumentu OpenOffice.org
 Comment[sl]=Predloga besedilnega dokumenta OpenOffice.org
 Comment[sr]=OpenOffice.org-ов шаблон текстуалног документа
-Comment[sr@Latn]=OpenOffice.org-ов шаблон текстуалног документа
+Comment[sr@Latn]=OpenOffice.org-ov šablon tekstualnog dokumenta
 Comment[sv]=OpenOffice.org textdokumentmall
 Comment[ta]=ழ-ஓப்பன்ஆபீஸ் உரை ஆவணம்
 Comment[tg]=Санади OpenOffice.org
diff -urN -x CVS kdelibs.orig/mimetypes/application/wordperfect.desktop kdelibs/mimetypes/application/wordperfect.desktop
--- kdelibs.orig/mimetypes/application/wordperfect.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/wordperfect.desktop	Sat Oct 30 08:38:20 2004
@@ -5,7 +5,7 @@
 Icon=wordprocessing
 Patterns=*.wpd;*.WPD;
 Comment=WordPerfect Document
-Comment[af]=Wordperfect Dokument
+Comment[af]=WordPerfect Dokument
 Comment[ar]=مستند Word Perfect
 Comment[az]=WordPerfect Sənədi
 Comment[be]=Дакумэнт WordPerfect
@@ -37,6 +37,7 @@
 Comment[ja]=WordPerfect ドキュメント
 Comment[ko]=워드퍼펙트 문서
 Comment[lt]=WordPerfect dokumentas
+Comment[mk]=WordPerfect документ
 Comment[mn]=WordPerfect-Баримт
 Comment[ms]=Dokumen WordPerfect
 Comment[mt]=Dokument WordPerfect
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-abiword.desktop kdelibs/mimetypes/application/x-abiword.desktop
--- kdelibs.orig/mimetypes/application/x-abiword.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-abiword.desktop	Sat Oct 30 08:38:20 2004
@@ -3,7 +3,7 @@
 Type=MimeType
 MimeType=application/x-abiword
 Comment=AbiWord Document
-Comment[af]=Abiword Dokument
+Comment[af]=AbiWord Dokument
 Comment[ar]=مستند AbiWord
 Comment[az]=AbiWord Sənədi
 Comment[be]=Дакумэнт AbiWord
@@ -37,6 +37,7 @@
 Comment[ko]=아비워드 문서
 Comment[lt]=AbiWord dokumentas
 Comment[lv]=AbiWord Dokuments
+Comment[mk]=AbiWord документ
 Comment[mn]=AbiWord-Баримт
 Comment[ms]=Dokumen AbiWord
 Comment[mt]=Dokument AbiWord
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-ace.desktop kdelibs/mimetypes/application/x-ace.desktop
--- kdelibs.orig/mimetypes/application/x-ace.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-ace.desktop	Sat Oct 30 08:38:20 2004
@@ -5,6 +5,7 @@
 Icon=tgz
 Patterns=*.ace;*.ACE;
 Comment=ACE Archive
+Comment[af]=ACE Argief
 Comment[ar]=أرشيف ACE
 Comment[az]=ACE Arxivi
 Comment[be]=Архіў ACE
@@ -25,6 +26,7 @@
 Comment[fa]=آرشیو ACE
 Comment[fi]=ACE-paketti
 Comment[fr]=Archive ACE
+Comment[ga]=Cartlann ACE
 Comment[gl]=Ficheiro ACE
 Comment[he]=ארכיון ACE
 Comment[hi]=ACE आर्काइव
@@ -35,6 +37,7 @@
 Comment[ja]=ACE アーカイブ
 Comment[ko]=ACE 저장고
 Comment[lt]=ACE archyvas
+Comment[mk]=ACE архива
 Comment[mn]=ACE Архив
 Comment[nb]=ACE arkiv
 Comment[nds]=ACE-Archiv
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-afm.desktop kdelibs/mimetypes/application/x-afm.desktop
--- kdelibs.orig/mimetypes/application/x-afm.desktop	Tue Aug 31 09:21:44 2004
+++ kdelibs/mimetypes/application/x-afm.desktop	Sat Oct 30 08:38:20 2004
@@ -1,6 +1,8 @@
 [Desktop Entry]
 Encoding=UTF-8
 Comment=PostScript Font Metrics
+Comment[af]=PostScript Skrif tipe Afmetings
+Comment[ar]=قياسات خط بوستسكريبت
 Comment[az]=PostScript Yazı Növü Metrikləri
 Comment[be]=Мэтрыкі шрыфту PostScript
 Comment[bg]=Метрика на шрифт PostScript
@@ -29,6 +31,7 @@
 Comment[ja]=PostScript フォント メトリクス
 Comment[ko]=포스트스크립트 글꼴 메트릭
 Comment[lt]=PostScript šrifto metrika
+Comment[mk]=PostScript метрики на фонт
 Comment[mn]=PostScript Бичиг Metrics
 Comment[nb]=PostScript skrift Metrics
 Comment[nds]=Metriken för PostScript-Schriftoorden
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-amipro.desktop kdelibs/mimetypes/application/x-amipro.desktop
--- kdelibs.orig/mimetypes/application/x-amipro.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-amipro.desktop	Sat Oct 30 08:38:20 2004
@@ -37,6 +37,7 @@
 Comment[ja]=Lotus AmiPro ドキュメント
 Comment[ko]=로터스 아미프로 문서
 Comment[lt]=Lotus AmiPro dokumentas
+Comment[mk]=Lotus AmiPro документ
 Comment[mn]=Lotus-AmiPro-Баримт
 Comment[ms]=Dokumen Lotus AmiPro
 Comment[mt]=Dokument Lotus AmiPro
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-applixgraphics.desktop kdelibs/mimetypes/application/x-applixgraphics.desktop
--- kdelibs.orig/mimetypes/application/x-applixgraphics.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-applixgraphics.desktop	Sat Oct 30 08:38:20 2004
@@ -37,11 +37,12 @@
 Comment[ja]=Applix グラフィックスドキュメント
 Comment[ko]=애플릭스 그림
 Comment[lt]=Applix grafinis dokumentas
+Comment[mk]=Applix Graphics документ
 Comment[mn]=Applix-Graphik-Баримт
 Comment[ms]=Dokumen Grafik Applix
 Comment[mt]=Dokument Applix Graphics
 Comment[nb]=Applix grafikk-dokument
-Comment[nds]=Applix Graphics-Dokment
+Comment[nds]=Applix Grafik-Dokment
 Comment[nl]=Applix Graphics-document
 Comment[nn]=Applix Graphics-dokument
 Comment[nso]=Tokomane ya di-Graphic tsa Applix
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-applixspread.desktop kdelibs/mimetypes/application/x-applixspread.desktop
--- kdelibs.orig/mimetypes/application/x-applixspread.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-applixspread.desktop	Sat Oct 30 08:38:20 2004
@@ -11,6 +11,7 @@
 Comment[be]=Дакумэнт Applix Spreadsheets
 Comment[bg]=Документ на Applix Spreadsheets
 Comment[bn]=অ্যাপলিক্স স্প্রেডশিট ডকুমেন্ট
+Comment[br]=Teul al loger Applix
 Comment[bs]=Applix proračunska tablica
 Comment[ca]=Document fulla de càlcul de Applix
 Comment[cs]=Dokument Applix Spreadsheets
@@ -36,11 +37,12 @@
 Comment[ja]=Applix スプレッドシートドキュメント
 Comment[ko]=애플릭스 스프레드시트 문서
 Comment[lt]=Applix elektroninės lentelės dokumentas
+Comment[mk]=Applix Spreadsheets документ
 Comment[mn]=Applix-Tabellenkalkulations-Баримт
 Comment[ms]=Dokumen Hamparan Helaian Applix
 Comment[mt]=Spreadsheet Applix
 Comment[nb]=Applix regneark
-Comment[nds]=Applix Spreadsheets-Dokment
+Comment[nds]=Applix-Tabell
 Comment[nl]=Applix Spreadsheets-document
 Comment[nn]=Applix Spreadsheets-dokument
 Comment[nso]=Tokomane ya Matlakala a Phatlalatso a Applix
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-applixword.desktop kdelibs/mimetypes/application/x-applixword.desktop
--- kdelibs.orig/mimetypes/application/x-applixword.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-applixword.desktop	Sat Oct 30 08:38:20 2004
@@ -37,6 +37,7 @@
 Comment[ja]=Applix ワードドキュメント
 Comment[ko]=애플릭스 글틀 문서
 Comment[lt]=Applix Words dokumentas
+Comment[mk]=Applix Words документ
 Comment[mn]=Applix-Text-Баримт
 Comment[ms]=Dokumen Applix Words
 Comment[mt]=Dokument Applix Words
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-arc.desktop kdelibs/mimetypes/application/x-arc.desktop
--- kdelibs.orig/mimetypes/application/x-arc.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-arc.desktop	Sat Oct 30 08:38:20 2004
@@ -5,6 +5,7 @@
 Icon=tgz
 Patterns=*.arc;*.ARC;
 Comment=ARC Archive
+Comment[af]=ARC Argief
 Comment[ar]=أرشيف ARC
 Comment[az]=ARC Arxivi
 Comment[be]=Архіў ARC
@@ -25,6 +26,7 @@
 Comment[fa]=آرشیو ARC
 Comment[fi]=ARC-paketti
 Comment[fr]=Archive ARC
+Comment[ga]=Cartlann ARC
 Comment[gl]=Ficheiro ARC
 Comment[he]=ארכיון ARC
 Comment[hi]=ARC आर्काइव
@@ -35,6 +37,7 @@
 Comment[ja]=ARC アーカイブ
 Comment[ko]=ARC 저장고
 Comment[lt]=ARC archyvas
+Comment[mk]=ARC архива
 Comment[mn]=ARC Архив
 Comment[nb]=ARC arkiv
 Comment[nds]=ARC-Archiv
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-archive.desktop kdelibs/mimetypes/application/x-archive.desktop
--- kdelibs.orig/mimetypes/application/x-archive.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-archive.desktop	Sat Oct 30 08:38:20 2004
@@ -34,6 +34,7 @@
 Comment[ja]=Ar アーカイブ
 Comment[ko]=Ar 저장고
 Comment[lt]=Ar Archyvas
+Comment[mk]=Ar архива
 Comment[mn]=AR-Архив
 Comment[ms]=Arkib Ar
 Comment[mt]=Arkivji Ar
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-arj.desktop kdelibs/mimetypes/application/x-arj.desktop
--- kdelibs.orig/mimetypes/application/x-arj.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-arj.desktop	Sat Oct 30 08:38:20 2004
@@ -37,6 +37,7 @@
 Comment[ja]=ARJ アーカイブ
 Comment[ko]=ARJ 저장고
 Comment[lt]=ARJ archyvas
+Comment[mk]=ARJ архива
 Comment[mn]=ARJ-Архив
 Comment[ms]=Arkib ARJ
 Comment[mt]=Arkivji ARJ
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-awk.desktop kdelibs/mimetypes/application/x-awk.desktop
--- kdelibs.orig/mimetypes/application/x-awk.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-awk.desktop	Sat Oct 30 08:38:20 2004
@@ -33,6 +33,7 @@
 Comment[ja]=AWK スクリプト
 Comment[ko]=AWK 스크립트
 Comment[lt]=AWK skriptas
+Comment[mk]=AWK скрипта
 Comment[mn]=AWK-скрипт
 Comment[ms]=Skrip AWK
 Comment[mt]=Skritt AWK
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-bittorrent.desktop kdelibs/mimetypes/application/x-bittorrent.desktop
--- kdelibs.orig/mimetypes/application/x-bittorrent.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-bittorrent.desktop	Sat Oct 30 08:38:20 2004
@@ -1,6 +1,8 @@
 [Desktop Entry]
 Encoding=UTF-8
 Comment=BitTorrent Download
+Comment[af]=BitTorrent Aflaai
+Comment[ar]=ملف تنزيل BitTorrent
 Comment[az]=BitTorrent Faylı
 Comment[bg]=Изтеглен файл на BitTorrent
 Comment[bn]=বিট-টরেন্ট ডাউনলোড
@@ -26,9 +28,11 @@
 Comment[it]=Scaricamento BitTorrent
 Comment[ja]=BitTorrent ダウンロード
 Comment[lt]=BitTorrent atsisiuntimas
+Comment[mk]=BitTorrent симнување
 Comment[mn]=BitTorrent татац
 Comment[ms]=Muat Turun BitTorrent
 Comment[nb]=BitTorrent nedlasting
+Comment[nds]=Daalladen mit BitTorrent
 Comment[nl]=BitTorrent-download
 Comment[nn]=BitTorrent-nedlasting
 Comment[pa]=BitTorrent ਡਾਊਨਲੋਡ
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-bz2dvi.desktop kdelibs/mimetypes/application/x-bz2dvi.desktop
--- kdelibs.orig/mimetypes/application/x-bz2dvi.desktop	Mon Sep 20 15:53:29 2004
+++ kdelibs/mimetypes/application/x-bz2dvi.desktop	Fri Nov 12 08:27:54 2004
@@ -1,6 +1,7 @@
 [Desktop Entry]
 Encoding=UTF-8
 Comment=Bzip2 Compressed DVI File
+Comment[af]=Bzip2 gekompakteerde DVI Lêer
 Comment[bg]=Компресиран файл DVI с bzip2
 Comment[bn]=বি-জিপ-২ (Bzip2) কম্প্রেসকৃত ডি-ভি-আই ফাইল
 Comment[bs]=Bzip2 komprimirana DVI datoteka
@@ -17,7 +18,10 @@
 Comment[is]=Bzip2 þjöppuð DVI skrá
 Comment[it]=File DVI compresso con Bzip2
 Comment[ja]=Bzip2 圧縮 DVI ファイル
+Comment[lt]=Bzip2 suspausta DVI byla
+Comment[mk]=Bzip2 компресирана DVI датотека
 Comment[nb]=Bzip2-komprimert DVI-fil
+Comment[nds]=BZip2-komprimeert DVI-Datei
 Comment[nl]=Met bzip2 gecomprimeerd DVI-bestand
 Comment[nn]=Bzip2-komprimert DVI-fil
 Comment[pa]=Bzip2 ਨਪੀੜੀ DVI ਫਾਇਲ਼
@@ -25,11 +29,12 @@
 Comment[pt]=Ficheiro DVI Comprimido com BZip2
 Comment[pt_BR]=Arquivo DVI compactado com o Bzip2
 Comment[ro]=Fişier DVI comprimat cu Bzip2
+Comment[ru]=Сжатый bzip2 файл DVI
 Comment[se]=Bzip2-čoahkkáibáhkkejuvvon DVI-fiila
 Comment[sk]=Komprimovaný súbor DVI pomocou bzip2
 Comment[sl]=Datoteka DVI, stisnjena s bzip2
 Comment[sr]=Bzip2 компресовани DVI фајл
-Comment[sr@Latn]=Bzip2 компресовани DVI фајл
+Comment[sr@Latn]=Bzip2 kompresovani DVI fajl
 Comment[sv]=Bzip2-komprimerad DVI-fil
 Comment[ta]=Bzip2 அழுத்திய DVI கோப்பு
 Comment[tg]=Bzip2 Файли DVI фушурдашуда
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-bzip.desktop kdelibs/mimetypes/application/x-bzip.desktop
--- kdelibs.orig/mimetypes/application/x-bzip.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-bzip.desktop	Sat Oct 30 08:38:20 2004
@@ -34,11 +34,12 @@
 Comment[ja]=Bzip ファイル
 Comment[ko]=Bzip 파일
 Comment[lt]=Bzip byla
+Comment[mk]=Bzip датотека
 Comment[mn]=Bzip-Файл
 Comment[ms]=Fail Bzip
 Comment[mt]=Arkivju Bzip
 Comment[nb]=Bzip-fil
-Comment[nds]=Bzip-Datei
+Comment[nds]=BZip-Datei
 Comment[nl]=Bzip-bestand
 Comment[nn]=Bzip-fil
 Comment[nso]=Faele ya Bzip
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-bzip2.desktop kdelibs/mimetypes/application/x-bzip2.desktop
--- kdelibs.orig/mimetypes/application/x-bzip2.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-bzip2.desktop	Sat Oct 30 08:38:20 2004
@@ -34,11 +34,12 @@
 Comment[ja]=Bzip2 ファイル
 Comment[ko]=Bzip2 파일
 Comment[lt]=Bzip2 byla
+Comment[mk]=Bzip2 датотека
 Comment[mn]=Bzip-Файл
 Comment[ms]=Fail Bzip2
 Comment[mt]=Arkivju Bzip2
 Comment[nb]=Bzip2-fil
-Comment[nds]=Bzip2-Datei
+Comment[nds]=BZip2-Datei
 Comment[nl]=Bzip2-bestand
 Comment[nn]=Bzip2-fil
 Comment[nso]=Faele ya Bzip2
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-cda.desktop kdelibs/mimetypes/application/x-cda.desktop
--- kdelibs.orig/mimetypes/application/x-cda.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-cda.desktop	Mon Nov 22 09:34:04 2004
@@ -32,6 +32,7 @@
 Comment[ja]=CD オーディオ
 Comment[ko]=CD 오디오
 Comment[lt]=CD audio
+Comment[mk]=CD аудио
 Comment[mn]=CD-Audio
 Comment[mt]=Awdjo CD
 Comment[nl]=CD-audio
@@ -51,6 +52,7 @@
 Comment[ss]=Umsindvo we CD 
 Comment[sv]=Ljud-cd
 Comment[ta]=குறுந்தட்டு ஒலி
+Comment[tg]=Савди CD
 Comment[tr]=CD sesi
 Comment[uk]=Аудіо на КД
 Comment[uz]=Аудио компакт-диск
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-compress.desktop kdelibs/mimetypes/application/x-compress.desktop
--- kdelibs.orig/mimetypes/application/x-compress.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-compress.desktop	Mon Nov 15 08:54:58 2004
@@ -33,14 +33,15 @@
 Comment[hu]=UNIX tömörített fájl
 Comment[is]=Þjöppuð skrá (compress)
 Comment[it]=File compresso UNIX
-Comment[ja]=UNIX compressedファイル
+Comment[ja]=UNIX 圧縮ファイル
 Comment[ko]=UNIX 기본 압축한 파일
 Comment[lt]=UNIX suspausta byla
+Comment[mk]=UNIX компресирана датотека
 Comment[mn]=Шахагдсан UNIX-Файл
 Comment[ms]=Fail UNIX Dipadatkan
 Comment[mt]=Fajl kompressat UNIX
 Comment[nb]=UNIX-komprimert fil
-Comment[nds]=Unix-komprimeert Datei
+Comment[nds]=Komprimeert Unix-Datei
 Comment[nl]=UNIX-compressiebestand
 Comment[nn]=UNIX-komprimert fil
 Comment[nso]=Faele yeo e Pitleleditswego ya UNIX
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-core.desktop kdelibs/mimetypes/application/x-core.desktop
--- kdelibs.orig/mimetypes/application/x-core.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-core.desktop	Sat Oct 30 08:38:20 2004
@@ -35,6 +35,7 @@
 Comment[ja]=プログラムクラッシュデータ
 Comment[ko]=프로그램이 죽을 때 남긴 자료
 Comment[lt]=Programos lūžimo duomenys
+Comment[mk]=Податоци за пад на програма
 Comment[mn]=Программчилалын осолдсон (Crash) өгөгдөл
 Comment[ms]=Data Program Rosak
 Comment[mt]=Data ta' kraxx ta' programm
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-cpio.desktop kdelibs/mimetypes/application/x-cpio.desktop
--- kdelibs.orig/mimetypes/application/x-cpio.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-cpio.desktop	Sat Oct 30 08:38:20 2004
@@ -37,6 +37,7 @@
 Comment[ja]=CPIO アーカイブ
 Comment[ko]=CPIO 저장고
 Comment[lt]=CPIO archyvas
+Comment[mk]=CPIO архива
 Comment[mn]=CPIO-Архив
 Comment[ms]=Arkib CPIO
 Comment[mt]=Arkivju CPIO
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-cue.desktop kdelibs/mimetypes/application/x-cue.desktop
--- kdelibs.orig/mimetypes/application/x-cue.desktop	Mon Sep 20 15:53:29 2004
+++ kdelibs/mimetypes/application/x-cue.desktop	Sat Oct 30 08:38:20 2004
@@ -4,6 +4,7 @@
 MimeType=application/x-cue
 Icon=cdimage
 Comment=CDRWIN Cue-Sheet
+Comment[af]=CDRWIN Cue-Bladsy
 Comment[bg]=Документ CDRWIN
 Comment[bn]=CDRWIN কিউ-শিট
 Comment[bs]=CDRWIN cue-sheet
@@ -18,7 +19,9 @@
 Comment[hu]=CDRWIN-es Cue-fájl
 Comment[is]=CDRWIN cue-skjal
 Comment[it]=Cuesheet di CDRWin
+Comment[mk]=CDRWIN табела со ознаки
 Comment[nb]=CDRWIN cue-ark
+Comment[nds]=CDRWIN Cue-Datei
 Comment[nl]=CDRWIN-cue-sheet
 Comment[nn]=CDRWIN-cue-ark
 Comment[pa]=CDRWIN Cue-ਸ਼ੀਟ
@@ -26,6 +29,7 @@
 Comment[pt]=Ficheiro de Dados CDRWIN
 Comment[pt_BR]=Folha Cue CDRWIN
 Comment[ro]=Proiect audio CD CDRWIN
+Comment[ru]=Таблица CDRWIN cue
 Comment[se]=CDRWIN-cue-árka
 Comment[sk]=CDRWIN cue-sheet
 Comment[sl]=CDRWIN cue-sheet
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-dbase.desktop kdelibs/mimetypes/application/x-dbase.desktop
--- kdelibs.orig/mimetypes/application/x-dbase.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-dbase.desktop	Sat Oct 30 08:38:20 2004
@@ -5,6 +5,7 @@
 Icon=database
 Patterns=*.dbf;*.DBF;
 Comment=dBASE Document
+Comment[af]=dBASE Dokument
 Comment[ar]=مستند dBASE
 Comment[az]=dBASE Sənədi
 Comment[be]=Дакумэнт dBASE
@@ -36,6 +37,7 @@
 Comment[ja]=dBASE ドキュメント
 Comment[ko]=dBASE 문서
 Comment[lt]=dBASE dokumentas
+Comment[mk]=dBASE документ
 Comment[mn]=dBASE-Баримт
 Comment[ms]=Dokumen dBASE
 Comment[mt]=Dokument dBASE
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-deb.desktop kdelibs/mimetypes/application/x-deb.desktop
--- kdelibs.orig/mimetypes/application/x-deb.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-deb.desktop	Sat Oct 30 08:38:20 2004
@@ -5,6 +5,7 @@
 Icon=deb
 Patterns=*.deb;*.DEB;
 Comment=Debian Package
+Comment[af]=Debian Pakkie
 Comment[ar]=حزمة ديبيان
 Comment[az]=Debian Paketi
 Comment[bg]=Пакет на Дебиан
@@ -24,6 +25,7 @@
 Comment[fa]=بسته‌ی دبیان
 Comment[fi]=Debian-paketti
 Comment[fr]=Paquetage Debian
+Comment[ga]=Pacáiste Debian
 Comment[gl]=Paquete Debian
 Comment[he]=חבילת Debian
 Comment[hi]=डेबिएन पैकेज
@@ -34,6 +36,7 @@
 Comment[ja]=Debian パッケージ
 Comment[ko]=데비안 꾸러미
 Comment[lt]=Debian paketas
+Comment[mk]=Debian пакет
 Comment[mn]=Дебиан пакет
 Comment[ms]=Pakej Debian
 Comment[nb]=Debian-pakke
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-designer.desktop kdelibs/mimetypes/application/x-designer.desktop
--- kdelibs.orig/mimetypes/application/x-designer.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-designer.desktop	Sat Oct 30 08:38:21 2004
@@ -34,6 +34,7 @@
 Comment[ko]=Qt 디자이너 파일
 Comment[lt]=Qt Designer byla
 Comment[lv]=Qt Dizainera Fails
+Comment[mk]=Qt Designer датотека
 Comment[mn]=Qt-Designer-Файл
 Comment[ms]=Fail Qt Designer
 Comment[mt]=Fajl Qt Designer
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-desktop.desktop kdelibs/mimetypes/application/x-desktop.desktop
--- kdelibs.orig/mimetypes/application/x-desktop.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-desktop.desktop	Tue Nov  9 08:35:29 2004
@@ -17,7 +17,7 @@
 Comment[eo]=Tabula agordo-dosiero
 Comment[es]=Archivo de configuración del escritorio
 Comment[et]=Töölaua seadistuste fail
-Comment[eu]=Idazmahai Konfigurazio Fitxategia
+Comment[eu]=Mahaigaina konfigurazio fitxategia
 Comment[fa]=پرونده‌ی تنظیم میزکار
 Comment[fi]=Työpöydän asetustiedosto
 Comment[fr]=Fichier de configuration du bureau
@@ -32,10 +32,12 @@
 Comment[ja]=デスクトップ設定ファイル
 Comment[ko]=일터 설정 파일
 Comment[lt]=Darbastalio derinimo byla
+Comment[mk]=Desktop конфигурациска датотека
 Comment[mn]=Ажилын талбарын тохиргоо
 Comment[ms]=Fail Config Ruang Kerja
 Comment[mt]=Fajl konfigurazzjoni desktop
 Comment[nb]=Konfigurasjonsfil til skrivebord
+Comment[nds]=Instellen-Datei
 Comment[nl]=Configuratiegegevens
 Comment[nn]=Skrivebordsoppsett-fil
 Comment[nso]=Faele ya Peakanyo ya Desktop
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-dvi.desktop kdelibs/mimetypes/application/x-dvi.desktop
--- kdelibs.orig/mimetypes/application/x-dvi.desktop	Tue Aug 31 09:21:44 2004
+++ kdelibs/mimetypes/application/x-dvi.desktop	Sat Oct 30 08:38:21 2004
@@ -32,6 +32,7 @@
 Comment[ja]=TeX Device Independen ファイル
 Comment[ko]=텍 장치에서 독립된 파일
 Comment[lt]=TeX nepriklausoma nuo įrengimų byla
+Comment[mk]=TeX датотека независна од уред
 Comment[mn]=TeX-DVI-Файл
 Comment[ms]=Fail Peranti TeX Tanpa Kebergantungan
 Comment[mt]=Fajl TeX Indipendenti mill-apparat
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-egon.desktop kdelibs/mimetypes/application/x-egon.desktop
--- kdelibs.orig/mimetypes/application/x-egon.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-egon.desktop	Sun Oct 24 09:02:05 2004
@@ -32,6 +32,7 @@
 Comment[mn]=Egon-Animator
 Comment[mt]=Animatur Egon
 Comment[nb]=Egon animasjon
+Comment[nds]=Egon-Animator
 Comment[nl]=Egon-animatieprogramma
 Comment[nn]=Egon-animasjon
 Comment[nso]=Sematlafatsi sa Egon
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-executable-script.desktop kdelibs/mimetypes/application/x-executable-script.desktop
--- kdelibs.orig/mimetypes/application/x-executable-script.desktop	Mon Sep 20 15:53:29 2004
+++ kdelibs/mimetypes/application/x-executable-script.desktop	Fri Nov 12 08:27:54 2004
@@ -1,6 +1,7 @@
 [Desktop Entry]
 Encoding=UTF-8
 Comment=Script (possibly executable)
+Comment[af]=Skrip (moointlik uitvoerbaar)
 Comment[bg]=Скрипт (вероятно изпълним)
 Comment[bn]=স্ক্রিপ্ট (সম্ভবত এক্সিকিউটেবল)
 Comment[bs]=Skripta (možda izvršiva)
@@ -17,7 +18,10 @@
 Comment[is]=Skeljaforrit (sem er ef til vill keyranlegt)
 Comment[it]=Script (eventualmente eseguibile)
 Comment[ja]=スクリプト (おそらく実行可能)
+Comment[lt]=Scenarijus (gal būt - vykdomoji byla)
+Comment[mk]=скрипта (можно да е извршна)
 Comment[nb]=Skript (kan kanskje kjøres)
+Comment[nds]=Skript (villicht utföhrbor)
 Comment[nl]=Script (mogelijk uitvoerbaar)
 Comment[nn]=Skript (kan kanskje køyrast)
 Comment[pa]=ਸਕ੍ਰਿਪਟ(ਸੰਭਵ ਤੌਰ ਤੇ ਚੱਲਣਯੋਗ)
@@ -25,11 +29,12 @@
 Comment[pt]='Script' (possivelmente executável)
 Comment[pt_BR]=Script que é provavelmente executável
 Comment[ro]=Script (care ar putea fi executat)
+Comment[ru]=Скрипт (возможно, запускаемый)
 Comment[se]=Skripta (dáidá leat vuolggahahtti)
 Comment[sk]=Skript (možno spustiteľný)
 Comment[sl]=Skript (verjetno izvedljiv)
 Comment[sr]=Скрипта (можда извршна)
-Comment[sr@Latn]=Скрипта (можда извршна)
+Comment[sr@Latn]=Skripta (možda izvršna)
 Comment[sv]=Skript (möjligen körbart)
 Comment[ta]=சிறுநிரல் (இயக்க முடிந்த)
 Comment[tg]=Скрипт (мумкин аст, ки ба кор бурда бошад)
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-executable.desktop kdelibs/mimetypes/application/x-executable.desktop
--- kdelibs.orig/mimetypes/application/x-executable.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-executable.desktop	Sat Oct 30 08:38:21 2004
@@ -31,6 +31,7 @@
 Comment[ja]=実行可能ファイル
 Comment[ko]=실행 파일
 Comment[lt]=Vykdoma byla
+Comment[mk]=Извршна датотека
 Comment[mn]=Программ
 Comment[ms]=Fail Boleh Laksana
 Comment[mt]=Programm
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-font-bdf.desktop kdelibs/mimetypes/application/x-font-bdf.desktop
--- kdelibs.orig/mimetypes/application/x-font-bdf.desktop	Tue Aug 31 09:21:44 2004
+++ kdelibs/mimetypes/application/x-font-bdf.desktop	Sat Oct 30 08:38:21 2004
@@ -35,6 +35,7 @@
 Comment[ja]=BDF ビットマップフォント
 Comment[ko]=BDF 비트맵 글꼴
 Comment[lt]=BDF taškinės grafikos (bitmap) šriftas
+Comment[mk]=BDF Bitmap фонт
 Comment[mn]=BDF-Bitmap-Бичиг
 Comment[ms]=Font BDF Bitmap
 Comment[mt]=Font BDF (bitmap)
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-font-ghostscript.desktop kdelibs/mimetypes/application/x-font-ghostscript.desktop
--- kdelibs.orig/mimetypes/application/x-font-ghostscript.desktop	Tue Aug 31 09:21:44 2004
+++ kdelibs/mimetypes/application/x-font-ghostscript.desktop	Tue Nov  9 08:35:29 2004
@@ -36,6 +36,7 @@
 Comment[ja]=GhostScript フォント
 Comment[ko]=고스트스크립트 글꼴
 Comment[lt]=Ghostscript šriftas
+Comment[mk]=Ghostscript фонт
 Comment[mn]=Ghostscript-Бичиг
 Comment[ms]=Font Ghostscript
 Comment[mt]=Font tal-GhostScript
@@ -58,7 +59,7 @@
 Comment[sr@Latn]=Ghostscript-ov font
 Comment[sv]=Ghostscript-teckensnitt
 Comment[ta]=Ghostscript எழுத்துரு
-Comment[tg]=Ҳарфи Ghostscript
+Comment[tg]=Ҳуруфи Ghostscript
 Comment[th]=แบบอักษรโกสต์สคริปต์
 Comment[tr]=Ghostscript Yazıtipi
 Comment[uk]=Шрифт Ghostscript
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-font-otf.desktop kdelibs/mimetypes/application/x-font-otf.desktop
--- kdelibs.orig/mimetypes/application/x-font-otf.desktop	Tue Aug 31 09:21:44 2004
+++ kdelibs/mimetypes/application/x-font-otf.desktop	Tue Nov  9 08:35:29 2004
@@ -1,6 +1,7 @@
 [Desktop Entry]
 Encoding=UTF-8
 Comment=OpenType Font
+Comment[af]=OpenType Skrif tipe
 Comment[ar]=خط OpenType
 Comment[az]=OpenType Yazı Növü
 Comment[be]=Шрыфт OpenType
@@ -21,6 +22,7 @@
 Comment[fa]=قلم OpenType
 Comment[fi]=OpenType-kirjasin
 Comment[fr]=Police de caractères OpenType
+Comment[ga]=Cló OpenType
 Comment[gl]=Fonte OpenType
 Comment[he]=גופן OpenType
 Comment[hi]=ओपन टाइप फ़ॉन्ट
@@ -31,6 +33,7 @@
 Comment[ja]=OpenType フォント
 Comment[ko]=오픈타입 글꼴
 Comment[lt]=OpenType šriftas
+Comment[mk]=OpenType фонт
 Comment[mn]=OpenType Бичиг
 Comment[ms]=Font OpenType
 Comment[nb]=OpenType skrift
@@ -51,7 +54,7 @@
 Comment[sr@Latn]=Opentype font
 Comment[sv]=Opentype-teckensnitt
 Comment[ta]=OpenType எழுத்துரு
-Comment[tg]=Ҳарфи Шакли Кушода
+Comment[tg]=Ҳуруфи Намуди Кушода
 Comment[th]=ตัวอักษรแบบโอเพ่นไทป์
 Comment[tr]=OpenType Yazıtipi
 Comment[uk]=Шрифт OpenType
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-font-pcf.desktop kdelibs/mimetypes/application/x-font-pcf.desktop
--- kdelibs.orig/mimetypes/application/x-font-pcf.desktop	Tue Aug 31 09:21:44 2004
+++ kdelibs/mimetypes/application/x-font-pcf.desktop	Sat Oct 30 08:38:21 2004
@@ -35,6 +35,7 @@
 Comment[ja]=PCF ビットマップフォント
 Comment[ko]=PCF 비트맵 글꼴
 Comment[lt]=PCF taškinės grafikos (bitmap) šriftas
+Comment[mk]=PCF Bitmap фонт
 Comment[mn]=PCF-Bitmap-Бичиг
 Comment[ms]=Font PCF Bitmap
 Comment[mt]=Font PCF (bitmap)
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-font-snf.desktop kdelibs/mimetypes/application/x-font-snf.desktop
--- kdelibs.orig/mimetypes/application/x-font-snf.desktop	Tue Aug 31 09:21:44 2004
+++ kdelibs/mimetypes/application/x-font-snf.desktop	Sat Oct 30 08:38:21 2004
@@ -35,6 +35,7 @@
 Comment[ja]=SNF ビットマップフォント
 Comment[ko]=SNF 비트맵 글꼴
 Comment[lt]=SBF taškinės grafikos (bitmap) šriftas
+Comment[mk]=SNF Bitmap фонт
 Comment[mn]=SNF Bitmap SNF Bitmap
 Comment[ms]=Font SNF Bitmap
 Comment[mt]=Font SNF (bitmap)
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-font-speedo.desktop kdelibs/mimetypes/application/x-font-speedo.desktop
--- kdelibs.orig/mimetypes/application/x-font-speedo.desktop	Tue Aug 31 09:21:44 2004
+++ kdelibs/mimetypes/application/x-font-speedo.desktop	Tue Nov  9 08:35:29 2004
@@ -36,6 +36,7 @@
 Comment[ja]=Speedo フォント
 Comment[ko]=스피도 글꼴
 Comment[lt]=Speedo šriftas
+Comment[mk]=Speedo фонт
 Comment[mn]=Speedo-Бичгийн хэлбэр
 Comment[ms]=Font Speedo
 Comment[mt]=Font "Speedo"
@@ -58,7 +59,7 @@
 Comment[sr@Latn]=Speedo font
 Comment[sv]=Speedo-teckensnitt
 Comment[ta]=ஸ்பீடோ எழுத்துருக்கள்
-Comment[tg]=Ҳарфи Speedo
+Comment[tg]=Ҳуруфи Speedo
 Comment[th]=แบบตัวอักษรสปีโด้
 Comment[tr]=Speedo Yazıtipi
 Comment[uk]=Шрифт Speedo
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-font-ttc.desktop kdelibs/mimetypes/application/x-font-ttc.desktop
--- kdelibs.orig/mimetypes/application/x-font-ttc.desktop	Tue Aug 31 09:21:44 2004
+++ kdelibs/mimetypes/application/x-font-ttc.desktop	Sat Oct 30 08:38:21 2004
@@ -1,6 +1,7 @@
 [Desktop Entry]
 Encoding=UTF-8
 Comment=TrueType Font Collection
+Comment[af]=Truetype Skrif Versameling
 Comment[ar]=مجموعة خطوط TrueType
 Comment[az]=TrueType Yazı Növü Kolleksiyası
 Comment[be]=Калекцыя шрыфтоў TrueType
@@ -31,6 +32,7 @@
 Comment[ja]=Truetype フォント コレクション
 Comment[ko]=트루타입 글꼴 모음
 Comment[lt]=TrueType šriftų rinkinys
+Comment[mk]=TrueType колекција од фонтови
 Comment[mn]=TrueType Бичгийн хэвүүд
 Comment[ms]=Koleksi Font Truetype
 Comment[nb]=Truetype-skrifttyper
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-font-ttf.desktop kdelibs/mimetypes/application/x-font-ttf.desktop
--- kdelibs.orig/mimetypes/application/x-font-ttf.desktop	Tue Aug 31 09:21:44 2004
+++ kdelibs/mimetypes/application/x-font-ttf.desktop	Tue Nov  9 08:35:29 2004
@@ -1,6 +1,7 @@
 [Desktop Entry]
 Encoding=UTF-8
 Comment=TrueType Font
+Comment[af]=Truetype Skrif tipe
 Comment[ar]=خط TrueType
 Comment[az]=TrueType Yazı Növü
 Comment[be]=Шрыфт TrueType
@@ -21,6 +22,7 @@
 Comment[fa]=قلم TrueType
 Comment[fi]=TrueType-kirjasin
 Comment[fr]=Police de caractères Truetype
+Comment[ga]=Cló TrueType
 Comment[gl]=Fonte Truetype
 Comment[he]=גופן Truetype
 Comment[hi]=ट्रू टाइप फ़ॉन्ट
@@ -31,6 +33,7 @@
 Comment[ja]=TrueTypeフォント
 Comment[ko]=트루타입 글꼴
 Comment[lt]=TrueType šriftas
+Comment[mk]=TrueType фонт
 Comment[mn]=TrueType-Бичиг
 Comment[ms]=Font Truetype
 Comment[nb]=Truetype-skrifttype
@@ -51,7 +54,7 @@
 Comment[sr@Latn]=TrueType font
 Comment[sv]=Truetype-teckensnitt
 Comment[ta]=TrueType எழுத்துரு
-Comment[tg]=Ҳарфи TrueType 
+Comment[tg]=Намуди асосии ҳуруф
 Comment[th]=ตัวอักษรแบบทรูไทป์
 Comment[tr]=TTF Yazıtipi
 Comment[uk]=Шрифт TrueType
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-font-type1.desktop kdelibs/mimetypes/application/x-font-type1.desktop
--- kdelibs.orig/mimetypes/application/x-font-type1.desktop	Tue Aug 31 09:21:44 2004
+++ kdelibs/mimetypes/application/x-font-type1.desktop	Sat Oct 30 08:38:21 2004
@@ -37,6 +37,7 @@
 Comment[ja]=PostScript Type1 フォント
 Comment[ko]=포스트스크립트 타입1 글꼴
 Comment[lt]=PostScript Type1 šriftas
+Comment[mk]=PostScript Type1 фонт
 Comment[mn]=Type1-Бичиг
 Comment[ms]=Font PostScript Type1
 Comment[mt]=Font PostScript Type1
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-gettext.desktop kdelibs/mimetypes/application/x-gettext.desktop
--- kdelibs.orig/mimetypes/application/x-gettext.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-gettext.desktop	Sat Oct 30 08:38:21 2004
@@ -1,6 +1,8 @@
 [Desktop Entry]
 Encoding=UTF-8
 Comment=GNU Gettext Message Catalog
+Comment[af]=GNU Gettext Boodskap Katalogus
+Comment[ar]=ملف ترجمة
 Comment[az]=GNU Gettext İsmarış Kataloqu
 Comment[bg]=Съобщения за превод (GNU Gettext)
 Comment[bn]=গনিউ গেট-টেক্সট বার্তা ক্যাটালগ
@@ -30,6 +32,7 @@
 Comment[ja]=GNU Gettext メッセージ カタログ
 Comment[ko]=GNU Gettext 메세지 일람표
 Comment[lt]=GNU Gettext pranešimų katalogas
+Comment[mk]=GNU Gettext Каталог на пораки
 Comment[mn]=GNU Gettext Мэдээний катлог
 Comment[ms]=Katalog Mesej GNU Gettext
 Comment[nb]=GNU gettext meldingskatalog
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-gnumeric.desktop kdelibs/mimetypes/application/x-gnumeric.desktop
--- kdelibs.orig/mimetypes/application/x-gnumeric.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-gnumeric.desktop	Sat Oct 30 08:38:21 2004
@@ -11,6 +11,7 @@
 Comment[be]=Электронная табліца GNUmeric
 Comment[bg]=Документ на GNUmeric
 Comment[bn]=গনিউমেরিক স্প্রেডশীট
+Comment[br]=Loger GNUmeric
 Comment[bs]=GNUmeric spreadsheet
 Comment[ca]=Fulla de càlcul de GNUmeric
 Comment[cs]=Tabulka programu Gnumeric
@@ -36,6 +37,7 @@
 Comment[ja]=GNUmeric スプレッドシート
 Comment[ko]=그누메릭(GNUmeric) 스프레드시트
 Comment[lt]=GNUmeric elektroninė lentelė
+Comment[mk]=GNUmeric табела
 Comment[mn]=GNUmeric-Өгөгдлийн хуудас
 Comment[ms]=Halaman Helaian GNUmeric
 Comment[mt]=Spreadsheet GNUmeric
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-graphite.desktop kdelibs/mimetypes/application/x-graphite.desktop
--- kdelibs.orig/mimetypes/application/x-graphite.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-graphite.desktop	Sat Oct 30 08:38:21 2004
@@ -35,11 +35,12 @@
 Comment[ja]=Graphite 科学技術用グラフ
 Comment[ko]=그래파이트 과학 그래프
 Comment[lt]=Graphite moksliniai grafikai
+Comment[mk]=Graphite научен график
 Comment[mn]=Graphit - Шинжлэх ухааны график
 Comment[ms]=Graf Saintifik Graphite
 Comment[mt]=Graff Xjentifiku Graphite
 Comment[nb]=Graphite - Vitenskaplige grafer
-Comment[nds]=Wetenschapliche Grafik vun Graphite
+Comment[nds]=Wetenschaplich Diagramm vun Graphite
 Comment[nl]=Graphite-grafiek
 Comment[nn]=Graphite vitskapleg graf
 Comment[nso]=Graph ya Boramahlale ya Graphite
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-gzdvi.desktop kdelibs/mimetypes/application/x-gzdvi.desktop
--- kdelibs.orig/mimetypes/application/x-gzdvi.desktop	Mon Sep 20 15:53:29 2004
+++ kdelibs/mimetypes/application/x-gzdvi.desktop	Fri Nov 12 08:27:54 2004
@@ -1,6 +1,7 @@
 [Desktop Entry]
 Encoding=UTF-8
 Comment=Gzip Compressed DVI File
+Comment[af]=Gzip Gekompakteerde DVI Lêer
 Comment[bg]=Компресиран файл DVI с gzip
 Comment[bn]=জি-জিপকৃত (gzipped) ডি-ভি-আই ফাইল
 Comment[bs]=Gzip komprimirana DVI datoteka
@@ -17,7 +18,10 @@
 Comment[is]=Gzip þjöppuð DVI skrá
 Comment[it]=File DVI compresso con Gzip
 Comment[ja]=Gzip 圧縮 DVI ファイル
+Comment[lt]=Gzip suspausta DVI byla
+Comment[mk]=Gzip компресирана DVI датотека
 Comment[nb]=Gzip-komprimert DVI-fil
+Comment[nds]=GZip-komprimeert DVI-Datei
 Comment[nl]=Met gzip gecomprimeerd DVI-bestand
 Comment[nn]=Gzip-komprimert DVI-fil
 Comment[pa]=Gzip ਨਪੀੜੀ DVI ਫਾਇਲ
@@ -25,11 +29,12 @@
 Comment[pt]=Ficheiro DVI Comprimido com GZip
 Comment[pt_BR]=Arquivo DVI compactado com o Gzip
 Comment[ro]=Fişier DVI comprimat cu Gzip
+Comment[ru]=Сжатый gzip файл DVI
 Comment[se]=Gzip-čoahkkáibáhkkejuvvon DVI-fiila
 Comment[sk]=Komprimovaný súbor DVI pomocou gzip
 Comment[sl]=Datoteka DVI, stisnjena s gzip-om
 Comment[sr]=Gzip компресовани DVI фајл
-Comment[sr@Latn]=Gzip компресовани DVI фајл
+Comment[sr@Latn]=Gzip kompresovani DVI fajl
 Comment[sv]=Gzip-komprimerad DVI-fil
 Comment[ta]=Gzip அழுத்திய கோப்பு
 Comment[tg]=Gzip Файли DVI фушурдашуда
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-gzip.desktop kdelibs/mimetypes/application/x-gzip.desktop
--- kdelibs.orig/mimetypes/application/x-gzip.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-gzip.desktop	Sat Oct 30 08:38:21 2004
@@ -34,11 +34,12 @@
 Comment[ja]=Gzip ファイル
 Comment[ko]=Gzip 파일
 Comment[lt]=Gzip byla
+Comment[mk]=Gzip датотека
 Comment[mn]=GZip-Файл
 Comment[ms]=Fail Gzip
 Comment[mt]=Arkivju Gzip
 Comment[nb]=GZip-fil
-Comment[nds]=Gzip-Datei
+Comment[nds]=GZip-Datei
 Comment[nl]=Gzip-bestand
 Comment[nn]=Gzip-fil
 Comment[nso]=Faele ya Gzip
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-gzpostscript.desktop kdelibs/mimetypes/application/x-gzpostscript.desktop
--- kdelibs.orig/mimetypes/application/x-gzpostscript.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-gzpostscript.desktop	Sat Oct 30 08:38:21 2004
@@ -31,11 +31,12 @@
 Comment[ja]=Gzip された Postscript ファイル
 Comment[ko]=Gzip으로 압축한 포스트스크립트 파일
 Comment[lt]=Suglaudinta su Gzip Postscript byla
+Comment[mk]=Gzip-увана PostScript датотека
 Comment[mn]=Gzip-р шахагдсан PostScript-Файл
 Comment[ms]=Fail PostScript diGzipkan
 Comment[mt]=Fajl Postscript gzippjat
 Comment[nb]=Gzippet Postscript-fil
-Comment[nds]=PostScript-Datei, de mit gzip komprimeert is
+Comment[nds]=PostScript-Datei, de mit GZip komprimeert is
 Comment[nl]=Met gzip gecomprimeerd PostScript-bestand
 Comment[nn]=Gzippa PostScript-fil
 Comment[nso]=Faele ya Setlankana sa Poso sa Gzipped
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-hancomword.desktop kdelibs/mimetypes/application/x-hancomword.desktop
--- kdelibs.orig/mimetypes/application/x-hancomword.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-hancomword.desktop	Sat Oct 30 08:38:21 2004
@@ -5,6 +5,7 @@
 Icon=wordprocessing
 Patterns=*.hwp;*.HWP;
 Comment=HancomWord Document
+Comment[af]=HancomWord Dokument
 Comment[ar]=مستند هانكوم وورد
 Comment[az]=HancomWord Sənədi
 Comment[be]=Дакумэнт HancomWord
@@ -36,6 +37,7 @@
 Comment[ja]=HancomWord ドキュメント
 Comment[ko]=한컴 글틀 문서
 Comment[lt]=HancomWord dokumentas
+Comment[mk]=HancomWord документ
 Comment[mn]=HancomWord-Баримт
 Comment[ms]=Dokumen HancomWord
 Comment[mt]=Dokument HancomWord
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-ica.desktop kdelibs/mimetypes/application/x-ica.desktop
--- kdelibs.orig/mimetypes/application/x-ica.desktop	Mon Sep 20 15:53:29 2004
+++ kdelibs/mimetypes/application/x-ica.desktop	Sat Nov 13 08:20:19 2004
@@ -2,10 +2,12 @@
 Encoding=UTF-8
 MimeType=application/x-ica
 Comment=Citrix ICA Client Configuration
+Comment[af]=Citrix ICA Klient Opstelling
 Comment[bg]=Конфигурация на клиент Citrix ICA
 Comment[bn]=সাইট্রিক্স ICA ক্লায়েন্ট কনফিগারেশন
 Comment[bs]=Citrix ICA Client postavke
 Comment[ca]=Configuració de client Citrix ICA
+Comment[cs]=Nastavení Citrix ICA klienta
 Comment[da]=Citrix ICA klientindstilling
 Comment[de]=Client-Einrichtung für Citrix ICA
 Comment[el]=Ρύθμιση πελάτη Citrix ICA
@@ -21,7 +23,10 @@
 Comment[it]=Configurazione client Citrix ICA
 Comment[ja]=Citrix ICA クライアント設定
 Comment[ko]=Citrix ICA 클라이언트 설정
+Comment[lt]=Citrix ICA kliento derinimas
+Comment[mk]=Citrix ICA конфигурација на клиент
 Comment[nb]=Oppsett av Citrix ICA-klient
+Comment[nds]=Client-Instellen för Citrix ICA
 Comment[nl]=Citrix ICA-werkstationinstellingen
 Comment[nn]=Oppsett av Citrix ICA-klient
 Comment[pa]=Citrix ICA ਕਲਾਂਇਟ ਸੰਰਚਨਾ
@@ -29,10 +34,11 @@
 Comment[pt]=Configuração do Cliente de Citrix ICA
 Comment[pt_BR]=Configuração do Cliente ICA Citrix
 Comment[ro]=Configurare client Citrix ICA
+Comment[ru]=Параметры клиента Citrix ICA
 Comment[se]=Heivet Citrix ICA-klientta
 Comment[sk]=Konfigurácia klienta Citrix ICA
 Comment[sr]=Подешавање Citrix-овог ICA клијента
-Comment[sr@Latn]=Подешавање Citrix-овог ICA клијента
+Comment[sr@Latn]=Podešavanje Citrix-ovog ICA klijenta
 Comment[sv]=Citrix ICA-klientanpassning
 Comment[ta]=Citrix ICA உறுப்பினம் வடிவமைப்பு
 Comment[tg]=Танзимоти коргири Citrix ICA
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-iso.desktop kdelibs/mimetypes/application/x-iso.desktop
--- kdelibs.orig/mimetypes/application/x-iso.desktop	Mon Sep 20 15:53:29 2004
+++ kdelibs/mimetypes/application/x-iso.desktop	Fri Nov 12 08:27:54 2004
@@ -4,6 +4,7 @@
 MimeType=application/x-iso
 Icon=cdtrack
 Comment=ISO9660 Image File
+Comment[af]=ISO9660 CD-Beeld Leêr
 Comment[be]=Файл вобразу ISO9660
 Comment[bg]=Файл снимка ISO9660
 Comment[bn]=ISO9660 ইমেজ ফাইল
@@ -21,7 +22,10 @@
 Comment[is]=ISO9660 diskmynd
 Comment[it]=File immagine ISO9660
 Comment[ja]=ISO9660 イメージ ファイル
+Comment[lt]=ISO9660 atvaizdo byla
+Comment[mk]=Датотека со ISO9660 слика
 Comment[nb]=ISO9660-biletfil
+Comment[nds]=ISO9660-Bilddatei
 Comment[nl]=ISO9660-beeldbestand
 Comment[nn]=ISO9660-biletfil
 Comment[pa]=ISO9660 ਪ੍ਰਤੀਬਿੰਬ ਫਾਇਲ਼
@@ -29,11 +33,12 @@
 Comment[pt]=Ficheiro com Imagem ISO9660
 Comment[pt_BR]=Arquivo de Imagem ISO9660
 Comment[ro]=Fişier imagine ISO9660
+Comment[ru]=Файл образа ISO9660
 Comment[se]=ISO9660-govvafiila
 Comment[sk]=Obraz disku ISO9660
 Comment[sl]=Podoba plošče ISO9660
 Comment[sr]=Фајл ISO9660 слике
-Comment[sr@Latn]=Фајл ISO9660 слике
+Comment[sr@Latn]=Fajl ISO9660 slike
 Comment[sv]=ISO9660-avbildsfil
 Comment[ta]=ISO9660 பிம்பக் கோப்பு
 Comment[tg]=Файли тасвири ISO9660
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-java-applet.desktop kdelibs/mimetypes/application/x-java-applet.desktop
--- kdelibs.orig/mimetypes/application/x-java-applet.desktop	Tue Aug 31 09:21:44 2004
+++ kdelibs/mimetypes/application/x-java-applet.desktop	Sat Oct 30 08:38:21 2004
@@ -2,6 +2,7 @@
 Encoding=UTF-8
 Type=MimeType
 Comment=Java Applet
+Comment[af]=Java Program
 Comment[ar]=بريمج جافا
 Comment[az]=Java Appleti
 Comment[bg]=Аплет на Java
@@ -30,8 +31,10 @@
 Comment[ja]=Java アプレット
 Comment[ko]=자바 애플릿
 Comment[lt]=Java įskiepis
+Comment[mk]=Java аплет
 Comment[mn]=Java-Апплет
 Comment[ms]=Aplet Java
+Comment[nds]=Java-Programm
 Comment[nn]=Java-applet
 Comment[pa]=ਜਾਵਾ(Java) ਐਪਲਿਟ
 Comment[pl]=Aplet Javy
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-javascript.desktop kdelibs/mimetypes/application/x-javascript.desktop
--- kdelibs.orig/mimetypes/application/x-javascript.desktop	Sun Sep 12 15:56:15 2004
+++ kdelibs/mimetypes/application/x-javascript.desktop	Fri Nov 12 08:27:54 2004
@@ -4,6 +4,7 @@
 Icon=Script
 Patterns=*.js;
 Comment=JavaScript File
+Comment[af]=JavaScript Lêer
 Comment[be]=Файл JavaScript
 Comment[bg]=Изходен код на JavaScript
 Comment[bn]=জাভাস্ক্রিপ্ট ফাইল
@@ -18,12 +19,16 @@
 Comment[et]=JavaScripti fail
 Comment[fi]=JavaScript-tiedosto
 Comment[fr]=Fichier JavaScript
+Comment[ga]=Comhad JavaScript
 Comment[he]=קובץ JavaScript
 Comment[hu]=JavaScript-fájl
 Comment[is]=JavaScript-skrá
 Comment[it]=File JavaScript
 Comment[ja]=JavaScript ファイル
+Comment[lt]=JavaScript byla
+Comment[mk]=JavaScript датотека
 Comment[nb]=JavaScript-fil
+Comment[nds]=JavaScript-Datei
 Comment[nl]=JavaScript-bestand
 Comment[nn]=JavaScript-fil
 Comment[pa]=ਜਾਵਾ-ਸਕ੍ਰਿਪਟ ਫਾਇਲ
@@ -31,11 +36,12 @@
 Comment[pt]=Ficheiro JavaScript
 Comment[pt_BR]=Arquivo JavaScript
 Comment[ro]=Fişier JavaScript
+Comment[ru]=Файл JavaScript
 Comment[se]=JavaScript-fiila
 Comment[sk]=Zdrojový kód JavaScript
 Comment[sl]=Datoteka JavaScript
 Comment[sr]=JavaScript фајл
-Comment[sr@Latn]=JavaScript фајл
+Comment[sr@Latn]=JavaScript fajl
 Comment[sv]=Javaskript-fil
 Comment[ta]=ஜாவா மூலக் கோப்பு
 Comment[tg]=Файли барномавии Java
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-karbon.desktop kdelibs/mimetypes/application/x-karbon.desktop
--- kdelibs.orig/mimetypes/application/x-karbon.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-karbon.desktop	Sat Oct 30 08:38:21 2004
@@ -38,6 +38,7 @@
 Comment[ko]=Karbon14 문서
 Comment[lt]=Karbon14 dokumentas
 Comment[lv]=Karbon14 Dokuments
+Comment[mk]=Karbon14 документ
 Comment[mn]=Karbon14-Баримт
 Comment[ms]=Dokumen Karbon14
 Comment[mt]=Dokument Karbon14
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-kchart.desktop kdelibs/mimetypes/application/x-kchart.desktop
--- kdelibs.orig/mimetypes/application/x-kchart.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-kchart.desktop	Sat Oct 30 08:38:21 2004
@@ -37,6 +37,7 @@
 Comment[ja]=KChart ドキュメント
 Comment[ko]=K도표 문서
 Comment[lt]=KChart dokumentas
+Comment[mk]=KChart документ
 Comment[mn]=Karbon14-Баримт
 Comment[ms]=Dokumen KChart
 Comment[mt]=Dokument KChart
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-kcsrc.desktop kdelibs/mimetypes/application/x-kcsrc.desktop
--- kdelibs.orig/mimetypes/application/x-kcsrc.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-kcsrc.desktop	Sat Oct 30 08:38:21 2004
@@ -5,6 +5,7 @@
 Icon=colorscm
 Patterns=*.kcsrc;*.KCSRC
 Comment=KDE Color Theme
+Comment[af]=KDE Kleur Tema
 Comment[ar]=سمة الألوان لKDE
 Comment[az]=KDE Rəng Örtüyü
 Comment[be]=Тэма колераў KDE
@@ -35,6 +36,7 @@
 Comment[ja]=KDE カラー テーマ
 Comment[ko]=KDE 색 테마
 Comment[lt]=KDE spalvų tema
+Comment[mk]=KDE колор тема
 Comment[mn]=КДЭ Өнгө загвар
 Comment[ms]=Tema Warna KDE
 Comment[nb]=KDE fargetema
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-kde-wallet.desktop kdelibs/mimetypes/application/x-kde-wallet.desktop
--- kdelibs.orig/mimetypes/application/x-kde-wallet.desktop	Tue Aug 31 09:21:44 2004
+++ kdelibs/mimetypes/application/x-kde-wallet.desktop	Wed Nov 10 08:36:33 2004
@@ -3,6 +3,7 @@
 Type=MimeType
 MimeType=application/x-kde-wallet
 Comment=KDE Wallet File
+Comment[af]=KDE Beursie Lêer
 Comment[ar]=ملف محفظة KDE
 Comment[az]=KDE Wallet Faylı
 Comment[bg]=Файл на системата Портфейл
@@ -29,9 +30,10 @@
 Comment[hu]=KDE digitális noteszfájl
 Comment[is]=KDE veski
 Comment[it]=File portafogli di KDE
-Comment[ja]=KDE Wallet ファイル
+Comment[ja]=KDE ウォレット ファイル
 Comment[ko]=KDE 지갑 파일
 Comment[lt]=KDE Piniginės byla
+Comment[mk]=KDE датотека-паричник
 Comment[mn]=КДЭ Wallet файл
 Comment[nb]=KDE lommebokfil
 Comment[nds]=KDE Wallet-Datei
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-kformula.desktop kdelibs/mimetypes/application/x-kformula.desktop
--- kdelibs.orig/mimetypes/application/x-kformula.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-kformula.desktop	Sat Oct 30 08:38:21 2004
@@ -5,7 +5,7 @@
 Icon=kformula_kfo
 Patterns=*.kfo;
 Comment=KFormula Document
-Comment[af]=Kformula Dokument
+Comment[af]=KFormula Dokument
 Comment[ar]=مستند KFormula
 Comment[az]=KFormula Sənədi
 Comment[be]=Дакумэнт KFormula
@@ -37,6 +37,7 @@
 Comment[ja]=KFormula ドキュメント
 Comment[ko]=K포뮬라 문서
 Comment[lt]=KFormula dokumentas
+Comment[mk]=KFormula документ
 Comment[mn]=KFormula Баримт
 Comment[ms]=Dokumen KFormula
 Comment[mt]=Dokument KFormula
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-kivio.desktop kdelibs/mimetypes/application/x-kivio.desktop
--- kdelibs.orig/mimetypes/application/x-kivio.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-kivio.desktop	Sat Oct 30 08:38:21 2004
@@ -38,6 +38,7 @@
 Comment[ja]=Kivio ドキュメント
 Comment[ko]=키비오 문서
 Comment[lt]=Kivio dokumentas
+Comment[mk]=Kivio документ
 Comment[mn]=Kivio-Баримт
 Comment[ms]=Dokumen Kivio
 Comment[mt]=Dokument Kivio
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-kontour.desktop kdelibs/mimetypes/application/x-kontour.desktop
--- kdelibs.orig/mimetypes/application/x-kontour.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-kontour.desktop	Sat Oct 30 08:38:21 2004
@@ -34,6 +34,7 @@
 Comment[it]=Documento Kontour
 Comment[ja]=Kontour ドキュメント
 Comment[lt]=Kontour dokumentas
+Comment[mk]=Kontour документ
 Comment[mn]=Kontour-Баримт
 Comment[ms]=Dokumen Kontour
 Comment[mt]=Dokument Kontour
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-kpovmodeler.desktop kdelibs/mimetypes/application/x-kpovmodeler.desktop
--- kdelibs.orig/mimetypes/application/x-kpovmodeler.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-kpovmodeler.desktop	Sat Oct 30 08:38:21 2004
@@ -32,6 +32,7 @@
 Comment[ja]=KPovModeler ファイル
 Comment[lt]=KPovModeler byla
 Comment[lv]=KPovModeler Fails
+Comment[mk]=KPovModeler датотека
 Comment[mn]=KDE-н Povray-Моделлчиллын файл
 Comment[ms]=Fail KPovModeler 
 Comment[mt]=Fajl KPovModeler
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-kpresenter.desktop kdelibs/mimetypes/application/x-kpresenter.desktop
--- kdelibs.orig/mimetypes/application/x-kpresenter.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-kpresenter.desktop	Sat Oct 30 08:38:21 2004
@@ -37,6 +37,7 @@
 Comment[it]=Documento KPresenter
 Comment[ja]=KPresenter ファイル
 Comment[lt]=KPresenter dokumentas
+Comment[mk]=KPresenter документ
 Comment[mn]=KPresenter 
 Comment[ms]=Dokumen KPresenter
 Comment[mt]=Dokument KPresenter
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-krita.desktop kdelibs/mimetypes/application/x-krita.desktop
--- kdelibs.orig/mimetypes/application/x-krita.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-krita.desktop	Sat Oct 30 08:38:21 2004
@@ -37,6 +37,7 @@
 Comment[it]=Documento Krita
 Comment[ja]=Krita ドキュメント
 Comment[lt]=Krita dokumentas
+Comment[mk]=Krita документ
 Comment[mn]=Krita-Баримт
 Comment[ms]=Dokumen Krita
 Comment[mt]=Dokument Krita
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-kspread.desktop kdelibs/mimetypes/application/x-kspread.desktop
--- kdelibs.orig/mimetypes/application/x-kspread.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-kspread.desktop	Sat Oct 30 08:38:21 2004
@@ -37,6 +37,7 @@
 Comment[it]=Documento KSpread
 Comment[ja]=KSpread ドキュメント
 Comment[lt]=KSpread dokumentas
+Comment[mk]=KSpread документ
 Comment[mn]=Шинэ KSpread-баримт
 Comment[ms]=Dokumen KSpread
 Comment[mt]=Spreadsheet KSpread
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-kudesigner.desktop kdelibs/mimetypes/application/x-kudesigner.desktop
--- kdelibs.orig/mimetypes/application/x-kudesigner.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-kudesigner.desktop	Sat Oct 30 08:38:21 2004
@@ -3,6 +3,8 @@
 Encoding=UTF-8
 MimeType=application/x-kudesigner
 Comment=Kugar Report Template
+Comment[af]=Kugar Raport Voorbeeld
+Comment[ar]=قالب تقارير كوغار
 Comment[az]=Kugar Report Sənədi
 Comment[be]=Шаблён справаздачы Kugar
 Comment[bg]=Шаблон за рапорт на Kugar
@@ -31,6 +33,7 @@
 Comment[it]=Modello di rapporti Kugar
 Comment[ja]=Kugar リポートテンプレート
 Comment[lt]=Kugar ataskaitų byla
+Comment[mk]=Kugar шаблон за извештај
 Comment[mn]=Kugar тайлан загвар
 Comment[ms]=Templat Laporan Kugar
 Comment[nb]=Kugar rapportmal
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-kugar.desktop kdelibs/mimetypes/application/x-kugar.desktop
--- kdelibs.orig/mimetypes/application/x-kugar.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-kugar.desktop	Sat Oct 30 08:38:21 2004
@@ -36,6 +36,7 @@
 Comment[ja]=Kugar データファイル
 Comment[lt]=Kugar duomenų byla
 Comment[lv]=Kugar Datu Fails
+Comment[mk]=Kugar датотека со податоци
 Comment[mn]=Kugar-Өгөгдлийн файл
 Comment[ms]=Fail Data Kugar
 Comment[mt]=Fajl tad-Data ta' Kugar
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-kword.desktop kdelibs/mimetypes/application/x-kword.desktop
--- kdelibs.orig/mimetypes/application/x-kword.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-kword.desktop	Sat Oct 30 08:38:21 2004
@@ -38,6 +38,7 @@
 Comment[ja]=KWord ドキュメント
 Comment[ko]=K워드 문서
 Comment[lt]=KWord dokumentas
+Comment[mk]=KWord документ
 Comment[mn]=Шинэ KWord-баримт
 Comment[ms]=Dokumen KWord
 Comment[mt]=Dokument KWord
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-lha.desktop kdelibs/mimetypes/application/x-lha.desktop
--- kdelibs.orig/mimetypes/application/x-lha.desktop	Tue Aug 24 08:29:48 2004
+++ kdelibs/mimetypes/application/x-lha.desktop	Sat Oct 30 08:38:21 2004
@@ -34,6 +34,7 @@
 Comment[ja]=Lha アーカイブ
 Comment[ko]=LHA 저장고
 Comment[lt]=Lha archyvas
+Comment[mk]=Lha архива
 Comment[mn]=LHA-Архив
 Comment[ms]=Arkib Lha
 Comment[mt]=Arkivju LHA
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-linguist.desktop kdelibs/mimetypes/application/x-linguist.desktop
--- kdelibs.orig/mimetypes/application/x-linguist.desktop	Tue Aug 31 09:21:45 2004
+++ kdelibs/mimetypes/application/x-linguist.desktop	Sat Oct 30 08:38:21 2004
@@ -5,6 +5,8 @@
 Icon=gettext
 Patterns=*.ts;
 Comment=Qt Translation Source File
+Comment[af]=Qt Vertaal Bronlêer
+Comment[ar]=ملف ترجمة QT مصدري
 Comment[az]=Qt Tərcümə Mənbəsi Faylı
 Comment[bg]=Съобщения за превод (Qt)
 Comment[bn]=কিউ-টি অনুবাদ সোর্স ফাইল
@@ -33,6 +35,7 @@
 Comment[ja]=Qt 翻訳 ソースファイル
 Comment[ko]=Qt 번역 밑그림 파일
 Comment[lt]=Qt vertimų išeities tekstų byla
+Comment[mk]=Qt Изворна датотека со превод
 Comment[mn]=Qt Орчуулгын эх файл
 Comment[ms]=Fail Penterjemahan Sumber Qt
 Comment[nb]=Qt kildekode for oversetting
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-lyx.desktop kdelibs/mimetypes/application/x-lyx.desktop
--- kdelibs.orig/mimetypes/application/x-lyx.desktop	Tue Aug 24 08:29:49 2004
+++ kdelibs/mimetypes/application/x-lyx.desktop	Sat Oct 30 08:38:21 2004
@@ -34,6 +34,7 @@
 Comment[ko]=LyX 문서
 Comment[lt]=LyX dokumentas
 Comment[lv]=LyX Dokuments
+Comment[mk]=LyX документ
 Comment[mn]=LyX-баримт
 Comment[ms]=Dokumen LyX
 Comment[mt]=Dokument LyX
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-lzop.desktop kdelibs/mimetypes/application/x-lzop.desktop
--- kdelibs.orig/mimetypes/application/x-lzop.desktop	Tue Aug 24 08:29:49 2004
+++ kdelibs/mimetypes/application/x-lzop.desktop	Sat Oct 30 08:38:21 2004
@@ -39,7 +39,7 @@
 Comment[lt]=suglaudinta su LZO byla
 Comment[lv]=Lzopped Fails
 Comment[mi]=Konae Lzop
-Comment[mk]=Lzopped датотека
+Comment[mk]=Lzop-увана датотека
 Comment[mn]=Lzopp-Файл
 Comment[ms]=Fail Lzopped
 Comment[mt]=Fajl Lzop
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-magicpoint.desktop kdelibs/mimetypes/application/x-magicpoint.desktop
--- kdelibs.orig/mimetypes/application/x-magicpoint.desktop	Tue Aug 24 08:29:49 2004
+++ kdelibs/mimetypes/application/x-magicpoint.desktop	Sat Oct 30 08:38:21 2004
@@ -5,6 +5,8 @@
 Icon=presentation
 Patterns=*.mgp;*.MGP;
 Comment=MagicPoint Presentation
+Comment[af]=MagicPoint Voorlegging
+Comment[ar]=مستند MagicPoint
 Comment[az]=MagicPoint Sənədi
 Comment[be]=Прэзэнтацыя MagicPoint
 Comment[bg]=Документ на MagicPoint
@@ -23,6 +25,7 @@
 Comment[fa]=نمایش MagicPoint
 Comment[fi]=MagicPoint-esitys
 Comment[fr]=Présentation Magicpoint
+Comment[ga]=Láithreán MagicPoint
 Comment[gl]=Presentación MagicPoint
 Comment[he]=מצגת MagicPoint
 Comment[hi]=मेजिकपाइंट प्रेजेन्टेशन
@@ -32,10 +35,11 @@
 Comment[it]=Presentazione MagicPoint
 Comment[ja]=MagicPoint プレゼンテーション
 Comment[lt]=MagicPoint pristatymas
+Comment[mk]=MagicPoint презентација
 Comment[mn]=MagicPoint Үзүүлэнгүүд
 Comment[ms]=Persembahan Magicpoint
 Comment[nb]=MagicPoint presentasjon
-Comment[nds]=MagicPoint Präsentatschoon
+Comment[nds]=MagicPoint Presentatschoon
 Comment[nl]=MagicPoint-presentatie
 Comment[nn]=MagicPoint-presentasjon
 Comment[pa]=MagicPoint ਪੇਸ਼ਕਾਰੀ
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-msaccess.desktop kdelibs/mimetypes/application/x-msaccess.desktop
--- kdelibs.orig/mimetypes/application/x-msaccess.desktop	Tue Aug 24 08:29:49 2004
+++ kdelibs/mimetypes/application/x-msaccess.desktop	Sat Oct 30 08:38:21 2004
@@ -5,6 +5,8 @@
 Icon=database
 Patterns=*.mdb;*.MDB;*.mda;*.MDA;*.mde;*.MDE;
 Comment=Microsoft Access Database
+Comment[af]=Microsoft Access Databasis
+Comment[ar]=قاعدة بيانات مايكروسوفت أكسيس
 Comment[az]=Microsoft Access Databeyzi
 Comment[be]=База дадзеных Microsoft Access
 Comment[bg]=Документ на Microsoft Access
@@ -22,6 +24,7 @@
 Comment[fa]=بانک اطلاعاتی مایکروسافت اکسس
 Comment[fi]=Microsoft Access -tietokanta
 Comment[fr]=Base de données Microsoft Access
+Comment[ga]=Bunachar Sonraí Microsoft Access
 Comment[gl]=Base de Datos de Microsoft Access
 Comment[he]=בסיס נתונים של Microsoft Access
 Comment[hi]=माइक्रोसॉफ्ट एक्सेस डाटाबेस
@@ -32,10 +35,11 @@
 Comment[ja]=Microsoft Access データベース
 Comment[ko]=마이크로소프트 엑세스 데이타베이스
 Comment[lt]=Microsoft Access duombazė
+Comment[mk]=Microsoft Access база на податоци
 Comment[mn]=Microsoft Access Өгөгдлийн бааз
 Comment[ms]=Pangkalan Data Microsoft Access
 Comment[nb]=Microsoft Access database
-Comment[nds]=Microsoft Access Datenbank
+Comment[nds]=Microsoft-Access-Datenbank
 Comment[nl]=Microsoft Access-database
 Comment[nn]=Microsoft Access-database
 Comment[pa]= ਮਾਈਕਰੋਸਾਫਟ Access ਡਾਟਾਬੇਸ
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-msdos-program.desktop kdelibs/mimetypes/application/x-msdos-program.desktop
--- kdelibs.orig/mimetypes/application/x-msdos-program.desktop	Tue Aug 31 09:21:45 2004
+++ kdelibs/mimetypes/application/x-msdos-program.desktop	Sat Oct 30 08:38:21 2004
@@ -1,6 +1,6 @@
 [KDE Desktop Entry]
 Comment=Windows Executable
-Comment[af]=Vensters Uitvoerbare
+Comment[af]=Windows Uitvoerbare
 Comment[ar]=ملف وندوز تشغيلي
 Comment[az]=Windows İcraçısı
 Comment[bg]=Изпълним файл на Windows
@@ -30,10 +30,11 @@
 Comment[ja]=Windows 実行ファイル
 Comment[ko]=윈도우즈 실행 파일
 Comment[lt]=Windows vykdoma byla
+Comment[mk]=Windows извршна
 Comment[mn]=Виндовсын ажлын файл
 Comment[ms]=Windows boleh-laksana
 Comment[nb]=Kjørbart program for Windows
-Comment[nds]=Windows-Datei, de een utföhren kunn
+Comment[nds]=Windows-Programm
 Comment[nl]=Windows-programma
 Comment[nn]=Windowsprogram
 Comment[nso]=Di-Window tseo di Phethagatsegago
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-msmetafile.desktop kdelibs/mimetypes/application/x-msmetafile.desktop
--- kdelibs.orig/mimetypes/application/x-msmetafile.desktop	Mon Sep 20 15:53:29 2004
+++ kdelibs/mimetypes/application/x-msmetafile.desktop	Sat Oct 30 08:38:21 2004
@@ -5,6 +5,7 @@
 MimeType=application/x-msmetafile
 Patterns=*.wmf;*.WMF
 Comment=Microsoft Metafile
+Comment[af]=Microsoft Meta-Lêer
 Comment[bg]=Мета файл на Microsoft
 Comment[bn]=মাইক্রোসফ্‌ট মেটা-ফাইল
 Comment[ca]=Metafitxer Microsoft
@@ -23,7 +24,9 @@
 Comment[it]=Metafile Microsoft
 Comment[ja]=Microsoft メタファイル
 Comment[ko]=마이크로소프트 메타 파일
+Comment[mk]=Windows метадатотека
 Comment[nb]=Microsoft-metafil
+Comment[nds]=Microsoft Metadatei
 Comment[nl]=Microsoft-metabestand
 Comment[nn]=Microsoft-metafil
 Comment[pa]=ਮਾਈਕਰੋਸਾਫਟ ਮੈਟਾ ਫਾਇਲ
@@ -31,10 +34,11 @@
 Comment[pt]=Meta-ficheiro Microsoft
 Comment[pt_BR]=MetaArquivo Microsoft
 Comment[ro]=Microsoft MetaFile
+Comment[ru]=Метафайл Microsoft
 Comment[se]=Microsoft-metafiila
 Comment[sk]=Metafile Microsoft
 Comment[sr]=Microsoft-ов метафајл
-Comment[sr@Latn]=Microsoft-ов метафајл
+Comment[sr@Latn]=Microsoft-ov metafajl
 Comment[sv]=Microsoft-metafil
 Comment[ta]=மைக்ரோசாஃட் மெடாகோப்பு
 Comment[tg]=Метафайли QPicture
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-mswrite.desktop kdelibs/mimetypes/application/x-mswrite.desktop
--- kdelibs.orig/mimetypes/application/x-mswrite.desktop	Tue Aug 24 08:29:49 2004
+++ kdelibs/mimetypes/application/x-mswrite.desktop	Sat Oct 30 08:38:21 2004
@@ -37,6 +37,7 @@
 Comment[ja]=Microsoft Write ドキュメント
 Comment[ko]=마이크로소프트 글틀 문서
 Comment[lt]=Microsoft Write dokumentas
+Comment[mk]=Microsoft Write документ
 Comment[mn]=MS-Write-баримт
 Comment[ms]=Dokumen Microsoft Write
 Comment[mt]=Dokument Microsoft Write
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-ogg.desktop kdelibs/mimetypes/application/x-ogg.desktop
--- kdelibs.orig/mimetypes/application/x-ogg.desktop	Tue Aug 31 09:21:45 2004
+++ kdelibs/mimetypes/application/x-ogg.desktop	Sat Oct 30 08:38:21 2004
@@ -35,6 +35,7 @@
 Comment[ja]=Ogg マルチメディア
 Comment[ko]=Ogg 멀티미디어
 Comment[lt]=Ogg multimedija
+Comment[mk]=Ogg мултимедија
 Comment[mn]=Ogg Мултимедиа
 Comment[ms]=Multimedia Ogg
 Comment[mt]=Awdjo OGG
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-pak.desktop kdelibs/mimetypes/application/x-pak.desktop
--- kdelibs.orig/mimetypes/application/x-pak.desktop	Mon Sep 20 15:53:29 2004
+++ kdelibs/mimetypes/application/x-pak.desktop	Fri Nov 12 08:27:54 2004
@@ -5,6 +5,7 @@
 Icon=tgz
 Patterns=*.pak;*.PAK;
 Comment=PAK File Archive
+Comment[af]=PAK Argief
 Comment[be]=Архіў PAK
 Comment[bg]=Архив PAK
 Comment[bn]=PAK ফাইল আর্কাইভ
@@ -22,7 +23,10 @@
 Comment[is]=PAK safnskrá
 Comment[it]=Archivio file PAK
 Comment[ja]=PAK ファイルアーカイブ
+Comment[lt]=PAK bylos archyvas
+Comment[mk]=PAK датотечна архива
 Comment[nb]=PAK-filarkiv
+Comment[nds]=PAK-Dateiarchiv
 Comment[nl]=PAK-archief
 Comment[nn]=PAK-filarkiv
 Comment[pa]=PAK ਫਾਇਲ਼ ਸੁਕੰਚਿਤ
@@ -30,11 +34,12 @@
 Comment[pt]=Arquivo de Ficheiros PAK
 Comment[pt_BR]=Arquivo PAK
 Comment[ro]=Arhivă PAK
+Comment[ru]=Архив PAK
 Comment[se]=PAK-fiilaarkiiva
 Comment[sk]=Archív PAK
 Comment[sl]=Datotečni arhiv PAK
 Comment[sr]=Фајл PAK архиве
-Comment[sr@Latn]=Фајл PAK архиве
+Comment[sr@Latn]=Fajl PAK arhive
 Comment[sv]=PAK-filarkiv
 Comment[ta]=PAK கோப்பு காப்பகம்
 Comment[tg]=Файли архивии PAK
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-perl-module.desktop kdelibs/mimetypes/application/x-perl-module.desktop
--- kdelibs.orig/mimetypes/application/x-perl-module.desktop	Tue Aug 24 08:29:49 2004
+++ kdelibs/mimetypes/application/x-perl-module.desktop	Sat Oct 30 08:38:21 2004
@@ -21,6 +21,7 @@
 Comment[fa]=بخش Perl
 Comment[fi]=PERL-moduuli
 Comment[fr]=Module PERL
+Comment[ga]=Modúl PERL
 Comment[gl]=Módulo de PERL
 Comment[he]=מודול שך Perl
 Comment[hi]=पर्ल मॉड्यूल
@@ -31,10 +32,11 @@
 Comment[ja]=PERL モジュール
 Comment[ko]=펄 모듈
 Comment[lt]=PERL modulis
+Comment[mk]=PERL модул
 Comment[mn]=PERL Модул
 Comment[ms]=Modul PERL
 Comment[nb]=PERL-modul
-Comment[nds]=PERL-Modul
+Comment[nds]=PERL-Moduul
 Comment[nl]=PERL-module
 Comment[nn]=PERL-modul
 Comment[pa]=PERL ਮੈਡੀਊਲ
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-perl.desktop kdelibs/mimetypes/application/x-perl.desktop
--- kdelibs.orig/mimetypes/application/x-perl.desktop	Tue Aug 24 08:29:49 2004
+++ kdelibs/mimetypes/application/x-perl.desktop	Tue Nov  9 08:35:29 2004
@@ -33,6 +33,7 @@
 Comment[ja]=PERL プログラム
 Comment[ko]=펄 프로그램
 Comment[lt]=PERL programa
+Comment[mk]=PERL програма
 Comment[mn]=Perl-Программ
 Comment[ms]=Program PERL
 Comment[mt]=Programm PERL
@@ -56,7 +57,7 @@
 Comment[ss]=Luhlelo lwe PERL 
 Comment[sv]=Perl-program
 Comment[ta]=பேர்ல் நிரல்
-Comment[tg]=Программаи PERL
+Comment[tg]=Барномаи PERL
 Comment[th]=โปรแกรมเพิร์ล
 Comment[tr]=PERL Programı
 Comment[uk]=Програма PERL
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-php.desktop kdelibs/mimetypes/application/x-php.desktop
--- kdelibs.orig/mimetypes/application/x-php.desktop	Tue Aug 24 08:29:49 2004
+++ kdelibs/mimetypes/application/x-php.desktop	Sat Oct 30 08:38:21 2004
@@ -1,6 +1,8 @@
 [Desktop Entry]
 Encoding=UTF-8
 Comment=PHP Script
+Comment[af]=PHP Skrip
+Comment[ar]=ملف PHP
 Comment[az]=PHP Skripti
 Comment[be]=Скрыпт PHP
 Comment[bg]=Скрипт на PHP
@@ -20,6 +22,7 @@
 Comment[fa]=نویسه‌ی PHP
 Comment[fi]=PHP-skripti
 Comment[fr]=Script PHP
+Comment[ga]=Script PHP
 Comment[gl]=Script en PHP
 Comment[he]=תסריט PHP
 Comment[hi]=PHP स्क्रिप्ट
@@ -30,6 +33,7 @@
 Comment[ja]=PHP スクリプト
 Comment[ko]=PHP 스크립트
 Comment[lt]=PHP skriptas
+Comment[mk]=PHP скрипта
 Comment[mn]=PHP скрипт
 Comment[nb]=PHP-skript
 Comment[nds]=PHP-Skript
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-pkcs12.desktop kdelibs/mimetypes/application/x-pkcs12.desktop
--- kdelibs.orig/mimetypes/application/x-pkcs12.desktop	Tue Aug 24 08:29:49 2004
+++ kdelibs/mimetypes/application/x-pkcs12.desktop	Sat Oct 30 08:38:21 2004
@@ -31,6 +31,7 @@
 Comment[ja]=PKCS#12 証明書バンドル
 Comment[lt]=PKCS#12 sertifikatų rinkinys
 Comment[lv]=PKCS#12 Sertifikātu Komplekts
+Comment[mk]=PKCS#12 Збирка од сертификати
 Comment[mn]= PKCS#12 Сертификат пакет
 Comment[ms]=Set Sijil PKCS#12
 Comment[mt]=Mazz ċertifikati PKCS#12
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-pw.desktop kdelibs/mimetypes/application/x-pw.desktop
--- kdelibs.orig/mimetypes/application/x-pw.desktop	Tue Aug 24 08:29:49 2004
+++ kdelibs/mimetypes/application/x-pw.desktop	Sat Oct 30 08:38:21 2004
@@ -2,6 +2,8 @@
 Encoding=UTF-8
 MimeType=application/x-pw
 Comment=Pathetic Writer Document
+Comment[af]='Pathetic Writer' Dokument
+Comment[ar]=مستند Pathetic Writer
 Comment[az]=Pathetic Writer Sənədi
 Comment[be]=Дакумэнт Pathetic Writer
 Comment[bg]=Документ на Pathetic Writer
@@ -20,6 +22,7 @@
 Comment[fa]=سند Pathetic ٌWriter
 Comment[fi]=Pathetic Writer -asiakirja
 Comment[fr]=Document Pathetic Writer
+Comment[ga]=Cáipéis Pathetic Writer
 Comment[gl]=Documento de Pathetic Writer
 Comment[he]=מסמך Pathetic Writer
 Comment[hi]=पैथेटिक राइटर दस्तावेज़
@@ -30,9 +33,10 @@
 Comment[ja]=Pathetic Writer ドキュメント
 Comment[ko]=패스틱 라이터 문서
 Comment[lt]=Pathetic Writer dokumentas
+Comment[mk]=Pathetic Writer документ
 Comment[mn]=Pathetic Баримт Бичигч
 Comment[nb]=Pathetic Writer dokument
-Comment[nds]=Pathetic Writer-Dokment
+Comment[nds]=Pathetic-Writer-Dokment
 Comment[nl]=Pathetic Writer-document
 Comment[nn]=Pathetic Writer-dokument
 Comment[pa]=Pathetic Writer ਦਸਤਾਵੇਜ਼
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-python-bytecode.desktop kdelibs/mimetypes/application/x-python-bytecode.desktop
--- kdelibs.orig/mimetypes/application/x-python-bytecode.desktop	Tue Aug 24 08:29:49 2004
+++ kdelibs/mimetypes/application/x-python-bytecode.desktop	Sat Oct 30 08:38:21 2004
@@ -35,10 +35,12 @@
 Comment[ja]=Python バイトコード
 Comment[ko]=파이썬 바이트 코드
 Comment[lt]=Phyton baitinis kodas
+Comment[mk]=Python бајткод
 Comment[mn]=Python-байткод
 Comment[ms]=Kod Bait Python
 Comment[mt]=Bytecode Python
 Comment[nb]=Python-bytecode
+Comment[nds]=Python-Bytecode
 Comment[nl]=Python-bytecode
 Comment[nn]=Python-byte-kode
 Comment[nso]=Khoutu ya Kgemo ya Python
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-python.desktop kdelibs/mimetypes/application/x-python.desktop
--- kdelibs.orig/mimetypes/application/x-python.desktop	Tue Aug 24 08:29:49 2004
+++ kdelibs/mimetypes/application/x-python.desktop	Tue Nov  9 08:35:29 2004
@@ -32,11 +32,12 @@
 Comment[ja]=Python プログラム
 Comment[ko]=파이썬 프로그램
 Comment[lt]=Python programa
+Comment[mk]=Python програма
 Comment[mn]=Python-Программ
 Comment[ms]=Program Python
 Comment[mt]=Programm Python
 Comment[nb]=Python-program
-Comment[nds]=Python Programm
+Comment[nds]=Python-Programm
 Comment[nl]=Python-programma
 Comment[nn]=Python-program
 Comment[nso]=Lenaneo la Python
@@ -55,7 +56,7 @@
 Comment[ss]=Luhlelo lwe Python 
 Comment[sv]=Python-program
 Comment[ta]=பைதான் நிரல்
-Comment[tg]=Нақшаи Python
+Comment[tg]=Барномаи Python
 Comment[th]=โปรแกรมไพธอน
 Comment[tr]=Python Programı
 Comment[uk]=Програма Python
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-quattropro.desktop kdelibs/mimetypes/application/x-quattropro.desktop
--- kdelibs.orig/mimetypes/application/x-quattropro.desktop	Tue Aug 24 08:29:49 2004
+++ kdelibs/mimetypes/application/x-quattropro.desktop	Sat Oct 30 08:38:21 2004
@@ -37,11 +37,12 @@
 Comment[ja]=Quattro Pro ドキュメント
 Comment[ko]=쿼트로 프로 문서
 Comment[lt]=Quattro Pro dokumentas
+Comment[mk]=Quattro Pro документ
 Comment[mn]=Quattro Pro-Файл
 Comment[ms]=Dokumen Quattro Pro
 Comment[mt]=Spreadsheet Quattro Pro
 Comment[nb]=Quattro Pro-dokument
-Comment[nds]=Quattro Pro-Dokment
+Comment[nds]=Quattro-Pro-Dokment
 Comment[nl]=Quattro Pro-document
 Comment[nn]=Quattro Pro-dokument
 Comment[nso]=Tokomane ya Pro ya Quattro
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-rar.desktop kdelibs/mimetypes/application/x-rar.desktop
--- kdelibs.orig/mimetypes/application/x-rar.desktop	Tue Aug 24 08:29:49 2004
+++ kdelibs/mimetypes/application/x-rar.desktop	Sat Oct 30 08:38:21 2004
@@ -37,6 +37,7 @@
 Comment[ja]=Rar アーカイブ
 Comment[ko]=RAR 저장고
 Comment[lt]=Rar archyvas
+Comment[mk]=Rar архива
 Comment[mn]=Rar-Архив
 Comment[ms]=Arkib Rar
 Comment[mt]=Arkivju RAR
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-rpm.desktop kdelibs/mimetypes/application/x-rpm.desktop
--- kdelibs.orig/mimetypes/application/x-rpm.desktop	Tue Aug 24 08:29:49 2004
+++ kdelibs/mimetypes/application/x-rpm.desktop	Sat Oct 30 08:38:21 2004
@@ -36,6 +36,7 @@
 Comment[ja]=RPM パッケージファイル
 Comment[ko]=RPM 꾸러미 파일
 Comment[lt]=RPM paketo byla
+Comment[mk]=RPM пакет датотека
 Comment[mn]=RPM-Пакет
 Comment[ms]=Fail Pakej RPM
 Comment[mt]=Pakkett RPM
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-ruby.desktop kdelibs/mimetypes/application/x-ruby.desktop
--- kdelibs.orig/mimetypes/application/x-ruby.desktop	Tue Aug 24 08:29:49 2004
+++ kdelibs/mimetypes/application/x-ruby.desktop	Tue Nov  9 08:35:29 2004
@@ -20,6 +20,7 @@
 Comment[fa]=برنامه‌ی Ruby
 Comment[fi]=Ruby-ohjelma
 Comment[fr]=Programme Ruby
+Comment[ga]=Clár Ruby
 Comment[gl]=Programa en Ruby
 Comment[he]=תוכנית Ruby
 Comment[hi]=रूबी प्रोग्राम
@@ -30,6 +31,7 @@
 Comment[ja]=Ruby プログラム
 Comment[ko]=루비 프로그램
 Comment[lt]=Ruby programa
+Comment[mk]=Ruby програма
 Comment[mn]=Ruby Програм
 Comment[ms]=Program Ruby
 Comment[nb]=Ruby-program
@@ -50,7 +52,7 @@
 Comment[sr@Latn]=Ruby program
 Comment[sv]=Ruby-program
 Comment[ta]=Ruby நிரல்
-Comment[tg]=Нақшаи Ruby
+Comment[tg]=Барномаи Ruby
 Comment[th]=โปรแกรม Ruby
 Comment[tr]=Ruby Programı
 Comment[uk]=Програма на мові програмування Ruby
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-sharedlib.desktop kdelibs/mimetypes/application/x-sharedlib.desktop
--- kdelibs.orig/mimetypes/application/x-sharedlib.desktop	Tue Aug 24 08:29:49 2004
+++ kdelibs/mimetypes/application/x-sharedlib.desktop	Sat Oct 30 08:38:21 2004
@@ -32,10 +32,12 @@
 Comment[ja]=共有ライブラリ
 Comment[ko]=공유 라이브러리
 Comment[lt]=Bendro naudojimo biblioteka
+Comment[mk]=Делена библиотека
 Comment[mn]=Нийтийн сан
 Comment[ms]=Perkongsian Pustaka
 Comment[mt]=Librerija "shared"
 Comment[nb]=Delt bibliotek
+Comment[nds]=Deelte Bibliotheek
 Comment[nl]=Gedeelde bibliotheek
 Comment[nn]=Delt bibliotek
 Comment[nso]=Bokgobapuku bjo bo Abaganwego
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-shellscript.desktop kdelibs/mimetypes/application/x-shellscript.desktop
--- kdelibs.orig/mimetypes/application/x-shellscript.desktop	Tue Aug 31 09:21:45 2004
+++ kdelibs/mimetypes/application/x-shellscript.desktop	Sat Oct 30 08:38:21 2004
@@ -33,6 +33,7 @@
 Comment[ja]=シェルスクリプト
 Comment[ko]=쉘 스크립트
 Comment[lt]=apvalkalo skriptas
+Comment[mk]=Shell скрипта
 Comment[mn]=Shell-Скрипт
 Comment[ms]=Skrip Cengkerang
 Comment[mt]=Skritt shell
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-shockwave-flash.desktop kdelibs/mimetypes/application/x-shockwave-flash.desktop
--- kdelibs.orig/mimetypes/application/x-shockwave-flash.desktop	Tue Aug 24 08:29:49 2004
+++ kdelibs/mimetypes/application/x-shockwave-flash.desktop	Sat Oct 30 08:38:21 2004
@@ -26,10 +26,10 @@
 Comment[ja]=Shockwave Flash メディア
 Comment[ko]=쇽 웨이브 플래시 미디어
 Comment[lv]=Shockwave Flash Mēdija
-Comment[mk]=Shockwave Flash медиум
 Comment[ms]=Media Shockwave Flash
 Comment[mt]=Media Shockwave Flash
 Comment[nb]=Shockware flashmedia
+Comment[nds]=Shockwave-Flash-Datei
 Comment[nn]=Shockwave Flash-media
 Comment[nso]=Media wa Kgadimo ya Shockwave
 Comment[pa]=Shockwave ਫਲੈਸ਼ ਮੀਡਿਆ
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-siag.desktop kdelibs/mimetypes/application/x-siag.desktop
--- kdelibs.orig/mimetypes/application/x-siag.desktop	Tue Aug 24 08:29:49 2004
+++ kdelibs/mimetypes/application/x-siag.desktop	Sat Oct 30 08:38:21 2004
@@ -8,6 +8,7 @@
 Comment[be]=Электронная табліца Siag
 Comment[bg]=Документ на Siag Spreadsheet
 Comment[bn]=সিয়াগ স্প্রেডশীট
+Comment[br]=Loger Siag
 Comment[ca]=Fulla de càlcul de Siag
 Comment[cs]=Tabulkový procesor aplikace Siag
 Comment[cy]=Taenlen Siag
@@ -34,6 +35,7 @@
 Comment[ko]=Siag 스프레드시트
 Comment[lt]=Siag elektroninė lentelė
 Comment[lv]=Siag Elektroniska Tabula
+Comment[mk]=Siag табела
 Comment[mn]=Siag-Хүснэгтэн боловсруулагч
 Comment[ms]=Hamparan helaian Siag
 Comment[mt]=Spreadsheet Siag
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-tar.desktop kdelibs/mimetypes/application/x-tar.desktop
--- kdelibs.orig/mimetypes/application/x-tar.desktop	Tue Aug 24 08:29:49 2004
+++ kdelibs/mimetypes/application/x-tar.desktop	Sat Oct 30 08:38:21 2004
@@ -37,6 +37,7 @@
 Comment[ja]=Tar アーカイブ
 Comment[ko]=TAR 저장고
 Comment[lt]=Tar archyvas
+Comment[mk]=Tar архива
 Comment[mn]=Tar-Архив
 Comment[ms]=Arkib Tar
 Comment[mt]=Arkivju Tar
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-tarz.desktop kdelibs/mimetypes/application/x-tarz.desktop
--- kdelibs.orig/mimetypes/application/x-tarz.desktop	Tue Aug 24 08:29:49 2004
+++ kdelibs/mimetypes/application/x-tarz.desktop	Sat Oct 30 08:38:21 2004
@@ -35,12 +35,12 @@
 Comment[ko]=압축한 TAR 저장고
 Comment[lt]=Suglaudintas tar archyvas
 Comment[lv]=Saspiests Tar Arhīvs
-Comment[mk]=Компримирана Tar-архива
+Comment[mk]=Компресирана Tar архива
 Comment[mn]=Шахагдсан Tar-Архив
 Comment[ms]=Arkib Tar Dipadatkan
 Comment[mt]=Arkivju Tar Kompressat
 Comment[nb]=Komprimert tar-arkiv
-Comment[nds]=komprimeert Tar-Archiv
+Comment[nds]=Komprimeert Tar-Archiv
 Comment[nl]=Gecomprimeerd Tar-archief
 Comment[nn]=Komprimert tar-arkiv
 Comment[nso]=Polokelo yeo e Pitleleditswego ya Tar
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-tbz.desktop kdelibs/mimetypes/application/x-tbz.desktop
--- kdelibs.orig/mimetypes/application/x-tbz.desktop	Tue Aug 24 08:29:49 2004
+++ kdelibs/mimetypes/application/x-tbz.desktop	Sat Oct 30 08:38:21 2004
@@ -32,11 +32,12 @@
 Comment[ja]=Bzip された Tar アーカイブ
 Comment[ko]=Bzip으로 압축한 TAR 저장고
 Comment[lt]=Tar archyvai, suglaudinti su bzip
+Comment[mk]=Bzip-увана Tar архива
 Comment[mn]=Bzip-р шахагдсан Tar-Архив
 Comment[ms]=Arkib Tar diBzipkan
 Comment[mt]=Arkivju Tar Bzippjat
 Comment[nb]=Bzippet tar-arkiv
-Comment[nds]=Tar-Archiv (mit bzip komprimeert)
+Comment[nds]=Tar-Archiv (mit BZip komprimeert)
 Comment[nl]=Met Bzip gecomprimeerd Tar-archief
 Comment[nn]=Bzippa tar-arkiv
 Comment[nso]=Polokelo ya Tar ya Bzipped
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-tex-gf.desktop kdelibs/mimetypes/application/x-tex-gf.desktop
--- kdelibs.orig/mimetypes/application/x-tex-gf.desktop	Tue Aug 31 09:21:45 2004
+++ kdelibs/mimetypes/application/x-tex-gf.desktop	Tue Nov  9 08:35:29 2004
@@ -32,6 +32,7 @@
 Comment[ja]=一般フォント
 Comment[ko]=보통 글꼴
 Comment[lt]=Bendras šriftas
+Comment[mk]=Општ фонт
 Comment[mn]=Ерөнхий бичгийн файлууд
 Comment[ms]=Font Generik
 Comment[mt]=Font ġeneriku
@@ -54,7 +55,7 @@
 Comment[sr@Latn]=Generički font
 Comment[sv]=Generell teckensnittsfil
 Comment[ta]=பொது எழுத்துரு
-Comment[tg]=Ҳарфи Умумӣ
+Comment[tg]=Ҳуруфи Умумӣ
 Comment[th]=แบบตัวอักษรทั่วไป
 Comment[tr]=Genel Yazıtipi Dosyası
 Comment[uk]=Загальний шрифт
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-tex-pk.desktop kdelibs/mimetypes/application/x-tex-pk.desktop
--- kdelibs.orig/mimetypes/application/x-tex-pk.desktop	Tue Aug 31 09:21:45 2004
+++ kdelibs/mimetypes/application/x-tex-pk.desktop	Tue Nov  9 08:35:29 2004
@@ -31,6 +31,7 @@
 Comment[ja]=パックされたフォント
 Comment[ko]=묶어놓은 글꼴
 Comment[lt]=Supakuotas šriftas
+Comment[mk]=Спакуван фонт
 Comment[mn]=Шахагдсан бичгийн файл
 Comment[ms]=Font Dipaketkan
 Comment[mt]=Font ippakkjat
@@ -53,7 +54,7 @@
 Comment[sr@Latn]=Zapakovani font
 Comment[sv]=Komprimerad teckensnittsfil
 Comment[ta]=பொதிந்த எழுத்துரு
-Comment[tg]=Ҳарфи Бастани
+Comment[tg]=Бастани ҳуруф
 Comment[th]=แบบตัวอักษรบีบข้อมูล
 Comment[tr]=Paketlenmiş Yazıtipi
 Comment[uk]=Упакований шрифт
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-tgif.desktop kdelibs/mimetypes/application/x-tgif.desktop
--- kdelibs.orig/mimetypes/application/x-tgif.desktop	Tue Aug 24 08:29:49 2004
+++ kdelibs/mimetypes/application/x-tgif.desktop	Sat Oct 30 08:38:21 2004
@@ -34,6 +34,7 @@
 Comment[ko]=TGIF 문서
 Comment[lt]=TGIF dokumentas
 Comment[lv]=TGIF Dokuments
+Comment[mk]=TGIF документ
 Comment[mn]=TGIF-Баримт
 Comment[ms]=Dokumen TGIF
 Comment[mt]=Dokument TGIF
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-tgz.desktop kdelibs/mimetypes/application/x-tgz.desktop
--- kdelibs.orig/mimetypes/application/x-tgz.desktop	Tue Aug 24 08:29:49 2004
+++ kdelibs/mimetypes/application/x-tgz.desktop	Sat Oct 30 08:38:21 2004
@@ -39,12 +39,12 @@
 Comment[lt]=Tar archyvas, suglaudintas su gzip
 Comment[lv]=Gzipots Tar Arhīvs
 Comment[mi]=Takotoranga Tar Gzip
-Comment[mk]=Gzip-Tar архива
+Comment[mk]=Gzip-увана Tar архива
 Comment[mn]=Gzip-р шахагдсан Tar-Архив
 Comment[ms]=Arkib Tar diGzipkan
 Comment[mt]=Arkivju Tar Gzippjat
 Comment[nb]=Gzippet tar-arkiv
-Comment[nds]=Tar-Archiv (mit gzip komprimeert)
+Comment[nds]=Tar-Archiv (mit GZip komprimeert)
 Comment[nl]=Met Gzip gecomprimeerd Tar-archief
 Comment[nn]=Gzippa tar-arkiv
 Comment[nso]=Polokelo ya Tar ya Gzipped
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-trash.desktop kdelibs/mimetypes/application/x-trash.desktop
--- kdelibs.orig/mimetypes/application/x-trash.desktop	Tue Aug 24 08:29:49 2004
+++ kdelibs/mimetypes/application/x-trash.desktop	Sat Oct 30 08:38:21 2004
@@ -36,10 +36,12 @@
 Comment[ja]=バックアップファイル
 Comment[ko]=여벌 파일 (백업)
 Comment[lt]=Atsarginė bylos kopija
+Comment[mk]=Датотека со заштитна копија
 Comment[mn]=Нөөгц файл
 Comment[ms]=Fail Salinan Kecemasan
 Comment[mt]=Fajl backup
 Comment[nb]=Sikkerhetskopi
+Comment[nds]=Sekerheitskopie
 Comment[nl]=Reservekopie
 Comment[nn]=Reservekopi
 Comment[nso]=Faele ya Thekgo
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-troff-man.desktop kdelibs/mimetypes/application/x-troff-man.desktop
--- kdelibs.orig/mimetypes/application/x-troff-man.desktop	Tue Aug 24 08:29:49 2004
+++ kdelibs/mimetypes/application/x-troff-man.desktop	Sat Oct 30 08:38:21 2004
@@ -31,10 +31,12 @@
 Comment[ja]=Manpage マクロの Troff ドキュメント
 Comment[ko]=맨페이지 매크로가 담겨 있는 Troff 문서
 Comment[lt]=Troff dokumentas su man puslapių makrosais
+Comment[mk]=Troff документ со Manpage макроа
 Comment[mn]=Manpage Makros-той Troff-Баримт
 Comment[ms]=Dokumen Troff dengan makro Manpage
 Comment[mt]=Dokument Troff bil-makri tal-manpage
 Comment[nb]=Troff-dokument med manualsidemakroer
+Comment[nds]=Troff-Dokment mit Manpage-Makros
 Comment[nl]=Troff-document met manpage-macro's
 Comment[nn]=Troff-dokument med manpage-makroar
 Comment[nso]=Tokomane ya Troff yeo enago le Macros wa Manpage
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-troff.desktop kdelibs/mimetypes/application/x-troff.desktop
--- kdelibs.orig/mimetypes/application/x-troff.desktop	Tue Aug 24 08:29:49 2004
+++ kdelibs/mimetypes/application/x-troff.desktop	Sat Oct 30 08:38:21 2004
@@ -33,6 +33,7 @@
 Comment[ja]=Troff ドキュメント
 Comment[ko]=Troff 문서
 Comment[lt]=Troff dokumentas
+Comment[mk]=Troff документ
 Comment[mn]=Troff-Баримт
 Comment[ms]=Dokumen Troff
 Comment[mt]=Dokument Troff
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-tzo.desktop kdelibs/mimetypes/application/x-tzo.desktop
--- kdelibs.orig/mimetypes/application/x-tzo.desktop	Tue Aug 24 08:29:49 2004
+++ kdelibs/mimetypes/application/x-tzo.desktop	Sat Oct 30 08:38:21 2004
@@ -36,7 +36,7 @@
 Comment[lt]=Tar archyvas, suglaudintas su Lzo 
 Comment[lv]=Lzopped Tar Arhīvs
 Comment[mi]=Takotoranga Tar Lzop
-Comment[mk]=Lzop-Tar архива
+Comment[mk]=Lzop-увана Tar архива
 Comment[mn]=Lzop-р шахагдсан Tar-Архив
 Comment[ms]=Arkib Tar diLzopkan
 Comment[mt]=Arkivju Tar Lzop
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-vnd.kde.kexi.desktop kdelibs/mimetypes/application/x-vnd.kde.kexi.desktop
--- kdelibs.orig/mimetypes/application/x-vnd.kde.kexi.desktop	Tue Aug 24 08:29:49 2004
+++ kdelibs/mimetypes/application/x-vnd.kde.kexi.desktop	Sat Oct 30 08:38:21 2004
@@ -6,6 +6,8 @@
 Patterns=*.kexi;
 X-KDE-AutoEmbed=false
 Comment=Kexi Project File
+Comment[af]=Kexi Projek Lêer
+Comment[ar]=ملف مشروع Kexi
 Comment[az]=Kexi Layihə Faylı
 Comment[be]=Файл праекту Kexi
 Comment[bg]=Проект на Kexi
@@ -34,6 +36,7 @@
 Comment[it]=File di progetto Kexi
 Comment[ja]=Kexi プロジェクト ファイル
 Comment[lt]=Kexi Project byla
+Comment[mk]=Kexi проектна датотека
 Comment[mn]=Kexi Төсөл Файл
 Comment[ms]=Fail Projek Kexi
 Comment[nb]=Kexi-prosjektfil
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-vnd.kde.kplato.desktop kdelibs/mimetypes/application/x-vnd.kde.kplato.desktop
--- kdelibs.orig/mimetypes/application/x-vnd.kde.kplato.desktop	Sun Sep 12 15:56:15 2004
+++ kdelibs/mimetypes/application/x-vnd.kde.kplato.desktop	Fri Nov 12 08:27:54 2004
@@ -3,10 +3,12 @@
 Encoding=UTF-8
 MimeType=application/x-vnd.kde.kplato
 Comment=KPlato Project Management Document
+Comment[af]=KPlato Projek Bestuur Dokument
 Comment[bg]=Документ на KPlato Project Management
 Comment[bn]=কে-প্লেটো প্রোজেক্ট ম্যানেজমেন্ট নথী
 Comment[bs]=KPlato Menadžment projektima dokument
 Comment[ca]=Document de gestió de projectes KPlato
+Comment[cs]=Dokument programu KPlato
 Comment[da]=KPlato projekthåndteringsdokument
 Comment[de]=KPlato-Dokument zur Projektverwaltung
 Comment[el]=Έγγραφο διαχείρισης έργου του KPlato
@@ -20,7 +22,10 @@
 Comment[is]=KPlato verkefnisskjal
 Comment[it]=Documento di gestione progetti KPlato
 Comment[ja]=KPlato プロジェクトマネージメントドキュメント
+Comment[lt]=KPlato projektų valdymo dokumentas
+Comment[mk]=KPlato документ за менаџмент на проект
 Comment[nb]=KPlato-prosjektstyringsdokument
+Comment[nds]=KPlato-Projektpleeg-Dokment
 Comment[nl]=KPlato Projectbeheer-document
 Comment[nn]=KPlato-prosjektstyringsdokument
 Comment[pa]=KPlato ਪ੍ਰੋਜੈਕਟ ਪ੍ਰਬੰਧਨ ਦਸਤਾਵੇਜ਼
@@ -28,10 +33,11 @@
 Comment[pt]=Documento de Gestão de Projectos KPlato
 Comment[pt_BR]= Documento do Gerenciador de Projetos KPlato
 Comment[ro]=Document management de proiect KPlato
+Comment[ru]=Документ управления проектом KPlato
 Comment[se]=KPlato-prošeaktajođiheapmedokumeanta
 Comment[sk]=KPlato dokument pre správu projektov
 Comment[sr]=KPlato-ов документ пројекта управљања
-Comment[sr@Latn]=KPlato-ов документ пројекта управљања
+Comment[sr@Latn]=KPlato-ov dokument projekta upravljanja
 Comment[sv]=Kplato projekthanteringsdokument
 Comment[ta]=கேப்ளாட்டோ திட்ட மேலாண்மை ஆவணம்
 Comment[tg]=Сохти идоракунии санади KPlato
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-vnd.kde.kugar.mixed.desktop kdelibs/mimetypes/application/x-vnd.kde.kugar.mixed.desktop
--- kdelibs.orig/mimetypes/application/x-vnd.kde.kugar.mixed.desktop	Tue Aug 24 08:29:49 2004
+++ kdelibs/mimetypes/application/x-vnd.kde.kugar.mixed.desktop	Sat Oct 30 08:38:21 2004
@@ -5,6 +5,8 @@
 Icon=kugar_kud
 Patterns=*.kug
 Comment=Kugar Archive File
+Comment[af]=Kugar Argief Lêer
+Comment[ar]=ملف أرشيف كوغار
 Comment[az]=Kugar Arxiv Faylı
 Comment[be]=Архіўны файл Kugar
 Comment[bg]=Архивен файл на Kugar
@@ -34,10 +36,11 @@
 Comment[it]=File di archivio Kugar
 Comment[ja]=Kugar アーカイブ ファイル
 Comment[lt]=Kugar archyvo byla
+Comment[mk]=Kugar архивирана датотека
 Comment[mn]=Kugar Архив файл
 Comment[ms]=Fail Arkib Kugar
 Comment[nb]=Kugar arkivfil
-Comment[nds]=Kugar Archivdatei
+Comment[nds]=Kugar-Archivdatei
 Comment[nl]=Kugar-archiefbestand
 Comment[nn]=Kugar-arkivfil
 Comment[pa]=Kugar ਸੁਕੰਚਿਤ ਫਾਇਲ
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-x509-ca-cert.desktop kdelibs/mimetypes/application/x-x509-ca-cert.desktop
--- kdelibs.orig/mimetypes/application/x-x509-ca-cert.desktop	Tue Aug 24 08:29:49 2004
+++ kdelibs/mimetypes/application/x-x509-ca-cert.desktop	Sat Oct 30 08:38:21 2004
@@ -33,11 +33,12 @@
 Comment[it]=Certificato X.509 codificato DER, PEM o Netscape
 Comment[ja]=DER, PEM, Netscape エンコードされた X.509 証明書
 Comment[lt]=DER, PEM, ar Netscape koduotas X.509 sertifikatas
+Comment[mk]=DER, PEM, или Netscape Encoded X.509 сертификат
 Comment[mn]=DER, PEM эсвэл netscape-kodлогдсон X.509-Гэрчилгээ
 Comment[ms]=Sijil DER, PEM, atau Netscape Encoded X.509
 Comment[mt]=Ċertifikat X.509 kodifikat b'DER, PEM, jew Netscape
 Comment[nb]=DER, PEM, eller Netscape Encoded X.509 sertifikat
-Comment[nds]=DER, PEM, oderr Netscape Encoded X.509-Zertifikaat
+Comment[nds]=DER, PEM, oder Netscape kodeert X.509-Zertifikaat
 Comment[nl]=DER-, PEM-, of Netscape-versleuteld X.509-certificaat
 Comment[nn]=DER, PEM eller Netscape-koda X.509-sertifikat
 Comment[nso]=Kgonthisiso ya DER, PEM, goba X.509 yeo e Khoutilwego ka Netscape
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-zerosize.desktop kdelibs/mimetypes/application/x-zerosize.desktop
--- kdelibs.orig/mimetypes/application/x-zerosize.desktop	Tue Aug 24 08:29:49 2004
+++ kdelibs/mimetypes/application/x-zerosize.desktop	Mon Nov 22 09:34:04 2004
@@ -7,6 +7,7 @@
 Comment[be]=Пусты дакумэнт
 Comment[bg]=Празен документ
 Comment[bn]=ফাঁকা নথী
+Comment[br]=Teul goullo
 Comment[bs]=Prazan dokument
 Comment[ca]=Document buit
 Comment[cs]=Prázdný dokument
@@ -33,6 +34,7 @@
 Comment[ko]=빈 문서
 Comment[lt]=Tuščias dokumentas
 Comment[lv]=Tukšs Dokuments
+Comment[mk]=Празен документ
 Comment[mn]=Хоосон баримт
 Comment[ms]=Dokumen Kosong
 Comment[mt]=Dokument vojt
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-zip.desktop kdelibs/mimetypes/application/x-zip.desktop
--- kdelibs.orig/mimetypes/application/x-zip.desktop	Tue Aug 24 08:29:49 2004
+++ kdelibs/mimetypes/application/x-zip.desktop	Sat Oct 30 08:38:21 2004
@@ -37,6 +37,7 @@
 Comment[ja]=Zip アーカイブ
 Comment[ko]=Zip 저장고
 Comment[lt]=Zip archyvas
+Comment[mk]=Zip архива
 Comment[mn]=Zip-Архив
 Comment[ms]=Arkib Zip
 Comment[mt]=Arkivju Zip
diff -urN -x CVS kdelibs.orig/mimetypes/application/x-zoo.desktop kdelibs/mimetypes/application/x-zoo.desktop
--- kdelibs.orig/mimetypes/application/x-zoo.desktop	Tue Aug 24 08:29:49 2004
+++ kdelibs/mimetypes/application/x-zoo.desktop	Sat Oct 30 08:38:21 2004
@@ -37,6 +37,7 @@
 Comment[ja]=Zoo アーカイブ
 Comment[ko]=Zoo 저장고
 Comment[lt]=Zoo archyvas
+Comment[mk]=Zoo архива
 Comment[mn]=Zoo-Архив
 Comment[ms]=Arkib Zoo
 Comment[mt]=Arkivju Zoo
diff -urN -x CVS kdelibs.orig/mimetypes/application/xhtml+xml.desktop kdelibs/mimetypes/application/xhtml+xml.desktop
--- kdelibs.orig/mimetypes/application/xhtml+xml.desktop	Mon Sep  6 15:47:49 2004
+++ kdelibs/mimetypes/application/xhtml+xml.desktop	Sat Oct 30 08:38:21 2004
@@ -1,6 +1,8 @@
 [Desktop Entry]
 Encoding=UTF-8
 Comment=XHTML Family Document
+Comment[af]=XHTML Familie Dokument
+Comment[ar]=مستند XHTML
 Comment[az]=XHTML Ailəsi Sənədi
 Comment[be]=Дакумэнт XHTML
 Comment[bg]=Документ XHTML
@@ -30,6 +32,7 @@
 Comment[ja]=XHTML ファミリドキュメント
 Comment[ko]=XHTML군 문서
 Comment[lt]=XHTML šeimos dokumentas
+Comment[mk]=Документ од фамилијата XHTML
 Comment[mn]=XHTML-Бүлийн Баримт
 Comment[ms]=Dokumen Keluarga XHTML
 Comment[nb]=Dokument av XHTML-familien
diff -urN -x CVS kdelibs.orig/mimetypes/application/xml.desktop kdelibs/mimetypes/application/xml.desktop
--- kdelibs.orig/mimetypes/application/xml.desktop	Thu Jan  1 01:00:00 1970
+++ kdelibs/mimetypes/application/xml.desktop	Thu Nov 11 08:50:26 2004
@@ -0,0 +1,73 @@
+[Desktop Entry]
+Encoding=UTF-8
+Comment=XML Document
+Comment[af]=XML Dokument
+Comment[ar]=مستند XML
+Comment[az]=XML Sənədi
+Comment[be]=Дакумэнт XML
+Comment[bg]=Документ XML
+Comment[bn]=এক্স-এম-এল নথী
+Comment[br]=Teul XML
+Comment[bs]=XML dokument
+Comment[ca]=Document XML
+Comment[cs]=XML dokument
+Comment[cy]=Dogfen XML
+Comment[da]=XML-dokument
+Comment[de]=XML-Dokument
+Comment[el]=Έγγραφο XML
+Comment[eo]=XML-dokumento
+Comment[es]=Documento XML
+Comment[et]=XML dokument
+Comment[eu]=XML dokumentua
+Comment[fa]=سند XML
+Comment[fi]=XML-asiakirja
+Comment[fr]=Document XML
+Comment[ga]=Cáipéis XML
+Comment[gl]=Documento XML
+Comment[he]=מסמך XML
+Comment[hi]=एक्सएमएल दस्तावेज़ 
+Comment[hr]=XML dokument
+Comment[hu]=XML-dokumentum
+Comment[is]=XML skjal
+Comment[it]=Documento XML
+Comment[ja]=XML ドキュメント
+Comment[ko]=XML 문서
+Comment[lt]=XML dokumentas
+Comment[mk]=XML документ
+Comment[mn]=XML Баримт
+Comment[ms]=Dokumen XML
+Comment[nb]=XML-dokument
+Comment[nds]=XML-Dokment
+Comment[nl]=XML-document
+Comment[nn]=XML-dokument
+Comment[pa]=XML ਦਸਤਾਵੇਜ਼
+Comment[pl]=Dokument XML
+Comment[pt]=Documento XML
+Comment[pt_BR]=Documento XML
+Comment[ro]=Document XML
+Comment[ru]=Документ XML
+Comment[se]=XML-dokumeanta
+Comment[sk]=XML dokument
+Comment[sl]=Dokument XML
+Comment[sq]=Dokument XML
+Comment[sr]=XML документ
+Comment[sr@Latn]=XML dokument
+Comment[sv]=XML-dokument
+Comment[ta]=XML ஆவணம்
+Comment[tg]=Хуҷҷати XML 
+Comment[th]=เอกสาร XML
+Comment[tr]=XML Belgesi
+Comment[uk]=Документ XML
+Comment[uz]=XML ҳужжати
+Comment[wa]=Documint XML
+Comment[zh_CN]=XML 文档
+Comment[zh_TW]=XML 文件
+Icon=html
+Type=MimeType
+MimeType=application/xml
+# This mimetype is an alias for text/xml. Both are referenced by the W3C.
+X-KDE-IsAlso=text/xml
+
+[Property::X-KDE-text]
+Type=bool
+Value=true
diff -urN -x CVS kdelibs.orig/mimetypes/audio/aac.desktop kdelibs/mimetypes/audio/aac.desktop
--- kdelibs.orig/mimetypes/audio/aac.desktop	Mon Sep  6 15:47:49 2004
+++ kdelibs/mimetypes/audio/aac.desktop	Tue Nov  9 08:35:30 2004
@@ -5,6 +5,8 @@
 Icon=sound
 Patterns=*.aac;*.AAC;
 Comment=AAC Sound
+Comment[af]=AAC Klank
+Comment[ar]=ملف AAC صوتي
 Comment[az]=AAC Səsi
 Comment[be]=AAC аўдыё
 Comment[bg]=Аудио файл AAC
@@ -24,6 +26,7 @@
 Comment[fa]=صوت AAC
 Comment[fi]=AAC-ääni
 Comment[fr]=Son AAC
+Comment[ga]=Fuaim AAC
 Comment[gl]=Son AAC
 Comment[he]=שמע AAC
 Comment[hi]=AAC ध्वनि
@@ -34,9 +37,10 @@
 Comment[ja]=ACC サウンド
 Comment[ko]=AAC 소리
 Comment[lt]=AAC garsas
+Comment[mk]=AAC звук
 Comment[mn]=AAC Дуу
 Comment[nb]=AAC lyd
-Comment[nds]=AAC Kläng
+Comment[nds]=AAC-Kläng
 Comment[nl]=AAC-audio
 Comment[nn]=AAC-lyd
 Comment[pa]=AAC ਧੁਨੀ
@@ -53,7 +57,7 @@
 Comment[sr@Latn]=AAC zvuk
 Comment[sv]=AAC-ljud
 Comment[ta]=AAC ஒலி
-Comment[tg]=Овози AAC
+Comment[tg]=Садои AAC
 Comment[tr]=ACC Ses Dosyası
 Comment[uk]=Аудіо AAC
 Comment[uz]=AAC аудио
diff -urN -x CVS kdelibs.orig/mimetypes/audio/ac3.desktop kdelibs/mimetypes/audio/ac3.desktop
--- kdelibs.orig/mimetypes/audio/ac3.desktop	Mon Sep  6 15:47:49 2004
+++ kdelibs/mimetypes/audio/ac3.desktop	Sat Oct 30 08:38:26 2004
@@ -5,6 +5,8 @@
 Icon=sound
 Patterns=*.ac3;*.AC3;
 Comment=Dolby AC3 Sound
+Comment[af]=Dolby AC3 Klank
+Comment[ar]=ملف صوتي Dolby AC3
 Comment[az]=Dolby AC3 Səsi
 Comment[be]=Dolby AC3 аўдыё
 Comment[bg]=Долби аудио AC3
@@ -23,6 +25,7 @@
 Comment[fa]=صوت Dolby AC3
 Comment[fi]=Dolby AC3 -ääni
 Comment[fr]=Son Dolby AC3
+Comment[ga]=Fuaim Dolby AC3
 Comment[gl]=Son Dolby AC3
 Comment[he]=שמע Dolby AC3
 Comment[hi]=डॉल्बी AC3 ध्वनि
@@ -33,9 +36,10 @@
 Comment[ja]=ドルビー AC3 サウンド
 Comment[ko]=돌비 AC3 소리
 Comment[lt]=Dolby AC3 garsas
+Comment[mk]=Dolby AC3 звук
 Comment[mn]=Dolby AC3 Дуу
 Comment[nb]=Dolby AC3 lyd
-Comment[nds]=Dolby AC3 Kläng
+Comment[nds]=Dolby-AC3-Kläng
 Comment[nl]=Dolby AC3-audio
 Comment[nn]=Dolby AC3-lyd
 Comment[pa]=Dolby AC3 ਸੰਗੀਤ
diff -urN -x CVS kdelibs.orig/mimetypes/audio/basic.desktop kdelibs/mimetypes/audio/basic.desktop
--- kdelibs.orig/mimetypes/audio/basic.desktop	Tue Aug 24 08:29:55 2004
+++ kdelibs/mimetypes/audio/basic.desktop	Mon Nov 22 09:34:05 2004
@@ -31,10 +31,12 @@
 Comment[it]=Audio ULAW (Sun)
 Comment[ja]=ULAW (Sun) オーディオ
 Comment[ko]=ULAW (선) 오디오
+Comment[mk]=ULAW (Sun) аудио
 Comment[mn]=ULAW (Sun) Аудио
 Comment[ms]=Audio ULAW (Sun)
 Comment[mt]=Awdjo ULAW (Sun)
 Comment[nb]=ULAW (Sun-lyd)
+Comment[nds]=ULAW (Sun)-Audiodatei
 Comment[nl]=ULAW (Sun) audiobestand
 Comment[nn]=ULAW-lyd (Sun)
 Comment[nso]=Kwagalo ya ya ULAW (Letsatsi)
@@ -52,6 +54,7 @@
 Comment[ss]=Umsindvo we ULAW (Sun)
 Comment[sv]=ULAW-ljud (Sun)
 Comment[ta]=ULAW (Sun) கேட்பொலி
+Comment[tg]=Савди ULAW (Sun) 
 Comment[tr]=ULAW (Sun) Ses Dosyası
 Comment[uk]=Аудіо ULAW (Sun)
 Comment[uz]=ULAW (Sun) аудио
diff -urN -x CVS kdelibs.orig/mimetypes/audio/mp4.desktop kdelibs/mimetypes/audio/mp4.desktop
--- kdelibs.orig/mimetypes/audio/mp4.desktop	Tue Aug 24 08:29:55 2004
+++ kdelibs/mimetypes/audio/mp4.desktop	Sat Oct 30 08:38:26 2004
@@ -5,6 +5,7 @@
 Icon=sound
 Patterns=*.m4a;*.M4A;
 Comment=MPEG-4 Audio
+Comment[af]=MPEG-4 Klank
 Comment[ar]=صوت MPEG-4
 Comment[be]=MPEG-4 аўдыё
 Comment[bg]=Аудио файл MPEG-4
@@ -23,6 +24,7 @@
 Comment[fa]=صوتی MPEG-4
 Comment[fi]=MPEG-4 -ääni
 Comment[fr]=Son MPEG-4
+Comment[ga]=Fuaim MPEG-4
 Comment[gl]=Son em MPEG-4
 Comment[he]=שמע MPEG4
 Comment[hi]=MPEG-4 ऑडियो
@@ -32,8 +34,10 @@
 Comment[it]=Audio MPEG-4
 Comment[ja]=MPEG-4 オーディオ
 Comment[ko]=MPEG-4 오디오
+Comment[mk]=MPEG-4 аудио
 Comment[mn]=MPEG-4 Аудио
 Comment[nb]=MPEG-4 lyd
+Comment[nds]=MPEG-4 Audiodatei
 Comment[nl]=MPEG-4 audio
 Comment[nn]=MPEG-4-lyd
 Comment[pa]=MPEG-4 ਆਡੀਓ
diff -urN -x CVS kdelibs.orig/mimetypes/audio/mpeg.desktop kdelibs/mimetypes/audio/mpeg.desktop
--- kdelibs.orig/mimetypes/audio/mpeg.desktop	Sun Sep 12 15:56:17 2004
+++ kdelibs/mimetypes/audio/mpeg.desktop	Mon Nov 22 09:34:05 2004
@@ -7,6 +7,7 @@
 MimeType=audio/mpeg
 Icon=sound
 Comment=MPEG Audio
+Comment[af]=MPEG Klank
 Comment[be]=MPEG аўдыё
 Comment[bg]=Аудио файл MPEG
 Comment[bn]=এমপেগ অডিও
@@ -28,7 +29,10 @@
 Comment[it]=Audio MPEG
 Comment[ja]=MPEG オーディオ
 Comment[ko]=MPEG 오디오
+Comment[lt]=MPEG-4 Audio
+Comment[mk]=MPEG аудио
 Comment[nb]=MPEG-lyd
+Comment[nds]=MPEG-Audiodatei
 Comment[nl]=MPEG audio
 Comment[nn]=MPEG-lyd
 Comment[pa]=MPEG ਆਡੀਓ
@@ -36,13 +40,15 @@
 Comment[pt]=Áudio MPEG
 Comment[pt_BR]=Áudio MPEG
 Comment[ro]=Fişier audio MPEG
+Comment[ru]=Звуковой файл MPEG
 Comment[se]=MPEG-jietna
 Comment[sk]=Zvuk MPEG
 Comment[sl]=Zvok MPEG
 Comment[sr]=MPEG аудио
-Comment[sr@Latn]=MPEG аудио
+Comment[sr@Latn]=MPEG audio
 Comment[sv]=MPEG-ljud
 Comment[ta]=MPEG கேட்பொலி
+Comment[tg]=Савди MPEG
 Comment[th]=แฟ้มเสียง MPEG
 Comment[uk]=Аудіо запис MPEG
 Comment[uz]=MPEG аудио
diff -urN -x CVS kdelibs.orig/mimetypes/audio/mpegurl.desktop kdelibs/mimetypes/audio/mpegurl.desktop
--- kdelibs.orig/mimetypes/audio/mpegurl.desktop	Tue Aug 24 08:29:55 2004
+++ kdelibs/mimetypes/audio/mpegurl.desktop	Mon Nov 15 08:54:58 2004
@@ -33,13 +33,15 @@
 Comment[hu]=MP3 (MPEG Layer 3) sugárzási hangfájl
 Comment[is]=MP3 hljóðstraumur
 Comment[it]=Audio MPEG layer 3 in stream
-Comment[ja]=ストリーミング MPEG layer 3 オーディオ
+Comment[ja]=ストリーミング MPEG Layer 3 オーディオ
 Comment[ko]=스트리밍 MPEG 레이어 3 오디오
 Comment[lt]=MPEG layer 3 audio srautas
+Comment[mk]=Поточно MPEG Layer 3 аудио
 Comment[mn]=MPEG-Үе-3-Аудио
 Comment[ms]=Audio Aliran MPEG Peringkat 3
 Comment[mt]=Awdjo Streaming MPEG 3
 Comment[nb]=MPEG lag 3-lydstrøm
+Comment[nds]=Streaming-MPEG-Audiodatei (Layer 3)
 Comment[nl]=Streaming MPEG Layer3-audio
 Comment[nn]=MPEG lag 3-lydstraum
 Comment[nso]=Latelanya Kwagalo ya Peo 3 ya MPEG
diff -urN -x CVS kdelibs.orig/mimetypes/audio/prs.sid.desktop kdelibs/mimetypes/audio/prs.sid.desktop
--- kdelibs.orig/mimetypes/audio/prs.sid.desktop	Mon Sep 20 15:53:29 2004
+++ kdelibs/mimetypes/audio/prs.sid.desktop	Fri Nov 12 08:27:54 2004
@@ -5,6 +5,7 @@
 Icon=sound
 Patterns=*.sid;*.SID;*.psid;*.PSID
 Comment=C64 SID Music
+Comment[af]=C64 SID Musiek
 Comment[be]=Музыка C64 SID
 Comment[bg]=Аудио файл C64 SID
 Comment[bn]=C64 SID মিউসিক
@@ -24,8 +25,10 @@
 Comment[is]=C64 SID hljóðskrá
 Comment[it]=Musica SID C64
 Comment[ja]=C64 SIDミュージック
+Comment[lt]=C64 SID muzika
+Comment[mk]=C64 SID музика
 Comment[nb]=C64 SID-musikk
-Comment[nds]=C64 SID Musik
+Comment[nds]=C64-SID-Musikdatei
 Comment[nl]=C64 SID-muziek
 Comment[nn]=C64 SID-musikk
 Comment[pa]=C64 SID ਸੰਗੀਤ
@@ -33,11 +36,12 @@
 Comment[pt]=Música SID do C64
 Comment[pt_BR]=Música C64 SID
 Comment[ro]=Muzică SID C64
+Comment[ru]=Звуковой файл C64 SID
 Comment[se]=C64 SID-musihkka
 Comment[sk]=Zvuk C64 SID
 Comment[sl]=Glasba C64 SID
 Comment[sr]=C64 SID музика
-Comment[sr@Latn]=C64 SID музика
+Comment[sr@Latn]=C64 SID muzika
 Comment[sv]=C64 SID-musik
 Comment[ta]=குறுந்தட்டு ஒலி
 Comment[tg]=Мусиқии C64 SID
diff -urN -x CVS kdelibs.orig/mimetypes/audio/vnd.rn-realaudio.desktop kdelibs/mimetypes/audio/vnd.rn-realaudio.desktop
--- kdelibs.orig/mimetypes/audio/vnd.rn-realaudio.desktop	Tue Aug 24 08:29:55 2004
+++ kdelibs/mimetypes/audio/vnd.rn-realaudio.desktop	Mon Nov 15 08:54:58 2004
@@ -6,6 +6,8 @@
 Patterns=*.ra;*.ram;*.RA;*.RAM;
 X-KDE-IsAlso=audio/x-pn-realaudio
 Comment=RealAudio File
+Comment[af]=RealAudio Lêer
+Comment[ar]=ملف Real Audio
 Comment[az]=RealAudio Faylı
 Comment[be]=Файл RealAudio
 Comment[bg]=Аудио файл RealAudio
@@ -25,6 +27,7 @@
 Comment[fa]=پرونده‌ی RealAudio
 Comment[fi]=RealAudio tiedosto
 Comment[fr]=Fichier ReadAudio
+Comment[ga]=Comhad RealAudio
 Comment[gl]=Ficheiro de RealAudio
 Comment[he]=קובץ RealAudio
 Comment[hi]=रीयलऑडियो फ़ाइल
@@ -32,12 +35,13 @@
 Comment[hu]=RealAudio-fájl
 Comment[is]=RealAudio skrá
 Comment[it]=File RealAudio
-Comment[ja]=リアルオーディオ ファイル
+Comment[ja]=RealAudio ファイル
 Comment[ko]=리얼오디오 파일
 Comment[lt]=RealAudio byla
+Comment[mk]=RealAudio датотека
 Comment[mn]=RealAudio файл
 Comment[nb]=RealAudio-fil
-Comment[nds]=RealAudio Datei
+Comment[nds]=RealAudio-Datei
 Comment[nl]=RealAudio-bestand
 Comment[nn]=RealAudio-fil
 Comment[pa]=RealAudio ਫਾਇਲ
diff -urN -x CVS kdelibs.orig/mimetypes/audio/vorbis.desktop kdelibs/mimetypes/audio/vorbis.desktop
--- kdelibs.orig/mimetypes/audio/vorbis.desktop	Tue Aug 24 08:29:55 2004
+++ kdelibs/mimetypes/audio/vorbis.desktop	Sat Oct 30 08:38:26 2004
@@ -5,6 +5,8 @@
 Icon=sound
 X-KDE-IsAlso=audio/x-vorbis
 Comment=Ogg Vorbis Audio
+Comment[af]=Ogg Vorbis Klank
+Comment[ar]=ملف Ogg Vorbis صوتي
 Comment[be]=Ogg Vorbis аўдыё
 Comment[bg]=Аудио файл Ogg Vorbis
 Comment[bn]=অগ ভরবিস অডিও
@@ -22,6 +24,7 @@
 Comment[fa]=صوتی Ogg Vorbis
 Comment[fi]=Ogg Vorbis -ääni
 Comment[fr]=Son Ogg Vorbis
+Comment[ga]=Fuaim Ogg Vorbis
 Comment[gl]=Son Vorbis Ogg
 Comment[he]=שמע Ogg Vorbis
 Comment[hi]=ऑग वॉर्बिस ऑडियो
@@ -32,9 +35,11 @@
 Comment[ja]=Ogg Vorbis オーディオ
 Comment[ko]=Ogg Vorbis 오디오
 Comment[lt]=Ogg Vorbis audio
+Comment[mk]=Ogg Vorbis аудио
 Comment[mn]=Ogg Vorbis Аудио
 Comment[mt]=Awdjo Ogg Vorbis
 Comment[nb]=Ogg Vorbis-lyd
+Comment[nds]=Ogg-Vorbis-Audiodatei
 Comment[nl]=Ogg Vorbis-audio
 Comment[nn]=Ogg Vorbis-lyd
 Comment[pa]=Ogg Vorbis ਧੁਨੀ
diff -urN -x CVS kdelibs.orig/mimetypes/audio/x-adpcm.desktop kdelibs/mimetypes/audio/x-adpcm.desktop
--- kdelibs.orig/mimetypes/audio/x-adpcm.desktop	Tue Aug 24 08:29:55 2004
+++ kdelibs/mimetypes/audio/x-adpcm.desktop	Mon Nov 22 09:34:05 2004
@@ -2,7 +2,7 @@
 Encoding=UTF-8
 Type=MimeType
 Comment=PCM Audio
-Comment[af]=Pcm Audio
+Comment[af]=PCM Klank
 Comment[ar]=صوت PCM
 Comment[be]=PCM аўдыё
 Comment[bg]=Аудио файл PCM
@@ -32,10 +32,12 @@
 Comment[ja]=PCM オーディオ
 Comment[ko]=PCM 오디오
 Comment[lt]=PCM audio
+Comment[mk]=PCM аудио
 Comment[mn]=PCM-Аудио
 Comment[ms]=Audio PCM
 Comment[mt]=Awdjo PCM
 Comment[nb]=PCM-lyd
+Comment[nds]=PCM-Audiodatei
 Comment[nl]=PCM-audio
 Comment[nn]=PCM-lyd
 Comment[nso]=Kwagalo ya PCM
@@ -53,6 +55,7 @@
 Comment[ss]=Umsindvo we PCM 
 Comment[sv]=PCM-ljud
 Comment[ta]=PCM  கேட்பொலி
+Comment[tg]=Савди PCM
 Comment[th]=แฟ้มเสียง PCM
 Comment[tr]=PCM Ses Dosyası
 Comment[uk]=PCM-аудіо
diff -urN -x CVS kdelibs.orig/mimetypes/audio/x-aiff.desktop kdelibs/mimetypes/audio/x-aiff.desktop
--- kdelibs.orig/mimetypes/audio/x-aiff.desktop	Tue Aug 24 08:29:55 2004
+++ kdelibs/mimetypes/audio/x-aiff.desktop	Mon Nov 22 09:34:05 2004
@@ -2,7 +2,7 @@
 Encoding=UTF-8
 Type=MimeType
 Comment=AIFF/Amiga Audio
-Comment[af]=Aiff/Amiga Audio
+Comment[af]=Aiff/Amiga Klank
 Comment[ar]=صوت AIFF/Amiga
 Comment[be]=AIFF/Amiga аўдыё
 Comment[bg]=Аудио файл AIFF/Amiga
@@ -32,10 +32,12 @@
 Comment[ja]=AIFF/Amiga オーディオ
 Comment[ko]=AIFF/아미가 오디오
 Comment[lt]=AIFF/Amiga audio
+Comment[mk]=AIFF/Amiga аудио
 Comment[mn]=AIFF/Amiga-Аудио
 Comment[ms]=Audio AIFF/Amiga
 Comment[mt]=Awdjo AIFF/Amiga
 Comment[nb]=AIFF/Amiga-lyd
+Comment[nds]=AIFF/Amiga-Audiodatei
 Comment[nl]=AIFF-/Amiga-audio
 Comment[nn]=AIFF-/Amiga-lyd
 Comment[nso]=Kwagalo ya AIFF/Amiga
@@ -53,6 +55,7 @@
 Comment[ss]=Umsindvo we AIFF/Amiga 
 Comment[sv]=AIFF/Amiga-ljud
 Comment[ta]=AIFF/Amiga  கேட்பொலி
+Comment[tg]=Савди AIFF/Amiga 
 Comment[th]=แฟ้มเสียง AIFF/Amiga
 Comment[tr]=AIFF/Amiga Ses Dosyası
 Comment[uk]=AIFF/Amiga-аудіо
diff -urN -x CVS kdelibs.orig/mimetypes/audio/x-flac.desktop kdelibs/mimetypes/audio/x-flac.desktop
--- kdelibs.orig/mimetypes/audio/x-flac.desktop	Tue Aug 24 08:29:55 2004
+++ kdelibs/mimetypes/audio/x-flac.desktop	Sat Oct 30 08:38:26 2004
@@ -2,6 +2,8 @@
 Encoding=UTF-8
 Type=MimeType
 Comment=FLAC Audio
+Comment[af]=FLAC Klank
+Comment[ar]=ملف FLAC صوتي
 Comment[be]=FLAC аўдыё
 Comment[bg]=Аудио файл FLAC
 Comment[bn]=এফ-এল-এ-সি (FLAC) অডিও
@@ -19,6 +21,7 @@
 Comment[fa]=صوتی FLAC
 Comment[fi]=FLAC-ääni
 Comment[fr]=Son FLAC
+Comment[ga]=Fuaim FLAC
 Comment[gl]=Son en FLAC
 Comment[he]=שמע FLAC
 Comment[hi]=FLAC आडियो
@@ -29,8 +32,10 @@
 Comment[ja]=FLAC オーディオ
 Comment[ko]=FLAC 오디오
 Comment[lt]=FLAC audio
+Comment[mk]=FLAC аудио
 Comment[mn]=FLAC Аудио
 Comment[nb]=FLAC-lyd
+Comment[nds]=FLAC-Audiodatei
 Comment[nl]=FLAC-audio
 Comment[nn]=FLAC-lyd
 Comment[pa]=FLAC ਧੁਨੀ
diff -urN -x CVS kdelibs.orig/mimetypes/audio/x-matroska.desktop kdelibs/mimetypes/audio/x-matroska.desktop
--- kdelibs.orig/mimetypes/audio/x-matroska.desktop	Tue Aug 24 08:29:55 2004
+++ kdelibs/mimetypes/audio/x-matroska.desktop	Sat Oct 30 08:38:26 2004
@@ -5,6 +5,8 @@
 Icon=sound
 Patterns=*.mka;*.MKA;
 Comment=Matroska Audio
+Comment[af]=Matroska Klank
+Comment[ar]=ملف ماتروسكا صوتي
 Comment[be]=Матрошка аўдыё
 Comment[bg]=Аудио файл Matroska
 Comment[bn]=ম্যাট্রস্কা অডিও
@@ -22,6 +24,7 @@
 Comment[fa]=صوتی Matroska
 Comment[fi]=Matroska-ääni
 Comment[fr]=Son Matroska
+Comment[ga]=Fuaim Matroska
 Comment[gl]=Son Matroska
 Comment[he]=Matroska שמע
 Comment[hi]=मात्रोस्का ऑडियो
@@ -31,8 +34,10 @@
 Comment[it]=Audio Matroska
 Comment[ja]=Matroska オーディオ
 Comment[lt]=Matroska audio
+Comment[mk]=Matroska аудио
 Comment[mn]=Matroska Аудио
 Comment[nb]=Matroska lyd
+Comment[nds]=Matroska-Audiodatei
 Comment[nl]=Matroska-audio
 Comment[nn]=Matroska-lyd
 Comment[pa]=Matroska ਧੁਨੀ
diff -urN -x CVS kdelibs.orig/mimetypes/audio/x-midi.desktop kdelibs/mimetypes/audio/x-midi.desktop
--- kdelibs.orig/mimetypes/audio/x-midi.desktop	Tue Aug 24 08:29:55 2004
+++ kdelibs/mimetypes/audio/x-midi.desktop	Mon Nov 22 09:34:05 2004
@@ -5,7 +5,7 @@
 Icon=midi
 Patterns=*.mid;*.MID;
 Comment=MIDI Audio
-Comment[af]=Midi Audio
+Comment[af]=MIDI Klank
 Comment[ar]=صوت MIDI
 Comment[be]=MIDI аўдыё
 Comment[bg]=Аудио файл MIDI
@@ -35,10 +35,12 @@
 Comment[ja]=MIDI オーディオ
 Comment[ko]=미디 오디오
 Comment[lt]=MIDI audio
+Comment[mk]=MIDI аудио
 Comment[mn]=MIDI-Аудио
 Comment[ms]=Audio MIDI
 Comment[mt]=Awdio MIDI
 Comment[nb]=MIDI-lyd
+Comment[nds]=MIDI-Audiodatei
 Comment[nl]=Midi-audio
 Comment[nn]=MIDI-lyd
 Comment[nso]=Kwagalo ya MIDI
@@ -56,6 +58,7 @@
 Comment[ss]=msindvo we MIDI 
 Comment[sv]=Midi-ljud
 Comment[ta]=MIDI  கேட்பொலி
+Comment[tg]=Савди MIDI
 Comment[th]=แฟ้มเสียง MIDI
 Comment[tr]=MIDI Ses Dosyası
 Comment[uk]=MIDI-аудіо
diff -urN -x CVS kdelibs.orig/mimetypes/audio/x-mod.desktop kdelibs/mimetypes/audio/x-mod.desktop
--- kdelibs.orig/mimetypes/audio/x-mod.desktop	Tue Aug 24 08:29:55 2004
+++ kdelibs/mimetypes/audio/x-mod.desktop	Sat Oct 30 08:38:26 2004
@@ -34,10 +34,12 @@
 Comment[ja]=Amiga Soundtracker オーディオ
 Comment[ko]=아미가 사운트 트랙커 오디오
 Comment[lt]=Amiga Soundtracker audio
+Comment[mk]=Amiga Soundtracker аудио
 Comment[mn]=Amiga Soundtracker-Аудио
 Comment[ms]=Audio Penjejak Bunyi Amiga
 Comment[mt]=Awdjo Amiga Soundtracker
 Comment[nb]=Amiga lydtracker-lyd
+Comment[nds]=Amiga-Soundtracker-Audiodatei
 Comment[nl]=Amiga Soundtracker-audio
 Comment[nn]=Amiga Soundtracker-lyd
 Comment[nso]=Kwagalo ya Sentshamodumo sa Amiga
diff -urN -x CVS kdelibs.orig/mimetypes/audio/x-mp2.desktop kdelibs/mimetypes/audio/x-mp2.desktop
--- kdelibs.orig/mimetypes/audio/x-mp2.desktop	Sun Sep 12 15:56:17 2004
+++ kdelibs/mimetypes/audio/x-mp2.desktop	Fri Nov 12 08:27:54 2004
@@ -6,6 +6,7 @@
 Patterns=*.mp2;*.MP2;
 X-KDE-IsAlso=audio/mpeg
 Comment=MPEG Layer 2 Audio
+Comment[af]=MPEG Vlak 2 Klank
 Comment[be]=MPEG Layer 2 аўдыё
 Comment[bg]=Аудио файл MP2
 Comment[bn]=এমপেগ লেয়ার ২ অডিও
@@ -25,7 +26,10 @@
 Comment[is]=MPEG teg. 2 hljóðskrá
 Comment[it]=Audio MPEG layer 2
 Comment[ja]=MPEG Layer 2 オーディオ
+Comment[lt]=MPEG Layer 2 audio
+Comment[mk]=MPEG Layer 2 аудио
 Comment[nb]=MPEG lag 2-lyd
+Comment[nds]=MPEG-Audiodatei (Layer 2)
 Comment[nl]=MPEG Layer2-audio
 Comment[nn]=MPEG lag 2-lyd
 Comment[pa]=MPEG ਪਰਤ੨ ਧੁਨੀ
@@ -33,11 +37,12 @@
 Comment[pt]=Audio MPEG Layer 2
 Comment[pt_BR]=Áudio MPEG 2
 Comment[ro]=Fişier audio MPEG Layer 2
+Comment[ru]=Звуковой файл MPEG Layer 2
 Comment[se]=MPEG dási 2-jietna
 Comment[sk]=Zvuk MPEG layer 2
 Comment[sl]=Zvok oblike MPEG layer 2
 Comment[sr]=MPEG ниво 2 аудио
-Comment[sr@Latn]=MPEG ниво 2 аудио
+Comment[sr@Latn]=MPEG nivo 2 audio
 Comment[sv]=MPEG lager 2-ljud
 Comment[ta]=MPEG அடுக்கு 3  கேட்பொலி
 Comment[tg]=Файли садои лояи 2 барои MPEG
diff -urN -x CVS kdelibs.orig/mimetypes/audio/x-mp3.desktop kdelibs/mimetypes/audio/x-mp3.desktop
--- kdelibs.orig/mimetypes/audio/x-mp3.desktop	Tue Aug 24 08:29:55 2004
+++ kdelibs/mimetypes/audio/x-mp3.desktop	Sat Oct 30 08:38:26 2004
@@ -6,7 +6,7 @@
 Patterns=*.mp3;*.MP3;
 X-KDE-IsAlso=audio/mpeg
 Comment=MPEG Layer 3 Audio
-Comment[af]=Mpeg Laag 3 Audio
+Comment[af]=MPEG Vlak 3 Klank
 Comment[ar]=صوت MPEG الطبقة 3
 Comment[be]=MPEG Layer 3 аўдыё
 Comment[bg]=Аудио файл MP3
@@ -36,10 +36,12 @@
 Comment[ja]=MPEG Layer 3 オーディオ
 Comment[ko]=MPEG 레이어 3 오디오
 Comment[lt]=MPEG layer 3 audio
+Comment[mk]=MPEG Layer 3 аудио
 Comment[mn]=MPEG-Үе-3 Аудио
 Comment[ms]=Audio MPEG Lapisan 3
 Comment[mt]=Awdio MPEG 3
 Comment[nb]=MPEG layer 3-lyd
+Comment[nds]=MPEG-Audiodatei (Layer 3)
 Comment[nl]=MPEG Layer3-audio
 Comment[nn]=MPEG lag 3-lyd
 Comment[nso]=Kwagalo ya Peo 3 ya MPEG
diff -urN -x CVS kdelibs.orig/mimetypes/audio/x-mpegurl.desktop kdelibs/mimetypes/audio/x-mpegurl.desktop
--- kdelibs.orig/mimetypes/audio/x-mpegurl.desktop	Tue Aug 24 08:29:55 2004
+++ kdelibs/mimetypes/audio/x-mpegurl.desktop	Mon Nov 15 08:54:58 2004
@@ -31,13 +31,15 @@
 Comment[hu]=MP3 (MPEG Layer 3) sugárzási hangfájl
 Comment[is]=MP3 hljóðstraumur
 Comment[it]=Audio MPEG layer 3 in stream
-Comment[ja]=ストリーミング MPEG layer 3 オーディオ
+Comment[ja]=ストリーミング MPEG Layer 3 オーディオ
 Comment[ko]=스트리밍 MPEG 레이어 3 오디오
 Comment[lt]=MPEG layer 3 audio srautas
+Comment[mk]=Поточно MPEG Layer 3 аудио
 Comment[mn]=MPEG-Үе-3-Аудио
 Comment[ms]=Audio Aliran MPEG Peringkat 3
 Comment[mt]=Awdjo Streaming MPEG 3
 Comment[nb]=MPEG lag 3-lydstrøm
+Comment[nds]=Streaming-MPEG-Audiodatei (Layer 3)
 Comment[nl]=Streaming MPEG Layer3-audio
 Comment[nn]=MPEG lag 3-lydstraum
 Comment[nso]=Latelanya Kwagalo ya Peo 3 ya MPEG
diff -urN -x CVS kdelibs.orig/mimetypes/audio/x-ms-wma.desktop kdelibs/mimetypes/audio/x-ms-wma.desktop
--- kdelibs.orig/mimetypes/audio/x-ms-wma.desktop	Sun Sep 12 15:56:17 2004
+++ kdelibs/mimetypes/audio/x-ms-wma.desktop	Sat Oct 30 08:38:26 2004
@@ -5,6 +5,7 @@
 Icon=audio
 Patterns=*.wma;*.WMA
 Comment=Windows Media Audio
+Comment[af]=Windows Media Klank
 Comment[be]=Windows Media аўдыё
 Comment[bg]=Аудио файл Windows Media
 Comment[bn]=উইন্ডোস মিডিয়া অডিও
@@ -24,7 +25,9 @@
 Comment[is]=Windows Media hljóðskrá
 Comment[it]=Audio Windows Media
 Comment[ko]=윈도우즈 메타 오디오
+Comment[mk]=Windows Media аудио
 Comment[nb]=Windows Media-lyd
+Comment[nds]=Windows-Media-Audiodatei
 Comment[nl]=Windows Media-audio
 Comment[nn]=Windows Media-lyd
 Comment[pa]=ਵਿੰਡੋ ਮੀਡਿਆ ਫਾਇਲ
@@ -32,10 +35,11 @@
 Comment[pt]=Áudio de Windows Media
 Comment[pt_BR]=Mídia do Windows
 Comment[ro]=Fişier Windows Media Audio
+Comment[ru]=Звуковой файл Windows Media
 Comment[se]=Windows Media-jietna
 Comment[sl]=Avdio Windows Media
 Comment[sr]=Windows медија аудио
-Comment[sr@Latn]=Windows медија аудио
+Comment[sr@Latn]=Windows medija audio
 Comment[sv]=Windows-medialjud
 Comment[ta]=சாளரங்களின் ஊடக கேட்பொலி
 Comment[tg]=Аудиофайли Windows Media
diff -urN -x CVS kdelibs.orig/mimetypes/audio/x-musepack.desktop kdelibs/mimetypes/audio/x-musepack.desktop
--- kdelibs.orig/mimetypes/audio/x-musepack.desktop	Sun Sep 12 15:56:17 2004
+++ kdelibs/mimetypes/audio/x-musepack.desktop	Sat Oct 30 08:38:26 2004
@@ -5,6 +5,7 @@
 Icon=sound
 Patterns=*.mpc;*.MPC;*.mp+;*.MP+
 Comment=Musepack Audio
+Comment[af]=Musepack Klank
 Comment[be]=Musepack аўдыё
 Comment[bg]=Аудио файл Musepack
 Comment[bn]=মিউস-প্যাক অডিও
@@ -23,7 +24,9 @@
 Comment[is]=Musepack hljóðskrá
 Comment[it]=Audio Musepack
 Comment[ja]=Musepack オーディオ
+Comment[mk]=Musepack аудио
 Comment[nb]=Musepack-lyd
+Comment[nds]=Musepack-Audiodatei
 Comment[nl]=Musepack-audio
 Comment[nn]=Musepack-lyd
 Comment[pa]=Musepack ਆਡੀਓ
@@ -31,11 +34,12 @@
 Comment[pt]=Audio Musepack
 Comment[pt_BR]=Áudio Musepack
 Comment[ro]=Fişier audio Musepack
+Comment[ru]=Звуковой файл Musepack
 Comment[se]=Musepack-jietna
 Comment[sk]=Zvuk Musepack
 Comment[sl]=Zvok Musepack
 Comment[sr]=Musepack аудио
-Comment[sr@Latn]=Musepack аудио
+Comment[sr@Latn]=Musepack audio
 Comment[sv]=Musepack-ljud
 Comment[ta]= மியுஸ்பேக் ஒலி
 Comment[tg]=Файли садоии Musepack
diff -urN -x CVS kdelibs.orig/mimetypes/audio/x-oggflac.desktop kdelibs/mimetypes/audio/x-oggflac.desktop
--- kdelibs.orig/mimetypes/audio/x-oggflac.desktop	Tue Aug 24 08:29:55 2004
+++ kdelibs/mimetypes/audio/x-oggflac.desktop	Sat Oct 30 08:38:26 2004
@@ -5,6 +5,8 @@
 Icon=sound
 X-KDE-IsAlso=application/ogg
 Comment=Ogg FLAC Audio
+Comment[af]=Ogg FLAC Klank
+Comment[ar]=ملف Ogg FLAC صوتي
 Comment[be]=Ogg FLAC аўдыё
 Comment[bg]=Аудио файл Ogg FLAC
 Comment[bn]=অগ এফ-এল-এ-সি (FLAC) অডিও
@@ -22,6 +24,7 @@
 Comment[fa]=صوتی Ogg FLAC
 Comment[fi]=Ogg FLAC -ääni
 Comment[fr]=Son Ogg Flac
+Comment[ga]=Fuaim Ogg FLAC
 Comment[gl]=Son Ogg FLAC
 Comment[he]=שמע Ogg FLAC
 Comment[hi]=ऑग FLAC ऑडियो
@@ -32,8 +35,10 @@
 Comment[ja]=Ogg FLAC オーディオ
 Comment[ko]=Ogg FLAC 오디오
 Comment[lt]=Ogg FLAC audio
+Comment[mk]=Ogg FLAC аудио
 Comment[mn]=Ogg FLAC Аудио
 Comment[nb]=Ogg FLAC lyd
+Comment[nds]=Ogg-FLAC-Audiodatei
 Comment[nl]=Ogg FLAC-audio
 Comment[nn]=Ogg FLAC-lyd
 Comment[pa]=Ogg FLAC ਧੁਨੀ
diff -urN -x CVS kdelibs.orig/mimetypes/audio/x-pn-realaudio.desktop kdelibs/mimetypes/audio/x-pn-realaudio.desktop
--- kdelibs.orig/mimetypes/audio/x-pn-realaudio.desktop	Tue Aug 24 08:29:55 2004
+++ kdelibs/mimetypes/audio/x-pn-realaudio.desktop	Mon Nov 15 08:54:58 2004
@@ -4,6 +4,8 @@
 MimeType=audio/x-pn-realaudio
 Icon=sound
 Comment=RealAudio File
+Comment[af]=RealAudio Lêer
+Comment[ar]=ملف Real Audio
 Comment[az]=RealAudio Faylı
 Comment[be]=Файл RealAudio
 Comment[bg]=Аудио файл RealAudio
@@ -23,6 +25,7 @@
 Comment[fa]=پرونده‌ی RealAudio
 Comment[fi]=RealAudio tiedosto
 Comment[fr]=Fichier ReadAudio
+Comment[ga]=Comhad RealAudio
 Comment[gl]=Ficheiro de RealAudio
 Comment[he]=קובץ RealAudio
 Comment[hi]=रीयलऑडियो फ़ाइल
@@ -30,12 +33,13 @@
 Comment[hu]=RealAudio-fájl
 Comment[is]=RealAudio skrá
 Comment[it]=File RealAudio
-Comment[ja]=リアルオーディオ ファイル
+Comment[ja]=RealAudio ファイル
 Comment[ko]=리얼오디오 파일
 Comment[lt]=RealAudio byla
+Comment[mk]=RealAudio датотека
 Comment[mn]=RealAudio файл
 Comment[nb]=RealAudio-fil
-Comment[nds]=RealAudio Datei
+Comment[nds]=RealAudio-Datei
 Comment[nl]=RealAudio-bestand
 Comment[nn]=RealAudio-fil
 Comment[pa]=RealAudio ਫਾਇਲ
diff -urN -x CVS kdelibs.orig/mimetypes/audio/x-scpls.desktop kdelibs/mimetypes/audio/x-scpls.desktop
--- kdelibs.orig/mimetypes/audio/x-scpls.desktop	Tue Aug 31 09:21:46 2004
+++ kdelibs/mimetypes/audio/x-scpls.desktop	Mon Nov 15 08:54:58 2004
@@ -31,16 +31,16 @@
 Comment[id]=Playlist MP3 ShoutCast
 Comment[is]=MP3 ShoutCast lagalisti
 Comment[it]=Playlist MP3 ShoutCast
+Comment[ja]=MP3 ShoutCast プレイリスト
 Comment[ko]=MP3 샤우트캐스트 연주 목록
 Comment[lt]=MP3 ShoutCast gaidaraštis
 Comment[lv]=MP3 ShoutCast Plejlists
 Comment[mi]=Rärangi-takaro MP3 ShoutCast
-Comment[mk]=MP3 ShoutCast плеј-листа
 Comment[mn]=MP3-ShoutCast-тоглуулах жигсаалт
 Comment[ms]=Senarai main MP3 ShoutCast
 Comment[mt]=Lista ta' Diski MP3 ShoutCast
 Comment[nb]=MP3 ShoutCast-spilleliste
-Comment[nds]=MP3 ShoutCast Afspeellist
+Comment[nds]=MP3-ShoutCast-Afspeellist
 Comment[nl]=MP3-ShoutCast-afspeellijst
 Comment[nn]=MP3 ShoutCast-speleliste
 Comment[nso]=Palo ya Papadi ya SoutCast ya MP3
diff -urN -x CVS kdelibs.orig/mimetypes/audio/x-speex.desktop kdelibs/mimetypes/audio/x-speex.desktop
--- kdelibs.orig/mimetypes/audio/x-speex.desktop	Tue Aug 24 08:29:55 2004
+++ kdelibs/mimetypes/audio/x-speex.desktop	Sat Oct 30 08:38:26 2004
@@ -5,6 +5,8 @@
 Icon=sound
 Patterns=*.spx;*.SPX;
 Comment=Speex Audio
+Comment[af]=Speex Klank
+Comment[ar]=ملف Speex صوتي
 Comment[be]=Speex аўдыё
 Comment[bg]=Аудио файл Speex
 Comment[bn]=স্পীক্স অডিও
@@ -22,6 +24,7 @@
 Comment[fa]=صوتی Speex
 Comment[fi]=Speex-ääni
 Comment[fr]=Son Speex
+Comment[ga]=Fuaim Speex
 Comment[gl]=Son Speex
 Comment[he]=שמע Speex
 Comment[hi]=स्पीक्स ऑडियो
@@ -31,8 +34,10 @@
 Comment[it]=Audio Speex
 Comment[ja]=Speex オーディオ
 Comment[lt]=Speex audio
+Comment[mk]=Speex аудио
 Comment[mn]=Speex Аудио
 Comment[nb]=Speex lyd
+Comment[nds]=Speex-Audiodatei
 Comment[nl]=Speex-audio
 Comment[nn]=Speex-lyd
 Comment[pa]=Speex ਆਡੀਓ
diff -urN -x CVS kdelibs.orig/mimetypes/audio/x-vorbis.desktop kdelibs/mimetypes/audio/x-vorbis.desktop
--- kdelibs.orig/mimetypes/audio/x-vorbis.desktop	Tue Aug 24 08:29:55 2004
+++ kdelibs/mimetypes/audio/x-vorbis.desktop	Sat Oct 30 08:38:26 2004
@@ -5,6 +5,8 @@
 Icon=sound
 X-KDE-IsAlso=application/ogg
 Comment=Ogg Vorbis Audio
+Comment[af]=Ogg Vorbis Klank
+Comment[ar]=ملف Ogg Vorbis صوتي
 Comment[be]=Ogg Vorbis аўдыё
 Comment[bg]=Аудио файл Ogg Vorbis
 Comment[bn]=অগ ভরবিস অডিও
@@ -22,6 +24,7 @@
 Comment[fa]=صوتی Ogg Vorbis
 Comment[fi]=Ogg Vorbis -ääni
 Comment[fr]=Son Ogg Vorbis
+Comment[ga]=Fuaim Ogg Vorbis
 Comment[gl]=Son Vorbis Ogg
 Comment[he]=שמע Ogg Vorbis
 Comment[hi]=ऑग वॉर्बिस ऑडियो
@@ -32,9 +35,11 @@
 Comment[ja]=Ogg Vorbis オーディオ
 Comment[ko]=Ogg Vorbis 오디오
 Comment[lt]=Ogg Vorbis audio
+Comment[mk]=Ogg Vorbis аудио
 Comment[mn]=Ogg Vorbis Аудио
 Comment[mt]=Awdjo Ogg Vorbis
 Comment[nb]=Ogg Vorbis-lyd
+Comment[nds]=Ogg-Vorbis-Audiodatei
 Comment[nl]=Ogg Vorbis-audio
 Comment[nn]=Ogg Vorbis-lyd
 Comment[pa]=Ogg Vorbis ਧੁਨੀ
diff -urN -x CVS kdelibs.orig/mimetypes/audio/x-wav.desktop kdelibs/mimetypes/audio/x-wav.desktop
--- kdelibs.orig/mimetypes/audio/x-wav.desktop	Tue Aug 24 08:29:55 2004
+++ kdelibs/mimetypes/audio/x-wav.desktop	Mon Nov 22 09:34:05 2004
@@ -35,10 +35,12 @@
 Comment[ja]=WAV オーディオ
 Comment[ko]=WAV 오디오
 Comment[lt]=WAV audio
+Comment[mk]=WAV аудио
 Comment[mn]=WAV-Аудио
 Comment[ms]=Audio WAV
 Comment[mt]=Awdjo WAV
 Comment[nb]=WAV-lyd
+Comment[nds]=WAV-Audiodatei
 Comment[nl]=WAV-audio
 Comment[nn]=WAV-lyd
 Comment[nso]=Kwagalo ya WAV
@@ -56,6 +58,7 @@
 Comment[ss]=Umsindvo WAV
 Comment[sv]=Wav-ljud
 Comment[ta]=WAV கேட்பொலி
+Comment[tg]=Савди WAV
 Comment[th]=แฟ้มเสียง WAV
 Comment[tr]=WAV Sesi
 Comment[uk]=WAV-аудіо
diff -urN -x CVS kdelibs.orig/mimetypes/image/cgm.desktop kdelibs/mimetypes/image/cgm.desktop
--- kdelibs.orig/mimetypes/image/cgm.desktop	Tue Aug 24 08:29:56 2004
+++ kdelibs/mimetypes/image/cgm.desktop	Sat Oct 30 08:38:27 2004
@@ -33,9 +33,11 @@
 Comment[ko]=컴퓨터 그림 메타 파일
 Comment[lt]=Kompiuterio grafikos metabyla
 Comment[lv]=Dator Grafikas Metafails
+Comment[mk]=Метадатотека со компјутерска графика
 Comment[mn]=Компьютерын графикын Мита файл
 Comment[ms]=Fail Meta Grafik Komputer
 Comment[nb]=Metafil for datagrafikk
+Comment[nds]=Reeknergrafik-Metadatei
 Comment[nl]=Computer Graphics-metabestand
 Comment[nn]=Metafil for datagrafikk
 Comment[nso]=Metafaele wa di-Graphic tsa Computer
diff -urN -x CVS kdelibs.orig/mimetypes/image/fax-g3.desktop kdelibs/mimetypes/image/fax-g3.desktop
--- kdelibs.orig/mimetypes/image/fax-g3.desktop	Tue Aug 24 08:29:56 2004
+++ kdelibs/mimetypes/image/fax-g3.desktop	Sat Oct 30 08:38:27 2004
@@ -37,10 +37,12 @@
 Comment[ja]=CCITT G3 fax
 Comment[ko]=CCITT G3 팩스
 Comment[lt]=CCITT g3 faksas
+Comment[mk]=CCITT G3 факс
 Comment[mn]=CCITT-G3-Факс
 Comment[ms]=Faks CCITT G3
 Comment[mt]=faks CCITT g3
 Comment[nb]=CCITT G3-Fax
+Comment[nds]=CCITT-G3-Fax
 Comment[nl]=CCITT G3-fax
 Comment[nn]=CCITT g3-faks
 Comment[pa]=CCITT G3 ਫੈਕਸ
diff -urN -x CVS kdelibs.orig/mimetypes/image/gif.desktop kdelibs/mimetypes/image/gif.desktop
--- kdelibs.orig/mimetypes/image/gif.desktop	Tue Aug 24 08:29:56 2004
+++ kdelibs/mimetypes/image/gif.desktop	Sat Oct 30 08:38:27 2004
@@ -37,6 +37,7 @@
 Comment[ja]=GIF イメージ
 Comment[ko]=GIF 그림
 Comment[lt]=GIF paveiksliukas
+Comment[mk]=GIF слика
 Comment[mn]=GIF-Зураг
 Comment[ms]=Imej GIF
 Comment[mt]=Stampa GIF
diff -urN -x CVS kdelibs.orig/mimetypes/image/jp2.desktop kdelibs/mimetypes/image/jp2.desktop
--- kdelibs.orig/mimetypes/image/jp2.desktop	Tue Aug 24 08:29:56 2004
+++ kdelibs/mimetypes/image/jp2.desktop	Sat Oct 30 08:38:27 2004
@@ -5,6 +5,8 @@
 Icon=image
 Patterns=*.jp2;*.JP2
 Comment=JPEG 2000 Image
+Comment[af]=JPEG 2000 Beeld
+Comment[ar]=صورة JPEG 2000
 Comment[az]=JPEG 2000 Rəsmi
 Comment[be]=Выява JPEG 2000
 Comment[bg]=Изображение JPEG 2000
@@ -35,10 +37,11 @@
 Comment[ja]=JPEG 2000 イメージ
 Comment[ko]=JPEG 2000 그림
 Comment[lt]=JPEG 2000 paveiksliukas
+Comment[mk]=JPEG 2000 слика
 Comment[mn]=JPEG 2000 зураг
 Comment[ms]=Imej JPEG 2000
 Comment[nb]=JPEG-2000 bilde
-Comment[nds]=JPEG 2000-Bild
+Comment[nds]=JPEG-2000-Bild
 Comment[nl]=JPEG 2000-afbeelding
 Comment[nn]=JPEG 2000-bilete
 Comment[pa]=JPEG 2000 ਚਿੱਤਰ
diff -urN -x CVS kdelibs.orig/mimetypes/image/jpeg.desktop kdelibs/mimetypes/image/jpeg.desktop
--- kdelibs.orig/mimetypes/image/jpeg.desktop	Tue Aug 24 08:29:56 2004
+++ kdelibs/mimetypes/image/jpeg.desktop	Sat Oct 30 08:38:27 2004
@@ -5,7 +5,7 @@
 Icon=image
 Patterns=*.jpg;*.JPG;*.jpeg;*.JPEG;
 Comment=JPEG Image
-Comment[af]=Jpeg Beeld
+Comment[af]=JPEG Beeld
 Comment[ar]=صورة JPEG
 Comment[az]=JPEG Rəsmi
 Comment[be]=Выява JPEG
@@ -37,6 +37,7 @@
 Comment[ja]=JPEG イメージ
 Comment[ko]=JPEG 그림
 Comment[lt]=JPEG paveiksliukas
+Comment[mk]=JPEG слика
 Comment[mn]=JPEG-Зураг
 Comment[ms]=Imej JPEG
 Comment[mt]=Stampa JPEG
diff -urN -x CVS kdelibs.orig/mimetypes/image/pjpeg.desktop kdelibs/mimetypes/image/pjpeg.desktop
--- kdelibs.orig/mimetypes/image/pjpeg.desktop	Tue Aug 24 08:29:56 2004
+++ kdelibs/mimetypes/image/pjpeg.desktop	Sat Oct 30 08:38:27 2004
@@ -6,7 +6,7 @@
 Icon=image
 X-KDE-IsAlso=image/jpeg
 Comment=JPEG Image
-Comment[af]=Jpeg Beeld
+Comment[af]=JPEG Beeld
 Comment[ar]=صورة JPEG
 Comment[az]=JPEG Rəsmi
 Comment[be]=Выява JPEG
@@ -38,6 +38,7 @@
 Comment[ja]=JPEG イメージ
 Comment[ko]=JPEG 그림
 Comment[lt]=JPEG paveiksliukas
+Comment[mk]=JPEG слика
 Comment[mn]=JPEG-Зураг
 Comment[ms]=Imej JPEG
 Comment[mt]=Stampa JPEG
diff -urN -x CVS kdelibs.orig/mimetypes/image/png.desktop kdelibs/mimetypes/image/png.desktop
--- kdelibs.orig/mimetypes/image/png.desktop	Tue Aug 24 08:29:56 2004
+++ kdelibs/mimetypes/image/png.desktop	Sat Oct 30 08:38:27 2004
@@ -37,6 +37,7 @@
 Comment[ja]=PNG イメージ
 Comment[ko]=PNG 그림
 Comment[lt]=PNG paveiksliukas
+Comment[mk]=PNG слика
 Comment[mn]=PNG-Зураг
 Comment[ms]=Imej PNG
 Comment[mt]=Stampa PNG
diff -urN -x CVS kdelibs.orig/mimetypes/image/svg+xml.desktop kdelibs/mimetypes/image/svg+xml.desktop
--- kdelibs.orig/mimetypes/image/svg+xml.desktop	Mon Sep  6 15:47:49 2004
+++ kdelibs/mimetypes/image/svg+xml.desktop	Sat Oct 30 08:38:27 2004
@@ -28,10 +28,11 @@
 Comment[ja]=スケーラブルベクトルグラフィックス
 Comment[lt]=Keičiamo dydžio vektorinė grafika
 Comment[lv]=Mērogojama Vektoru Grafika
+Comment[mk]=Скалабилна векторска графика
 Comment[mn]=Хувиргаж болох вектор график
 Comment[ms]=Grafik boleh Skala Vektor
 Comment[nb]=Skalerbar vektor-grafikk
-Comment[nds]=Skaleerbaar Vektorgrafik
+Comment[nds]=Skaleerbor Vektorgrafik
 Comment[nl]=Schaalbare Vector Afbeelding
 Comment[nn]=Vektorgrafikk (Scalable Vector Graphics)
 Comment[nso]=Di-Graphics tsa Vector yeo e Kalegago
diff -urN -x CVS kdelibs.orig/mimetypes/image/x-bmp.desktop kdelibs/mimetypes/image/x-bmp.desktop
--- kdelibs.orig/mimetypes/image/x-bmp.desktop	Tue Aug 24 08:29:56 2004
+++ kdelibs/mimetypes/image/x-bmp.desktop	Sat Oct 30 08:38:27 2004
@@ -5,6 +5,8 @@
 Icon=image
 Patterns=*.bmp;*.BMP;
 Comment=BMP Image
+Comment[af]=BMP Beeld
+Comment[ar]=صورة BMP
 Comment[az]=BMP Rəsmi
 Comment[be]=Выява BMP
 Comment[bg]=Изображение BMP
@@ -35,6 +37,7 @@
 Comment[ja]=BMP イメージ
 Comment[ko]=BMP 그림
 Comment[lt]=BMP paveiksliukas
+Comment[mk]=BMP слика
 Comment[mn]=BMP зураг
 Comment[ms]=Imej BMP
 Comment[nb]=BMP-bilde
diff -urN -x CVS kdelibs.orig/mimetypes/image/x-dds.desktop kdelibs/mimetypes/image/x-dds.desktop
--- kdelibs.orig/mimetypes/image/x-dds.desktop	Sun Sep 12 15:56:17 2004
+++ kdelibs/mimetypes/image/x-dds.desktop	Sun Oct 24 09:02:11 2004
@@ -5,6 +5,7 @@
 Icon=image
 Patterns=*.dds;*.DDS;
 Comment=DirectDraw Surface
+Comment[af]=DirectDraw Oppervlakte
 Comment[be]=Паверхня DirectDraw
 Comment[bg]=Област с директно изчертаване
 Comment[bn]=ডায়রেক্ট-ড্র সারফেস
@@ -20,17 +21,19 @@
 Comment[is]=DirectDraw yfirborð
 Comment[it]=Superficie DirectDraw
 Comment[nb]=DirectDraw-overflate
+Comment[nds]=Böversiet för DirectDraw
 Comment[nl]=Direct beeldgeheugen
 Comment[nn]=DirectDraw-overflate
 Comment[pl]=Powierzchnia DirectDraw
 Comment[pt]=Superfície DirectDraw
 Comment[pt_BR]=DirectDraw
 Comment[ro]=Suprafaţă DirectDraw
+Comment[ru]=Поверхность DirectDraw
 Comment[se]=DirectDraw-guovlu
 Comment[sk]=Povrch DirectDraw
 Comment[sl]=Površina DirectDraw
 Comment[sr]=Површина за директно цртање
-Comment[sr@Latn]=Површина за директно цртање
+Comment[sr@Latn]=Površina za direktno crtanje
 Comment[sv]=Direktrityta
 Comment[ta]=நேரடி வரையும் சூழல்
 Comment[tg]=Кашидани сатҳи мустақим
diff -urN -x CVS kdelibs.orig/mimetypes/image/x-eps.desktop kdelibs/mimetypes/image/x-eps.desktop
--- kdelibs.orig/mimetypes/image/x-eps.desktop	Tue Aug 24 08:29:56 2004
+++ kdelibs/mimetypes/image/x-eps.desktop	Sat Oct 30 08:38:27 2004
@@ -37,6 +37,7 @@
 Comment[ja]=Encapsulated PostScript イメージ
 Comment[ko]=암호화된 포스트스크립트 그림
 Comment[lt]=Įsiūtas PostScript paveiksliukas
+Comment[mk]=Encapsulated PostScript слика
 Comment[mn]=Хайрцагласан PostScript
 Comment[ms]=Imej PostScript Terenkapsul
 Comment[mt]=Stampa PostScript Enkapsulat
diff -urN -x CVS kdelibs.orig/mimetypes/image/x-exr.desktop kdelibs/mimetypes/image/x-exr.desktop
--- kdelibs.orig/mimetypes/image/x-exr.desktop	Sun Sep 12 15:56:17 2004
+++ kdelibs/mimetypes/image/x-exr.desktop	Fri Nov 12 08:27:55 2004
@@ -5,6 +5,7 @@
 Icon=image
 Patterns=*.exr;*.EXR;
 Comment=ILM EXR Image
+Comment[af]=ILM EXR Beeld
 Comment[be]=Выява ILM EXR
 Comment[bg]=Изображение ILM EXR
 Comment[bn]=ILM EXR ইমেজ
@@ -27,7 +28,10 @@
 Comment[it]=Immagine EXR ILM
 Comment[ja]=ILM EXR イメージ
 Comment[ko]=ILM EXR 그림
+Comment[lt]=ILM EXR paveiksliukas
+Comment[mk]=ILM EXR слика
 Comment[nb]=ILM EXR-bilete
+Comment[nds]=ILM EXR-Bild
 Comment[nl]=ILM EXR-afbeelding
 Comment[nn]=ILM EXR-bilete
 Comment[pa]=ILM EXR ਚਿੱਤਰ
@@ -35,11 +39,12 @@
 Comment[pt]=Imagem ILM EXR
 Comment[pt_BR]=Imagem EXR ILM
 Comment[ro]=Imagine ILM EXR
+Comment[ru]=Изображение ILM EXR
 Comment[se]=ILM EXR-govva
 Comment[sk]=ILM EXR obrázok
 Comment[sl]=Slika ILM EXR
 Comment[sr]=ILM EXR слика
-Comment[sr@Latn]=ILM EXR слика
+Comment[sr@Latn]=ILM EXR slika
 Comment[sv]=ILM EXR-bild
 Comment[ta]=ILM EXR பிம்பம்
 Comment[tg]=Тасвири ILM EXR
diff -urN -x CVS kdelibs.orig/mimetypes/image/x-ico.desktop kdelibs/mimetypes/image/x-ico.desktop
--- kdelibs.orig/mimetypes/image/x-ico.desktop	Tue Aug 31 09:21:46 2004
+++ kdelibs/mimetypes/image/x-ico.desktop	Sat Oct 30 08:38:27 2004
@@ -37,6 +37,7 @@
 Comment[ja]=ウィンドウズアイコン
 Comment[ko]=윈도우즈 아이콘
 Comment[lt]=Windows ženkliukas
+Comment[mk]=Windows икона
 Comment[mn]=MS Windows-Тэмдэг
 Comment[ms]=Ikon Windows
 Comment[mt]=Ikona tal-Windows
diff -urN -x CVS kdelibs.orig/mimetypes/image/x-jng.desktop kdelibs/mimetypes/image/x-jng.desktop
--- kdelibs.orig/mimetypes/image/x-jng.desktop	Tue Aug 24 08:29:56 2004
+++ kdelibs/mimetypes/image/x-jng.desktop	Sat Oct 30 08:38:27 2004
@@ -37,6 +37,7 @@
 Comment[ja]=JNG イメージ
 Comment[ko]=JNG 그림
 Comment[lt]=JNG paveiksliukas
+Comment[mk]=JNG слика
 Comment[mn]=JNG-Зураг
 Comment[ms]=Imej JNG
 Comment[mt]=Stampa JNG
diff -urN -x CVS kdelibs.orig/mimetypes/image/x-msod.desktop kdelibs/mimetypes/image/x-msod.desktop
--- kdelibs.orig/mimetypes/image/x-msod.desktop	Tue Aug 24 08:29:56 2004
+++ kdelibs/mimetypes/image/x-msod.desktop	Sat Oct 30 08:38:27 2004
@@ -31,10 +31,12 @@
 Comment[is]=Microsoft Office teikning
 Comment[ko]=마이크로소프트 오피스 그림
 Comment[lt]=Microsoft Office piešinys
+Comment[mk]=Microsoft Office цртеж
 Comment[mn]=MS Office-Зураглал
 Comment[ms]=Lukisan Microsoft Office
 Comment[mt]=Tpinġija Microsoft Office
 Comment[nb]=MS Office Tegning
+Comment[nds]=Teken vun Microsoft Office
 Comment[nl]=MS Office-tekening
 Comment[nn]=Microsoft Office-teikning
 Comment[nso]=Tako ya Ofisi ya Microsoft
diff -urN -x CVS kdelibs.orig/mimetypes/image/x-pcx.desktop kdelibs/mimetypes/image/x-pcx.desktop
--- kdelibs.orig/mimetypes/image/x-pcx.desktop	Tue Aug 24 08:29:56 2004
+++ kdelibs/mimetypes/image/x-pcx.desktop	Sat Oct 30 08:38:27 2004
@@ -5,6 +5,7 @@
 Icon=image
 Patterns=*.pcx;*.PCX;
 Comment=PCX Image
+Comment[af]=PCX Beeld
 Comment[ar]=صورة PNG
 Comment[az]=PCX Rəsmi
 Comment[be]=Выява PCX
@@ -36,6 +37,7 @@
 Comment[ja]=PCX イメージ
 Comment[ko]=PCX 그림
 Comment[lt]=PCX paveikslas
+Comment[mk]=PCX слика
 Comment[mn]=PCX-Зураг
 Comment[ms]=Imej PCX
 Comment[mt]=Stampa PCX
diff -urN -x CVS kdelibs.orig/mimetypes/image/x-photo-cd.desktop kdelibs/mimetypes/image/x-photo-cd.desktop
--- kdelibs.orig/mimetypes/image/x-photo-cd.desktop	Tue Aug 24 08:29:56 2004
+++ kdelibs/mimetypes/image/x-photo-cd.desktop	Sat Oct 30 08:38:27 2004
@@ -37,6 +37,7 @@
 Comment[ja]=PhotoCD イメージ
 Comment[ko]=포토CD 그림
 Comment[lt]=PhotoCD paveiksliukas
+Comment[mk]=PhotoCD слика
 Comment[mn]=Photo-CD-Зураг
 Comment[ms]=Imej PhotoCD
 Comment[mt]=Stampa PhotoCD
diff -urN -x CVS kdelibs.orig/mimetypes/image/x-portable-bitmap.desktop kdelibs/mimetypes/image/x-portable-bitmap.desktop
--- kdelibs.orig/mimetypes/image/x-portable-bitmap.desktop	Tue Aug 24 08:29:56 2004
+++ kdelibs/mimetypes/image/x-portable-bitmap.desktop	Sat Oct 30 08:38:27 2004
@@ -35,6 +35,7 @@
 Comment[ja]=ポータブルビットマップイメージ
 Comment[ko]=포터블 비트맵 그림
 Comment[lt]=Perkeliamas taškinės grafikos (bitmap) bylų formatas
+Comment[mk]=Портабилна Bitmap слика
 Comment[mn]=Шилжүүлж болох Bitmap-Зураг
 Comment[ms]=Imej Mudah Alih Bitmap
 Comment[mt]=Stampa "portable bitmap"
diff -urN -x CVS kdelibs.orig/mimetypes/image/x-portable-greymap.desktop kdelibs/mimetypes/image/x-portable-greymap.desktop
--- kdelibs.orig/mimetypes/image/x-portable-greymap.desktop	Tue Aug 24 08:29:56 2004
+++ kdelibs/mimetypes/image/x-portable-greymap.desktop	Sat Oct 30 08:38:27 2004
@@ -35,6 +35,7 @@
 Comment[it]=Immagine Portable Graymap
 Comment[ja]=ポータブルグレイマップイメージ
 Comment[lt]=Perkeliamas pilkų pustonių (greymap) paveiksliukas
+Comment[mk]=Портабилна Graymap слика
 Comment[mn]=Шилжүүлж болох Greymap-Зураг
 Comment[ms]=Imej Mudah Alih Graymap
 Comment[mt]=Stampa "portable greymap"
diff -urN -x CVS kdelibs.orig/mimetypes/image/x-portable-pixmap.desktop kdelibs/mimetypes/image/x-portable-pixmap.desktop
--- kdelibs.orig/mimetypes/image/x-portable-pixmap.desktop	Tue Aug 24 08:29:56 2004
+++ kdelibs/mimetypes/image/x-portable-pixmap.desktop	Sat Oct 30 08:38:27 2004
@@ -35,6 +35,7 @@
 Comment[ja]=ポータブルピックスマップイメージ
 Comment[ko]=포터블 픽스맵 그림
 Comment[lt]=Perkeliamas taškinės grafikos (pixmap) paveiksliukas
+Comment[mk]=Портабилна Pixmap слика
 Comment[mn]=Шилжүүлж болох Pixmap-Зураг
 Comment[ms]=Imej Mudah Alih Pixmap
 Comment[mt]=Stampa "portable pixmap"
diff -urN -x CVS kdelibs.orig/mimetypes/image/x-rgb.desktop kdelibs/mimetypes/image/x-rgb.desktop
--- kdelibs.orig/mimetypes/image/x-rgb.desktop	Sun Sep 12 15:56:17 2004
+++ kdelibs/mimetypes/image/x-rgb.desktop	Fri Nov 12 08:27:55 2004
@@ -5,6 +5,7 @@
 Icon=image
 Patterns=*.rgb;*.RGB;*.rgba;*.RGBA;*.bw;*.BW;*.sgi;*.SGI
 Comment=SGI Image (RGB)
+Comment[af]=SGI Beeld (RGB)
 Comment[be]=Выява SGI (RGB)
 Comment[bg]=Изображение SGI (RGB)
 Comment[bn]=এস-জি-আই চিত্র (RGB)
@@ -20,6 +21,7 @@
 Comment[et]=SGI pildifail (RGB)
 Comment[fi]=SGI-kuva (RGB)
 Comment[fr]=Image SGI (RVB)
+Comment[ga]=Íomhá SGI (RGB)
 Comment[he]=תמונת SGI (RGB)
 Comment[hr]=SGI slika (RGB)
 Comment[hu]=SGI-kép (RGB)
@@ -27,7 +29,10 @@
 Comment[it]=Immagine SGI (RGB)
 Comment[ja]=SGI イメージ (RGB)
 Comment[ko]=SGI 그림 (RGB)
+Comment[lt]=SGI paveiksliukas (RGB)
+Comment[mk]=SGI слика (RGB)
 Comment[nb]=SGI-bilde (RGB)
+Comment[nds]=SGI-Bild (RGB)
 Comment[nl]=SGI-Afbeelding (RGB)
 Comment[nn]=SGI-bilete (RGB)
 Comment[pa]=SGI ਚਿੱਤਰ (RGB)
@@ -35,11 +40,12 @@
 Comment[pt]=Imagem SGI (RGB)
 Comment[pt_BR]=Imagem SGI (RGB)
 Comment[ro]=Imagine SGI (RGB)
+Comment[ru]=Изображение SGI (RGB)
 Comment[se]=SGI-govva (RGB)
 Comment[sk]=Obrázok SGI (RGB)
 Comment[sl]=Slika SGI (RGB)
 Comment[sr]=SGI слика (RGB)
-Comment[sr@Latn]=SGI слика (RGB)
+Comment[sr@Latn]=SGI slika (RGB)
 Comment[sv]=SGI-bild (RGB)
 Comment[ta]=GIF பிம்பம்
 Comment[tg]=Тасвири SGI (RGB)
diff -urN -x CVS kdelibs.orig/mimetypes/image/x-targa.desktop kdelibs/mimetypes/image/x-targa.desktop
--- kdelibs.orig/mimetypes/image/x-targa.desktop	Tue Aug 24 08:29:56 2004
+++ kdelibs/mimetypes/image/x-targa.desktop	Sat Oct 30 08:38:27 2004
@@ -5,6 +5,7 @@
 Icon=image
 Patterns=*.tga;*.TGA;
 Comment=Truevision Targa Image
+Comment[af]=Truevision Targa Beeld
 Comment[ar]=صورة Truevision Targa
 Comment[az]=Truevision Targa Rəsmi
 Comment[be]=Выява Truevision Targa
@@ -36,11 +37,12 @@
 Comment[ja]=トゥルービジョン Targa イメージ
 Comment[ko]=트루비전 타가 그림
 Comment[lt]=Truevision Targa paveiksliukas
+Comment[mk]=Truevision Targa слика
 Comment[mn]=Truevision Targa Зураг
 Comment[ms]=Imej Truevision Targa
 Comment[mt]=Stampa Truevision Targa
 Comment[nb]=Truevision Targa-bilde
-Comment[nds]=Truevision Targa-Bild
+Comment[nds]=Truevision-Targa-Bild
 Comment[nl]=Truevision Targa-afbeelding
 Comment[nn]=Truevision Targa-bilete
 Comment[nso]=Ponagalo ya Pono ya Nnete ya Targa
diff -urN -x CVS kdelibs.orig/mimetypes/image/x-vnd.adobe.photoshop.desktop kdelibs/mimetypes/image/x-vnd.adobe.photoshop.desktop
--- kdelibs.orig/mimetypes/image/x-vnd.adobe.photoshop.desktop	Tue Aug 24 08:29:56 2004
+++ kdelibs/mimetypes/image/x-vnd.adobe.photoshop.desktop	Sat Oct 30 08:38:28 2004
@@ -5,6 +5,8 @@
 MimeType=image/x-vnd.adobe.photoshop
 Patterns=*.psd;*.PSD;
 Comment=Adobe Photoshop Image
+Comment[af]=Adobe Photoshop Beeld
+Comment[ar]=صورة أدوبي فوتوشوب
 Comment[az]=Adobe Photoshop Rəsmi
 Comment[be]=Выява Adobe Photoshop
 Comment[bg]=Изображение на Adobe Photoshop
@@ -35,10 +37,11 @@
 Comment[ja]=Adobe Photoshop イメージ
 Comment[ko]=어도비 포토샵 그림
 Comment[lt]=Adobe Photoshop paveiksliukas
+Comment[mk]=Adobe Photoshop слика
 Comment[mn]=Adobe Photoshop зураг
 Comment[ms]=Imej Adobe Photoshop
 Comment[nb]=Adobe Photoshop bilde
-Comment[nds]=Adobe Photoshop-Bild
+Comment[nds]=Adobe-Photoshop-Bild
 Comment[nl]=Adobe Photoshop-afbeelding
 Comment[nn]=Adobe Photoshop-bilete
 Comment[pa]=Adobe Photoshop ਚਿੱਤਰ
diff -urN -x CVS kdelibs.orig/mimetypes/image/x-vnd.trolltech.qpicture.desktop kdelibs/mimetypes/image/x-vnd.trolltech.qpicture.desktop
--- kdelibs.orig/mimetypes/image/x-vnd.trolltech.qpicture.desktop	Tue Aug 24 08:29:56 2004
+++ kdelibs/mimetypes/image/x-vnd.trolltech.qpicture.desktop	Tue Nov  9 08:35:30 2004
@@ -5,6 +5,8 @@
 MimeType=image/x-vnd.trolltech.qpicture
 Patterns=*.qpic;
 Comment=QPicture Metafile
+Comment[af]=QPicture Meta-Lêer
+Comment[ar]=ملف QPicture
 Comment[az]=QPicture Meta Faylı
 Comment[bg]=Мета файл на QPicture
 Comment[bn]=কিউ-পিকচার মেটা-ফাইল
@@ -33,9 +35,11 @@
 Comment[ja]=QPicture メタファイル
 Comment[ko]=QPicture 메타 파일
 Comment[lt]=QPicture metabyla
+Comment[mk]=QPicture метадатотека
 Comment[mn]=QPicture Мета файл
 Comment[ms]=Fail Meta QPicture
 Comment[nb]=QPicture metafil
+Comment[nds]=QPicture-Metadatei
 Comment[nl]=QPicture-metabestand
 Comment[nn]=QPicture-metafil
 Comment[pa]=QPicture ਮੈਟਾਫਾਇਲ਼
@@ -51,6 +55,7 @@
 Comment[sr@Latn]=QPicture meta fajl
 Comment[sv]=QPicture-metafil
 Comment[ta]=Qபடம் மீக்கோப்பு
+Comment[tg]=QСурати Metafile
 Comment[tr]=QPicture Meta Dosyası
 Comment[uk]=Мета-файл QPicture (дані що містять опис даних)
 Comment[uz]=QPicture мета-файли
diff -urN -x CVS kdelibs.orig/mimetypes/image/x-wmf.desktop kdelibs/mimetypes/image/x-wmf.desktop
--- kdelibs.orig/mimetypes/image/x-wmf.desktop	Tue Aug 31 09:21:46 2004
+++ kdelibs/mimetypes/image/x-wmf.desktop	Sat Oct 30 08:38:28 2004
@@ -31,9 +31,11 @@
 Comment[ko]=윈도우즈 메타 파일
 Comment[lt]=Windows metabyla
 Comment[lv]=Windows MetaFails
+Comment[mk]=Windows метадатотека
 Comment[ms]=Fail Meta Windows
 Comment[mt]=Metafile tal-Windows
 Comment[nb]=Windows metafil
+Comment[nds]=Windows-Metadatei
 Comment[nl]=Windows Meta-bestand
 Comment[nn]=Windows Metafile
 Comment[nso]=Faele ya Meta ya di-Window
diff -urN -x CVS kdelibs.orig/mimetypes/image/x-xbm.desktop kdelibs/mimetypes/image/x-xbm.desktop
--- kdelibs.orig/mimetypes/image/x-xbm.desktop	Tue Aug 24 08:29:56 2004
+++ kdelibs/mimetypes/image/x-xbm.desktop	Sat Oct 30 08:38:28 2004
@@ -37,6 +37,7 @@
 Comment[ja]=X ビットマップイメージ
 Comment[ko]=X용 비트맵 그림
 Comment[lt]=X BitMap paveiksliukas
+Comment[mk]=X BitMap слика
 Comment[mn]=X Bitmap зураг
 Comment[ms]=Imej X BitMap
 Comment[mt]=Stampa X BitMap
diff -urN -x CVS kdelibs.orig/mimetypes/image/x-xcf-gimp.desktop kdelibs/mimetypes/image/x-xcf-gimp.desktop
--- kdelibs.orig/mimetypes/image/x-xcf-gimp.desktop	Tue Aug 24 08:29:56 2004
+++ kdelibs/mimetypes/image/x-xcf-gimp.desktop	Sat Oct 30 08:38:28 2004
@@ -30,11 +30,12 @@
 Comment[it]=Immagine GIMP
 Comment[ja]=GIMP ネイティブイメージフォーマット
 Comment[lt]=GIMP nuosavas paveiksliukų formatas
+Comment[mk]=GIMP природен формат на слика
 Comment[mn]=GIMP-Зургийн формат
 Comment[ms]=Format Native Imej GIMP
 Comment[mt]=Stampa tal-GIMP
 Comment[nb]=GIMP-bildeformat
-Comment[nds]=GIMP sien egen Bildformat
+Comment[nds]=GIMP-Bild
 Comment[nl]=GIMP-afbeeldingbestand
 Comment[nn]=GIMP-bilete
 Comment[nso]=Thlolego ya Ponagalo ya Matswalo a GIMP
diff -urN -x CVS kdelibs.orig/mimetypes/image/x-xcursor.desktop kdelibs/mimetypes/image/x-xcursor.desktop
--- kdelibs.orig/mimetypes/image/x-xcursor.desktop	Tue Aug 24 08:29:56 2004
+++ kdelibs/mimetypes/image/x-xcursor.desktop	Sat Oct 30 08:38:28 2004
@@ -4,6 +4,8 @@
 MimeType=image/x-xcursor
 Icon=cursor
 Comment=X11 Mouse Cursor
+Comment[af]=X11 Muis Wyser
+Comment[ar]=مؤشر فأرة
 Comment[az]=X11 Siçan Kursoru
 Comment[bg]=Показалец на мишката
 Comment[bn]=X11 মাউস কার্সর
@@ -31,10 +33,11 @@
 Comment[ja]=X11 マウス カーソル
 Comment[ko]=X11 마우스 커서
 Comment[lt]=X11 pelės žymeklis
+Comment[mk]=X11 курсор за глушец
 Comment[mn]=X11 Хулганы түүчээ
 Comment[ms]=Kursor Tetikus X11
 Comment[nb]=X11 musepeker
-Comment[nds]=X11 Musswieser
+Comment[nds]=X11 Muuswieser
 Comment[nl]=X11-muisaanwijzer
 Comment[nn]=X11-musepeikar
 Comment[pa]=X11 ਮਾਊਸ ਕਰਸਰ
diff -urN -x CVS kdelibs.orig/mimetypes/image/x-xfig.desktop kdelibs/mimetypes/image/x-xfig.desktop
--- kdelibs.orig/mimetypes/image/x-xfig.desktop	Tue Aug 24 08:29:56 2004
+++ kdelibs/mimetypes/image/x-xfig.desktop	Sat Oct 30 08:38:28 2004
@@ -38,6 +38,7 @@
 Comment[ko]=XFig 파일
 Comment[lt]=XFig byla
 Comment[lv]=XFig Fails
+Comment[mk]=XFig датотека
 Comment[mn]=XFig-Файл
 Comment[ms]=Fail XFig
 Comment[mt]=Fajl XFig
diff -urN -x CVS kdelibs.orig/mimetypes/image/x-xpm.desktop kdelibs/mimetypes/image/x-xpm.desktop
--- kdelibs.orig/mimetypes/image/x-xpm.desktop	Tue Aug 24 08:29:56 2004
+++ kdelibs/mimetypes/image/x-xpm.desktop	Sat Oct 30 08:38:28 2004
@@ -37,6 +37,7 @@
 Comment[ja]=X ピックスマップイメージ
 Comment[ko]=X용 픽스맵 그림
 Comment[lt]=X taškinės grafikos (pixmap) paveiksliukas
+Comment[mk]=X PixMap слика
 Comment[mn]=X-Bitmap зураг
 Comment[ms]=Imej X PixMap
 Comment[mt]=Stampa X PixMap
diff -urN -x CVS kdelibs.orig/mimetypes/inode/block.desktop kdelibs/mimetypes/inode/block.desktop
--- kdelibs.orig/mimetypes/inode/block.desktop	Tue Aug 31 09:21:46 2004
+++ kdelibs/mimetypes/inode/block.desktop	Sat Oct 30 08:38:29 2004
@@ -36,7 +36,7 @@
 Comment[lt]=Blokinis įrenginys
 Comment[lv]=Bloku iekārta
 Comment[mi]=Taonga Mahi Wähanga
-Comment[mk]=Блоковен уред
+Comment[mk]=Блоковски уред
 Comment[mn]=Блок хандалтат төхөөрөмж
 Comment[ms]=Peranti Blok
 Comment[nb]=Blokkenhet
diff -urN -x CVS kdelibs.orig/mimetypes/inode/chardevice.desktop kdelibs/mimetypes/inode/chardevice.desktop
--- kdelibs.orig/mimetypes/inode/chardevice.desktop	Tue Aug 31 09:21:46 2004
+++ kdelibs/mimetypes/inode/chardevice.desktop	Sun Oct 24 09:02:12 2004
@@ -39,6 +39,7 @@
 Comment[mn]=Тэмдэгт хандалтат төхөөрөмж
 Comment[ms]=Peranti Aksara
 Comment[nb]=Tegnenhet
+Comment[nds]=Bookstaven-Reedschap
 Comment[nn]=Teikneining
 Comment[nso]=Leano la Hlaka
 Comment[oc]=Dispositiu de caracter
diff -urN -x CVS kdelibs.orig/mimetypes/inode/directory-locked.desktop kdelibs/mimetypes/inode/directory-locked.desktop
--- kdelibs.orig/mimetypes/inode/directory-locked.desktop	Tue Aug 24 08:29:57 2004
+++ kdelibs/mimetypes/inode/directory-locked.desktop	Sat Oct 30 08:38:29 2004
@@ -1,6 +1,8 @@
 [Desktop Entry]
 Encoding=UTF-8
 Comment=Locked Folder
+Comment[af]=Toegesluitte Gids
+Comment[ar]=مجلد مقفل
 Comment[az]=Qıfıllanmış Qovluq
 Comment[bg]=Заключена директория
 Comment[bn]=লক করা ফোল্ডার
@@ -18,6 +20,7 @@
 Comment[fa]=پوشه‌ی قفل شده
 Comment[fi]=Lukittu kansio
 Comment[fr]=Dossier verrouillé
+Comment[ga]=Comhadlann faoi ghlas
 Comment[gl]=Cartafol Bloqueado
 Comment[he]=תקייה נעולה
 Comment[hi]=तालाबंद फ़ोल्डर
@@ -28,8 +31,10 @@
 Comment[ja]=ロックされたフォルダ
 Comment[ko]=잠긴 자료방
 Comment[lt]=Užrakintas aplankas
+Comment[mk]=Заклучена датотека
 Comment[mn]=Түгжээтэй Хавтас
 Comment[nb]=Lukket mappe
+Comment[nds]=Afslaten Orner
 Comment[nl]=Afgesloten map
 Comment[nn]=Låst mappe
 Comment[pa]=ਤਾਲਾਬੰਦ ਫੋਲਡਰ
diff -urN -x CVS kdelibs.orig/mimetypes/inode/directory.desktop kdelibs/mimetypes/inode/directory.desktop
--- kdelibs.orig/mimetypes/inode/directory.desktop	Tue Aug 24 08:29:57 2004
+++ kdelibs/mimetypes/inode/directory.desktop	Sat Oct 30 08:38:29 2004
@@ -1,6 +1,8 @@
 [Desktop Entry]
 Encoding=UTF-8
 Comment=Folder
+Comment[af]=Gids
+Comment[ar]=مجلد
 Comment[az]=Qovluq
 Comment[be]=Тэчка
 Comment[bg]=Директория
@@ -20,6 +22,7 @@
 Comment[fa]=پوشه
 Comment[fi]=Kansio
 Comment[fr]=Dossier
+Comment[ga]=Comhadlann
 Comment[gl]=Cartafol
 Comment[he]=תיקייה
 Comment[hi]=फ़ोल्डर
@@ -30,9 +33,10 @@
 Comment[ja]=フォルダ
 Comment[ko]=자료방
 Comment[lt]=Aplankas
+Comment[mk]=Папка
 Comment[mn]=Хавтас
 Comment[nb]=Mappe
-Comment[nds]=Ordner
+Comment[nds]=Orner
 Comment[nl]=Map
 Comment[nn]=Mappe
 Comment[pa]=ਫੋਲਡਰ
diff -urN -x CVS kdelibs.orig/mimetypes/inode/fifo.desktop kdelibs/mimetypes/inode/fifo.desktop
--- kdelibs.orig/mimetypes/inode/fifo.desktop	Tue Aug 24 08:29:57 2004
+++ kdelibs/mimetypes/inode/fifo.desktop	Sun Oct 24 09:02:12 2004
@@ -38,6 +38,7 @@
 Comment[ms]=Paip
 Comment[mt]=Pajp
 Comment[nb]=Rør
+Comment[nds]=Wiederledden (Pipe)
 Comment[nl]=Pijp
 Comment[nn]=Røyr
 Comment[oc]=Tube (pipe)
diff -urN -x CVS kdelibs.orig/mimetypes/inode/socket.desktop kdelibs/mimetypes/inode/socket.desktop
--- kdelibs.orig/mimetypes/inode/socket.desktop	Tue Aug 24 08:29:57 2004
+++ kdelibs/mimetypes/inode/socket.desktop	Sat Oct 30 08:38:29 2004
@@ -27,9 +27,9 @@
 Comment[ko]=소켓
 Comment[lv]=Ligzda
 Comment[mi]=Köhao
-Comment[mk]=Штекер
 Comment[ms]=Soket
 Comment[nb]=Sokkel
+Comment[nds]=Sockel
 Comment[nn]=Sokkel
 Comment[nso]=Lesoba
 Comment[pa]=ਸਾਕਟ
diff -urN -x CVS kdelibs.orig/mimetypes/message/news.desktop kdelibs/mimetypes/message/news.desktop
--- kdelibs.orig/mimetypes/message/news.desktop	Tue Aug 24 08:29:58 2004
+++ kdelibs/mimetypes/message/news.desktop	Sat Oct 30 08:38:29 2004
@@ -34,11 +34,12 @@
 Comment[ja]=Usenet ニュースメッセージ
 Comment[ko]=유즈넷 새소식 메세지
 Comment[lt]=Usenet naujienų žinutė
+Comment[mk]=Usenet порака со вести
 Comment[mn]=Usenet-Артикел
 Comment[ms]=Mesej Berita Usenet
 Comment[mt]=Messaġġ usenet
 Comment[nb]=Usenet nyhetsmelding
-Comment[nds]=Usenet News-Naricht
+Comment[nds]=Usenet-Naricht
 Comment[nl]=Usenet-nieuwsbericht
 Comment[nn]=Usenet-innlegg
 Comment[nso]=Molaetsa wa Ditaba tsa Usenet
diff -urN -x CVS kdelibs.orig/mimetypes/message/rfc822.desktop kdelibs/mimetypes/message/rfc822.desktop
--- kdelibs.orig/mimetypes/message/rfc822.desktop	Tue Aug 24 08:29:58 2004
+++ kdelibs/mimetypes/message/rfc822.desktop	Sat Oct 30 08:38:29 2004
@@ -36,6 +36,7 @@
 Comment[ja]=Eメールメッセージ
 Comment[ko]=편지 메세지
 Comment[lt]=E.pašto laiškas
+Comment[mk]=е-поштенска порака
 Comment[mn]=Э-Захиа мэдээ
 Comment[ms]=Mesej Emel
 Comment[mt]=Messaġġ imejl
diff -urN -x CVS kdelibs.orig/mimetypes/model/vrml.desktop kdelibs/mimetypes/model/vrml.desktop
--- kdelibs.orig/mimetypes/model/vrml.desktop	Tue Aug 24 08:29:58 2004
+++ kdelibs/mimetypes/model/vrml.desktop	Sat Oct 30 08:38:29 2004
@@ -3,10 +3,13 @@
 Type=MimeType
 MimeType=model/vrml
 Comment=VRML Model
+Comment[af]=VRML Module
+Comment[ar]=نمودج VRML
 Comment[az]=VRML Modeli
 Comment[be]=VRML мадэль
 Comment[bg]=Модел VRML
 Comment[bn]=ভি-আর-এম-এল (VRML) মডেল
+Comment[br]=Gobari VRML
 Comment[bs]=VRML model
 Comment[ca]=Model VRML
 Comment[cs]=VRML model
@@ -31,9 +34,11 @@
 Comment[ja]=VRML モジュール
 Comment[ko]=VRML 모델
 Comment[lt]=VRML modelis
+Comment[mk]=VRML модел
 Comment[mn]=VRML Загвар
 Comment[ms]=Model VRML
 Comment[nb]=VRML-modell
+Comment[nds]=VRML-Modell
 Comment[nl]=VRML-model
 Comment[nn]=VRML-modell
 Comment[pa]=VRML ਮਾਡਲ
diff -urN -x CVS kdelibs.orig/mimetypes/multipart/mixed.desktop kdelibs/mimetypes/multipart/mixed.desktop
--- kdelibs.orig/mimetypes/multipart/mixed.desktop	Tue Aug 24 08:29:58 2004
+++ kdelibs/mimetypes/multipart/mixed.desktop	Sat Oct 30 08:38:30 2004
@@ -33,11 +33,12 @@
 Comment[it]=Documento composto
 Comment[ja]=合成ドキュメント
 Comment[lt]=Sudėtinis dokumentas
+Comment[mk]=Сложен документ
 Comment[mn]=Нийлмэл баримт
 Comment[ms]=Dokumen Kompaun
 Comment[mt]=Dokument kompost
 Comment[nb]=Sammensatt dokument
-Comment[nds]=Tosammensett Dokment
+Comment[nds]=Tosamensett Dokment
 Comment[nl]=Samengesteld document
 Comment[nn]=Samansett dokument
 Comment[nso]=Tokomane ya Kgobokanyo
diff -urN -x CVS kdelibs.orig/mimetypes/multipart/x-mixed-replace.desktop kdelibs/mimetypes/multipart/x-mixed-replace.desktop
--- kdelibs.orig/mimetypes/multipart/x-mixed-replace.desktop	Tue Aug 24 08:29:58 2004
+++ kdelibs/mimetypes/multipart/x-mixed-replace.desktop	Sat Oct 30 08:38:30 2004
@@ -31,10 +31,12 @@
 Comment[ja]=データストリーム (サーバプッシュ)
 Comment[ko]=(서버에서 보내는) 자료 스트림
 Comment[lt]=Duomenų srautas (inicijuojamas serverio)
+Comment[mk]=Поток на податоци (Server Push)
 Comment[mn]=Өгөгдлийн урсгал (Server Push)
 Comment[ms]=Aliran Data (Tolakan Pelayan)
 Comment[mt]=Sekwenza ta' data (imbuttat mis-server)
 Comment[nb]=Direkteoverførte data (fra tjener)
+Comment[nds]=Datenstroom (Server Push)
 Comment[nl]=Gegevensstroom (server push)
 Comment[nn]=Datastraum (frå tenar)
 Comment[nso]=Tatelano ya Data (Tshofo ya Seabi)
diff -urN -x CVS kdelibs.orig/mimetypes/text/calendar.desktop kdelibs/mimetypes/text/calendar.desktop
--- kdelibs.orig/mimetypes/text/calendar.desktop	Tue Aug 31 09:21:47 2004
+++ kdelibs/mimetypes/text/calendar.desktop	Sat Oct 30 08:38:30 2004
@@ -33,6 +33,7 @@
 Comment[ja]=iCalendar ファイル
 Comment[ko]=i달력 파일
 Comment[lt]=iCalendar byla
+Comment[mk]=iCalendar датотека
 Comment[mn]=iCalendar-Файл
 Comment[ms]=Fail iCalendar
 Comment[mt]=Fajl iCalendar
diff -urN -x CVS kdelibs.orig/mimetypes/text/css.desktop kdelibs/mimetypes/text/css.desktop
--- kdelibs.orig/mimetypes/text/css.desktop	Tue Aug 24 08:29:59 2004
+++ kdelibs/mimetypes/text/css.desktop	Sat Oct 30 08:38:30 2004
@@ -26,9 +26,10 @@
 Comment[ko]=계단형 스타일시트
 Comment[lt]=Pakopinis stiliaus aprašymas (CSS)
 Comment[lv]=Kaskadētu Stilu Saraksts
-Comment[mk]=CSS (список на стилови)
+Comment[mk]=CSS (страница со дизајн)
 Comment[ms]=Lembaran Gaya Lata (CSS)
 Comment[nb]=Stilsett (css)
+Comment[nds]=Stilvörlaag-Datei (Cascading Style Sheet)
 Comment[nl]=Cascading Style Sheet (stijlbladen)
 Comment[nn]=Stilark
 Comment[nso]=Letlakala la Mokgwa wo o Falatsago
diff -urN -x CVS kdelibs.orig/mimetypes/text/docbook.desktop kdelibs/mimetypes/text/docbook.desktop
--- kdelibs.orig/mimetypes/text/docbook.desktop	Tue Aug 24 08:29:59 2004
+++ kdelibs/mimetypes/text/docbook.desktop	Sat Oct 30 08:38:30 2004
@@ -1,6 +1,8 @@
 [Desktop Entry]
 Encoding=UTF-8
 Comment=DocBook Document
+Comment[af]=DocBook Dokument
+Comment[ar]=مستند DocBook
 Comment[az]=DocBook Sənədi
 Comment[be]=Дакумэнт DocBook
 Comment[bg]=Документ на DocBook
@@ -31,6 +33,7 @@
 Comment[ja]=DocBook ドキュメント
 Comment[ko]=닥북 문서
 Comment[lt]=DocBook dokumentas
+Comment[mk]=DocBook документ
 Comment[mn]=DocBook Баримт
 Comment[ms]=Dokumen DocBook
 Comment[nb]=DocBook-dokument
diff -urN -x CVS kdelibs.orig/mimetypes/text/enriched.desktop kdelibs/mimetypes/text/enriched.desktop
--- kdelibs.orig/mimetypes/text/enriched.desktop	Tue Aug 24 08:29:59 2004
+++ kdelibs/mimetypes/text/enriched.desktop	Sat Oct 30 08:38:30 2004
@@ -2,6 +2,7 @@
 Encoding=UTF-8
 MimeType=text/enriched
 Comment=Lightly Enriched Text Document
+Comment[af]='Lightly Enriched' Teks Dokument
 Comment[az]=Həfifcə Zənginləşdirilmiş Mətn Sənədi
 Comment[bg]=Леко разширен текстов файл (Lightly Enriched)
 Comment[bs]=Lightly Enriched tekst dokument
@@ -26,8 +27,10 @@
 Comment[it]=Documento di testo arricchito semplicemente
 Comment[ja]=Lightly Enriched テキストドキュメント
 Comment[lt]=Lengvai raiškus teksto dokumentas
+Comment[mk]=Лесно збогатен текстуален документ
 Comment[mn]=Хялбар баяжуулсан текст баримт
 Comment[nb]=Utvidet tekstdokument
+Comment[nds]=Textdokment mit Formateren
 Comment[nl]=Licht opgemaakt tekstdocument
 Comment[nn]=Lightly Enriched-tekstdokument
 Comment[pa]=ਹਲਕਾ ਤਕਨੀਕੀ ਪਾਠ ਦਸਤਾਵੇਜ਼
diff -urN -x CVS kdelibs.orig/mimetypes/text/html.desktop kdelibs/mimetypes/text/html.desktop
--- kdelibs.orig/mimetypes/text/html.desktop	Tue Aug 24 08:29:59 2004
+++ kdelibs/mimetypes/text/html.desktop	Sat Oct 30 08:38:30 2004
@@ -1,6 +1,8 @@
 [Desktop Entry]
 Encoding=UTF-8
 Comment=HTML Document
+Comment[af]=HTML Dokument
+Comment[ar]=مستند HTML
 Comment[az]=HTML Sənədi
 Comment[be]=Дакумэнт HTML
 Comment[bg]=Уеб страница (HTML)
@@ -31,6 +33,7 @@
 Comment[ja]=HTML ドキュメント
 Comment[ko]=HTML 문서
 Comment[lt]=HTML dokumentas
+Comment[mk]=HTML документ
 Comment[mn]=HTML Баримт
 Comment[ms]=Dokumen HTML
 Comment[nb]=HTML-dokument
diff -urN -x CVS kdelibs.orig/mimetypes/text/plain.desktop kdelibs/mimetypes/text/plain.desktop
--- kdelibs.orig/mimetypes/text/plain.desktop	Tue Aug 24 08:29:59 2004
+++ kdelibs/mimetypes/text/plain.desktop	Sat Oct 30 08:38:30 2004
@@ -2,6 +2,8 @@
 Encoding=UTF-8
 MimeType=text/plain
 Comment=Plain Text Document
+Comment[af]=Eenvoudig Teks Dokument
+Comment[ar]=مستند نصي
 Comment[az]=Xam Mətn Sənədi
 Comment[bg]=Текстов файл
 Comment[bn]=প্লেইন টেক্সট নথী
@@ -30,10 +32,11 @@
 Comment[ja]=プレーン テキスト ドキュメント
 Comment[ko]=보통 글월 문서
 Comment[lt]=Paprasto teksto dokumentas
+Comment[mk]=Обичен текст
 Comment[mn]=Энгийн текст баримт
 Comment[ms]=Dokumen Teks Kosong
 Comment[nb]=Rent tekstdokument
-Comment[nds]=Einfachet Textdokment
+Comment[nds]=Eenfach Textdokment
 Comment[nl]=Platte tekst-document
 Comment[nn]=Reint tekstdokument
 Comment[pa]=ਇਕਸਾਰ ਪਾਠ ਦਸਤਾਵੇਜ਼
diff -urN -x CVS kdelibs.orig/mimetypes/text/rdf.desktop kdelibs/mimetypes/text/rdf.desktop
--- kdelibs.orig/mimetypes/text/rdf.desktop	Tue Aug 24 08:29:59 2004
+++ kdelibs/mimetypes/text/rdf.desktop	Sun Oct 24 09:02:13 2004
@@ -2,6 +2,8 @@
 Encoding=UTF-8
 MimeType=text/rdf
 Comment=Resource Description Framework File
+Comment[af]=Hulpbron Beskrywing Raamwerk Lêer
+Comment[ar]=ملف إطار عمل لوصف الموارد
 Comment[az]=Ehtiyat İzahatı Faylı
 Comment[bg]=Файл за описание на ресурси (RDF)
 Comment[bn]=রিসোর্স ডেস্‌ক্রিপশন ফ্রেমওয়ার্ক ফাইল
@@ -19,6 +21,7 @@
 Comment[fa]=پرونده‌ی قالب‌گار توضیح منابع
 Comment[fi]=Resurssin Framework-kuvaustiedosto
 Comment[fr]=Fichier de cadre de description de ressources
+Comment[ga]=Comhad "Resource Description Framework" (RDF)
 Comment[he]=קובץ מסגרת תיאור משאבים (RDF)
 Comment[hi]=रिसोर्स डिस्क्रिप्शन फ्रेमवर्क फ़ाइल
 Comment[hr]=Datoteka s opisom resursa Framework
@@ -30,6 +33,7 @@
 Comment[mn]=Нөөц Тодорхойлох Файл (RDF)
 Comment[ms]=Fail Kerangka Penghurai Sumber
 Comment[nb]=Resource Description Framework (RDF)-fil
+Comment[nds]=Ressourcen-Beschrieven-Datei
 Comment[nl]=Resource Description Framework-bestand
 Comment[nn]=Resource Description Framework-fil (RDF)
 Comment[pa]=ਸਰੋਤ ਵੇਰਵਾ ਫਰੇਮਵਰਕ ਫਾਇਲ
diff -urN -x CVS kdelibs.orig/mimetypes/text/rss.desktop kdelibs/mimetypes/text/rss.desktop
--- kdelibs.orig/mimetypes/text/rss.desktop	Tue Aug 24 08:29:59 2004
+++ kdelibs/mimetypes/text/rss.desktop	Sun Oct 24 09:02:13 2004
@@ -34,6 +34,7 @@
 Comment[ms]=Ringkasan Tapak RDF
 Comment[mt]=Sommarju tas-sit RDF
 Comment[nb]=RDF-oppsummering
+Comment[nds]=RDF-Siet-Tosamenfaten
 Comment[nl]=RDF-site samenvatting
 Comment[nn]=RDF-oppsummering
 Comment[nso]=Kakaretso ya Lefelo la RDF
diff -urN -x CVS kdelibs.orig/mimetypes/text/rtf.desktop kdelibs/mimetypes/text/rtf.desktop
--- kdelibs.orig/mimetypes/text/rtf.desktop	Tue Aug 24 08:29:59 2004
+++ kdelibs/mimetypes/text/rtf.desktop	Sat Oct 30 08:38:30 2004
@@ -2,6 +2,8 @@
 Encoding=UTF-8
 MimeType=text/rtf
 Comment=RTF Document
+Comment[af]=RTF Dokument
+Comment[ar]=مستند RTF
 Comment[az]=RTF Sənədi
 Comment[be]=Дакумэнт RTF
 Comment[bg]=Документ RTF
@@ -21,6 +23,7 @@
 Comment[fa]=سند RTF
 Comment[fi]=RTF-asiakirja
 Comment[fr]=Document RTF
+Comment[ga]=Cáipéis RTF
 Comment[gl]=Documento RTF
 Comment[he]=מסמך RTF
 Comment[hi]=RTF दस्तावेज़ 
@@ -31,6 +34,7 @@
 Comment[ja]=RTF ドキュメント
 Comment[ko]=RTF 문서
 Comment[lt]=RTF dokumentas
+Comment[mk]=RTF документ
 Comment[mn]=RTF Баримт
 Comment[ms]=Dokumen RTF
 Comment[nb]=RTF-dokument
diff -urN -x CVS kdelibs.orig/mimetypes/text/sgml.desktop kdelibs/mimetypes/text/sgml.desktop
--- kdelibs.orig/mimetypes/text/sgml.desktop	Tue Aug 24 08:29:59 2004
+++ kdelibs/mimetypes/text/sgml.desktop	Sat Oct 30 08:38:30 2004
@@ -34,6 +34,7 @@
 Comment[ja]=SGML ドキュメント
 Comment[ko]=SGML 문서
 Comment[lt]=SGML dokumentas
+Comment[mk]=SGML документ
 Comment[mn]=SGML-Баримт
 Comment[ms]=Dokumen SGML
 Comment[mt]=Dokument SGML
diff -urN -x CVS kdelibs.orig/mimetypes/text/vnd.wap.wml.desktop kdelibs/mimetypes/text/vnd.wap.wml.desktop
--- kdelibs.orig/mimetypes/text/vnd.wap.wml.desktop	Tue Aug 24 08:29:59 2004
+++ kdelibs/mimetypes/text/vnd.wap.wml.desktop	Sat Oct 30 08:38:30 2004
@@ -5,6 +5,7 @@
 MimeType=text/vnd.wap.wml
 Patterns=*.wml;*.WML;
 Comment=WML Document
+Comment[af]=WML Dokument
 Comment[ar]=مستند WML
 Comment[az]=WML Sənədi
 Comment[be]=Дакумэнт WML
@@ -36,6 +37,7 @@
 Comment[ja]=WMLドキュメント
 Comment[ko]=WML 문서
 Comment[lt]=WML dokumentas
+Comment[mk]=WML документ
 Comment[mn]=WML-Баримт
 Comment[ms]=Dokumen WML
 Comment[mt]=Dokument WML
diff -urN -x CVS kdelibs.orig/mimetypes/text/x-adasrc.desktop kdelibs/mimetypes/text/x-adasrc.desktop
--- kdelibs.orig/mimetypes/text/x-adasrc.desktop	Tue Aug 24 08:29:59 2004
+++ kdelibs/mimetypes/text/x-adasrc.desktop	Sat Oct 30 08:38:30 2004
@@ -32,6 +32,7 @@
 Comment[ja]=Ada ソースソース
 Comment[ko]=에이다(Ada) 밑그림 파일
 Comment[lt]=Ada išeities tekstų byla
+Comment[mk]=Ada изворна датотека
 Comment[mn]=Ada-эх файл
 Comment[ms]=Fail Sumber 'Ada' (nama perisian)
 Comment[mt]=Sors tal-Ada
diff -urN -x CVS kdelibs.orig/mimetypes/text/x-bibtex.desktop kdelibs/mimetypes/text/x-bibtex.desktop
--- kdelibs.orig/mimetypes/text/x-bibtex.desktop	Tue Aug 24 08:29:59 2004
+++ kdelibs/mimetypes/text/x-bibtex.desktop	Sat Oct 30 08:38:30 2004
@@ -31,11 +31,12 @@
 Comment[ja]=Bibliographic データ (Bibtex)
 Comment[ko]=서지학 자료 (Bibtex)
 Comment[lt]=Bibliografiniai duomenys (bibtex)
+Comment[mk]=Библиографски податоци (Bibtex)
 Comment[mn]=Ном зүйн өгөгдөл (bibtex)
 Comment[ms]=Data Bibliografik (Bibtex)
 Comment[mt]=Data bibljografika (bibtex)
 Comment[nb]=Bibliografiske data (bibtex)
-Comment[nds]=Biblografisch Daten (Bibtex)
+Comment[nds]=Bibliograafsche Daten (Bibtex)
 Comment[nl]=Bibliografische gegevens (bibtex)
 Comment[nn]=Bibliografiske data (Bibtex)
 Comment[nso]=Data ya Bibliography (Bibtex)
diff -urN -x CVS kdelibs.orig/mimetypes/text/x-c++hdr.desktop kdelibs/mimetypes/text/x-c++hdr.desktop
--- kdelibs.orig/mimetypes/text/x-c++hdr.desktop	Tue Aug 24 08:29:59 2004
+++ kdelibs/mimetypes/text/x-c++hdr.desktop	Sat Oct 30 08:38:30 2004
@@ -31,11 +31,12 @@
 Comment[ja]=C++ ヘッダーファイル
 Comment[ko]=C++ 머리글 파일
 Comment[lt]=C++ antraščių byla
+Comment[mk]=C++ датотека-заглавие
 Comment[mn]=C++-Толгой
 Comment[ms]=Fail Pengepala C++
 Comment[mt]=Header tas-C++
 Comment[nb]=C++-deklarasjonsfil
-Comment[nds]=C++ Headerdatei
+Comment[nds]=C++-Koppdatei
 Comment[nl]=C++-headerbestand
 Comment[nn]=C++-deklarasjonsfil
 Comment[nso]=Faele ya Hlogo ya C++
diff -urN -x CVS kdelibs.orig/mimetypes/text/x-c++src.desktop kdelibs/mimetypes/text/x-c++src.desktop
--- kdelibs.orig/mimetypes/text/x-c++src.desktop	Tue Aug 24 08:29:59 2004
+++ kdelibs/mimetypes/text/x-c++src.desktop	Sat Oct 30 08:38:30 2004
@@ -32,6 +32,7 @@
 Comment[ja]=C++ ソースファイル
 Comment[ko]=C++ 밑그림 파일
 Comment[lt]=C++ išeities tekstų byla
+Comment[mk]=C++ изворна датотека
 Comment[mn]=C++-Эх файл
 Comment[ms]=Fail Sumber C++
 Comment[mt]=Sors C++
diff -urN -x CVS kdelibs.orig/mimetypes/text/x-chdr.desktop kdelibs/mimetypes/text/x-chdr.desktop
--- kdelibs.orig/mimetypes/text/x-chdr.desktop	Tue Aug 24 08:29:59 2004
+++ kdelibs/mimetypes/text/x-chdr.desktop	Sat Oct 30 08:38:30 2004
@@ -31,11 +31,12 @@
 Comment[ja]=C ヘッダーファイル
 Comment[ko]=C 머리글 파일
 Comment[lt]=C antraščių byla
+Comment[mk]=C датотека-заглавие
 Comment[mn]=C-Толгой
 Comment[ms]=Fail Pengepala C
 Comment[mt]=header tas-C
 Comment[nb]=C-deklarasjonsfil
-Comment[nds]=C Headerdatei
+Comment[nds]=C-Koppdatei
 Comment[nl]=C-headerbestand
 Comment[nn]=C-deklarasjonsfil
 Comment[nso]=Faele ya Hlogo ya C
diff -urN -x CVS kdelibs.orig/mimetypes/text/x-csrc.desktop kdelibs/mimetypes/text/x-csrc.desktop
--- kdelibs.orig/mimetypes/text/x-csrc.desktop	Tue Aug 24 08:29:59 2004
+++ kdelibs/mimetypes/text/x-csrc.desktop	Sat Oct 30 08:38:30 2004
@@ -32,6 +32,7 @@
 Comment[ja]=C ソースファイル
 Comment[ko]=C 밑그림 파일
 Comment[lt]=C išeities tekstų byla
+Comment[mk]=C изворна датотека
 Comment[mn]=C-эх файл
 Comment[ms]=Fail Sumber C
 Comment[mt]=Sors C
diff -urN -x CVS kdelibs.orig/mimetypes/text/x-csv.desktop kdelibs/mimetypes/text/x-csv.desktop
--- kdelibs.orig/mimetypes/text/x-csv.desktop	Tue Aug 24 08:29:59 2004
+++ kdelibs/mimetypes/text/x-csv.desktop	Sat Oct 30 08:38:30 2004
@@ -36,10 +36,12 @@
 Comment[ja]=値がコンマで区切られたテキストファイル (CSV)
 Comment[ko]=쉼표로 값이 나눠져있는 글월 파일
 Comment[lt]=Teksto byla su kableliu atskirtomis reikšmėmis
+Comment[mk]=Текст датотека со вредности одвоени со запирки
 Comment[mn]=Таслалаар тусгаарлагдсан утга бүхий текст файл
 Comment[ms]=Fail Teks dengan Nila Dipisah Koma (CSV)
 Comment[mt]=Fajl ta' test bil-valuri separati b'virgola
 Comment[nb]=Tekstfil med kommaseparerte verdier
+Comment[nds]=Textdatei mit Weerten, mit Kommas optrennt
 Comment[nl]=Tekstbestand met door komma's gescheiden waarden
 Comment[nn]=Tekstfil med kommadelte verdiar
 Comment[nso]=Sengwalwana seo senago le Maboleng ao a Kgaogantswego ke Difegelwana
diff -urN -x CVS kdelibs.orig/mimetypes/text/x-diff.desktop kdelibs/mimetypes/text/x-diff.desktop
--- kdelibs.orig/mimetypes/text/x-diff.desktop	Tue Aug 24 08:29:59 2004
+++ kdelibs/mimetypes/text/x-diff.desktop	Sat Oct 30 08:38:30 2004
@@ -33,6 +33,7 @@
 Comment[ja]=2つのファイルの差分
 Comment[ko]=두 파일 차이를 기록한 파일
 Comment[lt]=Skirtumai tarp bylų
+Comment[mk]=Разлики помеѓу датотеки
 Comment[mn]=Файлуудын хоорондох ялгаа
 Comment[ms]=Beza Antara Fail
 Comment[mt]=Differenzi bejn fajls
diff -urN -x CVS kdelibs.orig/mimetypes/text/x-hex.desktop kdelibs/mimetypes/text/x-hex.desktop
--- kdelibs.orig/mimetypes/text/x-hex.desktop	Mon Sep 20 15:53:29 2004
+++ kdelibs/mimetypes/text/x-hex.desktop	Sat Oct 30 08:38:30 2004
@@ -6,9 +6,11 @@
 X-KDE-IsAlso=text/plain
 Patterns=*.HEX;*.hex;
 Comment=Intel® Hexadecimal Object File Format
+Comment[af]=Intel® Heksadesimale Voorwerp Lêer Formaat
 Comment[bg]=Шестнадесетичен обектен файлов формат на Intel®
 Comment[bn]=ইনটেল® হেক্সাডেসিমাল অবজেক্ট ফাইল ফর্ম্যাট
 Comment[ca]=Format de fitxer objecte hexadecimal Intel®
+Comment[cs]=Objektový soubor Intel® Hexadecimal
 Comment[da]=Intel® Hexadecimal objektfil-format
 Comment[de]=Dateiformat: Intel® Hexadecimal Object
 Comment[eo]=Deksessuma objektdosierformo de Intel®
@@ -20,7 +22,9 @@
 Comment[is]=Intel® Hexadecimal hlutsskráarsnið
 Comment[it]=Formato file oggetto esadecimale Intel®
 Comment[ja]=Intel® 16進数オブジェクトファイルフォーマット
+Comment[mk]=Intel® Хексадецимален формат на објектна датотека
 Comment[nb]=Intel®-heksadesimal objektfil
+Comment[nds]=Intel® Hexadezimaalobjekt-Datei
 Comment[nl]=Intel® Hexadecimaal Object-bestandsformaat
 Comment[nn]=Intel®-heksadesimal objektfil
 Comment[pa]=Intel® ਹੈਕਸਾਡੈਸੀਮਲ ਆਬਜੈਕਟ ਫਾਇਲ ਫਾਰਮਿਟ
@@ -28,10 +32,11 @@
 Comment[pt]=Formato de Ficheiros Hexadecimais de Objectos Intel®
 Comment[pt_BR]=Formato de Arquivo de Objeto Hexadecimal Intel®
 Comment[ro]=Fişier în format obiect hexazecimal Intel®
+Comment[ru]=Файл формата Intel® Hexadecimal Object
 Comment[se]=Intel®-heksadesimála objeaktafiila
 Comment[sk]=Intel® hexadecimalný objektový súbor
 Comment[sr]=Intel® хексадецимални формат објектног фајла
-Comment[sr@Latn]=Intel® хексадецимални формат објектног фајла
+Comment[sr@Latn]=Intel® heksadecimalni format objektnog fajla
 Comment[sv]=Intel® hexadecimalt objektfilformat
 Comment[ta]=Qt மெடா பொருள் கோப்பு
 Comment[tg]=Андозаи Файли Объекти Intel® Hexadecimal
diff -urN -x CVS kdelibs.orig/mimetypes/text/x-java.desktop kdelibs/mimetypes/text/x-java.desktop
--- kdelibs.orig/mimetypes/text/x-java.desktop	Tue Aug 24 08:29:59 2004
+++ kdelibs/mimetypes/text/x-java.desktop	Sat Oct 30 08:38:30 2004
@@ -32,6 +32,7 @@
 Comment[ja]=Java ソースファイル
 Comment[ko]=자바 밑그림 파일
 Comment[lt]=Java išeities tekstų byla
+Comment[mk]=Java изворна датотека
 Comment[mn]=Java-эх файл
 Comment[ms]=Fail Sumber Java
 Comment[mt]=Sors Java
diff -urN -x CVS kdelibs.orig/mimetypes/text/x-katefilelist.desktop kdelibs/mimetypes/text/x-katefilelist.desktop
--- kdelibs.orig/mimetypes/text/x-katefilelist.desktop	Tue Aug 31 09:21:47 2004
+++ kdelibs/mimetypes/text/x-katefilelist.desktop	Sun Nov 28 09:33:03 2004
@@ -19,7 +19,7 @@
 Comment[eu]= Fitxategi Zerrenda (Kate File List Loader Pluginerako)
 Comment[fa]=سیاهه‌ی پرونده (برای متصل‌کننده‌ی بارکننده‌ی سیاهه‌ی پرونده‌ی Kate)
 Comment[fi]=Tiedostolista (Kate-tiedostolistalisäosalle)
-Comment[fr]=Liste des fichiers (pour le module externe du chargeur de liste de fichiers de Kate)
+Comment[fr]=Liste de fichiers (pour le chargeur de listes de fichiers de Kate)
 Comment[gl]=Lista de Ficheiros (para o Plugin Cargador de Lista de Ficheiros de Kate)
 Comment[he]=רשימת קבצים (עבור תוסף טעינת רשימות הקבצים של Kate)
 Comment[hi]=फ़ाइल सूची(के-एटीई फ़ाइल लिस्ट लोडर प्लगिन के लिए)
@@ -29,11 +29,13 @@
 Comment[it]=Lista di file (per il plugin Caricamento lista file di Kate)
 Comment[ja]=ファイルリスト(Kate ファイルリスト読み込みプラグイン)
 Comment[ko]=(카테용 파일 목록 부름이 플러그인에서 쓰는) 파일 목록
-Comment[lt]=Bylų sąrašas (skirtas Kate bylų sąrašo pakrovėjo priedui)
+Comment[lt]=Bylų sąrašas (skirtas Kate bylų sąrašo pakrovėjo įskiepiui)
+Comment[mk]=Листа датотеки (за Kate приклучокот за вчитување на листа на датотеки)
 Comment[mn]=Файлын жигсаалт (for the Kate File List Loader Plugin)
 Comment[ms]=Senarai Fail (untuk Plug Masuk Pemuat Senarai Fail Kate)
 Comment[mt]=Lista ta' fajls għal Kate
 Comment[nb]=Filliste (Til programtillegget Kate fillistelaster)
+Comment[nds]=Dateilist (för dat Dateilisten-Laden-Plugin vun Kate)
 Comment[nl]=Bestandslijst (voor de Kate-bestandenplugin)
 Comment[nn]=Filliste (for Kate-programtillegget for fillistelasting)
 Comment[nso]=Palo ya Faele (ya Tsenyo ya Selaisi sa Palo ya Faele ya Kate)
@@ -48,7 +50,7 @@
 Comment[sl]=Seznam datotek (za vstavek seznama datotek Kate)
 Comment[sq]=Lista e Skedarëve (për Shtojcën Kate File List Loader)
 Comment[sr]=Листа фајлова (за Kate-ов прикључак за учитавање листе фајлова)
-Comment[sr@Latn]=Lista fajlova (za Kate-ov dodatak za učitavanje liste fajlova)
+Comment[sr@Latn]=Lista fajlova (za Kate-ov priključak za učitavanje liste fajlova)
 Comment[sv]=Fillista för (insticksprogram för Kates fillistladdare)
 Comment[ta]=கோப்புப் பட்டியல் (கேட் கோப்புப் பட்டியல் ஏற்றச் செருகுப்பொருளுக்கு)
 Comment[tg]=Рӯйхати Файл ( барои Файли Kate Модули Пурборкуни)
diff -urN -x CVS kdelibs.orig/mimetypes/text/x-latex.desktop kdelibs/mimetypes/text/x-latex.desktop
--- kdelibs.orig/mimetypes/text/x-latex.desktop	Tue Aug 24 08:29:59 2004
+++ kdelibs/mimetypes/text/x-latex.desktop	Sat Oct 30 08:38:30 2004
@@ -1,6 +1,8 @@
 [Desktop Entry]
 Encoding=UTF-8
 Comment=LaTeX Document
+Comment[af]=LaTeX Dokument
+Comment[ar]=مستند LaTeX
 Comment[az]=LaTeX Sənədi
 Comment[be]=Дакумэнт LaTeX
 Comment[bg]=Документ на LaTeX
@@ -20,6 +22,7 @@
 Comment[fa]=سند LaTex
 Comment[fi]=LaTeX-asiakirja
 Comment[fr]=Document LaTeX
+Comment[ga]=Cáipéis LaTeX
 Comment[gl]=Documento LaTeX
 Comment[he]=מסמך LaTeX
 Comment[hi]=LaTeX दस्तावेज़
@@ -30,6 +33,7 @@
 Comment[ja]=LaTeX ドキュメント
 Comment[ko]=레이텍 문서
 Comment[lt]=LaTeX dokumentas
+Comment[mk]=LaTeX документ
 Comment[mn]=LaTeX Баримт
 Comment[nb]=LaTeX-dokument
 Comment[nds]=LaTeX-Dokment
diff -urN -x CVS kdelibs.orig/mimetypes/text/x-ldif.desktop kdelibs/mimetypes/text/x-ldif.desktop
--- kdelibs.orig/mimetypes/text/x-ldif.desktop	Tue Aug 24 08:29:59 2004
+++ kdelibs/mimetypes/text/x-ldif.desktop	Sat Oct 30 08:38:30 2004
@@ -1,10 +1,13 @@
 [Desktop Entry]
 Encoding=UTF-8
 Comment=LDAP Addressbook
+Comment[af]=LDAP Adresboek
+Comment[ar]=دفتر عناوين LDAP
 Comment[az]=LDAP Ünvan Kitabçası
 Comment[be]=Адрасная кніга LDAP
 Comment[bg]=Адресник LDAP
 Comment[bn]=এল-ডি-এ-পি (LDAP) অ্যাড্রেসবুক
+Comment[br]=Karned chomlec'hioù LDAP
 Comment[bs]=LDAP adresar
 Comment[ca]=Llibreta d'adreces LDAP
 Comment[cs]=LDAP adresář
@@ -29,9 +32,11 @@
 Comment[ja]=LDAP ドキュメント
 Comment[ko]=LDAP 주소록
 Comment[lt]=LDAP adresų knyga
+Comment[mk]=LDAP адресар
 Comment[mn]=LDAP хаягийн дэвтэр
 Comment[ms]=Buku Alamat LDAP
 Comment[nb]=LDAP adressebok
+Comment[nds]=LDAP-Adressbook
 Comment[nl]=LDAP-adresboek
 Comment[nn]=LDAP-adressebok
 Comment[pa]=LDAP ਸਿਰਨਾਵਾਂ ਕਿਤਾਬ
diff -urN -x CVS kdelibs.orig/mimetypes/text/x-log.desktop kdelibs/mimetypes/text/x-log.desktop
--- kdelibs.orig/mimetypes/text/x-log.desktop	Tue Aug 24 08:29:59 2004
+++ kdelibs/mimetypes/text/x-log.desktop	Sat Oct 30 08:38:30 2004
@@ -31,6 +31,7 @@
 Comment[ja]=アプリケーションログファイル
 Comment[ko]=응용 프로그램 기록 파일
 Comment[lt]=Programų žurnalo byla
+Comment[mk]=Апликациски дневник
 Comment[mn]=Программын Log файл
 Comment[ms]=Fail Log Aplikasi
 Comment[mt]=Log ta' programm
diff -urN -x CVS kdelibs.orig/mimetypes/text/x-makefile.desktop kdelibs/mimetypes/text/x-makefile.desktop
--- kdelibs.orig/mimetypes/text/x-makefile.desktop	Tue Aug 24 08:29:59 2004
+++ kdelibs/mimetypes/text/x-makefile.desktop	Sat Oct 30 08:38:30 2004
@@ -17,7 +17,6 @@
 Comment[hu]=Makefájl
 Comment[is]=Make-skrá
 Comment[ko]=Make 파일
-Comment[mk]=Makefile датотека
 Comment[nn]=Make-fil
 Comment[nso]=Faele ya Tiro
 Comment[ro]=Fişier Makefile
diff -urN -x CVS kdelibs.orig/mimetypes/text/x-moc.desktop kdelibs/mimetypes/text/x-moc.desktop
--- kdelibs.orig/mimetypes/text/x-moc.desktop	Tue Aug 24 08:29:59 2004
+++ kdelibs/mimetypes/text/x-moc.desktop	Sat Oct 30 08:38:30 2004
@@ -32,12 +32,12 @@
 Comment[ko]=Qt 메타 오브젝트 파일
 Comment[lt]=Qt Meta objektinė byla
 Comment[lv]=Qt Meta Objektu Fails
-Comment[mk]=Qt MOC датотека
+Comment[mk]=Qt мета објектна датотека
 Comment[mn]=Qt-Meta-Объект Файл
 Comment[ms]=Fail Objek Meta Qt
 Comment[mt]=Fajl Qt Meta Object
 Comment[nb]=Qt-metaobjektfil
-Comment[nds]=Qt Meta Object-Datei
+Comment[nds]=Qt Meta-Objekt-Datei
 Comment[nl]=Qt-Meta-Object-bestand
 Comment[nn]=Qt-metaobjektfil
 Comment[nso]=Faele ya Sediriswa sa Meta wa Qt
diff -urN -x CVS kdelibs.orig/mimetypes/text/x-mswinurl.desktop kdelibs/mimetypes/text/x-mswinurl.desktop
--- kdelibs.orig/mimetypes/text/x-mswinurl.desktop	Mon Sep  6 15:47:49 2004
+++ kdelibs/mimetypes/text/x-mswinurl.desktop	Sat Oct 30 08:38:30 2004
@@ -35,6 +35,7 @@
 Comment[ja]=インターネットショートカット
 Comment[ko]=인터넷 바로가기
 Comment[lt]=Interneto nuoroda
+Comment[mk]=Интернет кратенка
 Comment[mn]=Интэрнет-Богино тушаал
 Comment[ms]=Pintasan Internet
 Comment[mt]=Taqsira tal-internet
diff -urN -x CVS kdelibs.orig/mimetypes/text/x-objcsrc.desktop kdelibs/mimetypes/text/x-objcsrc.desktop
--- kdelibs.orig/mimetypes/text/x-objcsrc.desktop	Tue Aug 31 09:21:47 2004
+++ kdelibs/mimetypes/text/x-objcsrc.desktop	Sat Oct 30 08:38:30 2004
@@ -33,6 +33,7 @@
 Comment[ja]=Objective-C ソースファイル
 Comment[ko]=오브젝티브-C 밑그림 파일
 Comment[lt]=Objective-C išeities tekstų byla
+Comment[mk]=Objective-C изворна датотека
 Comment[mn]=Objective-C-Эх файл
 Comment[ms]=Fail Sumber C Objektif
 Comment[mt]=Sors Objective-C
diff -urN -x CVS kdelibs.orig/mimetypes/text/x-pascal.desktop kdelibs/mimetypes/text/x-pascal.desktop
--- kdelibs.orig/mimetypes/text/x-pascal.desktop	Tue Aug 24 08:29:59 2004
+++ kdelibs/mimetypes/text/x-pascal.desktop	Sat Oct 30 08:38:30 2004
@@ -32,6 +32,7 @@
 Comment[ja]=Pascal ソースファイル
 Comment[ko]=파스칼 밑그림 파일
 Comment[lt]=Pascal išeities tekstų byla
+Comment[mk]=Pascal изворна датотека
 Comment[mn]=Pascal-Эх файл
 Comment[ms]=Fail Sumber Pascal
 Comment[mt]=Sors Pascal
diff -urN -x CVS kdelibs.orig/mimetypes/text/x-tcl.desktop kdelibs/mimetypes/text/x-tcl.desktop
--- kdelibs.orig/mimetypes/text/x-tcl.desktop	Tue Aug 24 08:29:59 2004
+++ kdelibs/mimetypes/text/x-tcl.desktop	Sat Oct 30 08:38:30 2004
@@ -33,6 +33,7 @@
 Comment[ja]=Tcl ファイル
 Comment[ko]=티클 파일
 Comment[lt]=Tcl byla
+Comment[mk]=Tcl датотека
 Comment[mn]=TcL-Файл
 Comment[ms]=Fail Tcl
 Comment[mt]=Fajl Tcl
diff -urN -x CVS kdelibs.orig/mimetypes/text/x-tex.desktop kdelibs/mimetypes/text/x-tex.desktop
--- kdelibs.orig/mimetypes/text/x-tex.desktop	Tue Aug 24 08:29:59 2004
+++ kdelibs/mimetypes/text/x-tex.desktop	Sat Oct 30 08:38:30 2004
@@ -33,6 +33,7 @@
 Comment[ja]=TeX ファイル
 Comment[ko]=텍 파일
 Comment[lt]=TeX byla
+Comment[mk]=TeX датотека
 Comment[mn]=TeX-Баримт
 Comment[ms]=Fail TeX
 Comment[mt]=Fajl TeX
diff -urN -x CVS kdelibs.orig/mimetypes/text/x-vcalendar.desktop kdelibs/mimetypes/text/x-vcalendar.desktop
--- kdelibs.orig/mimetypes/text/x-vcalendar.desktop	Tue Aug 24 08:29:59 2004
+++ kdelibs/mimetypes/text/x-vcalendar.desktop	Sat Oct 30 08:38:30 2004
@@ -29,10 +29,12 @@
 Comment[it]=File di interscambio vCalendar
 Comment[ja]=vCalendar 交換ファイル
 Comment[lt]=vCalendar apsikeitimų byla
+Comment[mk]=vCalendar Interchange датотека
 Comment[mn]=vCalendar-Солилцооны файл
 Comment[ms]=Fail Tukar Ganti vCalendar
 Comment[mt]=Fajl ta' skambju vCalendar
 Comment[nb]=vCalendar-utvekslingsfil
+Comment[nds]=vCalendar-Kommunikatschoon-Datei
 Comment[nl]=vCalendar Interchange-bestand
 Comment[nn]=vCalendar-delingsfil
 Comment[nso]=Faele yago Fetosafetosa vAlemanaka
diff -urN -x CVS kdelibs.orig/mimetypes/text/x-vcard.desktop kdelibs/mimetypes/text/x-vcard.desktop
--- kdelibs.orig/mimetypes/text/x-vcard.desktop	Tue Aug 24 08:29:59 2004
+++ kdelibs/mimetypes/text/x-vcard.desktop	Sat Oct 30 08:38:30 2004
@@ -35,11 +35,12 @@
 Comment[lt]=Elektroninė biznio kortelė
 Comment[lv]=Elektroniska vizītkarte
 Comment[mi]=Papa Mahi Hiko
-Comment[mk]=Електронски бизнис картички
+Comment[mk]=Електронска бизнис картичка
 Comment[mn]=Электрон нэрийн хуудас
 Comment[ms]=Kad Elektronik Perniagaan
 Comment[mt]=Business Card Elettronika
 Comment[nb]=Elektronisk visittkort
+Comment[nds]=Elektroonsch Visitenkoort
 Comment[nl]=Elektronische visitekaart
 Comment[nn]=Elektronisk visittkort
 Comment[nso]=Karata ya Setegeniki ya Kgwebo
diff -urN -x CVS kdelibs.orig/mimetypes/text/x-xslfo.desktop kdelibs/mimetypes/text/x-xslfo.desktop
--- kdelibs.orig/mimetypes/text/x-xslfo.desktop	Tue Aug 24 08:29:59 2004
+++ kdelibs/mimetypes/text/x-xslfo.desktop	Sat Oct 30 08:38:30 2004
@@ -28,10 +28,12 @@
 Comment[ja]=XSL フォーマットオブジェクトファイル
 Comment[ko]=XSL 형식 오프젝트 파일
 Comment[lt]=XSL Formating Object byla
+Comment[mk]=Објектна датотека со XSL формат
 Comment[mn]=XSL-Форматтай объект файл
 Comment[ms]=Fail Pengformat Objek XSL
 Comment[mt]=Fajl tal-ifformattjar XSL
 Comment[nb]=XSL-formatert objektfil
+Comment[nds]=XSL-Formaatobjekt-Datei
 Comment[nl]=XSL Formatting Object-bestand
 Comment[nn]=XSL-formatobjektfil
 Comment[nso]=Faele ya Sediriswa sa Thlolo ya XSL
diff -urN -x CVS kdelibs.orig/mimetypes/text/x-xslt.desktop kdelibs/mimetypes/text/x-xslt.desktop
--- kdelibs.orig/mimetypes/text/x-xslt.desktop	Tue Aug 24 08:29:59 2004
+++ kdelibs/mimetypes/text/x-xslt.desktop	Mon Nov 22 09:34:05 2004
@@ -6,6 +6,7 @@
 Comment[be]=Файл табліцы стыляў XSLT
 Comment[bg]=Файл със стилове (XSLT)
 Comment[bn]=XSLT স্টাইলশিট ফাইল
+Comment[br]=Restr ar folenn c'hiz XSLT
 Comment[bs]=XSLT Stylesheet datoteka
 Comment[ca]=Fitxer fulla de càlcul a l'estil XSLT
 Comment[cs]=Soubor se stylem XSLT
@@ -29,11 +30,12 @@
 Comment[ja]=XSLT スタイルシートファイル
 Comment[ko]=XSLT 스타일시트 파일
 Comment[lt]=XSLT stiliaus aprašymo byla
+Comment[mk]=XSLT Stylesheet датотека
 Comment[mn]=XSLT-Stylesheet Файл
 Comment[ms]=Fail Gaya Lata XSLT
 Comment[mt]=Stylesheet XSLT
 Comment[nb]=XSLT-stilarkfil
-Comment[nds]=XSLT Stylesheet-Datei
+Comment[nds]=XSLT-Stilvörlaag-Datei
 Comment[nl]=XSLT-stijlbladbestand
 Comment[nn]=XSLT-stilsettfil
 Comment[nso]=Faele ya Letlakala la Mokgwa wa XSLT
diff -urN -x CVS kdelibs.orig/mimetypes/text/xml.desktop kdelibs/mimetypes/text/xml.desktop
--- kdelibs.orig/mimetypes/text/xml.desktop	Tue Aug 31 09:21:47 2004
+++ kdelibs/mimetypes/text/xml.desktop	Sat Oct 30 08:38:30 2004
@@ -1,6 +1,8 @@
 [Desktop Entry]
 Encoding=UTF-8
 Comment=XML Document
+Comment[af]=XML Dokument
+Comment[ar]=مستند XML
 Comment[az]=XML Sənədi
 Comment[be]=Дакумэнт XML
 Comment[bg]=Документ XML
@@ -20,6 +22,7 @@
 Comment[fa]=سند XML
 Comment[fi]=XML-asiakirja
 Comment[fr]=Document XML
+Comment[ga]=Cáipéis XML
 Comment[gl]=Documento XML
 Comment[he]=מסמך XML
 Comment[hi]=एक्सएमएल दस्तावेज़ 
@@ -30,6 +33,7 @@
 Comment[ja]=XML ドキュメント
 Comment[ko]=XML 문서
 Comment[lt]=XML dokumentas
+Comment[mk]=XML документ
 Comment[mn]=XML Баримт
 Comment[ms]=Dokumen XML
 Comment[nb]=XML-dokument
diff -urN -x CVS kdelibs.orig/mimetypes/video/avi.desktop kdelibs/mimetypes/video/avi.desktop
--- kdelibs.orig/mimetypes/video/avi.desktop	Tue Aug 24 08:30:00 2004
+++ kdelibs/mimetypes/video/avi.desktop	Sun Oct 24 09:02:14 2004
@@ -42,6 +42,7 @@
 Comment[ms]=Video Microsoft AVI
 Comment[mt]=Video Microsoft AVI
 Comment[nb]=Microsoft AVI-film
+Comment[nds]=Microsoft AVI-Video
 Comment[nl]=Microsoft AVI-video
 Comment[nn]=Microsoft AVI-video
 Comment[nso]=Video ya AVI ya Microsoft
diff -urN -x CVS kdelibs.orig/mimetypes/video/mp4.desktop kdelibs/mimetypes/video/mp4.desktop
--- kdelibs.orig/mimetypes/video/mp4.desktop	Tue Aug 24 08:30:00 2004
+++ kdelibs/mimetypes/video/mp4.desktop	Sat Oct 30 08:38:32 2004
@@ -5,6 +5,7 @@
 Icon=video
 Patterns=*.mp4;*.MP4;*.m4v;*.M4V;
 Comment=MPEG-4 Video
+Comment[ar]=ملف فيديو MPEG-4
 Comment[be]=MPEG-4 відэа
 Comment[bg]=Видео файл MPEG-4
 Comment[bn]=এমপেগ-৪ ভিডিও
@@ -23,6 +24,7 @@
 Comment[fa]=تصویری MPEG-4
 Comment[fi]=MPEG-4 -video
 Comment[fr]=Vidéo MPEG-4
+Comment[ga]=Físeán MPEG-4
 Comment[gl]=Vídeo MPEG-4
 Comment[he]=סרט MPEG-4
 Comment[hi]=MPEG-4 वीडियो
@@ -32,6 +34,7 @@
 Comment[it]=Video MPEG-4
 Comment[ja]=MPEG-4 ビデオ
 Comment[ko]=MPEG-4 비디오
+Comment[mk]=MPEG-4 видео
 Comment[mn]=MPEG-4 Видео
 Comment[nb]=MPEG-4 video
 Comment[nl]=MPEG-4 video
diff -urN -x CVS kdelibs.orig/mimetypes/video/vnd.rn-realvideo.desktop kdelibs/mimetypes/video/vnd.rn-realvideo.desktop
--- kdelibs.orig/mimetypes/video/vnd.rn-realvideo.desktop	Tue Aug 24 08:30:00 2004
+++ kdelibs/mimetypes/video/vnd.rn-realvideo.desktop	Mon Nov 15 08:54:59 2004
@@ -5,6 +5,8 @@
 Icon=video
 Patterns=*.rv;*.RV;
 Comment=RealVideo File
+Comment[af]=RealVideo Lêer
+Comment[ar]=ملف RealVideo
 Comment[az]=RealVideo Faylı
 Comment[be]=Файл RealAudio
 Comment[bg]=Видео файл RealVideo
@@ -24,6 +26,7 @@
 Comment[fa]=پرونده‌ی RealVideo
 Comment[fi]=RealVideo-tiedosto
 Comment[fr]=Fichier RealVideo
+Comment[ga]=Comhad RealVideo
 Comment[gl]=Ficheiro RealVideo
 Comment[he]=קובץ RealVideo
 Comment[hi]=रीयलवीडियो फ़ाइल
@@ -31,9 +34,10 @@
 Comment[hu]=RealVideo-fájl
 Comment[is]=RealVideo skrá
 Comment[it]=File RealVideo
-Comment[ja]=リアルビデオ ファイル
+Comment[ja]=RealVideo ファイル
 Comment[ko]=리얼비디오 파일
 Comment[lt]=RealVideo byla
+Comment[mk]=RealVideo датотека
 Comment[mn]=RealVideo файл
 Comment[nb]=RealVideo-fil
 Comment[nds]=RealVideo-Datei
diff -urN -x CVS kdelibs.orig/mimetypes/video/x-flic.desktop kdelibs/mimetypes/video/x-flic.desktop
--- kdelibs.orig/mimetypes/video/x-flic.desktop	Tue Aug 24 08:30:00 2004
+++ kdelibs/mimetypes/video/x-flic.desktop	Sat Oct 30 08:38:32 2004
@@ -5,6 +5,7 @@
 Icon=video
 Patterns=*.fli;*.flc;*.FLI;*.FLC;
 Comment=Autodesk's FLIC File
+Comment[af]=Autodesk se FLIC Lêer
 Comment[ar]=ملف FLIC لأوتوديسك
 Comment[az]=Autodesk FLIC Faylı
 Comment[be]=Autodesk FLIC файл
@@ -36,11 +37,12 @@
 Comment[ja]=Autodesk's FLIC ファイル
 Comment[ko]=오토데스크에서 만든 FLIC 파일
 Comment[lt]=Autodesk FLIC byla
+Comment[mk]=Autodesk's FLIC датотека
 Comment[mn]=FLIC-Файл (Autodesk)
 Comment[ms]=Fail FLIC Autodesk
 Comment[mt]=Fajl FLIC ta' Autodesk
 Comment[nb]=Autodesks FLIC-filer
-Comment[nds]=Autodesk's FLIC-Datei
+Comment[nds]=Autodesks FLIC-Datei
 Comment[nl]=Autodesk's FLIC-bestand
 Comment[nn]=FLIC-filer frå Autodesk
 Comment[nso]=Faele ya FLIC ya Autodesk
diff -urN -x CVS kdelibs.orig/mimetypes/video/x-matroska.desktop kdelibs/mimetypes/video/x-matroska.desktop
--- kdelibs.orig/mimetypes/video/x-matroska.desktop	Tue Aug 24 08:30:00 2004
+++ kdelibs/mimetypes/video/x-matroska.desktop	Sat Oct 30 08:38:32 2004
@@ -5,6 +5,7 @@
 Icon=video
 Patterns=*.mkv;*.MKV;
 Comment=Matroska Video
+Comment[ar]=ملف فيديو ماتروسكا
 Comment[be]=Матрошка відэа
 Comment[bg]=Видео файл Matroska
 Comment[bn]=মাত্রোস্কা ভিডিও
@@ -22,6 +23,7 @@
 Comment[fa]=تصویری Matroska
 Comment[fi]=Matroska-video
 Comment[fr]=Vidéo Matroska
+Comment[ga]=Físeán Matroska
 Comment[gl]=Vídeo Matroska
 Comment[he]=סרט Matroska
 Comment[hi]=मात्रोस्का वीडियो
@@ -30,8 +32,10 @@
 Comment[is]=Matroska kvikmynd
 Comment[it]=Video Matroska
 Comment[ja]=Matroska ビデオ
+Comment[mk]=Matroska видео
 Comment[mn]=Matroska Видео
 Comment[nb]=Matroska video
+Comment[nds]=Matroska-Video
 Comment[nl]=Matroska-video
 Comment[nn]=Matroska-video
 Comment[pa]=Matroska ਵੀਡਿਓ
diff -urN -x CVS kdelibs.orig/mimetypes/video/x-mng.desktop kdelibs/mimetypes/video/x-mng.desktop
--- kdelibs.orig/mimetypes/video/x-mng.desktop	Tue Aug 24 08:30:00 2004
+++ kdelibs/mimetypes/video/x-mng.desktop	Sat Oct 30 08:38:32 2004
@@ -37,6 +37,7 @@
 Comment[ja]=MNG イメージ
 Comment[ko]=MNG 그림 (움직이는 PNG)
 Comment[lt]=MNG paveiksliukas
+Comment[mk]=MNG слика
 Comment[mn]=MNG-Зураг
 Comment[ms]=Imej MNG
 Comment[mt]=Stampa MNG
diff -urN -x CVS kdelibs.orig/mimetypes/video/x-ms-asf.desktop kdelibs/mimetypes/video/x-ms-asf.desktop
--- kdelibs.orig/mimetypes/video/x-ms-asf.desktop	Tue Aug 24 08:30:00 2004
+++ kdelibs/mimetypes/video/x-ms-asf.desktop	Tue Nov  9 08:35:30 2004
@@ -10,6 +10,7 @@
 Comment[az]=ASF Mediyası
 Comment[bg]=Медия ASF
 Comment[bn]=এ-এস-এফ মিডিয়া
+Comment[br]=Media ASF
 Comment[bs]=ASF medija
 Comment[ca]=Medi ASF
 Comment[cs]=ASF média
@@ -31,9 +32,11 @@
 Comment[it]=File multimediale ASF
 Comment[ja]=ASF メディア
 Comment[ko]=ASF 파일
+Comment[mk]=ASF медиум
 Comment[mn]=ASF Медиа
 Comment[ms]=Media ASF
 Comment[mt]=Media ASF
+Comment[nds]=ASF-Medien
 Comment[nl]=ASF-media
 Comment[nn]=ASF-media
 Comment[nso]=Media wa ASF
@@ -52,6 +55,7 @@
 Comment[ss]=Tindzaba te ASF 
 Comment[sv]=ASF-media
 Comment[ta]=ASF ஊடகம்
+Comment[tg]=Медияи ASF 
 Comment[th]=แฟ้มสื่อ ASF
 Comment[tr]=ASF dosyası
 Comment[uk]=Носій ASF
diff -urN -x CVS kdelibs.orig/mimetypes/video/x-ms-wmv.desktop kdelibs/mimetypes/video/x-ms-wmv.desktop
--- kdelibs.orig/mimetypes/video/x-ms-wmv.desktop	Tue Aug 31 09:21:47 2004
+++ kdelibs/mimetypes/video/x-ms-wmv.desktop	Sat Oct 30 08:38:32 2004
@@ -1,6 +1,8 @@
 [Desktop Entry]
 Encoding=UTF-8
 Comment=Windows Media Video
+Comment[af]=Windows Media Lêer
+Comment[ar]=ملف فيديو Windows Media
 Comment[az]=Windows Mediya Video Faylı
 Comment[be]=Windows Media відэа
 Comment[bg]=Видео файл Windows Media
@@ -20,6 +22,7 @@
 Comment[fa]=ویدیوی ویندوز مدیا
 Comment[fi]=Windows mediatiedosto
 Comment[fr]=Vidéo Windows Media
+Comment[ga]=Físeán "Windows Media"
 Comment[gl]=Video de Windows Media
 Comment[he]=קובץ ווידאו של Windows
 Comment[hi]=विंडोज़ मीडिया वीडियो
@@ -29,9 +32,11 @@
 Comment[it]=Video Windows Media
 Comment[ja]=Windows Media ファイル
 Comment[ko]=윈도우즈 미디어 비디오
+Comment[mk]=Windows Media видео
 Comment[mn]=Виндовс Медиа Видео
 Comment[ms]=Video Windows Media
 Comment[nb]=Windows Media video
+Comment[nds]=Windows Media-Video
 Comment[nl]=Windows Media-video
 Comment[nn]=Windows Media-video
 Comment[pa]=ਵਿੰਡੋ ਮੀਡਿਆ ਵੀਡਿਓ
diff -urN -x CVS kdelibs.orig/mimetypes/video/x-msvideo.desktop kdelibs/mimetypes/video/x-msvideo.desktop
--- kdelibs.orig/mimetypes/video/x-msvideo.desktop	Tue Aug 24 08:30:01 2004
+++ kdelibs/mimetypes/video/x-msvideo.desktop	Sun Oct 24 09:02:14 2004
@@ -41,6 +41,7 @@
 Comment[ms]=Video Microsoft AVI
 Comment[mt]=Video Microsoft AVI
 Comment[nb]=Microsoft AVI-film
+Comment[nds]=Microsoft AVI-Video
 Comment[nl]=Microsoft AVI-video
 Comment[nn]=Microsoft AVI-video
 Comment[nso]=Video ya AVI ya Microsoft
diff -urN -x CVS kdelibs.orig/mimetypes/video/x-ogm.desktop kdelibs/mimetypes/video/x-ogm.desktop
--- kdelibs.orig/mimetypes/video/x-ogm.desktop	Tue Aug 24 08:30:01 2004
+++ kdelibs/mimetypes/video/x-ogm.desktop	Sat Oct 30 08:38:32 2004
@@ -6,6 +6,7 @@
 Patterns=*.ogm;*.OGM;
 X-KDE-IsAlso=application/ogg
 Comment=Ogg/Ogm Video
+Comment[ar]=ملف فيديو Ogg/Ogm
 Comment[be]=Ogg/Ogm відэа
 Comment[bg]=Видео файл Ogg/Ogm
 Comment[bn]=অগ/ও-জি-এম ভিডিও
@@ -23,6 +24,7 @@
 Comment[fa]=تصویری Ogg/Ogm
 Comment[fi]=Ogg/Ogm-video
 Comment[fr]=Vidéo Ogg / Ogm
+Comment[ga]=Físeán Ogg/Ogm
 Comment[gl]=Vídeo Ogg/Ogm
 Comment[he]=סרט Ogg/Ogm
 Comment[hi]=Ogg/Ogm वीडियो
@@ -32,8 +34,10 @@
 Comment[it]=Video Ogg/Ogm
 Comment[ja]=Ogg/Ogm ビデオ
 Comment[ko]=Ogg/Ogm 비디오
+Comment[mk]=Ogg/Ogm видео
 Comment[mn]=Ogg/Ogm Видео
 Comment[nb]=Ogg/Ogm video
+Comment[nds]=Ogg/Ogm-Video
 Comment[nl]=Ogg/Ogm-video
 Comment[nn]=Ogg/Ogm-video
 Comment[pa]=Ogg/Ogm ਵੀਡਿਓ
diff -urN -x CVS kdelibs.orig/mimetypes/video/x-theora.desktop kdelibs/mimetypes/video/x-theora.desktop
--- kdelibs.orig/mimetypes/video/x-theora.desktop	Tue Aug 24 08:30:01 2004
+++ kdelibs/mimetypes/video/x-theora.desktop	Sat Oct 30 08:38:32 2004
@@ -5,6 +5,7 @@
 Icon=video
 X-KDE-IsAlso=application/ogg
 Comment=Theora Video
+Comment[ar]=ملف فيديو Theora
 Comment[be]=Theora відэа
 Comment[bg]=Видео файл Theora
 Comment[bn]=থিওরা ভিডিও
@@ -22,6 +23,7 @@
 Comment[fa]=تصویری Theora
 Comment[fi]=Theora-video
 Comment[fr]=Vidéo Theora
+Comment[ga]=Físeán Theora
 Comment[gl]=Vídeo Theroa
 Comment[he]=סרט Theora
 Comment[hi]=थिओरा वीडियो
@@ -30,8 +32,10 @@
 Comment[is]=Theora kvikmynd
 Comment[it]=Video Theora
 Comment[ja]=Theora ビデオ
+Comment[mk]=Theora видео
 Comment[mn]=Theora Видео
 Comment[nb]=Theora video
+Comment[nds]=Theora-Video
 Comment[nl]=Theora-video
 Comment[nn]=Theora-video
 Comment[pa]=Theora ਵੀਡਿਓ
diff -urN -x CVS kdelibs.orig/pics/crystalsvg/index.theme kdelibs/pics/crystalsvg/index.theme
--- kdelibs.orig/pics/crystalsvg/index.theme	Sun Sep 12 15:56:20 2004
+++ kdelibs/pics/crystalsvg/index.theme	Fri Nov 12 08:27:55 2004
@@ -16,6 +16,7 @@
 Name[th]=คริสตัล SVG รุ่นเบต้า 1
 Name[uz]=Кристал SVG бета1
 Comment=Icon Theme by Everaldo.com Design Studio
+Comment[af]=Ikoon Tema deur Everaldo.com Design Studio
 Comment[be]=Тэма піктаграмаў ад студыі дызайну Everaldo.com
 Comment[bg]=Тема с икони от Евералдо (www.everaldo.com)
 Comment[bn]=এভারাল্ডোর (www.everaldo.com) তৈরি আইকন থিম
@@ -37,7 +38,10 @@
 Comment[it]=Tema icone dello studio di design Everaldo.com
 Comment[ja]=アイコンテーマ by Everaldo.com Design Studio
 Comment[ko]=Everaldo.com 디자인 스튜디오가 만든 아이콘 테마
+Comment[lt]=Everaldo.com Design Studio ženkliukų tema
+Comment[mk]=Тема на икони од студиото за дизајн на Everaldo.com
 Comment[nb]=Ikontema av Everaldo.com Design Studio
+Comment[nds]=Lüttbildmuster vun de Everaldo.com-Design-Makers
 Comment[nl]=Pictogramthema van ontwerpbureau Everaldo.com 
 Comment[nn]=Ikontema av Everaldo.com Design Studio
 Comment[pa]=Everaldo.com ਡਿਜ਼ਾਇਨ ਸਟੂਡਿਊ ਦਾ ਆਈਕਾਨ ਸਰੂਪ
@@ -45,11 +49,12 @@
 Comment[pt]=Tema de Ícones por Everaldo.com Design Studio
 Comment[pt_BR]=Tema de Ícones por Everaldo (ww
 Comment[ro]=Tematică de iconiţe de Everaldo.com Design Studio
+Comment[ru]=Пиктограммы от Everaldo (everaldo@everaldo.com)
 Comment[se]=Govašfáddá maid Everaldo.com Design Studio lea ráhkadan
 Comment[sk]=Téma ikon od Everaldo.com Design Studio
 Comment[sl]=Ikonska tema od oblikovalskega sutida Everaldo.com
 Comment[sr]=Тема икона Everaldo.com дизајнерског студија
-Comment[sr@Latn]=Тема икона Everaldo.com дизајнерског студија
+Comment[sr@Latn]=Tema ikona Everaldo.com dizajnerskog studija
 Comment[sv]=Ikontema av Everaldo.com designstudio
 Comment[ta]=எவரால்டோ.காம் வடிவமைப்பு படப்பிடிப்பகத்தின் சின்னம்
 Comment[tg]=Мавзӯъҳои нишонаҳо аз Эвералдо мебошад (www.everaldo.com)
diff -urN -x CVS kdelibs.orig/pics/hicolor/index.theme kdelibs/pics/hicolor/index.theme
--- kdelibs.orig/pics/hicolor/index.theme	Tue Aug 31 09:21:50 2004
+++ kdelibs/pics/hicolor/index.theme	Sat Oct 30 08:38:32 2004
@@ -19,7 +19,6 @@
 Name[ko]=KDE-많은 색
 Name[lt]=KDE daug spalvų
 Name[mi]=TaeTeitei-KDE
-Name[mk]=KDE - многу бои
 Name[mn]=KDE-64000-Өнгө
 Name[mt]=KDE-Ħafna Kuluri
 Name[nb]=KDE Mange farger
@@ -52,6 +51,7 @@
 Comment[az]=Çox Rəngli Timsal Örtüyü
 Comment[bg]=Тема с икони с висококачествени цветове (24, 32 бита)
 Comment[bn]=হাইকালার আইকন থিম
+Comment[br]=Gwiskadoù Arlun
 Comment[bs]=Tema s ikonama sa mnogo boja
 Comment[ca]=Tema d'icones Highcolor
 Comment[cs]=Motiv ikon s mnoha barvami
@@ -79,7 +79,7 @@
 Comment[ko]=많은 색으로 그린 아이콘 모음
 Comment[lt]=Aukštos spalvų gebos ženkliukų tema
 Comment[lv]=Daudzkrāsu Ikonu Tēma
-Comment[mk]=Разнобојна тема на икони
+Comment[mk]=Високобојна тема на икони
 Comment[mn]=64000-Өнгөтэй-Загвар
 Comment[mt]=Tema ta' ikoni b'ħafna kuluri
 Comment[nb]=Ikontema med mange farger
