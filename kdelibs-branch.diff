Index: interfaces/kscript/sample/shellscript.desktop
===================================================================
--- interfaces/kscript/sample/shellscript.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ interfaces/kscript/sample/shellscript.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -62,6 +62,7 @@
 Name[vi]=Bộ chạy tập lệnh hệ vỏ Bash
 Name[wa]=Enondeu di scripes shell bash
 Name[zh_CN]=Bash Shell 脚本运行程序
+Name[zh_TW]=Bash Shell Script 執行器
 Type=Service
 X-KDE-Library=libshellscript
 X-KDE-Script-Runner=ShellScript/bash
Index: interfaces/kimproxy/interface/dcopinstantmessenger.desktop
===================================================================
--- interfaces/kimproxy/interface/dcopinstantmessenger.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ interfaces/kimproxy/interface/dcopinstantmessenger.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -60,3 +60,4 @@
 Comment[vi]=Bộ tin nhắn tức khắc có giao diện DCOP
 Comment[zh_CN]=带 DCOP 接口的即时通讯程序
 Comment[zh_HK]=附有 DCOP 介面的即時通訊軟件
+Comment[zh_TW]=DCOP 介面的即時通訊系統
Index: interfaces/kimproxy/interface/kcm_instantmessenger.desktop
===================================================================
--- interfaces/kimproxy/interface/kcm_instantmessenger.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ interfaces/kimproxy/interface/kcm_instantmessenger.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -48,6 +48,7 @@
 Name[vi]=Bộ tin nhắn tức khắc
 Name[zh_CN]=即时通讯程序
 Name[zh_HK]=即時通訊軟件
+Name[zh_TW]=即時通訊
 Comment=The instant messenger allows two-way chat between individuals and groups.
 Comment[af]=Die oombliklike boodskappe laat twee rigting kommunikasie tussen individue en groepe toe.
 Comment[bg]=Разговор между различни хора в реално време.
@@ -105,6 +106,7 @@
 Comment[vi]=Bộ tin nhắn tức khắc cho phép trò chuyện hai chiều giữa người riêng và nhóm.
 Comment[zh_CN]=允许在个人和群组之间双向聊天的即时通讯程序。
 Comment[zh_HK]=即時通訊軟件可以讓用戶和別的用戶或羣組通訊。
+Comment[zh_TW]=即時通訊系統允許兩個人或兩個群組間的聊天與對話
 ServiceTypeToConfigure=DCOP/InstantMessenger
 MimeTypeOfInterest=DCOP/InstantMessenger
 defaultImplementation=kopete
Index: interfaces/kspeech/dcoptexttospeech.desktop
===================================================================
--- interfaces/kspeech/dcoptexttospeech.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ interfaces/kspeech/dcoptexttospeech.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -57,3 +57,4 @@
 Comment[vi]=Dịch vụ Văn bản sang Tiếng nói có giao diện DCOP
 Comment[zh_CN]=带 DCOP 接口的文本到语音服务
 Comment[zh_HK]=附有 DCOP 介面的文字朗讀工具
+Comment[zh_TW]=DCOP 介面的文字轉語音服務
Index: kate/plugins/kdatatool/ktexteditor_kdatatool.desktop
===================================================================
--- kate/plugins/kdatatool/ktexteditor_kdatatool.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kate/plugins/kdatatool/ktexteditor_kdatatool.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -102,7 +102,7 @@
 Comment[hu]=Adatkezelési eszközök (pl. szinonimaszótár, helyesírás-ellenőrző) támogatása
 Comment[is]=Virkir gagnatól eins og stafsetningaforrit og leiðréttingar (ef uppsett)
 Comment[it]=Abilita gli strumenti per i dati come il dizionario dei sinonimi e il controllo ortografico (se installati)
-Comment[ja]=同義語ツールやスペルチェックなどのデータツールを有効にします （インストールされている場合）
+Comment[ja]=同義語ツールやスペルチェックなどのデータツールを有効にします (インストールされている場合)
 Comment[km]=ធ្វើ​ឲ្យ​ឧបករណ៍​ទិន្នន័យ​ប្រើ​បាន ដូច​ជា​កម្រង​វេវចនសព្ទ និង​ពិនិត្យ​អក្ខរាវិរុទ្ធ​ជា​ដើម (បើ​បាន​ដំឡើង)
 Comment[ko]=(깔려 있다면) 비슷한 말 사전과 맞춤법 검사기 같은 도구를 씁니다
 Comment[lb]=Hëllefsprogrammer, wéi Thésaurus an Rechtschreifkontroll, uschalten (wann installéiert)
Index: kate/plugins/insertfile/ktexteditor_insertfile.desktop
===================================================================
--- kate/plugins/insertfile/ktexteditor_insertfile.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kate/plugins/insertfile/ktexteditor_insertfile.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -131,6 +131,7 @@
 Comment[vi]=Chèn bất kỳ tập tin có khả năng đọc tại vị trí của con chạy.
 Comment[zh_CN]=在光标位置插入任何可读文件
 Comment[zh_HK]=在游標處插入任意的檔案
+Comment[zh_TW]=在游標處插入任意的可讀檔案
 X-KDE-Library=ktexteditor_insertfile
 ServiceTypes=KTextEditor/Plugin
 Type=Service
Index: kate/plugins/autobookmarker/ktexteditor_autobookmarker.desktop
===================================================================
--- kate/plugins/autobookmarker/ktexteditor_autobookmarker.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kate/plugins/autobookmarker/ktexteditor_autobookmarker.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -110,6 +110,7 @@
 Comment[uk]=Встановлює закладки на рядках, що відповідають взірцю, під час завантаження документів
 Comment[vi]=Đặt đánh dấu trên các dòng khớp một mẫu nào đó khi tải tài liệu.
 Comment[zh_CN]=文档装入时根据匹配模式自动设置书签
+Comment[zh_TW]=文件載入時以字串比對演算法來設定書籤。
 X-KDE-Library=ktexteditor_autobookmarker
 ServiceTypes=KTextEditor/Plugin
 Type=Service
Index: kate/plugins/wordcompletion/ktexteditor_docwordcompletion.desktop
===================================================================
--- kate/plugins/wordcompletion/ktexteditor_docwordcompletion.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kate/plugins/wordcompletion/ktexteditor_docwordcompletion.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -57,6 +57,7 @@
 Name[vi]=Bộ cầm phít Nhập xong Từ KTextEditor
 Name[zh_CN]=KTextEditor 单词补全插件
 Name[zh_HK]=KTextEditor 文字自動補齊外掛程式
+Name[zh_TW]=KTextEditor 單字補完外掛程式
 Comment=Directional or popup-based completion from words in the document
 Comment[af]=Direksionele of opspring gebaseerde woord voltooiïng van woorde in die dokument
 Comment[bg]=Автоматично завършване на думи, базирано на използваните вече думи в документа
@@ -111,6 +112,7 @@
 Comment[uk]=Завершення слів у документі. Пряме або на основі вигулькного меню
 Comment[vi]=Khả năng nhập xong từ trong tài liệu, đựa vào chiều hoặc vào bộ bật lên.
 Comment[zh_CN]=在文档中基于方向或弹出补全单词
+Comment[zh_TW]=在編輯文件時的單字補完功能
 X-KDE-Library=ktexteditor_docwordcompletion
 ServiceTypes=KTextEditor/Plugin
 Type=Service
Index: kate/plugins/isearch/ktexteditor_isearch.desktop
===================================================================
--- kate/plugins/isearch/ktexteditor_isearch.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kate/plugins/isearch/ktexteditor_isearch.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -128,6 +128,7 @@
 Comment[uk]=Також відомий як "Пошук за вводом"
 Comment[vi]=Cũng được biết như là « Tìm kiếm trong khi gõ ».
 Comment[zh_CN]=也称为“即输即搜”
+Comment[zh_TW]=也稱做「即時搜尋」
 X-KDE-Library=ktexteditor_isearch
 ServiceTypes=KTextEditor/Plugin
 Type=Service
Index: kate/part/katerenderer.cpp
===================================================================
--- kate/part/katerenderer.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kate/part/katerenderer.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -34,9 +34,6 @@
 #include <qpainter.h>
 #include <qpopupmenu.h>
 
-static const QChar tabChar('\t');
-static const QChar spaceChar(' ');
-
 KateRenderer::KateRenderer(KateDocument* doc, KateView *view)
   : m_doc(doc), m_view (view), m_caretStyle(KateRenderer::Insert)
     , m_drawCaret(true)
@@ -376,7 +373,7 @@
     if (showCursor && (cursor->col() >= int(startcol)))
     {
       cursorVisible = true;
-      cursorXPos = xPos + cursor->col() * fs->myFontMetrics.width(spaceChar);
+      cursorXPos = xPos + cursor->col() * fs->myFontMetrics.width(QChar(' '));
     }
   }
   else
@@ -417,7 +414,7 @@
     const uint lastIndentColumn = textLine->firstChar();
 
     // Could be precomputed.
-    const uint spaceWidth = fs->width (spaceChar, false, false, m_tabWidth);
+    const uint spaceWidth = fs->width (QChar(' '), false, false, m_tabWidth);
 
     // Get current x position.
     int curPos = textLine->cursorX(curCol, m_tabWidth);
@@ -425,12 +422,13 @@
     while (curCol - startcol < len)
     {
       // make sure curPos is updated correctly.
-      Q_ASSERT(curPos == textLine->cursorX(curCol, m_tabWidth));
+      // ### if uncommented, causes an O(n^2) behaviour
+      //Q_ASSERT(curPos == textLine->cursorX(curCol, m_tabWidth));
 
       QChar curChar = textLine->string()[curCol];
       // Decide if this character is a tab - we treat the spacing differently
       // TODO: move tab width calculation elsewhere?
-      bool isTab = curChar == tabChar;
+      bool isTab = curChar == QChar('\t');
 
       // Determine current syntax highlighting attribute
       // A bit legacy but doesn't need to change
@@ -497,7 +495,7 @@
           || (superRanges.count() && superRanges.currentBoundary() && *(superRanges.currentBoundary()) == KateTextCursor(line, nextCol))
 
           // it is the end of the line OR
-          || (curCol >= len - 1)
+          || (curCol - startcol >= len - 1)
 
           // the rest of the line is trailing whitespace OR
           || (curCol + 1 >= trailingWhitespaceColumn)
@@ -516,7 +514,7 @@
 
           // the next char is a tab (removed the "and this isn't" because that's dealt with above)
           // i.e. we have to draw the current text so the tab can be rendered as above.
-          || (textLine->string()[nextCol] == tabChar)
+          || (textLine->string()[nextCol] == QChar('\t'))
 
           // input method edit area
           || ( m_view && (isIMEdit != m_view->isIMEdit( line, nextCol )) )
@@ -698,11 +696,18 @@
       }
     }
 
+    // If this line has a partial selection that's the start of a multi-line selection,
+    // we have to fill areas on the right side of the text with the selection color.
+    if (showSelections() && hasSel && !selectionPainted && xStart >= (int)xPos && m_view->lineEndSelected(line, -1))
+    {
+      paint.fillRect(0, 0, xEnd-xStart, fs->fontHeight, config()->selectionColor());
+    }
+
     // Determine cursor position (if it is not within the range being drawn)
     if (showCursor && (cursor->col() >= int(curCol)))
     {
       cursorVisible = true;
-      cursorXPos = xPos + (cursor->col() - int(curCol)) * fs->myFontMetrics.width(spaceChar);
+      cursorXPos = xPos + (cursor->col() - int(curCol)) * fs->myFontMetrics.width(QChar(' '));
       cursorMaxWidth = xPosAfter - xPos;
       cursorColor = &oldAt->textColor();
     }
@@ -733,29 +738,32 @@
   if (!textLine)
     return 0;
 
-  int len = textLine->length();
+  const int len = textLine->length();
 
-  if (cursorCol < 0)
+  if (cursorCol < 0 || cursorCol > len)
     cursorCol = len;
 
   KateFontStruct *fs = config()->fontStruct();
 
+  const QChar *unicode = textLine->text();
+  const QString &textString = textLine->string();
+
   int x = 0;
   int width;
   for (int z = 0; z < cursorCol; z++) {
     KateAttribute* a = attribute(textLine->attribute(z));
 
     if (z < len) {
-      width = a->width(*fs, textLine->string(), z, m_tabWidth);
+      width = a->width(*fs, textString, z, m_tabWidth);
     } else {
       // DF: commented out. It happens all the time.
       //Q_ASSERT(!m_doc->wrapCursor());
-      width = a->width(*fs, spaceChar, m_tabWidth);
+      width = a->width(*fs, QChar(' '), m_tabWidth);
     }
 
     x += width;
 
-    if (textLine->getChar(z) == tabChar)
+    if (unicode[z] == QChar('\t'))
       x -= x % width;
   }
 
@@ -778,15 +786,19 @@
 
   *needWrap = false;
 
+  const uint len = textLine->length();
+  const QChar *unicode = textLine->text();
+  const QString &textString = textLine->string();
+
   uint z = startcol;
-  for (; z < textLine->length(); z++)
+  for (; z < len; z++)
   {
     KateAttribute* a = attribute(textLine->attribute(z));
-    int width = a->width(*fs, textLine->string(), z, m_tabWidth);
+    int width = a->width(*fs, textString, z, m_tabWidth);
     Q_ASSERT(width);
     x += width;
 
-    if (textLine->getChar(z).isSpace())
+    if (unicode[z].isSpace())
     {
       lastWhiteSpace = z+1;
       lastWhiteSpaceX = x;
@@ -806,7 +818,7 @@
 
     // How should tabs be treated when they word-wrap on a print-out?
     // if startcol != 0, this messes up (then again, word wrapping messes up anyway)
-    if (textLine->getChar(z) == tabChar)
+    if (unicode[z] == QChar('\t'))
       x -= x % width;
 
     if (x <= maxwidth)
@@ -864,7 +876,6 @@
 uint KateRenderer::textWidth( KateTextCursor &cursor, int xPos, uint startCol)
 {
   bool wrapCursor = m_view->wrapCursor();
-  int len;
   int x, oldX;
 
   KateFontStruct *fs = config()->fontStruct();
@@ -875,10 +886,12 @@
 
   if (!textLine) return 0;
 
-  len = textLine->length();
+  const uint len = textLine->length();
+  const QChar *unicode = textLine->text();
+  const QString &textString = textLine->string();
 
   x = oldX = 0;
-  int z = startCol;
+  uint z = startCol;
   while (x < xPos && (!wrapCursor || z < len)) {
     oldX = x;
 
@@ -887,13 +900,13 @@
     int width = 0;
 
     if (z < len)
-      width = a->width(*fs, textLine->string(), z, m_tabWidth);
+      width = a->width(*fs, textString, z, m_tabWidth);
     else
-      width = a->width(*fs, spaceChar, m_tabWidth);
+      width = a->width(*fs, QChar(' '), m_tabWidth);
 
     x += width;
 
-    if (textLine->getChar(z) == tabChar)
+    if (z < len && unicode[z] == QChar('\t'))
       x -= x % width;
 
     z++;
@@ -933,12 +946,14 @@
   x = oldX = 0;
 
   uint z = startCol;
-  uint len= textLine->length();
+  const uint len = textLine->length();
+  const QString &textString = textLine->string();
+
   while ( (x < xPos)  && (z < len)) {
     oldX = x;
 
     KateAttribute* a = attribute(textLine->attribute(z));
-    x += a->width(*fs, textLine->string(), z, m_tabWidth);
+    x += a->width(*fs, textString, z, m_tabWidth);
 
     z++;
   }
@@ -1011,7 +1026,7 @@
 
 uint KateRenderer::spaceWidth()
 {
-  return attribute(0)->width(*config()->fontStruct(), spaceChar, m_tabWidth);
+  return attribute(0)->width(*config()->fontStruct(), QChar(' '), m_tabWidth);
 }
 
 // kate: space-indent on; indent-width 2; replace-tabs on;
Index: kate/part/katehighlight.cpp
===================================================================
--- kate/part/katehighlight.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kate/part/katehighlight.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -1522,7 +1522,7 @@
         // even set attributes ;)
         memset ( textLine->attributes()+offset
                , item->onlyConsume ? context->attr : item->attr
-               , len-offset);
+               , offset2-offset);
 
         offset = offset2;
         lastChar = text[offset-1];
@@ -2080,8 +2080,8 @@
 
 bool KateHighlighting::isInWord( QChar c, int attrib ) const
 {
-  static const QString& sq = KGlobal::staticQString(" \"'");
-  return m_additionalData[ hlKeyForAttrib( attrib ) ]->deliminator.find(c) < 0 && sq.find(c) < 0;
+  return m_additionalData[ hlKeyForAttrib( attrib ) ]->deliminator.find(c) < 0
+      && !c.isSpace() && c != '"' && c != '\'';
 }
 
 bool KateHighlighting::canBreakAt( QChar c, int attrib ) const
Index: kate/part/kateviewinternal.h
===================================================================
--- kate/part/kateviewinternal.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kate/part/kateviewinternal.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -190,7 +190,6 @@
 
   private:
     void moveChar( Bias bias, bool sel );
-    void moveWord( Bias bias, bool sel );
     void moveEdge( Bias bias, bool sel );
     KateTextCursor maxStartPos(bool changed = false);
     void scrollPos(KateTextCursor& c, bool force = false, bool calledExternally = false);
@@ -269,7 +268,6 @@
     //
     QScrollBar *m_columnScroll;
     int m_startX;
-    int m_oldStartX;
 
     // has selection changed while your mouse or shift key is pressed
     bool m_selChangedByUser;
@@ -363,10 +361,6 @@
     static const int scrollTime = 30;
     static const int scrollMargin = 16;
 
-    // dyn wrap mode:
-    // used to set the lineScroll to the max value
-    bool m_maximizeLineScroll;
-
   private slots:
     void scrollTimeout ();
     void cursorTimeout ();
Index: kate/part/katetextline.cpp
===================================================================
--- kate/part/katetextline.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kate/part/katetextline.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -109,9 +109,12 @@
 
 int KateTextLine::nextNonSpaceChar(uint pos) const
 {
-  for(int i = pos; i < (int)m_text.length(); i++)
+  const uint len = m_text.length();
+  const QChar *unicode = m_text.unicode();
+
+  for(uint i = pos; i < len; i++)
   {
-    if(!m_text[i].isSpace())
+    if(!unicode[i].isSpace())
       return i;
   }
 
@@ -120,12 +123,16 @@
 
 int KateTextLine::previousNonSpaceChar(uint pos) const
 {
-  if (pos >= m_text.length())
-    pos = m_text.length() - 1;
+  const int len = m_text.length();
 
+  if (pos >= (uint)len)
+    pos = len - 1;
+
+  const QChar *unicode = m_text.unicode();
+
   for(int i = pos; i >= 0; i--)
   {
-    if(!m_text[i].isSpace())
+    if(!unicode[i].isSpace())
       return i;
   }
 
@@ -151,12 +158,14 @@
 uint KateTextLine::indentDepth (uint tabwidth) const
 {
   uint d = 0;
+  const uint len = m_text.length();
+  const QChar *unicode = m_text.unicode();
 
-  for(uint i = 0; i < m_text.length(); i++)
+  for(uint i = 0; i < len; i++)
   {
-    if(m_text[i].isSpace())
+    if(unicode[i].isSpace())
     {
-      if (m_text[i] == QChar('\t'))
+      if (unicode[i] == QChar('\t'))
         d += tabwidth - (d % tabwidth);
       else
         d++;
@@ -170,11 +179,21 @@
 
 bool KateTextLine::stringAtPos(uint pos, const QString& match) const
 {
-  if ((pos+match.length()) > m_text.length())
+  const uint len = m_text.length();
+  const uint matchlen = match.length();
+
+  if ((pos+matchlen) > len)
     return false;
 
-  for (uint i=0; i < match.length(); i++)
-    if (m_text[i+pos] != match[i])
+  // (pos > len) in case the uint pos was assigned a signed -1, pos+matchlen can
+  // overflow again which (pos+matchlen > len) does not catch; see bugs #129263 and #129580
+  Q_ASSERT(pos < len);
+
+  const QChar *unicode = m_text.unicode();
+  const QChar *matchUnicode = match.unicode();
+
+  for (uint i=0; i < matchlen; i++)
+    if (unicode[i+pos] != matchUnicode[i])
       return false;
 
   return true;
@@ -182,11 +201,16 @@
 
 bool KateTextLine::startingWith(const QString& match) const
 {
-  if (match.length() > m_text.length())
+  const uint matchlen = match.length();
+
+  if (matchlen > m_text.length())
     return false;
 
-  for (uint i=0; i < match.length(); i++)
-    if (m_text[i] != match[i])
+  const QChar *unicode = m_text.unicode();
+  const QChar *matchUnicode = match.unicode();
+
+  for (uint i=0; i < matchlen; i++)
+    if (unicode[i] != matchUnicode[i])
       return false;
 
   return true;
@@ -194,12 +218,17 @@
 
 bool KateTextLine::endingWith(const QString& match) const
 {
-  if (match.length() > m_text.length())
+  const uint matchlen = match.length();
+
+  if (matchlen > m_text.length())
     return false;
 
-  uint start = m_text.length() - match.length();
-  for (uint i=0; i < match.length(); i++)
-    if (m_text[start+i] != match[i])
+  const QChar *unicode = m_text.unicode();
+  const QChar *matchUnicode = match.unicode();
+
+  uint start = m_text.length() - matchlen;
+  for (uint i=0; i < matchlen; i++)
+    if (unicode[start+i] != matchUnicode[i])
       return false;
 
   return true;
@@ -209,9 +238,12 @@
 {
   uint x = 0;
 
-  for ( uint z = 0; z < kMin (pos, m_text.length()); z++)
+  const uint n = kMin (pos, m_text.length());
+  const QChar *unicode = m_text.unicode();
+
+  for ( uint z = 0; z < n; z++)
   {
-    if (m_text[z] == QChar('\t'))
+    if (unicode[z] == QChar('\t'))
       x += tabChars - (x % tabChars);
     else
       x++;
@@ -224,10 +256,12 @@
 uint KateTextLine::lengthWithTabs (uint tabChars) const
 {
   uint x = 0;
+  const uint len = m_text.length();
+  const QChar *unicode = m_text.unicode();
 
-  for ( uint z = 0; z < m_text.length(); z++)
+  for ( uint z = 0; z < len; z++)
   {
-    if (m_text[z] == QChar('\t'))
+    if (unicode[z] == QChar('\t'))
       x += tabChars - (x % tabChars);
     else
       x++;
Index: kate/part/katebuffer.cpp
===================================================================
--- kate/part/katebuffer.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kate/part/katebuffer.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -807,6 +807,10 @@
     // cu block !
     delete buf;
     m_blocks.erase (m_blocks.begin()+index);
+
+    // make sure we don't keep a pointer to the deleted block
+    if( m_lastInSyncBlock >= index )
+      m_lastInSyncBlock = index - 1;
   }
   else
   {
@@ -866,6 +870,10 @@
 
     h->use();
 
+    // Clear code folding tree (see bug #124102)
+    m_regionTree.clear();
+    m_regionTree.fixRoot(m_lines);
+
     // try to set indentation
     if (!h->indentation().isEmpty())
       m_doc->config()->setIndentationMode (KateAutoIndent::modeNumber(h->indentation()));
Index: kate/part/kateschema.cpp
===================================================================
--- kate/part/kateschema.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kate/part/kateschema.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -1450,6 +1450,7 @@
     is->clearAttribute(KateAttribute::BGColor);
   else if ( c == 101 && is->itemSet(KateAttribute::SelectedBGColor) )
     is->clearAttribute(KateAttribute::SelectedBGColor);
+  updateStyle();
 }
 
 void KateStyleListItem::paintCell( QPainter *p, const QColorGroup& /*cg*/, int col, int width, int align )
Index: kate/part/katecodefoldinghelpers.cpp
===================================================================
--- kate/part/katecodefoldinghelpers.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kate/part/katecodefoldinghelpers.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -559,7 +559,9 @@
   uint endCol=node->endCol;
 
   // removes + deletes
-  delete parent->takeChild(mypos);
+  KateCodeFoldingNode *child = parent->takeChild(mypos);
+  markedForDeleting.removeRef(child);
+  delete child;
 
   if ((type>0) && (endLineValid))
     correctEndings(-type, parent, line+endLineRel/*+1*/,endCol, mypos); // why the hell did I add a +1 here ?
@@ -583,7 +585,11 @@
     // removes + deletes
     int i = parent->findChild (node);
     if (i >= 0)
-      delete parent->takeChild (i);
+    {
+      KateCodeFoldingNode *child = parent->takeChild(i);
+      markedForDeleting.removeRef(child);
+      delete child;
+    }
 
     return true;
   }
@@ -598,7 +604,9 @@
       node->endLineValid = true;
       node->endLineRel = parent->child(i)->startLineRel - node->startLineRel;
 
-      delete parent->takeChild(i);
+      KateCodeFoldingNode *child = parent->takeChild(i);
+      markedForDeleting.removeRef(child);
+      delete child;
 
       count = i-mypos-1;
       if (count > 0)
@@ -831,7 +839,9 @@
                 node->endLineValid = true;
                 node->endLineRel = getStartLine(parent->child(i))-line;
                 node->endCol = parent->child(i)->endCol;
-                delete parent->takeChild(i);
+                KateCodeFoldingNode *child = parent->takeChild(i);
+                markedForDeleting.removeRef( child );
+                delete child;
                 break;
               }
             }
@@ -907,7 +917,9 @@
               count = node->childCount() - i - 1;
               newNode->endLineValid = true;
               newNode->endLineRel = line - getStartLine(node->child(i));
-              delete node->takeChild(i);
+              KateCodeFoldingNode *child = node->takeChild(i);
+              markedForDeleting.removeRef( child );
+              delete child;
               break;
             }
           }
Index: kate/part/kateviewinternal.cpp
===================================================================
--- kate/part/kateviewinternal.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kate/part/kateviewinternal.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -76,7 +76,6 @@
   , m_scrollTimer (this)
   , m_cursorTimer (this)
   , m_textHintTimer (this)
-  , m_maximizeLineScroll (false)
   , m_textHintEnabled(false)
   , m_textHintMouseX(-1)
   , m_textHintMouseY(-1)
@@ -142,7 +141,6 @@
 
   m_columnScroll->setTracking(true);
   m_startX = 0;
-  m_oldStartX = 0;
 
   connect( m_columnScroll, SIGNAL( valueChanged (int) ),
            this, SLOT( scrollColumns (int) ) );
@@ -390,9 +388,6 @@
   if (c > limit) {
     c = limit;
 
-    if (m_view->dynWordWrap())
-      m_maximizeLineScroll = true;
-
     // Re-check we're not just scrolling to the same place
     if (!force && ((!m_view->dynWordWrap() && c.line() == (int)startLine()) || c == startPos()))
       return;
@@ -459,7 +454,6 @@
     x = 0;
 
   int dx = m_startX - x;
-  m_oldStartX = m_startX;
   m_startX = x;
 
   if (QABS(dx) < width())
@@ -487,12 +481,7 @@
     maxLineScrollRange++;
   m_lineScroll->setRange(0, maxLineScrollRange);
 
-  if (m_view->dynWordWrap() && m_maximizeLineScroll) {
-    m_maximizeLineScroll = false;
-    m_lineScroll->setValue(maxStart.line());
-  } else {
-    m_lineScroll->setValue(startPos().line());
-  }
+  m_lineScroll->setValue(startPos().line());
   m_lineScroll->setSteps(1, height() / m_view->renderer()->fontHeight());
   m_lineScroll->blockSignals(false);
 
@@ -698,6 +687,12 @@
     if (max < 0)
       max = 0;
 
+    // if we lose the ability to scroll horizontally, move view to the far-left
+    if (max == 0)
+    {
+      m_startX = 0;
+    }
+
     // disable scrollbar
     m_columnScroll->setDisabled (max == 0);
 
@@ -1123,43 +1118,90 @@
   }
 }
 
-void KateViewInternal::moveWord( Bias bias, bool sel )
+void KateViewInternal::wordLeft ( bool sel )
 {
-  // This matches the word-moving in QTextEdit, QLineEdit etc.
-
   WrappingCursor c( this, cursor );
-  if( !c.atEdge( bias ) ) {
-    KateHighlighting* h = m_doc->highlight();
 
-    bool moved = false;
-    while( !c.atEdge( bias ) && !h->isInWord( m_doc->textLine( c.line() )[ c.col() - (bias == left ? 1 : 0) ] ) )
+  // First we skip backwards all space.
+  // Then we look up into which category the current position falls:
+  // 1. a "word" character
+  // 2. a "non-word" character (except space)
+  // 3. the beginning of the line
+  // and skip all preceding characters that fall into this class.
+  // The code assumes that space is never part of the word character class.
+
+  KateHighlighting* h = m_doc->highlight();
+  if( !c.atEdge( left ) ) {
+
+    while( !c.atEdge( left ) && m_doc->textLine( c.line() )[ c.col() - 1 ].isSpace() )
+      --c;
+  }
+  if( c.atEdge( left ) )
+  {
+    --c;
+  }
+  else if( h->isInWord( m_doc->textLine( c.line() )[ c.col() - 1 ] ) )
+  {
+    while( !c.atEdge( left ) && h->isInWord( m_doc->textLine( c.line() )[ c.col() - 1 ] ) )
+      --c;
+  }
+  else
+  {
+    while( !c.atEdge( left )
+           && !h->isInWord( m_doc->textLine( c.line() )[ c.col() - 1 ] )
+           // in order to stay symmetric to wordLeft()
+           // we must not skip space preceding a non-word sequence
+           && !m_doc->textLine( c.line() )[ c.col() - 1 ].isSpace() )
     {
-      c += bias;
-      moved = true;
+      --c;
     }
+  }
 
-    if ( bias != right || !moved )
+  updateSelection( c, sel );
+  updateCursor( c );
+}
+
+void KateViewInternal::wordRight( bool sel )
+{
+  WrappingCursor c( this, cursor );
+
+  // We look up into which category the current position falls:
+  // 1. a "word" character
+  // 2. a "non-word" character (except space)
+  // 3. the end of the line
+  // and skip all following characters that fall into this class.
+  // If the skipped characters are followed by space, we skip that too.
+  // The code assumes that space is never part of the word character class.
+
+  KateHighlighting* h = m_doc->highlight();
+  if( c.atEdge( right ) )
+  {
+    ++c;
+  }
+  else if( h->isInWord( m_doc->textLine( c.line() )[ c.col() ] ) )
+  {
+    while( !c.atEdge( right ) && h->isInWord( m_doc->textLine( c.line() )[ c.col() ] ) )
+      ++c;
+  }
+  else
+  {
+    while( !c.atEdge( right )
+           && !h->isInWord( m_doc->textLine( c.line() )[ c.col() ] )
+           // we must not skip space, because if that space is followed
+           // by more non-word characters, we would skip them, too
+           && !m_doc->textLine( c.line() )[ c.col() ].isSpace() )
     {
-      while( !c.atEdge( bias ) &&  h->isInWord( m_doc->textLine( c.line() )[ c.col() - (bias == left ? 1 : 0) ] ) )
-        c += bias;
-      if ( bias == right )
-      {
-        while ( !c.atEdge( bias ) && m_doc->textLine( c.line() )[ c.col() ].isSpace() )
-          c+= bias;
-      }
+      ++c;
     }
-
-  } else {
-    c += bias;
   }
 
+  while( !c.atEdge( right ) && m_doc->textLine( c.line() )[ c.col() ].isSpace() )
+    ++c;
+
   updateSelection( c, sel );
   updateCursor( c );
 }
 
-void KateViewInternal::wordLeft ( bool sel ) { moveWord( left,  sel ); }
-void KateViewInternal::wordRight( bool sel ) { moveWord( right, sel ); }
-
 void KateViewInternal::moveEdge( Bias bias, bool sel )
 {
   BoundedCursor c( this, cursor );
@@ -2606,7 +2648,8 @@
           selEndCached = m_view->selectEnd;
 
           cursor.setCol(0);
-          updateCursor( cursor );
+          updateCursor( cursor, true );
+          e->accept ();
           return;
         }
 
@@ -2659,6 +2702,11 @@
       }
       else
       {
+        // first clear the selection, otherweise we run into bug #106402
+        // Parameters: 1st false: don't redraw
+        //             2nd false: don't emit selectionChanged signals, as
+        //             selectWord() emits this already
+        m_view->clearSelection( false, false );
         m_view->selectWord( cursor );
         selectAnchor = KateTextCursor (m_view->selEndLine(), m_view->selEndCol());
         selStartCached = m_view->selectStart;
@@ -2673,7 +2721,7 @@
         QApplication::clipboard()->setSelectionMode( false );
 
         cursor.setPos(m_view->selectEnd);
-        updateCursor( cursor );
+        updateCursor( cursor, true );
 
         selStartCached = m_view->selectStart;
         selEndCached = m_view->selectEnd;
Index: kate/part/kateautoindent.cpp
===================================================================
--- kate/part/kateautoindent.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kate/part/kateautoindent.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -891,9 +891,10 @@
   {
     cur.setCol(cur.col() + 4);
     needsBalanced = false;
-    if (textLine->stringAtPos(textLine->nextNonSpaceChar(cur.col()), "if"))
+    int next = textLine->nextNonSpaceChar(cur.col());
+    if (next >= 0 && textLine->stringAtPos(next, "if"))
     {
-      cur.setCol(textLine->nextNonSpaceChar(cur.col()) + 2);
+      cur.setCol(next + 2);
       needsBalanced = true;
     }
   }
Index: kate/scripts/jstest.desktop
===================================================================
--- kate/scripts/jstest.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kate/scripts/jstest.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -83,6 +83,7 @@
 Comment[ru]=Скрипт для проверки поддержки скриптов в Kate
 Comment[rw]=Inyandikoporogaramu yo kugenzura kwandika kode by'igice cya kate.
 Comment[se]=Skripta mii geahččala Kate part-skriptema
+Comment[sk]=Skript pre testovanie skriptovania Kate Part
 Comment[sl]=Skript za testiranje delovanja skriptov za del Kate
 Comment[sr]=Скрипта за испробавање скриптовања Kate-иног дела
 Comment[sr@Latn]=Skripta za isprobavanje skriptovanja Kate-inog dela
@@ -93,5 +94,6 @@
 Comment[uk]=Скрипт для перевірки підтримки скриптів в компоненті Kate
 Comment[vi]=Tập lệnh để thử ra khả năng điều khiển bằng tập lệnh của phần Kate.
 Comment[zh_CN]=测试 kate 部件脚本的脚本
+Comment[zh_TW]=測試 kate part 的文稿
 X-Kate-Command=jstest
 X-Kate-Help=<p>Usage: <code>jstest</code></p>
Index: kate/data/makefile.xml
===================================================================
--- kate/data/makefile.xml	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kate/data/makefile.xml	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -2,7 +2,7 @@
 <!DOCTYPE language SYSTEM "language.dtd">
 <!-- Makefile syntaxfile v0.9 by Per Wigren <wigren@home.se> -->
 <!-- Modified by Joseph Wenninger <jowenn@kde.org> -->
-<language name="Makefile" version="1.06" kateversion="2.4" section="Other" extensions="*makefile*;*Makefile*" mimetype="text/x-makefile" author="Per Wigren (wigren@home.se)" license="">
+<language name="Makefile" version="1.08" kateversion="2.4" section="Other" extensions="*makefile*;*Makefile*" mimetype="text/x-makefile" author="Per Wigren (wigren@home.se)" license="">
   <highlighting>
     <list name = "keywords">
       <item> include </item>
@@ -24,9 +24,11 @@
         <RegExpr attribute="Section" context="#stay" String="^[.].*:"/>
         <DetectChar attribute="String" context="String" char="&quot;"/>
         <RegExpr attribute="Operator" context="VarFromNormal" String="[$][\({]"/>
-        <AnyChar attribute="Operator" context="#stay" String="+*=%$():\\&#059;" />
-        <RegExpr attribute="Operator" context="Commands" String="[@-]" firstNonSpace="true"/>
-        <RegExpr attribute="Comment" context="#stay" String="(:^|[^\\])#.*$"/>
+        <Detect2Chars attribute="Special" context="#stay" char="\" char1="#"/>
+        <Detect2Chars attribute="Special" context="#stay" char="\" char1="\"/>
+        <AnyChar attribute="Operator" context="#stay" String="+*=%$():\&#059;"/>
+        <AnyChar attribute="Operator" context="Commands" String="@-" firstNonSpace="true"/>
+        <RegExpr attribute="Comment" context="#stay" String="#.*$"/>
       </context>
 
       <context attribute="String" lineEndContext="#pop" name="String">
@@ -49,7 +51,7 @@
       </context>
 
       <context name="VarFromNormal" attribute="Variable" lineEndContext="#stay">
-        <RegExpr attribute="Operator" String="[\)}]" context="#pop"/>
+        <AnyChar attribute="Operator" String=")}" context="#pop"/>
       </context>
 
       <context name="Commands" attribute="Normal Text" lineEndContext="#pop">
Index: mimetypes/all.desktop
===================================================================
--- mimetypes/all.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/all.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -33,7 +33,7 @@
 Comment[hu]=Minden fájl és könyvtár
 Comment[is]=Allar skrár og möppur
 Comment[it]=Tutti i file e le cartelle
-Comment[ja]=全てのファイルとディレクトリ
+Comment[ja]=すべてのファイルとディレクトリ
 Comment[km]=ឯកសារ និង ថត​ទាំងអស់
 Comment[ko]=모든 파일과 자료방
 Comment[lb]=All Dateien an Dossieren
Index: mimetypes/audio/x-musepack.desktop
===================================================================
--- mimetypes/audio/x-musepack.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/audio/x-musepack.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -59,3 +59,4 @@
 Comment[vi]=Âm thanh Musepack
 Comment[zh_CN]=Musepack 音频
 Comment[zh_HK]=Musepack 音效檔
+Comment[zh_TW]=Musepack 音效
Index: mimetypes/audio/prs.sid.desktop
===================================================================
--- mimetypes/audio/prs.sid.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/audio/prs.sid.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -63,3 +63,4 @@
 Comment[vi]=Âm nhạc SID C64
 Comment[zh_CN]=C64 SID 音频
 Comment[zh_HK]=C64 SID 音樂
+Comment[zh_TW]=C64 SID 音樂
Index: mimetypes/audio/x-mp2.desktop
===================================================================
--- mimetypes/audio/x-mp2.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/audio/x-mp2.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -62,3 +62,4 @@
 Comment[vi]=Âm thanh lớp 2 MPEG
 Comment[zh_CN]=MP2 音频文件
 Comment[zh_HK]=MPEG Layer 2 音效檔
+Comment[zh_TW]=MPEG Layer 2 音效
Index: mimetypes/audio/x-ms-wma.desktop
===================================================================
--- mimetypes/audio/x-ms-wma.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/audio/x-ms-wma.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -57,3 +57,4 @@
 Comment[vi]=Âm thanh Windows Media
 Comment[zh_CN]=Windows Media 音频
 Comment[zh_HK]=Windows Media 音效檔
+Comment[zh_TW]=WIndows Media 音效
Index: mimetypes/image/x-hdr.desktop
===================================================================
--- mimetypes/image/x-hdr.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/image/x-hdr.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -39,6 +39,7 @@
 Comment[ro]=Imagine cu domeniu dinamic larg
 Comment[ru]=Рисунок HDR
 Comment[se]=Govva mas lea stuorra dynámalaš gaskkadat
+Comment[sk]=High Dynamic Range obrázok
 Comment[sl]=Slika z visokim dinamičnim razponom
 Comment[sr]=Слика високог динамичког опсега
 Comment[sr@Latn]=Slika visokog dinamičkog opsega
Index: mimetypes/image/x-exr.desktop
===================================================================
--- mimetypes/image/x-exr.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/image/x-exr.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -64,4 +64,5 @@
 Comment[uz]=ILM EXR-расм
 Comment[vi]=Ảnh ILM EXR
 Comment[zh_CN]=ILM EXR 图像
+Comment[zh_TW]=ILM EXR 影像
 
Index: mimetypes/image/x-djvu-2.desktop
===================================================================
--- mimetypes/image/x-djvu-2.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/image/x-djvu-2.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -45,6 +45,7 @@
 Comment[ro]=Document DjVu
 Comment[ru]=Документ DjVu
 Comment[se]=DjVu-dokumeanta
+Comment[sk]=DjVu dokument
 Comment[sl]=Dokument DjVu
 Comment[sr]=DjVu документ
 Comment[sr@Latn]=DjVu dokument
@@ -57,3 +58,4 @@
 Comment[vi]=Tài liệu DjVu
 Comment[zh_CN]=DjVu 文档
 Comment[zh_HK]=DjVu 圖檔
+Comment[zh_TW]=DjVu 文件
Index: mimetypes/image/x-djvu.desktop
===================================================================
--- mimetypes/image/x-djvu.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/image/x-djvu.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -45,6 +45,7 @@
 Comment[ro]=Document DjVu
 Comment[ru]=Документ DjVu
 Comment[se]=DjVu-dokumeanta
+Comment[sk]=DjVu dokument
 Comment[sl]=Dokument DjVu
 Comment[sr]=DjVu документ
 Comment[sr@Latn]=DjVu dokument
@@ -57,3 +58,4 @@
 Comment[vi]=Tài liệu DjVu
 Comment[zh_CN]=DjVu 文档
 Comment[zh_HK]=DjVu 圖檔
+Comment[zh_TW]=DjVu 文件
Index: mimetypes/image/x-rgb.desktop
===================================================================
--- mimetypes/image/x-rgb.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/image/x-rgb.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -67,3 +67,4 @@
 Comment[vi]=Ảnh SGI (RGB)
 Comment[zh_CN]=SGI 图像(RGB)
 Comment[zh_HK]=SGI 圖檔 (RGB)
+Comment[zh_TW]=SGI 影像 (RGB)
Index: mimetypes/image/x-raw.desktop
===================================================================
--- mimetypes/image/x-raw.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/image/x-raw.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -3,7 +3,7 @@
 Type=MimeType
 MimeType=image/x-raw
 Icon=image
-Patterns=*.raw;*.RAW;*.dcr;*.DCR;*.dng;*.DNG;*.crw;*.CRW;*.cr2,*.CR2;*.nef;*.NEF;*.mrw;*.MRW;
+Patterns=*.raw;*.RAW;*.dcr;*.DCR;*.dng;*.DNG;*.crw;*.CRW;*.cr2,*.CR2;*.nef;*.NEF;*.mrw;*.MRW;*.bay;*.bmq;*.cs1;*.dc2;*.erf;*.fff;*.hrd;*.k25;*.kdc;*.mdc;*.mos;*.orf;*.pef;*.pxn;*.raf;*.rdc;*.sr2;*.srf;*.x3f;
 Comment=RAW Camera Image
 Comment[bs]=RAW kamera datoteka
 Comment[ca]=Fitxer de càmera RAW
@@ -33,6 +33,7 @@
 Comment[pt]=Imagem RAW da Máquina Fotográfica
 Comment[pt_BR]=Imagem RAW da Máquina Fotográfica
 Comment[ro]=Imagine foto brută
+Comment[sk]=RAW fotografický obrázok
 Comment[sl]=Slika RAW s fotoaparata
 Comment[sr]=Сирова слика са камере
 Comment[sr@Latn]=Sirova slika sa kamere
@@ -41,3 +42,4 @@
 Comment[uk]=Необроблене зображення з фотоапарату
 Comment[vi]=Ảnh PCX
 Comment[zh_CN]=RAW 相机图像
+Comment[zh_TW]=原始 Camera 影像
Index: mimetypes/image/fits.desktop
===================================================================
--- mimetypes/image/fits.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/image/fits.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -43,6 +43,7 @@
 Comment[ro]=Imagine FITS
 Comment[ru]=Рисунок FITS
 Comment[se]=FITS-govva
+Comment[sk]=FITS obrázok
 Comment[sl]=Slika FITS
 Comment[sr]=FITS слика
 Comment[sr@Latn]=FITS slika
@@ -53,6 +54,7 @@
 Comment[vi]=Ảnh FITS
 Comment[zh_CN]=FITS 图像
 Comment[zh_HK]=FITS 圖檔
+Comment[zh_TW]=FITS 影像
 ### TODO: what file patterns, especially that application/fits has the same
 # RFC 4047 tells that image/fits are also application/fits
 X-KDE-IsAlso=application/fits
Index: mimetypes/allfiles.desktop
===================================================================
--- mimetypes/allfiles.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/allfiles.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -33,7 +33,7 @@
 Comment[hu]=Minden fájl
 Comment[is]=Allar skrár
 Comment[it]=Tutti i file
-Comment[ja]=全てのファイル
+Comment[ja]=すべてのファイル
 Comment[km]=ឯកសារ​ទាំងអស់
 Comment[ko]=모든 파일
 Comment[lb]=All Dateien
Index: mimetypes/application/chm.desktop
===================================================================
--- mimetypes/application/chm.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/chm.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -38,6 +38,7 @@
 Comment[ro]=Document de ajutor HTML
 Comment[ru]=Документ справки в формате HTML
 Comment[se]=HTML-veahkkedokumeanta
+Comment[sk]=HTML pomocník
 Comment[sl]=Dokument HTML s pomočjo
 Comment[sr]=HTML документ помоћи
 Comment[sr@Latn]=HTML dokument pomoći
@@ -48,6 +49,7 @@
 Comment[vi]=Tài liệu trợ giúp HTML
 Comment[zh_CN]=HTML 帮助文档
 Comment[zh_HK]=HTML 說明文件
+Comment[zh_TW]=HTML 說明文件
 Hidden=false
 Icon=help
 MimeType=application/chm
Index: mimetypes/application/x-magicpoint.desktop
===================================================================
--- mimetypes/application/x-magicpoint.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/x-magicpoint.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -71,3 +71,4 @@
 Comment[wa]=Documint di prezintaedje Magicpoint
 Comment[zh_CN]=MagicPoint 演示文稿
 Comment[zh_HK]=MagicPoint 簡報
+Comment[zh_TW]=MagicPoint 簡報
Index: mimetypes/application/vnd.mozilla.xul+xml.desktop
===================================================================
--- mimetypes/application/vnd.mozilla.xul+xml.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/vnd.mozilla.xul+xml.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -64,3 +64,4 @@
 Comment[vi]=Tài liệu XUL Mozilla.
 Comment[zh_CN]=Mozilla XUL 文件
 Comment[zh_HK]=Mozilla XUL 檔案
+Comment[zh_TW]=Mozilla XUL 檔案
Index: mimetypes/application/x-mplayer2.desktop
===================================================================
--- mimetypes/application/x-mplayer2.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 0)
+++ mimetypes/application/x-mplayer2.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -0,0 +1,19 @@
+[Desktop Entry]
+Encoding=UTF-8
+Type=MimeType
+MimeType=application/x-mplayer2
+Icon=video
+Patterns=*.avi;*.AVI;*.asf;*.wmv;*.ASF;*.WMV;*.asx;*.ASX;*.wma;*.WMA;*.wmx;*.WMX
+Comment=Microsoft Media
+Comment[da]=Microsoft video
+Comment[el]=Μέσο της Microsoft
+Comment[es]=Media de Microsoft
+Comment[is]=Microsoft miðill
+Comment[ja]=Microsoft メディア
+Comment[nds]=Microsoft-Medium
+Comment[nl]=Microsoft media
+Comment[pt]=Multimédia da Microsoft
+Comment[pt_BR]=Multimédia da Microsoft
+Comment[sl]=Microsoftova večpredstavnost
+Comment[sv]=Microsoft media
+Comment[uk]=Медіа (Microsoft)
Index: mimetypes/application/x-bittorrent.desktop
===================================================================
--- mimetypes/application/x-bittorrent.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/x-bittorrent.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -69,5 +69,5 @@
 MimeType=application/x-bittorrent
 Icon=bt
 Type=MimeType
-Patterns=*.torrent
+Patterns=*.torrent;*.tor
 X-KDE-AutoEmbed=false
Index: mimetypes/application/vnd.sun.xml.base.desktop
===================================================================
--- mimetypes/application/vnd.sun.xml.base.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/vnd.sun.xml.base.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -41,6 +41,7 @@
 Comment[ru]=База данных OpenOffice.org
 Comment[rw]=OpenOffice.org Ububikoshingiro 
 Comment[se]=OpenOffice.org-diehtovuođđu
+Comment[sk]=OpenOffice.org  databáza
 Comment[sl]=Zbirka podatkov OpenOffice.org
 Comment[sr]=OpenOffice.org-ова база података
 Comment[sr@Latn]=OpenOffice.org-ova baza podataka
@@ -54,6 +55,7 @@
 Comment[vi]=Cơ sở dữ liệu OpenOffice.org
 Comment[zh_CN]=OpenOffice.org 数据库
 Comment[zh_HK]=OpenOffice.org 資料庫
+Comment[zh_TW]=OpenOffice.org 資料庫
 Icon=spreadsheet
 Type=MimeType
 Patterns=*.odb;*.ODB;
Index: mimetypes/application/x-tbz.desktop
===================================================================
--- mimetypes/application/x-tbz.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/x-tbz.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -39,6 +39,7 @@
 Comment[ro]=Arhivă Tar comprimată cu BZip2
 Comment[ru]=Сжатый bzip архив tar
 Comment[se]=Bzipp2ejuvvon Tar-arkiiva
+Comment[sk]=Bzip2 Tar archív
 Comment[sl]=Z bzip2 stisnjeni arhiv tar
 Comment[sr]=Bzip2-ована TAR архива
 Comment[sr@Latn]=Bzip2-ovana TAR arhiva
@@ -49,6 +50,7 @@
 Comment[vi]=Bản Tar đã nén Bzip
 Comment[zh_CN]=Bzip 压缩的 Tar 归档
 Comment[zh_HK]=Bzip2 壓縮的 Tar 保存檔
+Comment[zh_TW]=Bzip2-ed Tar 壓縮文件
 MimeType=application/x-tbz
 Icon=tgz
 Type=MimeType
Index: mimetypes/application/vnd.oasis.opendocument.spreadsheet-template.desktop
===================================================================
--- mimetypes/application/vnd.oasis.opendocument.spreadsheet-template.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/vnd.oasis.opendocument.spreadsheet-template.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -28,7 +28,7 @@
 Comment[hu]=OASIS-munkafüzet-sablon
 Comment[is]=OASIS OpenDocument töflureikningsnið
 Comment[it]=Modello di foglio di calcolo OASIS OpenDocument
-Comment[ja]=OASIS OpenDocument 表計算テンプレート
+Comment[ja]=OASIS OpenDocument 表計算 テンプレート
 Comment[km]=ពុម្ព​សៀវភៅបញ្ជី OASIS OpenDocument
 Comment[lb]=OASIS-OpenDocument-Tabellëkalkulatiounsvirlag
 Comment[lt]=OASIS OpenDocument elektroninės lentelės šablonas
@@ -60,6 +60,7 @@
 Comment[vi]=Biểu mẫu bảng tính OpenDocument OASIS
 Comment[zh_CN]=OASIS OpenDocument 电子表格模板
 Comment[zh_HK]=OASIS OpenDocument 試算表範本
+Comment[zh_TW]=OASIS OpenDocument 試算表樣本
 [Property::X-KDE-NativeExtension]
 Type=QString
 Value=.ots
Index: mimetypes/application/x-webarchive.desktop
===================================================================
--- mimetypes/application/x-webarchive.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/x-webarchive.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -61,6 +61,7 @@
 Comment[vi]=Kho Mạng
 Comment[xh]=Ushicilelo lukawonke-wonke kunye nexwebhu leMbali
 Comment[zh_CN]=Web 归档
+Comment[zh_TW]=Web 壓縮文件
 Comment[zu]=Ushicilelo layoyonke imiqulu ye Web
 Icon=www
 Type=MimeType
Index: mimetypes/application/vnd.oasis.opendocument.text.desktop
===================================================================
--- mimetypes/application/vnd.oasis.opendocument.text.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/vnd.oasis.opendocument.text.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -59,6 +59,7 @@
 Comment[uz]=OASIS OpenDocument матн ҳужжати
 Comment[vi]=Văn bản OpenDocument OASIS
 Comment[zh_CN]=OASIS OpenDocument 文本
+Comment[zh_TW]=OASIS OpenDocument 文字
 [Property::X-KDE-NativeExtension]
 Type=QString
 Value=.odt
Index: mimetypes/application/vnd.oasis.opendocument.text-template.desktop
===================================================================
--- mimetypes/application/vnd.oasis.opendocument.text-template.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/vnd.oasis.opendocument.text-template.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -28,7 +28,7 @@
 Comment[hu]=OASIS-dokumentumsablon
 Comment[is]=OASIS OpenDocument textasnið
 Comment[it]=Modello di documento di testo OASIS OpenDocument
-Comment[ja]=OASIS OpenDocument テキストテンプレート
+Comment[ja]=OASIS OpenDocument テキスト テンプレート
 Comment[km]=ពុម្ព​អត្ថបទ OASIS OpenDocument
 Comment[lb]=OASIS-OpenDocument-Textvirlag
 Comment[lt]=OASIS OpenDocument teksto dokumento šablonas
@@ -59,6 +59,7 @@
 Comment[uz]=OASIS OpenDocument матн ҳужжати намунаси
 Comment[vi]=Biểu mẫu văn bản OpenDocument OASIS
 Comment[zh_CN]=OASIS OpenDocument 文本文档模板
+Comment[zh_TW]=OASIS OpenDocument 文字樣本
 [Property::X-KDE-NativeExtension]
 Type=QString
 Value=.ott
Index: mimetypes/application/vnd.sun.xml.writer.master.desktop
===================================================================
--- mimetypes/application/vnd.sun.xml.writer.master.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/vnd.sun.xml.writer.master.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -58,6 +58,7 @@
 Comment[vi]=Tài liệu văn bản cái OpenOffice.org
 Comment[zh_CN]=OpenOffice.org 主文本文档
 Comment[zh_HK]=OpenOffice.org 主控文字文件
+Comment[zh_TW]=OpenOffice.org Master Text 文件
 MimeType=application/vnd.sun.xml.writer.master
 Type=MimeType
 Icon=wordprocessing
Index: mimetypes/application/vnd.sun.xml.calc.template.desktop
===================================================================
--- mimetypes/application/vnd.sun.xml.calc.template.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/vnd.sun.xml.calc.template.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -60,6 +60,7 @@
 Comment[vi]=Biểu mẫu bảng tính OpenOffice.org
 Comment[zh_CN]=OpenOffice.org 电子表格模板
 Comment[zh_HK]=OpenOffice.org 試算表範本
+Comment[zh_TW]=OpenOffice.org 試算表樣本
 Icon=spreadsheet
 Type=MimeType
 Patterns=*.stc;*.STC;
Index: mimetypes/application/xml-dtd.desktop
===================================================================
--- mimetypes/application/xml-dtd.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/xml-dtd.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -39,6 +39,7 @@
 Comment[ro]=Document DTD XML
 Comment[ru]=Документ DTD XML
 Comment[se]=XML-DTD-dokumeanta
+Comment[sk]=XML DTD dokument
 Comment[sl]=Dokument XML DTD
 Comment[sr]=XML DTD документ
 Comment[sr@Latn]=XML DTD dokument
@@ -49,6 +50,7 @@
 Comment[vi]=Tài liệu DTD XML
 Comment[zh_CN]=XML DTD 文档
 Comment[zh_HK]=XML DTD 文件
+Comment[zh_TW]=XML DTD 文件
 Icon=html
 Type=MimeType
 # RFC 3023
Index: mimetypes/application/vnd.sun.xml.writer.template.desktop
===================================================================
--- mimetypes/application/vnd.sun.xml.writer.template.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/vnd.sun.xml.writer.template.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -27,7 +27,7 @@
 Comment[hu]=OpenOffice.org szöveges dokumentumsablon
 Comment[is]=OpenOffice.org textaskjalssniðmát
 Comment[it]=Modello di documento di testo OpenOffice.org
-Comment[ja]=OpenOffice.org テキストドキュメントテンプレート
+Comment[ja]=OpenOffice.org テキストドキュメント テンプレート
 Comment[km]=ពុម្ព​ឯកសារ​អត្ថបទ OpenOffice.org
 Comment[ko]=OpenOffice.org 글월 문서 본
 Comment[lb]=OpenOffice.org-Textdokumentvirlag
@@ -61,6 +61,7 @@
 Comment[vi]=Biểu mẫu tài liệu văn bản OpenOffice.org
 Comment[zh_CN]=OpenOffice.org 文本文档模板
 Comment[zh_HK]=OpenOffice.org 文字文件範本
+Comment[zh_TW]=OpenOffice.org Text 文件樣本
 MimeType=application/vnd.sun.xml.writer.template
 Type=MimeType
 Icon=wordprocessing
Index: mimetypes/application/vnd.oasis.opendocument.presentation-template.desktop
===================================================================
--- mimetypes/application/vnd.oasis.opendocument.presentation-template.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/vnd.oasis.opendocument.presentation-template.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -28,7 +28,7 @@
 Comment[hu]=OASIS-bemutatósablon
 Comment[is]=OASIS OpenDocument kynningarsnið
 Comment[it]=Modello di presentazione OASIS OpenDocument
-Comment[ja]=OASIS OpenDocument プレゼンテーションテンプレート
+Comment[ja]=OASIS OpenDocument プレゼンテーション テンプレート
 Comment[km]=ពុម្ព​ការបង្ហាញ OASIS OpenDocument
 Comment[lb]=OASIS-OpenDocument-Präsentatiounsvirlag
 Comment[lt]=OASIS OpenDocument pateikčių šablonas
@@ -60,6 +60,7 @@
 Comment[vi]=Biểu mẫu trình diễn OpenDocument OASIS
 Comment[zh_CN]=OASIS OpenDocument 演示文稿模板
 Comment[zh_HK]=OASIS OpenDocument 簡報範本
+Comment[zh_TW]=OASIS OpenDocument 簡報樣本
 [Property::X-KDE-NativeExtension]
 Type=QString
 Value=.otp
Index: mimetypes/application/x-mimearchive.desktop
===================================================================
--- mimetypes/application/x-mimearchive.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/x-mimearchive.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -54,6 +54,7 @@
 Comment[uk]=Архів Тенет з інформацією про mine
 Comment[vi]=Bản nén Mạng đã bao bọc MIME
 Comment[zh_CN]=MIME 封装的 Web 归档
+Comment[zh_TW]=Mime 封裝 Web 壓縮
 
 [Property::X-KDE-LocalProtocol]
 Type=QString
Index: mimetypes/application/x-ica.desktop
===================================================================
--- mimetypes/application/x-ica.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/x-ica.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -57,6 +57,7 @@
 Comment[vi]=Cấu hình ứng dụng khách ICA Citrix
 Comment[zh_CN]=Citrix ICA 客户配置
 Comment[zh_HK]=Citrix ICA 客戶端組態
+Comment[zh_TW]=Citrix ICA 客戶端設定
 Icon=wordprocessing
 Type=MimeType
 Patterns=*.ica;*.ICA;
Index: mimetypes/application/x-java-jnlp-file.desktop
===================================================================
--- mimetypes/application/x-java-jnlp-file.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/x-java-jnlp-file.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -39,6 +39,7 @@
 Comment[ru]=Приложение Java Web Start
 Comment[rw]=Porogaramu Gutangira Urubuga Java
 Comment[se]=Java Web Start-prográmma
+Comment[sk]=Java Web Start aplikácia
 Comment[sl]=Javanski program Web Start
 Comment[sr]=Java Web Start примена
 Comment[sr@Latn]=Java Web Start primena
@@ -51,4 +52,5 @@
 Comment[vi]=Ứng dụng Web Start Java
 Comment[zh_CN]=Java Web Start 应用程序
 Comment[zh_HK]=Java Web Start 程式
+Comment[zh_TW]=Java Web Start 應用程式
 MimeType=application/x-java-jnlp-file
Index: mimetypes/application/x-perl.desktop
===================================================================
--- mimetypes/application/x-perl.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/x-perl.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -58,6 +58,7 @@
 Comment[vi]=Chương trình Perl
 Comment[zh_CN]=Perl 程序
 Comment[zh_HK]=Perl 程式
+Comment[zh_TW]=PERL 程式
 Icon=source_pl
 Type=MimeType
 MimeType=application/x-perl
Index: mimetypes/application/vnd.oasis.opendocument.graphics-template.desktop
===================================================================
--- mimetypes/application/vnd.oasis.opendocument.graphics-template.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/vnd.oasis.opendocument.graphics-template.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -28,7 +28,7 @@
 Comment[hu]=OASIS-ábrasablon
 Comment[is]=OASIS OpenDocument grafísksnið
 Comment[it]=Modello di disegno OASIS OpenDocument
-Comment[ja]=OASIS OpenDocument 図形描画テンプレート
+Comment[ja]=OASIS OpenDocument 図形描画 テンプレート
 Comment[km]=ពុម្ព​ក្រាហ្វិក OASIS OpenDocument
 Comment[lb]=OASIS-OpenDocument-Grafikvirlag
 Comment[lt]=OASIS OpenDocument grafikos šablonas
@@ -60,6 +60,7 @@
 Comment[vi]=Biểu mẩu đồ họa OpenDocument OASIS
 Comment[zh_CN]=OASIS OpenDocument 图形模板
 Comment[zh_HK]=OASIS OpenDocument 繪圖範本
+Comment[zh_TW]=OASIS OpenDocument 圖形樣本
 [Property::X-KDE-NativeExtension]
 Type=QString
 Value=.otg
Index: mimetypes/application/vnd.oasis.opendocument.presentation.desktop
===================================================================
--- mimetypes/application/vnd.oasis.opendocument.presentation.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/vnd.oasis.opendocument.presentation.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -60,6 +60,7 @@
 Comment[vi]=Trình diễn OpenDocument OASIS
 Comment[zh_CN]=OASIS OpenDocument 演示文稿
 Comment[zh_HK]=OASIS OpenDocument 簡報
+Comment[zh_TW]=OASIS OpenDocument 簡報
 [Property::X-KDE-NativeExtension]
 Type=QString
 Value=.odp
Index: mimetypes/application/x-xliff.desktop
===================================================================
--- mimetypes/application/x-xliff.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/x-xliff.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -60,6 +60,7 @@
 Comment[vi]=Tập tin dịch XLIFF
 Comment[zh_CN]=XLIFF 翻译文件
 Comment[zh_HK]=XLIFF 翻譯檔
+Comment[zh_TW]=XLIFF 翻譯檔
 [Property::X-KDE-NativeExtension]
 Type=QString
 Value=.xlf
Index: mimetypes/application/vnd.oasis.opendocument.image.desktop
===================================================================
--- mimetypes/application/vnd.oasis.opendocument.image.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/vnd.oasis.opendocument.image.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -59,6 +59,7 @@
 Comment[uz]=OASIS OpenDocument расм
 Comment[vi]=Ảnh OpenDocument OASIS
 Comment[zh_CN]=OASIS OpenDocument 图像
+Comment[zh_TW]=OASIS OpenDocument 影像
 [Property::X-KDE-NativeExtension]
 Type=QString
 Value=.odi
Index: mimetypes/application/vnd.sun.xml.impress.template.desktop
===================================================================
--- mimetypes/application/vnd.sun.xml.impress.template.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/vnd.sun.xml.impress.template.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -27,7 +27,7 @@
 Comment[hu]=OpenOffice.org-bemutatósablon
 Comment[is]=OpenOffice.org kynningarsniðmát
 Comment[it]=Modello di presentazione OpenOffice.org
-Comment[ja]=OpenOffice.org プレゼンテーションテンプレート
+Comment[ja]=OpenOffice.org プレゼンテーション テンプレート
 Comment[km]=ពុម្ព​ការ​បង្ហាញ OpenOffice.org
 Comment[ko]=OpenOffice.org 프리젠테이션 본
 Comment[lb]=OpenOffice.org-Präsentatiounsvirlag
@@ -61,6 +61,7 @@
 Comment[vi]=Biểu mẫu trình diễn OpenOffice.org
 Comment[zh_CN]=OpenOffice.org 演示文稿模板
 Comment[zh_HK]=OpenOffice.org 簡報範本
+Comment[zh_TW]=OpenOffice.org 簡報樣本
 MimeType=application/vnd.sun.xml.impress.template
 Type=MimeType
 Icon=presentation
Index: mimetypes/application/vnd.stardivision.math.desktop
===================================================================
--- mimetypes/application/vnd.stardivision.math.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/vnd.stardivision.math.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -64,6 +64,7 @@
 Comment[vi]=Tài liệu Math của StarOffice
 Comment[zh_CN]=StarOffice Math 文档
 Comment[zh_HK]=StarOffice 算式文件
+Comment[zh_TW]=StarOffice 數學文件
 [Property::X-KDE-NativeExtension]
 Type=QString
 Value=.sdf
Index: mimetypes/application/x-iso.desktop
===================================================================
--- mimetypes/application/x-iso.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/x-iso.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -61,3 +61,4 @@
 Comment[vi]=Tập tin ảnh ISO9660
 Comment[zh_CN]=ISO9660 映像文件
 Comment[zh_HK]=ISO9660 影像檔
+Comment[zh_TW]=ISO9660 映像檔案
Index: mimetypes/application/Makefile.am
===================================================================
--- mimetypes/application/Makefile.am	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/Makefile.am	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -66,7 +66,8 @@
 	vnd.oasis.opendocument.chart.desktop \
 	x-java-jnlp-file.desktop xml-dtd.desktop fits.desktop \
 	x-rar-compressed.desktop \
-	x-sqlite2.desktop x-sqlite3.desktop chm.desktop
+	x-sqlite2.desktop x-sqlite3.desktop chm.desktop \
+	x-mplayer2.desktop
 
 mimetypeapplicationdatadir = $(kde_mimedir)/application
 
Index: mimetypes/application/x-bz2dvi.desktop
===================================================================
--- mimetypes/application/x-bz2dvi.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/x-bz2dvi.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -58,6 +58,7 @@
 Comment[vi]=Tập tin DVI đã nén Bzip2
 Comment[zh_CN]=Bzip2 压缩的 DVI 文件
 Comment[zh_HK]=Bzip2 格式壓縮的 DVI 檔案
+Comment[zh_TW]=Bzip2 壓縮的 DVI 檔案
 Hidden=false
 Icon=tgz
 MimeType=application/x-bz2dvi
Index: mimetypes/application/x-7z.desktop
===================================================================
--- mimetypes/application/x-7z.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/x-7z.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -61,3 +61,4 @@
 Comment[vi]=Bản nén 7-Zip
 Comment[zh_CN]=7-Zip 归档
 Comment[zh_HK]=7-Zip 壓縮檔
+Comment[zh_TW]=7-Zip 壓縮文件
Index: mimetypes/application/x-msaccess.desktop
===================================================================
--- mimetypes/application/x-msaccess.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/x-msaccess.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -49,7 +49,7 @@
 Comment[nn]=Microsoft Access-database
 Comment[pa]=Microsoft Access ਡਾਟਾਬੇਸ
 Comment[pl]=Baza danych Microsoft Access
-Comment[pt]=Base de Dados do Microsoft Office
+Comment[pt]=Base de Dados Microsoft Access
 Comment[pt_BR]=Base de Dados do Microsoft Access
 Comment[ro]=Bază de date Microsoft Access
 Comment[ru]=База данных Microsoft Access
Index: mimetypes/application/x-dvi.desktop
===================================================================
--- mimetypes/application/x-dvi.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/x-dvi.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -33,7 +33,7 @@
 Comment[ja]=TeX Device Independen ファイル
 Comment[km]=ឯកសារ​ឯករាជ្យ​ឧបករណ៍ TeX
 Comment[ko]=텍 장치에서 독립된 파일
-Comment[lb]=Gerät-onofhängeg Datei vun TeX (DVI)
+Comment[lb]=Gerät-onofhängeg Datei vum TeX (DVI)
 Comment[lt]=TeX nepriklausoma nuo įrengimų byla
 Comment[lv]=TeX Iekārtu Neatkarīgs fails
 Comment[mk]=TeX-датотека независна од уред
Index: mimetypes/application/vnd.stardivision.chart.desktop
===================================================================
--- mimetypes/application/vnd.stardivision.chart.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/vnd.stardivision.chart.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -60,6 +60,7 @@
 Comment[uk]=Діаграма StarOffice
 Comment[vi]=Biểu đồ StarOffice
 Comment[zh_CN]=StarOffice 图表
+Comment[zh_TW]=StarOffice 圖表
 [Property::X-KDE-NativeExtension]
 Type=QString
 Value=.sds
Index: mimetypes/application/x-sqlite2.desktop
===================================================================
--- mimetypes/application/x-sqlite2.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/x-sqlite2.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -44,6 +44,7 @@
 Comment[ro]=Fişier bază de date SQLite2
 Comment[ru]=Файл базы SQLite2
 Comment[se]=SQLite2-diehtovuođđofiila
+Comment[sk]=SQLite2 databázový súbor
 Comment[sl]=Datoteka podatkovne zbirke SQLite2
 Comment[sr]=SQLite2 фајл базе података
 Comment[sr@Latn]=SQLite2 fajl baze podataka
@@ -54,3 +55,4 @@
 Comment[vi]=Tập tin cơ sở dữ liệu SQLite2
 Comment[zh_CN]=SQLite2 数据库文件
 Comment[zh_HK]=SQLite2 資料庫檔案
+Comment[zh_TW]=SQLite2 資料庫檔案
Index: mimetypes/application/x-sqlite3.desktop
===================================================================
--- mimetypes/application/x-sqlite3.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/x-sqlite3.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -44,6 +44,7 @@
 Comment[ro]=Fişier bază de date SQLite3
 Comment[ru]=Файл базы SQLite3
 Comment[se]=SQLite3-diehtovuođđofiila
+Comment[sk]=SQLite3 databázový súbor
 Comment[sl]=Datoteka podatkovne zbirke SQLite3
 Comment[sr]=SQLite3 фајл базе података
 Comment[sr@Latn]=SQLite3 fajl baze podataka
@@ -54,3 +55,4 @@
 Comment[vi]=Tập tin cơ sở dữ liệu SQLite3
 Comment[zh_CN]=SQLite3 数据库文件
 Comment[zh_HK]=SQLite3 資料庫檔案
+Comment[zh_TW]=SQLite3 資料庫檔案
Index: mimetypes/application/x-perl-module.desktop
===================================================================
--- mimetypes/application/x-perl-module.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/x-perl-module.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -57,6 +57,7 @@
 Comment[vi]=Mô-đun Perl
 Comment[zh_CN]=Perl 模块
 Comment[zh_HK]=Perl 模組
+Comment[zh_TW]=Perl 模組
 Icon=source_pl
 Type=MimeType
 MimeType=application/x-perl-module
Index: mimetypes/application/fits.desktop
===================================================================
--- mimetypes/application/fits.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/fits.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -36,6 +36,7 @@
 Comment[ro]=Date FITS
 Comment[ru]=Данные FITS
 Comment[se]=FITS-dáhtat
+Comment[sk]=FITS dáta
 Comment[sl]=Podatki FITS
 Comment[sr]=FITS подаци
 Comment[sr@Latn]=FITS podaci
@@ -45,6 +46,7 @@
 Comment[uz]=FITS маълумот
 Comment[zh_CN]=FITs 数据
 Comment[zh_HK]=FITS 資料
+Comment[zh_TW]=FITS 資料
 Icon=binary
 # Note: application/fits is for any kind of FITS, so also for non-images
 ### TODO: what file pattern, especially that image/fits has the same
Index: mimetypes/application/vnd.oasis.opendocument.spreadsheet.desktop
===================================================================
--- mimetypes/application/vnd.oasis.opendocument.spreadsheet.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/vnd.oasis.opendocument.spreadsheet.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -60,6 +60,7 @@
 Comment[vi]=Bảng tính OpenDocument OASIS
 Comment[zh_CN]=OASIS OpenDocument 电子表格
 Comment[zh_HK]=OASIS OpenDocument 試算表
+Comment[zh_TW]=OASIS OpenDocument 試算表
 [Property::X-KDE-NativeExtension]
 Type=QString
 Value=.ods
Index: mimetypes/application/x-javascript.desktop
===================================================================
--- mimetypes/application/x-javascript.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/x-javascript.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -63,6 +63,7 @@
 Comment[vi]=Tập tin JavaScript
 Comment[zh_CN]=JavaScript 文件
 Comment[zh_HK]=JavaScript 檔案
+Comment[zh_TW]=JavaScript 檔案
 X-KDE-IsAlso=application/x-executable-script
 
 [Property::X-KDE-text]
Index: mimetypes/application/vnd.sun.xml.impress.desktop
===================================================================
--- mimetypes/application/vnd.sun.xml.impress.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/vnd.sun.xml.impress.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -67,6 +67,7 @@
 Comment[wa]=Documint di prezintaedje OpenOffice.org
 Comment[zh_CN]=OpenOffice.org 演示文稿
 Comment[zh_HK]=OpenOffice.org 簡報
+Comment[zh_TW]=OpenOffice.org 簡報
 MimeType=application/vnd.sun.xml.impress
 Type=MimeType
 Icon=presentation
Index: mimetypes/application/x-executable-script.desktop
===================================================================
--- mimetypes/application/x-executable-script.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/x-executable-script.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -58,6 +58,7 @@
 Comment[vi]=Tập lệnh (có lẽ có khả năng thực hiện)
 Comment[zh_CN]=脚本(可能可执行)
 Comment[zh_HK]=Script (可能是可執行檔)
+Comment[zh_TW]=文稿（可能可執行）
 Icon=exec
 Type=MimeType
 MimeType=application/x-executable-script
Index: mimetypes/application/x-lzop.desktop
===================================================================
--- mimetypes/application/x-lzop.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/x-lzop.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -47,7 +47,7 @@
 Comment[ms]=Fail Lzopped
 Comment[mt]=Fajl Lzop
 Comment[nb]=Lzoppet fil
-Comment[nds]=Datei, de mit lzop komprimeert is
+Comment[nds]=Mit "lzop" komprimeert Datei
 Comment[nl]=Lzop-bestand
 Comment[nn]=Lzoppa fil
 Comment[nso]=Faele ya Lzopped
Index: mimetypes/application/vnd.oasis.opendocument.graphics.desktop
===================================================================
--- mimetypes/application/vnd.oasis.opendocument.graphics.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/vnd.oasis.opendocument.graphics.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -60,6 +60,7 @@
 Comment[vi]=Đồ họa OpenDocument OASIS
 Comment[zh_CN]=OASIS OpenDocument 图形
 Comment[zh_HK]=OASIS OpenDocument 繪圖
+Comment[zh_TW]=OASIS OpenDocument 圖形
 [Property::X-KDE-NativeExtension]
 Type=QString
 Value=.odg
Index: mimetypes/application/x-kudesigner.desktop
===================================================================
--- mimetypes/application/x-kudesigner.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/x-kudesigner.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -32,7 +32,7 @@
 Comment[hu]=Kugar-jelentéssablon
 Comment[is]=Kugar skýrslusnið
 Comment[it]=Modello di rapporti Kugar
-Comment[ja]=Kugar リポートテンプレート
+Comment[ja]=Kugar リポート テンプレート
 Comment[km]=ពុម្ព​របាយការណ៍ Kugar
 Comment[lb]=Kugar-Report-Virlag
 Comment[lt]=Kugar ataskaitų byla
Index: mimetypes/application/vnd.oasis.opendocument.formula.desktop
===================================================================
--- mimetypes/application/vnd.oasis.opendocument.formula.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/vnd.oasis.opendocument.formula.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -60,6 +60,7 @@
 Comment[vi]=Công thức OpenDocument OASIS
 Comment[zh_CN]=OASIS OpenDocument 公式
 Comment[zh_HK]=OASIS OpenDocument 算式
+Comment[zh_TW]=OASIS OpenDocument 公式
 [Property::X-KDE-NativeExtension]
 Type=QString
 Value=.odf
Index: mimetypes/application/vnd.stardivision.writer-global.desktop
===================================================================
--- mimetypes/application/vnd.stardivision.writer-global.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/vnd.stardivision.writer-global.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -63,6 +63,7 @@
 Comment[vi]=Tài liệu cái Writer của StarOffice
 Comment[zh_CN]=StarOffice Writer 主文档
 Comment[zh_HK]=StarOffice Writer 主控文件
+Comment[zh_TW]=StarOffice Writer Master 文件
 [Property::X-KDE-NativeExtension]
 Type=QString
 Value=.sgl
Index: mimetypes/application/x-pak.desktop
===================================================================
--- mimetypes/application/x-pak.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/x-pak.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -62,3 +62,4 @@
 Comment[vi]=Bản nén tập tin PAK
 Comment[zh_CN]=PAK 文件归档
 Comment[zh_HK]=PAK 壓縮檔
+Comment[zh_TW]=PAK 檔案壓縮
Index: mimetypes/application/vnd.sun.xml.draw.desktop
===================================================================
--- mimetypes/application/vnd.sun.xml.draw.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/vnd.sun.xml.draw.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -65,7 +65,7 @@
 Comment[wa]=Documint di dessinaedje OpenOffice.org
 Comment[zh_CN]=OpenOffice.org 绘图
 Comment[zh_HK]=OpenOffice.org 繪圖
-Comment[zh_TW]=StarOffice.org 繪圖
+Comment[zh_TW]=OpenOffice.org 繪圖
 MimeType=application/vnd.sun.xml.draw
 Type=MimeType
 Icon=image
Index: mimetypes/application/x-vnd.kde.kplato.desktop
===================================================================
--- mimetypes/application/x-vnd.kde.kplato.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/x-vnd.kde.kplato.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -59,6 +59,7 @@
 Comment[vi]=Tài liệu quản lý dự án KPlato
 Comment[zh_CN]=KPlato 项目管理文档
 Comment[zh_HK]=KPlato 計畫管理文件
+Comment[zh_TW]=KPlato 專案管理文件
 Type=MimeType
 Patterns=*.kplato;*.kplatot;
 X-KDE-AutoEmbed=false
Index: mimetypes/application/x-gzdvi.desktop
===================================================================
--- mimetypes/application/x-gzdvi.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/x-gzdvi.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -58,6 +58,7 @@
 Comment[vi]=Tập tin DVI đã nén Gzip
 Comment[zh_CN]=Gzip 压缩的 DVI 文件
 Comment[zh_HK]=Gzip 格式壓縮的 DVI 檔案
+Comment[zh_TW]=Gzip 壓縮的 DVI 檔案
 Hidden=false
 Icon=tgz
 MimeType=application/x-gzdvi
Index: mimetypes/application/vnd.stardivision.draw.desktop
===================================================================
--- mimetypes/application/vnd.stardivision.draw.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/vnd.stardivision.draw.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -64,6 +64,7 @@
 Comment[vi]=Bản vẽ StarOffice
 Comment[zh_CN]=StarOffice 绘图
 Comment[zh_HK]=StarOffice 繪圖
+Comment[zh_TW]=StarOffice 繪圖
 [Property::X-KDE-NativeExtension]
 Type=QString
 Value=.sda
Index: mimetypes/application/vnd.sun.xml.draw.template.desktop
===================================================================
--- mimetypes/application/vnd.sun.xml.draw.template.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/vnd.sun.xml.draw.template.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -27,7 +27,7 @@
 Comment[hu]=OpenOffice.org-rajzsablon
 Comment[is]=OpenOffice.org teikningarsniðmát
 Comment[it]=Modello di disegno OpenOffice.org
-Comment[ja]=OpenOffice.org 図形描画テンプレート
+Comment[ja]=OpenOffice.org 図形描画 テンプレート
 Comment[km]=ពុម្ព​គំនូរ OpenOffice.org
 Comment[ko]=OpenOffice.org 그림 본
 Comment[lb]=OpenOffice.org-Zeechnungsvirlag
@@ -61,6 +61,7 @@
 Comment[vi]=Biểu mẫu vẽ OpenOffice.org
 Comment[zh_CN]=OpenOffice.org 绘图模板
 Comment[zh_HK]=OpenOffice.org 繪圖範本
+Comment[zh_TW]=OpenOffice.org 繪圖樣本
 MimeType=application/vnd.sun.xml.draw.template
 Type=MimeType
 Icon=image
Index: mimetypes/application/vnd.oasis.opendocument.chart.desktop
===================================================================
--- mimetypes/application/vnd.oasis.opendocument.chart.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/vnd.oasis.opendocument.chart.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -28,7 +28,7 @@
 Comment[hu]=OASIS-grafikon
 Comment[is]=OASIS OpenDocument graf
 Comment[it]=Diagramma OASIS OpenDocument
-Comment[ja]=OpenDocument チャート
+Comment[ja]=OASIS OpenDocument チャート
 Comment[km]=គំនូសតាង OASIS OpenDocument
 Comment[lb]=OASIS-OpenDocument-Diagramm
 Comment[lt]=OASIS OpenDocument grafikas
@@ -58,6 +58,7 @@
 Comment[uk]=Діаграма OASIS OpenDocument
 Comment[vi]=Biểu đồ OpenDocument OASIS
 Comment[zh_CN]=OASIS OpenDocument 图表
+Comment[zh_TW]=OASIS OpenDocument 圖表
 [Property::X-KDE-NativeExtension]
 Type=QString
 Value=.odc
Index: mimetypes/application/mbox.desktop
===================================================================
--- mimetypes/application/mbox.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/application/mbox.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -36,6 +36,7 @@
 Comment[pt_BR]=Pasta de Correio MBOX
 Comment[ro]=Folder de mail MBOX
 Comment[ru]=Почтовая папка MBOX
+Comment[sk]=MBOX poštový priečinok
 Comment[sl]=Mapa za pošto MBOX
 Comment[sr]=MBOX фасцикла поште
 Comment[sr@Latn]=MBOX fascikla pošte
@@ -45,6 +46,7 @@
 Comment[uz]=MBOX хат қутиси
 Comment[vi]=Thư mục thư dạng .mbox.
 Comment[zh_CN]=MBOX 邮件文件夹
+Comment[zh_TW]=MBOX 郵件資料夾
 
 [Property::X-KDE-text]
 Type=bool
Index: mimetypes/text/x-objchdr.desktop
===================================================================
--- mimetypes/text/x-objchdr.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/text/x-objchdr.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -56,6 +56,7 @@
 Comment[vi]=Tập tin phần đầu Objective-C
 Comment[zh_CN]=Objective-C 头文件
 Comment[zh_HK]=Objective-C 標頭檔
+Comment[zh_TW]=Objective-C 標頭檔
 Icon=source_h
 Type=MimeType
 MimeType=text/x-objchdr
Index: mimetypes/text/javascript.desktop
===================================================================
--- mimetypes/text/javascript.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/text/javascript.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -62,4 +62,5 @@
 Comment[vi]=Tập tin JavaScript
 Comment[zh_CN]=JavaScript 文件
 Comment[zh_HK]=JavaScript 檔案
+Comment[zh_TW]=JavaScript 檔案
 X-KDE-IsAlso=application/x-javascript
Index: mimetypes/text/vnd.abc.desktop
===================================================================
--- mimetypes/text/vnd.abc.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/text/vnd.abc.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -57,6 +57,7 @@
 Comment[vi]=Tập tin âm nhạc ABC
 Comment[zh_CN]=ABC 音乐文件
 Comment[zh_HK]=ABC 音樂原始檔
+Comment[zh_TW]=ABC 音樂檔
 Icon=sound
 Type=MimeType
 MimeType=text/vnd.abc
Index: mimetypes/text/x-hex.desktop
===================================================================
--- mimetypes/text/x-hex.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ mimetypes/text/x-hex.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -58,3 +58,4 @@
 Comment[uk]=Файл в форматі Intel® Hexadecimal Object
 Comment[vi]=Dạng thức tập tin đối tượng thập lục Intel®
 Comment[zh_CN]=Intel® 十六进制目标文件
+Comment[zh_TW]=Intel® 十六進位目的檔案格式
Index: kioslave/http/kcookiejar/kcookiejar.desktop
===================================================================
--- kioslave/http/kcookiejar/kcookiejar.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kioslave/http/kcookiejar/kcookiejar.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -126,6 +126,7 @@
 Comment[uz]=Тизимдаги ҳамма кукиларни кузатади
 Comment[vi]=Theo dõi các tập tin cookie trong hệ thống.
 Comment[zh_CN]=将全部 cookies 的记录保存在系统中
+Comment[zh_TW]=追蹤系統所有的 cookies
 ServiceTypes=KDEDModule
 Exec=kcookiejar
 X-DCOP-ServiceType=Unique
Index: kioslave/http/http.cc
===================================================================
--- kioslave/http/http.cc	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kioslave/http/http.cc	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -399,12 +399,12 @@
   m_remoteConnTimeout = connectTimeout();
   m_remoteRespTimeout = responseTimeout();
 
+  // Set the SSL meta-data here...
+  setSSLMetaData();
+
   // Bounce back the actual referrer sent
   setMetaData("referrer", m_request.referrer);
 
-  // Set the SSL meta-data here...
-  setSSLMetaData();
-
   // Follow HTTP/1.1 spec and enable keep-alive by default
   // unless the remote side tells us otherwise or we determine
   // the persistent link has been terminated by the remote end.
Index: kinit/klauncher.cpp
===================================================================
--- kinit/klauncher.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kinit/klauncher.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -1307,7 +1307,7 @@
        if (!mSlaveValgrindSkin.isEmpty()) {
            arg_list.prepend(QCString("--tool=") + mSlaveValgrindSkin);
        } else
-	   arg_list.prepend("--tool=addrcheck");
+	   arg_list.prepend("--tool=memcheck");
     }
 
     KLaunchRequest *request = new KLaunchRequest;
Index: kimgio/rgb.kimgio
===================================================================
--- kimgio/rgb.kimgio	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kimgio/rgb.kimgio	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -64,6 +64,7 @@
 Name[vi]=Ảnh SGI (RGB)
 Name[zh_CN]=SGI 图像(RGB)
 Name[zh_HK]=SGI 圖檔 (RGB)
+Name[zh_TW]=SGI 影像（RGB）
 Read=true
 Write=true
 Suffices=rgb,RGB,rgba,RGBA,bw,BW,sgi,SGI
Index: kimgio/hdr.kimgio
===================================================================
--- kimgio/hdr.kimgio	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kimgio/hdr.kimgio	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -35,6 +35,7 @@
 Name[ro]=Imagine cu domeniu dinamic larg
 Name[ru]=Рисунок HDR
 Name[se]=Govva mas lea stuorra dynámalaš gaskkadat
+Name[sk]=High Dynamic Range obrázok
 Name[sl]=Slika z visokim dinamičnim razponom
 Name[sr]=Слика високог динамичког опсега
 Name[sr@Latn]=Slika visokog dinamičkog opsega
Index: kimgio/bmp.kimgio
===================================================================
--- kimgio/bmp.kimgio	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kimgio/bmp.kimgio	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -71,6 +71,7 @@
 Name[wa]=Imådje BMP
 Name[zh_CN]=BMP 图像
 Name[zh_HK]=點陣圖
+Name[zh_TW]=BMP 影像
 Read=true
 Write=true
 Suffices=bmp,BMP
Index: kimgio/xcf.kimgio
===================================================================
--- kimgio/xcf.kimgio	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kimgio/xcf.kimgio	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -59,6 +59,7 @@
 Name[vi]=Ảnh GIMP
 Name[zh_CN]=GIMP 图像
 Name[zh_HK]=GIMP 圖檔
+Name[zh_TW]=GIMP 影像
 Read=true
 Write=false
 Suffices=xcf,XCF
Index: kimgio/mng.kimgio
===================================================================
--- kimgio/mng.kimgio	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kimgio/mng.kimgio	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -60,6 +60,7 @@
 Name[vi]=Ảnh MNG
 Name[zh_CN]=MNG 图像
 Name[zh_HK]=MNG 圖檔
+Name[zh_TW]=MNG 影像
 Read=true
 Write=false
 Suffices=mng,MNG
Index: kimgio/psd.kimgio
===================================================================
--- kimgio/psd.kimgio	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kimgio/psd.kimgio	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -27,6 +27,7 @@
 Name[km]= រូបភាព​របស់ Adobe Photoshop
 Name[lb]=Adobe-Photoshop-Bild
 Name[lt]=Adobe Photoshop paveiksliukas
+Name[mk]=Adobe Photoshop-слика
 Name[ms]=Imej Adobe Photoshop
 Name[nb]=Adobe Photoshop-bilde
 Name[nds]=Adobe-Photoshop-Bild
@@ -38,6 +39,7 @@
 Name[pt_BR]=Imagem do Adobe Photoshop
 Name[ro]=Imagine Adobe Photoshop
 Name[ru]=Рисунок Adobe Photoshop
+Name[sk]=Adobe Photoshop obrázok
 Name[sl]=Slika Adobe Photoshop
 Name[sr]=Слика Adobe-овог Photoshop-а
 Name[sr@Latn]=Slika Adobe-ovog Photoshop-a
@@ -48,6 +50,7 @@
 Name[vi]=Ảnh Photoshop của Adobe
 Name[zh_CN]=Adobe Photoshop 图像
 Name[zh_HK]=Adobe Photoshop 圖檔
+Name[zh_TW]=Adobe Photoshop 影像
 Read=true
 Write=false
 Suffices=psd,PSD
Index: kimgio/configure.in.in
===================================================================
--- kimgio/configure.in.in	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kimgio/configure.in.in	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -1,69 +1,3 @@
-AC_DEFUN([AC_FIND_LIBEXR],
-[
-AC_REQUIRE([KDE_CHECK_EXTRA_LIBS])
-AC_REQUIRE([AC_FIND_ZLIB])
-AC_CACHE_VAL(ac_cv_libexr,
-[
-  if test -z "$PKG_CONFIG"; then
-    AC_PATH_PROG(PKG_CONFIG, pkg-config, no)
-  fi
-
-  AC_MSG_CHECKING([for OpenEXR libraries])
-
-  if test "$PKG_CONFIG" = "no" ; then
-     AC_MSG_RESULT(no)
-     echo "*** The pkg-config script could not be found. Make sure it is"
-     echo "*** in your path, or set the PKG_CONFIG environment variable"
-     echo "*** to the full path to pkg-config."
-     echo "*** Or see http://www.freedesktop.org/software/pkgconfig to get pkg-config."
-  else
-     if !(`$PKG_CONFIG --exists OpenEXR`) ; then
-        AC_MSG_RESULT(no)
-        EXRSTATUS=no
-     else
-        if !(`$PKG_CONFIG --atleast-version="1.1.1" OpenEXR`) ; then
-           AC_MSG_RESULT(no)
-           EXRSTATUS=old
-        else
-           kde_save_LIBS="$LIBS"
-           LIBS="$LIBS $all_libraries $USER_LDFLAGS $LIBZ `pkg-config --libs OpenEXR`"
-           AC_LANG_SAVE
-           AC_LANG_CPLUSPLUS
-           kde_save_CXXFLAGS="$CXXFLAGS"
-           EXR_FLAGS=`$PKG_CONFIG --cflags OpenEXR`
-           CXXFLAGS="$CXXFLAGS $all_includes $USER_INCLUDES $EXR_FLAGS"
-
-           AC_TRY_LINK(dnl
-               [
-               #include <ImfRgbaFile.h>
-               ],
-               [
-               using namespace Imf;
-               RgbaInputFile file ("dummy");
-               return 0;
-               ],
-               eval "ac_cv_libexr='$LIBZ `pkg-config --libs OpenEXR`'",
-               eval "ac_cv_libexr=no"
-           )
-           LIBS="$kde_save_LIBS"
-           CXXFLAGS="$kde_save_CXXFLAGS"
-           AC_LANG_RESTORE
-           ])dnl
-           if eval "test ! \"`echo $ac_cv_libexr`\" = no"; then
-               AC_DEFINE_UNQUOTED(HAVE_EXR, 1, [Define if you have OpenEXR])
-               LIB_EXR="$ac_cv_libexr"
-               AC_MSG_RESULT($ac_cv_libexr)
-           else
-               AC_MSG_RESULT(no)
-               LIB_EXR=""
-           fi
-        fi
-     fi
-  fi
-  AC_SUBST(LIB_EXR)
-  AC_SUBST(EXR_FLAGS)
-])
-
 AC_ARG_WITH(tiff,AC_HELP_STRING([--with-tiff],[Enable tiff support [default=check]]),[tiff_test="$withval"],[tiff_test="yes"])
 
 if test "x$tiff_test" = "xyes" ; then
@@ -82,7 +16,7 @@
 AC_ARG_WITH(openexr,AC_HELP_STRING([--with-openexr],[Enable openexr support [default=check]]),[openexr_test="$withval"],[openexr_test="yes"])
 
 if test "x$openexr_test" = "xyes" ; then
-AC_FIND_LIBEXR
+  KDE_FIND_LIBEXR
 fi
 
 AM_CONDITIONAL(include_TIFF_MODULES, test -n "$LIBTIFF")
Index: kimgio/pgm.kimgio
===================================================================
--- kimgio/pgm.kimgio	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kimgio/pgm.kimgio	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -69,6 +69,7 @@
 Name[wa]=Imådje PGM
 Name[zh_CN]=便携灰度图像
 Name[zh_HK]=PGM 圖檔
+Name[zh_TW]=可攜式灰階檔案格式
 Read=true
 Write=true
 Suffices=pgm,PGM,pgmraw,PGMRAW
Index: kimgio/exr.kimgio
===================================================================
--- kimgio/exr.kimgio	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kimgio/exr.kimgio	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -51,6 +51,7 @@
 Name[uk]=Ввід/Вивід для зображень ILM EXR
 Name[vi]=Kimgio ảnh EXR ILM
 Name[zh_CN]=ILM EXR 图像 Kimgio
+Name[zh_TW]=ILM EXR 影像 Kimgio
 Read=true
 Write=false
 Suffices=.exr,.EXR
Index: kio/kio/configure.in.in
===================================================================
--- kio/kio/configure.in.in	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kio/kio/configure.in.in	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -107,7 +107,7 @@
 dnl ------------------------------------------------------------------------
 
 AC_ARG_ENABLE(inotify,
-AC_HELP_STRING([--enable-inotify],[enable use of Linux inode notifications]),
+AC_HELP_STRING([--disable-inotify],[enable use of Linux inode notifications]),
 [ kde_enable_inotify=$enableval ], [kde_enable_inotify=yes])dnl
 
 AC_CHECK_GNU_EXTENSIONS
Index: kio/kio/kdirwatch.cpp
===================================================================
--- kio/kio/kdirwatch.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kio/kio/kdirwatch.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -340,7 +340,7 @@
   kdDebug(7001) << "Available methods: " << available << endl;
 }
 
-/* This should never be called, but doesn't harm */
+/* This is called on app exit (KStaticDeleter) */
 KDirWatchPrivate::~KDirWatchPrivate()
 {
   timer->stop();
@@ -407,9 +407,6 @@
       if ( event->len )
         path = QFile::decodeName( QCString( event->name, event->len ) );
 
-      if ( event->mask & IN_IGNORED )
-        continue;
-
       if ( path.length() && isNoisyFile( path.latin1() ) )
         continue;
 
@@ -428,12 +425,15 @@
             if( event->mask & IN_DELETE_SELF) {
               kdDebug(7001) << "-->got deleteself signal for " << e->path << endl;
               e->m_status = NonExistent;
-              //(void) inotify_rm_watch( m_inotify_fd, e->wd );
-              addEntry(0, QDir::cleanDirPath(e->path+"/.."), e, true);
+              if (e->isDir)
+                addEntry(0, QDir::cleanDirPath(e->path+"/.."), e, true);
+              else
+                addEntry(0, QFileInfo(e->path).dirPath(true), e, true);
             }
+            if ( event->mask & IN_IGNORED ) {
+              e->wd = 0;
+            }
             if ( event->mask & (IN_CREATE|IN_MOVED_TO) ) {
-              kdDebug(7001) << "-->got new subfile " << path << " in " << e->path << endl;
-
               Entry *sub_entry = e->m_entries.first();
               for(;sub_entry; sub_entry = e->m_entries.next())
                 if (sub_entry->path == e->path + "/" + path) break;
@@ -727,7 +727,10 @@
     return true;
 
   if ( e->m_status == NonExistent ) {
-    addEntry(0, QDir::cleanDirPath(e->path+"/.."), e, true);
+    if (e->isDir) 
+      addEntry(0, QDir::cleanDirPath(e->path+"/.."), e, true);
+    else
+      addEntry(0, QFileInfo(e->path).dirPath(true), e, true);
     return true;
   }
 
@@ -782,7 +785,9 @@
        (*it).m_entries.append(sub_entry);
        kdDebug(7001) << "Added already watched Entry " << path
 		     << " (for " << sub_entry->path << ")" << endl;
+
 #ifdef HAVE_DNOTIFY
+     {
        Entry* e = &(*it);
        if( (e->m_mode == DNotifyMode) && (e->dn_fd > 0) ) {
          int mask = DN_DELETE|DN_CREATE|DN_RENAME|DN_MULTISHOT;
@@ -797,8 +802,26 @@
            useStat( e );
          }
        }
+     }
 #endif
+
+#ifdef HAVE_INOTIFY
+     {
+       Entry* e = &(*it);
+       if( (e->m_mode == INotifyMode) && (e->wd > 0) ) {
+         int mask = IN_DELETE|IN_DELETE_SELF|IN_CREATE|IN_MOVE|IN_MOVE_SELF|IN_DONT_FOLLOW;
+         if(!e->isDir)
+           mask |= IN_MODIFY|IN_ATTRIB;
+         else
+           mask |= IN_ONLYDIR;
+
+         inotify_rm_watch (m_inotify_fd, e->wd);
+         e->wd = inotify_add_watch( m_inotify_fd, QFile::encodeName( e->path ), mask);
+       }
     }
+#endif
+ 
+    }
     else {
        (*it).addClient(instance);
        kdDebug(7001) << "Added already watched Entry " << path
@@ -928,8 +951,12 @@
         m_inotify_fd << ", "  << e->wd <<
         ") for " << e->path << endl;
     }
-    else
-      removeEntry( 0, QDir::cleanDirPath( e->path+"/.." ), e );
+    else {
+      if (e->isDir)
+	removeEntry(0, QDir::cleanDirPath(e->path+"/.."), e);
+      else
+	removeEntry(0, QFileInfo(e->path).dirPath(true), e);
+    }
   }
 #endif
 
@@ -1167,15 +1194,6 @@
       return Changed;
     }
 
-#ifdef HAVE_INOTIFY
-    // for inotify we delay the initial stating till the first event in it
-    if ( e->m_status == Normal && e->m_ctime == invalid_ctime )
-    {
-      e->m_ctime = stat_buf.st_ctime;
-      e->m_nlink = stat_buf.st_nlink;
-    }
-#endif
-
     return NoChange;
   }
 
@@ -1278,7 +1296,7 @@
   // removeDir(), when called in slotDirty(), can cause a crash otherwise
   delayRemove = true;
 
-#ifdef HAVE_DNOTIFY
+#if defined(HAVE_DNOTIFY) || defined(HAVE_INOTIFY)
   QPtrList<Entry> dList, cList;
 #endif
 
@@ -1306,6 +1324,16 @@
 
     int ev = scanEntry( &(*it) );
 
+
+#ifdef HAVE_INOTIFY
+    if ((*it).m_mode == INotifyMode && ev == Created && (*it).wd == 0) {
+      cList.append( &(*it) );
+      if (! useINotify( &(*it) )) {
+        useStat( &(*it) );
+      }
+    }
+#endif
+
 #ifdef HAVE_DNOTIFY
     if ((*it).m_mode == DNotifyMode) {
       if ((*it).isDir && (ev == Deleted)) {
@@ -1337,7 +1365,7 @@
   }
 
 
-#ifdef HAVE_DNOTIFY
+#if defined(HAVE_DNOTIFY) || defined(HAVE_INOTIFY)
   // Scan parent of deleted directories for new creation
   Entry* e;
   for(e=dList.first();e;e=dList.next())
@@ -1542,7 +1570,8 @@
 	kdDebug(7001) << "    dependent entries:" << endl;
 	Entry* d = e->m_entries.first();
 	for(;d; d = e->m_entries.next()) {
-	  kdDebug(7001) << "      " << d->path << endl;
+          kdDebug(7001) << "      " << d << endl;
+	  kdDebug(7001) << "      " << d->path << " (" << d << ") " << endl;
 	}
       }
     }
Index: kio/kio/job.cpp
===================================================================
--- kio/kio/job.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kio/kio/job.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -2304,12 +2304,15 @@
             destinationState = bDir ? DEST_IS_DIR : DEST_IS_FILE;
             //kdDebug(7007) << "CopyJob::slotResultStating dest is dir:" << bDir << endl;
         }
-        if ( m_dest == d->m_globalDest )
+        const bool isGlobalDest = m_dest == d->m_globalDest;
+        if ( isGlobalDest )
             d->m_globalDestinationState = destinationState;
 
         if ( !sLocalPath.isEmpty() && kio_resolve_local_urls ) {
             m_dest = KURL();
             m_dest.setPath(sLocalPath);
+            if ( isGlobalDest )
+                d->m_globalDest = m_dest;
         }
 
         subjobs.remove( job );
@@ -2587,6 +2590,10 @@
 
 void CopyJob::statNextSrc()
 {
+    /* Revert to the global destination, the one that applies to all source urls.
+     * Imagine you copy the items a b and c into /d, but /d/b exists so the user uses "Rename" to put it in /foo/b instead.
+     * m_dest is /foo/b for b, but we have to revert to /d for item c and following.
+     */
     m_dest = d->m_globalDest;
     destinationState = d->m_globalDestinationState;
     ++m_currentStatSrc;
Index: kio/kfile/krecentdocument.cpp
===================================================================
--- kio/kfile/krecentdocument.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kio/kfile/krecentdocument.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -141,7 +141,10 @@
     conf.writePathEntry( QString::fromLatin1("URL"), openStr );
     // If you change the line below, change the test in the above loop
     conf.writeEntry( QString::fromLatin1("X-KDE-LastOpenedWith"), desktopEntryName );
-    conf.writeEntry( QString::fromLatin1("Name"), url.fileName() );
+    QString name = url.fileName();
+    if (name.isEmpty())
+      name = openStr;
+    conf.writeEntry( QString::fromLatin1("Name"), name );
     conf.writeEntry( QString::fromLatin1("Icon"), KMimeType::iconForURL( url ) );
 }
 
Index: kio/kfile/kacleditwidget.cpp
===================================================================
--- kio/kfile/kacleditwidget.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kio/kfile/kacleditwidget.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -274,7 +274,7 @@
           idx = KACLListView::OWNER_IDX;
             break;
     }
-    setText( 0, s_itemAttributes[idx].label );
+    setText( 0, i18n(s_itemAttributes[idx].label) );
     setPixmap( 0, *s_itemAttributes[idx].pixmap );
     if ( isDefault )
         setText( 0, text( 0 ) + i18n( " (Default)" ) );
Index: kio/misc/kssld/kssld.desktop
===================================================================
--- kio/misc/kssld/kssld.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kio/misc/kssld/kssld.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -136,3 +136,4 @@
 Comment[vi]=Mô-đun trình nền KSSL cho KDED.
 Comment[zh_CN]=KDED 的 KSSL 守护进程模块
 Comment[zh_HK]=KDED 使用的 SSL 伺服程式模組
+Comment[zh_TW]=KDED 使用的 KSSL 伺服程式模組
Index: kio/misc/mms.protocol
===================================================================
--- kio/misc/mms.protocol	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kio/misc/mms.protocol	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -58,4 +58,5 @@
 Description[vi]=Giao thức trình phục vụ phương tiện Microsoft™.
 Description[zh_CN]=Microsoft 媒体服务器协议
 Description[zh_HK]=Microsoft Media Server 協定
+Description[zh_TW]=Microsoft Media Server 協定
 URIMode=url
Index: kio/misc/kwalletd/kwalletd.desktop
===================================================================
--- kio/misc/kwalletd/kwalletd.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kio/misc/kwalletd/kwalletd.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -127,3 +127,4 @@
 Comment[vi]=Mô-đun trình nền KWallet cho KDED.
 Comment[zh_CN]=KDED 的 KWallet 守护进程模块
 Comment[zh_HK]=KDED 的 KWallet 伺服程式模組
+Comment[zh_TW]=KDED 的 KWallet 服務程式模組
Index: kio/misc/kpac/proxyscout.desktop
===================================================================
--- kio/misc/kpac/proxyscout.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kio/misc/kpac/proxyscout.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -105,6 +105,7 @@
 Comment[vi]=Cấu hình ủy nhiệm tự động.
 Comment[zh_CN]=自动代理配置
 Comment[zh_HK]=自動代理伺服器組態
+Comment[zh_TW]=自動代理組態
 ServiceTypes=KDEDModule
 X-KDE-ModuleType=Library
 X-KDE-Library=proxyscout
Index: kio/kpasswdserver.desktop
===================================================================
--- kio/kpasswdserver.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kio/kpasswdserver.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -131,6 +131,7 @@
 Comment[vi]=Cách hỗ trợ khả năng lưu tạm mật khẩu.
 Comment[zh_CN]=密码缓存支持
 Comment[zh_HK]=密碼暫存支援
+Comment[zh_TW]=密碼暫存(cache)支援
 ServiceTypes=KDEDModule
 X-KDE-ModuleType=Library
 X-KDE-Library=kpasswdserver
Index: kio/kssl/kopenssl.h
===================================================================
--- kio/kssl/kopenssl.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kio/kssl/kopenssl.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -882,6 +882,9 @@
    /* Set the subject */
    int X509_REQ_set_subject_name(X509_REQ*,X509_NAME*);
 
+   /* get list of available SSL_CIPHER's sorted by preference */
+   STACK_OF(SSL_CIPHER) *SSL_get_ciphers(const SSL* ssl);
+
 #endif
 
 private:
Index: kio/kssl/ksslsettings.cc
===================================================================
--- kio/kssl/ksslsettings.cc	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kio/kssl/ksslsettings.cc	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -44,9 +44,18 @@
 #include <openssl/ssl.h>
 #undef crypt
 #endif
-
 #include <kopenssl.h>
 
+#ifdef KSSL_HAVE_SSL
+#define sk_new d->kossl->sk_new
+#define sk_push d->kossl->sk_push
+#define sk_free d->kossl->sk_free
+#define sk_value d->kossl->sk_value
+#define sk_num d->kossl->sk_num
+#define sk_dup d->kossl->sk_dup
+#define sk_pop d->kossl->sk_pop
+#endif
+
       class CipherNode {
       public:
         CipherNode(const char *_name, int _keylen) : 
@@ -123,87 +132,78 @@
 //        since OpenSSL seems to just choose any old thing if it's given an
 //        empty list.  This behavior is not confirmed though.
 QString KSSLSettings::getCipherList() {
-  QString clist;
+	QString clist;
 #ifdef KSSL_HAVE_SSL
-  QString tcipher;
-  bool firstcipher = true;
-  SSL_METHOD *meth = 0L;
-  QSortedList<CipherNode> cipherSort;
+	QString tcipher;
+	bool firstcipher = true;
+	SSL_METHOD *meth = 0L;
+	QPtrList<CipherNode> cipherList;
 
-  cipherSort.setAutoDelete(true);
+	cipherList.setAutoDelete(true);
 
-  if (!d->kossl)
-    d->kossl = KOSSL::self();
+	if (!d->kossl)
+		d->kossl = KOSSL::self();
 
-  if (m_bUseSSLv3) {
-    m_cfg->setGroup("SSLv3");
-    meth = d->kossl->SSLv3_client_method();
-    for(int i = 0; ; i++) {
-      SSL_CIPHER *sc = (meth->get_cipher)(i);
-      if (!sc)
-        break;
-      tcipher.sprintf("cipher_%s", sc->name);
-      int bits = d->kossl->SSL_CIPHER_get_bits(sc, NULL);
+	if (m_bUseSSLv3 && m_bUseSSLv2)
+		meth = d->kossl->SSLv23_client_method();
+	else if(m_bUseSSLv3)
+		meth = d->kossl->SSLv3_client_method();
+	else if (m_bUseSSLv2)
+		meth = d->kossl->SSLv2_client_method();
 
-      if (m_cfg->readBoolEntry(tcipher, bits >= 56)) {
-        CipherNode *xx = new CipherNode(sc->name,bits);
-        if (!cipherSort.contains(xx)) {
-          cipherSort.prepend(xx);
-        } else {
-          delete xx;
-        }
-      }
-    }
-  }
+	SSL_CTX *ctx = d->kossl->SSL_CTX_new(meth);
+	SSL* ssl = d->kossl->SSL_new(ctx);
+	STACK_OF(SSL_CIPHER)* sk = d->kossl->SSL_get_ciphers(ssl);
+	int cnt = sk_SSL_CIPHER_num(sk);
+	for (int i=0; i< cnt; i++) {
+		SSL_CIPHER *sc = sk_SSL_CIPHER_value(sk,i);
+		if (!sc)
+			break;
 
-  if (m_bUseSSLv2) {
-    m_cfg->setGroup("SSLv2");
-    meth = d->kossl->SSLv2_client_method();
+		if(!strcmp("SSLv2", d->kossl->SSL_CIPHER_get_version(sc)))
+			m_cfg->setGroup("SSLv2");
+		else
+			m_cfg->setGroup("SSLv3");
 
-    for(int i = 0; meth; i++) {
-      SSL_CIPHER *sc = (meth->get_cipher)(i);
-      if (!sc)
-        break;
-      tcipher.sprintf("cipher_%s", sc->name);
-      int bits = d->kossl->SSL_CIPHER_get_bits(sc, NULL);
+		tcipher.sprintf("cipher_%s", sc->name);
+		int bits = d->kossl->SSL_CIPHER_get_bits(sc, NULL);
+		if (m_cfg->readBoolEntry(tcipher, bits >= 56)) {
+			CipherNode *xx = new CipherNode(sc->name,bits);
+			if (!cipherList.contains(xx))
+				cipherList.prepend(xx);
+			else
+				delete xx;
+		}
+	}
+	d->kossl->SSL_free(ssl);
+	d->kossl->SSL_CTX_free(ctx);
 
-      if (m_cfg->readBoolEntry(tcipher, bits >= 56)) {
-        CipherNode *xx = new CipherNode(sc->name,bits);
-        if (!cipherSort.contains(xx)) {
-          cipherSort.prepend(xx);
-        } else {
-          delete xx;
-        }
-      }
-    }
-  }
+	// Remove any ADH ciphers as per RFC2246
+	// Also remove NULL ciphers and 168bit ciphers
+	for (unsigned int i = 0; i < cipherList.count(); i++) {
+		CipherNode *j = 0L;
+		while ((j = cipherList.at(i)) != 0L) {
+			if (j->name.contains("ADH-") || j->name.contains("NULL-") || j->name.contains("DES-CBC3-SHA") || j->name.contains("FZA")) {
+				cipherList.remove(j);
+			} else {
+				break;
+			}
+		}
+	} 
 
-  // Remove any ADH ciphers as per RFC2246
-  // Also remove NULL ciphers and 168bit ciphers
-  for (unsigned int i = 0; i < cipherSort.count(); i++) {
-    CipherNode *j = 0L;
-    while ((j = cipherSort.at(i)) != 0L) {
-      if (j->name.contains("ADH-") || j->name.contains("NULL-") || j->name.contains("DES-CBC3-SHA") || j->name.contains("FZA")) {
-        cipherSort.remove(j);
-      } else {
-        break;
-      }
-    }
-  } 
+	// now assemble the list  cipher1:cipher2:cipher3:...:ciphern
+	while (!cipherList.isEmpty()) {
+		if (firstcipher)
+			firstcipher = false;
+		else clist.append(":");
+		clist.append(cipherList.getLast()->name);
+		cipherList.removeLast();
+	} // while
 
-  // now assemble the list  cipher1:cipher2:cipher3:...:ciphern
-  while (!cipherSort.isEmpty()) {
-    if (firstcipher)
-      firstcipher = false;
-    else clist.append(":");
-    clist.append(cipherSort.getLast()->name);
-    cipherSort.removeLast();
-  } // while
+	kdDebug(7029) << "Cipher list is: " << clist << endl;
 
-  kdDebug(7029) << "Cipher list is: " << clist << endl;
-
 #endif
-  return clist;
+	return clist;
 }
 
 // FIXME - sync these up so that we can use them with the control module!!
@@ -344,3 +344,13 @@
 
 QString& KSSLSettings::getEGDPath()       { return d->m_EGDPath; }
 
+#ifdef KSSL_HAVE_SSL
+#undef sk_new
+#undef sk_push
+#undef sk_free
+#undef sk_value
+#undef sk_num
+#undef sk_pop
+#undef sk_dup
+#endif
+
Index: kio/kssl/kopenssl.cc
===================================================================
--- kio/kssl/kopenssl.cc	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kio/kssl/kopenssl.cc	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -20,7 +20,6 @@
 #include <config.h>
 #endif
 
-
 #ifdef KSSL_HAVE_SSL
 #include <openssl/opensslv.h>
 #endif
@@ -197,6 +196,8 @@
 static X509_NAME *(*K_X509_NAME_new)() = 0L;
 static int (*K_X509_REQ_set_subject_name)(X509_REQ*,X509_NAME*) = 0L;
 static unsigned char *(*K_ASN1_STRING_data)(ASN1_STRING*) = 0L;
+static STACK_OF(SSL_CIPHER) *(*K_SSL_get_ciphers)(const SSL *ssl) = 0L;
+
 #endif
 }
 
@@ -567,6 +568,7 @@
       K_SSL_set_session = (int (*)(SSL*,SSL_SESSION*)) _sslLib->symbol("SSL_set_session");
       K_d2i_SSL_SESSION = (SSL_SESSION* (*)(SSL_SESSION**,unsigned char**, long)) _sslLib->symbol("d2i_SSL_SESSION");
       K_i2d_SSL_SESSION = (int (*)(SSL_SESSION*,unsigned char**)) _sslLib->symbol("i2d_SSL_SESSION");
+      K_SSL_get_ciphers = (STACK *(*)(const SSL*)) _sslLib->symbol("SSL_get_ciphers");
 #endif
 
 
@@ -1543,5 +1545,10 @@
    return 0L;
 }
 
+STACK_OF(SSL_CIPHER) *KOpenSSLProxy::SSL_get_ciphers(const SSL* ssl) {
+  if (K_SSL_get_ciphers) return (K_SSL_get_ciphers)(ssl);
+  return 0L;
+}
+
 #endif
 
Index: kio/kssl/ksslcertdlg.cc
===================================================================
--- kio/kssl/ksslcertdlg.cc	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kio/kssl/ksslcertdlg.cc	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -42,34 +42,44 @@
 class KSSLCertDlg::KSSLCertDlgPrivate {
 private:
     friend class KSSLCertDlg;
+    QLabel *p_message;
+    QPushButton *p_pb_dontsend;
+    bool p_send_flag;
 };
 
 KSSLCertDlg::KSSLCertDlg(QWidget *parent, const char *name, bool modal)
  : KDialog(parent, name, modal), d(new KSSLCertDlgPrivate) {
-   QGridLayout *grid = new QGridLayout(this, 8, 6, KDialog::marginHint(),
-                                                   KDialog::spacingHint() );
 
-   _send = new QRadioButton(i18n("Send certificate..."), this);
-   grid->addMultiCellWidget(_send, 0, 0, 0, 2);
-   connect(_send, SIGNAL(clicked()), SLOT(slotSend()));
+   QBoxLayout * grid = new QVBoxLayout( this, KDialog::marginHint(),
+                                              KDialog::spacingHint() );
 
-   _dont = new QRadioButton(i18n("Do not send a certificate"), this);
-   grid->addMultiCellWidget(_dont, 1, 1, 0, 2);
-   connect(_dont, SIGNAL(clicked()), SLOT(slotDont()));
+   d->p_message = new QLabel(QString::null, this);
+   grid->addWidget(d->p_message);
+   setHost(_host);
 
    _certs = new QListView(this);
-   grid->addMultiCellWidget(_certs, 0, 4, 3, 5);
    _certs->addColumn(i18n("Certificate"));
+   _certs->setResizeMode(QListView::LastColumn);
+   QFontMetrics fm( KGlobalSettings::generalFont() );
+   _certs->setMinimumHeight(4*fm.height());
+   grid->addWidget(_certs);
 
    _save = new QCheckBox(i18n("Save selection for this host."), this);
-   grid->addMultiCellWidget(_save, 5, 5, 0, 3);
+   grid->addWidget(_save);
 
-   grid->addMultiCellWidget(new KSeparator(KSeparator::HLine, this), 6, 6, 0, 5);
+   grid->addWidget(new KSeparator(KSeparator::HLine, this));
 
-   _ok = new KPushButton(KStdGuiItem::cont(), this);
-   grid->addWidget(_ok, 7, 5);
-   connect(_ok, SIGNAL(clicked()), SLOT(accept()));
+   QBoxLayout * h = new QHBoxLayout( grid );
+   h->insertStretch(0);
 
+   _ok = new KPushButton(i18n("Send certificate"), this);
+   h->addWidget(_ok);
+   connect(_ok, SIGNAL(clicked()), SLOT(slotSend()));
+
+   d->p_pb_dontsend = new KPushButton(i18n("Do not send a certificate"), this);
+   h->addWidget(d->p_pb_dontsend);
+   connect(d->p_pb_dontsend, SIGNAL(clicked()), SLOT(slotDont()));
+
 #ifndef QT_NO_WIDGET_TOPEXTRA
    setCaption(i18n("KDE SSL Certificate Dialog"));
 #endif
@@ -87,10 +97,13 @@
 
 void KSSLCertDlg::setupDialog(const QStringList& certs, bool saveChecked, bool sendChecked) {
   _save->setChecked(saveChecked);
-  _send->setChecked(sendChecked);
-  _dont->setChecked(!sendChecked);
-  _certs->setEnabled(sendChecked);
+  d->p_send_flag = sendChecked;
 
+  if (sendChecked)
+    _ok->setDefault(true); // "do send" is the "default action".
+  else
+    d->p_pb_dontsend->setDefault(true); // "do not send" is the "default action".
+
   for (QStringList::ConstIterator i = certs.begin(); i != certs.end(); ++i) {
     if ((*i).isEmpty())
       continue;
@@ -108,34 +121,36 @@
 
 
 bool KSSLCertDlg::wantsToSend() {
-  return _send->isChecked();
+  return d->p_send_flag;
 }
 
 
 QString KSSLCertDlg::getChoice() {
-   return _certs->selectedItem()->text(0);
+   QListViewItem *selected = _certs->selectedItem();
+   if (selected && d->p_send_flag)
+	return selected->text(0);
+   else
+	return QString::null;
 }
 
 
 void KSSLCertDlg::setHost(const QString& host) {
    _host = host;
-#ifndef QT_NO_WIDGET_TOPEXTRA
-   setCaption(i18n("KDE SSL Certificate Dialog")+" - "+host);
-#endif
+   d->p_message->setText(i18n("The server <b>%1</b> requests a certificate.<p>"
+			     "Select a certificate to use from the list below:")
+			 .arg(_host));
 }
 
 
 void KSSLCertDlg::slotSend() {
-   _dont->setChecked(false);
-   _send->setChecked(true);
-   _certs->setEnabled(true);
+   d->p_send_flag = true;
+   accept();
 }
 
 
 void KSSLCertDlg::slotDont() {
-   _send->setChecked(false);
-   _dont->setChecked(true);
-   _certs->setEnabled(false);
+   d->p_send_flag = false;
+   reject();
 }
 
 
Index: kio/kssl/kssl/caroot/ca-bundle.crt
===================================================================
Cannot display: file marked as a binary type.
svn:mime-type = application/x-x509-ca-cert

Property changes on: kio/kssl/kssl/caroot/ca-bundle.crt
___________________________________________________________________
Name: svn:mime-type
   - application/x-x509-ca-cert
   + text/plain

Index: kio/kssl/kssl/netlock4.pem
===================================================================
--- kio/kssl/kssl/netlock4.pem	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kio/kssl/kssl/netlock4.pem	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -1,45 +1,39 @@
------BEGIN CERTIFICATE-----
-MIIH+zCCBuOgAwIBAgIBEDANBgkqhkiG9w0BAQUFADCByTELMAkGA1UEBhMCSFUx
-ETAPBgNVBAcTCEJ1ZGFwZXN0MScwJQYDVQQKEx5OZXRMb2NrIEhhbG96YXRiaXp0
-b25zYWdpIEtmdC4xGjAYBgNVBAsTEVRhbnVzaXR2YW55a2lhZG9rMUIwQAYDVQQD
-EzlOZXRMb2NrIE1pbm9zaXRldHQgS296amVneXpvaSAoQ2xhc3MgUUEpIFRhbnVz
-aXR2YW55a2lhZG8xHjAcBgkqhkiG9w0BCQEWD2luZm9AbmV0bG9jay5odTAeFw0w
-MzAzMzAwMTQ3MTFaFw0yMjEyMTUwMTQ3MTFaMIHJMQswCQYDVQQGEwJIVTERMA8G
-A1UEBxMIQnVkYXBlc3QxJzAlBgNVBAoTHk5ldExvY2sgSGFsb3phdGJpenRvbnNh
-Z2kgS2Z0LjEaMBgGA1UECxMRVGFudXNpdHZhbnlraWFkb2sxQjBABgNVBAMTOU5l
-dExvY2sgTWlub3NpdGV0dCBLb3pqZWd5em9pIChDbGFzcyBRQSkgVGFudXNpdHZh
-bnlraWFkbzEeMBwGCSqGSIb3DQEJARYPaW5mb0BuZXRsb2NrLmh1MIIBIjANBgkq
-hkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAx1Ilstg91IRVCacbvWy5FPSKAtt2/Goq
-eKvld/Bu4IwjZ9ulZJm53QE+b+8tmjwi8F3JV6BVQX/yQ15YglMxZc4e8ia6AFQe
-r7C8HORSjKAyr7c3sVNnaHRnUPYtLmTeriZ539+Zhqurf4XsoPuAzPS4DB6TRWO5
-3Lhbm+1bOdRfYrCnjnxmOCyqsQhjF2d9zL2z8cM/z1A57dEZgxXbhxInlrfa6uWd
-vLrqOU+L73Sa58XQ0uqGURzk/mQIKAR5BevKxXEOC++r6uwSEaEYBTJp0QwsGj0l
-mT+1fMptsK6ZmfoIYOcZwvK9UdPM0wKswREMgM6r3JSda6M5UzrWhQIDAMV9o4ID
-6jCCA+YwEgYDVR0TAQH/BAgwBgEB/wIBBDAOBgNVHQ8BAf8EBAMCAQYwGwYIKwYB
-BQUHAQMBAf8EDDAKMAgGBgQAjkYBATCCA6EGCWCGSAGG+EIBDQSCA5IWggOORklH
-WUVMRU0hIEV6ZW4gdGFudXNpdHZhbnkgYSBOZXRMb2NrIEtmdC4gTWlub3NpdGV0
-dCBTem9sZ2FsdGF0YXNpIFN6YWJhbHl6YXRhYmFuIGxlaXJ0IGVsamFyYXNvayBh
-bGFwamFuIGtlc3p1bHQuIEEga2lib2NzYXRvdHQgdGFudXNpdHZhbnlob3ogdGFy
-dG96byBtYWdhbmt1bGNzIGEgam9nc3phYmFseWkgcmVuZGVsa2V6ZXNla25layBt
-ZWdmZWxlbG8gQml6dG9uc2Fnb3MgQWxhaXJhcyBMZXRyZWhvem8gRXN6a296YmVu
-IChCQUxFKSBrZXN6dWx0LiBBIG1pbm9zaXRldHQgZWxla3Ryb25pa3VzIGFsYWly
-YXMgam9naGF0YXMgZXJ2ZW55ZXN1bGVzZW5laywgdmFsYW1pbnQgZWxmb2dhZGFz
-YW5hayBmZWx0ZXRlbGUgYSBNaW5vc2l0ZXR0IFN6b2xnYWx0YXRhc2kgU3phYmFs
-eXphdGJhbiwgYXogQWx0YWxhbm9zIFN6ZXJ6b2Rlc2kgRmVsdGV0ZWxla2JlbiBl
-bG9pcnQgZWxsZW5vcnplc2kgZWxqYXJhcyBtZWd0ZXRlbGUuIEEgZG9rdW1lbnR1
-bW9rIG1lZ3RhbGFsaGF0b2sgYSBodHRwczovL3d3dy5uZXRsb2NrLmh1L2RvY3Mv
-IGNpbWVuIHZhZ3kga2VyaGV0b2sgYXogaW5mb0BuZXRsb2NrLm5ldCBlLW1haWwg
-Y2ltZW4uIFdBUk5JTkchIFRoaXMgY2VydGlmaWNhdGUgaGFzIGJlZW4gaXNzdWVk
-IGFzIGEgcXVhbGlmaWVkIGNlcnRpZmljYXRlLiBUaGUgY29ycmVzcG9uZGluZyBw
-cml2YXRlIGtleSBoYXMgYmVlbiBnZW5lcmF0ZWQgb24gYSBTZWN1cmUgU2lnbmF0
-dXJlIENyZWF0aW9uIERldmljZSAoU1NDRCkuIFRoZSBpc3N1YW5jZSBhbmQgdGhl
-IHVzZSBvZiB0aGlzIGNlcnRpZmljYXRlIGFyZSBzdWJqZWN0IHRvIHRoZSBOZXRM
-b2NrIFF1YWxpZmllZCBDUFMgYXZhaWxhYmxlIGF0IGh0dHBzOi8vd3d3Lm5ldGxv
-Y2suaHVkb2NzLyBvciBieSBlLW1haWwgYXQgaW5mb0BuZXRsb2NrLm5ldDANBgkq
-hkiG9w0BAQUFAAOCAQEAFQXbp9UbAIBzZWkrPzbZCnSA7wgiCmHKxmWCnXBm8UTU
-Ia3UuOyTzpS6msdUFkLMIjpUPdDEjsA3qcxKIeLzAQATjYmp7mADio+uWv9RunTi
-ZOkaNuoa7j/y57XZCx/LUHtpcEH1KY2LZwOGi5TbkmYfE+b7IiFoTfChJ9RYkoGi
-v1OVQ1JfzgGB/sd1QeMzFDt2c6tqyMGtNzOMqAU37DGfC2spiS2g4UD15q1f5MBs
-OC2F1gRx9/q83zee0EGzDzWvxkYWXtIFfd49RvdRvG4rEHPPHTtaW9R6YDKZrj9i
-ICUh7wvfwzX+Ozax6pdMqxQzzlC4f1p2HILEBjeEHQ==
+-----BEGIN CERTIFICATE----- 
+MIIG0TCCBbmgAwIBAgIBezANBgkqhkiG9w0BAQUFADCByTELMAkGA1UEBhMCSFUx 
+ETAPBgNVBAcTCEJ1ZGFwZXN0MScwJQYDVQQKEx5OZXRMb2NrIEhhbG96YXRiaXp0 
+b25zYWdpIEtmdC4xGjAYBgNVBAsTEVRhbnVzaXR2YW55a2lhZG9rMUIwQAYDVQQD 
+EzlOZXRMb2NrIE1pbm9zaXRldHQgS296amVneXpvaSAoQ2xhc3MgUUEpIFRhbnVz 
+aXR2YW55a2lhZG8xHjAcBgkqhkiG9w0BCQEWD2luZm9AbmV0bG9jay5odTAeFw0w 
+MzAzMzAwMTQ3MTFaFw0yMjEyMTUwMTQ3MTFaMIHJMQswCQYDVQQGEwJIVTERMA8G 
+A1UEBxMIQnVkYXBlc3QxJzAlBgNVBAoTHk5ldExvY2sgSGFsb3phdGJpenRvbnNh 
+Z2kgS2Z0LjEaMBgGA1UECxMRVGFudXNpdHZhbnlraWFkb2sxQjBABgNVBAMTOU5l 
+dExvY2sgTWlub3NpdGV0dCBLb3pqZWd5em9pIChDbGFzcyBRQSkgVGFudXNpdHZh 
+bnlraWFkbzEeMBwGCSqGSIb3DQEJARYPaW5mb0BuZXRsb2NrLmh1MIIBIjANBgkq 
+hkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAx1Ilstg91IRVCacbvWy5FPSKAtt2/Goq 
+eKvld/Bu4IwjZ9ulZJm53QE+b+8tmjwi8F3JV6BVQX/yQ15YglMxZc4e8ia6AFQe 
+r7C8HORSjKAyr7c3sVNnaHRnUPYtLmTeriZ539+Zhqurf4XsoPuAzPS4DB6TRWO5 
+3Lhbm+1bOdRfYrCnjnxmOCyqsQhjF2d9zL2z8cM/z1A57dEZgxXbhxInlrfa6uWd 
+vLrqOU+L73Sa58XQ0uqGURzk/mQIKAR5BevKxXEOC++r6uwSEaEYBTJp0QwsGj0l 
+mT+1fMptsK6ZmfoIYOcZwvK9UdPM0wKswREMgM6r3JSda6M5UzrWhQIDAMV9o4IC 
+wDCCArwwEgYDVR0TAQH/BAgwBgEB/wIBBDAOBgNVHQ8BAf8EBAMCAQYwggJ1Bglg 
+hkgBhvhCAQ0EggJmFoICYkZJR1lFTEVNISBFemVuIHRhbnVzaXR2YW55IGEgTmV0 
+TG9jayBLZnQuIE1pbm9zaXRldHQgU3pvbGdhbHRhdGFzaSBTemFiYWx5emF0YWJh 
+biBsZWlydCBlbGphcmFzb2sgYWxhcGphbiBrZXN6dWx0LiBBIG1pbm9zaXRldHQg 
+ZWxla3Ryb25pa3VzIGFsYWlyYXMgam9naGF0YXMgZXJ2ZW55ZXN1bGVzZW5laywg 
+dmFsYW1pbnQgZWxmb2dhZGFzYW5hayBmZWx0ZXRlbGUgYSBNaW5vc2l0ZXR0IFN6 
+b2xnYWx0YXRhc2kgU3phYmFseXphdGJhbiwgYXogQWx0YWxhbm9zIFN6ZXJ6b2Rl 
+c2kgRmVsdGV0ZWxla2JlbiBlbG9pcnQgZWxsZW5vcnplc2kgZWxqYXJhcyBtZWd0 
+ZXRlbGUuIEEgZG9rdW1lbnR1bW9rIG1lZ3RhbGFsaGF0b2sgYSBodHRwczovL3d3 
+dy5uZXRsb2NrLmh1L2RvY3MvIGNpbWVuIHZhZ3kga2VyaGV0b2sgYXogaW5mb0Bu 
+ZXRsb2NrLm5ldCBlLW1haWwgY2ltZW4uIFdBUk5JTkchIFRoZSBpc3N1YW5jZSBh 
+bmQgdGhlIHVzZSBvZiB0aGlzIGNlcnRpZmljYXRlIGFyZSBzdWJqZWN0IHRvIHRo 
+ZSBOZXRMb2NrIFF1YWxpZmllZCBDUFMgYXZhaWxhYmxlIGF0IGh0dHBzOi8vd3d3 
+Lm5ldGxvY2suaHUvZG9jcy8gb3IgYnkgZS1tYWlsIGF0IGluZm9AbmV0bG9jay5u 
+ZXQwHQYDVR0OBBYEFAlqYhaSsFq7VQ7LdTI6MuWyIckoMA0GCSqGSIb3DQEBBQUA 
+A4IBAQCRalCc23iBmz+LQuM7/KbD7kPgz/PigDVJRXYC4uMvBcXxKufAQTPGtpvQ 
+MznNwNuhrWw3AkxYQTvyl5LGSKjN5Yo5iWH5Upfpvfb5lHTocQ68d4bDBsxafEp+ 
+NFAwLvt/MpqNPfMgW/hqyobzMUwsWYACff44yTB1HLdV47yfuqhthCgFdbOLDcCR 
+VCHnpgu0mfVRQdzNo0ci2ccBgcTcR08m6h/t280NmPSjnLRzMkqWmf68f8glWPhY 
+83ZmiVSkpj7EUFy6iRiCdUgh0k8T6GB+B3bbELVR5qq5aKrN9p2QdRLqOBrKROi3 
+macqaJVmlaut74nLYKkGEsaUR+ko 
 -----END CERTIFICATE-----
Index: kio/kssl/kssl/ksslcalist
===================================================================
--- kio/kssl/kssl/ksslcalist	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kio/kssl/kssl/ksslcalist	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -661,7 +661,7 @@
 code=false
 
 [/C=HU/L=Budapest/O=NetLock Halozatbiztonsagi Kft./OU=Tanusitvanykiadok/CN=NetLock Minositett Kozjegyzoi (Class QA) Tanusitvanykiado/Email=info@netlock.hu]
-x509=MIIH+zCCBuOgAwIBAgIBEDANBgkqhkiG9w0BAQUFADCByTELMAkGA1UEBhMCSFUxETAPBgNVBAcTCEJ1ZGFwZXN0MScwJQYDVQQKEx5OZXRMb2NrIEhhbG96YXRiaXp0b25zYWdpIEtmdC4xGjAYBgNVBAsTEVRhbnVzaXR2YW55a2lhZG9rMUIwQAYDVQQDEzlOZXRMb2NrIE1pbm9zaXRldHQgS296amVneXpvaSAoQ2xhc3MgUUEpIFRhbnVzaXR2YW55a2lhZG8xHjAcBgkqhkiG9w0BCQEWD2luZm9AbmV0bG9jay5odTAeFw0wMzAzMzAwMTQ3MTFaFw0yMjEyMTUwMTQ3MTFaMIHJMQswCQYDVQQGEwJIVTERMA8GA1UEBxMIQnVkYXBlc3QxJzAlBgNVBAoTHk5ldExvY2sgSGFsb3phdGJpenRvbnNhZ2kgS2Z0LjEaMBgGA1UECxMRVGFudXNpdHZhbnlraWFkb2sxQjBABgNVBAMTOU5ldExvY2sgTWlub3NpdGV0dCBLb3pqZWd5em9pIChDbGFzcyBRQSkgVGFudXNpdHZhbnlraWFkbzEeMBwGCSqGSIb3DQEJARYPaW5mb0BuZXRsb2NrLmh1MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAx1Ilstg91IRVCacbvWy5FPSKAtt2/GoqeKvld/Bu4IwjZ9ulZJm53QE+b+8tmjwi8F3JV6BVQX/yQ15YglMxZc4e8ia6AFQer7C8HORSjKAyr7c3sVNnaHRnUPYtLmTeriZ539+Zhqurf4XsoPuAzPS4DB6TRWO53Lhbm+1bOdRfYrCnjnxmOCyqsQhjF2d9zL2z8cM/z1A57dEZgxXbhxInlrfa6uWdvLrqOU+L73Sa58XQ0uqGURzk/mQIKAR5BevKxXEOC++r6uwSEaEYBTJp0QwsGj0lmT+1fMptsK6ZmfoIYOcZwvK9UdPM0wKswREMgM6r3JSda6M5UzrWhQIDAMV9o4ID6jCCA+YwEgYDVR0TAQH/BAgwBgEB/wIBBDAOBgNVHQ8BAf8EBAMCAQYwGwYIKwYBBQUHAQMBAf8EDDAKMAgGBgQAjkYBATCCA6EGCWCGSAGG+EIBDQSCA5IWggOORklHWUVMRU0hIEV6ZW4gdGFudXNpdHZhbnkgYSBOZXRMb2NrIEtmdC4gTWlub3NpdGV0dCBTem9sZ2FsdGF0YXNpIFN6YWJhbHl6YXRhYmFuIGxlaXJ0IGVsamFyYXNvayBhbGFwamFuIGtlc3p1bHQuIEEga2lib2NzYXRvdHQgdGFudXNpdHZhbnlob3ogdGFydG96byBtYWdhbmt1bGNzIGEgam9nc3phYmFseWkgcmVuZGVsa2V6ZXNla25layBtZWdmZWxlbG8gQml6dG9uc2Fnb3MgQWxhaXJhcyBMZXRyZWhvem8gRXN6a296YmVuIChCQUxFKSBrZXN6dWx0LiBBIG1pbm9zaXRldHQgZWxla3Ryb25pa3VzIGFsYWlyYXMgam9naGF0YXMgZXJ2ZW55ZXN1bGVzZW5laywgdmFsYW1pbnQgZWxmb2dhZGFzYW5hayBmZWx0ZXRlbGUgYSBNaW5vc2l0ZXR0IFN6b2xnYWx0YXRhc2kgU3phYmFseXphdGJhbiwgYXogQWx0YWxhbm9zIFN6ZXJ6b2Rlc2kgRmVsdGV0ZWxla2JlbiBlbG9pcnQgZWxsZW5vcnplc2kgZWxqYXJhcyBtZWd0ZXRlbGUuIEEgZG9rdW1lbnR1bW9rIG1lZ3RhbGFsaGF0b2sgYSBodHRwczovL3d3dy5uZXRsb2NrLmh1L2RvY3MvIGNpbWVuIHZhZ3kga2VyaGV0b2sgYXogaW5mb0BuZXRsb2NrLm5ldCBlLW1haWwgY2ltZW4uIFdBUk5JTkchIFRoaXMgY2VydGlmaWNhdGUgaGFzIGJlZW4gaXNzdWVkIGFzIGEgcXVhbGlmaWVkIGNlcnRpZmljYXRlLiBUaGUgY29ycmVzcG9uZGluZyBwcml2YXRlIGtleSBoYXMgYmVlbiBnZW5lcmF0ZWQgb24gYSBTZWN1cmUgU2lnbmF0dXJlIENyZWF0aW9uIERldmljZSAoU1NDRCkuIFRoZSBpc3N1YW5jZSBhbmQgdGhlIHVzZSBvZiB0aGlzIGNlcnRpZmljYXRlIGFyZSBzdWJqZWN0IHRvIHRoZSBOZXRMb2NrIFF1YWxpZmllZCBDUFMgYXZhaWxhYmxlIGF0IGh0dHBzOi8vd3d3Lm5ldGxvY2suaHVkb2NzLyBvciBieSBlLW1haWwgYXQgaW5mb0BuZXRsb2NrLm5ldDANBgkqhkiG9w0BAQUFAAOCAQEAFQXbp9UbAIBzZWkrPzbZCnSA7wgiCmHKxmWCnXBm8UTUIa3UuOyTzpS6msdUFkLMIjpUPdDEjsA3qcxKIeLzAQATjYmp7mADio+uWv9RunTiZOkaNuoa7j/y57XZCx/LUHtpcEH1KY2LZwOGi5TbkmYfE+b7IiFoTfChJ9RYkoGiv1OVQ1JfzgGB/sd1QeMzFDt2c6tqyMGtNzOMqAU37DGfC2spiS2g4UD15q1f5MBsOC2F1gRx9/q83zee0EGzDzWvxkYWXtIFfd49RvdRvG4rEHPPHTtaW9R6YDKZrj9iICUh7wvfwzX+Ozax6pdMqxQzzlC4f1p2HILEBjeEHQ==
+x509=MIIG0TCCBbmgAwIBAgIBezANBgkqhkiG9w0BAQUFADCByTELMAkGA1UEBhMCSFUxETAPBgNVBAcTCEJ1ZGFwZXN0MScwJQYDVQQKEx5OZXRMb2NrIEhhbG96YXRiaXp0b25zYWdpIEtmdC4xGjAYBgNVBAsTEVRhbnVzaXR2YW55a2lhZG9rMUIwQAYDVQQDEzlOZXRMb2NrIE1pbm9zaXRldHQgS296amVneXpvaSAoQ2xhc3MgUUEpIFRhbnVzaXR2YW55a2lhZG8xHjAcBgkqhkiG9w0BCQEWD2luZm9AbmV0bG9jay5odTAeFw0wMzAzMzAwMTQ3MTFaFw0yMjEyMTUwMTQ3MTFaMIHJMQswCQYDVQQGEwJIVTERMA8GA1UEBxMIQnVkYXBlc3QxJzAlBgNVBAoTHk5ldExvY2sgSGFsb3phdGJpenRvbnNhZ2kgS2Z0LjEaMBgGA1UECxMRVGFudXNpdHZhbnlraWFkb2sxQjBABgNVBAMTOU5ldExvY2sgTWlub3NpdGV0dCBLb3pqZWd5em9pIChDbGFzcyBRQSkgVGFudXNpdHZhbnlraWFkbzEeMBwGCSqGSIb3DQEJARYPaW5mb0BuZXRsb2NrLmh1MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAx1Ilstg91IRVCacbvWy5FPSKAtt2/GoqeKvld/Bu4IwjZ9ulZJm53QE+b+8tmjwi8F3JV6BVQX/yQ15YglMxZc4e8ia6AFQer7C8HORSjKAyr7c3sVNnaHRnUPYtLmTeriZ539+Zhqurf4XsoPuAzPS4DB6TRWO53Lhbm+1bOdRfYrCnjnxmOCyqsQhjF2d9zL2z8cM/z1A57dEZgxXbhxInlrfa6uWdvLrqOU+L73Sa58XQ0uqGURzk/mQIKAR5BevKxXEOC++r6uwSEaEYBTJp0QwsGj0lmT+1fMptsK6ZmfoIYOcZwvK9UdPM0wKswREMgM6r3JSda6M5UzrWhQIDAMV9o4ICwDCCArwwEgYDVR0TAQH/BAgwBgEB/wIBBDAOBgNVHQ8BAf8EBAMCAQYwggJ1BglghkgBhvhCAQ0EggJmFoICYkZJR1lFTEVNISBFemVuIHRhbnVzaXR2YW55IGEgTmV0TG9jayBLZnQuIE1pbm9zaXRldHQgU3pvbGdhbHRhdGFzaSBTemFiYWx5emF0YWJhbiBsZWlydCBlbGphcmFzb2sgYWxhcGphbiBrZXN6dWx0LiBBIG1pbm9zaXRldHQgZWxla3Ryb25pa3VzIGFsYWlyYXMgam9naGF0YXMgZXJ2ZW55ZXN1bGVzZW5laywgdmFsYW1pbnQgZWxmb2dhZGFzYW5hayBmZWx0ZXRlbGUgYSBNaW5vc2l0ZXR0IFN6b2xnYWx0YXRhc2kgU3phYmFseXphdGJhbiwgYXogQWx0YWxhbm9zIFN6ZXJ6b2Rlc2kgRmVsdGV0ZWxla2JlbiBlbG9pcnQgZWxsZW5vcnplc2kgZWxqYXJhcyBtZWd0ZXRlbGUuIEEgZG9rdW1lbnR1bW9rIG1lZ3RhbGFsaGF0b2sgYSBodHRwczovL3d3dy5uZXRsb2NrLmh1L2RvY3MvIGNpbWVuIHZhZ3kga2VyaGV0b2sgYXogaW5mb0BuZXRsb2NrLm5ldCBlLW1haWwgY2ltZW4uIFdBUk5JTkchIFRoZSBpc3N1YW5jZSBhbmQgdGhlIHVzZSBvZiB0aGlzIGNlcnRpZmljYXRlIGFyZSBzdWJqZWN0IHRvIHRoZSBOZXRMb2NrIFF1YWxpZmllZCBDUFMgYXZhaWxhYmxlIGF0IGh0dHBzOi8vd3d3Lm5ldGxvY2suaHUvZG9jcy8gb3IgYnkgZS1tYWlsIGF0IGluZm9AbmV0bG9jay5uZXQwHQYDVR0OBBYEFAlqYhaSsFq7VQ7LdTI6MuWyIckoMA0GCSqGSIb3DQEBBQUAA4IBAQCRalCc23iBmz+LQuM7/KbD7kPgz/PigDVJRXYC4uMvBcXxKufAQTPGtpvQMznNwNuhrWw3AkxYQTvyl5LGSKjN5Yo5iWH5Upfpvfb5lHTocQ68d4bDBsxafEp+NFAwLvt/MpqNPfMgW/hqyobzMUwsWYACff44yTB1HLdV47yfuqhthCgFdbOLDcCRVCHnpgu0mfVRQdzNo0ci2ccBgcTcR08m6h/t280NmPSjnLRzMkqWmf68f8glWPhY83ZmiVSkpj7EUFy6iRiCdUgh0k8T6GB+B3bbELVR5qq5aKrN9p2QdRLqOBrKROi3macqaJVmlaut74nLYKkGEsaUR+ko
 site=false
 email=true
 code=true
Index: kstyles/themes/qtwindows.themerc
===================================================================
--- kstyles/themes/qtwindows.themerc	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kstyles/themes/qtwindows.themerc	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -10,6 +10,7 @@
 Name[se]=Windows
 Name[th]=วินโดว์ส 9x
 Name[vi]=MS™ Windows 9x
+Name[zh_TW]=MSWindows 9x
 Comment=Built-in unthemed Windows 9x style
 Comment[af]=Ingeboude ongetemade Vensters 9x styl
 Comment[ar]=مظهر مضمن مشابه لويندوز
Index: kstyles/themes/keramik.themerc
===================================================================
--- kstyles/themes/keramik.themerc	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kstyles/themes/keramik.themerc	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -62,6 +62,7 @@
 Comment[ro]=Un stil care utilizează transparenţă
 Comment[ru]=Стиль с использованием альфа-смешивания
 Comment[se]=Stiila mii geavaha alfaseaguhusa
+Comment[sk]=Štýl používajúci alfa kanál
 Comment[sl]=Slog z uporabo mešanja alfa
 Comment[sr]=Стил који користи алфа-стапање
 Comment[sr@Latn]=Stil koji koristi alfa-stapanje
@@ -72,6 +73,7 @@
 Comment[vi]=Kiểu dáng hợp nhau anfa.
 Comment[zh_CN]=使用 alpha 混和的风格
 Comment[zh_HK]=一個使用漸變色的佈景
+Comment[zh_TW]=使用 alphablending 的預設風格
 
 [KDE]
 WidgetStyle=Keramik
Index: kstyles/plastik/plastik.themerc
===================================================================
--- kstyles/plastik/plastik.themerc	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kstyles/plastik/plastik.themerc	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -78,5 +78,6 @@
 Comment[uz]=Оддий ва чиройли услуб
 Comment[vi]=Kiểu dáng sạch và đơn giản.
 Comment[zh_CN]=简洁清爽的样式
+Comment[zh_TW]=簡單而乾淨的風格
 [KDE]
 WidgetStyle=Plastik
Index: kstyles/highcontrast/highcontrast.themerc
===================================================================
--- kstyles/highcontrast/highcontrast.themerc	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kstyles/highcontrast/highcontrast.themerc	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -102,5 +102,6 @@
 Comment[vi]=Kiểu dáng thích hợp với lược đồ màu có độ tương phản cao.
 Comment[zh_CN]=在高对比度配色方案中适用的样式
 Comment[zh_HK]=適用於高反差色彩的佈景
+Comment[zh_TW]=在高彩度下可以使用的風格
 [KDE]
 WidgetStyle=HighContrast
Index: kabc/plugins/file/file.desktop
===================================================================
--- kabc/plugins/file/file.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kabc/plugins/file/file.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -69,6 +69,7 @@
 Name[wa]=Fitchî
 Name[zh_CN]=文件
 Name[zh_HK]=檔案
+Name[zh_TW]=檔案
 X-KDE-Library=kabc_file
 Type=Service
 ServiceTypes=KResources/Plugin
Index: kabc/plugins/file/resourcefile.cpp
===================================================================
--- kabc/plugins/file/resourcefile.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kabc/plugins/file/resourcefile.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -36,9 +36,6 @@
 #include <klocale.h>
 #include <ksavefile.h>
 #include <kstandarddirs.h>
-#include <kurl.h>
-#include <jobclasses.h>
-#include <kio/netaccess.h>
 
 #include "formatfactory.h"
 #include "resourcefileconfig.h"
@@ -175,23 +172,30 @@
         if ( backup.size() != 0 )
         {
           kdDebug() << "Restoring backup " << i << endl;
-          KURL src, dest;
-          src.setPath( mFileName + "__" + QString::number(i) );
-          dest.setPath( mFileName );
+          const QString src = mFileName + "__" + QString::number(i);
+          const QString dest = mFileName;
 
-          KIO::DeleteJob* job = KIO::del( dest, false, false ); 
-          KIO::NetAccess::synchronousRun( job, 0);
+          // remove dest
+          QFile::remove( dest );
 
-          KIO::CopyJob* job2 = KIO::copy( src, dest, false ); 
-          KIO::NetAccess::synchronousRun( job2, 0);
+          // copy src to dest
+          if ( backup.open( IO_ReadOnly ) ) {
+            const QByteArray data = backup.readAll();
 
-          backup.close();
+            QFile out( dest );
+            if ( out.open( IO_WriteOnly ) ) {
+              out.writeBlock( data );
+              out.close();
+            }
+
+            backup.close();
+          }
           return true; 
         }
-        backup.close();
       }
       return true;
     }
+
     bool ok = mFormat->checkFormat( &file );
     file.close();
 
@@ -243,20 +247,33 @@
   // Only do the logrotate dance when the __0 file is not 0 bytes.
   QFile file( mFileName + "__0" );
   if ( file.size() != 0 ) {
-    KURL last;
-    last.setPath( mFileName + "__20" );
+    const QString last = mFileName + "__20";
     kdDebug() << "deleting " << last << endl;
-    KIO::DeleteJob* job = KIO::del( last, false, false ); 
-    KIO::NetAccess::synchronousRun( job, 0);
 
+    QFile::remove( last );
+
     for (int i=19; i>=0; i--)
     {
-      KURL src, dest;
-      src.setPath( mFileName + "__" + QString::number(i) );
-      dest.setPath( mFileName + "__" + QString::number(i+1) );
+      const QString src = mFileName + "__" + QString::number(i);
+      const QString dest = mFileName + "__" + QString::number(i+1);
       kdDebug() << "moving " << src << " -> " << dest << endl;
-      KIO::SimpleJob* job = KIO::rename( src, dest, false ); 
-      KIO::NetAccess::synchronousRun( job, 0);
+
+      // copy src to dest
+      QFile in( src );
+      if ( in.open( IO_ReadOnly ) ) {
+        const QByteArray data = in.readAll();
+
+        QFile out( dest );
+        if ( out.open( IO_WriteOnly ) ) {
+          out.writeBlock( data );
+          out.close();
+        }
+
+        in.close();
+      }
+
+      // remove src
+      QFile::remove( src );
     }
   } else
     kdDebug() << "Not starting logrotate __0 is 0 bytes." << endl;
Index: kabc/kabc_manager.desktop
===================================================================
--- kabc/kabc_manager.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kabc/kabc_manager.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -58,6 +58,7 @@
 Name[vi]=Liên lạc
 Name[zh_CN]=联系人
 Name[zh_HK]=聯絡人
+Name[zh_TW]=聯絡人
 Type=Service
 ServiceTypes=KResources/Manager
 
Index: kspell2/kspellclient.desktop
===================================================================
--- kspell2/kspellclient.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kspell2/kspellclient.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -60,3 +60,4 @@
 Comment[uz]=KSpell клиенти
 Comment[vi]=Ứng dụng khách chính tả KSpell
 Comment[zh_CN]=KSpell 客户
+Comment[zh_TW]=KShell 客戶端程式
Index: knewstuff/downloaddialog.cpp
===================================================================
--- knewstuff/downloaddialog.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ knewstuff/downloaddialog.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -22,7 +22,6 @@
 #include "downloaddialog.moc"
 
 #include <klocale.h>
-#include <ktabctl.h>
 #include <klistview.h>
 #include <kdebug.h>
 #include <kio/job.h>
@@ -42,6 +41,7 @@
 #include <qdom.h>
 #include <qlabel.h>
 #include <qtextbrowser.h>
+#include <qtabwidget.h>
 #include <qtimer.h> // hack
 
 using namespace KNS;
@@ -209,7 +209,7 @@
 void DownloadDialog::addProvider(Provider *p)
 {
   QFrame *frame;
-  KTabCtl *ctl;
+  QTabWidget *ctl;
   QWidget *w_d, *w_r, *w_l;
   QWidget *w2;
   QTextBrowser *rt;
@@ -249,7 +249,7 @@
   w_r = new QWidget(frame);
   w_l = new QWidget(frame);
 
-  ctl = new KTabCtl(frame);
+  ctl = new QTabWidget(frame);
   ctl->addTab(w_r, i18n("Highest Rated"));
   ctl->addTab(w_d, i18n("Most Downloads"));
   ctl->addTab(w_l, i18n("Latest"));
Index: kdecore/kmdcodec.cpp
===================================================================
--- kdecore/kmdcodec.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kdecore/kmdcodec.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -480,6 +480,9 @@
             data[count] == '\t' || data[count] == ' ') )
         count++;
 
+    if ( count == len )
+        return;
+
     if ( strncasecmp(data+count, "begin", 5) == 0 )
     {
         count += 5;
@@ -495,8 +498,8 @@
 
     // Find the tail end of the actual encoded data even if
     // there is/are trailing CR and/or LF.
-    while ( data[tail-1] == '=' || data[tail-1] == '\n' ||
-            data[tail-1] == '\r' )
+    while ( tail > 0
+            && ( data[tail-1] == '=' || data[tail-1] == '\n' || data[tail-1] == '\r' ) )
         if ( data[--tail] != '=' ) len = tail;
 
     unsigned int outIdx = 0;
Index: kdecore/kaccelbase.h
===================================================================
--- kdecore/kaccelbase.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kdecore/kaccelbase.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -166,6 +166,10 @@
 	*/
 	void setConfigGroup( const QString& group );
 	void setConfigGlobal( bool global );
+	/** Enables or disables the accelerator.
+	 * @param bEnabled determines whether the accelerator should be enabled or
+	 * disabled.
+	 */
 	virtual void setEnabled( bool bEnabled ) = 0;
 	/** Returns whether autoupdate is enabled for these accelerators. */
 	bool getAutoUpdate() { return m_bAutoUpdate; }
@@ -217,14 +221,32 @@
 	void slotRemoveAction( KAccelAction* );
 
 	struct X;
+
+	/** Constructs a list of keys to be connected, sorted highest priority first.
+	 * @param rgKeys constructed list of keys
+	 */
 	void createKeyList( QValueVector<struct X>& rgKeys );
 	bool insertConnection( KAccelAction* );
 	bool removeConnection( KAccelAction* );
 
-	virtual bool emitSignal( Signal ) = 0;
-	virtual bool connectKey( KAccelAction&, const KKeyServer::Key& ) = 0;
-	virtual bool connectKey( const KKeyServer::Key& ) = 0;
+	/** Emits a signal.
+	 * @param signal signal to be emitted
+	 */
+	virtual bool emitSignal( Signal signal ) = 0;
+	/** Defines a key which activates the accelerator and executes the action
+	 * @param action action to be executed when key is pressed
+	 * @param key key which causes the action to be executed
+	 */
+	virtual bool connectKey( KAccelAction& action, const KKeyServer::Key& key ) = 0;
+	/** Defines a key which activates the accelerator
+	 * @param key key which causes the action to be executed
+	 */
+	virtual bool connectKey( const KKeyServer::Key& key) = 0;
+	/** Removes the key from accelerator so it no longer executes the action
+	 */
 	virtual bool disconnectKey( KAccelAction&, const KKeyServer::Key& ) = 0;
+	/** Removes the key from accelerator
+	 */
 	virtual bool disconnectKey( const KKeyServer::Key& ) = 0;
 
  protected:
Index: kdecore/kconfigbackend.cpp
===================================================================
--- kdecore/kconfigbackend.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kdecore/kconfigbackend.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -211,6 +211,26 @@
   return result;
 }
 
+static QCString encodeKey(const char* key)
+{
+    QCString newKey(key);
+
+    newKey.replace('[', "%5b");
+    newKey.replace(']', "%5d");
+
+    return newKey;
+}
+
+static QCString decodeKey(const char* key)
+{
+    QCString newKey(key);
+
+    newKey.replace("%5b", "[");
+    newKey.replace("%5d", "]");
+
+    return newKey;
+}
+
 class KConfigBackEnd::KConfigBackEndPrivate
 {
 public:
@@ -675,7 +695,7 @@
       QCString val = printableToString(st, s - st);
       //qDebug("found key '%s' with value '%s'", key.data(), val.data());
 
-      KEntryKey aEntryKey(aCurrentGroup, key);
+      KEntryKey aEntryKey(aCurrentGroup, decodeKey(key));
       aEntryKey.bLocal = (locale != 0);
       aEntryKey.bDefault = bDefault;
 
@@ -870,7 +890,7 @@
 
      firstEntry = false;
      // it is data for a group
-     fputs(key.mKey.data(), pStream); // Key
+     fputs(encodeKey(key.mKey.data()), pStream); // Key
 
      if ( currentEntry.bNLS )
      {
Index: kdecore/ksycoca.cpp
===================================================================
--- kdecore/ksycoca.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kdecore/ksycoca.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -43,7 +43,10 @@
 #endif
 
 #ifdef Q_OS_SOLARIS
-extern "C" extern int madvise(caddr_t, size_t, int); 
+extern "C" 
+{
+	extern int madvise(caddr_t, size_t, int); 
+}
 #endif
 
 #ifndef MAP_FAILED
Index: kdecore/eventsrc
===================================================================
--- kdecore/eventsrc	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kdecore/eventsrc	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -138,6 +138,7 @@
 Name[uz]=Чиқиндилар қутиси бўшатилди
 Name[vi]=Rác: đã đổ
 Name[zh_CN]=回收站：已清空
+Name[zh_TW]=垃圾桶已清空
 Comment=The trash has been emptied
 Comment[af]=Die gemors is leeggemaak
 Comment[bg]=Съдържанието а кошчето е изтрито
@@ -194,6 +195,7 @@
 Comment[uz]=Чиқиндилар қутиси бўшатилди
 Comment[vi]=Rác đã được đổ.
 Comment[zh_CN]=回收站已被清空
+Comment[zh_TW]=垃圾桶已清空。
 default_presentation=1
 
 [Textcompletion: rotation]
@@ -331,6 +333,7 @@
 Comment[uz]=Мос келадиган элементлар рўйхатининг охири
 Comment[vi]=Mới tới kết thúc của danh sách từ khớp.
 Comment[zh_CN]=已到达匹配项列表的最后
+Comment[zh_TW]=符合條件的列表已經到結尾了。
 default_presentation=1
 
 [Textcompletion: no match]
@@ -469,6 +472,7 @@
 Comment[vi]=Không tìm thấy.
 Comment[zh_CN]=没有找到匹配的补全项
 Comment[zh_HK]=找不到完全匹配的項目
+Comment[zh_TW]=找不到完全匹配的項目。
 default_presentation=1
 
 [Textcompletion: partial match]
@@ -607,6 +611,7 @@
 Comment[vi]=Khớp nhiều từ.
 Comment[zh_CN]=有多于一个的可能匹配项
 Comment[zh_HK]=匹配的可能性多於一個
+Comment[zh_TW]=有多於一個的可能匹配項。
 default_presentation=1
 
 [cannotopenfile]
@@ -909,6 +914,7 @@
 Comment[vi]=Gặp lỗi nghiêm trong mà gây ra chương trình thoát.
 Comment[zh_CN]=有一个严重的错误导致程序退出
 Comment[zh_HK]=發生了嚴重的錯誤，導致程式結束
+Comment[zh_TW]=發生了一個嚴重的錯誤導致結束該程式。
 default_presentation=2
 level=4
 
@@ -1050,6 +1056,7 @@
 Comment[vi]=Có gì đặc biệt đã xảy ra trong chương trình.
 Comment[zh_CN]=程序中发生了特殊情况
 Comment[zh_HK]=程式發生了特殊情況
+Comment[zh_TW]=程式中發生了特殊的情況
 default_presentation=1
 default_sound=KDE_Beep.ogg
 level=1
@@ -1193,6 +1200,7 @@
 Comment[uz]=Дастурда муаммоларга олиб келиши мумкин бўлган хато рўй берди
 Comment[vi]=Gặp lỗi trong chương trình, mà có thể gây ra vấn đề.
 Comment[zh_CN]=程序中发生了可能导致问题的错误
+Comment[zh_TW]=程式中發生了一個可能會導致發生問題的錯誤。
 default_presentation=2
 level=2
 
@@ -1342,6 +1350,7 @@
 Comment[vi]=Gặp lỗi rất nghiêm trọng mà ít nhất đã gây ra chương trình thoát.
 Comment[zh_CN]=出现了一个非常严重的错误，至少使程序退出
 Comment[zh_HK]=發生了一個很嚴重的錯誤，令程式必須結束
+Comment[zh_TW]=因為發生了一個很嚴重的錯誤，所以該程式必須要結束
 default_presentation=2
 level=8
 [startkde]
@@ -1479,6 +1488,7 @@
 Comment[vi]=KDE đang khởi chạy.
 Comment[zh_CN]=KDE 正在启动
 Comment[zh_HK]=KDE 正在啟動
+Comment[zh_TW]=KDE 正在啟動
 default_presentation=1
 default_sound=KDE_Startup_1.ogg
 
@@ -1619,6 +1629,7 @@
 Comment[vi]=KDE đang thoát.
 Comment[zh_CN]=KDE 正在退出
 Comment[zh_HK]=KDE 正在結束
+Comment[zh_TW]=KDE 正在結束
 default_presentation=1
 default_sound=KDE_Logout_3.ogg
 
@@ -1847,6 +1858,7 @@
 Name[wa]=Messaedje d' informåcion
 Name[zh_CN]=信息性消息
 Name[zh_HK]=一般訊息
+Name[zh_TW]=資訊訊息
 Comment=An information message is being shown
 Comment[af]='n Informasie boodskap word vertoon
 Comment[ar]=تظهر الآن رسالة معلوماتية
@@ -1916,6 +1928,7 @@
 Comment[wa]=On messaedje d' informåcion est håyné
 Comment[zh_CN]=正在显示信息性消息
 Comment[zh_HK]=顯示一般訊息
+Comment[zh_TW]=資訊訊息已顯示
 default_sound=KDE_Chimes_2.ogg
 default_presentation=65
 nopresentation=18
@@ -1991,6 +2004,7 @@
 Name[wa]=Messaedje d' adviertixhmint
 Name[zh_CN]=警告消息
 Name[zh_HK]=警告訊息
+Name[zh_TW]=警告訊息
 Comment=A warning message is being shown
 Comment[af]='n Waarskuwing boodskap word vertoon
 Comment[ar]=تظهر الآن رسالة تحذيرية
@@ -2135,6 +2149,7 @@
 Name[wa]=Messaedje critike
 Name[zh_CN]=关键消息
 Name[zh_HK]=嚴重警告訊息
+Name[zh_TW]=嚴重警告訊息
 Comment=A critical message is being shown
 Comment[af]='n Kritiese boodskap word vertoon
 Comment[ar]=تظهر الآن رسالة مهمَة
@@ -2280,6 +2295,7 @@
 Name[wa]=Kesse
 Name[zh_CN]=问题
 Name[zh_HK]=提問
+Name[zh_TW]=問題
 Comment=A question is being asked
 Comment[af]='n Vraag word gevra
 Comment[ar]=هناك سؤال يتم سؤاله
@@ -2350,7 +2366,7 @@
 Comment[wa]=Ene kesse est dmandêye
 Comment[zh_CN]=正在提问
 Comment[zh_HK]=顯示提問訊息
-Comment[zh_TW]=問題已經在詢問中
+Comment[zh_TW]=問題詢問中
 default_sound=KDE_Vox_Ahem.ogg
 default_presentation=65
 nopresentation=18
Index: kdecore/kprocess.cpp
===================================================================
--- kdecore/kprocess.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kdecore/kprocess.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -387,7 +387,10 @@
            if (pw)
               initgroups(pw->pw_name, pw->pw_gid);
 #endif
-           setuid(getuid());
+	   if (geteuid() != getuid())
+	       setuid(getuid());
+	   if (geteuid() != getuid())
+	       _exit(1);
         }
 
         setupEnvironment();
Index: kdecore/all_languages.desktop
===================================================================
--- kdecore/all_languages.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kdecore/all_languages.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -2061,6 +2061,7 @@
 Name[vi]=Anh (quốc Anh)
 Name[zh_CN]=英国英语
 Name[zh_HK]=英式英語
+Name[zh_TW]=（英式）英語
 [en_US]
 Name=American English
 Name[af]=Amerikaanse Engels
@@ -2118,6 +2119,7 @@
 Name[vi]=Anh (Mỹ)
 Name[zh_CN]=美国英语
 Name[zh_HK]=美式英語
+Name[zh_TW]=美語
 [eo]
 Name=Esperanto
 Name[ar]=الإسبرانتو
@@ -2456,6 +2458,7 @@
 Name[wa]=Farsi
 Name[zh_CN]=波斯语
 Name[zh_HK]=波斯語
+Name[zh_TW]=波斯語
 [fi]
 Name=Finnish
 Name[af]=Feense
@@ -2870,6 +2873,7 @@
 Name[uk]=Гальська (Ірландія)
 Name[vi]=Xen-tợ Ái-nhĩ-lan
 Name[zh_CN]=爱尔兰盖尔语
+Name[zh_TW]=（愛爾蘭）蓋爾語
 [gd]
 Name=Gaelic
 Name[ar]=غالي
@@ -2944,7 +2948,7 @@
 Name[ca]=Gallec
 Name[cs]=Haličský
 Name[cy]=Galiseg
-Name[da]=Galisisk
+Name[da]=Galicisk
 Name[de]=Galizisch
 Name[es]=Gallego
 Name[et]=Galeegi
@@ -2994,6 +2998,7 @@
 Name[vi]=Ga-li-ci
 Name[xh]=isiGalacian
 Name[zh_CN]=加利西亚语
+Name[zh_TW]=加利西亞語
 Name[zu]=Isi-Galashiyani
 [gn]
 Name=Guarani
@@ -3259,7 +3264,6 @@
 Name[bn]=হিন্দী
 Name[cs]=Hindský
 Name[cy]=Hindw^
-Name[da]=Hindu
 Name[eo]=Hinda
 Name[fa]=هندی
 Name[fy]=Hindy
@@ -3442,7 +3446,7 @@
 Name[hsb]=Hornjoserbsce
 Name[hu]=Felső szorb
 Name[it]=Alto sorabo
-Name[ja]=ソルブ語
+Name[ja]=ソルビア語
 Name[km]=សូបៀន លើ
 Name[lb]=Uewersorbesch
 Name[mk]=Јужно лужички
@@ -3471,6 +3475,7 @@
 Name[uz]=Юқори Сорбча
 Name[vi]=Xoa-bi muộn
 Name[zh_CN]=索布语
+Name[zh_TW]=塞爾維亞語
 [hu]
 Name=Hungarian
 Name[af]=Hongaars
@@ -5005,7 +5010,6 @@
 Name[ca]=Luxemburguès
 Name[cs]=Lucemburský
 Name[cy]=Luxembwrgeg
-Name[da]=Luxembourgsk
 Name[de]=Luxemburgisch
 Name[el]=Λουξεμβουργικά
 Name[eo]=Luksemburga
@@ -5878,7 +5882,6 @@
 Name[bs]=Malajski
 Name[ca]=Malai
 Name[cs]=Malajský
-Name[da]=Malajisk
 Name[de]=Malaiisch
 Name[eo]=Malaja
 Name[es]=Malayo
@@ -6154,7 +6157,7 @@
 Name[hu]=Norvég (bokmal)
 Name[is]=Norska (bókmál)
 Name[it]=Norvegese Bokmål
-Name[ja]=ノルウェー語 (Bokmål)
+Name[ja]=ノルウェー語 (ブークモール)
 Name[km]=ន័រវែស បុកម៉ាល់
 Name[ko]=노르웨이어 (Bokmaal)
 Name[lb]=Norwegesch (Bokmål)
@@ -6190,6 +6193,7 @@
 Name[vi]=Na-uy (Bóc-mặn)
 Name[wa]=Norvedjyin (Bokmål)
 Name[zh_CN]=挪威语 (博克马尔语)
+Name[zh_TW]=挪威 Bokmål
 Name[zu]=Isi-Norwegian Bokmaal
 [nd]
 Name=Ndebele, North
@@ -6287,7 +6291,7 @@
 Name[hsb]=Delnjosaksce
 Name[hu]=Alsószász
 Name[it]=Basso sassone
-Name[ja]=低地ドイツ語
+Name[ja]=低ザクセン語
 Name[km]=ឡូសាក់សុង
 Name[lb]=Niddersächsesch
 Name[lt]=Žemutinių saksonų
@@ -6318,6 +6322,7 @@
 Name[uz]=Паст Саксонча
 Name[vi]=Xác-xọnh thấp
 Name[zh_CN]=撒克逊语
+Name[zh_TW]=薩克遜語
 [ne]
 Name=Nepali
 Name[ar]=نيبالي
@@ -6527,7 +6532,7 @@
 Name[id]=Norwegia (Nynorsk)
 Name[is]=Norska (nýnorska)
 Name[it]=Norvegese Nynorsk
-Name[ja]=ノルウェー語 (Nynorsk)
+Name[ja]=ノルウェー語 (ニーノシュク)
 Name[km]=ន័រវែស នីនូស
 Name[ko]=노르웨이어 (Nynorsk)
 Name[lb]=Norwegesch (Nynorsk)
@@ -7377,6 +7382,7 @@
 Name[wa]=Portuguès do Braezi
 Name[zh_CN]=巴西葡萄牙语
 Name[zh_HK]=巴西葡萄牙語
+Name[zh_TW]=巴西葡萄牙語
 [qu]
 Name=Quechua
 Name[ar]=الكويتشيوا
@@ -7565,6 +7571,7 @@
 Name[pt_BR]=Romeno
 Name[ro]=Ţigănească
 Name[ru]=Цыганский
+Name[sk]=Románsky
 Name[sl]=romsko
 Name[sr]=Ромски
 Name[sr@Latn]=Romski
@@ -7573,6 +7580,7 @@
 Name[uk]=Циганська
 Name[vi]=Rô-ma-ny
 Name[zh_CN]=吉普赛语
+Name[zh_TW]=吉普賽語
 [ru]
 Name=Russian
 Name[af]=Russies
@@ -7669,7 +7677,7 @@
 Name[hi]=किन्यारवान्डा
 Name[hr]=Kinidžaruandski
 Name[hu]=Kinjarvanda
-Name[ja]=キヌヤルワンダ語
+Name[ja]=キニヤルワンダ語
 Name[km]=គីនយ៉ាវ៉ាន់ដា
 Name[ko]=키냐르완다어
 Name[lb]=Ruanda-Sprooch
@@ -8108,6 +8116,7 @@
 Name[xh]=isiSlovak
 Name[zh_CN]=斯洛伐克语
 Name[zh_HK]=斯洛伐克語
+Name[zh_TW]=斯洛伐克語
 Name[zu]=Isi-Silovaki
 [sl]
 Name=Slovenian
@@ -8526,7 +8535,7 @@
 Name[hu]=Szerb (latin betűs)
 Name[is]=Serbnesk latína
 Name[it]=Serbo latino
-Name[ja]=セルビア系ラテン語
+Name[ja]=セルビア語 (ラテン文字)
 Name[km]=សែប៊ី (ឡាតាំង)
 Name[lb]=Latäinescht Serbesch
 Name[lt]=Serbų lotyniška
@@ -8540,6 +8549,7 @@
 Name[pt_BR]=Sérvio Latino
 Name[ro]=Sîrbă latină
 Name[ru]=Сербский латинницей
+Name[sk]=Srbský Latinka
 Name[sl]=srbsko latinsko
 Name[sr]=Српски латинични
 Name[sr@Latn]=Srpski latinični
@@ -8549,6 +8559,7 @@
 Name[uz]=Сербча (Лотин)
 Name[vi]=Xéc-bi (La-tinh)
 Name[zh_CN]=塞尔维亚语(拉丁)
+Name[zh_TW]=賽爾維亞拉丁語
 [ss]
 Name=Swati
 Name[ar]=السواتي
@@ -10396,6 +10407,7 @@
 Name[vi]=Trung quốc (phổ thông)
 Name[zh_CN]=简体中文
 Name[zh_HK]=簡體中文
+Name[zh_TW]=簡體中文
 [zh_HK]
 Name=Chinese (Hong Kong)
 Name[br]=Sinaeg (Hong Kong)
@@ -10430,6 +10442,7 @@
 Name[pt_BR]=Chinês (Hong Kong)
 Name[ro]=Chineză (Hong Kong)
 Name[ru]=Китайский (Гонконг)
+Name[sk]=Čínsky (Hong Kong)
 Name[sl]=kitajsko (Hong Kong)
 Name[sr]=Кинески (Хонгконг)
 Name[sr@Latn]=Kineski (Hongkong)
@@ -10439,6 +10452,7 @@
 Name[uz]=Хитойча (Гонгконг)
 Name[vi]=Trung quốc (Hồng Kông)
 Name[zh_CN]=繁体中文(香港)
+Name[zh_TW]=正體中文（香港）
 [zh_TW]
 Name=Chinese Traditional
 Name[af]=Sjinese tradisioneel
@@ -10498,6 +10512,7 @@
 Name[vi]=Trung quốc (truyền thống)
 Name[zh_CN]=繁体中文
 Name[zh_HK]=繁體中文
+Name[zh_TW]=正體中文
 [zu]
 Name=Zulu
 Name[af]=Zoeloe
Index: kdecore/kconfig_compiler/tests/kconfigcompiler_test.cpp
===================================================================
--- kdecore/kconfig_compiler/tests/kconfigcompiler_test.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kdecore/kconfig_compiler/tests/kconfigcompiler_test.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -21,8 +21,8 @@
 
 using namespace KUnitTest;
 
-KUNITTEST_MODULE( kunittest_kconfigcompiler_test, "KConfigXT");
-KUNITTEST_MODULE_REGISTER_TESTER( KConfigCompiler_Test );
+KUNITTEST_MODULE( kunittest_kconfigcompiler_test, "KConfigXT")
+KUNITTEST_MODULE_REGISTER_TESTER( KConfigCompiler_Test )
 
 typedef const char * CompilerTestSet[];
 
Index: kdecore/network/kresolver.cpp
===================================================================
--- kdecore/network/kresolver.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kdecore/network/kresolver.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -942,7 +942,7 @@
 {
   const char *kde_use_idn = getenv("KDE_USE_IDN");
   if (!kde_use_idn)
-     kde_use_idn = "ac:at:cat:br:ch:cl:cn:de:dk:fi:hu:info:io:jp:kr:li:lt:museum:no:se:sh:th:tm:tw:vn";
+     kde_use_idn = "ac:at:br:cat:ch:cl:cn:de:dk:fi:gr:hu:info:io:is:jp:kr:li:lt:museum:org:no:se:sh:th:tm:tw:vn";
   return new QStringList(QStringList::split(':', QString::fromLatin1(kde_use_idn).lower()));
 }
 
Index: kdecore/tests/kconfigtest.cpp
===================================================================
--- kdecore/tests/kconfigtest.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kdecore/tests/kconfigtest.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -31,8 +31,8 @@
     void revertEntries();
 };
 
-KUNITTEST_MODULE( kunittest_kconfig, "KConfigTest" );
-KUNITTEST_MODULE_REGISTER_TESTER( KConfigTest );
+KUNITTEST_MODULE( kunittest_kconfig, "KConfigTest" )
+KUNITTEST_MODULE_REGISTER_TESTER( KConfigTest )
 
 // test data
 #define BOOLENTRY1 true
Index: kdecore/fakes.c
===================================================================
--- kdecore/fakes.c	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kdecore/fakes.c	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -157,7 +157,7 @@
 #ifndef HAVE_SETEUID
 int seteuid(uid_t euid)
 {
-    setreuid(-1, euid); /* Well, if you have neither you are in trouble :) */
+    return setreuid(-1, euid); /* Well, if you have neither you are in trouble :) */
 }
 #endif
 
Index: kdecore/kcrash.cpp
===================================================================
--- kdecore/kcrash.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kdecore/kcrash.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -319,9 +319,12 @@
   pid_t pid = fork();
   if (pid <= 0)
   {
-    setgid(getgid());
-    setuid(getuid());
+    if(!geteuid() && setgid(getgid()) < 0)
+      _exit(253);
+    if(!geteuid() && setuid(getuid()) < 0)
+      _exit(253);
     execvp("drkonqi", const_cast< char** >( argv ));
+    _exit(errno);
   }
   else
   {
Index: khtml/khtml_part.cpp
===================================================================
--- khtml/khtml_part.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/khtml_part.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -137,7 +137,7 @@
         {
             if ( m_cachedSheet ) m_cachedSheet->deref(this);
         }
-        virtual void setStyleSheet(const DOM::DOMString&, const DOM::DOMString &sheet)
+        virtual void setStyleSheet(const DOM::DOMString&, const DOM::DOMString &sheet, const DOM::DOMString &)
         {
           if ( m_part )
             m_part->setUserStyleSheet( sheet.string() );
@@ -1876,10 +1876,14 @@
     removeJSErrorExtension();
     setSuppressedPopupIndicator( false );
     d->m_openableSuppressedPopups = 0;
-    for ( KHTMLPart* part = d->m_suppressedPopupOriginParts.first(); part; part = d->m_suppressedPopupOriginParts.next() ) {
-       KJS::Window *w = KJS::Window::retrieveWindow( part );
-       if (w)
-           w->forgetSuppressedWindows();
+    for ( QValueListIterator<QGuardedPtr<KHTMLPart> > i = d->m_suppressedPopupOriginParts.begin();
+          i != d->m_suppressedPopupOriginParts.end(); ++i ) {
+       
+      if (KHTMLPart* part = *i) {
+        KJS::Window *w = KJS::Window::retrieveWindow( part );
+        if (w)
+          w->forgetSuppressedWindows();
+      }
     }
   }
 
@@ -6703,38 +6707,19 @@
 
             if ( node->id() == ID_IMG ||
                  node->id() == ID_IFRAME ||
-                 (node->id() == ID_INPUT && !strcasecmp( static_cast<ElementImpl *>(node)->getAttribute(ATTR_TYPE), "image")) )
+                 (node->id() == ID_INPUT && static_cast<HTMLInputElementImpl *>(node)->inputType() == HTMLInputElementImpl::IMAGE ))
             {
                 if ( KHTMLFactory::defaultHTMLSettings()->isAdFiltered( d->m_doc->completeURL( static_cast<ElementImpl *>(node)->getAttribute(ATTR_SRC).string() ) ) )
                 {
-                    // We found an IMG, IFRAME or INPUT (of type "image") matching a filter.
-
-                    // Detach the node from the document and rendering trees.
-                    node->detach();
-
-                    // Connect its siblings to each other instead.
-                    NodeImpl *next = node->nextSibling();
-                    NodeImpl *prev = node->previousSibling();
-
-                    if( next ) next->setPreviousSibling( prev );
-                    if( prev ) prev->setNextSibling( next );
-
-                    // If it's the first or last child of its parent, we cut it off there too.
+                    // We found an IMG, IFRAME or INPUT (of type IMAGE) matching a filter.
+                    node->ref();
                     NodeImpl *parent = node->parent();
                     if( parent )
                     {
-                        if( node == parent->firstChild() )
-                            parent->setFirstChild( next );
-
-                        if( node == parent->lastChild() )
-                            parent->setLastChild( prev );
+                        int exception = 0;
+                        parent->removeChild(node, exception);
                     }
-
-                    node->removedFromDocument();
-
-                    // If nobody needs this node, we can safely delete it.
-                    if( !node->refCount() )
-                        delete node;
+                    node->deref();
                 }
             }
         }
@@ -7379,7 +7364,7 @@
 
     if ( enable && originPart ) {
         d->m_openableSuppressedPopups++;
-        if ( d->m_suppressedPopupOriginParts.find( originPart ) == -1 )
+        if ( d->m_suppressedPopupOriginParts.findIndex( originPart ) == -1 )
             d->m_suppressedPopupOriginParts.append( originPart );
     }
 
@@ -7424,12 +7409,15 @@
 }
 
 void KHTMLPart::showSuppressedPopups() {
-    for ( KHTMLPart* part = d->m_suppressedPopupOriginParts.first(); part; part = d->m_suppressedPopupOriginParts.next() ) {
-       KJS::Window *w = KJS::Window::retrieveWindow( part );
-       if (w) {
-           w->showSuppressedWindows();
-           w->forgetSuppressedWindows();
-       }
+    for ( QValueListIterator<QGuardedPtr<KHTMLPart> > i = d->m_suppressedPopupOriginParts.begin();
+          i != d->m_suppressedPopupOriginParts.end(); ++i ) {
+      if (KHTMLPart* part = *i) {
+        KJS::Window *w = KJS::Window::retrieveWindow( part );
+        if (w) {
+            w->showSuppressedWindows();
+            w->forgetSuppressedWindows();
+        }
+      }
     }
     setSuppressedPopupIndicator( false );
     d->m_openableSuppressedPopups = 0;
Index: khtml/khtmlview.cpp
===================================================================
--- khtml/khtmlview.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/khtmlview.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -660,7 +660,14 @@
 	QWidget *w = it.current();
 	RenderWidget* rw = static_cast<RenderWidget*>( it.currentKey() );
 	if (w && rw && !rw->isKHTMLWidget()) { 
-            QRect g = w->geometry();
+            int x, y;
+            rw->absolutePosition(x, y);
+            contentsToViewport(x, y, x, y);
+            int pbx = rw->borderLeft()+rw->paddingLeft();
+            int pby = rw->borderTop()+rw->paddingTop();
+            QRect g = QRect(x+pbx, y+pby, 
+                            rw->width()-pbx-rw->borderRight()-rw->paddingRight(), 
+                            rw->height()-pby-rw->borderBottom()-rw->paddingBottom());
             if ( !rw->isFrame() && ((g.top() > pt.y()+eh) || (g.bottom() <= pt.y()) ||
                                     (g.right() <= pt.x()) || (g.left() > pt.x()+ew) ))
                 continue;
@@ -673,10 +680,7 @@
                 mask = mask.intersect( QRect(g.x(),g.y(),g.width(),g.height()) );
                 cr -= mask;
             } else {
-                int x, y;
-                rw->absolutePosition(x,y);
-                contentsToViewport(x,y,x,y);
-                cr -= QRect(x,y,rw->width(),rw->height());
+                cr -= g;
             }
         }
     }
Index: khtml/kmultipart/kmultipart.desktop
===================================================================
--- khtml/kmultipart/kmultipart.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/kmultipart/kmultipart.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -58,5 +58,6 @@
 Name[vi]=Thành phần có khả năng nhúng cho dạng thức thư đa phần/đã trộn (multipart/mixed).
 Name[zh_CN]=可嵌入的 multipart/mixed 组件
 Name[zh_HK]=multipart/mixed 的可嵌入元件
+Name[zh_TW]=multipart/mixed 的可嵌入元件
 ServiceTypes=KParts/ReadOnlyPart
 X-KDE-Library=libkmultipart
Index: khtml/html/htmltokenizer.cpp
===================================================================
--- khtml/html/htmltokenizer.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/html/htmltokenizer.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -388,9 +388,10 @@
 
     // Scripts following a frameset element should not be executed or even loaded in the case of extern scripts.
     bool followingFrameset = (parser->doc()->body() && parser->doc()->body()->id() == ID_FRAMESET);
+    bool effectiveScript = !parser->skipMode() && !followingFrameset;
     bool deferredScript = false;
 
-    if ( !parser->skipMode() && !followingFrameset) {
+    if ( effectiveScript ) {
         CachedScript* cs = 0;
 
         // forget what we just got, load from src url instead
@@ -413,13 +414,16 @@
             setSrc(TokenizerString());
             scriptCodeSize = scriptCodeResync = 0;
             scriptExecution( exScript, QString::null, tagStartLineno /*scriptStartLineno*/ );
+        } else {
+            // script was filtered or disallowed
+            effectiveScript = false;
         }
     }
 
     script = false;
     scriptCodeSize = scriptCodeResync = 0;
 
-    if (parser->skipMode() || followingFrameset)
+    if ( !effectiveScript )
         return;
 
     if ( !m_executingScript && cachedScript.isEmpty() ) {
@@ -427,8 +431,8 @@
     } else if ( cachedScript.isEmpty() ) {
         write( pendingQueue.pop(), false );
     } else if ( !deferredScript && pendingQueue.count() > 1) {
-       TokenizerString t = pendingQueue.pop();
-       pendingQueue.top().prepend( t );
+        TokenizerString t = pendingQueue.pop();
+        pendingQueue.top().prepend( t );
     }
 }
 
@@ -1317,7 +1321,10 @@
         return;
     }
 
-    setSrc(str);
+    if (!src.isEmpty())
+        src.append(str);
+    else
+        setSrc(str);
     m_abort = false;
 
 //     if (Entity)
Index: khtml/html/html_miscimpl.cpp
===================================================================
--- khtml/html/html_miscimpl.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/html/html_miscimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -91,6 +91,10 @@
         if(e->id() == ID_IMG)
             check = true;
         break;
+    case DOC_SCRIPTS:
+        if(e->id() == ID_SCRIPT)
+            check = true;
+        break;
     case DOC_FORMS:
         if(e->id() == ID_FORM)
             check = true;
@@ -213,7 +217,7 @@
         return NodeListImpl::item(index);
 
     //For table.rows, we first need to check header, then bodies, then footer.
-    //we pack any extra headers/footer with bodies. This matches IE, and 
+    //we pack any extra headers/footer with bodies. This matches IE, and
     //means doing the usual thing with length is right
     const HTMLTableElementImpl* table = static_cast<const HTMLTableElementImpl*>(m_refNode);
 
@@ -396,8 +400,8 @@
 }
 
 // -------------------------------------------------------------------------
-HTMLMappedNameCollectionImpl::HTMLMappedNameCollectionImpl(NodeImpl* _base, int _type, const DOMString& _name): 
-    HTMLCollectionImpl(_base, NodeListImpl::UNCACHEABLE), name(_name) 
+HTMLMappedNameCollectionImpl::HTMLMappedNameCollectionImpl(NodeImpl* _base, int _type, const DOMString& _name):
+    HTMLCollectionImpl(_base, NodeListImpl::UNCACHEABLE), name(_name)
 {
     type = _type; //We pass uncacheable to collection, but need our own type internally.
 }
@@ -411,7 +415,7 @@
     }
 
     HTMLElementImpl *e = static_cast<HTMLElementImpl *>(current);
-    
+
     return matchesName(e, type, name);
 }
 
Index: khtml/html/html_headimpl.cpp
===================================================================
--- khtml/html/html_headimpl.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/html/html_headimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -196,6 +196,9 @@
                 getDocument()->addPendingSheet();
 
             QString chset = getAttribute( ATTR_CHARSET ).string();
+            // set chset to charset of referring document when attribute CHARSET is absent.
+            // http://www.w3.org/TR/CSS21/syndata.html(4.4)
+            if (chset.isEmpty() && part) chset = part->encoding();
             if (m_cachedSheet)
 		m_cachedSheet->deref(this);
             m_cachedSheet = getDocument()->docLoader()->requestStyleSheet(m_url, chset);
@@ -230,12 +233,13 @@
     getDocument()->updateStyleSelector();
 }
 
-void HTMLLinkElementImpl::setStyleSheet(const DOM::DOMString &url, const DOM::DOMString &sheetStr)
+void HTMLLinkElementImpl::setStyleSheet(const DOM::DOMString &url, const DOM::DOMString &sheetStr, const DOM::DOMString &charset)
 {
     if (m_sheet)
         m_sheet->deref();
     m_sheet = new CSSStyleSheetImpl(this, url);
     m_sheet->ref();
+    m_sheet->setCharset(charset);
     m_sheet->parseString( sheetStr, !getDocument()->inCompatMode() );
 
     MediaListImpl *media = new MediaListImpl( m_sheet, m_media );
Index: khtml/html/html_formimpl.cpp
===================================================================
--- khtml/html/html_formimpl.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/html/html_formimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -1916,8 +1916,8 @@
 		getDocument()->setFocusNode(formNode);
 		if (formNode->id()==ID_INPUT)
 		    static_cast<DOM::HTMLInputElementImpl*>(formNode)->click();
+		evt->setDefaultHandled();
 	    }
-	    evt->setDefaultHandled();
 	}
     }
     HTMLGenericFormElementImpl::defaultEventHandler(evt);
Index: khtml/html/doctypes.gperf
===================================================================
--- khtml/html/doctypes.gperf	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/html/doctypes.gperf	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -1,8 +1,9 @@
 struct PubIDInfo {
     enum eMode { 
-        eQuirks,         
-        eQuirks3,       
-        eAlmostStandards
+        eQuirks,        /* always quirks mode, unless there's an internal subset */
+        eQuirks3,       /* ditto, but but pre-HTML4 (no tbody) */
+        eAlmostStandards,
+        eFullStandards
     };
 
     const char* name;
@@ -10,6 +11,7 @@
     eMode mode_if_sysid;
 }
 %%
+"+//silmaril//dtd html pro v0r11 19970101//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
 "-//advasoft ltd//dtd html 3.0 aswedit + extensions//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
 "-//as//dtd html 3.0 aswedit + extensions//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
 "-//ietf//dtd html 2.0 level 1//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
@@ -24,15 +26,46 @@
 "-//ietf//dtd html 3.2 final//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
 "-//ietf//dtd html 3.2//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
 "-//ietf//dtd html 3//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//ietf//dtd html level 0//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//ietf//dtd html level 0//en//2.0", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//ietf//dtd html level 1//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//ietf//dtd html level 1//en//2.0", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//ietf//dtd html level 2//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//ietf//dtd html level 2//en//2.0", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//ietf//dtd html level 3//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//ietf//dtd html level 3//en//3.0", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//ietf//dtd html strict level 0//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//ietf//dtd html strict level 0//en//2.0", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//ietf//dtd html strict level 1//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//ietf//dtd html strict level 1//en//2.0", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//ietf//dtd html strict level 2//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//ietf//dtd html strict level 2//en//2.0", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//ietf//dtd html strict level 3//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//ietf//dtd html strict level 3//en//3.0", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//ietf//dtd html strict//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//ietf//dtd html strict//en//2.0", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//ietf//dtd html strict//en//3.0", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
 "-//ietf//dtd html//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
 "-//ietf//dtd html//en//2.0", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
 "-//ietf//dtd html//en//3.0", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//metrius//dtd metrius presentational//en", PubIDInfo::eQuirks, PubIDInfo::eQuirks
+"-//microsoft//dtd internet explorer 2.0 html strict//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//microsoft//dtd internet explorer 2.0 html//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//microsoft//dtd internet explorer 2.0 tables//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//microsoft//dtd internet explorer 3.0 html strict//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//microsoft//dtd internet explorer 3.0 html//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//microsoft//dtd internet explorer 3.0 tables//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
 "-//netscape comm. corp.//dtd html//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//netscape comm. corp.//dtd strict html//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
 "-//o'reilly and associates//dtd html 2.0//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//o'reilly and associates//dtd html extended 1.0//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//o'reilly and associates//dtd html extended relaxed 1.0//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
 "-//softquad software//dtd hotmetal pro 6.0::19990601::extensions to html 4.0//en", PubIDInfo::eQuirks, PubIDInfo::eQuirks
 "-//softquad//dtd hotmetal pro 4.0::19971010::extensions to html 4.0//en", PubIDInfo::eQuirks, PubIDInfo::eQuirks
 "-//spyglass//dtd html 2.0 extended//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
 "-//sq//dtd html 2.0 hotmetal + extensions//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//sun microsystems corp.//dtd hotjava html//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//sun microsystems corp.//dtd hotjava strict html//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
 "-//w30//dtd w3 html 2.0//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
 "-//w3c//dtd html 3 1995-03-24//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
 "-//w3c//dtd html 3.2 draft//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
@@ -51,4 +84,8 @@
 "-//w3c//dtd xhtml 1.1//en", PubIDInfo::eAlmostStandards, PubIDInfo::eAlmostStandards
 "-//w3o//dtd w3 html 3.0//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
 "-//w3o//dtd w3 html 3.0//en//", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//w3o//dtd w3 html strict 3.0//en//", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
 "-//webtechs//dtd mozilla html 2.0//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-//webtechs//dtd mozilla html//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
+"-/w3c/dtd html 4.0 transitional/en", PubIDInfo::eQuirks, PubIDInfo::eQuirks
+"html", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3
\ No newline at end of file
Index: khtml/html/html_baseimpl.cpp
===================================================================
--- khtml/html/html_baseimpl.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/html/html_baseimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -584,6 +584,7 @@
     marginWidth = 0;
     marginHeight = 0;
     needWidgetUpdate = false;
+    m_frame = true;
 }
 
 HTMLIFrameElementImpl::~HTMLIFrameElementImpl()
@@ -615,17 +616,41 @@
         needWidgetUpdate = true; // ### do this for scrolling, margins etc?
         HTMLFrameElementImpl::parseAttribute( attr );
         break;
+    case ATTR_FRAMEBORDER:
+    {
+        m_frame = (!attr->val() || attr->value().toInt() > 0);
+        if (attached()) updateFrame();
+    }
     default:
         HTMLFrameElementImpl::parseAttribute( attr );
     }
 }
 
+void HTMLIFrameElementImpl::updateFrame()
+{
+    if (m_frame) {
+        addCSSProperty(CSS_PROP_BORDER_TOP_STYLE, CSS_VAL_OUTSET);
+        addCSSProperty(CSS_PROP_BORDER_BOTTOM_STYLE, CSS_VAL_OUTSET);
+        addCSSProperty(CSS_PROP_BORDER_LEFT_STYLE, CSS_VAL_OUTSET);
+        addCSSProperty(CSS_PROP_BORDER_RIGHT_STYLE, CSS_VAL_OUTSET);
+        addCSSLength(CSS_PROP_BORDER_WIDTH, "2");
+    } else {
+        addCSSProperty(CSS_PROP_BORDER_TOP_STYLE, CSS_VAL_NONE);
+        addCSSProperty(CSS_PROP_BORDER_BOTTOM_STYLE, CSS_VAL_NONE);
+        addCSSProperty(CSS_PROP_BORDER_LEFT_STYLE, CSS_VAL_NONE);
+        addCSSProperty(CSS_PROP_BORDER_RIGHT_STYLE, CSS_VAL_NONE);
+        removeCSSProperty(CSS_PROP_BORDER_WIDTH);
+    }
+
+}
+
 void HTMLIFrameElementImpl::attach()
 {
     assert(!attached());
     assert(!m_render);
     assert(parentNode());
 
+    updateFrame();
     name = getAttribute(ATTR_NAME);
     if (name.isNull())
         name = getAttribute(ATTR_ID);
Index: khtml/html/html_elementimpl.cpp
===================================================================
--- khtml/html/html_elementimpl.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/html/html_elementimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -450,9 +450,11 @@
 
 DOMString HTMLElementImpl::innerHTML() const
 {
-    DOMString result = "";
-    for (NodeImpl *child = firstChild(); child != NULL; child = child->nextSibling())
-        result += child->toString();
+    QString result; //Use QString to accumulate since DOMString is poor for appends
+    for (NodeImpl *child = firstChild(); child != NULL; child = child->nextSibling()) {
+        DOMString kid = child->toString();
+        result += QConstString(kid.unicode(), kid.length()).string();
+    }
     return result;
 }
 
Index: khtml/html/html_miscimpl.h
===================================================================
--- khtml/html/html_miscimpl.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/html/html_miscimpl.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -57,6 +57,7 @@
         DOC_LAYERS,    // all LAYERS
         DOC_LINKS,     // all A _and_ AREA elements with a value for href
         DOC_ANCHORS,      // all A elements with a value for name
+        DOC_SCRIPTS,   // all SCRIPT elements
         // from HTMLTable, HTMLTableSection, HTMLTableRow
         TABLE_ROWS,    // all rows in this table
         TABLE_TBODIES, // all TBODY elements in this table
@@ -93,7 +94,7 @@
     }
 protected:
     virtual unsigned long calcLength(NodeImpl *start) const;
-    
+
     // The collection list the following elements
     int type:8;
 
@@ -130,7 +131,7 @@
 };
 
 /*
- Special collection for items of given name/id under document. or window.; but using 
+ Special collection for items of given name/id under document. or window.; but using
  iteration interface
 */
 class HTMLMappedNameCollectionImpl : public HTMLCollectionImpl
Index: khtml/html/dtd.cpp
===================================================================
--- khtml/html/dtd.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/html/dtd.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -599,8 +599,8 @@
         // _1 *
         return check_array(childID, tag_list_1) || check_array(childID, tag_list_6);
     case ID_P:
-        // P: ( _0 | TABLE ) *
-        return check_array(childID, tag_list_0) || (!strict && childID == ID_TABLE);
+        // P: ( _0 | TABLE | NOSCRIPT) *
+        return check_array(childID, tag_list_0) || (!strict && (childID == ID_TABLE || childID == ID_NOSCRIPT));
     case ID_H1:
     case ID_H2:
     case ID_H3:
Index: khtml/html/html_headimpl.h
===================================================================
--- khtml/html/html_headimpl.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/html/html_headimpl.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -91,7 +91,7 @@
     virtual void removedFromDocument();
 
     // from CachedObjectClient
-    virtual void setStyleSheet(const DOM::DOMString &url, const DOM::DOMString &sheet);
+    virtual void setStyleSheet(const DOM::DOMString &url, const DOM::DOMString &sheet, const DOM::DOMString &charset);
     virtual void error(int err, const QString &text);
     bool isLoading() const;
     void sheetLoaded();
Index: khtml/html/htmlparser.cpp
===================================================================
--- khtml/html/htmlparser.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/html/htmlparser.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -329,6 +329,11 @@
 #ifdef PARSER_DEBUG
         kdDebug( 6035 ) << "added " << n->nodeName().string() << " to " << tmp->nodeName().string() << ", new current=" << newNode->nodeName().string() << endl;
 #endif
+        // We allow TABLE > FORM in dtd.cpp, but do not allow the form have children in this case
+        if (current->id() == ID_TABLE && id == ID_FORM) {
+            flat = true;
+            static_cast<HTMLFormElementImpl*>(n)->setMalformed(true);
+        }
 
 	// don't push elements without end tag on the stack
         if(tagPriority[id] != 0 && !flat) {
@@ -353,6 +358,7 @@
 	    if(n->isInline()) m_inline = true;
         }
 
+
 #if SPEED_DEBUG < 1
         if(tagPriority[id] == 0 && n->renderer())
             n->renderer()->calcMinMaxWidth();
@@ -366,12 +372,11 @@
         HTMLElementImpl *e;
         bool handled = false;
 
-        // first switch on current element for a elements with optional end-tag
+        // first switch on current element for elements with optional end-tag and inline-only content
         switch(current->id())
         {
         case ID_P:
-        case ID_DD:
-        case ID_LI:
+        case ID_DT:
             if(!n->isInline())
             {
                 popBlock(current->id());
@@ -1261,6 +1266,8 @@
         case ID_VAR:
         case ID_DEL:
         case ID_INS:
+        case ID_WBR:
+        case ID_NOBR:
             return true;
         default:
             return false;
Index: khtml/html/html_documentimpl.cpp
===================================================================
--- khtml/html/html_documentimpl.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/html/html_documentimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -399,7 +399,7 @@
 
         // We need to trim whitespace off the public identifier.
         publicID = buffer.mid(publicIDStart, publicIDEnd - publicIDStart);
-        publicID = publicID.stripWhiteSpace();
+        publicID = publicID.simplifyWhiteSpace();
         *resultFlags |= PARSEMODE_HAVE_PUBLIC_ID;
     } else {
         if (containsString("system", buffer, index)) {
@@ -476,6 +476,7 @@
             const PubIDInfo* doctypeEntry = findDoctypeEntry(pubIDStr, publicID.length());
             if (!doctypeEntry) {
                 // The DOCTYPE is not in the list.  Assume strict mode.
+                // ### Doesn't make any sense, but it's what Mozilla does.
                 pMode = Strict;
                 hMode = Html4;
                 return;
Index: khtml/html/html_baseimpl.h
===================================================================
--- khtml/html/html_baseimpl.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/html/html_baseimpl.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -190,7 +190,11 @@
     virtual void recalcStyle( StyleChange ch );
 
 protected:
+
+    void updateFrame();
+
     bool needWidgetUpdate;
+    bool m_frame;
 };
 
 
Index: khtml/html/doctypes.cpp
===================================================================
--- khtml/html/doctypes.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/html/doctypes.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -31,16 +31,17 @@
 #line 1 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
 struct PubIDInfo {
     enum eMode { 
-        eQuirks,         
-        eQuirks3,       
-        eAlmostStandards
+        eQuirks,        /* always quirks mode, unless there's an internal subset */
+        eQuirks3,       /* ditto, but but pre-HTML4 (no tbody) */
+        eAlmostStandards,
+        eFullStandards
     };
 
     const char* name;
     eMode mode_if_no_sysid;
     eMode mode_if_sysid;
 };
-/* maximum key range = 173, duplicates = 0 */
+/* maximum key range = 727, duplicates = 0 */
 
 #ifdef __GNUC__
 __inline
@@ -52,34 +53,34 @@
 static unsigned int
 hash (register const char *str, register unsigned int len)
 {
-  static const unsigned char asso_values[] =
+  static const unsigned short asso_values[] =
     {
-      236, 236, 236, 236, 236, 236, 236, 236, 236, 236,
-      236, 236, 236, 236, 236, 236, 236, 236, 236, 236,
-      236, 236, 236, 236, 236, 236, 236, 236, 236, 236,
-      236, 236,   0, 236, 236, 236, 236, 236, 236,   0,
-      236, 236, 236,   0, 236,   0,   0,   0,  10,   0,
-        5,   0,   5,   0,   0,   0, 236,   0,   0, 236,
-      236, 236, 236, 236, 236, 236, 236, 236, 236, 236,
-      236, 236, 236, 236, 236, 236, 236, 236, 236, 236,
-      236, 236, 236, 236, 236, 236, 236, 236, 236, 236,
-      236, 236, 236, 236, 236, 236, 236,   5,  10,   0,
-       10,   0,  10,   0,   0,   0, 236, 236,   0,  15,
-        5,   0,   0,   0,   0,   0,   0,   0,   0,   0,
-        0,   0,   5, 236, 236, 236, 236, 236, 236, 236,
-      236, 236, 236, 236, 236, 236, 236, 236, 236, 236,
-      236, 236, 236, 236, 236, 236, 236, 236, 236, 236,
-      236, 236, 236, 236, 236, 236, 236, 236, 236, 236,
-      236, 236, 236, 236, 236, 236, 236, 236, 236, 236,
-      236, 236, 236, 236, 236, 236, 236, 236, 236, 236,
-      236, 236, 236, 236, 236, 236, 236, 236, 236, 236,
-      236, 236, 236, 236, 236, 236, 236, 236, 236, 236,
-      236, 236, 236, 236, 236, 236, 236, 236, 236, 236,
-      236, 236, 236, 236, 236, 236, 236, 236, 236, 236,
-      236, 236, 236, 236, 236, 236, 236, 236, 236, 236,
-      236, 236, 236, 236, 236, 236, 236, 236, 236, 236,
-      236, 236, 236, 236, 236, 236, 236, 236, 236, 236,
-      236, 236, 236, 236, 236, 236
+      731, 731, 731, 731, 731, 731, 731, 731, 731, 731,
+      731, 731, 731, 731, 731, 731, 731, 731, 731, 731,
+      731, 731, 731, 731, 731, 731, 731, 731, 731, 731,
+      731, 731,   0, 731, 731, 731, 731, 731, 731,   0,
+      731, 731, 731,   0, 731,   0,  15,   0,  10,  25,
+        5,   0,   5,  15,   5,   5, 731,   5,   0, 731,
+      731, 731, 731, 731, 731, 731, 731, 731, 731, 731,
+      731, 731, 731, 731, 731, 731, 731, 731, 731, 731,
+      731, 731, 731, 731, 731, 731, 731, 731, 731, 731,
+      731, 731, 731, 731, 731, 731, 731,  10,   5,   0,
+       40,   0,  20,  10,   0,   0,   0, 731,   0,   0,
+       10,  45,   0,   0,   0,   0,   0,   0,   0,   0,
+       10,   0,   5, 731, 731, 731, 731, 731, 731, 731,
+      731, 731, 731, 731, 731, 731, 731, 731, 731, 731,
+      731, 731, 731, 731, 731, 731, 731, 731, 731, 731,
+      731, 731, 731, 731, 731, 731, 731, 731, 731, 731,
+      731, 731, 731, 731, 731, 731, 731, 731, 731, 731,
+      731, 731, 731, 731, 731, 731, 731, 731, 731, 731,
+      731, 731, 731, 731, 731, 731, 731, 731, 731, 731,
+      731, 731, 731, 731, 731, 731, 731, 731, 731, 731,
+      731, 731, 731, 731, 731, 731, 731, 731, 731, 731,
+      731, 731, 731, 731, 731, 731, 731, 731, 731, 731,
+      731, 731, 731, 731, 731, 731, 731, 731, 731, 731,
+      731, 731, 731, 731, 731, 731, 731, 731, 731, 731,
+      731, 731, 731, 731, 731, 731, 731, 731, 731, 731,
+      731, 731, 731, 731, 731, 731
     };
   register int hval = len;
 
@@ -337,11 +338,11 @@
 {
   enum
     {
-      TOTAL_KEYWORDS = 42,
-      MIN_WORD_LENGTH = 21,
+      TOTAL_KEYWORDS = 78,
+      MIN_WORD_LENGTH = 4,
       MAX_WORD_LENGTH = 80,
-      MIN_HASH_VALUE = 63,
-      MAX_HASH_VALUE = 235
+      MIN_HASH_VALUE = 4,
+      MAX_HASH_VALUE = 730
     };
 
   static const struct PubIDInfo wordlist[] =
@@ -350,6 +351,8 @@
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 91 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"html", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
@@ -409,113 +412,342 @@
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
-#line 48 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 81 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
       {"-//w3c//dtd w3 html//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
-#line 51 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
-      {"-//w3c//dtd xhtml 1.1//en", PubIDInfo::eAlmostStandards, PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
-#line 40 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
-      {"-//w3c//dtd html 3.2//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
-#line 27 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 48 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
       {"-//ietf//dtd html//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
-#line 26 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+#line 28 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
       {"-//ietf//dtd html 3//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 73 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//w3c//dtd html 3.2//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
-#line 52 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
-      {"-//w3o//dtd w3 html 3.0//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 45 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//ietf//dtd html strict//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 35 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//ietf//dtd html level 3//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
-#line 53 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
-      {"-//w3o//dtd w3 html 3.0//en//", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
-#line 25 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 33 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//ietf//dtd html level 2//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 43 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//ietf//dtd html strict level 3//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 29 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//ietf//dtd html level 0//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 41 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//ietf//dtd html strict level 2//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 27 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
       {"-//ietf//dtd html 3.2//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
-#line 21 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
-      {"-//ietf//dtd html 2.1e//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 37 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//ietf//dtd html strict level 0//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 69 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//w30//dtd w3 html 2.0//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
-      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
-#line 22 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+#line 24 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
       {"-//ietf//dtd html 3.0//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
-#line 29 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+#line 50 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
       {"-//ietf//dtd html//en//3.0", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
-#line 23 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+#line 25 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
       {"-//ietf//dtd html 3.0//en//", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
-      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
-#line 20 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+#line 31 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//ietf//dtd html level 1//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 22 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
       {"-//ietf//dtd html 2.0//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
-#line 28 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+#line 49 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
       {"-//ietf//dtd html//en//2.0", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 47 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//ietf//dtd html strict//en//3.0", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
 #line 36 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
-      {"-//w30//dtd w3 html 2.0//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
-#line 37 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
-      {"-//w3c//dtd html 3 1995-03-24//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+      {"-//ietf//dtd html level 3//en//3.0", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
 #line 39 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//ietf//dtd html strict level 1//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 21 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//ietf//dtd html 2.0 strict//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 46 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//ietf//dtd html strict//en//2.0", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 44 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//ietf//dtd html strict level 3//en//3.0", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 18 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//ietf//dtd html 2.0 level 2//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 34 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//ietf//dtd html level 2//en//2.0", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 72 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
       {"-//w3c//dtd html 3.2 final//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 23 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//ietf//dtd html 2.1e//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
-#line 19 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
-      {"-//ietf//dtd html 2.0 strict//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
-#line 15 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+#line 75 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//w3c//dtd html 4.0 frameset//en", PubIDInfo::eQuirks, PubIDInfo::eQuirks},
+#line 30 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//ietf//dtd html level 0//en//2.0", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 20 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//ietf//dtd html 2.0 strict level 2//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 42 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//ietf//dtd html strict level 2//en//2.0", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 85 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//w3o//dtd w3 html 3.0//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 89 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//webtechs//dtd mozilla html//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 86 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//w3o//dtd w3 html 3.0//en//", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 84 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//w3c//dtd xhtml 1.1//en", PubIDInfo::eAlmostStandards, PubIDInfo::eAlmostStandards},
+#line 38 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//ietf//dtd html strict level 0//en//2.0", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 70 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//w3c//dtd html 3 1995-03-24//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 87 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//w3o//dtd w3 html strict 3.0//en//", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 17 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
       {"-//ietf//dtd html 2.0 level 1//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 32 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//ietf//dtd html level 1//en//2.0", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
-#line 38 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+#line 26 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//ietf//dtd html 3.2 final//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 19 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//ietf//dtd html 2.0 strict level 1//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 40 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//ietf//dtd html strict level 1//en//2.0", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 77 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//w3c//dtd html 4.01 frameset//en", PubIDInfo::eQuirks, PubIDInfo::eAlmostStandards},
+#line 71 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
       {"-//w3c//dtd html 3.2 draft//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
-#line 41 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+#line 74 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
       {"-//w3c//dtd html 3.2s draft//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
-#line 16 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
-      {"-//ietf//dtd html 2.0 level 2//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
-#line 17 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
-      {"-//ietf//dtd html 2.0 strict level 1//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
-#line 24 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
-      {"-//ietf//dtd html 3.2 final//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 82 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//w3c//dtd xhtml 1.0 frameset//en", PubIDInfo::eAlmostStandards, PubIDInfo::eAlmostStandards},
+#line 80 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//w3c//dtd html experimental 970421//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
-#line 50 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
-      {"-//w3c//dtd xhtml 1.0 transitional//en", PubIDInfo::eAlmostStandards, PubIDInfo::eAlmostStandards},
+#line 51 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//metrius//dtd metrius presentational//en", PubIDInfo::eQuirks, PubIDInfo::eQuirks},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
-#line 18 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
-      {"-//ietf//dtd html 2.0 strict level 2//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
-#line 43 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 88 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//webtechs//dtd mozilla html 2.0//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 90 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-/w3c/dtd html 4.0 transitional/en", PubIDInfo::eQuirks, PubIDInfo::eQuirks},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 76 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
       {"-//w3c//dtd html 4.0 transitional//en", PubIDInfo::eQuirks, PubIDInfo::eQuirks},
-#line 45 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
-      {"-//w3c//dtd html 4.01 transitional//en", PubIDInfo::eQuirks, PubIDInfo::eAlmostStandards},
-#line 49 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
-      {"-//w3c//dtd xhtml 1.0 frameset//en", PubIDInfo::eAlmostStandards, PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
-#line 30 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 79 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//w3c//dtd html experimental 19960712//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 58 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
       {"-//netscape comm. corp.//dtd html//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
-#line 42 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
-      {"-//w3c//dtd html 4.0 frameset//en", PubIDInfo::eQuirks, PubIDInfo::eQuirks},
-#line 44 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
-      {"-//w3c//dtd html 4.01 frameset//en", PubIDInfo::eQuirks, PubIDInfo::eAlmostStandards},
+#line 78 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//w3c//dtd html 4.01 transitional//en", PubIDInfo::eQuirks, PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
-#line 46 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
-      {"-//w3c//dtd html experimental 19960712//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
-#line 34 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 83 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//w3c//dtd xhtml 1.0 transitional//en", PubIDInfo::eAlmostStandards, PubIDInfo::eAlmostStandards},
+#line 59 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//netscape comm. corp.//dtd strict html//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 65 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
       {"-//spyglass//dtd html 2.0 extended//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
-#line 14 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 16 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
       {"-//as//dtd html 3.0 aswedit + extensions//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
-#line 47 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
-      {"-//w3c//dtd html experimental 970421//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 66 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//sq//dtd html 2.0 hotmetal + extensions//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
-#line 54 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
-      {"-//webtechs//dtd mozilla html 2.0//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
-#line 31 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 67 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//sun microsystems corp.//dtd hotjava html//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 68 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//sun microsystems corp.//dtd hotjava strict html//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 60 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
       {"-//o'reilly and associates//dtd html 2.0//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
-#line 35 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
-      {"-//sq//dtd html 2.0 hotmetal + extensions//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
@@ -529,22 +761,36 @@
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 56 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//microsoft//dtd internet explorer 3.0 html//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 53 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//microsoft//dtd internet explorer 2.0 html//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 55 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//microsoft//dtd internet explorer 3.0 html strict//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 14 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"+//silmaril//dtd html pro v0r11 19970101//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+#line 52 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//microsoft//dtd internet explorer 2.0 html strict//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 57 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//microsoft//dtd internet explorer 3.0 tables//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 54 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//microsoft//dtd internet explorer 2.0 tables//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
@@ -554,11 +800,92 @@
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
-#line 13 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 15 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
       {"-//advasoft ltd//dtd html 3.0 aswedit + extensions//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 61 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//o'reilly and associates//dtd html extended 1.0//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
@@ -602,7 +929,167 @@
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
-#line 33 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 62 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"-//o'reilly and associates//dtd html extended relaxed 1.0//en", PubIDInfo::eQuirks3, PubIDInfo::eQuirks3},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 64 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
       {"-//softquad//dtd hotmetal pro 4.0::19971010::extensions to html 4.0//en", PubIDInfo::eQuirks, PubIDInfo::eQuirks},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
@@ -622,7 +1109,52 @@
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
       {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
-#line 32 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+      {"",PubIDInfo::eAlmostStandards,PubIDInfo::eAlmostStandards},
+#line 63 "/opt/src/kde/kdelibs/khtml/html/doctypes.gperf"
       {"-//softquad software//dtd hotmetal pro 6.0::19990601::extensions to html 4.0//en", PubIDInfo::eQuirks, PubIDInfo::eQuirks}
     };
 
Index: khtml/ecma/xmlserializer.cpp
===================================================================
--- khtml/ecma/xmlserializer.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/ecma/xmlserializer.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -79,21 +79,20 @@
 	return Undefined();
       }
 
-      if (!args[0].toObject(exec).inherits(&DOMDocument::info)) {
+      if (!args[0].toObject(exec).inherits(&DOMNode::info)) {
 	return Undefined();
       }
 
-      DOM::Node docNode = static_cast<KJS::DOMDocument *>(args[0].toObject(exec).imp())->toNode();
-      DOM::DocumentImpl *doc = static_cast<DOM::DocumentImpl *>(docNode.handle());
+      DOM::NodeImpl *node = static_cast<DOM::NodeImpl *>(static_cast<KJS::DOMNode *>(args[0].toObject(exec).imp())->toNode().handle());
 
-      if (!doc) {
+      if (!node) {
 	return Undefined();
       }
 
       QString body;
 
       try {
-	  body = doc->toString().string();
+	  body = node->toString().string();
       } catch(DOM::DOMException& e) {
 	  Object err = Error::create(exec, GeneralError, "Exception serializing document");
 	  exec->setException(err);
Index: khtml/ecma/kjs_html.cpp
===================================================================
--- khtml/ecma/kjs_html.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/ecma/kjs_html.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -289,22 +289,8 @@
       return getHTMLCollection(exec,doc.layers(), true);
     case Anchors:
       return getHTMLCollection(exec,doc.anchors());
-    case Scripts: // TODO (IE-specific)
-    {
-      // Disable document.scripts unless we try to be IE-compatible
-      // Especially since it's not implemented, so
-      // if (document.scripts) shouldn't return true.
-      if ( exec->interpreter()->compatMode() != Interpreter::IECompat )
-        return Undefined();
-      // To be implemented. Meanwhile, return an object with a length property set to 0
-      // This gets some code going on IE-specific pages.
-      // The script object isn't really simple to implement though
-      // (http://msdn.microsoft.com/workshop/author/dhtml/reference/objects/script.asp)
-      kdDebug(6070) << "WARNING: KJS::HTMLDocument document.scripts called - not implemented" << endl;
-      Object obj( new ObjectImp() );
-      obj.put( exec, lengthPropertyName, Number(0) );
-      return obj;
-    }
+    case Scripts:
+      return getHTMLCollection(exec,doc.scripts());
     case All:
       // Disable document.all when we try to be Netscape-compatible
       if ( exec->interpreter()->compatMode() == Interpreter::NetscapeCompat )
Index: khtml/ecma/kjs_debugwin.cpp
===================================================================
--- khtml/ecma/kjs_debugwin.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/ecma/kjs_debugwin.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -731,6 +731,10 @@
     }
   }
   else {
+    // Ensure that each source file to be displayed is associated with
+    // an appropriate interpreter
+    if (!sourceFile->interpreter)
+      sourceFile->interpreter = exec->interpreter();
     for (index = 0; index < m_sourceSel->count(); index++) {
       if (m_sourceSelFiles.at(index) == sourceFile)
 	break;
Index: khtml/ecma/kjs_window.cpp
===================================================================
--- khtml/ecma/kjs_window.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/ecma/kjs_window.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -2464,8 +2464,10 @@
     break;
   case Location::Reload: {
     KHTMLPart *khtmlpart = ::qt_cast<KHTMLPart *>(part);
-    if (part)
+    if (khtmlpart)
       khtmlpart->scheduleRedirection(-1, part->url().url(), true/*lock history*/);
+    else
+      part->openURL(part->url());
     break;
   }
   case Location::ToString:
Index: khtml/rendering/render_style.cpp
===================================================================
--- khtml/rendering/render_style.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/rendering/render_style.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -106,10 +106,14 @@
 BackgroundLayer::BackgroundLayer()
 :m_image(RenderStyle::initialBackgroundImage()),
  m_bgAttachment(RenderStyle::initialBackgroundAttachment()),
+ m_bgClip(RenderStyle::initialBackgroundClip()),
+ m_bgOrigin(RenderStyle::initialBackgroundOrigin()),
  m_bgRepeat(RenderStyle::initialBackgroundRepeat()),
+ m_backgroundSize(RenderStyle::initialBackgroundSize()),
  m_next(0)
 {
-    m_imageSet = m_attachmentSet = m_repeatSet = m_xPosSet = m_yPosSet = false;
+    m_imageSet = m_attachmentSet = m_clipSet = m_originSet = 
+            m_repeatSet = m_xPosSet = m_yPosSet = m_backgroundSizeSet = false;
 }
 
 BackgroundLayer::BackgroundLayer(const BackgroundLayer& o)
@@ -119,12 +123,18 @@
     m_xPosition = o.m_xPosition;
     m_yPosition = o.m_yPosition;
     m_bgAttachment = o.m_bgAttachment;
+    m_bgClip = o.m_bgClip;
+    m_bgOrigin = o.m_bgOrigin;
     m_bgRepeat = o.m_bgRepeat;
+    m_backgroundSize = o.m_backgroundSize;
     m_imageSet = o.m_imageSet;
     m_attachmentSet = o.m_attachmentSet;
+    m_clipSet = o.m_clipSet;
+    m_originSet = o.m_originSet;
     m_repeatSet = o.m_repeatSet;
     m_xPosSet = o.m_xPosSet;
     m_yPosSet = o.m_yPosSet;
+    m_backgroundSizeSet = o.m_backgroundSizeSet;
 }
 
 BackgroundLayer::~BackgroundLayer()
@@ -142,22 +152,28 @@
     m_xPosition = o.m_xPosition;
     m_yPosition = o.m_yPosition;
     m_bgAttachment = o.m_bgAttachment;
+    m_bgClip = o.m_bgClip;
+    m_bgOrigin = o.m_bgOrigin;
     m_bgRepeat = o.m_bgRepeat;
+    m_backgroundSize = o.m_backgroundSize;
 
     m_imageSet = o.m_imageSet;
     m_attachmentSet = o.m_attachmentSet;
+    m_originSet = o.m_originSet;
     m_repeatSet = o.m_repeatSet;
     m_xPosSet = o.m_xPosSet;
     m_yPosSet = o.m_yPosSet;
+    m_backgroundSizeSet = o.m_backgroundSizeSet;
 
     return *this;
 }
 
 bool BackgroundLayer::operator==(const BackgroundLayer& o) const {
     return m_image == o.m_image && m_xPosition == o.m_xPosition && m_yPosition == o.m_yPosition &&
-           m_bgAttachment == o.m_bgAttachment && m_bgRepeat == o.m_bgRepeat &&
-           m_imageSet == o.m_imageSet && m_attachmentSet == o.m_attachmentSet && m_repeatSet == o.m_repeatSet &&
-           m_xPosSet == o.m_xPosSet && m_yPosSet == o.m_yPosSet &&
+           m_bgAttachment == o.m_bgAttachment && m_bgClip == o.m_bgClip && m_bgOrigin == o.m_bgOrigin && m_bgRepeat == o.m_bgRepeat &&
+           m_backgroundSize.width == o.m_backgroundSize.width && m_backgroundSize.height == o.m_backgroundSize.height && 
+           m_imageSet == o.m_imageSet && m_attachmentSet == o.m_attachmentSet && m_repeatSet == o.m_repeatSet && 
+           m_xPosSet == o.m_xPosSet && m_yPosSet == o.m_yPosSet && m_backgroundSizeSet == o.m_backgroundSizeSet && 
            ((m_next && o.m_next) ? *m_next == *o.m_next : m_next == o.m_next);
 }
 
@@ -208,6 +224,28 @@
         }
     }
 
+    for (curr = this; curr && curr->isBackgroundClipSet(); curr = curr->next());
+    if (curr && curr != this) {
+        // We need to fill in the remaining values with the pattern specified.
+        for (BackgroundLayer* pattern = this; curr; curr = curr->next()) {
+            curr->m_bgClip = pattern->m_bgClip;
+            pattern = pattern->next();
+            if (pattern == curr || !pattern)
+                pattern = this;
+        }
+    }
+
+    for (curr = this; curr && curr->isBackgroundOriginSet(); curr = curr->next());
+    if (curr && curr != this) {
+        // We need to fill in the remaining values with the pattern specified.
+        for (BackgroundLayer* pattern = this; curr; curr = curr->next()) {
+            curr->m_bgOrigin = pattern->m_bgOrigin;
+            pattern = pattern->next();
+            if (pattern == curr || !pattern)
+                pattern = this;
+        }
+    }
+
     for (curr = this; curr && curr->isBackgroundRepeatSet(); curr = curr->next());
     if (curr && curr != this) {
         // We need to fill in the remaining values with the pattern specified.
@@ -218,6 +256,17 @@
                 pattern = this;
         }
     }
+    
+    for (curr = this; curr && curr->isBackgroundSizeSet(); curr = curr->next());
+    if (curr && curr != this) {
+        // We need to fill in the remaining values with the pattern specified.
+        for (BackgroundLayer* pattern = this; curr; curr = curr->next()) {
+            curr->m_backgroundSize = pattern->m_backgroundSize;
+            pattern = pattern->next();
+            if (pattern == curr || !pattern)
+                pattern = this;
+        }
+    }
 }
 
 void BackgroundLayer::cullEmptyLayers()
@@ -227,7 +276,9 @@
         next = p->m_next;
         if (next && !next->isBackgroundImageSet() &&
             !next->isBackgroundXPositionSet() && !next->isBackgroundYPositionSet() &&
-            !next->isBackgroundAttachmentSet() && !next->isBackgroundRepeatSet()) {
+            !next->isBackgroundAttachmentSet() && !next->isBackgroundClipSet() &&
+            !next->isBackgroundOriginSet() && !next->isBackgroundRepeatSet() &&
+            !next->isBackgroundSizeSet()) {
             delete next;
             p->m_next = 0;
             break;
@@ -558,8 +609,11 @@
             inherited == o.inherited);
 }
 
-enum EPseudoBit { NO_BIT = 0x0, BEFORE_BIT = 0x1, AFTER_BIT = 0x2, FIRST_LINE_BIT = 0x4,
-                  FIRST_LETTER_BIT = 0x8, SELECTION_BIT = 0x10 };
+enum EPseudoBit { NO_BIT = 0x0, 
+                  FIRST_LINE_BIT = 0x1, FIRST_LETTER_BIT = 0x2, SELECTION_BIT = 0x4, 
+                  BEFORE_BIT = 0x8, AFTER_BIT = 0x10, MARKER_BIT = 0x20,
+                  REPLACED_BIT = 0x40
+                  };
 
 static int pseudoBit(RenderStyle::PseudoId pseudo)
 {
@@ -568,6 +622,10 @@
             return BEFORE_BIT;
         case RenderStyle::AFTER:
             return AFTER_BIT;
+        case RenderStyle::MARKER:
+            return MARKER_BIT;
+        case RenderStyle::REPLACED:
+            return REPLACED_BIT;
         case RenderStyle::FIRST_LINE:
             return FIRST_LINE_BIT;
         case RenderStyle::FIRST_LETTER:
@@ -961,8 +1019,10 @@
 
 // content: normal is the same as having no content at all
 void RenderStyle::setContentNormal() {
-    delete generated->content;
-    generated.access()->content = 0;
+    if (generated->content != 0) {
+        delete generated->content;
+        generated.access()->content = 0;
+    }
 }
 
 // content: none, add an empty content node
@@ -971,6 +1031,15 @@
     generated.access()->content = new ContentData;
 }
 
+void RenderStyle::setContentData(ContentData *data) {
+    if (data != generated->content) {
+        if (data)
+            generated.access()->content = new ContentData(*data);
+        else
+            generated.access()->content = 0;
+    }
+}
+
 ContentData::ContentData(const ContentData& o) : _contentType(o._contentType)
 {
     switch (_contentType) {
Index: khtml/rendering/bidi.cpp
===================================================================
--- khtml/rendering/bidi.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/rendering/bidi.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -2,7 +2,7 @@
  * This file is part of the html renderer for KDE.
  *
  * Copyright (C) 2000-2003 Lars Knoll (knoll@kde.org)
- *           (C) 2003-2004 Apple Computer, Inc.
+ *           (C) 2003-2005 Apple Computer, Inc.
  *           (C) 2005 Allan Sandfeld Jensen (kde@carewolf.com)
  *
  * This library is free software; you can redistribute it and/or
@@ -274,7 +274,7 @@
 
         if (!next) break;
 
-        if (next->isText() || next->isBR() || next->isFloating() || next->isReplaced() || next->isPositioned()
+        if (next->isText() || next->isBR() || next->isFloating() || next->isReplaced() || next->isPositioned() || next->isGlyph()
             || ((!skipInlines || !next->firstChild()) // Always return EMPTY inlines.
                 && next->isInlineFlow()))
             break;
@@ -295,7 +295,7 @@
             return o; // Never skip empty inlines.
     }
 
-    if (o && !o->isText() && !o->isBR() && !o->isReplaced() && !o->isFloating() && !o->isPositioned())
+    if (o && !o->isText() && !o->isBR() && !o->isReplaced() && !o->isFloating() && !o->isPositioned() && !o->isGlyph())
         o = Bidinext( par, o, bidi, skipInlines );
     return o;
 }
@@ -774,7 +774,7 @@
     if (rightPos > m_overflowWidth)
         m_overflowWidth = rightPos; // FIXME: Work for rtl overflow also.
     if (x < 0)
-        m_negativeOverflowWidth = kMax(m_negativeOverflowWidth, -x);
+        m_overflowLeft = kMin(m_overflowLeft, x);
 }
 
 void RenderBlock::computeVerticalPositionsForLine(InlineFlowBox* lineBox)
@@ -1596,9 +1596,11 @@
     m_height += toAdd;
 
     // Always make sure this is at least our height.
-    if (m_overflowHeight < m_height)
-        m_overflowHeight = m_height;
+    m_overflowHeight = kMax(m_height, m_overflowHeight);
 
+    // See if any lines spill out of the block.  If so, we need to update our overflow width.
+    checkLinesForOverflow();
+
 #if BIDI_DEBUG > 1
     kdDebug(6041) << " ------- bidi end " << this << " -------" << endl;
 #endif
@@ -1780,7 +1782,7 @@
             KHTMLAssert(!o->firstChild());
             tmpW += o->marginLeft()+o->borderLeft()+o->paddingLeft()+
                     o->marginRight()+o->borderRight()+o->paddingRight();
-        } else if ( o->isReplaced() ) {
+        } else if ( o->isReplaced() || o->isGlyph() ) {
             EWhiteSpace currWS = o->style()->whiteSpace();
             EWhiteSpace lastWS = last->style()->whiteSpace();
 
@@ -2188,6 +2190,16 @@
     return lBreak;
 }
 
+void RenderBlock::checkLinesForOverflow()
+{
+    for (RootInlineBox* curr = static_cast<khtml::RootInlineBox*>(firstLineBox()); curr; curr = static_cast<khtml::RootInlineBox*>(curr->nextLineBox())) {
+//         m_overflowLeft = min(curr->leftOverflow(), m_overflowLeft);
+        m_overflowTop = kMin(curr->topOverflow(), m_overflowTop);
+//         m_overflowWidth = max(curr->rightOverflow(), m_overflowWidth);
+        m_overflowHeight = kMax(curr->bottomOverflow(), m_overflowHeight);
+    }
+}
+
 // For --enable-final
 #undef BIDI_DEBUG
 #undef DEBUG_LINEBREAKS
Index: khtml/rendering/render_form.h
===================================================================
--- khtml/rendering/render_form.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/rendering/render_form.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -78,11 +78,6 @@
 
     virtual bool isFormElement() const { return true; }
 
-    virtual int borderTop() const { return canHaveBorder() ? RenderWidget::borderTop() : 0; }
-    virtual int borderBottom() const { return canHaveBorder() ? RenderWidget::borderBottom() : 0; }
-    virtual int borderLeft() const { return canHaveBorder() ? RenderWidget::borderLeft() : 0; }
-    virtual int borderRight() const { return canHaveBorder() ? RenderWidget::borderRight() : 0; }
-
     // form elements never have padding
     virtual int paddingTop() const { return 0; }
     virtual int paddingBottom() const { return 0; }
Index: khtml/rendering/render_list.cpp
===================================================================
--- khtml/rendering/render_list.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/rendering/render_list.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -537,13 +537,7 @@
     case TRAD_CHINESE_INFORMAL:
         m_item = toTradChineseInformal( value );
         break;
-// Quotes:
-    case OPEN_QUOTE:
-        m_item = style()->openQuote( value );
-        break;
-    case CLOSE_QUOTE:
-        m_item = style()->closeQuote( value );
-        break;
+// special:
     case LNONE:
         break;
     default:
Index: khtml/rendering/render_object.h
===================================================================
--- khtml/rendering/render_object.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/rendering/render_object.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -141,6 +141,9 @@
     virtual RenderObject *firstChild() const { return 0; }
     virtual RenderObject *lastChild() const { return 0; }
 
+    RenderObject *nextRenderer() const; 
+    RenderObject *previousRenderer() const; 
+
     virtual bool childAllowed() const { return false; }
 
     virtual RenderLayer* layer() const { return 0; }
@@ -247,6 +250,7 @@
     virtual bool isBox() const { return false; }
     virtual bool isRenderReplaced() const { return false; }
 
+    virtual bool isGlyph() const { return false; }
     virtual bool isCounter() const { return false; }
     virtual bool isQuote() const { return false; }
     virtual bool isListItem() const { return false; }
@@ -369,7 +373,7 @@
 
     virtual void paintBackgroundExtended(QPainter* /*p*/, const QColor& /*c*/, const BackgroundLayer */*bgLayer*/,
                                          int /*clipy*/, int /*cliph*/, int /*_tx*/, int /*_ty*/,
-                                         int /*w*/, int /*height*/, int /*bleft*/, int /*bright*/ ) {}
+                                         int /*w*/, int /*height*/, int /*bleft*/, int /*bright*/, int /*pleft*/, int /*pright*/  ) {}
 
 
     /*
@@ -417,6 +421,9 @@
     // repaint and do not need a relayout
     virtual void updateFromElement() {}
 
+    // Called immediately after render-object is inserted
+    virtual void attach() { m_attached = true; }
+    bool attached() { return m_attached; }
     // The corresponding closing element has been parsed. ### remove me
     virtual void close() { }
 
@@ -541,8 +548,13 @@
     /** the position of the object from where it begins drawing, including
      * its negative overflow
      */
-    int effectiveXPos() const { return xPos() - (hasOverflowClip() ? 0 : negativeOverflowWidth()); }
+    int effectiveXPos() const { return xPos() + (hasOverflowClip() ? 0 : overflowLeft()); }
 
+    /** the position of the object from where it begins drawing, including
+     * its negative overflow
+     */
+    int effectiveYPos() const { return yPos() + (hasOverflowClip() ? 0 : overflowTop()); }
+
     /** Leftmost coordinate of this inline element relative to containing
      * block. Always zero for non-inline elements.
      */
@@ -565,19 +577,20 @@
     // of borderTop() + paddingTop() + 100px.
     virtual int overflowHeight() const { return height(); }
     virtual int overflowWidth() const { return width(); }
-    // how much goes over the left hand side (0 or a positive number)
-    virtual int negativeOverflowWidth() const { return 0; }
+    // how much goes over the left hand side (0 or a negative number)
+    virtual int overflowTop() const { return 0; }
+    virtual int overflowLeft() const { return 0; }
 
     /**
      * Returns the height that is effectively considered when contemplating the
      * object as a whole -- usually the overflow height, or the height if clipped.
      */
-    int effectiveHeight() const { return hasOverflowClip() ? height() : overflowHeight(); }
+    int effectiveHeight() const { return hasOverflowClip() ? height() : overflowHeight() - overflowTop(); }
     /**
      * Returns the width that is effectively considered when contemplating the
      * object as a whole -- usually the overflow width, or the width if clipped.
      */
-    int effectiveWidth() const { return hasOverflowClip() ? width() : overflowWidth() + negativeOverflowWidth(); }
+    int effectiveWidth() const { return hasOverflowClip() ? width() : overflowWidth() - overflowLeft(); }
 
     // IE extensions, heavily used in ECMA
     virtual short offsetWidth() const { return width(); }
@@ -740,7 +753,7 @@
     virtual long maxOffset() const { return 0; }
 
     virtual void setPixmap(const QPixmap &, const QRect&, CachedImage *);
-    
+
     QRegion visibleFlowRegion(int x, int y) const;
 
 protected:
@@ -782,6 +795,7 @@
     bool m_recalcMinMax 	     : 1;
     bool m_isText                    : 1;
     bool m_inline                    : 1;
+    bool m_attached                  : 1;
 
     bool m_replaced                  : 1;
     bool m_mouseInside               : 1;
@@ -796,7 +810,7 @@
     bool m_needsPageClear            : 1;
     bool m_containsPageBreak         : 1;
 
-    // ### we have 16 + 23 bits. Cut 4 and save 32
+    // ### we have 16 + 24 bits. Cut 8 and save 32
 
 
     void arenaDelete(RenderArena *arena, void *objectBase);
Index: khtml/rendering/render_inline.cpp
===================================================================
--- khtml/rendering/render_inline.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/rendering/render_inline.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -56,7 +56,20 @@
         currCont = currCont->continuation();
     }
 
-    // Update pseudos for ::before and ::after now.
+    if (attached()) {
+        // Update replaced content
+        updateReplacedContent();
+        // Update pseudos for ::before and ::after
+        updatePseudoChildren();
+    }
+}
+
+// Attach handles initial setStyle that requires parent nodes
+void RenderInline::attach() 
+{
+    RenderFlow::attach();
+
+    updateReplacedContent();
     updatePseudoChildren();
 }
 
@@ -89,7 +102,7 @@
         // has to move into the inline continuation.  Call updatePseudoChild to ensure that our :after
         // content gets properly destroyed.
         bool isLastChild = (beforeChild == lastChild());
-        updatePseudoChild(RenderStyle::AFTER, lastChild());
+        updatePseudoChild(RenderStyle::AFTER);
         if (isLastChild && beforeChild != lastChild())
             beforeChild = 0; // We destroyed the last child, so now we need to update our insertion
                              // point to be 0.  It's just a straight append now.
Index: khtml/rendering/render_frames.h
===================================================================
--- khtml/rendering/render_frames.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/rendering/render_frames.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -130,6 +130,12 @@
     virtual const char *renderName() const { return "RenderFrame"; }
     virtual bool isFrame() const { return true; }
 
+    // frames never have padding
+    virtual int paddingTop() const { return 0; }
+    virtual int paddingBottom() const { return 0; }
+    virtual int paddingLeft() const { return 0; }
+    virtual int paddingRight() const { return 0; }
+
     DOM::HTMLFrameElementImpl *element() const
     { return static_cast<DOM::HTMLFrameElementImpl*>(RenderObject::element()); }
 
@@ -150,6 +156,8 @@
 
     virtual void layout( );
     virtual void updateWidget();
+    
+    virtual bool canHaveBorder() const { return true; }
 
     virtual bool partLoadingErrorNotify( khtml::ChildFrame *childFrame, const KURL& url, const QString& serviceType );
 
Index: khtml/rendering/render_image.cpp
===================================================================
--- khtml/rendering/render_image.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/rendering/render_image.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -59,7 +59,7 @@
 RenderImage::RenderImage(NodeImpl *_element)
     : RenderReplaced(_element)
 {
-    oimage = image = 0;
+    m_oldImage = m_cachedImage = 0;
 
     m_selectionState = SelectionNone;
     berrorPic = false;
@@ -73,13 +73,13 @@
 
 RenderImage::~RenderImage()
 {
-    if(image) image->deref(this);
-    if (oimage) oimage->deref( this );
+    if(m_cachedImage) m_cachedImage->deref( this );
+    if(m_oldImage) m_oldImage->deref( this );
 }
 
 QPixmap RenderImage::pixmap() const
 {
-    return image ? image->pixmap() : QPixmap();
+    return m_cachedImage ? m_cachedImage->pixmap() : QPixmap();
 }
 
 void RenderImage::setStyle(RenderStyle* _style)
@@ -92,16 +92,16 @@
 
 void RenderImage::setContentObject(CachedObject* co )
 {
-    if (co && image != co)
+    if (co && m_cachedImage != co)
         updateImage( static_cast<CachedImage*>( co ) );
 }
 
 void RenderImage::setPixmap( const QPixmap &p, const QRect& r, CachedImage *o)
 {
-    if ( o == oimage )
+    if ( o == m_oldImage )
         return;
 
-    if(o != image) {
+    if(o != m_cachedImage) {
         RenderReplaced::setPixmap(p, r, o);
         return;
     }
@@ -234,10 +234,10 @@
     if (!canvas()->printImages())
         return;
 
-    CachedImage* i = oimage && oimage->valid_rect().size() == oimage->pixmap_size() &&
-                     oimage->pixmap_size().width()  == intrinsicWidth() &&
-                     oimage->pixmap_size().height() == intrinsicHeight()
-                     ? oimage : image;
+    CachedImage* i = m_oldImage && m_oldImage->valid_rect().size() == m_oldImage->pixmap_size() &&
+                     m_oldImage->pixmap_size().width()  == intrinsicWidth() &&
+                     m_oldImage->pixmap_size().height() == intrinsicHeight()
+                     ? m_oldImage : m_cachedImage;
 
     // paint frame around image as long as it is not completely loaded from web.
     if (bUnfinishedImageFrame && paintInfo.phase == PaintActionForeground && cWidth > 2 && cHeight > 2 && !complete()) {
@@ -385,7 +385,7 @@
     int oldheight = m_height;
 
     // minimum height
-    m_height = image && image->isErrorImage() ? intrinsicHeight() : 0;
+    m_height = m_cachedImage && m_cachedImage->isErrorImage() ? intrinsicHeight() : 0;
 
     calcWidth();
     calcHeight();
@@ -413,9 +413,9 @@
 
 void RenderImage::notifyFinished(CachedObject *finishedObj)
 {
-    if ( ( image == finishedObj || oimage == finishedObj ) && oimage ) {
-        oimage->deref( this );
-        oimage = 0;
+    if ( ( m_cachedImage == finishedObj || m_oldImage == finishedObj ) && m_oldImage ) {
+        m_oldImage->deref( this );
+        m_oldImage = 0;
         repaint();
     }
 
@@ -447,20 +447,20 @@
 
 void RenderImage::updateImage(CachedImage* new_image)
 {
-    CachedImage* tempimage = oimage;
-    oimage = image;
-    image = new_image;
-    assert( image != oimage );
+    CachedImage* tempimage = m_oldImage;
+    m_oldImage = m_cachedImage;
+    m_cachedImage = new_image;
+    assert( m_cachedImage != m_oldImage );
 
-    if ( image != tempimage && image != oimage )
-        image->ref(this);
+    if ( m_cachedImage )
+        m_cachedImage->ref(this);
 
-    if (tempimage && image != tempimage && oimage != tempimage )
+    if ( tempimage )
         tempimage->deref(this);
 
     // if the loading finishes we might get an error and then the image is deleted
-    if ( image )
-        berrorPic = image->isErrorImage();
+    if ( m_cachedImage )
+        berrorPic = m_cachedImage->isErrorImage();
     else
         berrorPic = true;
 }
@@ -476,17 +476,12 @@
                   element()->getAttribute(ATTR_DATA) : element()->getAttribute(ATTR_SRC);
 
     if (!u.isEmpty() &&
-        ( !image || image->url() != u ) ) {
+        ( !m_cachedImage || m_cachedImage->url() != u ) ) {
         CachedImage *new_image = element()->getDocument()->docLoader()->
                                  requestImage(khtml::parseURL(u));
 
-        if(new_image && new_image != image
-           // check appears redundant, as we only care about this when we're anonymous
-           // which can never happen here.
-           /*&& (!style() || !style()->contentObject())*/
-            ) {
+        if(new_image && new_image != m_cachedImage)
             updateImage( new_image );
-        }
     }
 }
 
@@ -494,7 +489,7 @@
 {
      // "complete" means that the image has been loaded
      // but also that its width/height (contentWidth(),contentHeight()) have been calculated.
-     return image && image->valid_rect().size() == image->pixmap_size() && !needsLayout();
+     return m_cachedImage && m_cachedImage->valid_rect().size() == m_cachedImage->pixmap_size() && !needsLayout();
 }
 
 bool RenderImage::isWidthSpecified() const
@@ -527,7 +522,7 @@
 {
     if (intrinsicHeight() == 0)
         return 0;
-    if (!image || image->isErrorImage())
+    if (!m_cachedImage || m_cachedImage->isErrorImage())
         return intrinsicWidth(); // Don't bother scaling.
     return RenderReplaced::calcReplacedHeight() * intrinsicWidth() / intrinsicHeight();
 }
@@ -536,7 +531,7 @@
 {
     if (intrinsicWidth() == 0)
         return 0;
-    if (!image || image->isErrorImage())
+    if (!m_cachedImage || m_cachedImage->isErrorImage())
         return intrinsicHeight(); // Don't bother scaling.
     return RenderReplaced::calcReplacedWidth() * intrinsicHeight() / intrinsicWidth();
 }
Index: khtml/rendering/render_replaced.h
===================================================================
--- khtml/rendering/render_replaced.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/rendering/render_replaced.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -146,6 +146,11 @@
     bool m_needsMask;
 
 public:
+    virtual int borderTop() const { return canHaveBorder() ? RenderReplaced::borderTop() : 0; }
+    virtual int borderBottom() const { return canHaveBorder() ? RenderReplaced::borderBottom() : 0; }
+    virtual int borderLeft() const { return canHaveBorder() ? RenderReplaced::borderLeft() : 0; }
+    virtual int borderRight() const { return canHaveBorder() ? RenderReplaced::borderRight() : 0; }
+
     class EventPropagator : public QWidget {
     public:
         void sendEvent(QEvent *e);
Index: khtml/rendering/table_layout.cpp
===================================================================
--- khtml/rendering/table_layout.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/rendering/table_layout.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -176,7 +176,7 @@
 	while ( child ) {
 	    if ( child->isTableCell() ) {
 		RenderTableCell *cell = static_cast<RenderTableCell *>(child);
-		Length w = cell->style()->width();
+		Length w = cell->styleOrColWidth();
 		int span = cell->colSpan();
 		int effWidth = 0;
 		if ( (w.isFixed() || w.isPercent()) && w.value() > 0 ) {
@@ -288,8 +288,6 @@
 	int base = tableWidth * totalPercent / 100;
 	if ( base > available )
 	    base = available;
-	else
-	    totalPercent = 100;
 
 #ifdef DEBUG_LAYOUT
     qDebug("FixedTableLayout::layout: assigning percent width, base=%d, totalPercent=%d", base, totalPercent);
@@ -404,14 +402,13 @@
 			maxContributor = cell;
 		    }
 
-		    Length w = cell->style()->width();
+		    Length w = cell->styleOrColWidth();
                     w.l.value = kMin( 32767, kMax( 0, w.value() ) );
 		    switch( w.type() ) {
 		    case Fixed:
 			// ignore width=0
 			if ( w.value() > 0 && !l.width.isPercent() ) {
-                            // ### we should use box'es paddings here I guess.
-                            int wval = w.value() + cell->paddingLeft() + cell->paddingRight();
+                            int wval = cell->calcBoxWidth(w.value());
 			    if ( l.width.isFixed() ) {
                                 // Nav/IE weirdness
 				if ((wval > l.width.value()) ||
@@ -638,7 +635,7 @@
 	    break;
 	int span = cell->colSpan();
 
-	Length w = cell->style()->width();
+	Length w = cell->styleOrColWidth();
 	if ( !w.isRelative() && w.value() == 0 )
 	    w = Length(); // make it Variable
 
Index: khtml/rendering/render_container.h
===================================================================
--- khtml/rendering/render_container.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/rendering/render_container.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -41,7 +41,11 @@
     RenderObject *firstChild() const { return m_first; }
     RenderObject *lastChild() const { return m_last; }
 
-    virtual bool childAllowed() const { return true; }
+    virtual bool childAllowed() const { 
+        // Prevent normal children when we are replaced by generated content
+        if (style()) return style()->useNormalContent();
+        return true;
+    }
 
     virtual void addChild(RenderObject *newChild, RenderObject *beforeChild = 0);
 
@@ -58,11 +62,13 @@
 
 protected:
     // Generate CSS content
-    void createCSSContent();
+    void createGeneratedContent();
+    void updateReplacedContent();
 
     void updatePseudoChildren();
-    void updatePseudoChild(RenderStyle::PseudoId type, RenderObject* child);
+    void updatePseudoChild(RenderStyle::PseudoId type);
 
+    RenderContainer* pseudoContainer( RenderStyle::PseudoId type ) const;
 private:
 
     void setFirstChild(RenderObject *first) { m_first = first; }
Index: khtml/rendering/render_line.cpp
===================================================================
--- khtml/rendering/render_line.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/rendering/render_line.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -183,9 +183,10 @@
 
     RenderObject* curr = endObject;
     RenderObject* parent = curr->parent();
-    while (parent && !parent->isRenderBlock()) {
+    while (parent && !parent->isRenderBlock() || parent == object()) {
         if (parent->lastChild() != curr)
             return false;
+
         curr = parent;
         parent = curr->parent();
     }
@@ -544,7 +545,7 @@
     bool hasBackgroundImage = bg && (bg->pixmap_size() == bg->valid_rect().size()) &&
                               !bg->isTransparent() && !bg->isErrorImage();
     if (!hasBackgroundImage || (!prevLineBox() && !nextLineBox()) || !parent())
-        object()->paintBackgroundExtended(p, c, bgLayer, my, mh, _tx, _ty, w, h, borderLeft(), borderRight());
+        object()->paintBackgroundExtended(p, c, bgLayer, my, mh, _tx, _ty, w, h, borderLeft(), borderRight(), paddingLeft(), paddingRight());
     else {
         // We have a background image that spans multiple lines.
         // We need to adjust _tx and _ty by the width of all previous lines.
@@ -552,16 +553,19 @@
         // strip.  Even though that strip has been broken up across multiple lines, you still paint it
         // as though you had one single line.  This means each line has to pick up the background where
         // the previous line left off.
+        // FIXME: What the heck do we do with RTL here? The math we're using is obviously not right,
+        // but it isn't even clear how this should work at all.
+        int xOffsetOnLine = 0;
+        for (InlineRunBox* curr = prevLineBox(); curr; curr = curr->prevLineBox())
+            xOffsetOnLine += curr->width();
         int startX = _tx - xOffsetOnLine;
         int totalWidth = xOffsetOnLine;
         for (InlineRunBox* curr = this; curr; curr = curr->nextLineBox())
             totalWidth += curr->width();
-        QRect clipRect(_tx, _ty, width(), height());
-        clipRect = p->xForm(clipRect);
         p->save();
-        p->setClipRect( clipRect );
+        p->setClipRect(QRect(_tx, _ty, width(), height()), QPainter::CoordPainter);
         object()->paintBackgroundExtended(p, c, bgLayer, my, mh, startX, _ty,
-                                          totalWidth, h, borderLeft(), borderRight());
+                                          totalWidth, h, borderLeft(), borderRight(), paddingLeft(), paddingRight());
         p->restore();
     }
 }
Index: khtml/rendering/render_table.h
===================================================================
--- khtml/rendering/render_table.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/rendering/render_table.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -289,12 +289,8 @@
 
     virtual void setStyle( RenderStyle* );
     virtual const char *renderName() const { return "RenderTableRow"; }
-
     virtual bool isTableRow() const { return true; }
-
-    // overrides
     virtual void addChild(RenderObject *child, RenderObject *beforeChild = 0);
-    virtual RenderObject* removeChildNode(RenderObject* child);
 
     virtual short offsetWidth() const;
     virtual int offsetHeight() const;
@@ -310,10 +306,6 @@
 
     RenderTable *table() const { return static_cast<RenderTable *>(parent()->parent()); }
     RenderTableSection *section() const { return static_cast<RenderTableSection *>(parent()); }
-
-#ifdef ENABLE_DUMP
-    virtual void dump(QTextStream &stream, const QString& ind) const;
-#endif
 };
 
 // -------------------------------------------------------------------------
@@ -344,6 +336,8 @@
     int row() const { return _row; }
     void setRow(int r) { _row = r; }
 
+    Length styleOrColWidth();
+
     // overrides
     virtual void calcMinMaxWidth();
     virtual void calcWidth();
@@ -434,11 +428,6 @@
 
     virtual const char *renderName() const { return "RenderTableCol"; }
 
-    long span() const { return _span; }
-    void setSpan( long s ) { _span = s; }
-
-    virtual void addChild(RenderObject *child, RenderObject *beforeChild = 0);
-
     virtual bool isTableCol() const { return true; }
 
     virtual short lineHeight( bool ) const { return 0; }
@@ -451,8 +440,11 @@
     virtual void dump(QTextStream &stream, const QString& ind) const;
 #endif
 
-protected:
-    short _span;
+    int span() const { return m_span; }
+    void setSpan( int s ) { m_span = s; }
+
+private:
+    int m_span;
 };
 
 // -------------------------------------------------------------------------
Index: khtml/rendering/render_box.h
===================================================================
--- khtml/rendering/render_box.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/rendering/render_box.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -100,6 +100,7 @@
     virtual int   calcReplacedHeight() const;
 
     virtual int availableHeight() const;
+    virtual int availableWidth() const;
 
     void calcVerticalMargins();
 
@@ -118,18 +119,19 @@
     virtual int pageTopAfter(int y) const;
     virtual int crossesPageBreak(int t, int b) const;
 
-protected:
     int calcBoxWidth(int w) const;
     int calcBoxHeight(int h) const;
     int calcContentWidth(int w) const;
     int calcContentHeight(int h) const;
 
+protected:
     int calcWidthUsing(WidthType widthType, int cw, LengthType& lengthType);
     int calcHeightUsing(const Length& height);
     int calcReplacedWidthUsing(WidthType widthType) const;
     int calcReplacedHeightUsing(HeightType heightType) const;
     int calcPercentageHeight(const Length& height, bool treatAsReplaced = false) const;
     int availableHeightUsing(const Length& h) const;
+    int availableWidthUsing(const Length& w) const;
     int calcImplicitHeight() const;
     bool hasImplicitHeight() const {
         return isPositioned() && !style()->top().isVariable() && !style()->bottom().isVariable();
@@ -144,7 +146,7 @@
 
     virtual void paintBackgroundExtended(QPainter* /*p*/, const QColor& /*c*/, const BackgroundLayer* /*bgLayer*/,
                                          int /*clipy*/, int /*cliph*/, int /*_tx*/, int /*_ty*/,
-                                         int /*w*/, int /*height*/, int /*bleft*/, int /*bright*/ );
+                                         int /*w*/, int /*height*/, int /*bleft*/, int /*bright*/, int /*pleft*/, int /*pright*/ );
 
     void outlineBox(QPainter *p, int _tx, int _ty, const char *color = "red");
 
@@ -153,11 +155,18 @@
 
     void calcAbsoluteHorizontal();
     void calcAbsoluteVertical();
-    void calcAbsoluteHorizontalValues(WidthType widthType, RenderObject* cb, int cw, int pab, int static_distance,
-                                      int l, int r, int& w, int& ml, int& mr, int& x);
-    void calcAbsoluteVerticalValues(HeightType heightType, RenderObject* cb, int ch, int pab,
-                                    int t, int b, int& h, int& mt, int& mb, int& y);
+    void calcAbsoluteHorizontalValues(Length width, const RenderObject* cb, EDirection containerDirection,
+                                      const int containerWidth, const int bordersPlusPadding,
+                                      const Length left, const Length right, const Length marginLeft, const Length marginRight,
+                                      short& widthValue, short& marginLeftValue, short& marginRightValue, short& xPos);
+    void calcAbsoluteVerticalValues(Length height, const RenderObject* cb,
+                                    const int containerHeight, const int bordersPlusPadding,
+                                    const Length top, const Length bottom, const Length marginTop, const Length marginBottom,
+                                    int& heightValue, short& marginTopValue, short& marginBottomValue, int& yPos);
 
+    void calcAbsoluteVerticalReplaced();
+    void calcAbsoluteHorizontalReplaced();
+
     QRect getOverflowClipRect(int tx, int ty);
     QRect getClipRect(int tx, int ty);
 
Index: khtml/rendering/render_block.h
===================================================================
--- khtml/rendering/render_block.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/rendering/render_block.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -56,7 +56,8 @@
     // it would have an overflow height of borderTop() + paddingTop() + 100px.
     virtual int overflowHeight() const  { return m_overflowHeight; }
     virtual int overflowWidth() const   { return m_overflowWidth; }
-    virtual int negativeOverflowWidth() const { return m_negativeOverflowWidth; }
+    virtual int overflowLeft() const { return m_overflowLeft; }
+    virtual int overflowTop() const  { return m_overflowTop; }
     virtual void setOverflowHeight(int h) { m_overflowHeight = h; }
     virtual void setOverflowWidth(int w) { m_overflowWidth = w; }
 
@@ -92,6 +93,7 @@
     virtual void removeChild(RenderObject *oldChild);
 
     virtual void setStyle(RenderStyle* _style);
+    virtual void attach();
     void updateFirstLetter();
 
     virtual void layout();
@@ -114,6 +116,7 @@
     void computeHorizontalPositionsForLine(InlineFlowBox* lineBox, BidiState &bidi);
     void computeVerticalPositionsForLine(InlineFlowBox* lineBox);
     bool clearLineOfPageBreaks(InlineFlowBox* lineBox);
+    void checkLinesForOverflow();
     // end bidi.cpp functions
 
     virtual void paint(PaintInfo& i, int tx, int ty);
@@ -129,6 +132,9 @@
     int getClearDelta(RenderObject *child);
     virtual void markAllDescendantsWithFloatsForLayout(RenderObject* floatToRemove = 0);
 
+    // FIXME: containsFloats() should not return true if the floating objects list
+    // is empty. However, layoutInlineChildren() relies on the current behavior.
+    // http://bugzilla.opendarwin.org/show_bug.cgi?id=7395#c3
     virtual bool hasFloats() const { return m_floatingObjects!=0; }
     virtual bool containsFloat(RenderObject* o) const;
 
@@ -147,7 +153,7 @@
     int lowestAbsolutePosition() const;
     int leftmostAbsolutePosition() const;
     int rightmostAbsolutePosition() const;
-    
+
     virtual bool absolutePosition(int &xPos, int &yPos, bool=false);
 
     int rightOffset() const;
@@ -337,11 +343,13 @@
 protected:
     // How much content overflows out of our block vertically or horizontally (all we support
     // for now is spillage out of the bottom and the right, which are the common cases).
-    // XXX Generalize to work with top and left as well.
     int m_overflowHeight;
     int m_overflowWidth;
-    int m_negativeOverflowWidth;
 
+    // Left and top overflow.
+    int m_overflowTop;
+    int m_overflowLeft;
+
 private:
     QPtrList<FloatingObject>* m_floatingObjects;
     QPtrList<RenderObject>* m_positionedObjects;
Index: khtml/rendering/render_generated.h
===================================================================
--- khtml/rendering/render_generated.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/rendering/render_generated.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -23,6 +23,7 @@
 #define RENDER_GENERATED_H
 
 #include "rendering/render_text.h"
+#include "rendering/render_box.h"
 
 namespace DOM {
     class CounterImpl;
@@ -89,6 +90,36 @@
     EQuoteContent m_quoteType;
 };
 
+// -----------------------------------------------------------------------------
+
+// Is actually a special case of renderCounter for non-counted list-styles
+// These have traditionally been drawn rather than use Unicode characters
+class RenderGlyph : public RenderBox
+{
+public:
+    RenderGlyph(DOM::NodeImpl* node, EListStyleType type);
+    virtual ~RenderGlyph() {};
+
+    virtual const char *renderName() const { return "RenderGlyph"; }
+
+    virtual void paint(PaintInfo& paintInfo, int _tx, int _ty);
+    virtual void calcMinMaxWidth();
+
+    virtual void setStyle(RenderStyle *_style);
+
+    virtual short lineHeight( bool firstLine ) const;
+    virtual short baselinePosition( bool firstLine ) const;
+
+    virtual bool isGlyph() const { return true; }
+
+    virtual void position(InlineBox* box, int /*from*/, int /*len*/, bool /*reverse*/) {
+        setPos( box->xPos(), box->yPos() );
+    }
+
+protected:
+    EListStyleType m_type;
+};
+
 } //namespace
 
 #endif
Index: khtml/rendering/render_style.h
===================================================================
--- khtml/rendering/render_style.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/rendering/render_style.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -4,7 +4,7 @@
  * Copyright (C) 2000-2003 Lars Knoll (knoll@kde.org)
  *           (C) 2000 Antti Koivisto (koivisto@kde.org)
  *           (C) 2000-2003 Dirk Mueller (mueller@kde.org)
- *           (C) 2002-2004 Apple Computer, Inc.
+ *           (C) 2003-2005 Apple Computer, Inc.
  *           (C) 2004-2006 Allan Sandfeld Jensen (kde@carewolf.com)
  *
  * This library is free software; you can redistribute it and/or
@@ -212,10 +212,8 @@
     unsigned short width : 12;
     EBorderStyle style : 6;
 
-    bool nonZero() const
-    {
-      // rikkus: workaround for gcc 2.95.3
-      return width!=0 && !(style==BNONE);
+    bool nonZero(bool checkStyle = true) const {
+        return width != 0 && !(checkStyle && style == BNONE);
     }
 
     bool isTransparent() const {
@@ -293,6 +291,30 @@
     	return left.nonZero() || right.nonZero() || top.nonZero() || bottom.nonZero();
     }
 
+    unsigned short borderLeftWidth() const {
+        if (left.style == BNONE || left.style == BHIDDEN || left.style == BNATIVE)
+            return 0;
+        return left.width;
+    }
+
+    unsigned short borderRightWidth() const {
+        if (right.style == BNONE || right.style == BHIDDEN || right.style == BNATIVE)
+            return 0;
+        return right.width;
+    }
+
+    unsigned short borderTopWidth() const {
+        if (top.style == BNONE || top.style == BHIDDEN || top.style == BNATIVE)
+            return 0;
+        return top.width;
+    }
+
+    unsigned short borderBottomWidth() const {
+        if (bottom.style == BNONE || bottom.style == BHIDDEN || bottom.style == BNATIVE)
+            return 0;
+        return bottom.width;
+    }
+
     bool operator==(const BorderData& o) const
     {
     	return left==o.left && right==o.right && top==o.top && bottom==o.bottom;
@@ -408,10 +430,19 @@
 };
 
 //------------------------------------------------
+enum EBackgroundBox {
+    BGBORDER, BGPADDING, BGCONTENT
+};
+
 enum EBackgroundRepeat {
     REPEAT, REPEAT_X, REPEAT_Y, NO_REPEAT
 };
 
+struct LengthSize {
+    Length width;
+    Length height;
+};
+
 struct BackgroundLayer {
 public:
     BackgroundLayer();
@@ -421,7 +452,11 @@
     Length backgroundXPosition() const { return m_xPosition; }
     Length backgroundYPosition() const { return m_yPosition; }
     bool backgroundAttachment() const { return m_bgAttachment; }
+    EBackgroundBox backgroundClip() const { return m_bgClip; }
+    EBackgroundBox backgroundOrigin() const { return m_bgOrigin; }
     EBackgroundRepeat backgroundRepeat() const { return m_bgRepeat; }
+    LengthSize backgroundSize() const { return m_backgroundSize; }
+
     BackgroundLayer* next() const { return m_next; }
     BackgroundLayer* next() { return m_next; }
 
@@ -429,19 +464,28 @@
     bool isBackgroundXPositionSet() const { return m_xPosSet; }
     bool isBackgroundYPositionSet() const { return m_yPosSet; }
     bool isBackgroundAttachmentSet() const { return m_attachmentSet; }
+    bool isBackgroundClipSet() const { return m_clipSet; }
+    bool isBackgroundOriginSet() const { return m_originSet; }
     bool isBackgroundRepeatSet() const { return m_repeatSet; }
+    bool isBackgroundSizeSet() const { return m_backgroundSizeSet; }
 
     void setBackgroundImage(CachedImage* i) { m_image = i; m_imageSet = true; }
     void setBackgroundXPosition(const Length& l) { m_xPosition = l; m_xPosSet = true; }
     void setBackgroundYPosition(const Length& l) { m_yPosition = l; m_yPosSet = true; }
     void setBackgroundAttachment(bool b) { m_bgAttachment = b; m_attachmentSet = true; }
+    void setBackgroundClip(EBackgroundBox b) { m_bgClip = b; m_clipSet = true; }
+    void setBackgroundOrigin(EBackgroundBox b) { m_bgOrigin = b; m_originSet = true; }
     void setBackgroundRepeat(EBackgroundRepeat r) { m_bgRepeat = r; m_repeatSet = true; }
+    void setBackgroundSize(const LengthSize& b) { m_backgroundSize = b; m_backgroundSizeSet = true; }
 
     void clearBackgroundImage() { m_imageSet = false; }
     void clearBackgroundXPosition() { m_xPosSet = false; }
     void clearBackgroundYPosition() { m_yPosSet = false; }
     void clearBackgroundAttachment() { m_attachmentSet = false; }
+    void clearBackgroundClip() { m_clipSet = false; }
+    void clearBackgroundOrigin() { m_originSet = false; }
     void clearBackgroundRepeat() { m_repeatSet = false; }
+    void clearBackgroundSize() { m_backgroundSizeSet = false; }
 
     void setNext(BackgroundLayer* n) { if (m_next != n) { delete m_next; m_next = n; } }
 
@@ -475,13 +519,20 @@
     Length m_yPosition;
 
     bool m_bgAttachment : 1;
+    EBackgroundBox m_bgClip : 2;
+    EBackgroundBox m_bgOrigin : 2;
     EBackgroundRepeat m_bgRepeat : 2;
 
+    LengthSize m_backgroundSize;
+
     bool m_imageSet : 1;
     bool m_attachmentSet : 1;
+    bool m_clipSet : 1;
+    bool m_originSet : 1;
     bool m_repeatSet : 1;
     bool m_xPosSet : 1;
     bool m_yPosSet : 1;
+    bool m_backgroundSizeSet : 1;
 
     BackgroundLayer* m_next;
 };
@@ -508,7 +559,7 @@
 };
 
 enum ContentType {
-    CONTENT_NONE = 0, CONTENT_NORMAL, CONTENT_OBJECT, 
+    CONTENT_NONE = 0, CONTENT_NORMAL, CONTENT_OBJECT,
     CONTENT_TEXT, CONTENT_COUNTER, CONTENT_QUOTE
 };
 
@@ -746,6 +797,17 @@
      LNONE
 };
 
+inline bool isListStyleCounted(EListStyleType type)
+{
+    switch(type) {
+    case LDISC: case LCIRCLE: case LSQUARE: case LBOX: case LDIAMOND:
+    case LNONE:
+        return false;
+    default:
+        return true;
+    }
+}
+
 enum EListStylePosition { OUTSIDE, INSIDE };
 
 enum EVisibility { VISIBLE, HIDDEN, COLLAPSE };
@@ -776,8 +838,11 @@
 public:
     KDE_EXPORT static void cleanup();
 
-    // static pseudo styles. Dynamic ones are produced on the fly.
-    enum PseudoId { NOPSEUDO, FIRST_LINE, FIRST_LETTER, BEFORE, AFTER, SELECTION };
+    // pseudo elements
+    enum PseudoId {
+        NOPSEUDO, FIRST_LINE, FIRST_LETTER, SELECTION,
+        BEFORE, AFTER, REPLACED, MARKER
+    };
 
 protected:
 
@@ -845,10 +910,10 @@
 
                 PseudoId _styleType : 4;
                 bool _hasClip : 1;
-                unsigned _pseudoBits : 6;
+                unsigned _pseudoBits : 8;
                 EUnicodeBidi _unicodeBidi : 2;
 
-                unsigned int unused : 18;
+                unsigned int unused : 16;
             } f;
             Q_UINT64 _niflags;
         };
@@ -929,7 +994,14 @@
 
     void inheritFrom(const RenderStyle* inheritParent);
 
-    PseudoId styleType() { return  noninherited_flags.f._styleType; }
+    PseudoId styleType() const { return  noninherited_flags.f._styleType; }
+    void setStyleType(PseudoId pi) { noninherited_flags.f._styleType = pi; }
+    bool isGenerated() const {
+        if (styleType() == AFTER || styleType() == BEFORE || styleType() == MARKER || styleType() == REPLACED)
+            return true;
+        else
+            return false;
+    }
 
     bool hasPseudoStyle(PseudoId pi) const;
     void setHasPseudoStyle(PseudoId pi, bool b=true);
@@ -974,30 +1046,27 @@
     Length  	minHeight() const { return box->min_height; }
     Length  	maxHeight() const { return box->max_height; }
 
+    const BorderData& border() const { return surround->border; }
     const BorderValue& borderLeft() const { return surround->border.left; }
     const BorderValue& borderRight() const { return surround->border.right; }
     const BorderValue& borderTop() const { return surround->border.top; }
     const BorderValue& borderBottom() const { return surround->border.bottom; }
 
-    unsigned short  borderLeftWidth() const
-    { if( surround->border.left.style == BNONE || surround->border.left.style == BNATIVE) return 0; return surround->border.left.width; }
+    unsigned short  borderLeftWidth() const { return surround->border.borderLeftWidth(); }
     EBorderStyle    borderLeftStyle() const { return surround->border.left.style; }
-    const QColor &  borderLeftColor() const { return surround->border.left.color; }
+    const QColor&  borderLeftColor() const { return surround->border.left.color; }
     bool borderLeftIsTransparent() const { return surround->border.left.isTransparent(); }
-    unsigned short  borderRightWidth() const
-    { if (surround->border.right.style == BNONE || surround->border.left.style == BNATIVE) return 0; return surround->border.right.width; }
+    unsigned short  borderRightWidth() const { return surround->border.borderRightWidth(); }
     EBorderStyle    borderRightStyle() const {  return surround->border.right.style; }
-    const QColor &  	    borderRightColor() const {  return surround->border.right.color; }
+    const QColor&   borderRightColor() const {  return surround->border.right.color; }
     bool borderRightIsTransparent() const { return surround->border.right.isTransparent(); }
-    unsigned short  borderTopWidth() const
-    { if(surround->border.top.style == BNONE || surround->border.left.style == BNATIVE) return 0; return surround->border.top.width; }
-    EBorderStyle    borderTopStyle() const {return surround->border.top.style; }
-    const QColor &  borderTopColor() const {  return surround->border.top.color; }
+    unsigned short  borderTopWidth() const { return surround->border.borderTopWidth(); }
+    EBorderStyle    borderTopStyle() const { return surround->border.top.style; }
+    const QColor&  borderTopColor() const {  return surround->border.top.color; }
     bool borderTopIsTransparent() const { return surround->border.top.isTransparent(); }
-    unsigned short  borderBottomWidth() const
-    { if(surround->border.bottom.style == BNONE || surround->border.left.style == BNATIVE) return 0; return surround->border.bottom.width; }
+    unsigned short  borderBottomWidth() const { return surround->border.borderBottomWidth(); }
     EBorderStyle    borderBottomStyle() const {  return surround->border.bottom.style; }
-    const QColor &  	    borderBottomColor() const {  return surround->border.bottom.color; }
+    const QColor&   borderBottomColor() const {  return surround->border.bottom.color; }
     bool borderBottomIsTransparent() const { return surround->border.bottom.isTransparent(); }
 
     unsigned short  outlineSize() const { return outlineWidth() + outlineOffset(); }
@@ -1020,6 +1089,7 @@
     Length clipRight() const { return visual->clip.right; }
     Length clipTop() const { return visual->clip.top; }
     Length clipBottom() const { return visual->clip.bottom; }
+    LengthBox clip() const { return visual->clip; }
     bool hasClip() const { return noninherited_flags.f._hasClip; }
 
     EUnicodeBidi unicodeBidi() const { return noninherited_flags.f._unicodeBidi; }
@@ -1280,9 +1350,10 @@
         const_cast<StyleVisualData *>(visual.get())->palette = QApplication::palette();
     }
 
+    bool useNormalContent() const { return generated->content == 0; }
     ContentData* contentData() const { return generated->content; }
-    bool contentDataEquivalent(const RenderStyle* otherStyle) const 
-    { 
+    bool contentDataEquivalent(const RenderStyle* otherStyle) const
+    {
         return generated->contentDataEquivalent(otherStyle->generated.get());
     }
     void addContent(DOM::DOMStringImpl* s);
@@ -1291,6 +1362,7 @@
     void addContent(EQuoteContent q);
     void setContentNone();
     void setContentNormal();
+    void setContentData(ContentData* content);
 
     DOM::CSSValueListImpl* counterReset() const { return generated->counter_reset; }
     DOM::CSSValueListImpl* counterIncrement() const { return generated->counter_increment; }
@@ -1325,7 +1397,10 @@
 
     // Initial values for all the properties
     static bool initialBackgroundAttachment() { return true; }
+    static EBackgroundBox initialBackgroundClip() { return BGBORDER; }
+    static EBackgroundBox initialBackgroundOrigin() { return BGPADDING; }
     static EBackgroundRepeat initialBackgroundRepeat() { return REPEAT; }
+    static LengthSize initialBackgroundSize() { return LengthSize(); }
     static bool initialBorderCollapse() { return false; }
     static EBorderStyle initialBorderStyle() { return BNONE; }
     static ECaptionSide initialCaptionSide() { return CAPTOP; }
Index: khtml/rendering/render_object.cpp
===================================================================
--- khtml/rendering/render_object.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/rendering/render_object.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -4,7 +4,7 @@
  * Copyright (C) 1999-2003 Lars Knoll (knoll@kde.org)
  *           (C) 1999 Antti Koivisto (koivisto@kde.org)
  *           (C) 2000-2003 Dirk Mueller (mueller@kde.org)
- *           (C) 2002-2004 Apple Computer, Inc.
+ *           (C) 2002-2006 Apple Computer, Inc.
  *           (C) 2006 Germain Garand <germain@ebooksfrance.org>
  *
  * This library is free software; you can redistribute it and/or
@@ -178,6 +178,7 @@
       m_recalcMinMax( false ),
       m_isText( false ),
       m_inline( true ),
+      m_attached( false ),
 
       m_replaced( false ),
       m_mouseInside( false ),
@@ -282,6 +283,38 @@
     KHTMLAssert(0);
 }
 
+RenderObject *RenderObject::nextRenderer() const
+{
+    if (firstChild())
+        return firstChild();
+    else if (nextSibling())
+        return nextSibling();
+    else {
+        const RenderObject *r = this;
+        while (r && !r->nextSibling())
+            r = r->parent();
+        if (r)
+            return r->nextSibling();
+    }
+    return 0;
+}
+
+RenderObject *RenderObject::previousRenderer() const
+{
+    if (previousSibling()) {
+        RenderObject *r = previousSibling();
+        while (r->lastChild())
+            r = r->lastChild();
+        return r;
+    }
+    else if (parent()) {
+        return parent();
+    }
+    else {
+        return 0;
+    }
+}
+
 static void addLayers(RenderObject* obj, RenderLayer* parentLayer, RenderObject*& newObject,
                       RenderLayer*& beforeChild)
 {
@@ -484,12 +517,12 @@
 // scrollWidth/scrollHeight is the size including the overflow area
 short RenderObject::scrollWidth() const
 {
-    return (style()->hidesOverflow() && layer()) ? layer()->scrollWidth() : overflowWidth();
+    return (style()->hidesOverflow() && layer()) ? layer()->scrollWidth() : overflowWidth() - overflowLeft();
 }
 
 int RenderObject::scrollHeight() const
 {
-    return (style()->hidesOverflow() && layer()) ? layer()->scrollHeight() : overflowHeight();
+    return (style()->hidesOverflow() && layer()) ? layer()->scrollHeight() : overflowHeight() - overflowTop();
 }
 
 bool RenderObject::hasStaticX() const
@@ -1241,22 +1274,38 @@
 
     //qDebug("m_style: %p new style, diff=%d", m_style,  d);
 
-    if ( d == RenderStyle::Visible && m_parent && m_style &&
-         m_style->outlineWidth() > style->outlineWidth() )
-        repaint();
+    if (m_style) {
+        if ( d >= RenderStyle::Visible && !isText() && m_parent &&
+             ( m_style->outlineWidth() > style->outlineWidth() ||
+               ( m_style->hasClip() && !(m_style->clip() == style->clip()) ) ) ) {
+            // schedule a repaint with the old style
+            if (layer() && !isInlineFlow())
+                layer()->repaint();
+            else
+                repaint();
+        }
 
-    if ( m_style &&
-         ( ( isFloating() && m_style->floating() != style->floating() ) ||
-           ( isPositioned() && m_style->position() != style->position() &&
-             style->position() != ABSOLUTE && style->position() != FIXED ) ) )
-        removeFromObjectLists();
+        if ( ( isFloating() && m_style->floating() != style->floating() ) ||
+               ( isPositioned() && m_style->position() != style->position() &&
+                 style->position() != ABSOLUTE && style->position() != FIXED ) )
+            removeFromObjectLists();
 
-    // reset style flags
-    m_floating = false;
-    m_positioned = false;
-    m_relPositioned = false;
-    m_paintBackground = false;
+        if ( layer() ) {
+            if ( ( m_style->hasAutoZIndex() != style->hasAutoZIndex() ||
+                   m_style->zIndex() != style->zIndex() ||
+                   m_style->visibility() != style->visibility() ) ) {
+                layer()->stackingContext()->dirtyZOrderLists();
+                layer()->dirtyZOrderLists();
+            }
+        }
 
+        // reset style flags
+        m_floating = false;
+        m_positioned = false;
+        m_relPositioned = false;
+        m_paintBackground = false;
+    }
+
     // only honour z-index for non-static objects
     // ### and objects with opacity
     if ( style->position() == STATIC ) {
@@ -1266,15 +1315,6 @@
             style->setHasAutoZIndex();
     }
 
-    if ( layer() && style && m_style ) {
-        if ( ( m_style->hasAutoZIndex() != style->hasAutoZIndex() ||
-               m_style->zIndex() != style->zIndex() ||
-               m_style->visibility() != style->visibility() ) ) {
-            layer()->stackingContext()->dirtyZOrderLists();
-            layer()->dirtyZOrderLists();
-        }
-    }
-
     RenderStyle *oldStyle = m_style;
     m_style = style;
 
@@ -1675,8 +1715,9 @@
                 (_y >= ty) && (_y < ty + height()) && (_x >= tx) && (_x < tx + width())) || isRoot() || isBody();
     bool inOverflowRect = inside;
     if ( !inOverflowRect ) {
-        int no = negativeOverflowWidth();
-        QRect overflowRect( tx-no, ty, overflowWidth()+no, overflowHeight() );
+        int ol = overflowLeft();
+        int ot = overflowTop();
+        QRect overflowRect( tx+ol, ty+ot, overflowWidth()-ol, overflowHeight()-ot );
         inOverflowRect = overflowRect.contains( _x, _y );
     }
 
@@ -2173,9 +2214,13 @@
             QRegion r = l ? l->getMask() : QRegion();
             int x,y;
             if (!r.isNull() && curr->absolutePosition(x,y)) {
-                x+= curr->borderLeft()+curr->paddingLeft();
-                y+= curr->borderBottom()+curr->paddingBottom();
-                r = r.intersect(QRect(x,y,curr->width(),curr->height()));
+                int pbx = curr->borderLeft()+curr->paddingLeft();
+                int pby = curr->borderTop()+curr->paddingTop();
+                x+= pbx;
+                y+= pby;
+                r = r.intersect(QRect(x,y,
+                                  curr->width()-pbx-curr->borderRight()-curr->paddingRight(),
+                                  curr->height()-pby-curr->borderBottom()-curr->paddingBottom()));
 #ifdef MASK_DEBUG
                 QMemArray<QRect> ar = r.rects();
                 kdDebug(6040) << "|| Setting widget mask for " << curr->information() << endl;
Index: khtml/rendering/font.cpp
===================================================================
--- khtml/rendering/font.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/rendering/font.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -459,7 +459,8 @@
     }
 
     // make sure we don't bust up X11
-    size = KMAX(0, KMIN(255, size));
+    // Also, Qt does not support sizing a QFont to zero.
+    size = kMax(1, kMin(255, size));
 
 //       qDebug("setting font to %s, italic=%d, weight=%d, size=%d", fontDef.family.latin1(), fontDef.italic,
 //    	   fontDef.weight, size );
@@ -475,7 +476,7 @@
 
     if ( fontDef.smallCaps ) {
 	scFont = new QFont( f );
-	scFont->setPixelSize( f.pixelSize()*7/10 );
+	scFont->setPixelSize( kMax(1, f.pixelSize()*7/10) );
     }
 }
 
Index: khtml/rendering/render_canvas.cpp
===================================================================
--- khtml/rendering/render_canvas.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/rendering/render_canvas.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -72,7 +72,7 @@
     m_selectionEnd = 0;
     m_selectionStartPos = -1;
     m_selectionEndPos = -1;
-    
+
     m_needsWidgetMasks = false;
 
     // Create a new root layer for our layer hierarchy.
@@ -151,10 +151,24 @@
     for(RenderObject* c = firstChild(); c; c = c->nextSibling())
         c->setChildNeedsLayout(true);
 
+    int oldWidth = m_width;
+    int oldHeight = m_height;
+
+    if (m_pagedMode || !m_view) {
+        m_width = m_rootWidth;
+        m_height = m_rootHeight;
+    }
+    else
+    {
+        m_viewportWidth = m_width = m_view->visibleWidth();
+        m_viewportHeight = m_height = m_view->visibleHeight();
+    }
+
 #ifdef SPEED_DEBUG
     QTime qt;
     qt.start();
 #endif
+
     if ( recalcMinMax() )
 	recalcMinMaxWidths();
 
@@ -163,27 +177,15 @@
     qt.start();
 #endif
 
+    bool relayoutChildren = (oldWidth != m_width) || (oldHeight != m_height);
+
+    RenderBlock::layoutBlock( relayoutChildren );
+
 #ifdef SPEED_DEBUG
     kdDebug() << "RenderCanvas::layout time used=" << qt.elapsed() << endl;
     qt.start();
 #endif
-    int oldWidth = m_width;
-    int oldHeight = m_height;
 
-    if (m_pagedMode || !m_view) {
-        m_width = m_rootWidth;
-        m_height = m_rootHeight;
-    }
-    else
-    {
-        m_viewportWidth = m_width = m_view->visibleWidth();
-        m_viewportHeight = m_height = m_view->visibleHeight();
-    }
-
-    bool relayoutChildren = (oldWidth != m_width) || (oldHeight != m_height);
-
-    RenderBlock::layoutBlock( relayoutChildren );
-
     int docW = docWidth();
     int docH = docHeight();
 
@@ -230,7 +232,7 @@
 
     layer()->resize( kMax( docW,int( m_width ) ), kMax( docH,m_height ) );
     layer()->updateLayerPositions( layer(), needsFullRepaint(), true );
-    
+
     if (!m_pagedMode && m_needsWidgetMasks)
         layer()->updateWidgetMasks(layer());
 
@@ -378,9 +380,11 @@
         int ox, oy;
         enclosingParent->absolutePosition(ox, oy);
         int off = 0;
-        if (!enclosingParent->hasOverflowClip())
-            off = enclosingParent->negativeOverflowWidth();
-        rect.setX(ox - off);
+        if (!enclosingParent->hasOverflowClip()) {
+            ox += enclosingParent->overflowLeft();
+            oy += enclosingParent->overflowTop();
+        }
+        rect.setX(ox);
         rect.setY(oy);
         rect.setWidth(enclosingParent->effectiveWidth());
         rect.setHeight(enclosingParent->effectiveHeight());
Index: khtml/rendering/render_frames.cpp
===================================================================
--- khtml/rendering/render_frames.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/rendering/render_frames.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -656,7 +656,7 @@
 
 int RenderPart::intrinsicHeight() const
 {
-    return 200;
+    return 150;
 }
 
 void RenderPart::slotViewCleared()
@@ -796,8 +796,10 @@
               serviceType = "application/x-java-applet";
               url = objbase->classId.mid(5);
           }
-          if(serviceType.isEmpty() && !objbase->classId.isEmpty()) {
-
+          if ( (serviceType.isEmpty() ||
+                      serviceType == "application/x-oleobject") &&
+                  !objbase->classId.isEmpty())
+          {
 #if 0
               // We have a clsid, means this is activex (Niko)
               serviceType = "application/x-activex-handler";
@@ -831,7 +833,7 @@
               // TODO: add more plugins here
           }
       }
-      if ((url.isEmpty() && !embed) || !document()->isURLAllowed(url) || !part->requestObject( this, url, serviceType, params ))
+      if (!document()->isURLAllowed(url) || !part->requestObject( this, url, serviceType, params ))
           objbase->renderAlternative();
   }
 }
Index: khtml/rendering/render_replaced.cpp
===================================================================
--- khtml/rendering/render_replaced.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/rendering/render_replaced.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -58,7 +58,7 @@
     // init RenderObject attributes
     setReplaced(true);
 
-    m_intrinsicWidth = 200;
+    m_intrinsicWidth = 300;
     m_intrinsicHeight = 150;
 }
 
Index: khtml/rendering/render_container.cpp
===================================================================
--- khtml/rendering/render_container.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/rendering/render_container.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -152,6 +152,13 @@
 	// just add it...
 	insertChildNode(newChild, beforeChild);
     }
+ 
+    if (newChild->isText() && newChild->style()->textTransform() == CAPITALIZE) {
+        DOM::DOMStringImpl* textToTransform =  static_cast<RenderText*>(newChild)->originalString();
+        if (textToTransform)
+            static_cast<RenderText*>(newChild)->setText(textToTransform, true);
+    }    
+    newChild->attach();
 }
 
 RenderObject* RenderContainer::removeChildNode(RenderObject* oldChild)
@@ -213,8 +220,7 @@
     RenderObject::setStyle(_style);
 
     // If we are a pseudo-container we need to restyle the children
-    if (style()->styleType() == RenderStyle::BEFORE
-     || style()->styleType() == RenderStyle::AFTER)
+    if (style()->isGenerated())
     {
         // ### we could save this call when the change only affected
         // non inherited properties
@@ -239,15 +245,17 @@
      || style()->styleType() == RenderStyle::AFTER)
         return;
 
-    updatePseudoChild(RenderStyle::BEFORE, firstChild());
-    updatePseudoChild(RenderStyle::AFTER, lastChild());
+    updatePseudoChild(RenderStyle::BEFORE);
+    updatePseudoChild(RenderStyle::AFTER);
     // updatePseudoChild(RenderStyle::MARKER, marker());
 }
 
-void RenderContainer::updatePseudoChild(RenderStyle::PseudoId type, RenderObject* child)
+void RenderContainer::updatePseudoChild(RenderStyle::PseudoId type)
 {
     RenderStyle* pseudo = style()->getPseudoStyle(type);
 
+    RenderObject* child = pseudoContainer(type);
+
     // Whether or not we currently have generated content attached.
     bool oldContentPresent = child && (child->style()->styleType() == type);
 
@@ -294,21 +302,14 @@
     if (!newContentWanted)
         return;
 
-    if (isInlineFlow() && pseudo->display() != INLINE)
-        // According to the CSS2 spec (the end of section 12.1), the only allowed
-        // display values for the pseudo style are NONE and INLINE.  Since we already
-        // determined that the pseudo is not display NONE, any display other than
-        // inline should be mutated to INLINE.
-        pseudo->setDisplay(INLINE);
+    RenderObject* insertBefore = (type == RenderStyle::BEFORE) ? firstChild() : 0;
 
-    RenderObject* insertBefore = (type == RenderStyle::BEFORE) ? child : 0;
-
     // Generated content consists of a single container that houses multiple children (specified
     // by the content property).  This pseudo container gets the pseudo style set on it.
     RenderContainer* pseudoContainer = 0;
     pseudoContainer = RenderFlow::createFlow(element(), pseudo, renderArena());
     pseudoContainer->setIsAnonymous( true );
-    pseudoContainer->createCSSContent();
+    pseudoContainer->createGeneratedContent();
 
     // Only add the container if it had content
     if (pseudoContainer->firstChild()) {
@@ -319,7 +320,7 @@
     }
 }
 
-void RenderContainer::createCSSContent()
+void RenderContainer::createGeneratedContent()
 {
     RenderStyle* pseudo = style();
     RenderStyle* style = new RenderStyle();
@@ -349,7 +350,15 @@
         }
         else if (contentData->_contentType == CONTENT_COUNTER)
         {
-            RenderCounter* t = new (renderArena()) RenderCounter( node(), contentData->contentCounter() );
+            // really a counter or just a glyph?
+            EListStyleType type = (EListStyleType)contentData->contentCounter()->listStyle();
+            RenderObject *t = 0;
+            if (isListStyleCounted(type)) {
+                t = new (renderArena()) RenderCounter( node(), contentData->contentCounter() );
+            }
+            else {
+                t = new  (renderArena()) RenderGlyph( node(), type );
+            }
             t->setIsAnonymous( true );
             t->setStyle(style);
             addChild(t);
@@ -365,6 +374,68 @@
     style->deref();
 }
 
+RenderContainer* RenderContainer::pseudoContainer(RenderStyle::PseudoId type) const
+{
+    RenderObject *child = 0;
+    switch (type) {
+        case RenderStyle::AFTER:
+            child = lastChild();
+            break;
+        case RenderStyle::BEFORE:
+            child = firstChild();
+            break;
+        case RenderStyle::REPLACED:
+            child = lastChild();
+            if (child && child->style()->styleType() == RenderStyle::AFTER) 
+                child = child->previousSibling();
+            break;
+        default:
+            child = 0;
+    }
+
+    if (child && child->style()->styleType() == type) {
+        assert(child->isRenderBlock() || child->isRenderInline());
+        return static_cast<RenderContainer*>(child);
+    }
+    else 
+    {   // check continuations
+        RenderContainer *c = static_cast<RenderContainer*>(container());
+        if (c->isAnonymousBlock()) return c->pseudoContainer(type);
+    }
+    return 0;
+}
+
+void RenderContainer::updateReplacedContent()
+{
+    // Only for normal elements
+    if (!style() || style()->styleType() != RenderStyle::NOPSEUDO)
+        return;
+
+    // delete old generated content
+    RenderContainer *container = pseudoContainer(RenderStyle::REPLACED);
+    if (container) {
+        container->detach();
+    }
+
+    if (style()->useNormalContent()) return;
+
+    // create generated content
+    RenderStyle* pseudo = style()->getPseudoStyle(RenderStyle::REPLACED);
+    if (!pseudo) {
+        pseudo = new RenderStyle();
+        pseudo->inheritFrom(style());
+        pseudo->setStyleType(RenderStyle::REPLACED);
+    }
+    if (pseudo->useNormalContent())
+        pseudo->setContentData(style()->contentData());
+
+    container = RenderFlow::createFlow(node(), pseudo, renderArena());
+    container->setIsAnonymous( true );
+    container->createGeneratedContent();
+
+    addChild(container, pseudoContainer(RenderStyle::AFTER));
+}
+
 void RenderContainer::appendChildNode(RenderObject* newChild)
 {
     KHTMLAssert(newChild->parent() == 0);
Index: khtml/rendering/render_inline.h
===================================================================
--- khtml/rendering/render_inline.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/rendering/render_inline.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -52,6 +52,7 @@
                    RenderObject* newChild, RenderFlow* oldCont);
 
     virtual void setStyle(RenderStyle* _style);
+    virtual void attach();
 
     virtual void layout() {} // Do nothing for layout()
 
Index: khtml/rendering/render_text.cpp
===================================================================
--- khtml/rendering/render_text.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/rendering/render_text.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -1151,7 +1151,22 @@
     if ( str && style() ) {
         oldstr = str;
         switch(style()->textTransform()) {
-	case CAPITALIZE:   str = str->capitalize();  break;
+        case CAPITALIZE:
+        {
+            // find previous text renderer if one exists
+            RenderObject* o;
+            bool runOnString = false;
+            for (o = previousRenderer(); o && o->isInlineFlow(); o = o->previousRenderer())
+                ;
+            if (o && o->isText()) {
+                DOMStringImpl* prevStr = static_cast<RenderText*>(o)->string();
+                QChar c = (*prevStr)[prevStr->length() - 1];
+                if (!c.isSpace())
+                    runOnString = true;
+            }
+            str = str->capitalize(runOnString);
+        }
+        break;
 	case UPPERCASE:   str = str->upper();       break;
 	case LOWERCASE:  str = str->lower();       break;
 	case NONE:
Index: khtml/rendering/render_applet.cpp
===================================================================
--- khtml/rendering/render_applet.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/rendering/render_applet.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -67,7 +67,7 @@
 
 short RenderApplet::intrinsicWidth() const
 {
-    int rval = 150;
+    int rval = 300;
 
     if( m_widget )
         rval = ((KJavaAppletWidget*)(m_widget))->sizeHint().width();
Index: khtml/rendering/render_image.h
===================================================================
--- khtml/rendering/render_image.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/rendering/render_image.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -56,7 +56,7 @@
 
     bool complete() const;
 
-    CachedObject *contentObject() { return image; }
+    CachedObject *contentObject() { return m_cachedImage; }
     void setContentObject( CachedObject* );
 
     // hook to keep RendeObject::m_inline() up to date
@@ -91,8 +91,8 @@
     // text to display as long as the image isn't available
     DOM::DOMString alt;
 
-    CachedImage *image;
-    CachedImage *oimage;
+    CachedImage *m_cachedImage;
+    CachedImage *m_oldImage;
 
     bool berrorPic : 1;
     bool bUnfinishedImageFrame :1;
Index: khtml/rendering/render_table.cpp
===================================================================
--- khtml/rendering/render_table.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/rendering/render_table.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -34,6 +34,7 @@
 #include "rendering/render_canvas.h"
 #include "rendering/table_layout.h"
 #include "html/html_tableimpl.h"
+#include "html/html_formimpl.h"
 #include "misc/htmltags.h"
 #include "misc/htmlattrs.h"
 #include "rendering/render_line.h"
@@ -134,70 +135,93 @@
     kdDebug( 6040 ) << renderName() << "(Table)::addChild( " << child->renderName() << ", " <<
                        (beforeChild ? beforeChild->renderName() : "0") << " )" << endl;
 #endif
-    RenderObject *o = child;
+    bool wrapInAnonymousSection = false;
 
-    if (child->element() && child->element()->id() == ID_FORM) {
-        RenderContainer::addChild(child,beforeChild);
+    switch(child->style()->display())
+    {
+        case TABLE_CAPTION:
+            if (child->isRenderBlock())
+                tCaption = static_cast<RenderBlock *>(child);
+            break;
+        case TABLE_COLUMN:
+        case TABLE_COLUMN_GROUP:
+            has_col_elems = true;
+            break;
+        case TABLE_HEADER_GROUP:
+            if ( !head )
+                if (child->isTableSection())
+                    head = static_cast<RenderTableSection *>(child);
+            else if ( !firstBody )
+                if (child->isTableSection())
+                    firstBody = static_cast<RenderTableSection *>(child);
+            break;
+        case TABLE_FOOTER_GROUP:
+            if ( !foot ) {
+                if (child->isTableSection())
+                    foot = static_cast<RenderTableSection *>(child);
+                break;
+            }
+            // fall through
+        case TABLE_ROW_GROUP:
+            if(!firstBody)
+                if (child->isTableSection())
+                    firstBody = static_cast<RenderTableSection *>(child);
+            break;
+        case TABLE_CELL:
+        case TABLE_ROW:
+            wrapInAnonymousSection = true;
+            break;
+        case BLOCK:
+//         case BOX:
+        case COMPACT:
+        case INLINE:
+        case INLINE_BLOCK:
+//         case INLINE_BOX:
+        case INLINE_TABLE:
+        case LIST_ITEM:
+        case NONE:
+        case RUN_IN:
+        case TABLE:
+            // The special TABLE > FORM quirk allows the form to sit directly under the table
+            if (child->element() && child->element()->isHTMLElement() && child->element()->id() == ID_FORM)
+                wrapInAnonymousSection = !static_cast<HTMLFormElementImpl*>(child->element())->isMalformed();
+            else
+                wrapInAnonymousSection = true;
+            break;
+    }
+
+    if (!wrapInAnonymousSection) {
+        RenderContainer::addChild(child, beforeChild);
         return;
     }
 
-    switch(child->style()->display())
-    {
-    case TABLE_CAPTION:
-        tCaption = static_cast<RenderBlock *>(child);
-        break;
-    case TABLE_COLUMN:
-    case TABLE_COLUMN_GROUP:
-	has_col_elems = true;
-        break;
-    case TABLE_HEADER_GROUP:
-	if ( !head )
-	    head = static_cast<RenderTableSection *>(child);
-	else if ( !firstBody )
-            firstBody = static_cast<RenderTableSection *>(child);
-        break;
-    case TABLE_FOOTER_GROUP:
-	if ( !foot ) {
-	    foot = static_cast<RenderTableSection *>(child);
-	    break;
-	}
-	// fall through
-    case TABLE_ROW_GROUP:
-        if(!firstBody)
-            firstBody = static_cast<RenderTableSection *>(child);
-        break;
-    default:
-        if ( !beforeChild && lastChild() &&
-	     lastChild()->isTableSection() && lastChild()->isAnonymous() ) {
-            o = lastChild();
-        } else {
-	    RenderObject *lastBox = beforeChild;
-	    while ( lastBox && lastBox->parent()->isAnonymous() &&
-		    !lastBox->isTableSection() && lastBox->style()->display() != TABLE_CAPTION )
-		lastBox = lastBox->parent();
-	    if ( lastBox && lastBox->isAnonymous() ) {
-		lastBox->addChild( child, beforeChild );
-		return;
-	    } else {
-		if ( beforeChild && !beforeChild->isTableSection() )
-		    beforeChild = 0;
-  		//kdDebug( 6040 ) << this <<" creating anonymous table section beforeChild="<< beforeChild << endl;
-		o = new (renderArena()) RenderTableSection(document() /* anonymous */);
-		RenderStyle *newStyle = new RenderStyle();
-		newStyle->inheritFrom(style());
-                newStyle->setDisplay(TABLE_ROW_GROUP);
-		o->setStyle(newStyle);
-		addChild(o, beforeChild);
-	    }
-        }
-        o->addChild(child);
-        child->setNeedsLayoutAndMinMaxRecalc();
+    if (!beforeChild && lastChild() && lastChild()->isTableSection() && lastChild()->isAnonymous()) {
+        lastChild()->addChild(child);
         return;
     }
-    RenderContainer::addChild(child,beforeChild);
-}
 
+    RenderObject *lastBox = beforeChild;
+    RenderObject *nextToLastBox = beforeChild;
+    while (lastBox && lastBox->parent()->isAnonymous() &&
+            !lastBox->isTableSection() && lastBox->style()->display() != TABLE_CAPTION) {
+        nextToLastBox = lastBox;
+        lastBox = lastBox->parent();
+    }
+    if (lastBox && lastBox->isAnonymous()) {
+        lastBox->addChild(child, nextToLastBox);
+        return;
+    }
 
+    if (beforeChild && !beforeChild->isTableSection())
+        beforeChild = 0;
+    RenderTableSection* section = new (renderArena()) RenderTableSection(document() /* anonymous */);
+    RenderStyle* newStyle = new RenderStyle();
+    newStyle->inheritFrom(style());
+    newStyle->setDisplay(TABLE_ROW_GROUP);
+    section->setStyle(newStyle);
+    addChild(section, beforeChild);
+    section->addChild(child);
+}
 
 void RenderTable::calcWidth()
 {
@@ -280,6 +304,7 @@
 
     RenderObject *child = firstChild();
     while( child ) {
+        // FIXME: What about a form that has a display value that makes it a table section?
 	if ( child->needsLayout() && !(child->element() && child->element()->id() == ID_FORM) )
 	    child->layout();
 	if ( child->isTableSection() ) {
@@ -644,7 +669,7 @@
     while ( child ) {
 	switch(child->style()->display()) {
 	case TABLE_CAPTION:
-	    if ( !tCaption) {
+	    if ( !tCaption && child->isRenderBlock() ) {
 		tCaption = static_cast<RenderBlock*>(child);
                 tCaption->setNeedsLayout(true);
             }
@@ -653,33 +678,35 @@
 	case TABLE_COLUMN_GROUP:
 	    has_col_elems = true;
 	    break;
-	case TABLE_HEADER_GROUP: {
-	    RenderTableSection *section = static_cast<RenderTableSection *>(child);
-	    if ( !head )
-		head = section;
-	    else if ( !firstBody )
-		firstBody = section;
-	    if ( section->needCellRecalc )
-		section->recalcCells();
-	    break;
-	}
-	case TABLE_FOOTER_GROUP: {
-	    RenderTableSection *section = static_cast<RenderTableSection *>(child);
-	    if ( !foot )
-		foot = section;
-	    else if ( !firstBody )
-		firstBody = section;
-	    if ( section->needCellRecalc )
-		section->recalcCells();
-	    break;
-	}
-	case TABLE_ROW_GROUP: {
-	    RenderTableSection *section = static_cast<RenderTableSection *>(child);
-	    if ( !firstBody )
-		firstBody = section;
-	    if ( section->needCellRecalc )
-		section->recalcCells();
-	}
+        case TABLE_HEADER_GROUP:
+            if (child->isTableSection()) {
+                RenderTableSection *section = static_cast<RenderTableSection *>(child);
+                if (!head)
+                    head = section;
+                else if (!firstBody)
+                    firstBody = section;
+                if (section->needCellRecalc)
+                    section->recalcCells();
+            }
+        case TABLE_FOOTER_GROUP:
+            if (child->isTableSection()) {
+                RenderTableSection *section = static_cast<RenderTableSection *>(child);
+                if (!foot)
+                    foot = section;
+                else if (!firstBody)
+                    firstBody = section;
+                if (section->needCellRecalc)
+                    section->recalcCells();
+            }
+        case TABLE_ROW_GROUP:
+            if (child->isTableSection()) {
+                RenderTableSection *section = static_cast<RenderTableSection *>(child);
+                if (!firstBody)
+                    firstBody = section;
+                if (section->needCellRecalc)
+                    section->recalcCells();
+            }
+            break;
 	default:
 	    break;
 	}
@@ -955,39 +982,40 @@
     kdDebug( 6040 ) << renderName() << "(TableSection)::addChild( " << child->renderName()  << ", beforeChild=" <<
                        (beforeChild ? beforeChild->renderName() : "0") << " )" << endl;
 #endif
-    RenderObject *row = child;
-
-    if (child->element() && child->element()->id() == ID_FORM) {
-        RenderContainer::addChild(child,beforeChild);
-        return;
-    }
-
     if ( !child->isTableRow() ) {
+        // TBODY > FORM quirk (???)
+        if (child->element() && child->element()->isHTMLElement() && child->element()->id() == ID_FORM &&
+            static_cast<HTMLFormElementImpl*>(child->element())->isMalformed())
+        {
+            RenderContainer::addChild(child, beforeChild);
+            return;
+        }
 
-        if( !beforeChild )
-            beforeChild = lastChild();
+        RenderObject* last = beforeChild;
+        if (!last)
+            last = lastChild();
+        if (last && last->isAnonymous()) {
+            last->addChild(child);
+            return;
+        }
 
-        if( beforeChild && beforeChild->isAnonymous() )
-            row = beforeChild;
-        else {
-	    RenderObject *lastBox = beforeChild;
-	    while ( lastBox && lastBox->parent()->isAnonymous() && !lastBox->isTableRow() )
-		lastBox = lastBox->parent();
-	    if ( lastBox && lastBox->isAnonymous() ) {
-		lastBox->addChild( child, beforeChild );
-		return;
-	    } else {
-		//kdDebug( 6040 ) << "creating anonymous table row" << endl;
-		row = new (renderArena()) RenderTableRow(document() /* anonymous table */);
-		RenderStyle *newStyle = new RenderStyle();
-		newStyle->inheritFrom(style());
-		newStyle->setDisplay( TABLE_ROW );
-		row->setStyle(newStyle);
-		addChild(row, beforeChild);
-	    }
+        // If beforeChild is inside an anonymous cell/row, insert into the cell or into
+        // the anonymous row containing it, if there is one.
+        RenderObject* lastBox = last;
+        while (lastBox && lastBox->parent()->isAnonymous() && !lastBox->isTableRow())
+            lastBox = lastBox->parent();
+        if (lastBox && lastBox->isAnonymous()) {
+            lastBox->addChild(child, beforeChild);
+            return;
         }
+
+        RenderObject* row = new (renderArena()) RenderTableRow(document() /* anonymous table */);
+        RenderStyle* newStyle = new RenderStyle();
+        newStyle->inheritFrom(style());
+        newStyle->setDisplay(TABLE_ROW);
+        row->setStyle(newStyle);
+        addChild(row, beforeChild);
         row->addChild(child);
-        child->setNeedsLayoutAndMinMaxRecalc();
         return;
     }
 
@@ -1562,11 +1590,11 @@
         int offset = (endrow - startrow)/2;
         while (endrow - startrow > 1) {
             index = startrow+offset;
-            if (rowPos[index] <= min_y ) 
+            if (rowPos[index] <= min_y )
                 // index is below both min_y and max_y
                 startrow = index;
             else
-            if (rowPos[index] > max_y) 
+            if (rowPos[index] > max_y)
                 // index is above both min_y and max_y
                 endrow = index;
             else
@@ -1895,62 +1923,50 @@
     kdDebug( 6040 ) << renderName() << "(TableRow)::addChild( " << child->renderName() << " )"  << ", " <<
                        (beforeChild ? beforeChild->renderName() : "0") << " )" << endl;
 #endif
-    if (child->element() && child->element()->id() == ID_FORM) {
-        RenderContainer::addChild(child,beforeChild);
-        return;
-    }
 
-    RenderTableCell *cell;
+    if ( !child->isTableCell() ) {
+        // TR > FORM quirk (???)
+        if (child->element() && child->element()->isHTMLElement() && child->element()->id() == ID_FORM &&
+            static_cast<HTMLFormElementImpl*>(child->element())->isMalformed())
+        {
+            RenderContainer::addChild(child, beforeChild);
+            return;
+        }
 
-    if ( !child->isTableCell() ) {
-	RenderObject *last = beforeChild;
-        if ( !last )
+        RenderObject* last = beforeChild;
+        if (!last)
             last = lastChild();
-        RenderTableCell *cell = 0;
-        if( last && last->isAnonymous() && last->isTableCell() )
-            cell = static_cast<RenderTableCell *>(last);
-        else {
-            // If beforeChild is inside an anonymous cell, insert into the cell.
-            if (last && !last->isTableCell() && last->parent() && last->parent()->isAnonymous()) {
-                last->parent()->addChild(child, beforeChild);
-                return;
-            }
-            cell = new (renderArena()) RenderTableCell(document() /* anonymous object */);
-	    RenderStyle *newStyle = new RenderStyle();
-	    newStyle->inheritFrom(style());
-	    newStyle->setDisplay( TABLE_CELL );
-	    cell->setStyle(newStyle);
-	    addChild(cell, beforeChild);
+        if (last && last->isAnonymous() && last->isTableCell()) {
+            last->addChild(child);
+            return;
         }
+
+        // If beforeChild is inside an anonymous cell, insert into the cell.
+        if (last && !last->isTableCell() && last->parent() && last->parent()->isAnonymous()) {
+            last->parent()->addChild(child, beforeChild);
+            return;
+        }
+
+        RenderTableCell* cell = new (renderArena()) RenderTableCell(document() /* anonymous object */);
+        RenderStyle* newStyle = new RenderStyle();
+        newStyle->inheritFrom(style());
+        newStyle->setDisplay(TABLE_CELL);
+        cell->setStyle(newStyle);
+        addChild(cell, beforeChild);
         cell->addChild(child);
-        child->setNeedsLayoutAndMinMaxRecalc();
         return;
-    } else
-        cell = static_cast<RenderTableCell *>(child);
+    }
 
+    RenderTableCell* cell = static_cast<RenderTableCell*>(child);
+
     section()->addCell( cell, this );
 
     RenderContainer::addChild(cell,beforeChild);
 
-    if ( ( beforeChild || nextSibling()) && section() )
-	section()->setNeedCellRecalc();
+    if ( beforeChild || nextSibling() )
+        section()->setNeedCellRecalc();
 }
 
-RenderObject* RenderTableRow::removeChildNode(RenderObject* child)
-{
-// RenderTableCell detach should do it
-//     if ( section() )
-// 	section()->setNeedCellRecalc();
-    return RenderContainer::removeChildNode( child );
-}
-
-#ifdef ENABLE_DUMP
-void RenderTableRow::dump(QTextStream &stream, const QString &ind) const
-{
-    RenderContainer::dump(stream,ind);
-}
-#endif
-
 void RenderTableRow::layout()
 {
     KHTMLAssert( needsLayout() );
@@ -2079,6 +2095,17 @@
   }
 }
 
+Length RenderTableCell::styleOrColWidth()
+{
+    Length w = style()->width();
+    if (colSpan() > 1 || !w.isVariable())
+        return w;
+    RenderTableCol* col = table()->colElement(_col);
+    if (col)
+        w = col->style()->width();
+    return w;
+}
+
 void RenderTableCell::calcMinMaxWidth()
 {
     KHTMLAssert( !minMaxKnown() );
@@ -2089,15 +2116,16 @@
     RenderBlock::calcMinMaxWidth();
     if (element() && style()->whiteSpace() == NORMAL) {
         // See if nowrap was set.
+        Length w = styleOrColWidth();
         DOMString nowrap = static_cast<ElementImpl*>(element())->getAttribute(ATTR_NOWRAP);
-        if (!nowrap.isNull() && style()->width().isFixed() &&
-            m_minWidth < style()->width().value() )
+        if (!nowrap.isNull() && w.isFixed() &&
+            m_minWidth < w.value() )
             // Nowrap is set, but we didn't actually use it because of the
             // fixed width set on the cell.  Even so, it is a WinIE/Moz trait
             // to make the minwidth of the cell into the fixed width.  They do this
             // even in strict mode, so do not make this a quirk.  Affected the top
             // of hiptop.com.
-            m_minWidth = style()->width().value();
+            m_minWidth = w.value();
     }
 
     setMinMaxKnown();
@@ -2770,12 +2798,10 @@
 // -------------------------------------------------------------------------
 
 RenderTableCol::RenderTableCol(DOM::NodeImpl* node)
-    : RenderContainer(node)
+    : RenderContainer(node), m_span(1)
 {
     // init RenderObject attributes
     setInline(true);   // our object is not Inline
-
-    _span = 1;
     updateFromElement();
 }
 
@@ -2784,29 +2810,16 @@
   DOM::NodeImpl *node = element();
   if ( node && (node->id() == ID_COL || node->id() == ID_COLGROUP) ) {
       DOM::HTMLTableColElementImpl *tc = static_cast<DOM::HTMLTableColElementImpl *>(node);
-      _span = tc->span();
+      m_span = tc->span();
   } else
-      _span = ! ( style() && style()->display() == TABLE_COLUMN_GROUP );
+      m_span = ! ( style() && style()->display() == TABLE_COLUMN_GROUP );
 }
 
-void RenderTableCol::addChild(RenderObject *child, RenderObject *beforeChild)
-{
-#ifdef DEBUG_LAYOUT
-    //kdDebug( 6040 ) << renderName() << "(Table)::addChild( " << child->renderName() << " )"  << ", " <<
-    //                   (beforeChild ? beforeChild->renderName() : 0) << " )" << endl;
-#endif
-
-    KHTMLAssert(child->style()->display() == TABLE_COLUMN);
-
-    // these have to come before the table definition!
-    RenderContainer::addChild(child,beforeChild);
-}
-
 #ifdef ENABLE_DUMP
 void RenderTableCol::dump(QTextStream &stream, const QString &ind) const
 {
     RenderContainer::dump(stream,ind);
-    stream << " _span=" << _span;
+    stream << " _span=" << m_span;
 }
 #endif
 
Index: khtml/rendering/render_box.cpp
===================================================================
--- khtml/rendering/render_box.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/rendering/render_box.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -5,6 +5,7 @@
  *           (C) 1999 Antti Koivisto (koivisto@kde.org)
  *           (C) 2002-2003 Apple Computer, Inc.
  *           (C) 2005 Allan Sandfeld Jensen (kde@carewolf.com)
+ *           (C) 2006 Samuel Weinig (sam.weinig@gmail.com)
  *
  * This library is free software; you can redistribute it and/or
  * modify it under the terms of the GNU Library General Public
@@ -158,6 +159,8 @@
         if (!m_layer) {
             m_layer = new (renderArena()) RenderLayer(this);
             m_layer->insertOnlyThisLayer();
+            if (parent() && containingBlock())
+                m_layer->updateLayerPosition();
         }
     }
     else if (m_layer && !isCanvas()) {
@@ -393,16 +396,73 @@
 void RenderBox::paintBackground(QPainter *p, const QColor& c, const BackgroundLayer* bgLayer, int clipy, int cliph, int _tx, int _ty, int w, int height)
 {
     paintBackgroundExtended(p, c, bgLayer, clipy, cliph, _tx, _ty, w, height,
-                            borderLeft(), borderRight());
+                            borderLeft(), borderRight(), paddingLeft(), paddingRight());
 }
 
+static void calculateBackgroundSize(const BackgroundLayer* bgLayer, int& scaledWidth, int& scaledHeight)
+{
+    CachedImage* bg = bgLayer->backgroundImage();
+
+    if (bgLayer->isBackgroundSizeSet()) {
+        Length bgWidth = bgLayer->backgroundSize().width;
+        Length bgHeight = bgLayer->backgroundSize().height;
+
+        if (bgWidth.isPercent())
+            scaledWidth = scaledWidth * bgWidth.value() / 100;
+        else if (bgWidth.isFixed())
+            scaledWidth = bgWidth.value();
+        else if (bgWidth.isVariable()) {
+            // If the width is auto and the height is not, we have to use the appropriate
+            // scale to maintain our aspect ratio.
+            if (bgHeight.isPercent()) {
+                int scaledH = scaledHeight * bgHeight.value() / 100;
+                scaledWidth = bg->pixmap_size().width() * scaledH / bg->pixmap_size().height();
+            } else if (bgHeight.isFixed())
+                scaledWidth = bg->pixmap_size().width() * bgHeight.value() / bg->pixmap_size().height();
+        }
+
+        if (bgHeight.isPercent())
+            scaledHeight = scaledHeight * bgHeight.value() / 100;
+        else if (bgHeight.isFixed())
+            scaledHeight = bgHeight.value();
+        else if (bgHeight.isVariable()) {
+            // If the height is auto and the width is not, we have to use the appropriate
+            // scale to maintain our aspect ratio.
+            if (bgWidth.isPercent())
+                scaledHeight = bg->pixmap_size().height() * scaledWidth / bg->pixmap_size().width();
+            else if (bgWidth.isFixed())
+                scaledHeight = bg->pixmap_size().height() * bgWidth.value() / bg->pixmap_size().width();
+            else if (bgWidth.isVariable()) {
+                // If both width and height are auto, we just want to use the image's
+                // intrinsic size.
+                scaledWidth = bg->pixmap_size().width();
+                scaledHeight = bg->pixmap_size().height();
+            }
+        }
+    } else {
+        scaledWidth = bg->pixmap_size().width();
+        scaledHeight = bg->pixmap_size().height();
+    }
+}
+
 void RenderBox::paintBackgroundExtended(QPainter *p, const QColor &c, const BackgroundLayer* bgLayer, int clipy, int cliph,
                                         int _tx, int _ty, int w, int h,
-                                        int bleft, int bright)
+                                        int bleft, int bright, int pleft, int pright)
 {
     if ( cliph < 0 )
 	return;
 
+    if (bgLayer->backgroundClip() != BGBORDER) {
+        // Clip to the padding or content boxes as necessary.
+        bool includePadding = bgLayer->backgroundClip() == BGCONTENT;
+        int x = _tx + bleft + (includePadding ? pleft : 0);
+        int y = _ty + borderTop() + (includePadding ? paddingTop() : 0);
+        int width = w - bleft - bright - (includePadding ? pleft + pright : 0);
+        int height = h - borderTop() - borderBottom() - (includePadding ? paddingTop() + paddingBottom() : 0);
+        p->save();
+        p->setClipRect(QRect(x, y, width, height), QPainter::CoordPainter);
+    }
+
     CachedImage* bg = bgLayer->backgroundImage();
     bool shouldPaintBackgroundImage = bg && bg->pixmap_size() == bg->valid_rect().size() && !bg->isTransparent() && !bg->isErrorImage();
     QColor bgColor = c;
@@ -417,77 +477,91 @@
         int sy = 0;
         int cw,ch;
         int cx,cy;
-        int vpab = bleft + bright;
-        int hpab = borderTop() + borderBottom();
+        int scaledImageWidth, scaledImageHeight;
 
         // CSS2 chapter 14.2.1
 
-	int pixw = bg->pixmap_size().width();
-	int pixh = bg->pixmap_size().height();
-        if (bgLayer->backgroundAttachment())
-        {
+        if (bgLayer->backgroundAttachment()) {
             //scroll
-            int pw = w - vpab;
-            int ph = h - hpab;
+            int hpab = 0, vpab = 0, left = 0, top = 0; // Init to 0 for background-origin of 'border'
+            if (bgLayer->backgroundOrigin() != BGBORDER) {
+                hpab += bleft + bright;
+                vpab += borderTop() + borderBottom();
+                left += bleft;
+                top += borderTop();
+                if (bgLayer->backgroundOrigin() == BGCONTENT) {
+                    hpab += pleft + pright;
+                    vpab += paddingTop() + paddingBottom();
+                    left += pleft;
+                    top += paddingTop();
+                }
+            }
+
+            int pw = w - hpab;
+            int ph = h - vpab;
+            scaledImageWidth = pw;
+            scaledImageHeight = ph;
+            calculateBackgroundSize(bgLayer, scaledImageWidth, scaledImageHeight);
+
             EBackgroundRepeat bgr = bgLayer->backgroundRepeat();
-            if( (bgr == NO_REPEAT || bgr == REPEAT_Y) && pw > pixw ) {
-                cw = pixw;
-                int xp = bgLayer->backgroundXPosition().minWidth(pw-pixw);
-                if ( xp >= 0 ) {
-                    cx = _tx + xp;
-                    cw = kMin(cw, pw - xp);
+            if ((bgr == NO_REPEAT || bgr == REPEAT_Y) && w > scaledImageWidth) {
+                cw = scaledImageWidth;
+                int xPosition = bgLayer->backgroundXPosition().minWidth(pw-scaledImageWidth);
+                if ( xPosition >= 0 ) {
+                    cx = _tx + xPosition;
+                    cw = kMin(cw, pw - xPosition);
                 }
                 else {
                     cx = _tx;
-                    if (pixw > 0) {
-                        sx = -xp;
-                        cw += xp;
+                    if (scaledImageWidth > 0) {
+                        sx = -xPosition;
+                        cw += xPosition;
                     }
                 }
-                cx += bleft;
+                cx += left;
             } else {
                 // repeat over x or background is wider than box
                 cw = w;
                 cx = _tx;
-                if (pixw > 0) {
-                    int xp = bgLayer->backgroundXPosition().minWidth(pw-pixw);
-                    if ((xp > 0) && (bgr == NO_REPEAT)) {
-                        cx += xp;
-                        cw -= xp;
+                if (scaledImageWidth > 0) {
+                    int xPosition = bgLayer->backgroundXPosition().minWidth(pw-scaledImageWidth);
+                    if ((xPosition > 0) && (bgr == NO_REPEAT)) {
+                        cx += xPosition;
+                        cw -= xPosition;
                     } else {
-                        sx =  pixw - (xp % pixw );
-                        sx -= bleft % pixw;
+                        sx = scaledImageWidth - (xPosition % scaledImageWidth);
+                        sx -= left % scaledImageWidth;
                     }
                 }
             }
-            if( (bgr == NO_REPEAT || bgr == REPEAT_X) && ph > pixh ) {
-                ch = pixh;
-                int yp = bgLayer->backgroundYPosition().minWidth(ph-pixh);
-                if ( yp >= 0 ) {
-                    cy = _ty + yp;
-                    ch = kMin(ch, ph - yp);
+            if( (bgr == NO_REPEAT || bgr == REPEAT_X) && ph > scaledImageHeight ) {
+                ch = scaledImageHeight;
+                int yPosition = bgLayer->backgroundYPosition().minWidth(ph - scaledImageHeight);
+                if ( yPosition >= 0 ) {
+                    cy = _ty + yPosition;
+                    ch = kMin(ch, ph - yPosition);
                 }
                 else {
                     cy = _ty;
-                    if (pixh > 0) {
-                        sy = -yp;
-                        ch += yp;
+                    if (scaledImageHeight > 0) {
+                        sy = -yPosition;
+                        ch += yPosition;
                     }
                 }
 
-                cy += borderTop();
+                cy += top;
             } else {
                 // repeat over y or background is taller than box
                 ch = h;
                 cy = _ty;
-                if (pixh > 0) {
-                    int yPosition = bgLayer->backgroundYPosition().minWidth(ph-pixh);
+                if (scaledImageHeight > 0) {
+                    int yPosition = bgLayer->backgroundYPosition().minWidth(ph - scaledImageHeight);
                     if ((yPosition > 0) && (bgr == NO_REPEAT)) {
                         cy += yPosition;
                         ch -= yPosition;
                     } else {
-                        sy = pixh - (yPosition % pixh );
-                        sy -= borderTop() % pixh;
+                        sy = scaledImageHeight - (yPosition % scaledImageHeight);
+                        sy -= top % scaledImageHeight;
                     }
                 }
             }
@@ -500,28 +574,33 @@
             QRect vr = viewRect();
             int pw = vr.width();
             int ph = vr.height();
+            scaledImageWidth = pw;
+            scaledImageHeight = ph;
+            calculateBackgroundSize(bgLayer, scaledImageWidth, scaledImageHeight);
+            EBackgroundRepeat bgr = bgLayer->backgroundRepeat();
 
-            EBackgroundRepeat bgr = bgLayer->backgroundRepeat();
-            if( (bgr == NO_REPEAT || bgr == REPEAT_Y) && pw > pixw ) {
-                cw = pixw;
-                cx = vr.x() + bgLayer->backgroundXPosition().minWidth(pw-pixw);
+            if( (bgr == NO_REPEAT || bgr == REPEAT_Y) && pw > scaledImageWidth ) {
+                cw = scaledImageWidth;
+                cx = vr.x() + bgLayer->backgroundXPosition().minWidth(pw - scaledImageWidth);
             } else {
                 cw = pw;
                 cx = vr.x();
-                sx =  pixw ? pixw - ((bgLayer->backgroundXPosition().minWidth(pw-pixw)) % pixw ) : 0;
+                if (scaledImageWidth > 0)
+                    sx = scaledImageWidth - bgLayer->backgroundXPosition().minWidth(pw - scaledImageWidth) % scaledImageWidth;
             }
 
-            if( (bgr == NO_REPEAT || bgr == REPEAT_X) && ph > pixh ) {
-                ch = pixh;
-                cy = vr.y() + bgLayer->backgroundYPosition().minWidth(ph-pixh);
+            if( (bgr == NO_REPEAT || bgr == REPEAT_X) && ph > scaledImageHeight ) {
+                ch = scaledImageHeight;
+                cy = vr.y() + bgLayer->backgroundYPosition().minWidth(ph - scaledImageHeight);
             } else {
                 ch = ph;
                 cy = vr.y();
-                sy = pixh ? pixh - ((bgLayer->backgroundYPosition().minWidth(ph-pixh)) % pixh ) : 0;
+                if (scaledImageHeight > 0)
+                    sy = scaledImageHeight - bgLayer->backgroundYPosition().minWidth(ph - scaledImageHeight) % scaledImageHeight;
             }
 
-            QRect fix(cx,cy,cw,ch);
-            QRect ele(_tx+bleft,_ty+borderTop(),w-vpab,h-hpab);
+            QRect fix(cx, cy, cw, ch);
+            QRect ele(_tx, _ty, w, h);
             QRect b = fix.intersect(ele);
 
             //kdDebug() <<" ele is " << ele << " b is " << b << " fix is " << fix << endl;
@@ -537,12 +616,16 @@
         }
         ch = kMin(ch, cliph);
 
-// 	kdDebug() << " clipy, cliph: " << clipy << ", " << cliph << endl;
+//         kdDebug() << " clipy, cliph: " << clipy << ", " << cliph << endl;
 //         kdDebug() << " drawTiledPixmap(" << cx << ", " << cy << ", " << cw << ", " << ch << ", " << sx << ", " << sy << ")" << endl;
         if (cw>0 && ch>0)
-            p->drawTiledPixmap(cx, cy, cw, ch, bg->tiled_pixmap(c), sx, sy);
+            p->drawTiledPixmap(cx, cy, cw, ch, bg->tiled_pixmap(c, scaledImageWidth, scaledImageHeight), sx, sy);
 
     }
+
+    if (bgLayer->backgroundClip() != BGBORDER)
+        p->restore(); // Undo the background clip
+
 }
 
 void RenderBox::outlineBox(QPainter *p, int _tx, int _ty, const char *color)
@@ -651,7 +734,7 @@
                 o->layer()->subtractScrollOffset( xPos, yPos );
             if (isPositioned())
                 o->layer()->checkInlineRelOffset(this, xPos, yPos);
-        }            
+        }
 
         if(!isInline() || isReplaced())
             xPos += m_x, yPos += m_y;
@@ -700,13 +783,15 @@
         Q_ASSERT(p);
         while( p->isInline() && !p->isReplaced() )
             p = p->parent();
-        int off = p->hasOverflowClip() ? 0 : p->negativeOverflowWidth();
-        p->repaintRectangle( -ow - off, -ow, p->effectiveWidth()+ow*2, p->effectiveHeight()+ow*2, immediate);
+        int xoff = p->hasOverflowClip() ? 0 : p->overflowLeft();
+        int yoff = p->hasOverflowClip() ? 0 : p->overflowTop();
+        p->repaintRectangle( -ow + xoff, -ow + yoff, p->effectiveWidth()+ow*2, p->effectiveHeight()+ow*2, immediate);
     }
     else
     {
-        int off = hasOverflowClip() ? 0 : negativeOverflowWidth();
-        repaintRectangle( -ow - off, -ow, effectiveWidth()+ow*2, effectiveHeight()+ow*2, immediate);
+        int xoff = hasOverflowClip() ? 0 : overflowLeft();
+        int yoff = hasOverflowClip() ? 0 : overflowTop();
+        repaintRectangle( -ow + xoff, -ow + yoff, effectiveWidth()+ow*2, effectiveHeight()+ow*2, immediate);
     }
 }
 
@@ -1172,13 +1257,32 @@
     if (h.isPercent())
        return calcContentHeight(h.width(containingBlock()->availableHeight()));
 
-    // Check for implicit height 
+    // Check for implicit height
     if (hasImplicitHeight())
         return calcImplicitHeight();
 
     return containingBlock()->availableHeight();
 }
 
+int RenderBox::availableWidth() const
+{
+    return availableWidthUsing(style()->width());
+}
+
+int RenderBox::availableWidthUsing(const Length& w) const
+{
+    if (w.isFixed())
+        return calcContentWidth(w.value());
+
+    if (isCanvas())
+        return static_cast<const RenderCanvas*>(this)->viewportWidth();
+
+    if (w.isPercent())
+       return calcContentWidth(w.width(containingBlock()->availableWidth()));
+
+    return containingBlock()->availableWidth();
+}
+
 void RenderBox::calcVerticalMargins()
 {
     if( isTableCell() ) {
@@ -1211,394 +1315,845 @@
 
 void RenderBox::calcAbsoluteHorizontal()
 {
-    const int AUTO = -666666;
-    int l, r, cw;
+   if (isReplaced()) {
+        calcAbsoluteHorizontalReplaced();
+        return;
+    }
 
-    RenderObject* cb = container();
-    int pab = (style()->boxSizing() == BORDER_BOX) ? 0 :
-        borderLeft()+ borderRight()+ paddingLeft()+ paddingRight();
+    // QUESTIONS
+    // FIXME 1: Which RenderObject's 'direction' property should used: the
+    // containing block (cb) as the spec seems to imply, the parent (parent()) as
+    // was previously done in calculating the static distances, or ourself, which
+    // was also previously done for deciding what to override when you had
+    // over-constrained margins?  Also note that the container block is used
+    // in similar situations in other parts of the RenderBox class (see calcWidth()
+    // and calcHorizontalMargins()). For now we are using the parent for quirks
+    // mode and the containing block for strict mode.
 
-    l = r = AUTO;
-    cw = containingBlockWidth() + cb->paddingLeft() + cb->paddingRight();
+    // FIXME 2: Should we still deal with these the cases of 'left' or 'right' having
+    // the type 'static' in determining whether to calculate the static distance?
+    // NOTE: 'static' is not a legal value for 'left' or 'right' as of CSS 2.1.
 
-    if (!style()->left().isVariable())
-        l = style()->left().width(cw);
-    if (!style()->right().isVariable())
-        r = style()->right().width(cw);
+    // FIXME 3: Can perhaps optimize out cases when max-width/min-width are greater
+    // than or less than the computed m_width.  Be careful of box-sizing and
+    // percentage issues.
 
-    int static_distance=0;
-    if (parent()->style()->direction()==LTR && (l==AUTO && r==AUTO ))
-    {
-        // calc hypothetical location in the normal flow
-        // used for 1) left=static-position
-        //          2) left, right, width are all auto -> calc top -> 3.
-        //          3) precalc for case 2 below
+    // The following is based off of the W3C Working Draft from April 11, 2006 of
+    // CSS 2.1: Section 10.3.7 "Absolutely positioned, non-replaced elements"
+    // <http://www.w3.org/TR/CSS21/visudet.html#abs-non-replaced-width>
+    // (block-style-comments in this function and in calcAbsoluteHorizontalValues()
+    // correspond to text from the spec)
 
-        // all positioned elements are blocks, so that
-        // would be at the left edge
 
-        RenderObject* po = parent();
-        static_distance = m_staticX - cb->borderLeft(); // Should already have been set through layout of the parent().
-        for (; po && po != cb; po = po->parent())
-            static_distance += po->xPos();
+    // We don't use containingBlock(), since we may be positioned by an enclosing
+    // relative positioned inline.
+    const RenderObject* containerBlock = container();
 
-        l = static_distance;
-    }
+    // FIXME: This is incorrect for cases where the container block is a relatively
+    // positioned inline.
+    const int containerWidth = containingBlockWidth() + containerBlock->paddingLeft() + containerBlock->paddingRight();
 
-    else if (parent()->style()->direction()==RTL && (l==AUTO && r==AUTO ))
-    {
-        RenderObject* po = parent();
-        static_distance = m_staticX + cw + cb->borderRight() - po->width(); // Should already have been set through layout of the parent().
-        for (; po && po != cb; po = po->parent())
-            static_distance -= po->xPos();
+    // To match WinIE, in quirks mode use the parent's 'direction' property
+    // instead of the the container block's.
+    EDirection containerDirection = (style()->htmlHacks()) ? parent()->style()->direction() : containerBlock->style()->direction();
 
-        r = static_distance;
+    const int bordersPlusPadding = borderLeft() + borderRight() + paddingLeft() + paddingRight();
+    const Length marginLeft = style()->marginLeft();
+    const Length marginRight = style()->marginRight();
+    Length left = style()->left();
+    Length right = style()->right();
+
+    /*---------------------------------------------------------------------------*\
+     * For the purposes of this section and the next, the term "static position"
+     * (of an element) refers, roughly, to the position an element would have had
+     * in the normal flow. More precisely:
+     *
+     * * The static position for 'left' is the distance from the left edge of the
+     *   containing block to the left margin edge of a hypothetical box that would
+     *   have been the first box of the element if its 'position' property had
+     *   been 'static' and 'float' had been 'none'. The value is negative if the
+     *   hypothetical box is to the left of the containing block.
+     * * The static position for 'right' is the distance from the right edge of the
+     *   containing block to the right margin edge of the same hypothetical box as
+     *   above. The value is positive if the hypothetical box is to the left of the
+     *   containing block's edge.
+     *
+     * But rather than actually calculating the dimensions of that hypothetical box,
+     * user agents are free to make a guess at its probable position.
+     *
+     * For the purposes of calculating the static position, the containing block of
+     * fixed positioned elements is the initial containing block instead of the
+     * viewport, and all scrollable boxes should be assumed to be scrolled to their
+     * origin.
+    \*---------------------------------------------------------------------------*/
+
+    // see FIXME 2
+    // Calculate the static distance if needed.
+    if (left.isVariable() && right.isVariable()) {
+        if (containerDirection == LTR) {
+            // 'm_staticX' should already have been set through layout of the parent.
+            int staticPosition = m_staticX - containerBlock->borderLeft();
+            for (RenderObject* po = parent(); po && po != containerBlock; po = po->parent())
+                staticPosition += po->xPos();
+            left = Length(staticPosition, Fixed);
+        } else {
+            RenderObject* po = parent();
+            // 'm_staticX' should already have been set through layout of the parent.
+            int staticPosition = m_staticX + containerWidth + containerBlock->borderRight() - po->width();
+            for (; po && po != containerBlock; po = po->parent())
+                staticPosition -= po->xPos();
+            right = Length(staticPosition, Fixed);
+        }
     }
 
-    int w = m_width, ml, mr, x;
-    calcAbsoluteHorizontalValues(Width, cb, cw, pab, static_distance, l, r, w, ml, mr, x);
+    // Calculate constraint equation values for 'width' case.
+    calcAbsoluteHorizontalValues(style()->width(), containerBlock, containerDirection,
+                                 containerWidth, bordersPlusPadding,
+                                 left, right, marginLeft, marginRight,
+                                 m_width, m_marginLeft, m_marginRight, m_x);
+    // Calculate constraint equation values for 'max-width' case.calcContentWidth(width.width(containerWidth));
+    if (style()->maxWidth().value() != UNDEFINED) {
+        short maxWidth;
+        short maxMarginLeft;
+        short maxMarginRight;
+        short maxXPos;
 
-    m_width = w;
-    m_marginLeft = ml;
-    m_marginRight = mr;
-    m_x = x;
+        calcAbsoluteHorizontalValues(style()->maxWidth(), containerBlock, containerDirection,
+                                     containerWidth, bordersPlusPadding,
+                                     left, right, marginLeft, marginRight,
+                                     maxWidth, maxMarginLeft, maxMarginRight, maxXPos);
 
-    // Avoid doing any work in the common case (where the values of min-width and max-width are their defaults).
-    int minW = m_width, minML, minMR, minX;
-    calcAbsoluteHorizontalValues(MinWidth, cb, cw, pab, static_distance, l, r, minW, minML, minMR, minX);
+        if (m_width > maxWidth) {
+            m_width = maxWidth;
+            m_marginLeft = maxMarginLeft;
+            m_marginRight = maxMarginRight;
+            m_x = maxXPos;
+        }
+    }
 
-    int maxW = m_width, maxML, maxMR, maxX;
-    if (style()->maxWidth().value() != UNDEFINED)
-        calcAbsoluteHorizontalValues(MaxWidth, cb, cw, pab, static_distance, l, r, maxW, maxML, maxMR, maxX);
+    // Calculate constraint equation values for 'min-width' case.
+    if (style()->minWidth().value()) {
+        short minWidth;
+        short minMarginLeft;
+        short minMarginRight;
+        short minXPos;
 
-    if (m_width > maxW) {
-        m_width = maxW;
-        m_marginLeft = maxML;
-        m_marginRight = maxMR;
-        m_x = maxX;
+        calcAbsoluteHorizontalValues(style()->minWidth(), containerBlock, containerDirection,
+                                     containerWidth, bordersPlusPadding,
+                                     left, right, marginLeft, marginRight,
+                                     minWidth, minMarginLeft, minMarginRight, minXPos);
+
+        if (m_width < minWidth) {
+            m_width = minWidth;
+            m_marginLeft = minMarginLeft;
+            m_marginRight = minMarginRight;
+            m_x = minXPos;
+        }
     }
 
-    if (m_width < minW) {
-        m_width = minW;
-        m_marginLeft = minML;
-        m_marginRight = minMR;
-        m_x = minX;
-    }
+    // Put m_width into correct form.
+    m_width += bordersPlusPadding;
 }
 
-void RenderBox::calcAbsoluteHorizontalValues(WidthType widthType, RenderObject* cb, int cw, int pab, int static_distance,
-                                             int l, int r, int& w, int& ml, int& mr, int& x)
+void RenderBox::calcAbsoluteHorizontalValues(Length width, const RenderObject* containerBlock, EDirection containerDirection,
+                                             const int containerWidth, const int bordersPlusPadding,
+                                             const Length left, const Length right, const Length marginLeft, const Length marginRight,
+                                             short& widthValue, short& marginLeftValue, short& marginRightValue, short& xPos)
 {
-    const int AUTO = -666666;
+    // 'left' and 'right' cannot both be 'auto' because one would of been
+    // converted to the static postion already
+    assert(!(left.isVariable() && right.isVariable()));
 
-    w = ml = mr = AUTO;
+    int leftValue = 0;
 
-    if (!style()->marginLeft().isVariable())
-        ml = style()->marginLeft().width(cw);
-    if (!style()->marginRight().isVariable())
-        mr = style()->marginRight().width(cw);
+    bool widthIsAuto = width.isVariable();
+    bool leftIsAuto = left.isVariable();
+    bool rightIsAuto = right.isVariable();
 
-    Length width;
-    if (widthType == Width)
-        width = style()->width();
-    else if (widthType == MinWidth)
-        width = style()->minWidth();
-    else
-        width = style()->maxWidth();
+    if (!leftIsAuto && !widthIsAuto && !rightIsAuto) {
+        /*-----------------------------------------------------------------------*\
+         * If none of the three is 'auto': If both 'margin-left' and 'margin-
+         * right' are 'auto', solve the equation under the extra constraint that
+         * the two margins get equal values, unless this would make them negative,
+         * in which case when direction of the containing block is 'ltr' ('rtl'),
+         * set 'margin-left' ('margin-right') to zero and solve for 'margin-right'
+         * ('margin-left'). If one of 'margin-left' or 'margin-right' is 'auto',
+         * solve the equation for that value. If the values are over-constrained,
+         * ignore the value for 'left' (in case the 'direction' property of the
+         * containing block is 'rtl') or 'right' (in case 'direction' is 'ltr')
+         * and solve for that value.
+        \*-----------------------------------------------------------------------*/
+        // NOTE:  It is not necessary to solve for 'right' in the over constrained
+        // case because the value is not used for any further calculations.
 
-    if (!width.isVariable())
-        w = width.width(cw);
-    else if (isReplaced())
-        w = intrinsicWidth();
+        leftValue = left.width(containerWidth);
+        widthValue = calcContentWidth(width.width(containerWidth));
 
-    if (l != AUTO && w != AUTO && r != AUTO) {
-        // left, width, right all given, play with margins
-        int ot = l + w + r + pab;
+        const int availableSpace = containerWidth - (leftValue + widthValue + right.width(containerWidth) + bordersPlusPadding);
 
-        if (ml==AUTO && mr==AUTO)
-        {
-            // both margins auto, solve for equality
-            ml = (cw - ot)/2;
-            mr = cw - ot - ml;
+        // Margins are now the only unknown
+        if (marginLeft.isVariable() && marginRight.isVariable()) {
+            // Both margins auto, solve for equality
+            if (availableSpace >= 0) {
+                marginLeftValue = availableSpace / 2; // split the diference
+                marginRightValue = availableSpace - marginLeftValue;  // account for odd valued differences
+            } else {
+                // see FIXME 1
+                if (containerDirection == LTR) {
+                    marginLeftValue = 0;
+                    marginRightValue = availableSpace; // will be negative
+                } else {
+                    marginLeftValue = availableSpace; // will be negative
+                    marginRightValue = 0;
+                }
+            }
+        } else if (marginLeft.isVariable()) {
+            // Solve for left margin
+            marginRightValue = marginRight.width(containerWidth);
+            marginLeftValue = availableSpace - marginRightValue;
+        } else if (marginRight.isVariable()) {
+            // Solve for right margin
+            marginLeftValue = marginLeft.width(containerWidth);
+            marginRightValue = availableSpace - marginLeftValue;
+        } else {
+            // Over-constrained, solve for left if direction is RTL
+            marginLeftValue = marginLeft.width(containerWidth);
+            marginRightValue = marginRight.width(containerWidth);
+
+            // see FIXME 1 -- used to be "this->style()->direction()"
+            if (containerDirection == RTL)
+                leftValue = (availableSpace + leftValue) - marginLeftValue - marginRightValue;
         }
-        else if (ml==AUTO)
-            // solve for left margin
-            ml = cw - ot - mr;
-        else if (mr==AUTO)
-            // solve for right margin
-            mr = cw - ot - ml;
-        else
-        {
-            // overconstrained, solve according to dir
-            if (style()->direction()==LTR)
-                r = cw - ( l + w + ml + mr + pab);
-            else
-                l = cw - ( r + w + ml + mr + pab);
-        }
-    }
-    else
-    {
-        // one or two of (left, width, right) missing, solve
+    } else {
+        /*--------------------------------------------------------------------*\
+         * Otherwise, set 'auto' values for 'margin-left' and 'margin-right'
+         * to 0, and pick the one of the following six rules that applies.
+         *
+         * 1. 'left' and 'width' are 'auto' and 'right' is not 'auto', then the
+         *    width is shrink-to-fit. Then solve for 'left'
+         *
+         *              OMIT RULE 2 AS IT SHOULD NEVER BE HIT
+         * ------------------------------------------------------------------
+         * 2. 'left' and 'right' are 'auto' and 'width' is not 'auto', then if
+         *    the 'direction' property of the containing block is 'ltr' set
+         *    'left' to the static position, otherwise set 'right' to the
+         *    static position. Then solve for 'left' (if 'direction is 'rtl')
+         *    or 'right' (if 'direction' is 'ltr').
+         * ------------------------------------------------------------------
+         *
+         * 3. 'width' and 'right' are 'auto' and 'left' is not 'auto', then the
+         *    width is shrink-to-fit . Then solve for 'right'
+         * 4. 'left' is 'auto', 'width' and 'right' are not 'auto', then solve
+         *    for 'left'
+         * 5. 'width' is 'auto', 'left' and 'right' are not 'auto', then solve
+         *    for 'width'
+         * 6. 'right' is 'auto', 'left' and 'width' are not 'auto', then solve
+         *    for 'right'
+         *
+         * Calculation of the shrink-to-fit width is similar to calculating the
+         * width of a table cell using the automatic table layout algorithm.
+         * Roughly: calculate the preferred width by formatting the content
+         * without breaking lines other than where explicit line breaks occur,
+         * and also calculate the preferred minimum width, e.g., by trying all
+         * possible line breaks. CSS 2.1 does not define the exact algorithm.
+         * Thirdly, calculate the available width: this is found by solving
+         * for 'width' after setting 'left' (in case 1) or 'right' (in case 3)
+         * to 0.
+         *
+         * Then the shrink-to-fit width is:
+         * kMin(kMax(preferred minimum width, available width), preferred width).
+        \*--------------------------------------------------------------------*/
+        // NOTE: For rules 3 and 6 it is not necessary to solve for 'right'
+        // because the value is not used for any further calculations.
 
-        // auto margins are ignored
-        if (ml==AUTO) ml = 0;
-        if (mr==AUTO) mr = 0;
+        // Calculate margins, 'auto' margins are ignored.
+        marginLeftValue = marginLeft.minWidth(containerWidth);
+        marginRightValue = marginRight.minWidth(containerWidth);
 
-        //1. solve left & width.
-        if (l==AUTO && w==AUTO && r!=AUTO) {
-            w = kMin(kMax(m_minWidth - pab, cw - (r + ml + mr + pab)), m_maxWidth - pab);
-            l = cw - ( r + w + ml + mr + pab);
-        }
-        else
-        //2. solve left & right. use static positioning.
-        if (l==AUTO && w!=AUTO && r==AUTO) {
-            if (style()->direction()==RTL) {
-                r = static_distance;
-                l = cw - ( r + w + ml + mr + pab);
-            }
-            else {
-                l = static_distance;
-                r = cw - ( l + w + ml + mr + pab);
-            }
-        }
-        else
-        //3. solve width & right.
-        if (l!=AUTO && w==AUTO && r==AUTO) {
-            w = kMin(kMax(m_minWidth - pab, cw - (l + ml + mr + pab)), m_maxWidth - pab);
-            r = cw - ( l + w + ml + mr + pab);
-        }
-        else
+        const int availableSpace = containerWidth - (marginLeftValue + marginRightValue + bordersPlusPadding);
 
-        //4. solve left
-        if (l==AUTO && w!=AUTO && r!=AUTO)
-            l = cw - ( r + w + ml + mr + pab);
-        else
+        // FIXME: Is there a faster way to find the correct case?
+        // Use rule/case that applies.
+        if (leftIsAuto && widthIsAuto && !rightIsAuto) {
+            // RULE 1: (use shrink-to-fit for width, and solve of left)
+            int rightValue = right.width(containerWidth);
 
-        //5. solve width
-        if (l!=AUTO && w==AUTO && r!=AUTO)
-            w = cw - ( r + l + ml + mr + pab);
-        else
+            // FIXME: would it be better to have shrink-to-fit in one step?
+            int preferredWidth = m_maxWidth - bordersPlusPadding;
+            int preferredMinWidth = m_minWidth - bordersPlusPadding;
+            int availableWidth = availableSpace - rightValue;
+            widthValue = kMin(kMax(preferredMinWidth, availableWidth), preferredWidth);
+            leftValue = availableSpace - (widthValue + rightValue);
+        } else if (!leftIsAuto && widthIsAuto && rightIsAuto) {
+            // RULE 3: (use shrink-to-fit for width, and no need solve of right)
+            leftValue = left.width(containerWidth);
 
-        //6. solve right
-        if (l!=AUTO && w!=AUTO && r==AUTO)
-            r = cw - ( l + w + ml + mr + pab);
+            // FIXME: would it be better to have shrink-to-fit in one step?
+            int preferredWidth = m_maxWidth - bordersPlusPadding;
+            int preferredMinWidth = m_minWidth - bordersPlusPadding;
+            int availableWidth = availableSpace - leftValue;
+            widthValue = kMin(kMax(preferredMinWidth, availableWidth), preferredWidth);
+        } else if (leftIsAuto && !width.isVariable() && !rightIsAuto) {
+            // RULE 4: (solve for left)
+            widthValue = calcContentWidth(width.width(containerWidth));
+            leftValue = availableSpace - (widthValue + right.width(containerWidth));
+        } else if (!leftIsAuto && widthIsAuto && !rightIsAuto) {
+            // RULE 5: (solve for width)
+            leftValue = left.width(containerWidth);
+            widthValue = availableSpace - (leftValue + right.width(containerWidth));
+        } else if (!leftIsAuto&& !widthIsAuto && rightIsAuto) {
+            // RULE 6: (no need solve for right)
+            leftValue = left.width(containerWidth);
+            widthValue = calcContentWidth(width.width(containerWidth));
+        }
     }
 
-    w += pab;
-    x = l + ml + cb->borderLeft();
+    // Use computed values to calculate the horizontal position.
+    xPos = leftValue + marginLeftValue + containerBlock->borderLeft();
 }
 
 
 void RenderBox::calcAbsoluteVertical()
 {
-    // css2 spec 10.6.4 & 10.6.5
+    if (isReplaced()) {
+        calcAbsoluteVerticalReplaced();
+        return;
+    }
 
-    // based on
-    // http://www.w3.org/Style/css2-updates/REC-CSS2-19980512-errata
-    // (actually updated 2000-10-24)
-    // that introduces static-position value for top, left & right
+    // The following is based off of the W3C Working Draft from April 11, 2006 of
+    // CSS 2.1: Section 10.6.4 "Absolutely positioned, non-replaced elements"
+    // <http://www.w3.org/TR/2005/WD-CSS21-20050613/visudet.html#abs-non-replaced-height>
+    // (block-style-comments in this function and in calcAbsoluteVerticalValues()
+    // correspond to text from the spec)
 
-    const int AUTO = -666666;
-    int t, b, ch;
 
-    t = b = AUTO;
+    // We don't use containingBlock(), since we may be positioned by an enclosing relpositioned inline.
+    const RenderObject* containerBlock = container();
 
-    int pab = (style()->boxSizing() == BORDER_BOX) ? 0 :
-        borderTop()+borderBottom()+paddingTop()+paddingBottom();
+    // Even in strict mode (where we don't grow the root to fill the viewport) other browsers
+    // position as though the root fills the viewport.
+    const int containerHeight = containerBlock->isRoot() ? containerBlock->availableHeight() : (containerBlock->height() - containerBlock->borderTop() - containerBlock->borderBottom());
 
-    RenderObject* cb = container();
+    const int bordersPlusPadding = borderTop() + borderBottom() + paddingTop() + paddingBottom();
+    const Length marginTop = style()->marginTop();
+    const Length marginBottom = style()->marginBottom();
+    Length top = style()->top();
+    Length bottom = style()->bottom();
 
-    Length hl = cb->style()->height();
-    if (hl.isFixed()) {
-        if (cb->style()->boxSizing() == BORDER_BOX)
-            ch = kMax(0, hl.value() - cb->borderTop() - cb->borderBottom());
-        else
-            ch = hl.value() + cb->paddingTop() + cb->paddingBottom();
+    /*---------------------------------------------------------------------------*\
+     * For the purposes of this section and the next, the term "static position"
+     * (of an element) refers, roughly, to the position an element would have had
+     * in the normal flow. More precisely, the static position for 'top' is the
+     * distance from the top edge of the containing block to the top margin edge
+     * of a hypothetical box that would have been the first box of the element if
+     * its 'position' property had been 'static' and 'float' had been 'none'. The
+     * value is negative if the hypothetical box is above the containing block.
+     *
+     * But rather than actually calculating the dimensions of that hypothetical
+     * box, user agents are free to make a guess at its probable position.
+     *
+     * For the purposes of calculating the static position, the containing block
+     * of fixed positioned elements is the initial containing block instead of
+     * the viewport.
+    \*---------------------------------------------------------------------------*/
+
+    // see FIXME 2
+    // Calculate the static distance if needed.
+    if (top.isVariable() && bottom.isVariable()) {
+        // m_staticY should already have been set through layout of the parent()
+        int staticTop = m_staticY - containerBlock->borderTop();
+        for (RenderObject* po = parent(); po && po != containerBlock; po = po->parent()) {
+            if (!po->isTableRow())
+                staticTop += po->yPos();
+        }
+        top.setValue(Fixed, staticTop);
     }
-    else if (cb->isCanvas() || cb->isRoot())
-        ch = cb->availableHeight();
-    else
-        ch = cb->height() - cb->borderTop() - cb->borderBottom();
 
 
-    if(!style()->top().isVariable())
-        t = style()->top().width(ch);
-    if(!style()->bottom().isVariable())
-        b = style()->bottom().width(ch);
+    int height; // Needed to compute overflow.
 
-    int h, mt, mb, y;
-    calcAbsoluteVerticalValues(Height, cb, ch, pab, t, b, h, mt, mb, y);
+    // Calculate constraint equation values for 'height' case.
+    calcAbsoluteVerticalValues(style()->height(), containerBlock, containerHeight, bordersPlusPadding,
+                               top, bottom, marginTop, marginBottom,
+                               height, m_marginTop, m_marginBottom, m_y);
 
     // Avoid doing any work in the common case (where the values of min-height and max-height are their defaults).
-    int minH = h, minMT, minMB, minY;
-    calcAbsoluteVerticalValues(MinHeight, cb, ch, pab, t, b, minH, minMT, minMB, minY);
+    // see FIXME 3
 
-    int maxH = h, maxMT, maxMB, maxY;
-    if (style()->maxHeight().value() != UNDEFINED)
-        calcAbsoluteVerticalValues(MaxHeight, cb, ch, pab, t, b, maxH, maxMT, maxMB, maxY);
+    // Calculate constraint equation values for 'max-height' case.
+    if (style()->maxHeight().value() != UNDEFINED) {
+        int maxHeight;
+        short maxMarginTop;
+        short maxMarginBottom;
+        int maxYPos;
 
-    if (h > maxH) {
-        h = maxH;
-        mt = maxMT;
-        mb = maxMB;
-        y = maxY;
+        calcAbsoluteVerticalValues(style()->maxHeight(), containerBlock, containerHeight, bordersPlusPadding,
+                                   top, bottom, marginTop, marginBottom,
+                                   maxHeight, maxMarginTop, maxMarginBottom, maxYPos);
+
+        if (height > maxHeight) {
+            height = maxHeight;
+            m_marginTop = maxMarginTop;
+            m_marginBottom = maxMarginBottom;
+            m_y = maxYPos;
+        }
     }
 
-    if (h < minH) {
-        h = minH;
-        mt = minMT;
-        mb = minMB;
-        y = minY;
+    // Calculate constraint equation values for 'min-height' case.
+    if (style()->minHeight().value()) {
+        int minHeight;
+        short minMarginTop;
+        short minMarginBottom;
+        int minYPos;
+
+        calcAbsoluteVerticalValues(style()->minHeight(), containerBlock, containerHeight, bordersPlusPadding,
+                                   top, bottom, marginTop, marginBottom,
+                                   minHeight, minMarginTop, minMarginBottom, minYPos);
+
+        if (height < minHeight) {
+            height = minHeight;
+            m_marginTop = minMarginTop;
+            m_marginBottom = minMarginBottom;
+            m_y = minYPos;
+        }
     }
 
-#ifdef APPLE_CHANGES
-    // If our natural height exceeds the new height once we've set it, then we need to make sure to update
-    // overflow to track the spillout.
-    if (m_height > h)
-        setOverflowHeight(m_height);
-#endif
+    height += bordersPlusPadding;
 
-    // Set our final values.
-    m_height = h;
-    m_marginTop = mt;
-    m_marginBottom = mb;
-    m_y = y;
+    // If our natural/content height exceeds the new height once we've set it, then we
+    // need to make sure to update overflow to track the spillout.
+    if (m_height > height && isRenderBlock())
+        static_cast<RenderBlock*>(this)->setOverflowHeight(m_height);
+    // Set final height value.
+    m_height = height;
 }
 
-void RenderBox::calcAbsoluteVerticalValues(HeightType heightType, RenderObject* cb, int ch, int pab,
-                                           int t, int b, int& h, int& mt, int& mb, int& y)
+void RenderBox::calcAbsoluteVerticalValues(Length height, const RenderObject* containerBlock,
+                                           const int containerHeight, const int bordersPlusPadding,
+                                           const Length top, const Length bottom, const Length marginTop, const Length marginBottom,
+                                           int& heightValue, short& marginTopValue, short& marginBottomValue, int& yPos)
 {
-    const int AUTO = -666666;
-    h = mt = mb = AUTO;
+    // 'top' and 'bottom' cannot both be 'auto' because 'top would of been
+    // converted to the static position in calcAbsoluteVertical()
+    assert(!(top.isVariable() && bottom.isVariable()));
 
-    if (!style()->marginTop().isVariable())
-        mt = style()->marginTop().width(ch);
-    if (!style()->marginBottom().isVariable())
-        mb = style()->marginBottom().width(ch);
+    int contentHeight = m_height - bordersPlusPadding;
 
-    Length height;
-    if (heightType == Height)
-        height = style()->height();
-    else if (heightType == MinHeight)
-        height = style()->minHeight();
-    else
-        height = style()->maxHeight();
+    int topValue = 0;
 
-    int ourHeight = m_height;
+    bool heightIsAuto = height.isVariable();
+    bool topIsAuto = top.isVariable();
+    bool bottomIsAuto = bottom.isVariable();
 
-    if (isTable() && height.isVariable())
-         // Height is never unsolved for tables. "auto" means shrink to fit.  Use our
-         // height instead.
-        h = ourHeight - pab;
-    else if (!height.isVariable())
-    {
-        h = height.width(ch);
-        if (ourHeight - pab > h) {
+    if (isTable() && heightIsAuto) {
+         // Height is never unsolved for tables. "auto" means shrink to fit.
+         // Use our height instead.
+        heightValue = contentHeight;
+        heightIsAuto = false;
+    } else if (!heightIsAuto) {
+        heightValue = calcContentHeight(height.width(containerHeight));
+        if (contentHeight > heightValue) {
             if (!isTable())
-                ourHeight = h + pab;
+                contentHeight = heightValue;
             else
-                h = ourHeight - pab;
+                heightValue = contentHeight;
         }
     }
-    else if (isReplaced())
-        h = intrinsicHeight();
 
-    int static_top=0;
-    if (t==AUTO && b==AUTO)
-    {
-        // calc hypothetical location in the normal flow
-        // used for 1) top=static-position
-        //          2) top, bottom, height are all auto -> calc top -> 3.
-        //          3) precalc for case 2 below
-        static_top = m_staticY -cb->borderTop(); // Should already have been set through layout of the parent().
-        RenderObject* po = parent();
-        for (; po && po != cb; po = po->parent())
-            static_top += po->yPos();
 
-        if (h==AUTO)
-            t = static_top;
+    if (!topIsAuto && !heightIsAuto && !bottomIsAuto) {
+        /*-----------------------------------------------------------------------*\
+         * If none of the three are 'auto': If both 'margin-top' and 'margin-
+         * bottom' are 'auto', solve the equation under the extra constraint that
+         * the two margins get equal values. If one of 'margin-top' or 'margin-
+         * bottom' is 'auto', solve the equation for that value. If the values
+         * are over-constrained, ignore the value for 'bottom' and solve for that
+         * value.
+        \*-----------------------------------------------------------------------*/
+        // NOTE:  It is not necessary to solve for 'bottom' in the over constrained
+        // case because the value is not used for any further calculations.
+
+        topValue = top.width(containerHeight);
+
+        const int availableSpace = containerHeight - (topValue + heightValue + bottom.width(containerHeight) + bordersPlusPadding);
+
+        // Margins are now the only unknown
+        if (marginTop.isVariable() && marginBottom.isVariable()) {
+            // Both margins auto, solve for equality
+            // NOTE: This may result in negative values.
+            marginTopValue = availableSpace / 2; // split the diference
+            marginBottomValue = availableSpace - marginTopValue; // account for odd valued differences
+        } else if (marginTop.isVariable()) {
+            // Solve for top margin
+            marginBottomValue = marginBottom.width(containerHeight);
+            marginTopValue = availableSpace - marginBottomValue;
+        } else if (marginBottom.isVariable()) {
+            // Solve for bottom margin
+            marginTopValue = marginTop.width(containerHeight);
+            marginBottomValue = availableSpace - marginTopValue;
+        } else {
+            // Over-constrained, (no need solve for bottom)
+            marginTopValue = marginTop.width(containerHeight);
+            marginBottomValue = marginBottom.width(containerHeight);
+        }
+    } else {
+        /*--------------------------------------------------------------------*\
+         * Otherwise, set 'auto' values for 'margin-top' and 'margin-bottom'
+         * to 0, and pick the one of the following six rules that applies.
+         *
+         * 1. 'top' and 'height' are 'auto' and 'bottom' is not 'auto', then
+         *    the height is based on the content, and solve for 'top'.
+         *
+         *              OMIT RULE 2 AS IT SHOULD NEVER BE HIT
+         * ------------------------------------------------------------------
+         * 2. 'top' and 'bottom' are 'auto' and 'height' is not 'auto', then
+         *    set 'top' to the static position, and solve for 'bottom'.
+         * ------------------------------------------------------------------
+         *
+         * 3. 'height' and 'bottom' are 'auto' and 'top' is not 'auto', then
+         *    the height is based on the content, and solve for 'bottom'.
+         * 4. 'top' is 'auto', 'height' and 'bottom' are not 'auto', and
+         *    solve for 'top'.
+         * 5. 'height' is 'auto', 'top' and 'bottom' are not 'auto', and
+         *    solve for 'height'.
+         * 6. 'bottom' is 'auto', 'top' and 'height' are not 'auto', and
+         *    solve for 'bottom'.
+        \*--------------------------------------------------------------------*/
+        // NOTE: For rules 3 and 6 it is not necessary to solve for 'bottom'
+        // because the value is not used for any further calculations.
+
+        // Calculate margins, 'auto' margins are ignored.
+        marginTopValue = marginTop.minWidth(containerHeight);
+        marginBottomValue = marginBottom.minWidth(containerHeight);
+
+        const int availableSpace = containerHeight - (marginTopValue + marginBottomValue + bordersPlusPadding);
+
+        // Use rule/case that applies.
+        if (topIsAuto && heightIsAuto && !bottomIsAuto) {
+            // RULE 1: (height is content based, solve of top)
+            heightValue = contentHeight;
+            topValue = availableSpace - (heightValue + bottom.width(containerHeight));
+        }
+        else if (topIsAuto && !heightIsAuto && bottomIsAuto) {
+            // RULE 2: (shouldn't happen)
+        }
+        else if (!topIsAuto && heightIsAuto && bottomIsAuto) {
+            // RULE 3: (height is content based, no need solve of bottom)
+            heightValue = contentHeight;
+            topValue = top.width(containerHeight);
+        } else if (topIsAuto && !heightIsAuto && !bottomIsAuto) {
+            // RULE 4: (solve of top)
+            topValue = availableSpace - (heightValue + bottom.width(containerHeight));
+        } else if (!topIsAuto && heightIsAuto && !bottomIsAuto) {
+            // RULE 5: (solve of height)
+            topValue = top.width(containerHeight);
+            heightValue = kMax(0, availableSpace - (topValue + bottom.width(containerHeight)));
+        } else if (!topIsAuto && !heightIsAuto && bottomIsAuto) {
+            // RULE 6: (no need solve of bottom)
+            topValue = top.width(containerHeight);
+        }
     }
 
-    if (t!=AUTO && h!=AUTO && b!=AUTO)
-    {
-        // top, height, bottom all given, play with margins
-        int ot = h + t + b + pab;
+    // Use computed values to calculate the vertical position.
+    yPos = topValue + marginTopValue + containerBlock->borderTop();
+}
 
-        if (mt==AUTO && mb==AUTO)
-        {
-            // both margins auto, solve for equality
-            mt = (ch - ot)/2;
-            mb = ch - ot - mt;
+void RenderBox::calcAbsoluteHorizontalReplaced()
+{
+    // The following is based off of the W3C Working Draft from April 11, 2006 of
+    // CSS 2.1: Section 10.3.8 "Absolutly positioned, replaced elements"
+    // <http://www.w3.org/TR/2005/WD-CSS21-20050613/visudet.html#abs-replaced-width>
+    // (block-style-comments in this function correspond to text from the spec and
+    // the numbers correspond to numbers in spec)
+
+    // We don't use containingBlock(), since we may be positioned by an enclosing relpositioned inline.
+    const RenderObject* containerBlock = container();
+
+    // FIXME: This is incorrect for cases where the container block is a relatively
+    // positioned inline.
+    const int containerWidth = containingBlockWidth() + containerBlock->paddingLeft() + containerBlock->paddingRight();
+
+    // To match WinIE, in quirks mode use the parent's 'direction' property
+    // instead of the the container block's.
+    EDirection containerDirection = (style()->htmlHacks()) ? parent()->style()->direction() : containerBlock->style()->direction();
+
+    // Variables to solve.
+    Length left = style()->left();
+    Length right = style()->right();
+    Length marginLeft = style()->marginLeft();
+    Length marginRight = style()->marginRight();
+
+
+    /*-----------------------------------------------------------------------*\
+     * 1. The used value of 'width' is determined as for inline replaced
+     *    elements.
+    \*-----------------------------------------------------------------------*/
+    // NOTE: This value of width is FINAL in that the min/max width calculations
+    // are dealt with in calcReplacedWidth().  This means that the steps to produce
+    // correct max/min in the non-replaced version, are not necessary.
+    m_width = calcReplacedWidth() + borderLeft() + borderRight() + paddingLeft() + paddingRight();
+    const int availableSpace = containerWidth - m_width;
+
+    /*-----------------------------------------------------------------------*\
+     * 2. If both 'left' and 'right' have the value 'auto', then if 'direction'
+     *    of the containing block is 'ltr', set 'left' to the static position;
+     *    else if 'direction' is 'rtl', set 'right' to the static position.
+    \*-----------------------------------------------------------------------*/
+    // see FIXME 2
+    if (left.isVariable() && right.isVariable()) {
+        // see FIXME 1
+        if (containerDirection == LTR) {
+            // 'm_staticX' should already have been set through layout of the parent.
+            int staticPosition = m_staticX - containerBlock->borderLeft();
+            for (RenderObject* po = parent(); po && po != containerBlock; po = po->parent())
+                staticPosition += po->xPos();
+            left.setValue(Fixed, staticPosition);
+        } else {
+            RenderObject* po = parent();
+            // 'm_staticX' should already have been set through layout of the parent.
+            int staticPosition = m_staticX + containerWidth + containerBlock->borderRight() - po->width();
+            for (; po && po != containerBlock; po = po->parent())
+                staticPosition -= po->xPos();
+            right.setValue(Fixed, staticPosition);
         }
-        else if (mt==AUTO)
-            // solve for top margin
-            mt = ch - ot - mb;
-        else if (mb==AUTO)
-            // solve for bottom margin
-            mb = ch - ot - mt;
-        else
-            // overconstrained, solve for bottom
-            b = ch - ( h+t+mt+mb+pab);
     }
-    else
-    {
-        // one or two of (top, height, bottom) missing, solve
 
-        // auto margins are ignored
-        if (mt==AUTO) mt = 0;
-        if (mb==AUTO) mb = 0;
+    /*-----------------------------------------------------------------------*\
+     * 3. If 'left' or 'right' are 'auto', replace any 'auto' on 'margin-left'
+     *    or 'margin-right' with '0'.
+    \*-----------------------------------------------------------------------*/
+    if (left.isVariable() || right.isVariable()) {
+        if (marginLeft.isVariable())
+            marginLeft.setValue(Fixed, 0);
+        if (marginRight.isVariable())
+            marginRight.setValue(Fixed, 0);
+    }
 
-        //1. solve top & height. use content height.
-        if (t==AUTO && h==AUTO && b!=AUTO)
-        {
-            h = ourHeight - pab;
-            t = ch - ( h+b+mt+mb+pab);
+    /*-----------------------------------------------------------------------*\
+     * 4. If at this point both 'margin-left' and 'margin-right' are still
+     *    'auto', solve the equation under the extra constraint that the two
+     *    margins must get equal values, unless this would make them negative,
+     *    in which case when the direction of the containing block is 'ltr'
+     *    ('rtl'), set 'margin-left' ('margin-right') to zero and solve for
+     *    'margin-right' ('margin-left').
+    \*-----------------------------------------------------------------------*/
+    int leftValue = 0;
+    int rightValue = 0;
+
+    if (marginLeft.isVariable() && marginRight.isVariable()) {
+        // 'left' and 'right' cannot be 'auto' due to step 3
+        assert(!(left.isVariable() && right.isVariable()));
+
+        leftValue = left.width(containerWidth);
+        rightValue = right.width(containerWidth);
+
+        int difference = availableSpace - (leftValue + rightValue);
+        if (difference > 0) {
+            m_marginLeft = difference / 2; // split the diference
+            m_marginRight = difference - m_marginLeft; // account for odd valued differences
+        } else {
+            // see FIXME 1
+            if (containerDirection == LTR) {
+                m_marginLeft = 0;
+                m_marginRight = difference;  // will be negative
+            } else {
+                m_marginLeft = difference;  // will be negative
+                m_marginRight = 0;
+            }
         }
-        else
 
-        //2. solve top & bottom. use static positioning.
-        if (t==AUTO && h!=AUTO && b==AUTO)
-        {
-            t = static_top;
-            b = ch - ( h+t+mt+mb+pab);
+    /*-----------------------------------------------------------------------*\
+     * 5. If at this point there is an 'auto' left, solve the equation for
+     *    that value.
+    \*-----------------------------------------------------------------------*/
+    } else if (left.isVariable()) {
+        m_marginLeft = marginLeft.width(containerWidth);
+        m_marginRight = marginRight.width(containerWidth);
+        rightValue = right.width(containerWidth);
+
+        // Solve for 'left'
+        leftValue = availableSpace - (rightValue + m_marginLeft + m_marginRight);
+    } else if (right.isVariable()) {
+        m_marginLeft = marginLeft.width(containerWidth);
+        m_marginRight = marginRight.width(containerWidth);
+        leftValue = left.width(containerWidth);
+
+        // Solve for 'right'
+        rightValue = availableSpace - (leftValue + m_marginLeft + m_marginRight);
+    } else if (marginLeft.isVariable()) {
+        m_marginRight = marginRight.width(containerWidth);
+        leftValue = left.width(containerWidth);
+        rightValue = right.width(containerWidth);
+
+        // Solve for 'margin-left'
+        m_marginLeft = availableSpace - (leftValue + rightValue + m_marginRight);
+    } else if (marginRight.isVariable()) {
+        m_marginLeft = marginLeft.width(containerWidth);
+        leftValue = left.width(containerWidth);
+        rightValue = right.width(containerWidth);
+
+        // Solve for 'margin-right'
+        m_marginRight = availableSpace - (leftValue + rightValue + m_marginLeft);
+    }
+
+    /*-----------------------------------------------------------------------*\
+     * 6. If at this point the values are over-constrained, ignore the value
+     *    for either 'left' (in case the 'direction' property of the
+     *    containing block is 'rtl') or 'right' (in case 'direction' is
+     *    'ltr') and solve for that value.
+    \*-----------------------------------------------------------------------*/
+    else  {
+        m_marginLeft = marginLeft.width(containerWidth);
+        m_marginRight = marginRight.width(containerWidth);
+        if (containerDirection  == LTR) {
+            leftValue = left.width(containerWidth);
+            rightValue = availableSpace - (leftValue + m_marginLeft + m_marginRight);
         }
-        else
+        else {
+            rightValue = right.width(containerWidth);
+            leftValue = availableSpace - (rightValue + m_marginLeft + m_marginRight);
+        }
+    }
 
-        //3. solve height & bottom. use content height.
-        if (t!=AUTO && h==AUTO && b==AUTO)
-        {
-            h = ourHeight - pab;
-            b = ch - ( h+t+mt+mb+pab);
+    int totalWidth = m_width + leftValue + rightValue +  m_marginLeft + m_marginRight;
+    if (totalWidth > containerWidth && (containerDirection == RTL))
+        leftValue = containerWidth - (totalWidth - leftValue);
+
+    // Use computed values to calculate the horizontal position.
+    m_x = leftValue + m_marginLeft + containerBlock->borderLeft();
+}
+
+void RenderBox::calcAbsoluteVerticalReplaced()
+{
+    // The following is based off of the W3C Working Draft from April 11, 2006 of
+    // CSS 2.1: Section 10.6.5 "Absolutly positioned, replaced elements"
+    // <http://www.w3.org/TR/2005/WD-CSS21-20050613/visudet.html#abs-replaced-height>
+    // (block-style-comments in this function correspond to text from the spec and
+    // the numbers correspond to numbers in spec)
+
+    // We don't use containingBlock(), since we may be positioned by an enclosing relpositioned inline.
+    const RenderObject* containerBlock = container();
+
+    // Even in strict mode (where we don't grow the root to fill the viewport)
+    // other browsers position as though the root fills the viewport.
+    const int containerHeight = containerBlock->isRoot() ? containerBlock->availableHeight() : (containerBlock->height() - containerBlock->borderTop() - containerBlock->borderBottom());
+
+    // Variables to solve.
+    Length top = style()->top();
+    Length bottom = style()->bottom();
+    Length marginTop = style()->marginTop();
+    Length marginBottom = style()->marginBottom();
+
+
+    /*-----------------------------------------------------------------------*\
+     * 1. The used value of 'height' is determined as for inline replaced
+     *    elements.
+    \*-----------------------------------------------------------------------*/
+    // NOTE: This value of height is FINAL in that the min/max height calculations
+    // are dealt with in calcReplacedHeight().  This means that the steps to produce
+    // correct max/min in the non-replaced version, are not necessary.
+    m_height = calcReplacedHeight() + borderTop() + borderBottom() + paddingTop() + paddingBottom();
+    const int availableSpace = containerHeight - m_height;
+
+    /*-----------------------------------------------------------------------*\
+     * 2. If both 'top' and 'bottom' have the value 'auto', replace 'top'
+     *    with the element's static position.
+    \*-----------------------------------------------------------------------*/
+    // see FIXME 2
+    if (top.isVariable() && bottom.isVariable()) {
+        // m_staticY should already have been set through layout of the parent().
+        int staticTop = m_staticY - containerBlock->borderTop();
+        for (RenderObject* po = parent(); po && po != containerBlock; po = po->parent()) {
+            if (!po->isTableRow())
+                staticTop += po->yPos();
         }
-        else
+        top.setValue(Fixed, staticTop);
+    }
 
-        //4. solve top
-        if (t==AUTO && h!=AUTO && b!=AUTO)
-            t = ch - ( h+b+mt+mb+pab);
-        else
+    /*-----------------------------------------------------------------------*\
+     * 3. If 'bottom' is 'auto', replace any 'auto' on 'margin-top' or
+     *    'margin-bottom' with '0'.
+    \*-----------------------------------------------------------------------*/
+    // FIXME: The spec. says that this step should only be taken when bottom is
+    // auto, but if only top is auto, this makes step 4 impossible.
+    if (top.isVariable() || bottom.isVariable()) {
+        if (marginTop.isVariable())
+            marginTop.setValue(Fixed, 0);
+        if (marginBottom.isVariable())
+            marginBottom.setValue(Fixed, 0);
+    }
 
-        //5. solve height
-        if (t!=AUTO && h==AUTO && b!=AUTO)
-            h = ch - ( t+b+mt+mb+pab);
-        else
+    /*-----------------------------------------------------------------------*\
+     * 4. If at this point both 'margin-top' and 'margin-bottom' are still
+     *    'auto', solve the equation under the extra constraint that the two
+     *    margins must get equal values.
+    \*-----------------------------------------------------------------------*/
+    int topValue = 0;
+    int bottomValue = 0;
 
-        //6. solve bottom
-        if (t!=AUTO && h!=AUTO && b==AUTO)
-            b = ch - ( h+t+mt+mb+pab);
+    if (marginTop.isVariable() && marginBottom.isVariable()) {
+        // 'top' and 'bottom' cannot be 'auto' due to step 2 and 3 combinded.
+        assert(!(top.isVariable() || bottom.isVariable()));
+
+        topValue = top.width(containerHeight);
+        bottomValue = bottom.width(containerHeight);
+
+        int difference = availableSpace - (topValue + bottomValue);
+        // NOTE: This may result in negative values.
+        m_marginTop =  difference / 2; // split the difference
+        m_marginBottom = difference - m_marginTop; // account for odd valued differences
+
+    /*-----------------------------------------------------------------------*\
+     * 5. If at this point there is only one 'auto' left, solve the equation
+     *    for that value.
+    \*-----------------------------------------------------------------------*/
+    } else if (top.isVariable()) {
+        m_marginTop = marginTop.width(containerHeight);
+        m_marginBottom = marginBottom.width(containerHeight);
+        bottomValue = bottom.width(containerHeight);
+
+        // Solve for 'top'
+        topValue = availableSpace - (bottomValue + m_marginTop + m_marginBottom);
+    } else if (bottom.isVariable()) {
+        m_marginTop = marginTop.width(containerHeight);
+        m_marginBottom = marginBottom.width(containerHeight);
+        topValue = top.width(containerHeight);
+
+        // Solve for 'bottom'
+        // NOTE: It is not necessary to solve for 'bottom' because we don't ever
+        // use the value.
+    } else if (marginTop.isVariable()) {
+        m_marginBottom = marginBottom.width(containerHeight);
+        topValue = top.width(containerHeight);
+        bottomValue = bottom.width(containerHeight);
+
+        // Solve for 'margin-top'
+        m_marginTop = availableSpace - (topValue + bottomValue + m_marginBottom);
+    } else if (marginBottom.isVariable()) {
+        m_marginTop = marginTop.width(containerHeight);
+        topValue = top.width(containerHeight);
+        bottomValue = bottom.width(containerHeight);
+
+        // Solve for 'margin-bottom'
+        m_marginBottom = availableSpace - (topValue + bottomValue + m_marginTop);
     }
 
-    if (ourHeight < h + pab) //content must still fit
-        ourHeight = h + pab;
+    /*-----------------------------------------------------------------------*\
+     * 6. If at this point the values are over-constrained, ignore the value
+     *    for 'bottom' and solve for that value.
+    \*-----------------------------------------------------------------------*/
+    else {
+        m_marginTop = marginTop.width(containerHeight);
+        m_marginBottom = marginBottom.width(containerHeight);
+        topValue = top.width(containerHeight);
 
-    if (hasOverflowClip() && ourHeight > h + pab)
-        ourHeight = h + pab;
+        // Solve for 'bottom'
+        // NOTE: It is not necessary to solve for 'bottom' because we don't ever
+        // use the value.
+    }
 
-     // Do not allow the height to be negative.  This can happen when someone specifies both top and bottom
-     // but the containing block height is less than top, e.g., top:20px, bottom:0, containing block height 16.
-    ourHeight = kMax(0, ourHeight);
-
-    h = ourHeight;
-    y = t + mt + cb->borderTop();
+    // Use computed values to calculate the vertical position.
+    m_y = topValue + m_marginTop + containerBlock->borderTop();
 }
 
 
Index: khtml/rendering/render_block.cpp
===================================================================
--- khtml/rendering/render_block.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/rendering/render_block.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -4,7 +4,7 @@
  * Copyright (C) 1999-2003 Lars Knoll (knoll@kde.org)
  *           (C) 1999-2003 Antti Koivisto (koivisto@kde.org)
  *           (C) 2002-2003 Dirk Mueller (mueller@kde.org)
- *           (C) 2003 Apple Computer, Inc.
+ *           (C) 2003,2005 Apple Computer, Inc.
  *           (C) 2004 Germain Garand (germain@ebooksfrance.org)
  *           (C) 2005 Allan Sandfeld Jensen (kde@carewolf.com)
  *           (C) 2006 Charles Samuels (charles@kde.org)
@@ -97,9 +97,8 @@
     m_clearStatus = CNONE;
     m_maxTopPosMargin = m_maxTopNegMargin = m_maxBottomPosMargin = m_maxBottomNegMargin = 0;
     m_topMarginQuirk = m_bottomMarginQuirk = false;
-    m_overflowHeight = 0;
-    m_overflowWidth = 0;
-    m_negativeOverflowWidth = 0;
+    m_overflowHeight = m_overflowWidth = 0;
+    m_overflowLeft = m_overflowTop = 0;
 }
 
 RenderBlock::~RenderBlock()
@@ -129,15 +128,29 @@
         child = child->nextSibling();
     }
 
-    // Update pseudos for :before and :after now.
-    updatePseudoChildren();
+    if (attached()) {
+        // Update generated content and ::inside
+        updateReplacedContent();
+        // Update pseudos for :before and :after
+        updatePseudoChildren();
+    }
 
     // handled by close() during parsing
+    // ### remove close move upto updatePseudo
     if (!document()->parsing()) {
         updateFirstLetter();
     }
 }
 
+// Attach handles initial setStyle that requires parent nodes
+void RenderBlock::attach()
+{
+    RenderFlow::attach();
+
+    updateReplacedContent();
+    updatePseudoChildren();
+}
+
 void RenderBlock::updateFirstLetter()
 {
     // Only blocks with inline-children can generate a first-letter
@@ -146,7 +159,7 @@
     // Don't recurse
     if (style()->styleType() == RenderStyle::FIRST_LETTER) return;
 
-    // The first-letter style is inheritable. 
+    // The first-letter style is inheritable.
     RenderStyle *pseudoStyle = style()->getPseudoStyle(RenderStyle::FIRST_LETTER);
     RenderObject *o = this;
     while (o && !pseudoStyle) {
@@ -221,7 +234,7 @@
                 length++;
             // we need to generated a remainingText object even if no text is left
             // because it holds the place and style for the old textObj
-            RenderTextFragment* remainingText = 
+            RenderTextFragment* remainingText =
                 new (renderArena()) RenderTextFragment(textObj->node(), oldText, length, oldText->l-length);
             remainingText->setIsAnonymous( textObj->isAnonymous() );
             remainingText->setStyle(textObj->style());
@@ -617,15 +630,13 @@
 
     calcWidth();
     m_overflowWidth = m_width;
-    m_negativeOverflowWidth = 0;
+    m_overflowLeft = 0;
     if (style()->direction() == LTR )
     {
         int cw=0;
         if (style()->textIndent().isPercent())
             cw = containingBlock()->contentWidth();
-        m_negativeOverflowWidth = -style()->textIndent().minWidth(cw);
-        if (m_negativeOverflowWidth < 0)
-            m_negativeOverflowWidth = 0;
+        m_overflowLeft = kMin(0, style()->textIndent().minWidth(cw));
     }
 
     if ( oldWidth != m_width )
@@ -1207,7 +1218,7 @@
         // change (because it has more available line width).
         // So go ahead and mark the item as dirty.
         child->setChildNeedsLayout(true);
-    if (child->hasFloats())
+    if (!child->flowAroundFloats() && child->hasFloats())
         child->markAllDescendantsWithFloatsForLayout();
     if (child->containsPageBreak())
         child->setNeedsLayout(true);
@@ -1366,8 +1377,11 @@
         // make sure we relayout children if we need it.
         if (!child->isPositioned() && (relayoutChildren ||
              (child->isReplaced() && (child->style()->width().isPercent() || child->style()->height().isPercent())) ||
-             (child->isRenderBlock() && child->style()->height().isPercent())))
+             (child->isRenderBlock() && child->style()->height().isPercent()) ||
+             (child->isBody() && child->style()->htmlHacks())))
+        {
             child->setChildNeedsLayout(true);
+        }
 
         // Handle the four types of special elements first.  These include positioned content, floating content, compacts and
         // run-ins.  When we encounter these four types of objects, we don't actually lay them out as normal flow blocks.
@@ -1439,31 +1453,18 @@
         }
 
         // See if this child has made our overflow need to grow.
-        // ### --dwh Work with left overflow as well as right overflow.
-        int overflowDelta = - child->height() ;
-        if ( child->isBlockFlow () && !child->isTable() && child->style()->hidesOverflow() )
-            overflowDelta += child->height();
-        else
-            overflowDelta += child->overflowHeight();
-
-        // See if this child has made our overflow need to grow.
-        int rightChildPos = child->effectiveXPos() + kMax(child->effectiveWidth(), (int)child->width());
+        int effX = child->effectiveXPos();
+        int effY = child->effectiveYPos();
         if (child->isRelPositioned() && (hasOverflowClip() || !isTableCell())) {
             // CSS 2.1-9.4.3 - allow access to relatively positioned content
-            // ### left overflow support
-            int xoff = 0, yoff = 0;
-            static_cast<RenderBox*>(child)->relativePositionOffset(xoff, yoff);
-            if (xoff>0)
-               rightChildPos += xoff;
-            if (yoff>0)
-               overflowDelta += yoff;
+            static_cast<RenderBox*>(child)->relativePositionOffset(effX, effY);
         }
+        m_overflowWidth = kMax(effX + child->effectiveWidth(), m_overflowWidth);
+        m_overflowLeft = kMin(effX, m_overflowLeft);
 
-        m_overflowHeight = kMax(m_height + overflowDelta, m_overflowHeight);
-        m_overflowWidth = kMax(rightChildPos, m_overflowWidth);
+        m_overflowHeight = kMax(effY + child->effectiveHeight(), m_overflowHeight);
+        m_overflowTop = kMin(effY, m_overflowTop);
 
-        m_negativeOverflowWidth = kMax(m_negativeOverflowWidth, child->negativeOverflowWidth());
-
         // Insert our compact into the block margin if we have one.
         insertCompactIfNeeded(child, compactInfo);
 
@@ -1589,14 +1590,13 @@
                 r->dirtyFormattingContext(false);
             }
             r->layoutIfNeeded();
+
+            // Update overflow
             if (adjOverflow && r->style()->position() == ABSOLUTE) {
-                if (r->effectiveXPos() + r->effectiveWidth() > m_overflowWidth)
-                {
-                    m_overflowWidth = r->xPos() + r->overflowWidth();
-                    m_negativeOverflowWidth = r->negativeOverflowWidth();
-                }
-                if (r->yPos() + r->effectiveHeight() > m_overflowHeight)
-                    m_overflowHeight = r->yPos() + r->effectiveHeight();
+                m_overflowWidth = kMax(r->xPos() + r->overflowWidth(), m_overflowWidth);
+                m_overflowLeft = kMin(r->effectiveXPos(), m_overflowLeft);
+                m_overflowHeight = kMax(r->yPos() + r->overflowHeight(), m_overflowHeight);
+                m_overflowTop = kMin(r->effectiveYPos(), m_overflowTop);
             }
         }
     }
@@ -1615,11 +1615,7 @@
         if (m_floatingObjects && floatBottom() > h)
             h = floatBottom();
 
-        // Sanity check the first line
-        // to see if it extended a little above our box. Overflow out the bottom is already handled via
-        // overflowHeight(), so we don't need to check that.
-        if (m_firstLineBox && m_firstLineBox->topOverflow() < 0)
-            yPos += m_firstLineBox->topOverflow();
+        yPos += overflowTop();
 
         int os = 2*maximalOutlineSize(pI.phase);
         if( (yPos > pI.r.bottom() + os) || (_ty + h <= pI.r.y() - os))
@@ -1876,6 +1872,12 @@
         int lo = leftOffset(); // Constant part of left offset.
         int fwidth = f->width; // The width we look for.
                                //kdDebug( 6040 ) << " Object width: " << fwidth << " available width: " << ro - lo << endl;
+
+        // in quirk mode, floated auto-width tables try to fit within remaining linewidth
+        bool ftQuirk = o->isTable() && style()->htmlHacks() && o->style()->width().isVariable();
+        if (ftQuirk)
+            fwidth = kMin( o->minWidth()+o->marginLeft()+o->marginRight(), fwidth );
+
         if (ro - lo < fwidth)
             fwidth = ro - lo; // Never look for more than what will be available.
 
@@ -1898,6 +1900,13 @@
                     fx = leftRelOffset(y,lo, false, &heightRemainingLeft);
                 }
             }
+            if (ftQuirk && (rightRelOffset(y,ro, false)-fx < f->width)) {
+                o->setPos( o->xPos(), y + o->marginTop() );
+                o->setChildNeedsLayout(true, false);
+                o->layoutIfNeeded();
+                _height = o->height() + o->marginTop() + o->marginBottom();
+                f->width = o->width() + o->marginLeft() + o->marginRight();
+            }
             if (fx<0) fx=0;
             f->left = fx;
             //kdDebug( 6040 ) << "positioning left aligned float at (" << fx + o->marginLeft()  << "/" << y + o->marginTop() << ") fx=" << fx << endl;
@@ -1916,6 +1925,13 @@
                     fx = rightRelOffset(y,ro, false, &heightRemainingRight);
                 }
             }
+            if (ftQuirk && (fx - leftRelOffset(y,lo, false) < f->width)) {
+                o->setPos( o->xPos(), y + o->marginTop() );
+                o->setChildNeedsLayout(true, false);
+                o->layoutIfNeeded();
+                _height = o->height() + o->marginTop() + o->marginBottom();
+                f->width = o->width() + o->marginLeft() + o->marginRight();
+            }
             if (fx<f->width) fx=f->width;
             f->left = fx - f->width;
             //kdDebug( 6040 ) << "positioning right aligned float at (" << fx - o->marginRight() - o->width() << "/" << y + o->marginTop() << ")" << endl;
@@ -2183,7 +2199,8 @@
     if (!includeOverflowInterior && style()->hidesOverflow())
         return left;
 
-    // FIXME: Check left overflow when we eventually support it.
+    if (includeSelf && m_overflowLeft < left)
+        left = m_overflowLeft;
 
     if (m_floatingObjects) {
         FloatingObject* r;
@@ -2403,7 +2420,8 @@
 
 void RenderBlock::markAllDescendantsWithFloatsForLayout(RenderObject* floatToRemove)
 {
-    setNeedsLayout(true);
+    dirtyFormattingContext(false);
+    setChildNeedsLayout(true);
 
     if (floatToRemove)
         removeFloatingObject(floatToRemove);
@@ -2412,7 +2430,7 @@
     if (!childrenInline()) {
         for (RenderObject* child = firstChild(); child; child = child->nextSibling()) {
             if (isBlockFlow() && !child->isFloatingOrPositioned() &&
-                (floatToRemove ? child->containsFloat(floatToRemove) : child->hasFloats()))
+                ((floatToRemove ? child->containsFloat(floatToRemove) : child->hasFloats()) || child->usesLineWidth()))
                 child->markAllDescendantsWithFloatsForLayout(floatToRemove);
         }
     }
@@ -2540,12 +2558,12 @@
             m_minWidth = 0;
     }
 
-     if (style()->width().isFixed() && style()->width().value() > 0) {
-        if (isTableCell())
-            m_maxWidth = kMax(m_minWidth, (short)calcContentWidth(style()->width().value()));
-        else
-            m_minWidth = m_maxWidth = calcContentWidth(style()->width().value());
-    }
+    if (isTableCell()) {
+        Length w = static_cast<RenderTableCell*>(this)->styleOrColWidth();
+        if (w.isFixed() && w.value() > 0)
+            m_maxWidth = kMax((int)m_minWidth, calcContentWidth(w.value()));
+    } else if (style()->width().isFixed() && style()->width().value() > 0)
+        m_minWidth = m_maxWidth = calcContentWidth(style()->width().value());
 
     if (style()->minWidth().isFixed() && style()->minWidth().value() > 0) {
         m_maxWidth = kMax(m_maxWidth, (int)calcContentWidth(style()->minWidth().value()));
@@ -2687,6 +2705,7 @@
     int inlineMin=0;
 
     int cw = containingBlock()->contentWidth();
+    int floatMaxWidth = 0;
 
     // If we are at the start of a line, we want to ignore all white-space.
     // Also strip spaces if we previously had text that ended in a trailing space.
@@ -2791,12 +2810,15 @@
                 // go ahead and terminate maxwidth as well.
                 if (child->isFloating()) {
                     if (prevFloat &&
-                        (((prevFloat->style()->floating() & FLEFT) && (child->style()->clear() & CLEFT)) ||
+                        ((inlineMax + childMax > floatMaxWidth) ||
+                         ((prevFloat->style()->floating() & FLEFT) && (child->style()->clear() & CLEFT)) ||
                          ((prevFloat->style()->floating() & FRIGHT) && (child->style()->clear() & CRIGHT)))) {
                         m_maxWidth = kMax(inlineMax, (int)m_maxWidth);
                         inlineMax = 0;
                     }
                     prevFloat = child;
+                    if (!floatMaxWidth)
+                        floatMaxWidth = availableWidth();
                 }
 
                 // Add in text-indent.  This is added in only once.
@@ -2938,6 +2960,8 @@
     RenderObject *child = firstChild();
     RenderObject* prevFloat = 0;
     int floatWidths = 0;
+    int floatMaxWidth = 0;
+
     while(child != 0)
     {
         // positioned children don't affect the minmaxwidth
@@ -2991,9 +3015,13 @@
 
         if(m_maxWidth < w) m_maxWidth = w;
 
-        if (child->isFloating())
-            floatWidths += w;
-        else if (m_maxWidth < w)
+        if (child->isFloating()) {
+            if (prevFloat && (floatWidths + w > floatMaxWidth)) {
+               m_maxWidth = kMax(floatWidths, m_maxWidth);
+               floatWidths = w;
+            } else
+               floatWidths += w;
+        } else if (m_maxWidth < w)
             m_maxWidth = w;
 
         // A very specific WinIE quirk.
@@ -3017,8 +3045,11 @@
             if (!cb->isTableCell())
                 m_maxWidth = BLOCK_MAX_WIDTH;
         }
-        if (child->isFloating())
+        if (child->isFloating()) {
             prevFloat = child;
+            if (!floatMaxWidth)
+                floatMaxWidth = availableWidth();
+        }
         child = child->nextSibling();
     }
     m_maxWidth = kMax(floatWidths, m_maxWidth);
Index: khtml/rendering/render_generated.cpp
===================================================================
--- khtml/rendering/render_generated.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/rendering/render_generated.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -79,7 +79,7 @@
     {
     case LNONE:
         break;
-// Glyphs:
+// Glyphs: (these values are not really used and instead handled by RenderGlyph)
     case LDISC:
         item = QChar(0x2022);
         break;
@@ -226,6 +226,8 @@
 
 }
 
+// -------------------------------------------------------------------------
+
 RenderQuote::RenderQuote(DOM::NodeImpl* node, EQuoteContent type)
     : RenderCounterBase(node), m_quoteType(type)
 {
@@ -274,3 +276,117 @@
             m_item = QString();
     }
 }
+
+// -------------------------------------------------------------------------
+
+RenderGlyph::RenderGlyph(DOM::NodeImpl* node, EListStyleType type)
+    : RenderBox(node), m_type(type)
+{
+    setInline(true);
+//     setReplaced(true);
+}
+
+void RenderGlyph::setStyle(RenderStyle *_style)
+{
+    RenderBox::setStyle(_style);
+
+    const QFontMetrics &fm = style()->fontMetrics();
+    QRect xSize= fm.boundingRect('x');
+    m_height = xSize.height();
+    m_width = xSize.width();;
+
+    switch(m_type) {
+    // Glyphs:
+        case LDISC:
+        case LCIRCLE:
+        case LSQUARE:
+        case LBOX:
+        case LDIAMOND:
+        case LNONE:
+            break;
+        default:
+            // not a glyph !
+            assert(false); 
+            break;
+    }
+}
+
+void RenderGlyph::calcMinMaxWidth() 
+{
+    m_minWidth = m_width;
+    m_maxWidth = m_width;
+
+    setMinMaxKnown();
+}
+
+short RenderGlyph::lineHeight(bool /*b*/) const
+{
+    return height();
+}
+
+short RenderGlyph::baselinePosition(bool /*b*/) const
+{
+    return height();
+}
+
+void RenderGlyph::paint(PaintInfo& paintInfo, int _tx, int _ty)
+{
+    if (paintInfo.phase != PaintActionForeground)
+        return;
+
+    if (style()->visibility() != VISIBLE)  return;
+
+    _tx += m_x;
+    _ty += m_y;
+
+    if((_ty > paintInfo.r.bottom()) || (_ty + m_height <= paintInfo.r.top()))
+        return;
+
+    QPainter* p = paintInfo.p;
+
+    const QColor color( style()->color() );
+    p->setPen( color );
+
+    int xHeight = m_height;
+    int bulletWidth = (xHeight+1)/2;
+    int yoff = (xHeight - 1)/4;
+    QRect marker(_tx, _ty + yoff, bulletWidth, bulletWidth);
+
+    switch(m_type) {
+    case LDISC:
+        p->setBrush( color );
+        p->drawEllipse( marker );
+        return;
+    case LCIRCLE:
+        p->setBrush( Qt::NoBrush );
+        p->drawEllipse( marker );
+        return;
+    case LSQUARE:
+        p->setBrush( color );
+        p->drawRect( marker );
+        return;
+    case LBOX:
+        p->setBrush( Qt::NoBrush );
+        p->drawRect( marker );
+        return;
+    case LDIAMOND: {
+        static QPointArray diamond(4);
+        int x = marker.x();
+        int y = marker.y();
+        int s = bulletWidth/2;
+        diamond[0] = QPoint(x+s,   y);
+        diamond[1] = QPoint(x+2*s, y+s);
+        diamond[2] = QPoint(x+s,   y+2*s);
+        diamond[3] = QPoint(x,     y+s);
+        p->setBrush( color );
+        p->drawConvexPolygon( diamond, 0, 4 );
+        return;
+    }
+    case LNONE:
+        return;
+    default:
+        // not a glyph
+        assert(false);
+    }
+}
+
Index: khtml/dom/html_document.h
===================================================================
--- khtml/dom/html_document.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/dom/html_document.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -178,6 +178,12 @@
     HTMLCollection layers() const;
 
     /**
+     * A collection of all the scripts in the document.
+     *
+     */
+    HTMLCollection scripts() const;
+
+    /**
      * A collection of all the anchor ( \c A ) elements in
      * a document with a value for the \c name attribute.
      * Note. For reasons of backwards compatibility, the returned set
Index: khtml/dom/css_value.h
===================================================================
--- khtml/dom/css_value.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/dom/css_value.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -414,7 +414,8 @@
         CSS_COUNTER = 23,
         CSS_RECT = 24,
         CSS_RGBCOLOR = 25,
-	CSS_HTML_RELATIVE = 255
+        CSS_PAIR = 100, // We envision this being exposed as a means of getting computed style values for pairs 
+        CSS_HTML_RELATIVE = 255
     };
 
     /**
Index: khtml/dom/html_document.cpp
===================================================================
--- khtml/dom/html_document.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/dom/html_document.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -1,7 +1,7 @@
 /**
  * This file is part of the DOM implementation for KDE.
  *
- * (C) 1999 Lars Knoll (knoll@kde.org)
+ * Copyright (C) 1999 Lars Knoll (knoll@kde.org)
  *
  * This library is free software; you can redistribute it and/or
  * modify it under the terms of the GNU Library General Public
@@ -152,6 +152,12 @@
     return HTMLCollection(impl, HTMLCollectionImpl::DOC_APPLETS);
 }
 
+HTMLCollection HTMLDocument::scripts() const
+{
+    if(!impl) return HTMLCollection();
+    return HTMLCollection(impl, HTMLCollectionImpl::DOC_SCRIPTS);
+}
+
 HTMLCollection HTMLDocument::links() const
 {
     if(!impl) return HTMLCollection();
Index: khtml/ChangeLog
===================================================================
--- khtml/ChangeLog	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/ChangeLog	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -1,3 +1,101 @@
+2006-06-28  Germain Garand  <germain@ebooksfrance.org>
+
+        make updating of addRule/removeRule/insertRule work
+        cf. http://www.quirksmode.org/dom/w3c_css.html#change
+
+        * css/css_stylesheetimpl.cpp 
+            (insertRule/deleteRule): shallow update of styleselector.
+        * xml/dom_docimpl.{h,cpp} 
+            (updateStyleSelector): new boolean argument for shallow recalculation, when all sheets are known.
+            (DocumentImpl::recalcStyleSelector): split.
+            (DocumentImpl::rebuildStyleSelector): new from split. Recreate styleselector with known sheets.
+
+2006-06-27  Germain Garand  <germain@ebooksfrance.org>
+
+        . Correct drawing of borders on iframes and objects (#118277/#56109)
+        . Frameborder attribute for iframes (http://www.w3.org/TR/html401/present/frames.html#adef-frameborder) 
+        . Fix widget counter-mask not being updated in time, thus sometimes missing a repaint (e.g: http://lequipe.fr)
+
+        * html/html_baseimpl.{h,cpp} (HTMLIFrameElementImpl::parseAttribute): parse frameborder attribute. Defaults to true as per specification.
+        (HTMLIFrameElementImpl::updateFrame/attach): apply/remove frameborder style at attachment time.
+        * khtmlview.cpp (drawContents): fix counter-mask problem. Widget geometry is not accurate before painting, so we must 
+        use the RenderObject's.
+        * rendering/render_frames.h (paddingTop/paddingBottom/paddingLeft/paddingRight): reimplement. Frames have no padding.
+        (RenderPartObject::canHaveBorder): reimplement. True.
+        * rendering/render_object.cpp (RenderObject::updateWidgetMasks): clip mask to correct width/height, though it doesn't matter much on X11.
+        * rendering/render_replaced.h (RenderWidget::borderTop/borderBottom/borderLeft/borderRight): percolated down from RenderForm. 
+        Frames/Iframes also need that reimplementation.
+
+2006-06-22  Germain Garand  <germain@ebooksfrance.org>
+
+        Implement floating auto-width table quirk
+
+        * rendering/render_block.cpp (positionNewFloats): in quirkmode, floated auto-width
+        tables try to fit within remaining linewidth, so look for minWidth, and relayout if 
+        position found ends up being narrower than current table width.
+
+2006-06-20  Germain Garand  <germain@ebooksfrance.org>
+
+        Don't let a float serie grow an object's maxwidth beyond the available width
+
+        * rendering/render_block.cpp (calcInlineMinMaxWidth/calcBlockMinMaxWidth): lazzily check available width
+        so floats don't overflow it if they can break line.
+        * rendering/render_box.{h,cpp} (availableWidth{,Using}): new. Like availableHeight{,Using}
+        * rendering/render_canvas.cpp (RenderCanvas::layout): set m_viewportWidth before recalculating minmax, as 
+        availableWidth needs it.
+
+2006-06-15  Allan Sandfeld Jensen <kde@carewolf.com>
+
+        Merge CSS3 properties background-size, background-origin and background-clip from WebCore
+
+        * rendering/render_style.{h,cpp}: New properties
+        * rendering/render_box.cpp: Handle the values in paintBackgroundExtended.
+        * dom/css_value.h: Add CSS_PAIR primitive value
+        * css/css_valueimpl.{h,cpp}: Add PairImpl primitive value
+        * css/cssstyleselector.cpp: New properties
+        * css/cssvalues.in: New values
+        * css/cssproperties.in: New properties
+        * css/cssparser.{h,cpp}: Clean-up short-hand parsing WC style
+
+2006-06-14  Allan Sandfeld Jensen <kde@carewolf.com>
+
+        Implement replaced CSS(3) content, and fix various details in generated pseudo elements for CSS 2.1
+
+        * rendering/render_style.{h,cpp}: Add REPLACED and MARKER pseudo styles
+        * rendering/render_container.{h,cpp}:
+            (updatePseudoChild) Allow display: block as per CSS 2.1 standard
+            (updateReplacedContent) Handle changes in Replaced content.
+            (childrenAllowed) forbid children when generated content is used, this prevents
+                 their render-objects from being attached.
+        * rendering/render_block.cpp: Postpone updatePseudoChilden to attachment because block
+            children might need the elements parents.
+        * rendering/render_inline.cpp: ditto
+        * rendering/render_generated.{h,cpp}: Add new class RenderGlyph to render list-style glyphs (square, disc, etc.)
+        * xml/dom_nodeimpl.cpp:
+            (NodeImpl::diff) detect changes in content and return Detach
+        * css/css_base.{h,cpp}: Add marker and replaced pseudo-styles
+        * css/cssstyleselector.cpp:
+            (checkOneSelector) Allow content on more elements
+            (precomputeAttributeDependencies) Track attributes inside :not elements as well
+
+2006-06-08  George Staikos <staikos@kde.org>
+
+        Fix <a><label><img not in a form not being clickable
+
+        * html/html_formimpl.cpp: let the event bubble
+
+2006-05-31  Allan Sandfeld Jensen <kde@carewolf.com>
+
+        Merge WC bug-fixes and clean-up for positioned box-model
+
+        * rendering/Render_box.{h,cpp}:
+            (RenderBox::calcAbsoluteHorizontal):
+            (RenderBox::calcAbsoluteHorizontalValues):
+            (RenderBox::calcAbsoluteVertical):
+            (RenderBox::calcAbsoluteVerticalValues):
+            (RenderBox::calcAbsoluteHorizontalReplaced): Handle replaced case separately.
+            (RenderBox::calcAbsoluteVerticalReplaced): ditto.
+
 2006-04-20  Allan Sandfeld Jensen <kde@carewolf.com>
 
         Implement full support for CSS updates on dynamic DOM and user-interaction
Index: khtml/css/html4.css
===================================================================
--- khtml/css/html4.css	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/css/html4.css	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -529,7 +529,6 @@
 }
 
 nobr {
-        display: inline;
         white-space: nowrap;
 }
 
Index: khtml/css/cssparser.cpp
===================================================================
--- khtml/css/cssparser.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/css/cssparser.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -3,6 +3,7 @@
  *
  * Copyright (C) 2003 Lars Knoll (knoll@kde.org)
  * Copyright (C) 2005 Allan Sandfeld Jensen (kde@carewolf.com)
+ * Copyright (C) 2004, 2005, 2006 Apple Computer, Inc.
  *
  * This library is free software; you can redistribute it and/or
  * modify it under the terms of the GNU Library General Public
@@ -20,8 +21,8 @@
  * Boston, MA 02110-1301, USA.
  */
 
-//#define CSS_DEBUG
-//#define TOKEN_DEBUG
+// #define CSS_DEBUG
+// #define TOKEN_DEBUG
 #define YYDEBUG 0
 
 #include <kdebug.h>
@@ -49,38 +50,33 @@
         skip_next = false; \
     }
 
-ValueList::ValueList()
+ValueList::~ValueList()
 {
-    values = (Value *) malloc( 16 * sizeof ( Value ) );
-    numValues = 0;
-    currentValue = 0;
-    maxValues = 16;
+     unsigned numValues = m_values.size();
+     for (unsigned i = 0; i < numValues; i++)
+         if (m_values[i].unit == Value::Function)
+             delete m_values[i].function;
 }
 
-ValueList::~ValueList()
-{
-    for ( int i = 0; i < numValues; i++ ) {
-#ifdef CSS_DEBUG
-        kdDebug( 6080 ) << "       value: (unit=" << values[i].unit <<")"<< endl;
-#endif
-        if ( values[i].unit == Value::Function ) {
-            delete values[i].function->args;
-            delete values[i].function;
+namespace {
+    class ShorthandScope {
+    public:
+        ShorthandScope(CSSParser* parser, int propId) : m_parser(parser)
+        {
+            if (!(m_parser->m_inParseShorthand++))
+                m_parser->m_currentShorthand = propId;
         }
-    }
-    free( values );
-}
+        ~ShorthandScope()
+        {
+            if (!(--m_parser->m_inParseShorthand))
+                m_parser->m_currentShorthand = 0;
+        }
 
-void ValueList::addValue( const Value &val )
-{
-    if ( numValues >= maxValues ) {
-        maxValues += 16;
-        values = (Value *) realloc( values, maxValues*sizeof( Value ) );
-    }
-    values[numValues++] = val;
+    private:
+        CSSParser* m_parser;
+    };
 }
 
-
 using namespace DOM;
 
 #if YYDEBUG > 0
@@ -108,8 +104,11 @@
     id = 0;
     important = false;
     nonCSSHint = false;
-    inParseShortHand = false;
 
+    m_inParseShorthand = 0;
+    m_currentShorthand = 0;
+    m_implicitShorthand = false;
+
     yy_start = 1;
 
 #if YYDEBUG > 0
@@ -289,7 +288,7 @@
     CSSProperty *prop = new CSSProperty;
     prop->m_id = propId;
     prop->setValue( value );
-    prop->m_bImportant = important;
+    prop->m_important = important;
     prop->nonCSSHint = nonCSSHint;
 
     if ( numParsedProperties >= maxParsedProperties ) {
@@ -392,7 +391,7 @@
     return b;
 }
 
-bool CSSParser::parseValue( int propId, bool important, int expected )
+bool CSSParser::parseValue( int propId, bool important )
 {
     if ( !valueList ) return false;
 
@@ -403,13 +402,20 @@
 
     int id = value->id;
 
-    if ( id == CSS_VAL_INHERIT && expected == 1 ) {
+    int num = inShorthand() ? 1 : valueList->size();
+
+    if ( id == CSS_VAL_INHERIT ) {
+        if (num != 1)
+            return false;
         addProperty( propId, new CSSInheritedValueImpl(), important );
         return true;
-    } else if (id == CSS_VAL_INITIAL && expected == 1 ) {
+    } else if (id == CSS_VAL_INITIAL ) {
+        if (num != 1)
+            return false;
         addProperty(propId, new CSSInitialValueImpl(), important);
         return true;
     }
+
     bool valid_primitive = false;
     CSSValueImpl *parsedValue = 0;
 
@@ -631,16 +637,17 @@
     {
         const int properties[2] = { CSS_PROP__KHTML_BORDER_HORIZONTAL_SPACING,
                                     CSS_PROP__KHTML_BORDER_VERTICAL_SPACING };
-        int num = valueList->numValues;
         if (num == 1) {
+            ShorthandScope scope(this, CSS_PROP_BORDER_SPACING);
             if (!parseValue(properties[0], important)) return false;
             CSSValueImpl* value = parsedProperties[numParsedProperties-1]->value();
             addProperty(properties[1], value, important);
             return true;
         }
         else if (num == 2) {
-            if (!parseValue(properties[0], important, 2)) return false;
-            if (!parseValue(properties[1], important, 1)) return false;
+            ShorthandScope scope(this, CSS_PROP_BORDER_SPACING);
+            if (!parseValue(properties[0], important)) return false;
+            if (!parseValue(properties[1], important)) return false;
             return true;
         }
         return false;
@@ -699,10 +706,13 @@
         break;
 
     case CSS_PROP_BACKGROUND_ATTACHMENT:
+    case CSS_PROP__KHTML_BACKGROUND_CLIP:
     case CSS_PROP_BACKGROUND_IMAGE:
+    case CSS_PROP__KHTML_BACKGROUND_ORIGIN:
     case CSS_PROP_BACKGROUND_POSITION:
     case CSS_PROP_BACKGROUND_POSITION_X:
     case CSS_PROP_BACKGROUND_POSITION_Y:
+    case CSS_PROP__KHTML_BACKGROUND_SIZE:
     case CSS_PROP_BACKGROUND_REPEAT: {
         CSSValueImpl *val1 = 0, *val2 = 0;
         int propId1, propId2;
@@ -932,7 +942,7 @@
         const int properties[5] = { CSS_PROP__KHTML_MARQUEE_DIRECTION, CSS_PROP__KHTML_MARQUEE_INCREMENT,
                                     CSS_PROP__KHTML_MARQUEE_REPETITION,
                                     CSS_PROP__KHTML_MARQUEE_STYLE, CSS_PROP__KHTML_MARQUEE_SPEED };
-        return parseShortHand(properties, 5, important);
+        return parseShortHand(propId, properties, 5, important);
     }
     case CSS_PROP__KHTML_MARQUEE_DIRECTION:
         if (id == CSS_VAL_FORWARDS || id == CSS_VAL_BACKWARDS || id == CSS_VAL_AHEAD ||
@@ -975,77 +985,77 @@
     {
         const int properties[3] = { CSS_PROP_BORDER_WIDTH, CSS_PROP_BORDER_STYLE,
                                     CSS_PROP_BORDER_COLOR };
-        return parseShortHand(properties, 3, important);
+        return parseShortHand(propId, properties, 3, important);
     }
     case CSS_PROP_BORDER_TOP:
             // [ 'border-top-width' || 'border-style' || <color> ] | inherit
     {
         const int properties[3] = { CSS_PROP_BORDER_TOP_WIDTH, CSS_PROP_BORDER_TOP_STYLE,
                                     CSS_PROP_BORDER_TOP_COLOR};
-        return parseShortHand(properties, 3, important);
+        return parseShortHand(propId, properties, 3, important);
     }
     case CSS_PROP_BORDER_RIGHT:
             // [ 'border-right-width' || 'border-style' || <color> ] | inherit
     {
         const int properties[3] = { CSS_PROP_BORDER_RIGHT_WIDTH, CSS_PROP_BORDER_RIGHT_STYLE,
                                     CSS_PROP_BORDER_RIGHT_COLOR };
-        return parseShortHand(properties, 3, important);
+        return parseShortHand(propId, properties, 3, important);
     }
     case CSS_PROP_BORDER_BOTTOM:
             // [ 'border-bottom-width' || 'border-style' || <color> ] | inherit
     {
         const int properties[3] = { CSS_PROP_BORDER_BOTTOM_WIDTH, CSS_PROP_BORDER_BOTTOM_STYLE,
                                     CSS_PROP_BORDER_BOTTOM_COLOR };
-        return parseShortHand(properties, 3, important);
+        return parseShortHand(propId, properties, 3, important);
     }
     case CSS_PROP_BORDER_LEFT:
             // [ 'border-left-width' || 'border-style' || <color> ] | inherit
     {
         const int properties[3] = { CSS_PROP_BORDER_LEFT_WIDTH, CSS_PROP_BORDER_LEFT_STYLE,
                                     CSS_PROP_BORDER_LEFT_COLOR };
-        return parseShortHand(properties, 3, important);
+        return parseShortHand(propId, properties, 3, important);
     }
     case CSS_PROP_OUTLINE:
             // [ 'outline-color' || 'outline-style' || 'outline-width' ] | inherit
     {
         const int properties[3] = { CSS_PROP_OUTLINE_WIDTH, CSS_PROP_OUTLINE_STYLE,
                                     CSS_PROP_OUTLINE_COLOR };
-        return parseShortHand(properties, 3, important);
+        return parseShortHand(propId, properties, 3, important);
     }
     case CSS_PROP_BORDER_COLOR:
             // <color>{1,4} | inherit
     {
         const int properties[4] = { CSS_PROP_BORDER_TOP_COLOR, CSS_PROP_BORDER_RIGHT_COLOR,
                                     CSS_PROP_BORDER_BOTTOM_COLOR, CSS_PROP_BORDER_LEFT_COLOR };
-        return parse4Values(properties, important);
+        return parse4Values(propId, properties, important);
     }
     case CSS_PROP_BORDER_WIDTH:
             // <border-width>{1,4} | inherit
     {
         const int properties[4] = { CSS_PROP_BORDER_TOP_WIDTH, CSS_PROP_BORDER_RIGHT_WIDTH,
                                     CSS_PROP_BORDER_BOTTOM_WIDTH, CSS_PROP_BORDER_LEFT_WIDTH };
-        return parse4Values(properties, important);
+        return parse4Values(propId, properties, important);
     }
     case CSS_PROP_BORDER_STYLE:
             // <border-style>{1,4} | inherit
     {
         const int properties[4] = { CSS_PROP_BORDER_TOP_STYLE, CSS_PROP_BORDER_RIGHT_STYLE,
                                     CSS_PROP_BORDER_BOTTOM_STYLE, CSS_PROP_BORDER_LEFT_STYLE };
-        return parse4Values(properties, important);
+        return parse4Values(propId, properties, important);
     }
     case CSS_PROP_MARGIN:
             // <margin-width>{1,4} | inherit
     {
         const int properties[4] = { CSS_PROP_MARGIN_TOP, CSS_PROP_MARGIN_RIGHT,
                                     CSS_PROP_MARGIN_BOTTOM, CSS_PROP_MARGIN_LEFT };
-        return parse4Values(properties, important);
+        return parse4Values(propId, properties, important);
     }
     case CSS_PROP_PADDING:
             // <padding-width>{1,4} | inherit
     {
         const int properties[4] = { CSS_PROP_PADDING_TOP, CSS_PROP_PADDING_RIGHT,
                                     CSS_PROP_PADDING_BOTTOM, CSS_PROP_PADDING_LEFT };
-        return parse4Values(properties, important);
+        return parse4Values(propId, properties, important);
     }
     case CSS_PROP_FONT:
             // [ [ 'font-style' || 'font-variant' || 'font-weight' ]? 'font-size' [ / 'line-height' ]?
@@ -1059,7 +1069,7 @@
     {
         const int properties[3] = { CSS_PROP_LIST_STYLE_TYPE, CSS_PROP_LIST_STYLE_POSITION,
                                     CSS_PROP_LIST_STYLE_IMAGE };
-        return parseShortHand(properties, 3, important);
+        return parseShortHand(propId, properties, 3, important);
     }
     default:
 // #ifdef CSS_DEBUG
@@ -1071,31 +1081,25 @@
     if ( valid_primitive ) {
 
         if ( id != 0 ) {
-            // qDebug(" new value: id=%d", id );
             parsedValue = new CSSPrimitiveValueImpl( id );
         } else if ( value->unit == CSSPrimitiveValue::CSS_STRING )
             parsedValue = new CSSPrimitiveValueImpl( domString( value->string ),
                                                      (CSSPrimitiveValue::UnitTypes) value->unit );
         else if ( value->unit >= CSSPrimitiveValue::CSS_NUMBER &&
                   value->unit <= CSSPrimitiveValue::CSS_KHZ ) {
-            // qDebug(" new value: value=%.2f, unit=%d", value->fValue, value->unit );
             parsedValue = new CSSPrimitiveValueImpl( value->fValue,
                                                      (CSSPrimitiveValue::UnitTypes) value->unit );
         } else if ( value->unit >= Value::Q_EMS ) {
-            // qDebug(" new quirks value: value=%.2f, unit=%d", value->fValue, value->unit );
             parsedValue = new CSSQuirkPrimitiveValueImpl( value->fValue, CSSPrimitiveValue::CSS_EMS );
         }
-        --expected;
         valueList->next();
-        if ( valueList->current() && expected == 0)
-        {
-            delete parsedValue;
-            parsedValue = 0;
-        }
     }
     if ( parsedValue ) {
-        addProperty( propId, parsedValue, important );
-        return true;
+        if (!valueList->current() || inShorthand()) {
+            addProperty( propId, parsedValue, important );
+            return true;
+        }
+        delete parsedValue;
     }
     return false;
 }
@@ -1121,11 +1125,13 @@
 {
     // Position must come before color in this array because a plain old "0" is a legal color
     // in quirks mode but it's usually the X coordinate of a position.
-    const int numProperties = 5;
+    // FIXME: Add CSS_PROP__KHTML_BACKGROUND_SIZE to the shorthand.
+    const int numProperties = 7;
     const int properties[numProperties] = { CSS_PROP_BACKGROUND_IMAGE, CSS_PROP_BACKGROUND_REPEAT,
-        CSS_PROP_BACKGROUND_ATTACHMENT, CSS_PROP_BACKGROUND_POSITION, CSS_PROP_BACKGROUND_COLOR };
+        CSS_PROP_BACKGROUND_ATTACHMENT, CSS_PROP_BACKGROUND_POSITION,  CSS_PROP__KHTML_BACKGROUND_CLIP,
+        CSS_PROP__KHTML_BACKGROUND_ORIGIN, CSS_PROP_BACKGROUND_COLOR };
 
-    inParseShortHand = true;
+    ShorthandScope scope(this, CSS_PROP_BACKGROUND);
 
     bool parsedProperty[numProperties] = { false }; // compiler will repeat false as necessary
     CSSValueImpl* values[numProperties] = { 0 }; // compiler will repeat 0 as necessary
@@ -1193,82 +1199,56 @@
             addProperty(properties[i], values[i], important);
     }
 
-    inParseShortHand = false;
     return true;
 
 fail:
-    inParseShortHand = false;
     for (int k = 0; k < numProperties; k++)
         delete values[k];
     delete positionYValue;
     return false;
 }
 
-bool CSSParser::parseShortHand( const int *properties, int numProperties, bool important )
+bool CSSParser::parseShortHand(int propId, const int *properties, int numProperties, bool important )
 {
     /* We try to match as many properties as possible
      * We setup an array of booleans to mark which property has been found,
      * and we try to search for properties until it makes no longer any sense
      */
-    inParseShortHand = true;
+    ShorthandScope scope(this, propId);
 
     bool found = false;
-    int oldPropIndex = numParsedProperties;
     bool fnd[6]; //Trust me ;)
     for( int i = 0; i < numProperties; i++ )
-            fnd[i] = false;
+        fnd[i] = false;
 
-#ifdef CSS_DEBUG
-    kdDebug(6080) << "PSH: numProperties=" << numProperties << endl;
-#endif
-
     while ( valueList->current() ) {
         found = false;
-        // qDebug("outer loop" );
         for (int propIndex = 0; !found && propIndex < numProperties; ++propIndex) {
             if (!fnd[propIndex]) {
-#ifdef CSS_DEBUG
-                kdDebug(6080) << "LOOKING FOR: " << getPropertyName(properties[propIndex]).string() << endl;
-#endif
-                if ( parseValue( properties[propIndex], important, numProperties ) ) {
+                if ( parseValue( properties[propIndex], important ) ) {
                     fnd[propIndex] = found = true;
-#ifdef CSS_DEBUG
-                    kdDebug(6080) << "FOUND: " << getPropertyName(properties[propIndex]).string() << endl;
-#endif
                 }
             }
         }
+
         // if we didn't find at least one match, this is an
         // invalid shorthand and we have to ignore it
-        if (!found) {
-#ifdef CSS_DEBUG
-            qDebug("didn't find anything" );
-#endif
-
-            // need to nuke the already added values
-            for ( int i = oldPropIndex; i < numParsedProperties; ++i )
-                delete parsedProperties[i];
-
-            numParsedProperties = oldPropIndex;
-            inParseShortHand = false;
+        if (!found)
             return false;
-        }
     }
 
     // Fill in any remaining properties with the initial value.
+    m_implicitShorthand = true;
     for (int i = 0; i < numProperties; ++i) {
         if (!fnd[i])
             addProperty(properties[i], new CSSInitialValueImpl(), important);
     }
+    m_implicitShorthand = false;
 
-    inParseShortHand = false;
-#ifdef CSS_DEBUG
-    kdDebug( 6080 ) << "parsed shorthand" << endl;
-#endif
     return true;
 }
 
-bool CSSParser::parse4Values( const int *properties,  bool important )
+bool CSSParser::parse4Values(int propId, const int *properties,  bool important )
 {
     /* From the CSS 2 specs, 8.3
      * If there is only one value, it applies to all sides. If there are two values, the top and
@@ -1278,47 +1258,56 @@
      * right, bottom, and left, respectively.
      */
 
-    int num = inParseShortHand ? 1 : valueList->numValues;
+    int num = inShorthand() ? 1 : valueList->size();
     //qDebug("parse4Values: num=%d %d", num,  valueList->numValues );
 
+    ShorthandScope scope(this, propId);
+
     // the order is top, right, bottom, left
-    switch( num ) {
-    case 1: {
-        if( !parseValue( properties[0], important, valueList->numValues ) ) return false;
-        CSSValueImpl *value = parsedProperties[numParsedProperties-1]->value();
-        addProperty( properties[1], value, important );
-        addProperty( properties[2], value, important );
-        addProperty( properties[3], value, important );
-        return true;
+    switch (num) {
+        case 1: {
+            if (!parseValue(properties[0], important))
+                return false;
+            CSSValueImpl *value = parsedProperties[numParsedProperties-1]->value();
+            m_implicitShorthand = true;
+            addProperty(properties[1], value, important);
+            addProperty(properties[2], value, important);
+            addProperty(properties[3], value, important);
+            m_implicitShorthand = false;
+            break;
+        }
+        case 2: {
+            if (!parseValue(properties[0], important) || !parseValue(properties[1], important))
+                return false;
+            CSSValueImpl *value = parsedProperties[numParsedProperties-2]->value();
+            m_implicitShorthand = true;
+            addProperty(properties[2], value, important);
+            value = parsedProperties[numParsedProperties-2]->value();
+            addProperty(properties[3], value, important);
+            m_implicitShorthand = false;
+            break;
+        }
+        case 3: {
+            if (!parseValue(properties[0], important) || !parseValue(properties[1], important) || !parseValue(properties[2], important))
+                return false;
+            CSSValueImpl *value = parsedProperties[numParsedProperties-2]->value();
+            m_implicitShorthand = true;
+            addProperty(properties[3], value, important);
+            m_implicitShorthand = false;
+            break;
+        }
+        case 4: {
+            if (!parseValue(properties[0], important) || !parseValue(properties[1], important) ||
+                !parseValue(properties[2], important) || !parseValue(properties[3], important))
+                return false;
+            break;
+        }
+        default: {
+            return false;
+        }
     }
-    case 2: {
 
-        if( !parseValue( properties[0], important, valueList->numValues ) ) return false;
-        if( !parseValue( properties[1], important, valueList->numValues) ) return false;
-        CSSValueImpl *value = parsedProperties[numParsedProperties-2]->value();
-        addProperty( properties[2], value, important );
-        value = parsedProperties[numParsedProperties-2]->value();
-        addProperty( properties[3], value, important );
-        return true;
-    }
-    case 3: {
-        if( !parseValue( properties[0], important, valueList->numValues ) ) return false;
-        if( !parseValue( properties[1], important, valueList->numValues ) ) return false;
-        if( !parseValue( properties[2], important, valueList->numValues ) ) return false;
-        CSSValueImpl *value = parsedProperties[numParsedProperties-2]->value();
-        addProperty( properties[3], value, important );
-        return true;
-    }
-    case 4: {
-        if( !parseValue( properties[0], important, valueList->numValues ) ) return false;
-        if( !parseValue( properties[1], important, valueList->numValues ) ) return false;
-        if( !parseValue( properties[2], important, valueList->numValues ) ) return false;
-        if( !parseValue( properties[3], important, valueList->numValues ) ) return false;
-        return true;
-    }
-    default:
-        return false;
-    }
+    return true;
 }
 
 // [ <string> | <uri> | <counter> | attr(X) | open-quote | close-quote | no-open-quote | no-close-quote ]+ | inherit
@@ -1345,10 +1334,10 @@
             QString fname = qString( val->function->name ).lower();
             if (!args) return false;
             if (fname == "attr(") {
-            if ( args->numValues != 1)
-                return false;
-            Value *a = args->current();
-            parsedValue = new CSSPrimitiveValueImpl(domString(a->string), CSSPrimitiveValue::CSS_ATTR);
+                if ( args->size() != 1)
+                    return false;
+                Value *a = args->current();
+                parsedValue = new CSSPrimitiveValueImpl(domString(a->string), CSSPrimitiveValue::CSS_ATTR);
             }
             else
             if (fname == "counter(") {
@@ -1390,8 +1379,8 @@
 
 CSSValueImpl* CSSParser::parseCounterContent(ValueList *args, bool counters)
 {
-    if (counters || (args->numValues != 1 && args->numValues != 3))
-        if (!counters || (args->numValues != 3 && args->numValues != 5))
+    if (counters || (args->size() != 1 && args->size() != 3))
+        if (!counters || (args->size() != 3 && args->size() != 5))
             return 0;
 
     CounterImpl *counter = new CounterImpl;
@@ -1500,7 +1489,7 @@
         if (value2)
             valueList->next();
         else {
-            if (!inParseShortHand) {
+            if (!inShorthand()) {
                 delete value1;
                 value1 = 0;
                 return;
@@ -1523,9 +1512,43 @@
     }
 }
 
+CSSValueImpl* CSSParser::parseBackgroundSize()
+{
+    Value* value = valueList->current();
+    CSSPrimitiveValueImpl* parsedValue1;
+
+    if (value->id == CSS_VAL_AUTO)
+        parsedValue1 = new CSSPrimitiveValueImpl(0, CSSPrimitiveValue::CSS_UNKNOWN);
+    else {
+        if (!validUnit(value, FLength|FPercent, strict))
+            return 0;
+        parsedValue1 = new CSSPrimitiveValueImpl(value->fValue, (CSSPrimitiveValue::UnitTypes)value->unit);
+    }
+
+    CSSPrimitiveValueImpl* parsedValue2 = parsedValue1;
+    if ((value = valueList->next())) {
+        if (value->id == CSS_VAL_AUTO)
+            parsedValue2 = new CSSPrimitiveValueImpl(0, CSSPrimitiveValue::CSS_UNKNOWN);
+        else {
+            if (!validUnit(value, FLength|FPercent, strict)) {
+                delete parsedValue1;
+                return 0;
+            }
+            parsedValue2 = new CSSPrimitiveValueImpl(value->fValue, (CSSPrimitiveValue::UnitTypes)value->unit);
+        }
+    }
+
+    PairImpl* pair = new PairImpl(parsedValue1, parsedValue2);
+    return new CSSPrimitiveValueImpl(pair);
+}
+
 bool CSSParser::parseBackgroundProperty(int propId, int& propId1, int& propId2,
                                         CSSValueImpl*& retValue1, CSSValueImpl*& retValue2)
 {
+#ifdef CSS_DEBUG
+    kdDebug(6080) << "parseBackgroundProperty()" << endl;
+    kdDebug(6080) << "LOOKING FOR: " << getPropertyName(propId).string() << endl;
+#endif
     CSSValueListImpl *values = 0, *values2 = 0;
     Value* val;
     CSSValueImpl *value = 0, *value2 = 0;
@@ -1565,6 +1588,13 @@
                     if (currValue)
                         valueList->next();
                     break;
+                case CSS_PROP__KHTML_BACKGROUND_CLIP:
+                case CSS_PROP__KHTML_BACKGROUND_ORIGIN:
+                    if (val->id == CSS_VAL_BORDER || val->id == CSS_VAL_PADDING || val->id == CSS_VAL_CONTENT) {
+                        currValue = new CSSPrimitiveValueImpl(val->id);
+                        valueList->next();
+                    }
+                    break;
                 case CSS_PROP_BACKGROUND_POSITION:
                     parseBackgroundPosition(currValue, currValue2);
                     // unlike the other functions, parseBackgroundPosition advances the valueList pointer
@@ -1589,6 +1619,11 @@
                         valueList->next();
                     }
                     break;
+                case CSS_PROP__KHTML_BACKGROUND_SIZE:
+                    currValue = parseBackgroundSize();
+                    if (currValue)
+                        valueList->next();
+                    break;
             }
 
             if (!currValue)
@@ -1621,7 +1656,7 @@
 
         // When parsing the 'background' shorthand property, we let it handle building up the lists for all
         // properties.
-        if (inParseShortHand)
+        if (inShorthand())
             break;
     }
 
@@ -1653,7 +1688,7 @@
         return false;
 
     // rect( t, r, b, l ) || rect( t r b l )
-    if ( args->numValues != 4 && args->numValues != 7 )
+    if ( args->size() != 4 && args->size() != 7 )
         return false;
     RectImpl *rect = new RectImpl();
     bool valid = true;
@@ -1674,7 +1709,7 @@
         else
             rect->setLeft( length );
         a = args->next();
-        if ( a && args->numValues == 7 ) {
+        if ( a && args->size() == 7 ) {
             if ( a->unit == Value::Operator && a->iValue == ',' ) {
                 a = args->next();
             } else {
@@ -1979,7 +2014,7 @@
     }
     else if ( value->unit == Value::Function &&
 		value->function->args != 0 &&
-                value->function->args->numValues == 5 /* rgb + two commas */ &&
+                value->function->args->size() == 5 /* rgb + two commas */ &&
                 qString( value->function->name ).lower() == "rgb(" ) {
         ValueList *args = value->function->args;
         Value *v = args->current();
@@ -2007,7 +2042,7 @@
     }
     else if ( value->unit == Value::Function &&
               value->function->args != 0 &&
-              value->function->args->numValues == 7 /* rgba + three commas */ &&
+              value->function->args->size() == 7 /* rgba + three commas */ &&
               qString( value->function->name ).lower() == "rgba(" ) {
         ValueList *args = value->function->args;
         Value *v = args->current();
@@ -2157,7 +2192,7 @@
                            (val->id >= CSS_VAL_GREY && val->id <= CSS_VAL__KHTML_TEXT && !strict));
 	    if (!context.allowColor)
                 return context.failed();
- 
+
             if (isColor)
                parsedColor = new CSSPrimitiveValueImpl(val->id);
 
Index: khtml/css/css_ruleimpl.h
===================================================================
--- khtml/css/css_ruleimpl.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/css/css_ruleimpl.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -112,7 +112,7 @@
     virtual bool isImportRule() const { return true; }
 
     // from CachedObjectClient
-    virtual void setStyleSheet(const DOM::DOMString &url, const DOM::DOMString &sheet);
+    virtual void setStyleSheet(const DOM::DOMString &url, const DOM::DOMString &sheet, const DOM::DOMString &charset);
     virtual void error(int err, const QString &text);
 
     bool isLoading();
Index: khtml/css/css_valueimpl.cpp
===================================================================
--- khtml/css/css_valueimpl.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/css/css_valueimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -2,7 +2,7 @@
  * This file is part of the DOM implementation for KDE.
  *
  * Copyright (C) 1999-2003 Lars Knoll (knoll@kde.org)
- *           (C) 2004 Apple Computer, Inc.
+ *           (C) 2004, 2005, 2006 Apple Computer, Inc.
  *           (C) 2005 Allan Sandfeld Jensen (kde@carewolf.com)
  *
  * This library is free software; you can redistribute it and/or
@@ -293,7 +293,7 @@
 	CSSProperty *current;
 	for ( lstValuesIt.toFirst(); (current = lstValuesIt.current()); ++lstValuesIt ) {
 	    if( propertyID == current->m_id )
-		return current->m_bImportant;
+		return current->m_important;
 	}
     }
     return false;
@@ -511,6 +511,15 @@
     m_type = CSSPrimitiveValue::CSS_RGBCOLOR;
 }
 
+CSSPrimitiveValueImpl::CSSPrimitiveValueImpl(PairImpl *p)
+{
+    m_value.pair = p;
+    if (m_value.pair)
+	m_value.pair->ref();
+    m_type = CSSPrimitiveValue::CSS_PAIR;
+}
+
+
 CSSPrimitiveValueImpl::~CSSPrimitiveValueImpl()
 {
     cleanup();
@@ -529,6 +538,10 @@
         break;
     case CSSPrimitiveValue::CSS_RECT:
 	m_value.rect->deref();
+        break;
+    case CSSPrimitiveValue::CSS_PAIR:
+        m_value.pair->deref();
+        break;
     default:
         break;
     }
@@ -739,11 +752,16 @@
             text += rectVal->right()->cssText() + " ";
             text += rectVal->bottom()->cssText() + " ";
             text += rectVal->left()->cssText() + ")";
+            break;
         }
-        break;
 	case CSSPrimitiveValue::CSS_RGBCOLOR:
 	    text = QColor(m_value.rgbcolor).name();
 	    break;
+        case CSSPrimitiveValue::CSS_PAIR:
+            text = m_value.pair->first()->cssText();
+            text += " ";
+            text += m_value.pair->second()->cssText();
+            break;
 	default:
 	    break;
     }
@@ -798,6 +816,29 @@
 
 // -----------------------------------------------------------------
 
+PairImpl::~PairImpl()
+{
+    if (m_first) m_first->deref(); if (m_second) m_second->deref();
+}
+
+void PairImpl::setFirst(CSSPrimitiveValueImpl* first)
+{
+    if (first == m_first) return;
+    if (m_first) m_first->deref();
+    m_first = first;
+    if (m_first) m_first->ref();
+}
+
+void PairImpl::setSecond(CSSPrimitiveValueImpl* second)
+{
+    if (second == m_second) return;
+    if (m_second) m_second->deref();
+    m_second = second;
+    if (m_second) m_second->ref();
+}
+
+// -----------------------------------------------------------------
+
 CSSImageValueImpl::CSSImageValueImpl(const DOMString &url, const StyleBaseImpl* style)
     : CSSPrimitiveValueImpl(url, CSSPrimitiveValue::CSS_URI)
 {
@@ -1016,5 +1057,5 @@
 
 DOMString CSSProperty::cssText() const
 {
-    return getPropertyName(m_id) + DOMString(": ") + m_value->cssText() + (m_bImportant ? DOMString(" !important") : DOMString()) + DOMString("; ");
+    return getPropertyName(m_id) + DOMString(": ") + m_value->cssText() + (m_important ? DOMString(" !important") : DOMString()) + DOMString("; ");
 }
Index: khtml/css/cssstyleselector.h
===================================================================
--- khtml/css/cssstyleselector.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/css/cssstyleselector.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -2,7 +2,7 @@
  * This file is part of the CSS implementation for KDE.
  *
  * Copyright (C) 1999-2003 Lars Knoll (knoll@kde.org)
- * Copyright (C) 2003 Apple Computer, Inc.
+ * Copyright (C) 2003, 2005, 2006 Apple Computer, Inc.
  *
  * This library is free software; you can redistribute it and/or
  * modify it under the terms of the GNU Library General Public
@@ -152,7 +152,7 @@
 	    with given relationships matches the given Element */
 	void checkSelector(int selector, DOM::ElementImpl *e);
 	/* checks if the selector matches the given Element */
-	bool checkOneSelector(DOM::CSSSelector *selector, DOM::ElementImpl *e, bool isAncestor);
+	bool checkOneSelector(DOM::CSSSelector *selector, DOM::ElementImpl *e, bool isAncestor, bool isSubSelector=false);
 
 #ifdef APPLE_CHANGES
 	/* This function fixes up the default font size if it detects that the
@@ -190,8 +190,11 @@
         void init(const KHTMLSettings* settings, DOM::DocumentImpl* doc);
 
         void mapBackgroundAttachment(BackgroundLayer* layer, DOM::CSSValueImpl* value);
+        void mapBackgroundClip(BackgroundLayer* layer, DOM::CSSValueImpl* value);
+        void mapBackgroundOrigin(BackgroundLayer* layer, DOM::CSSValueImpl* value);
         void mapBackgroundImage(BackgroundLayer* layer, DOM::CSSValueImpl* value);
         void mapBackgroundRepeat(BackgroundLayer* layer, DOM::CSSValueImpl* value);
+        void mapBackgroundSize(BackgroundLayer* layer, DOM::CSSValueImpl* value);
         void mapBackgroundXPosition(BackgroundLayer* layer, DOM::CSSValueImpl* value);
         void mapBackgroundYPosition(BackgroundLayer* layer, DOM::CSSValueImpl* value);
 
Index: khtml/css/css_base.cpp
===================================================================
--- khtml/css/css_base.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/css/css_base.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -82,7 +82,7 @@
     propIt.toLast(); // just remove the top one - not sure what should happen if we have multiple instances of the property
     while (propIt.current() &&
            ( propIt.current()->m_id != propId || propIt.current()->nonCSSHint != nonCSSHint ||
-             propIt.current()->m_bImportant != important) )
+             propIt.current()->m_important != important) )
         --propIt;
     if (propIt.current())
         propList->removeRef(propIt.current());
@@ -90,14 +90,14 @@
     CSSProperty *prop = new CSSProperty();
     prop->m_id = propId;
     prop->setValue((CSSValueImpl *) parsedValue);
-    prop->m_bImportant = important;
+    prop->m_important = important;
     prop->nonCSSHint = nonCSSHint;
 
     propList->append(prop);
 #ifdef CSS_DEBUG
     kdDebug( 6080 ) << "added property: " << getPropertyName(propId).string()
                     // non implemented yet << ", value: " << parsedValue->cssText().string()
-                    << " important: " << prop->m_bImportant
+                    << " important: " << prop->m_important
                     << " nonCSS: " << prop->nonCSSHint << endl;
 #endif
 }
@@ -171,6 +171,14 @@
     if (!value.isEmpty()) {
         value = value.lower();
         switch (value[0]) {
+            case '-':
+                if (value == "-khtml-replaced")
+                    _pseudoType = PseudoReplaced;
+                else
+                if (value == "-khtml-marker")
+                    _pseudoType = PseudoMarker;
+                element = true;
+                break;
             case 'a':
                 if (value == "active")
                     _pseudoType = PseudoActive;
@@ -316,7 +324,7 @@
         str = "*";
     else if (tag != anyLocalName)
         str = getTagName( cs->tag );
-          
+
     const CSSSelector* op = 0;
     while (true) {
         if ( cs->attr == ATTR_ID && cs->match == CSSSelector::Id )
@@ -388,12 +396,12 @@
             op=0;
             str += ")";
         }
-            
+
         if ((cs->relation != CSSSelector::SubSelector && !op) || !cs->tagHistory)
             break;
         cs = cs->tagHistory;
     }
-    
+
     if ( cs->tagHistory ) {
         DOMString tagHistoryText = cs->tagHistory->selectorText();
         if ( cs->relation == DirectAdjacent )
Index: khtml/css/css_stylesheetimpl.h
===================================================================
--- khtml/css/css_stylesheetimpl.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/css/css_stylesheetimpl.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -104,6 +104,9 @@
     void determineNamespace(Q_UINT32& id, const DOM::DOMString& prefix);
     Q_UINT32 defaultNamespace() { return m_defaultNamespace; };
 
+    void setCharset(const DOMString &charset) { m_charset = charset; }
+    const DOMString& charset() const { return m_charset; }
+
     virtual bool parseString( const DOMString &string, bool strict = true );
 
     bool isLoading() const;
@@ -122,6 +125,7 @@
     bool m_implicit;
     Q_UINT32 m_defaultNamespace;
     CSSNamespace* m_namespaces;
+    DOMString m_charset;
 };
 
 // ----------------------------------------------------------------------------
Index: khtml/css/cssvalues.in
===================================================================
--- khtml/css/cssvalues.in	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/css/cssvalues.in	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -386,8 +386,23 @@
 unfurl
 
 #
-# Not supported CSS 2 Aural values
+
 #
+# CSS_PROP_BACKGROUND_CLIP/ORIGIN
+#
+border
+content
+padding
+
+#
+# Not supported:
+#
+# CSS_PROP_BORDER_IMAGE
+#
+# stretch
+# repeat
+# round
+#
 # CSS_PROP_AZIMUTH:
 #
 #A left-side
Index: khtml/css/css_renderstyledeclarationimpl.cpp
===================================================================
--- khtml/css/css_renderstyledeclarationimpl.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/css/css_renderstyledeclarationimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -309,13 +309,13 @@
 
     if (renderer->isPositioned())
         return valueForLength(l, renderer->contentWidth());
-    
+
     if (renderer->isRelPositioned())
         // FIXME: It's not enough to simply return "auto" values for one offset if the other side is defined.
         // In other words if left is auto and right is not auto, then left's computed value is negative right.
         // So we should get the opposite length unit and see if it is auto.
         return valueForLength(l, renderer->contentWidth());
-    
+
     return new CSSPrimitiveValueImpl(CSS_VAL_AUTO);
  }
 
@@ -1112,7 +1112,7 @@
 {
     CSSProperty prop;
     prop.m_id = id;
-    prop.m_bImportant = false;
+    prop.m_important = false;
     prop.nonCSSHint = false;
 
     CSSValueImpl* v = getPropertyCSSValue( id );
Index: khtml/css/css_ruleimpl.cpp
===================================================================
--- khtml/css/css_ruleimpl.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/css/css_ruleimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -130,13 +130,14 @@
     if(m_cachedSheet) m_cachedSheet->deref(this);
 }
 
-void CSSImportRuleImpl::setStyleSheet(const DOM::DOMString &url, const DOM::DOMString &sheet)
+void CSSImportRuleImpl::setStyleSheet(const DOM::DOMString &url, const DOM::DOMString &sheet, const DOM::DOMString &charset)
 {
     if ( m_styleSheet ) {
         m_styleSheet->setParent(0);
         m_styleSheet->deref();
     }
     m_styleSheet = new CSSStyleSheetImpl(this, url);
+    m_styleSheet->setCharset(charset);
     m_styleSheet->ref();
 
     CSSStyleSheetImpl *parent = parentStyleSheet();
@@ -199,8 +200,7 @@
         if ( absHref == parent->baseURL().url() )
             return;
 
-    // ### pass correct charset here!!
-    m_cachedSheet = docLoader->requestStyleSheet(absHref, QString::null);
+    m_cachedSheet = docLoader->requestStyleSheet(absHref, parentStyleSheet()->charset().string());
 
     if (m_cachedSheet)
     {
Index: khtml/css/cssproperties.c
===================================================================
--- khtml/css/cssproperties.c	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/css/cssproperties.c	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -40,7 +40,7 @@
 };
 
 static const struct props * findProp (register const char *str, register unsigned int len);
-/* maximum key range = 350, duplicates = 0 */
+/* maximum key range = 489, duplicates = 0 */
 
 #ifdef __GNUC__
 __inline
@@ -54,32 +54,32 @@
 {
   static const unsigned short asso_values[] =
     {
-      353, 353, 353, 353, 353, 353, 353, 353, 353, 353,
-      353, 353, 353, 353, 353, 353, 353, 353, 353, 353,
-      353, 353, 353, 353, 353, 353, 353, 353, 353, 353,
-      353, 353, 353, 353, 353, 353, 353, 353, 353, 353,
-      353, 353, 353, 353, 353,   0, 353, 353, 353, 353,
-      353,   0, 353, 353, 353, 353, 353, 353, 353, 353,
-      353, 353, 353, 353, 353, 353, 353, 353, 353, 353,
-      353, 353, 353, 353, 353, 353, 353, 353, 353, 353,
-      353, 353, 353, 353, 353, 353, 353, 353, 353, 353,
-      353, 353, 353, 353, 353, 353, 353,  30,   0,   5,
-        5,  10,  45,   0,   0,   0, 353,  60,   0,   0,
-       15,   0,   0,   5,   0,  20,   0, 115,  80, 100,
-       25,  45,  55, 353, 353, 353, 353, 353, 353, 353,
-      353, 353, 353, 353, 353, 353, 353, 353, 353, 353,
-      353, 353, 353, 353, 353, 353, 353, 353, 353, 353,
-      353, 353, 353, 353, 353, 353, 353, 353, 353, 353,
-      353, 353, 353, 353, 353, 353, 353, 353, 353, 353,
-      353, 353, 353, 353, 353, 353, 353, 353, 353, 353,
-      353, 353, 353, 353, 353, 353, 353, 353, 353, 353,
-      353, 353, 353, 353, 353, 353, 353, 353, 353, 353,
-      353, 353, 353, 353, 353, 353, 353, 353, 353, 353,
-      353, 353, 353, 353, 353, 353, 353, 353, 353, 353,
-      353, 353, 353, 353, 353, 353, 353, 353, 353, 353,
-      353, 353, 353, 353, 353, 353, 353, 353, 353, 353,
-      353, 353, 353, 353, 353, 353, 353, 353, 353, 353,
-      353, 353, 353, 353, 353, 353
+      492, 492, 492, 492, 492, 492, 492, 492, 492, 492,
+      492, 492, 492, 492, 492, 492, 492, 492, 492, 492,
+      492, 492, 492, 492, 492, 492, 492, 492, 492, 492,
+      492, 492, 492, 492, 492, 492, 492, 492, 492, 492,
+      492, 492, 492, 492, 492,   0, 492, 492, 492, 492,
+      492,   0, 492, 492, 492, 492, 492, 492, 492, 492,
+      492, 492, 492, 492, 492, 492, 492, 492, 492, 492,
+      492, 492, 492, 492, 492, 492, 492, 492, 492, 492,
+      492, 492, 492, 492, 492, 492, 492, 492, 492, 492,
+      492, 492, 492, 492, 492, 492, 492,  30,   0,   5,
+        5,  10, 155,   0,   0,   0, 492,   0,   0,   0,
+       15,   0,   0,  65,   0,  20,   0,  50,   5, 165,
+       80, 125, 120, 492, 492, 492, 492, 492, 492, 492,
+      492, 492, 492, 492, 492, 492, 492, 492, 492, 492,
+      492, 492, 492, 492, 492, 492, 492, 492, 492, 492,
+      492, 492, 492, 492, 492, 492, 492, 492, 492, 492,
+      492, 492, 492, 492, 492, 492, 492, 492, 492, 492,
+      492, 492, 492, 492, 492, 492, 492, 492, 492, 492,
+      492, 492, 492, 492, 492, 492, 492, 492, 492, 492,
+      492, 492, 492, 492, 492, 492, 492, 492, 492, 492,
+      492, 492, 492, 492, 492, 492, 492, 492, 492, 492,
+      492, 492, 492, 492, 492, 492, 492, 492, 492, 492,
+      492, 492, 492, 492, 492, 492, 492, 492, 492, 492,
+      492, 492, 492, 492, 492, 492, 492, 492, 492, 492,
+      492, 492, 492, 492, 492, 492, 492, 492, 492, 492,
+      492, 492, 492, 492, 492, 492
     };
   register int hval = len;
 
@@ -193,259 +193,265 @@
 {
   enum
     {
-      TOTAL_KEYWORDS = 122,
+      TOTAL_KEYWORDS = 125,
       MIN_WORD_LENGTH = 3,
       MAX_WORD_LENGTH = 32,
       MIN_HASH_VALUE = 3,
-      MAX_HASH_VALUE = 352
+      MAX_HASH_VALUE = 491
     };
 
   static const struct props wordlist_prop[] =
     {
-#line 102 "cssproperties.gperf"
+#line 105 "cssproperties.gperf"
       {"top", CSS_PROP_TOP},
-#line 94 "cssproperties.gperf"
+#line 97 "cssproperties.gperf"
       {"right", CSS_PROP_RIGHT},
-#line 37 "cssproperties.gperf"
+#line 40 "cssproperties.gperf"
       {"bottom", CSS_PROP_BOTTOM},
-#line 40 "cssproperties.gperf"
+#line 43 "cssproperties.gperf"
       {"clip", CSS_PROP_CLIP},
-#line 41 "cssproperties.gperf"
+#line 44 "cssproperties.gperf"
       {"color", CSS_PROP_COLOR},
-#line 55 "cssproperties.gperf"
+#line 58 "cssproperties.gperf"
       {"height", CSS_PROP_HEIGHT},
-#line 112 "cssproperties.gperf"
+#line 115 "cssproperties.gperf"
       {"border", CSS_PROP_BORDER},
-#line 115 "cssproperties.gperf"
+#line 118 "cssproperties.gperf"
       {"border-top", CSS_PROP_BORDER_TOP},
-#line 116 "cssproperties.gperf"
+#line 119 "cssproperties.gperf"
       {"border-right", CSS_PROP_BORDER_RIGHT},
-#line 117 "cssproperties.gperf"
+#line 120 "cssproperties.gperf"
       {"border-bottom", CSS_PROP_BORDER_BOTTOM},
-#line 113 "cssproperties.gperf"
+#line 116 "cssproperties.gperf"
       {"border-color", CSS_PROP_BORDER_COLOR},
-#line 75 "cssproperties.gperf"
+#line 78 "cssproperties.gperf"
       {"min-height", CSS_PROP_MIN_HEIGHT},
-#line 25 "cssproperties.gperf"
+#line 28 "cssproperties.gperf"
       {"border-top-color", CSS_PROP_BORDER_TOP_COLOR},
-#line 26 "cssproperties.gperf"
+#line 29 "cssproperties.gperf"
       {"border-right-color", CSS_PROP_BORDER_RIGHT_COLOR},
-#line 27 "cssproperties.gperf"
+#line 30 "cssproperties.gperf"
       {"border-bottom-color", CSS_PROP_BORDER_BOTTOM_COLOR},
-#line 92 "cssproperties.gperf"
+#line 95 "cssproperties.gperf"
       {"position", CSS_PROP_POSITION},
-#line 46 "cssproperties.gperf"
+#line 49 "cssproperties.gperf"
       {"direction", CSS_PROP_DIRECTION},
-#line 58 "cssproperties.gperf"
+#line 61 "cssproperties.gperf"
       {"line-height", CSS_PROP_LINE_HEIGHT},
-#line 39 "cssproperties.gperf"
+#line 42 "cssproperties.gperf"
       {"clear", CSS_PROP_CLEAR},
-#line 123 "cssproperties.gperf"
+#line 126 "cssproperties.gperf"
       {"margin", CSS_PROP_MARGIN},
-#line 42 "cssproperties.gperf"
+#line 45 "cssproperties.gperf"
       {"content", CSS_PROP_CONTENT},
-#line 62 "cssproperties.gperf"
+#line 65 "cssproperties.gperf"
       {"margin-top", CSS_PROP_MARGIN_TOP},
-#line 63 "cssproperties.gperf"
+#line 66 "cssproperties.gperf"
       {"margin-right", CSS_PROP_MARGIN_RIGHT},
-#line 64 "cssproperties.gperf"
+#line 67 "cssproperties.gperf"
       {"margin-bottom", CSS_PROP_MARGIN_BOTTOM},
-#line 56 "cssproperties.gperf"
-      {"left", CSS_PROP_LEFT},
-#line 125 "cssproperties.gperf"
+#line 128 "cssproperties.gperf"
       {"padding", CSS_PROP_PADDING},
-#line 121 "cssproperties.gperf"
-      {"font", CSS_PROP_FONT},
-#line 84 "cssproperties.gperf"
+#line 87 "cssproperties.gperf"
       {"padding-top", CSS_PROP_PADDING_TOP},
-#line 85 "cssproperties.gperf"
+#line 88 "cssproperties.gperf"
       {"padding-right", CSS_PROP_PADDING_RIGHT},
-#line 86 "cssproperties.gperf"
+#line 89 "cssproperties.gperf"
       {"padding-bottom", CSS_PROP_PADDING_BOTTOM},
-#line 77 "cssproperties.gperf"
+#line 80 "cssproperties.gperf"
       {"orphans", CSS_PROP_ORPHANS},
-#line 73 "cssproperties.gperf"
-      {"max-height", CSS_PROP_MAX_HEIGHT},
-#line 49 "cssproperties.gperf"
-      {"float", CSS_PROP_FLOAT},
-#line 118 "cssproperties.gperf"
-      {"border-left", CSS_PROP_BORDER_LEFT},
-#line 129 "cssproperties.gperf"
+#line 48 "cssproperties.gperf"
+      {"cursor", CSS_PROP_CURSOR},
+#line 127 "cssproperties.gperf"
+      {"outline", CSS_PROP_OUTLINE},
+#line 132 "cssproperties.gperf"
       {"scrollbar-highlight-color", CSS_PROP_SCROLLBAR_HIGHLIGHT_COLOR},
-#line 78 "cssproperties.gperf"
-      {"opacity", CSS_PROP_OPACITY},
-#line 130 "cssproperties.gperf"
+#line 133 "cssproperties.gperf"
       {"scrollbar-3dlight-color", CSS_PROP_SCROLLBAR_3DLIGHT_COLOR},
-#line 95 "cssproperties.gperf"
-      {"size", CSS_PROP_SIZE},
-#line 97 "cssproperties.gperf"
-      {"text-align", CSS_PROP_TEXT_ALIGN},
-#line 99 "cssproperties.gperf"
-      {"text-indent", CSS_PROP_TEXT_INDENT},
-#line 28 "cssproperties.gperf"
-      {"border-left-color", CSS_PROP_BORDER_LEFT_COLOR},
-#line 21 "cssproperties.gperf"
+#line 82 "cssproperties.gperf"
+      {"outline-color", CSS_PROP_OUTLINE_COLOR},
+#line 24 "cssproperties.gperf"
       {"border-collapse", CSS_PROP_BORDER_COLLAPSE},
-#line 38 "cssproperties.gperf"
+#line 41 "cssproperties.gperf"
       {"caption-side", CSS_PROP_CAPTION_SIDE},
+#line 25 "cssproperties.gperf"
+      {"border-spacing", CSS_PROP_BORDER_SPACING},
+#line 106 "cssproperties.gperf"
+      {"unicode-bidi", CSS_PROP_UNICODE_BIDI},
+#line 60 "cssproperties.gperf"
+      {"letter-spacing", CSS_PROP_LETTER_SPACING},
+#line 107 "cssproperties.gperf"
+      {"vertical-align", CSS_PROP_VERTICAL_ALIGN},
+#line 69 "cssproperties.gperf"
+      {"-khtml-margin-start", CSS_PROP__KHTML_MARGIN_START},
+#line 114 "cssproperties.gperf"
+      {"background", CSS_PROP_BACKGROUND},
+#line 135 "cssproperties.gperf"
+      {"scrollbar-track-color", CSS_PROP_SCROLLBAR_TRACK_COLOR},
+#line 91 "cssproperties.gperf"
+      {"-khtml-padding-start", CSS_PROP__KHTML_PADDING_START},
+#line 14 "cssproperties.gperf"
+      {"background-color", CSS_PROP_BACKGROUND_COLOR},
+#line 76 "cssproperties.gperf"
+      {"max-height", CSS_PROP_MAX_HEIGHT},
+#line 21 "cssproperties.gperf"
+      {"-khtml-background-clip", CSS_PROP__KHTML_BACKGROUND_CLIP},
+#line 47 "cssproperties.gperf"
+      {"counter-reset", CSS_PROP_COUNTER_RESET},
+#line 129 "cssproperties.gperf"
+      {"scrollbar-base-color", CSS_PROP_SCROLLBAR_BASE_COLOR},
 #line 22 "cssproperties.gperf"
-      {"border-spacing", CSS_PROP_BORDER_SPACING},
-#line 48 "cssproperties.gperf"
+      {"-khtml-background-origin", CSS_PROP__KHTML_BACKGROUND_ORIGIN},
+#line 100 "cssproperties.gperf"
+      {"text-align", CSS_PROP_TEXT_ALIGN},
+#line 102 "cssproperties.gperf"
+      {"text-indent", CSS_PROP_TEXT_INDENT},
+#line 94 "cssproperties.gperf"
+      {"page-break-inside", CSS_PROP_PAGE_BREAK_INSIDE},
+#line 96 "cssproperties.gperf"
+      {"quotes", CSS_PROP_QUOTES},
+#line 46 "cssproperties.gperf"
+      {"counter-increment", CSS_PROP_COUNTER_INCREMENT},
+#line 98 "cssproperties.gperf"
+      {"size", CSS_PROP_SIZE},
+#line 18 "cssproperties.gperf"
+      {"background-position", CSS_PROP_BACKGROUND_POSITION},
+#line 108 "cssproperties.gperf"
+      {"visibility", CSS_PROP_VISIBILITY},
+#line 15 "cssproperties.gperf"
+      {"background-image", CSS_PROP_BACKGROUND_IMAGE},
+#line 138 "cssproperties.gperf"
+      {"-khtml-user-input", CSS_PROP__KHTML_USER_INPUT},
+#line 27 "cssproperties.gperf"
+      {"-khtml-border-vertical-spacing", CSS_PROP__KHTML_BORDER_VERTICAL_SPACING},
+#line 81 "cssproperties.gperf"
+      {"opacity", CSS_PROP_OPACITY},
+#line 59 "cssproperties.gperf"
+      {"left", CSS_PROP_LEFT},
+#line 101 "cssproperties.gperf"
+      {"text-decoration", CSS_PROP_TEXT_DECORATION},
+#line 16 "cssproperties.gperf"
+      {"background-repeat", CSS_PROP_BACKGROUND_REPEAT},
+#line 124 "cssproperties.gperf"
+      {"font", CSS_PROP_FONT},
+#line 111 "cssproperties.gperf"
+      {"width", CSS_PROP_WIDTH},
+#line 70 "cssproperties.gperf"
+      {"-khtml-marquee", CSS_PROP__KHTML_MARQUEE},
+#line 51 "cssproperties.gperf"
       {"empty-cells", CSS_PROP_EMPTY_CELLS},
-#line 114 "cssproperties.gperf"
+#line 117 "cssproperties.gperf"
       {"border-style", CSS_PROP_BORDER_STYLE},
-#line 57 "cssproperties.gperf"
-      {"letter-spacing", CSS_PROP_LETTER_SPACING},
-#line 122 "cssproperties.gperf"
+#line 125 "cssproperties.gperf"
       {"list-style", CSS_PROP_LIST_STYLE},
-#line 29 "cssproperties.gperf"
+#line 32 "cssproperties.gperf"
       {"border-top-style", CSS_PROP_BORDER_TOP_STYLE},
-#line 47 "cssproperties.gperf"
+#line 50 "cssproperties.gperf"
       {"display", CSS_PROP_DISPLAY},
-#line 30 "cssproperties.gperf"
+#line 33 "cssproperties.gperf"
       {"border-right-style", CSS_PROP_BORDER_RIGHT_STYLE},
-#line 31 "cssproperties.gperf"
+#line 34 "cssproperties.gperf"
       {"border-bottom-style", CSS_PROP_BORDER_BOTTOM_STYLE},
-#line 108 "cssproperties.gperf"
-      {"width", CSS_PROP_WIDTH},
-#line 65 "cssproperties.gperf"
-      {"margin-left", CSS_PROP_MARGIN_LEFT},
-#line 98 "cssproperties.gperf"
-      {"text-decoration", CSS_PROP_TEXT_DECORATION},
-#line 110 "cssproperties.gperf"
-      {"z-index", CSS_PROP_Z_INDEX},
-#line 87 "cssproperties.gperf"
-      {"padding-left", CSS_PROP_PADDING_LEFT},
-#line 120 "cssproperties.gperf"
-      {"box-sizing", CSS_PROP_BOX_SIZING},
-#line 76 "cssproperties.gperf"
+#line 52 "cssproperties.gperf"
+      {"float", CSS_PROP_FLOAT},
+#line 121 "cssproperties.gperf"
+      {"border-left", CSS_PROP_BORDER_LEFT},
+#line 79 "cssproperties.gperf"
       {"min-width", CSS_PROP_MIN_WIDTH},
-#line 119 "cssproperties.gperf"
+#line 122 "cssproperties.gperf"
       {"border-width", CSS_PROP_BORDER_WIDTH},
-#line 33 "cssproperties.gperf"
+#line 36 "cssproperties.gperf"
       {"border-top-width", CSS_PROP_BORDER_TOP_WIDTH},
-#line 34 "cssproperties.gperf"
+#line 31 "cssproperties.gperf"
+      {"border-left-color", CSS_PROP_BORDER_LEFT_COLOR},
+#line 37 "cssproperties.gperf"
       {"border-right-width", CSS_PROP_BORDER_RIGHT_WIDTH},
-#line 35 "cssproperties.gperf"
+#line 38 "cssproperties.gperf"
       {"border-bottom-width", CSS_PROP_BORDER_BOTTOM_WIDTH},
-#line 126 "cssproperties.gperf"
-      {"scrollbar-base-color", CSS_PROP_SCROLLBAR_BASE_COLOR},
-#line 52 "cssproperties.gperf"
-      {"font-style", CSS_PROP_FONT_STYLE},
-#line 45 "cssproperties.gperf"
-      {"cursor", CSS_PROP_CURSOR},
-#line 124 "cssproperties.gperf"
-      {"outline", CSS_PROP_OUTLINE},
-#line 60 "cssproperties.gperf"
+#line 17 "cssproperties.gperf"
+      {"background-attachment", CSS_PROP_BACKGROUND_ATTACHMENT},
+#line 68 "cssproperties.gperf"
+      {"margin-left", CSS_PROP_MARGIN_LEFT},
+#line 71 "cssproperties.gperf"
+      {"-khtml-marquee-direction", CSS_PROP__KHTML_MARQUEE_DIRECTION},
+#line 73 "cssproperties.gperf"
+      {"-khtml-marquee-repetition", CSS_PROP__KHTML_MARQUEE_REPETITION},
+#line 63 "cssproperties.gperf"
       {"list-style-position", CSS_PROP_LIST_STYLE_POSITION},
-#line 59 "cssproperties.gperf"
+#line 74 "cssproperties.gperf"
+      {"-khtml-marquee-speed", CSS_PROP__KHTML_MARQUEE_SPEED},
+#line 62 "cssproperties.gperf"
       {"list-style-image", CSS_PROP_LIST_STYLE_IMAGE},
-#line 51 "cssproperties.gperf"
-      {"font-size", CSS_PROP_FONT_SIZE},
-#line 105 "cssproperties.gperf"
-      {"visibility", CSS_PROP_VISIBILITY},
-#line 93 "cssproperties.gperf"
-      {"quotes", CSS_PROP_QUOTES},
-#line 79 "cssproperties.gperf"
-      {"outline-color", CSS_PROP_OUTLINE_COLOR},
-#line 101 "cssproperties.gperf"
-      {"text-transform", CSS_PROP_TEXT_TRANSFORM},
-#line 32 "cssproperties.gperf"
-      {"border-left-style", CSS_PROP_BORDER_LEFT_STYLE},
-#line 61 "cssproperties.gperf"
-      {"list-style-type", CSS_PROP_LIST_STYLE_TYPE},
-#line 103 "cssproperties.gperf"
-      {"unicode-bidi", CSS_PROP_UNICODE_BIDI},
-#line 74 "cssproperties.gperf"
-      {"max-width", CSS_PROP_MAX_WIDTH},
-#line 127 "cssproperties.gperf"
-      {"scrollbar-face-color", CSS_PROP_SCROLLBAR_FACE_COLOR},
-#line 66 "cssproperties.gperf"
-      {"-khtml-margin-start", CSS_PROP__KHTML_MARGIN_START},
-#line 132 "cssproperties.gperf"
-      {"scrollbar-track-color", CSS_PROP_SCROLLBAR_TRACK_COLOR},
-#line 54 "cssproperties.gperf"
-      {"font-weight", CSS_PROP_FONT_WEIGHT},
-#line 104 "cssproperties.gperf"
-      {"vertical-align", CSS_PROP_VERTICAL_ALIGN},
-#line 88 "cssproperties.gperf"
-      {"-khtml-padding-start", CSS_PROP__KHTML_PADDING_START},
-#line 106 "cssproperties.gperf"
+#line 90 "cssproperties.gperf"
+      {"padding-left", CSS_PROP_PADDING_LEFT},
+#line 113 "cssproperties.gperf"
+      {"z-index", CSS_PROP_Z_INDEX},
+#line 19 "cssproperties.gperf"
+      {"background-position-x", CSS_PROP_BACKGROUND_POSITION_X},
+#line 84 "cssproperties.gperf"
+      {"outline-style", CSS_PROP_OUTLINE_STYLE},
+#line 72 "cssproperties.gperf"
+      {"-khtml-marquee-increment", CSS_PROP__KHTML_MARQUEE_INCREMENT},
+#line 123 "cssproperties.gperf"
+      {"box-sizing", CSS_PROP_BOX_SIZING},
+#line 109 "cssproperties.gperf"
       {"white-space", CSS_PROP_WHITE_SPACE},
-#line 109 "cssproperties.gperf"
+#line 112 "cssproperties.gperf"
       {"word-spacing", CSS_PROP_WORD_SPACING},
-#line 50 "cssproperties.gperf"
-      {"font-family", CSS_PROP_FONT_FAMILY},
-#line 36 "cssproperties.gperf"
-      {"border-left-width", CSS_PROP_BORDER_LEFT_WIDTH},
-#line 44 "cssproperties.gperf"
-      {"counter-reset", CSS_PROP_COUNTER_RESET},
-#line 100 "cssproperties.gperf"
-      {"text-shadow", CSS_PROP_TEXT_SHADOW},
-#line 91 "cssproperties.gperf"
-      {"page-break-inside", CSS_PROP_PAGE_BREAK_INSIDE},
-#line 133 "cssproperties.gperf"
-      {"scrollbar-arrow-color", CSS_PROP_SCROLLBAR_ARROW_COLOR},
-#line 43 "cssproperties.gperf"
-      {"counter-increment", CSS_PROP_COUNTER_INCREMENT},
-#line 90 "cssproperties.gperf"
-      {"page-break-before", CSS_PROP_PAGE_BREAK_BEFORE},
-#line 53 "cssproperties.gperf"
-      {"font-variant", CSS_PROP_FONT_VARIANT},
-#line 81 "cssproperties.gperf"
-      {"outline-style", CSS_PROP_OUTLINE_STYLE},
-#line 107 "cssproperties.gperf"
-      {"widows", CSS_PROP_WIDOWS},
-#line 134 "cssproperties.gperf"
-      {"-khtml-flow-mode", CSS_PROP__KHTML_FLOW_MODE},
-#line 128 "cssproperties.gperf"
-      {"scrollbar-shadow-color", CSS_PROP_SCROLLBAR_SHADOW_COLOR},
-#line 111 "cssproperties.gperf"
-      {"background", CSS_PROP_BACKGROUND},
-#line 89 "cssproperties.gperf"
-      {"page-break-after", CSS_PROP_PAGE_BREAK_AFTER},
-#line 96 "cssproperties.gperf"
+#line 99 "cssproperties.gperf"
       {"table-layout", CSS_PROP_TABLE_LAYOUT},
-#line 83 "cssproperties.gperf"
-      {"overflow", CSS_PROP_OVERFLOW},
-#line 67 "cssproperties.gperf"
-      {"-khtml-marquee", CSS_PROP__KHTML_MARQUEE},
-#line 14 "cssproperties.gperf"
-      {"background-color", CSS_PROP_BACKGROUND_COLOR},
-#line 82 "cssproperties.gperf"
+#line 85 "cssproperties.gperf"
       {"outline-width", CSS_PROP_OUTLINE_WIDTH},
-#line 80 "cssproperties.gperf"
-      {"outline-offset", CSS_PROP_OUTLINE_OFFSET},
+#line 56 "cssproperties.gperf"
+      {"font-variant", CSS_PROP_FONT_VARIANT},
+#line 93 "cssproperties.gperf"
+      {"page-break-before", CSS_PROP_PAGE_BREAK_BEFORE},
+#line 136 "cssproperties.gperf"
+      {"scrollbar-arrow-color", CSS_PROP_SCROLLBAR_ARROW_COLOR},
 #line 23 "cssproperties.gperf"
+      {"-khtml-background-size", CSS_PROP__KHTML_BACKGROUND_SIZE},
+#line 130 "cssproperties.gperf"
+      {"scrollbar-face-color", CSS_PROP_SCROLLBAR_FACE_COLOR},
+#line 26 "cssproperties.gperf"
       {"-khtml-border-horizontal-spacing", CSS_PROP__KHTML_BORDER_HORIZONTAL_SPACING},
-#line 18 "cssproperties.gperf"
-      {"background-position", CSS_PROP_BACKGROUND_POSITION},
-#line 15 "cssproperties.gperf"
-      {"background-image", CSS_PROP_BACKGROUND_IMAGE},
-#line 68 "cssproperties.gperf"
-      {"-khtml-marquee-direction", CSS_PROP__KHTML_MARQUEE_DIRECTION},
-#line 70 "cssproperties.gperf"
-      {"-khtml-marquee-repetition", CSS_PROP__KHTML_MARQUEE_REPETITION},
-#line 71 "cssproperties.gperf"
-      {"-khtml-marquee-speed", CSS_PROP__KHTML_MARQUEE_SPEED},
-#line 16 "cssproperties.gperf"
-      {"background-repeat", CSS_PROP_BACKGROUND_REPEAT},
-#line 24 "cssproperties.gperf"
-      {"-khtml-border-vertical-spacing", CSS_PROP__KHTML_BORDER_VERTICAL_SPACING},
-#line 69 "cssproperties.gperf"
-      {"-khtml-marquee-increment", CSS_PROP__KHTML_MARQUEE_INCREMENT},
-#line 19 "cssproperties.gperf"
-      {"background-position-x", CSS_PROP_BACKGROUND_POSITION_X},
-#line 72 "cssproperties.gperf"
-      {"-khtml-marquee-style", CSS_PROP__KHTML_MARQUEE_STYLE},
 #line 20 "cssproperties.gperf"
       {"background-position-y", CSS_PROP_BACKGROUND_POSITION_Y},
+#line 77 "cssproperties.gperf"
+      {"max-width", CSS_PROP_MAX_WIDTH},
+#line 92 "cssproperties.gperf"
+      {"page-break-after", CSS_PROP_PAGE_BREAK_AFTER},
 #line 131 "cssproperties.gperf"
+      {"scrollbar-shadow-color", CSS_PROP_SCROLLBAR_SHADOW_COLOR},
+#line 103 "cssproperties.gperf"
+      {"text-shadow", CSS_PROP_TEXT_SHADOW},
+#line 104 "cssproperties.gperf"
+      {"text-transform", CSS_PROP_TEXT_TRANSFORM},
+#line 64 "cssproperties.gperf"
+      {"list-style-type", CSS_PROP_LIST_STYLE_TYPE},
+#line 54 "cssproperties.gperf"
+      {"font-size", CSS_PROP_FONT_SIZE},
+#line 55 "cssproperties.gperf"
+      {"font-style", CSS_PROP_FONT_STYLE},
+#line 75 "cssproperties.gperf"
+      {"-khtml-marquee-style", CSS_PROP__KHTML_MARQUEE_STYLE},
+#line 134 "cssproperties.gperf"
       {"scrollbar-darkshadow-color", CSS_PROP_SCROLLBAR_DARKSHADOW_COLOR},
-#line 17 "cssproperties.gperf"
-      {"background-attachment", CSS_PROP_BACKGROUND_ATTACHMENT},
-#line 135 "cssproperties.gperf"
-      {"-khtml-user-input", CSS_PROP__KHTML_USER_INPUT}
+#line 86 "cssproperties.gperf"
+      {"overflow", CSS_PROP_OVERFLOW},
+#line 137 "cssproperties.gperf"
+      {"-khtml-flow-mode", CSS_PROP__KHTML_FLOW_MODE},
+#line 35 "cssproperties.gperf"
+      {"border-left-style", CSS_PROP_BORDER_LEFT_STYLE},
+#line 57 "cssproperties.gperf"
+      {"font-weight", CSS_PROP_FONT_WEIGHT},
+#line 110 "cssproperties.gperf"
+      {"widows", CSS_PROP_WIDOWS},
+#line 39 "cssproperties.gperf"
+      {"border-left-width", CSS_PROP_BORDER_LEFT_WIDTH},
+#line 83 "cssproperties.gperf"
+      {"outline-offset", CSS_PROP_OUTLINE_OFFSET},
+#line 53 "cssproperties.gperf"
+      {"font-family", CSS_PROP_FONT_FAMILY}
     };
 
   static const signed char lookup[] =
@@ -455,37 +461,51 @@
        -1,   6,  -1,  -1,  -1,   7,  -1,   8,   9,  -1,
        -1,  -1,  10,  -1,  -1,  11,  12,  -1,  13,  14,
        -1,  -1,  -1,  15,  16,  -1,  17,  -1,  -1,  -1,
-       18,  19,  20,  -1,  -1,  21,  -1,  22,  23,  24,
-       -1,  -1,  25,  -1,  26,  -1,  27,  -1,  28,  29,
-       -1,  -1,  30,  -1,  -1,  31,  -1,  -1,  -1,  -1,
-       32,  33,  -1,  -1,  -1,  34,  -1,  35,  36,  37,
-       38,  39,  40,  -1,  -1,  41,  -1,  42,  -1,  43,
-       -1,  44,  45,  -1,  46,  47,  48,  49,  50,  51,
-       52,  53,  -1,  -1,  -1,  54,  -1,  55,  -1,  -1,
-       -1,  -1,  56,  -1,  -1,  57,  -1,  -1,  -1,  58,
-       -1,  -1,  59,  -1,  -1,  -1,  60,  -1,  61,  62,
-       63,  -1,  -1,  -1,  -1,  64,  65,  66,  -1,  67,
-       -1,  68,  -1,  -1,  69,  70,  71,  -1,  72,  73,
-       -1,  -1,  74,  -1,  -1,  75,  -1,  76,  -1,  77,
-       78,  -1,  -1,  -1,  79,  -1,  80,  -1,  -1,  -1,
-       -1,  81,  -1,  -1,  82,  83,  84,  85,  -1,  -1,
-       -1,  86,  87,  -1,  -1,  -1,  -1,  -1,  88,  -1,
-       -1,  89,  -1,  -1,  -1,  -1,  -1,  90,  -1,  -1,
-       -1,  91,  -1,  -1,  -1,  -1,  -1,  92,  -1,  -1,
-       -1,  -1,  93,  -1,  -1,  -1,  -1,  94,  95,  -1,
-       -1,  96,  -1,  -1,  -1,  -1,  97,  98,  -1,  -1,
-       99, 100, 101, 102, 103,  -1,  -1,  -1,  -1,  -1,
-       -1, 104,  -1,  -1,  -1,  -1,  -1,  -1, 105,  -1,
+       18,  19,  20,  -1,  -1,  21,  -1,  22,  23,  -1,
+       -1,  -1,  24,  -1,  -1,  -1,  25,  -1,  26,  27,
+       -1,  -1,  28,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  29,  30,  -1,  -1,  31,  -1,  -1,  32,  -1,
+       -1,  -1,  -1,  33,  -1,  34,  -1,  35,  -1,  36,
+       -1,  -1,  37,  -1,  38,  -1,  -1,  -1,  -1,  39,
+       -1,  -1,  -1,  -1,  40,  41,  42,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  43,  44,  -1,  -1,  -1,
+       45,  -1,  46,  47,  -1,  -1,  -1,  -1,  -1,  -1,
+       48,  -1,  -1,  -1,  49,  50,  51,  52,  -1,  -1,
+       -1,  53,  54,  -1,  55,  -1,  -1,  -1,  -1,  56,
+       57,  58,  59,  -1,  -1,  60,  -1,  61,  -1,  62,
+       63,  -1,  64,  -1,  65,  66,  -1,  -1,  -1,  67,
+       -1,  68,  69,  -1,  -1,  70,  71,  72,  73,  74,
+       75,  76,  -1,  -1,  77,  -1,  -1,  78,  -1,  -1,
+       -1,  79,  80,  81,  82,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  83,  -1,  -1,  -1,
+       -1,  84,  -1,  -1,  85,  86,  -1,  -1,  -1,  87,
+       88,  89,  90,  -1,  -1,  -1,  -1,  91,  -1,  -1,
+       -1,  92,  -1,  93,  94,  95,  -1,  -1,  -1,  -1,
+       -1,  96,  97,  -1,  -1,  -1,  -1,  98,  99,  -1,
+       -1,  -1, 100,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1, 101,  -1,  -1,  -1, 102, 103,  -1,  -1,
+      104,  -1, 105,  -1,  -1,  -1, 106,  -1,  -1, 107,
+       -1, 108,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1, 109,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1, 106,  -1,  -1, 107,  -1,  -1,
-       -1,  -1,  -1,  -1, 108,  -1, 109,  -1,  -1, 110,
-      111,  -1,  -1,  -1,  -1, 112,  -1, 113,  -1,  -1,
-      114,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 115,
-       -1, 116,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1, 117,  -1,  -1,  -1,  -1,
-       -1, 118,  -1,  -1,  -1,  -1, 119,  -1,  -1,  -1,
-       -1, 120,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1, 121
+       -1, 110,  -1,  -1, 111, 112,  -1,  -1,  -1, 113,
+       -1,  -1,  -1,  -1,  -1, 114,  -1,  -1,  -1,  -1,
+      115, 116,  -1, 117,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1, 118, 119,  -1,  -1,  -1, 120,  -1,  -1,  -1,
+       -1, 121,  -1,  -1,  -1,  -1,  -1, 122,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 123,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1, 124
     };
 
   if (len <= MAX_WORD_LENGTH && len >= MIN_WORD_LENGTH)
@@ -507,7 +527,7 @@
     }
   return 0;
 }
-#line 136 "cssproperties.gperf"
+#line 139 "cssproperties.gperf"
 
 static const char * const propertyList[] = {
 "",
@@ -518,6 +538,9 @@
 "background-position", 
 "background-position-x", 
 "background-position-y", 
+"-khtml-background-clip", 
+"-khtml-background-origin", 
+"-khtml-background-size", 
 "border-collapse", 
 "border-spacing", 
 "-khtml-border-horizontal-spacing", 
Index: khtml/css/cssvalues.c
===================================================================
--- khtml/css/cssvalues.c	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/css/cssvalues.c	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -40,7 +40,7 @@
 };
 
 static const css_value* findValue (register const char *str, register unsigned int len);
-/* maximum key range = 2971, duplicates = 0 */
+/* maximum key range = 3056, duplicates = 0 */
 
 #ifdef __GNUC__
 __inline
@@ -54,32 +54,32 @@
 {
   static const unsigned short asso_values[] =
     {
-      2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971,
-      2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971,
-      2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971,
-      2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971,
-      2971, 2971, 2971, 2971, 2971,  265,  175, 2971,    0,    0,
-        95,   90,   85,   75,   50,   25,   20,    5, 2971, 2971,
-      2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971,
-      2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971,
-      2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971,
-      2971, 2971, 2971, 2971, 2971, 2971, 2971,   75,   20,  105,
-         0,    0,  475,  345,  245,    5,   23,  230,   20,   35,
-         5,   15,  145,  460,  145,  150,    0,   30,  198,   23,
-         3,  268,  325, 2971, 2971, 2971, 2971, 2971, 2971, 2971,
-      2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971,
-      2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971,
-      2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971,
-      2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971,
-      2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971,
-      2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971,
-      2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971,
-      2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971,
-      2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971,
-      2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971,
-      2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971,
-      2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971, 2971,
-      2971, 2971, 2971, 2971, 2971, 2971, 2971
+      3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056,
+      3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056,
+      3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056,
+      3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056,
+      3056, 3056, 3056, 3056, 3056,  420,  125, 3056,    0,    0,
+       105,  100,   40,   35,   20,   15,   10,    5, 3056, 3056,
+      3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056,
+      3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056,
+      3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056,
+      3056, 3056, 3056, 3056, 3056, 3056, 3056,  175,   60,    0,
+        20,   45,  235,  380,  270,    5,  103,   65,    0,   35,
+         0,    5,  265,  465,  100,   20,    5,  195,  223,   13,
+         3,   68,   10, 3056, 3056, 3056, 3056, 3056, 3056, 3056,
+      3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056,
+      3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056,
+      3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056,
+      3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056,
+      3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056,
+      3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056,
+      3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056,
+      3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056,
+      3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056,
+      3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056,
+      3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056,
+      3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056, 3056,
+      3056, 3056, 3056, 3056, 3056, 3056, 3056
     };
   register int hval = 0;
 
@@ -181,11 +181,11 @@
 {
   enum
     {
-      TOTAL_KEYWORDS = 269,
+      TOTAL_KEYWORDS = 272,
       MIN_WORD_LENGTH = 2,
       MAX_WORD_LENGTH = 28,
       MIN_HASH_VALUE = 0,
-      MAX_HASH_VALUE = 2970
+      MAX_HASH_VALUE = 3055
     };
 
   static const struct css_value wordlist_value[] =
@@ -194,532 +194,538 @@
       {"100", CSS_VAL_100},
 #line 48 "cssvalues.gperf"
       {"900", CSS_VAL_900},
-#line 19 "cssvalues.gperf"
-      {"inset", CSS_VAL_INSET},
-#line 145 "cssvalues.gperf"
-      {"inside", CSS_VAL_INSIDE},
 #line 47 "cssvalues.gperf"
       {"800", CSS_VAL_800},
+#line 46 "cssvalues.gperf"
+      {"700", CSS_VAL_700},
+#line 45 "cssvalues.gperf"
+      {"600", CSS_VAL_600},
+#line 216 "cssvalues.gperf"
+      {"ltr", CSS_VAL_LTR},
 #line 276 "cssvalues.gperf"
       {"down", CSS_VAL_DOWN},
-#line 46 "cssvalues.gperf"
-      {"700", CSS_VAL_700},
+#line 146 "cssvalues.gperf"
+      {"disc", CSS_VAL_DISC},
+#line 44 "cssvalues.gperf"
+      {"500", CSS_VAL_500},
+#line 43 "cssvalues.gperf"
+      {"400", CSS_VAL_400},
+#line 258 "cssvalues.gperf"
+      {"scroll", CSS_VAL_SCROLL},
 #line 83 "cssvalues.gperf"
       {"lime", CSS_VAL_LIME},
 #line 17 "cssvalues.gperf"
       {"none", CSS_VAL_NONE},
-#line 91 "cssvalues.gperf"
-      {"teal", CSS_VAL_TEAL},
-#line 23 "cssvalues.gperf"
-      {"dotted", CSS_VAL_DOTTED},
-#line 45 "cssvalues.gperf"
-      {"600", CSS_VAL_600},
+#line 19 "cssvalues.gperf"
+      {"inset", CSS_VAL_INSET},
+#line 118 "cssvalues.gperf"
+      {"window", CSS_VAL_WINDOW},
+#line 284 "cssvalues.gperf"
+      {"content", CSS_VAL_CONTENT},
+#line 147 "cssvalues.gperf"
+      {"circle", CSS_VAL_CIRCLE},
+#line 33 "cssvalues.gperf"
+      {"italic", CSS_VAL_ITALIC},
+#line 145 "cssvalues.gperf"
+      {"inside", CSS_VAL_INSIDE},
+#line 25 "cssvalues.gperf"
+      {"solid", CSS_VAL_SOLID},
 #line 183 "cssvalues.gperf"
       {"inline", CSS_VAL_INLINE},
-#line 128 "cssvalues.gperf"
-      {"middle", CSS_VAL_MIDDLE},
-#line 249 "cssvalues.gperf"
-      {"level", CSS_VAL_LEVEL},
-#line 269 "cssvalues.gperf"
-      {"enabled", CSS_VAL_ENABLED},
-#line 37 "cssvalues.gperf"
-      {"bold", CSS_VAL_BOLD},
+#line 261 "cssvalues.gperf"
+      {"static", CSS_VAL_STATIC},
 #line 204 "cssvalues.gperf"
       {"move", CSS_VAL_MOVE},
-#line 44 "cssvalues.gperf"
-      {"500", CSS_VAL_500},
-#line 29 "cssvalues.gperf"
-      {"menu", CSS_VAL_MENU},
-#line 118 "cssvalues.gperf"
-      {"window", CSS_VAL_WINDOW},
-#line 111 "cssvalues.gperf"
-      {"menutext", CSS_VAL_MENUTEXT},
-#line 120 "cssvalues.gperf"
-      {"windowtext", CSS_VAL_WINDOWTEXT},
-#line 43 "cssvalues.gperf"
-      {"400", CSS_VAL_400},
 #line 42 "cssvalues.gperf"
       {"300", CSS_VAL_300},
-#line 236 "cssvalues.gperf"
-      {"below", CSS_VAL_BELOW},
+#line 249 "cssvalues.gperf"
+      {"level", CSS_VAL_LEVEL},
 #line 41 "cssvalues.gperf"
       {"200", CSS_VAL_200},
-#line 101 "cssvalues.gperf"
-      {"buttontext", CSS_VAL_BUTTONTEXT},
-#line 52 "cssvalues.gperf"
-      {"medium", CSS_VAL_MEDIUM},
-#line 146 "cssvalues.gperf"
-      {"disc", CSS_VAL_DISC},
-#line 134 "cssvalues.gperf"
-      {"bottom", CSS_VAL_BOTTOM},
-#line 270 "cssvalues.gperf"
-      {"disabled", CSS_VAL_DISABLED},
-#line 214 "cssvalues.gperf"
-      {"wait", CSS_VAL_WAIT},
-#line 127 "cssvalues.gperf"
-      {"baseline", CSS_VAL_BASELINE},
-#line 15 "cssvalues.gperf"
-      {"initial", CSS_VAL_INITIAL},
-#line 151 "cssvalues.gperf"
-      {"decimal", CSS_VAL_DECIMAL},
+#line 254 "cssvalues.gperf"
+      {"mix", CSS_VAL_MIX},
+#line 91 "cssvalues.gperf"
+      {"teal", CSS_VAL_TEAL},
+#line 51 "cssvalues.gperf"
+      {"small", CSS_VAL_SMALL},
+#line 120 "cssvalues.gperf"
+      {"windowtext", CSS_VAL_WINDOWTEXT},
+#line 37 "cssvalues.gperf"
+      {"bold", CSS_VAL_BOLD},
+#line 213 "cssvalues.gperf"
+      {"text", CSS_VAL_TEXT},
+#line 149 "cssvalues.gperf"
+      {"box", CSS_VAL_BOX},
+#line 217 "cssvalues.gperf"
+      {"rtl", CSS_VAL_RTL},
 #line 242 "cssvalues.gperf"
       {"embed", CSS_VAL_EMBED},
-#line 89 "cssvalues.gperf"
-      {"red", CSS_VAL_RED},
-#line 199 "cssvalues.gperf"
-      {"auto", CSS_VAL_AUTO},
-#line 33 "cssvalues.gperf"
-      {"italic", CSS_VAL_ITALIC},
-#line 233 "cssvalues.gperf"
-      {"absolute", CSS_VAL_ABSOLUTE},
+#line 128 "cssvalues.gperf"
+      {"middle", CSS_VAL_MIDDLE},
+#line 252 "cssvalues.gperf"
+      {"lower", CSS_VAL_LOWER},
+#line 236 "cssvalues.gperf"
+      {"below", CSS_VAL_BELOW},
+#line 63 "cssvalues.gperf"
+      {"condensed", CSS_VAL_CONDENSED},
 #line 14 "cssvalues.gperf"
       {"inherit", CSS_VAL_INHERIT},
-#line 216 "cssvalues.gperf"
-      {"ltr", CSS_VAL_LTR},
-#line 59 "cssvalues.gperf"
-      {"wider", CSS_VAL_WIDER},
-#line 275 "cssvalues.gperf"
-      {"up", CSS_VAL_UP},
+#line 93 "cssvalues.gperf"
+      {"yellow", CSS_VAL_YELLOW},
 #line 247 "cssvalues.gperf"
       {"invert", CSS_VAL_INVERT},
-#line 217 "cssvalues.gperf"
-      {"rtl", CSS_VAL_RTL},
-#line 252 "cssvalues.gperf"
-      {"lower", CSS_VAL_LOWER},
+#line 76 "cssvalues.gperf"
+      {"black", CSS_VAL_BLACK},
 #line 280 "cssvalues.gperf"
       {"slide", CSS_VAL_SLIDE},
+#line 89 "cssvalues.gperf"
+      {"red", CSS_VAL_RED},
+#line 139 "cssvalues.gperf"
+      {"center", CSS_VAL_CENTER},
+#line 59 "cssvalues.gperf"
+      {"wider", CSS_VAL_WIDER},
+#line 129 "cssvalues.gperf"
+      {"sub", CSS_VAL_SUB},
 #line 189 "cssvalues.gperf"
       {"table", CSS_VAL_TABLE},
-#line 25 "cssvalues.gperf"
-      {"solid", CSS_VAL_SOLID},
-#line 264 "cssvalues.gperf"
-      {"underline", CSS_VAL_UNDERLINE},
+#line 238 "cssvalues.gperf"
+      {"blink", CSS_VAL_BLINK},
+#line 269 "cssvalues.gperf"
+      {"enabled", CSS_VAL_ENABLED},
+#line 36 "cssvalues.gperf"
+      {"normal", CSS_VAL_NORMAL},
+#line 84 "cssvalues.gperf"
+      {"maroon", CSS_VAL_MAROON},
+#line 251 "cssvalues.gperf"
+      {"loud", CSS_VAL_LOUD},
+#line 283 "cssvalues.gperf"
+      {"border", CSS_VAL_BORDER},
+#line 85 "cssvalues.gperf"
+      {"navy", CSS_VAL_NAVY},
+#line 57 "cssvalues.gperf"
+      {"smaller", CSS_VAL_SMALLER},
+#line 78 "cssvalues.gperf"
+      {"crimson", CSS_VAL_CRIMSON},
 #line 38 "cssvalues.gperf"
       {"bolder", CSS_VAL_BOLDER},
-#line 22 "cssvalues.gperf"
-      {"outset", CSS_VAL_OUTSET},
-#line 144 "cssvalues.gperf"
-      {"outside", CSS_VAL_OUTSIDE},
-#line 251 "cssvalues.gperf"
-      {"loud", CSS_VAL_LOUD},
+#line 28 "cssvalues.gperf"
+      {"icon", CSS_VAL_ICON},
+#line 29 "cssvalues.gperf"
+      {"menu", CSS_VAL_MENU},
+#line 23 "cssvalues.gperf"
+      {"dotted", CSS_VAL_DOTTED},
+#line 15 "cssvalues.gperf"
+      {"initial", CSS_VAL_INITIAL},
+#line 214 "cssvalues.gperf"
+      {"wait", CSS_VAL_WAIT},
+#line 277 "cssvalues.gperf"
+      {"slow", CSS_VAL_SLOW},
+#line 151 "cssvalues.gperf"
+      {"decimal", CSS_VAL_DECIMAL},
+#line 134 "cssvalues.gperf"
+      {"bottom", CSS_VAL_BOTTOM},
+#line 69 "cssvalues.gperf"
+      {"serif", CSS_VAL_SERIF},
 #line 77 "cssvalues.gperf"
       {"blue", CSS_VAL_BLUE},
-#line 51 "cssvalues.gperf"
-      {"small", CSS_VAL_SMALL},
+#line 270 "cssvalues.gperf"
+      {"disabled", CSS_VAL_DISABLED},
+#line 127 "cssvalues.gperf"
+      {"baseline", CSS_VAL_BASELINE},
+#line 111 "cssvalues.gperf"
+      {"menutext", CSS_VAL_MENUTEXT},
 #line 221 "cssvalues.gperf"
       {"visible", CSS_VAL_VISIBLE},
+#line 26 "cssvalues.gperf"
+      {"double", CSS_VAL_DOUBLE},
+#line 52 "cssvalues.gperf"
+      {"medium", CSS_VAL_MEDIUM},
+#line 49 "cssvalues.gperf"
+      {"xx-small", CSS_VAL_XX_SMALL},
+#line 207 "cssvalues.gperf"
+      {"nw-resize", CSS_VAL_NW_RESIZE},
 #line 245 "cssvalues.gperf"
       {"hide", CSS_VAL_HIDE},
-#line 26 "cssvalues.gperf"
-      {"double", CSS_VAL_DOUBLE},
-#line 18 "cssvalues.gperf"
-      {"hidden", CSS_VAL_HIDDEN},
+#line 274 "cssvalues.gperf"
+      {"reverse", CSS_VAL_REVERSE},
+#line 243 "cssvalues.gperf"
+      {"fixed", CSS_VAL_FIXED},
 #line 86 "cssvalues.gperf"
       {"olive", CSS_VAL_OLIVE},
-#line 28 "cssvalues.gperf"
-      {"icon", CSS_VAL_ICON},
-#line 139 "cssvalues.gperf"
-      {"center", CSS_VAL_CENTER},
-#line 213 "cssvalues.gperf"
-      {"text", CSS_VAL_TEXT},
 #line 263 "cssvalues.gperf"
       {"thin", CSS_VAL_THIN},
-#line 261 "cssvalues.gperf"
-      {"static", CSS_VAL_STATIC},
-#line 129 "cssvalues.gperf"
-      {"sub", CSS_VAL_SUB},
-#line 63 "cssvalues.gperf"
-      {"condensed", CSS_VAL_CONDENSED},
+#line 112 "cssvalues.gperf"
+      {"scrollbar", CSS_VAL_SCROLLBAR},
+#line 210 "cssvalues.gperf"
+      {"sw-resize", CSS_VAL_SW_RESIZE},
+#line 18 "cssvalues.gperf"
+      {"hidden", CSS_VAL_HIDDEN},
+#line 184 "cssvalues.gperf"
+      {"block", CSS_VAL_BLOCK},
+#line 220 "cssvalues.gperf"
+      {"lowercase", CSS_VAL_LOWERCASE},
+#line 206 "cssvalues.gperf"
+      {"ne-resize", CSS_VAL_NE_RESIZE},
+#line 241 "cssvalues.gperf"
+      {"cross", CSS_VAL_CROSS},
+#line 209 "cssvalues.gperf"
+      {"se-resize", CSS_VAL_SE_RESIZE},
+#line 278 "cssvalues.gperf"
+      {"fast", CSS_VAL_FAST},
+#line 90 "cssvalues.gperf"
+      {"silver", CSS_VAL_SILVER},
+#line 137 "cssvalues.gperf"
+      {"left", CSS_VAL_LEFT},
+#line 264 "cssvalues.gperf"
+      {"underline", CSS_VAL_UNDERLINE},
 #line 92 "cssvalues.gperf"
       {"white", CSS_VAL_WHITE},
-#line 84 "cssvalues.gperf"
-      {"maroon", CSS_VAL_MAROON},
-#line 238 "cssvalues.gperf"
-      {"blink", CSS_VAL_BLINK},
-#line 36 "cssvalues.gperf"
-      {"normal", CSS_VAL_NORMAL},
-#line 149 "cssvalues.gperf"
-      {"box", CSS_VAL_BOX},
-#line 254 "cssvalues.gperf"
-      {"mix", CSS_VAL_MIX},
-#line 239 "cssvalues.gperf"
-      {"both", CSS_VAL_BOTH},
-#line 162 "cssvalues.gperf"
-      {"armenian", CSS_VAL_ARMENIAN},
-#line 24 "cssvalues.gperf"
-      {"dashed", CSS_VAL_DASHED},
-#line 185 "cssvalues.gperf"
-      {"list-item", CSS_VAL_LIST_ITEM},
-#line 202 "cssvalues.gperf"
-      {"pointer", CSS_VAL_POINTER},
-#line 244 "cssvalues.gperf"
-      {"hand", CSS_VAL_HAND},
-#line 277 "cssvalues.gperf"
-      {"slow", CSS_VAL_SLOW},
-#line 281 "cssvalues.gperf"
-      {"alternate", CSS_VAL_ALTERNATE},
-#line 93 "cssvalues.gperf"
-      {"yellow", CSS_VAL_YELLOW},
-#line 137 "cssvalues.gperf"
-      {"left", CSS_VAL_LEFT},
+#line 82 "cssvalues.gperf"
+      {"indigo", CSS_VAL_INDIGO},
+#line 234 "cssvalues.gperf"
+      {"always", CSS_VAL_ALWAYS},
+#line 262 "cssvalues.gperf"
+      {"thick", CSS_VAL_THICK},
 #line 279 "cssvalues.gperf"
       {"infinite", CSS_VAL_INFINITE},
-#line 85 "cssvalues.gperf"
-      {"navy", CSS_VAL_NAVY},
 #line 110 "cssvalues.gperf"
       {"infotext", CSS_VAL_INFOTEXT},
-#line 82 "cssvalues.gperf"
-      {"indigo", CSS_VAL_INDIGO},
-#line 147 "cssvalues.gperf"
-      {"circle", CSS_VAL_CIRCLE},
-#line 227 "cssvalues.gperf"
-      {"nowrap", CSS_VAL_NOWRAP},
-#line 57 "cssvalues.gperf"
-      {"smaller", CSS_VAL_SMALLER},
-#line 76 "cssvalues.gperf"
-      {"black", CSS_VAL_BLACK},
-#line 50 "cssvalues.gperf"
-      {"x-small", CSS_VAL_X_SMALL},
-#line 235 "cssvalues.gperf"
-      {"avoid", CSS_VAL_AVOID},
-#line 215 "cssvalues.gperf"
-      {"help", CSS_VAL_HELP},
-#line 190 "cssvalues.gperf"
-      {"inline-table", CSS_VAL_INLINE_TABLE},
-#line 232 "cssvalues.gperf"
-      {"above", CSS_VAL_ABOVE},
-#line 268 "cssvalues.gperf"
-      {"content-box", CSS_VAL_CONTENT_BOX},
 #line 187 "cssvalues.gperf"
       {"compact", CSS_VAL_COMPACT},
-#line 257 "cssvalues.gperf"
-      {"relative", CSS_VAL_RELATIVE},
-#line 258 "cssvalues.gperf"
-      {"scroll", CSS_VAL_SCROLL},
-#line 274 "cssvalues.gperf"
-      {"reverse", CSS_VAL_REVERSE},
-#line 186 "cssvalues.gperf"
-      {"run-in", CSS_VAL_RUN_IN},
-#line 201 "cssvalues.gperf"
-      {"default", CSS_VAL_DEFAULT},
+#line 60 "cssvalues.gperf"
+      {"narrower", CSS_VAL_NARROWER},
+#line 275 "cssvalues.gperf"
+      {"up", CSS_VAL_UP},
+#line 22 "cssvalues.gperf"
+      {"outset", CSS_VAL_OUTSET},
+#line 244 "cssvalues.gperf"
+      {"hand", CSS_VAL_HAND},
+#line 161 "cssvalues.gperf"
+      {"hebrew", CSS_VAL_HEBREW},
 #line 133 "cssvalues.gperf"
       {"top", CSS_VAL_TOP},
-#line 78 "cssvalues.gperf"
-      {"crimson", CSS_VAL_CRIMSON},
-#line 49 "cssvalues.gperf"
-      {"xx-small", CSS_VAL_XX_SMALL},
-#line 88 "cssvalues.gperf"
-      {"purple", CSS_VAL_PURPLE},
-#line 21 "cssvalues.gperf"
-      {"ridge", CSS_VAL_RIDGE},
-#line 220 "cssvalues.gperf"
-      {"lowercase", CSS_VAL_LOWERCASE},
-#line 161 "cssvalues.gperf"
-      {"hebrew", CSS_VAL_HEBREW},
-#line 184 "cssvalues.gperf"
-      {"block", CSS_VAL_BLOCK},
-#line 87 "cssvalues.gperf"
-      {"orange", CSS_VAL_ORANGE},
-#line 90 "cssvalues.gperf"
-      {"silver", CSS_VAL_SILVER},
-#line 256 "cssvalues.gperf"
-      {"portrait", CSS_VAL_PORTRAIT},
-#line 240 "cssvalues.gperf"
-      {"crop", CSS_VAL_CROP},
-#line 66 "cssvalues.gperf"
-      {"expanded", CSS_VAL_EXPANDED},
+#line 144 "cssvalues.gperf"
+      {"outside", CSS_VAL_OUTSIDE},
+#line 233 "cssvalues.gperf"
+      {"absolute", CSS_VAL_ABSOLUTE},
+#line 162 "cssvalues.gperf"
+      {"armenian", CSS_VAL_ARMENIAN},
+#line 71 "cssvalues.gperf"
+      {"cursive", CSS_VAL_CURSIVE},
+#line 101 "cssvalues.gperf"
+      {"buttontext", CSS_VAL_BUTTONTEXT},
+#line 202 "cssvalues.gperf"
+      {"pointer", CSS_VAL_POINTER},
+#line 185 "cssvalues.gperf"
+      {"list-item", CSS_VAL_LIST_ITEM},
+#line 239 "cssvalues.gperf"
+      {"both", CSS_VAL_BOTH},
+#line 24 "cssvalues.gperf"
+      {"dashed", CSS_VAL_DASHED},
 #line 222 "cssvalues.gperf"
       {"collapse", CSS_VAL_COLLAPSE},
-#line 278 "cssvalues.gperf"
-      {"fast", CSS_VAL_FAST},
-#line 174 "cssvalues.gperf"
-      {"lower-latin", CSS_VAL_LOWER_LATIN},
+#line 227 "cssvalues.gperf"
+      {"nowrap", CSS_VAL_NOWRAP},
+#line 268 "cssvalues.gperf"
+      {"content-box", CSS_VAL_CONTENT_BOX},
 #line 73 "cssvalues.gperf"
       {"monospace", CSS_VAL_MONOSPACE},
-#line 60 "cssvalues.gperf"
-      {"narrower", CSS_VAL_NARROWER},
-#line 126 "cssvalues.gperf"
-      {"no-repeat", CSS_VAL_NO_REPEAT},
+#line 208 "cssvalues.gperf"
+      {"n-resize", CSS_VAL_N_RESIZE},
 #line 260 "cssvalues.gperf"
       {"show", CSS_VAL_SHOW},
-#line 34 "cssvalues.gperf"
-      {"oblique", CSS_VAL_OBLIQUE},
-#line 282 "cssvalues.gperf"
-      {"unfurl", CSS_VAL_UNFURL},
-#line 248 "cssvalues.gperf"
-      {"landscape", CSS_VAL_LANDSCAPE},
+#line 199 "cssvalues.gperf"
+      {"auto", CSS_VAL_AUTO},
+#line 21 "cssvalues.gperf"
+      {"ridge", CSS_VAL_RIDGE},
+#line 212 "cssvalues.gperf"
+      {"w-resize", CSS_VAL_W_RESIZE},
+#line 256 "cssvalues.gperf"
+      {"portrait", CSS_VAL_PORTRAIT},
+#line 211 "cssvalues.gperf"
+      {"s-resize", CSS_VAL_S_RESIZE},
+#line 271 "cssvalues.gperf"
+      {"forwards", CSS_VAL_FORWARDS},
+#line 87 "cssvalues.gperf"
+      {"orange", CSS_VAL_ORANGE},
+#line 228 "cssvalues.gperf"
+      {"pre", CSS_VAL_PRE},
+#line 80 "cssvalues.gperf"
+      {"gray", CSS_VAL_GRAY},
+#line 205 "cssvalues.gperf"
+      {"e-resize", CSS_VAL_E_RESIZE},
+#line 255 "cssvalues.gperf"
+      {"overline", CSS_VAL_OVERLINE},
+#line 215 "cssvalues.gperf"
+      {"help", CSS_VAL_HELP},
+#line 140 "cssvalues.gperf"
+      {"justify", CSS_VAL_JUSTIFY},
 #line 53 "cssvalues.gperf"
       {"large", CSS_VAL_LARGE},
-#line 234 "cssvalues.gperf"
-      {"always", CSS_VAL_ALWAYS},
-#line 262 "cssvalues.gperf"
-      {"thick", CSS_VAL_THICK},
-#line 100 "cssvalues.gperf"
-      {"buttonshadow", CSS_VAL_BUTTONSHADOW},
+#line 240 "cssvalues.gperf"
+      {"crop", CSS_VAL_CROP},
+#line 257 "cssvalues.gperf"
+      {"relative", CSS_VAL_RELATIVE},
+#line 50 "cssvalues.gperf"
+      {"x-small", CSS_VAL_X_SMALL},
+#line 188 "cssvalues.gperf"
+      {"inline-block", CSS_VAL_INLINE_BLOCK},
+#line 64 "cssvalues.gperf"
+      {"semi-condensed", CSS_VAL_SEMI_CONDENSED},
+#line 272 "cssvalues.gperf"
+      {"backwards", CSS_VAL_BACKWARDS},
+#line 138 "cssvalues.gperf"
+      {"right", CSS_VAL_RIGHT},
+#line 119 "cssvalues.gperf"
+      {"windowframe", CSS_VAL_WINDOWFRAME},
+#line 27 "cssvalues.gperf"
+      {"caption", CSS_VAL_CAPTION},
+#line 132 "cssvalues.gperf"
+      {"text-bottom", CSS_VAL_TEXT_BOTTOM},
+#line 103 "cssvalues.gperf"
+      {"graytext", CSS_VAL_GRAYTEXT},
+#line 106 "cssvalues.gperf"
+      {"inactiveborder", CSS_VAL_INACTIVEBORDER},
+#line 72 "cssvalues.gperf"
+      {"fantasy", CSS_VAL_FANTASY},
+#line 235 "cssvalues.gperf"
+      {"avoid", CSS_VAL_AVOID},
 #line 197 "cssvalues.gperf"
       {"table-cell", CSS_VAL_TABLE_CELL},
-#line 132 "cssvalues.gperf"
-      {"text-bottom", CSS_VAL_TEXT_BOTTOM},
+#line 39 "cssvalues.gperf"
+      {"lighter", CSS_VAL_LIGHTER},
+#line 248 "cssvalues.gperf"
+      {"landscape", CSS_VAL_LANDSCAPE},
+#line 102 "cssvalues.gperf"
+      {"captiontext", CSS_VAL_CAPTIONTEXT},
+#line 58 "cssvalues.gperf"
+      {"larger", CSS_VAL_LARGER},
+#line 186 "cssvalues.gperf"
+      {"run-in", CSS_VAL_RUN_IN},
 #line 267 "cssvalues.gperf"
       {"border-box", CSS_VAL_BORDER_BOX},
-#line 71 "cssvalues.gperf"
-      {"cursive", CSS_VAL_CURSIVE},
-#line 138 "cssvalues.gperf"
-      {"right", CSS_VAL_RIGHT},
+#line 281 "cssvalues.gperf"
+      {"alternate", CSS_VAL_ALTERNATE},
+#line 174 "cssvalues.gperf"
+      {"lower-latin", CSS_VAL_LOWER_LATIN},
+#line 81 "cssvalues.gperf"
+      {"green", CSS_VAL_GREEN},
 #line 194 "cssvalues.gperf"
       {"table-row", CSS_VAL_TABLE_ROW},
-#line 65 "cssvalues.gperf"
-      {"semi-expanded", CSS_VAL_SEMI_EXPANDED},
-#line 39 "cssvalues.gperf"
-      {"lighter", CSS_VAL_LIGHTER},
-#line 106 "cssvalues.gperf"
-      {"inactiveborder", CSS_VAL_INACTIVEBORDER},
-#line 27 "cssvalues.gperf"
-      {"caption", CSS_VAL_CAPTION},
-#line 102 "cssvalues.gperf"
-      {"captiontext", CSS_VAL_CAPTIONTEXT},
-#line 196 "cssvalues.gperf"
-      {"table-column", CSS_VAL_TABLE_COLUMN},
+#line 126 "cssvalues.gperf"
+      {"no-repeat", CSS_VAL_NO_REPEAT},
+#line 232 "cssvalues.gperf"
+      {"above", CSS_VAL_ABOVE},
+#line 66 "cssvalues.gperf"
+      {"expanded", CSS_VAL_EXPANDED},
+#line 74 "cssvalues.gperf"
+      {"transparent", CSS_VAL_TRANSPARENT},
+#line 121 "cssvalues.gperf"
+      {"grey", CSS_VAL_GREY},
+#line 88 "cssvalues.gperf"
+      {"purple", CSS_VAL_PURPLE},
+#line 190 "cssvalues.gperf"
+      {"inline-table", CSS_VAL_INLINE_TABLE},
+#line 107 "cssvalues.gperf"
+      {"inactivecaption", CSS_VAL_INACTIVECAPTION},
+#line 34 "cssvalues.gperf"
+      {"oblique", CSS_VAL_OBLIQUE},
+#line 131 "cssvalues.gperf"
+      {"text-top", CSS_VAL_TEXT_TOP},
+#line 201 "cssvalues.gperf"
+      {"default", CSS_VAL_DEFAULT},
+#line 130 "cssvalues.gperf"
+      {"super", CSS_VAL_SUPER},
+#line 55 "cssvalues.gperf"
+      {"xx-large", CSS_VAL_XX_LARGE},
 #line 123 "cssvalues.gperf"
       {"repeat", CSS_VAL_REPEAT},
-#line 107 "cssvalues.gperf"
-      {"inactivecaption", CSS_VAL_INACTIVECAPTION},
-#line 74 "cssvalues.gperf"
-      {"transparent", CSS_VAL_TRANSPARENT},
 #line 108 "cssvalues.gperf"
       {"inactivecaptiontext", CSS_VAL_INACTIVECAPTIONTEXT},
-#line 131 "cssvalues.gperf"
-      {"text-top", CSS_VAL_TEXT_TOP},
-#line 241 "cssvalues.gperf"
-      {"cross", CSS_VAL_CROSS},
-#line 112 "cssvalues.gperf"
-      {"scrollbar", CSS_VAL_SCROLLBAR},
-#line 64 "cssvalues.gperf"
-      {"semi-condensed", CSS_VAL_SEMI_CONDENSED},
-#line 188 "cssvalues.gperf"
-      {"inline-block", CSS_VAL_INLINE_BLOCK},
-#line 272 "cssvalues.gperf"
-      {"backwards", CSS_VAL_BACKWARDS},
+#line 114 "cssvalues.gperf"
+      {"threedface", CSS_VAL_THREEDFACE},
+#line 282 "cssvalues.gperf"
+      {"unfurl", CSS_VAL_UNFURL},
+#line 273 "cssvalues.gperf"
+      {"ahead", CSS_VAL_AHEAD},
+#line 196 "cssvalues.gperf"
+      {"table-column", CSS_VAL_TABLE_COLUMN},
+#line 218 "cssvalues.gperf"
+      {"capitalize", CSS_VAL_CAPITALIZE},
 #line 159 "cssvalues.gperf"
       {"lower-roman", CSS_VAL_LOWER_ROMAN},
-#line 58 "cssvalues.gperf"
-      {"larger", CSS_VAL_LARGER},
+#line 285 "cssvalues.gperf"
+      {"padding", CSS_VAL_PADDING},
+#line 117 "cssvalues.gperf"
+      {"threedshadow", CSS_VAL_THREEDSHADOW},
+#line 98 "cssvalues.gperf"
+      {"buttonface", CSS_VAL_BUTTONFACE},
+#line 79 "cssvalues.gperf"
+      {"fuchsia", CSS_VAL_FUCHSIA},
+#line 200 "cssvalues.gperf"
+      {"crosshair", CSS_VAL_CROSSHAIR},
+#line 246 "cssvalues.gperf"
+      {"higher", CSS_VAL_HIGHER},
+#line 100 "cssvalues.gperf"
+      {"buttonshadow", CSS_VAL_BUTTONSHADOW},
 #line 94 "cssvalues.gperf"
       {"activeborder", CSS_VAL_ACTIVEBORDER},
-#line 67 "cssvalues.gperf"
-      {"extra-expanded", CSS_VAL_EXTRA_EXPANDED},
-#line 243 "cssvalues.gperf"
-      {"fixed", CSS_VAL_FIXED},
 #line 253 "cssvalues.gperf"
       {"marquee", CSS_VAL_MARQUEE},
-#line 98 "cssvalues.gperf"
-      {"buttonface", CSS_VAL_BUTTONFACE},
-#line 95 "cssvalues.gperf"
-      {"activecaption", CSS_VAL_ACTIVECAPTION},
-#line 228 "cssvalues.gperf"
-      {"pre", CSS_VAL_PRE},
-#line 55 "cssvalues.gperf"
-      {"xx-large", CSS_VAL_XX_LARGE},
-#line 80 "cssvalues.gperf"
-      {"gray", CSS_VAL_GRAY},
-#line 69 "cssvalues.gperf"
-      {"serif", CSS_VAL_SERIF},
-#line 103 "cssvalues.gperf"
-      {"graytext", CSS_VAL_GRAYTEXT},
-#line 130 "cssvalues.gperf"
-      {"super", CSS_VAL_SUPER},
-#line 68 "cssvalues.gperf"
-      {"ultra-expanded", CSS_VAL_ULTRA_EXPANDED},
+#line 31 "cssvalues.gperf"
+      {"small-caption", CSS_VAL_SMALL_CAPTION},
+#line 35 "cssvalues.gperf"
+      {"small-caps", CSS_VAL_SMALL_CAPS},
+#line 122 "cssvalues.gperf"
+      {"-khtml-text", CSS_VAL__KHTML_TEXT},
+#line 20 "cssvalues.gperf"
+      {"groove", CSS_VAL_GROOVE},
+#line 97 "cssvalues.gperf"
+      {"background", CSS_VAL_BACKGROUND},
 #line 178 "cssvalues.gperf"
       {"katakana", CSS_VAL_KATAKANA},
+#line 148 "cssvalues.gperf"
+      {"square", CSS_VAL_SQUARE},
+#line 259 "cssvalues.gperf"
+      {"separate", CSS_VAL_SEPARATE},
+#line 75 "cssvalues.gperf"
+      {"aqua", CSS_VAL_AQUA},
+#line 70 "cssvalues.gperf"
+      {"sans-serif", CSS_VAL_SANS_SERIF},
+#line 32 "cssvalues.gperf"
+      {"status-bar", CSS_VAL_STATUS_BAR},
+#line 65 "cssvalues.gperf"
+      {"semi-expanded", CSS_VAL_SEMI_EXPANDED},
+#line 230 "cssvalues.gperf"
+      {"pre-line", CSS_VAL_PRE_LINE},
+#line 237 "cssvalues.gperf"
+      {"bidi-override", CSS_VAL_BIDI_OVERRIDE},
 #line 62 "cssvalues.gperf"
       {"extra-condensed", CSS_VAL_EXTRA_CONDENSED},
-#line 140 "cssvalues.gperf"
-      {"justify", CSS_VAL_JUSTIFY},
-#line 237 "cssvalues.gperf"
-      {"bidi-override", CSS_VAL_BIDI_OVERRIDE},
-#line 206 "cssvalues.gperf"
-      {"ne-resize", CSS_VAL_NE_RESIZE},
-#line 75 "cssvalues.gperf"
-      {"aqua", CSS_VAL_AQUA},
-#line 119 "cssvalues.gperf"
-      {"windowframe", CSS_VAL_WINDOWFRAME},
+#line 95 "cssvalues.gperf"
+      {"activecaption", CSS_VAL_ACTIVECAPTION},
 #line 198 "cssvalues.gperf"
       {"table-caption", CSS_VAL_TABLE_CAPTION},
-#line 122 "cssvalues.gperf"
-      {"-khtml-text", CSS_VAL__KHTML_TEXT},
-#line 207 "cssvalues.gperf"
-      {"nw-resize", CSS_VAL_NW_RESIZE},
-#line 61 "cssvalues.gperf"
-      {"ultra-condensed", CSS_VAL_ULTRA_CONDENSED},
-#line 20 "cssvalues.gperf"
-      {"groove", CSS_VAL_GROOVE},
-#line 32 "cssvalues.gperf"
-      {"status-bar", CSS_VAL_STATUS_BAR},
-#line 31 "cssvalues.gperf"
-      {"small-caption", CSS_VAL_SMALL_CAPTION},
-#line 255 "cssvalues.gperf"
-      {"overline", CSS_VAL_OVERLINE},
-#line 97 "cssvalues.gperf"
-      {"background", CSS_VAL_BACKGROUND},
+#line 154 "cssvalues.gperf"
+      {"-khtml-lao", CSS_VAL__KHTML_LAO},
+#line 143 "cssvalues.gperf"
+      {"-khtml-center", CSS_VAL__KHTML_CENTER},
 #line 54 "cssvalues.gperf"
       {"x-large", CSS_VAL_X_LARGE},
-#line 273 "cssvalues.gperf"
-      {"ahead", CSS_VAL_AHEAD},
-#line 246 "cssvalues.gperf"
-      {"higher", CSS_VAL_HIGHER},
-#line 205 "cssvalues.gperf"
-      {"e-resize", CSS_VAL_E_RESIZE},
-#line 208 "cssvalues.gperf"
-      {"n-resize", CSS_VAL_N_RESIZE},
-#line 117 "cssvalues.gperf"
-      {"threedshadow", CSS_VAL_THREEDSHADOW},
-#line 259 "cssvalues.gperf"
-      {"separate", CSS_VAL_SEPARATE},
 #line 30 "cssvalues.gperf"
       {"message-box", CSS_VAL_MESSAGE_BOX},
-#line 212 "cssvalues.gperf"
-      {"w-resize", CSS_VAL_W_RESIZE},
+#line 203 "cssvalues.gperf"
+      {"progress", CSS_VAL_PROGRESS},
+#line 177 "cssvalues.gperf"
+      {"hiragana", CSS_VAL_HIRAGANA},
+#line 171 "cssvalues.gperf"
+      {"lower-greek", CSS_VAL_LOWER_GREEK},
+#line 150 "cssvalues.gperf"
+      {"-khtml-diamond", CSS_VAL__KHTML_DIAMOND},
+#line 141 "cssvalues.gperf"
+      {"-khtml-left", CSS_VAL__KHTML_LEFT},
+#line 61 "cssvalues.gperf"
+      {"ultra-condensed", CSS_VAL_ULTRA_CONDENSED},
 #line 158 "cssvalues.gperf"
       {"-khtml-tibetan", CSS_VAL__KHTML_TIBETAN},
-#line 154 "cssvalues.gperf"
-      {"-khtml-lao", CSS_VAL__KHTML_LAO},
+#line 124 "cssvalues.gperf"
+      {"repeat-x", CSS_VAL_REPEAT_X},
+#line 265 "cssvalues.gperf"
+      {"-khtml-normal", CSS_VAL__KHTML_NORMAL},
+#line 113 "cssvalues.gperf"
+      {"threeddarkshadow", CSS_VAL_THREEDDARKSHADOW},
+#line 219 "cssvalues.gperf"
+      {"uppercase", CSS_VAL_UPPERCASE},
+#line 125 "cssvalues.gperf"
+      {"repeat-y", CSS_VAL_REPEAT_Y},
 #line 136 "cssvalues.gperf"
       {"-khtml-auto", CSS_VAL__KHTML_AUTO},
-#line 124 "cssvalues.gperf"
-      {"repeat-x", CSS_VAL_REPEAT_X},
-#line 209 "cssvalues.gperf"
-      {"se-resize", CSS_VAL_SE_RESIZE},
-#line 150 "cssvalues.gperf"
-      {"-khtml-diamond", CSS_VAL__KHTML_DIAMOND},
-#line 81 "cssvalues.gperf"
-      {"green", CSS_VAL_GREEN},
-#line 210 "cssvalues.gperf"
-      {"sw-resize", CSS_VAL_SW_RESIZE},
-#line 177 "cssvalues.gperf"
-      {"hiragana", CSS_VAL_HIRAGANA},
-#line 79 "cssvalues.gperf"
-      {"fuchsia", CSS_VAL_FUCHSIA},
-#line 35 "cssvalues.gperf"
-      {"small-caps", CSS_VAL_SMALL_CAPS},
-#line 173 "cssvalues.gperf"
-      {"lower-alpha", CSS_VAL_LOWER_ALPHA},
-#line 156 "cssvalues.gperf"
-      {"-khtml-urdu", CSS_VAL__KHTML_URDU},
-#line 148 "cssvalues.gperf"
-      {"square", CSS_VAL_SQUARE},
-#line 271 "cssvalues.gperf"
-      {"forwards", CSS_VAL_FORWARDS},
-#line 211 "cssvalues.gperf"
-      {"s-resize", CSS_VAL_S_RESIZE},
-#line 114 "cssvalues.gperf"
-      {"threedface", CSS_VAL_THREEDFACE},
-#line 72 "cssvalues.gperf"
-      {"fantasy", CSS_VAL_FANTASY},
-#line 230 "cssvalues.gperf"
-      {"pre-line", CSS_VAL_PRE_LINE},
+#line 224 "cssvalues.gperf"
+      {"no-close-quote", CSS_VAL_NO_CLOSE_QUOTE},
 #line 163 "cssvalues.gperf"
       {"georgian", CSS_VAL_GEORGIAN},
-#line 218 "cssvalues.gperf"
-      {"capitalize", CSS_VAL_CAPITALIZE},
-#line 143 "cssvalues.gperf"
-      {"-khtml-center", CSS_VAL__KHTML_CENTER},
+#line 109 "cssvalues.gperf"
+      {"infobackground", CSS_VAL_INFOBACKGROUND},
 #line 16 "cssvalues.gperf"
       {"-khtml-native", CSS_VAL__KHTML_NATIVE},
-#line 219 "cssvalues.gperf"
-      {"uppercase", CSS_VAL_UPPERCASE},
-#line 265 "cssvalues.gperf"
-      {"-khtml-normal", CSS_VAL__KHTML_NORMAL},
-#line 225 "cssvalues.gperf"
-      {"no-open-quote", CSS_VAL_NO_OPEN_QUOTE},
 #line 157 "cssvalues.gperf"
       {"-khtml-thai", CSS_VAL__KHTML_THAI},
-#line 176 "cssvalues.gperf"
-      {"upper-latin", CSS_VAL_UPPER_LATIN},
-#line 200 "cssvalues.gperf"
-      {"crosshair", CSS_VAL_CROSSHAIR},
-#line 171 "cssvalues.gperf"
-      {"lower-greek", CSS_VAL_LOWER_GREEK},
+#line 173 "cssvalues.gperf"
+      {"lower-alpha", CSS_VAL_LOWER_ALPHA},
+#line 156 "cssvalues.gperf"
+      {"-khtml-urdu", CSS_VAL__KHTML_URDU},
 #line 223 "cssvalues.gperf"
       {"close-quote", CSS_VAL_CLOSE_QUOTE},
-#line 125 "cssvalues.gperf"
-      {"repeat-y", CSS_VAL_REPEAT_Y},
-#line 203 "cssvalues.gperf"
-      {"progress", CSS_VAL_PROGRESS},
+#line 104 "cssvalues.gperf"
+      {"highlight", CSS_VAL_HIGHLIGHT},
 #line 231 "cssvalues.gperf"
       {"-khtml-nowrap", CSS_VAL__KHTML_NOWRAP},
-#line 121 "cssvalues.gperf"
-      {"grey", CSS_VAL_GREY},
-#line 224 "cssvalues.gperf"
-      {"no-close-quote", CSS_VAL_NO_CLOSE_QUOTE},
-#line 141 "cssvalues.gperf"
-      {"-khtml-left", CSS_VAL__KHTML_LEFT},
-#line 160 "cssvalues.gperf"
-      {"upper-roman", CSS_VAL_UPPER_ROMAN},
-#line 250 "cssvalues.gperf"
-      {"line-through", CSS_VAL_LINE_THROUGH},
-#line 109 "cssvalues.gperf"
-      {"infobackground", CSS_VAL_INFOBACKGROUND},
+#line 67 "cssvalues.gperf"
+      {"extra-expanded", CSS_VAL_EXTRA_EXPANDED},
+#line 105 "cssvalues.gperf"
+      {"highlighttext", CSS_VAL_HIGHLIGHTTEXT},
 #line 155 "cssvalues.gperf"
       {"-khtml-persian", CSS_VAL__KHTML_PERSIAN},
-#line 113 "cssvalues.gperf"
-      {"threeddarkshadow", CSS_VAL_THREEDDARKSHADOW},
-#line 104 "cssvalues.gperf"
-      {"highlight", CSS_VAL_HIGHLIGHT},
-#line 105 "cssvalues.gperf"
-      {"highlighttext", CSS_VAL_HIGHLIGHTTEXT},
+#line 116 "cssvalues.gperf"
+      {"threedlightshadow", CSS_VAL_THREEDLIGHTSHADOW},
+#line 229 "cssvalues.gperf"
+      {"pre-wrap", CSS_VAL_PRE_WRAP},
+#line 225 "cssvalues.gperf"
+      {"no-open-quote", CSS_VAL_NO_OPEN_QUOTE},
+#line 96 "cssvalues.gperf"
+      {"appworkspace", CSS_VAL_APPWORKSPACE},
 #line 226 "cssvalues.gperf"
       {"open-quote", CSS_VAL_OPEN_QUOTE},
-#line 229 "cssvalues.gperf"
-      {"pre-wrap", CSS_VAL_PRE_WRAP},
+#line 68 "cssvalues.gperf"
+      {"ultra-expanded", CSS_VAL_ULTRA_EXPANDED},
+#line 176 "cssvalues.gperf"
+      {"upper-latin", CSS_VAL_UPPER_LATIN},
+#line 250 "cssvalues.gperf"
+      {"line-through", CSS_VAL_LINE_THROUGH},
+#line 142 "cssvalues.gperf"
+      {"-khtml-right", CSS_VAL__KHTML_RIGHT},
+#line 164 "cssvalues.gperf"
+      {"cjk-ideographic", CSS_VAL_CJK_IDEOGRAPHIC},
+#line 160 "cssvalues.gperf"
+      {"upper-roman", CSS_VAL_UPPER_ROMAN},
 #line 135 "cssvalues.gperf"
       {"-khtml-baseline-middle", CSS_VAL__KHTML_BASELINE_MIDDLE},
-#line 70 "cssvalues.gperf"
-      {"sans-serif", CSS_VAL_SANS_SERIF},
-#line 164 "cssvalues.gperf"
-      {"cjk-ideographic", CSS_VAL_CJK_IDEOGRAPHIC},
-#line 116 "cssvalues.gperf"
-      {"threedlightshadow", CSS_VAL_THREEDLIGHTSHADOW},
+#line 153 "cssvalues.gperf"
+      {"-khtml-arabic-indic", CSS_VAL__KHTML_ARABIC_INDIC},
+#line 152 "cssvalues.gperf"
+      {"decimal-leading-zero", CSS_VAL_DECIMAL_LEADING_ZERO},
+#line 115 "cssvalues.gperf"
+      {"threedhighlight", CSS_VAL_THREEDHIGHLIGHT},
 #line 180 "cssvalues.gperf"
       {"katakana-iroha", CSS_VAL_KATAKANA_IROHA},
 #line 99 "cssvalues.gperf"
       {"buttonhighlight", CSS_VAL_BUTTONHIGHLIGHT},
-#line 142 "cssvalues.gperf"
-      {"-khtml-right", CSS_VAL__KHTML_RIGHT},
-#line 96 "cssvalues.gperf"
-      {"appworkspace", CSS_VAL_APPWORKSPACE},
+#line 56 "cssvalues.gperf"
+      {"-khtml-xxx-large", CSS_VAL__KHTML_XXX_LARGE},
 #line 191 "cssvalues.gperf"
       {"table-row-group", CSS_VAL_TABLE_ROW_GROUP},
-#line 152 "cssvalues.gperf"
-      {"decimal-leading-zero", CSS_VAL_DECIMAL_LEADING_ZERO},
+#line 182 "cssvalues.gperf"
+      {"-khtml-close-quote", CSS_VAL__KHTML_CLOSE_QUOTE},
+#line 179 "cssvalues.gperf"
+      {"hiragana-iroha", CSS_VAL_HIRAGANA_IROHA},
+#line 195 "cssvalues.gperf"
+      {"table-column-group", CSS_VAL_TABLE_COLUMN_GROUP},
+#line 266 "cssvalues.gperf"
+      {"-khtml-around-floats", CSS_VAL__KHTML_AROUND_FLOATS},
 #line 175 "cssvalues.gperf"
       {"upper-alpha", CSS_VAL_UPPER_ALPHA},
-#line 195 "cssvalues.gperf"
-      {"table-column-group", CSS_VAL_TABLE_COLUMN_GROUP},
-#line 153 "cssvalues.gperf"
-      {"-khtml-arabic-indic", CSS_VAL__KHTML_ARABIC_INDIC},
-#line 56 "cssvalues.gperf"
-      {"-khtml-xxx-large", CSS_VAL__KHTML_XXX_LARGE},
-#line 179 "cssvalues.gperf"
-      {"hiragana-iroha", CSS_VAL_HIRAGANA_IROHA},
 #line 181 "cssvalues.gperf"
       {"-khtml-open-quote", CSS_VAL__KHTML_OPEN_QUOTE},
-#line 115 "cssvalues.gperf"
-      {"threedhighlight", CSS_VAL_THREEDHIGHLIGHT},
+#line 193 "cssvalues.gperf"
+      {"table-footer-group", CSS_VAL_TABLE_FOOTER_GROUP},
 #line 192 "cssvalues.gperf"
       {"table-header-group", CSS_VAL_TABLE_HEADER_GROUP},
-#line 182 "cssvalues.gperf"
-      {"-khtml-close-quote", CSS_VAL__KHTML_CLOSE_QUOTE},
-#line 193 "cssvalues.gperf"
-      {"table-footer-group", CSS_VAL_TABLE_FOOTER_GROUP},
-#line 266 "cssvalues.gperf"
-      {"-khtml-around-floats", CSS_VAL__KHTML_AROUND_FLOATS},
-#line 172 "cssvalues.gperf"
-      {"-khtml-upper-greek", CSS_VAL__KHTML_UPPER_GREEK},
 #line 165 "cssvalues.gperf"
       {"-khtml-japanese-formal", CSS_VAL__KHTML_JAPANESE_FORMAL},
 #line 166 "cssvalues.gperf"
       {"-khtml-japanese-informal", CSS_VAL__KHTML_JAPANESE_INFORMAL},
+#line 172 "cssvalues.gperf"
+      {"-khtml-upper-greek", CSS_VAL__KHTML_UPPER_GREEK},
 #line 169 "cssvalues.gperf"
       {"-khtml-trad-chinese-formal", CSS_VAL__KHTML_TRAD_CHINESE_FORMAL},
 #line 170 "cssvalues.gperf"
@@ -734,238 +740,250 @@
     {
         0,  -1,  -1,  -1,  -1,   1,  -1,  -1,  -1,  -1,
         2,  -1,  -1,  -1,  -1,   3,  -1,  -1,  -1,  -1,
-        4,  -1,  -1,   5,  -1,   6,  -1,  -1,  -1,  -1,
+        4,  -1,  -1,  -1,  -1,   5,  -1,  -1,   6,  -1,
         7,  -1,  -1,  -1,  -1,   8,  -1,  -1,  -1,  -1,
         9,  -1,  -1,  -1,  -1,  10,  -1,  -1,  -1,  -1,
        11,  -1,  -1,  -1,  -1,  12,  -1,  -1,  -1,  -1,
-       13,  -1,  -1,  14,  -1,  15,  -1,  -1,  -1,  -1,
-       16,  -1,  -1,  17,  -1,  18,  -1,  -1,  -1,  -1,
-       19,  20,  -1,  21,  22,  23,  -1,  -1,  -1,  -1,
-       24,  -1,  -1,  25,  -1,  26,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  27,  -1,  28,  -1,  -1,  -1,  -1,
-       29,  -1,  -1,  -1,  -1,  30,  -1,  -1,  -1,  -1,
-       31,  32,  -1,  -1,  -1,  33,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  34,  -1,  35,  -1,  -1,  -1,  -1,
-       36,  -1,  -1,  -1,  -1,  37,  -1,  -1,  -1,  -1,
-       38,  -1,  -1,  -1,  -1,  39,  -1,  -1,  -1,  -1,
-       40,  -1,  -1,  -1,  -1,  41,  -1,  -1,  -1,  -1,
-       42,  -1,  -1,  43,  -1,  44,  -1,  -1,  45,  -1,
-       46,  -1,  -1,  47,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  48,  -1,  -1,  -1,  -1,  -1,  -1,
-       49,  -1,  -1,  -1,  -1,  50,  -1,  -1,  -1,  -1,
-       51,  -1,  -1,  -1,  -1,  52,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  53,  -1,  -1,  -1,  -1,
-       54,  -1,  -1,  55,  -1,  -1,  -1,  -1,  56,  -1,
-       -1,  -1,  -1,  -1,  -1,  57,  -1,  -1,  58,  -1,
-       59,  -1,  -1,  60,  -1,  61,  62,  -1,  -1,  -1,
-       63,  -1,  -1,  -1,  -1,  64,  -1,  -1,  65,  -1,
-       -1,  -1,  -1,  66,  -1,  -1,  -1,  -1,  -1,  -1,
-       67,  -1,  -1,  -1,  -1,  68,  -1,  -1,  -1,  -1,
-       69,  70,  -1,  -1,  -1,  71,  -1,  -1,  72,  -1,
-       73,  -1,  -1,  74,  -1,  -1,  -1,  -1,  75,  -1,
-       76,  -1,  -1,  -1,  -1,  77,  -1,  -1,  -1,  -1,
-       78,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       79,  -1,  -1,  80,  -1,  81,  -1,  -1,  82,  -1,
+       13,  14,  -1,  -1,  -1,  15,  -1,  -1,  -1,  -1,
+       16,  -1,  -1,  -1,  -1,  17,  -1,  -1,  -1,  -1,
+       18,  -1,  -1,  -1,  -1,  19,  -1,  -1,  -1,  -1,
+       20,  -1,  -1,  -1,  -1,  21,  -1,  -1,  22,  -1,
+       23,  -1,  -1,  24,  -1,  25,  -1,  -1,  26,  -1,
+       27,  -1,  -1,  -1,  -1,  28,  -1,  -1,  -1,  29,
+       30,  -1,  -1,  31,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  32,  -1,  -1,  -1,  -1,  -1,  -1,
+       33,  -1,  -1,  -1,  -1,  34,  -1,  -1,  -1,  -1,
+       35,  -1,  -1,  36,  -1,  -1,  -1,  -1,  37,  -1,
+       38,  -1,  -1,  -1,  -1,  39,  40,  -1,  41,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       83,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  84,  -1,  -1,  -1,  85,  -1,  -1,  -1,  -1,
-       86,  87,  -1,  88,  -1,  89,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  90,  -1,  -1,  91,  -1,
-       92,  -1,  -1,  -1,  -1,  93,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  42,  -1,  -1,  43,  -1,
+       44,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       45,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  46,  -1,
+       -1,  -1,  -1,  -1,  -1,  47,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  48,  -1,  -1,  49,  -1,
+       50,  -1,  -1,  -1,  -1,  51,  -1,  -1,  -1,  -1,
+       52,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  53,  -1,
+       54,  -1,  -1,  -1,  -1,  -1,  55,  -1,  -1,  -1,
+       56,  -1,  -1,  57,  -1,  58,  -1,  -1,  -1,  -1,
+       59,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       60,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       61,  -1,  -1,  62,  -1,  -1,  63,  -1,  64,  -1,
+       65,  -1,  -1,  -1,  -1,  66,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  94,  -1,
-       -1,  -1,  -1,  95,  -1,  96,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  97,  -1,  -1,  98,  -1,
-       -1,  -1,  -1,  99,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  67,  -1,  -1,  68,  -1,
+       69,  -1,  -1,  -1,  -1,  70,  -1,  -1,  71,  -1,
+       -1,  -1,  -1,  72,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  73,  -1,  -1,  -1,  -1,  -1,  -1,
+       74,  75,  -1,  76,  -1,  77,  -1,  -1,  78,  -1,
+       -1,  -1,  -1,  79,  -1,  -1,  80,  -1,  81,  -1,
+       82,  -1,  -1,  83,  -1,  84,  -1,  -1,  -1,  -1,
+       85,  -1,  -1,  86,  -1,  87,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  88,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  89,  -1,  -1,  -1,  -1,
+       90,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  91,  -1,
+       92,  -1,  -1,  -1,  -1,  93,  94,  -1,  -1,  -1,
+       95,  96,  -1,  97,  -1,  98,  -1,  -1,  99,  -1,
       100,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 101,  -1,
-      102,  -1,  -1, 103,  -1, 104,  -1,  -1,  -1,  -1,
-      105,  -1,  -1,  -1,  -1, 106,  -1,  -1, 107,  -1,
-       -1, 108,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-      109,  -1,  -1,  -1,  -1, 110,  -1,  -1,  -1,  -1,
+      102,  -1,  -1,  -1,  -1, 103,  -1,  -1,  -1,  -1,
+      104,  -1,  -1, 105,  -1, 106,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 107,  -1,  -1,  -1,  -1,
+      108,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+      109,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 110,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 111,  -1,
+       -1,  -1,  -1, 112,  -1, 113,  -1,  -1,  -1,  -1,
+      114,  -1,  -1,  -1,  -1, 115,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 116,  -1,  -1, 117,  -1,
+       -1,  -1,  -1, 118,  -1, 119,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 120,  -1,  -1, 121,  -1,
+      122,  -1,  -1,  -1,  -1, 123,  -1,  -1, 124,  -1,
+      125,  -1,  -1,  -1,  -1, 126,  -1,  -1, 127,  -1,
+      128,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+      129,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 130,  -1,
+      131,  -1,  -1, 132,  -1, 133, 134,  -1,  -1,  -1,
+      135,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+      136,  -1,  -1, 137,  -1,  -1,  -1,  -1, 138,  -1,
+      139,  -1,  -1,  -1,  -1, 140,  -1,  -1, 141,  -1,
+      142, 143,  -1,  -1,  -1, 144,  -1,  -1, 145,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1, 146,  -1,  -1,  -1,
+       -1,  -1,  -1, 147,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1, 148,  -1,  -1,  -1,  -1, 149,  -1,
+      150,  -1,  -1,  -1,  -1, 151,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 152,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1, 153,  -1,  -1,  -1,  -1,  -1,  -1,
+      154,  -1,  -1,  -1,  -1, 155,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 156,  -1,
+      157,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 158,  -1,
+      159,  -1,  -1, 160,  -1, 161,  -1,  -1, 162,  -1,
+       -1,  -1,  -1, 163,  -1, 164,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1, 165,  -1,  -1,  -1,  -1,  -1,  -1,
+      166,  -1,  -1,  -1,  -1, 167,  -1,  -1, 168,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1, 111,  -1,  -1,  -1,  -1, 112,  -1,
-      113,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-      114,  -1,  -1, 115,  -1, 116,  -1,  -1,  -1,  -1,
-      117,  -1,  -1, 118,  -1, 119,  -1,  -1,  -1,  -1,
-      120,  -1,  -1, 121,  -1, 122,  -1,  -1, 123,  -1,
-      124,  -1,  -1, 125,  -1, 126,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1, 127,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1, 128,  -1,  -1,  -1,  -1,
-      129, 130,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1, 131,  -1,  -1,  -1,  -1, 132,  -1,
-      133,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 134,  -1,
+      169,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 170,  -1,
+      171,  -1,  -1,  -1,  -1, 172,  -1,  -1,  -1,  -1,
+       -1, 173,  -1,  -1,  -1, 174,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1, 135,  -1,  -1,  -1,  -1, 136,  -1,
-      137,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 138,  -1,
-       -1,  -1,  -1, 139,  -1,  -1,  -1,  -1,  -1,  -1,
-      140,  -1,  -1, 141,  -1, 142,  -1,  -1, 143,  -1,
-       -1,  -1,  -1,  -1,  -1, 144,  -1,  -1,  -1,  -1,
-      145,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 146,  -1,
-      147, 148,  -1, 149,  -1, 150,  -1,  -1,  -1,  -1,
-      151,  -1,  -1,  -1,  -1, 152,  -1,  -1,  -1,  -1,
-      153,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 154,  -1,
-       -1,  -1,  -1, 155,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1, 156,  -1,  -1, 157,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1, 158,  -1, 159,  -1,
-      160,  -1,  -1,  -1,  -1, 161,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1, 162,  -1, 163, 164,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 165,  -1,
-      166, 167,  -1,  -1,  -1, 168,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1, 169,  -1, 170,  -1,  -1, 171,  -1,
-       -1, 172,  -1, 173,  -1, 174,  -1,  -1, 175,  -1,
-       -1, 176,  -1,  -1,  -1, 177,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1, 178,  -1,  -1,  -1,  -1, 179,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1, 175,  -1,  -1,  -1,
+      176,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+      177,  -1,  -1,  -1,  -1, 178,  -1,  -1,  -1,  -1,
+      179,  -1,  -1,  -1,  -1, 180,  -1,  -1, 181,  -1,
+      182,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 183,  -1,
+       -1,  -1,  -1,  -1,  -1, 184,  -1,  -1,  -1,  -1,
+      185,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1, 180,  -1,  -1, 181,  -1,
-       -1,  -1,  -1,  -1,  -1, 182,  -1,  -1,  -1,  -1,
-      183,  -1,  -1, 184,  -1, 185,  -1,  -1, 186,  -1,
-      187,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1, 188,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1, 189,  -1,  -1,  -1,  -1,
-      190,  -1,  -1, 191,  -1, 192,  -1,  -1, 193,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 186,  -1,  -1,  -1,  -1,
+      187,  -1,  -1, 188,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1, 189,  -1,  -1,  -1,  -1,  -1,  -1,
+      190,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+      191,  -1,  -1,  -1,  -1, 192,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 193,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 194,  -1,
-       -1,  -1,  -1,  -1,  -1, 195,  -1,  -1,  -1,  -1,
-      196,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-      197,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 198,  -1,
-      199,  -1,  -1,  -1,  -1, 200,  -1,  -1,  -1,  -1,
+      195,  -1,  -1,  -1,  -1, 196,  -1,  -1, 197,  -1,
+      198,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 199,  -1,
+       -1,  -1,  -1,  -1,  -1, 200,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-      201,  -1,  -1, 202,  -1, 203,  -1,  -1,  -1,  -1,
-      204,  -1,  -1,  -1,  -1, 205,  -1,  -1,  -1,  -1,
+      201,  -1,  -1, 202,  -1,  -1,  -1,  -1,  -1,  -1,
+      203,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 204,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 206,  -1,
+       -1,  -1,  -1, 205,  -1,  -1,  -1,  -1, 206,  -1,
+      207,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1, 207,  -1,  -1, 208,  -1,
-       -1,  -1,  -1, 209,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1, 210,  -1,  -1,  -1,  -1,
-      211,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 212,  -1,
-      213,  -1,  -1,  -1,  -1, 214,  -1,  -1,  -1,  -1,
-      215,  -1,  -1,  -1,  -1, 216,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+      208,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 209,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 210,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1, 217,  -1,  -1,  -1,  -1,  -1,  -1,
-      218,  -1,  -1,  -1,  -1, 219,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-      220,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1, 221,  -1,  -1,  -1,  -1,
-      222,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1, 223,  -1,  -1, 224,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1, 211,  -1, 212,  -1,  -1,  -1,  -1,
+      213,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 214,  -1,
+      215,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-      225,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 216,  -1,  -1,  -1,  -1,
+      217,  -1,  -1,  -1,  -1, 218,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 219,  -1,
+       -1,  -1,  -1,  -1,  -1, 220,  -1,  -1, 221,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1, 226,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1, 227,  -1,  -1, 228,  -1,
-       -1,  -1,  -1, 229,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1, 230,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+      222,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1, 223,  -1,  -1,  -1,  -1,  -1,  -1,
+      224,  -1,  -1,  -1,  -1, 225,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+      226,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1, 231,  -1,  -1,  -1,  -1,
-      232,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-      233,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-      234,  -1,  -1,  -1,  -1, 235,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1, 236,  -1, 237,  -1,  -1, 238,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+      227,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1, 228,  -1, 229,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-      239,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 240,  -1,
-      241,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-      242,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 230,  -1,
+      231,  -1,  -1,  -1,  -1, 232,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 233,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 234,  -1,
+       -1, 235,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1, 236,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 243,  -1,
+      237,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 238,  -1,
+       -1,  -1,  -1, 239,  -1,  -1,  -1,  -1,  -1,  -1,
+      240,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1, 241,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 244,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1, 245,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1, 246,  -1,  -1,  -1,  -1,
-      247,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 248,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+      242,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 243,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1, 249,  -1,  -1,  -1,  -1,  -1,  -1,
-      250,  -1,  -1,  -1,  -1, 251,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 244,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-      252,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-      253,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+      245,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+      246,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 254,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1, 255,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1, 247,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 248,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1, 256,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 249,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 250,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 251,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-      257,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1, 258,  -1,  -1,  -1,  -1,
-      259,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+      252,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+      253,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 254,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 255,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 256,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 257,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 258,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-      260,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-      261,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 259,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 260,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 261,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+      262,  -1,  -1,  -1,  -1, 263,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-      262,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1, 263,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1, 264,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
@@ -986,6 +1004,7 @@
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 264,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
@@ -993,6 +1012,8 @@
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1, 265,  -1,
+       -1,  -1,  -1, 266,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
@@ -1004,6 +1025,7 @@
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 267,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
@@ -1016,20 +1038,12 @@
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1, 265,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1, 266,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
+       -1,  -1,  -1,  -1,  -1, 268,  -1,  -1,  -1,  -1,
+      269,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
        -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-       -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-      267,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,  -1,
-      268
+      270,  -1,  -1,  -1,  -1, 271
     };
 
   if (len <= MAX_WORD_LENGTH && len >= MIN_WORD_LENGTH)
@@ -1051,7 +1065,7 @@
     }
   return 0;
 }
-#line 283 "cssvalues.gperf"
+#line 286 "cssvalues.gperf"
 
 static const char * const valueList[] = {
 "",
@@ -1324,6 +1338,9 @@
 "slide", 
 "alternate", 
 "unfurl", 
+"border", 
+"content", 
+"padding", 
     0
 };
 DOMString getValueName(unsigned short id)
Index: khtml/css/cssstyleselector.cpp
===================================================================
--- khtml/css/cssstyleselector.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/css/cssstyleselector.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -5,6 +5,7 @@
  *           (C) 2003-2004 Apple Computer, Inc.
  *           (C) 2004-2006 Allan Sandfeld Jensen (kde@carewolf.com)
  *           (C) 2004 Germain Garand (germain@ebooksfrance.org)
+ *           (C) 2005, 2006 Apple Computer, Inc.
  *
  * This library is free software; you can redistribute it and/or
  * modify it under the terms of the GNU Library General Public
@@ -741,7 +742,7 @@
         CSSProperty *prop = values->at(i >= firstLen ? i - firstLen : i);
 	Source source = Inline;
 
-        if( prop->m_bImportant ) source = InlineImportant;
+        if( prop->m_important ) source = InlineImportant;
 	if( prop->nonCSSHint ) source = NonCSSHint;
 
 	bool first;
@@ -912,7 +913,16 @@
         else
             doc->dynamicDomRestyler().addDependency(sel->attr, PredecessorDependency);
     }
-
+    if(sel->match == CSSSelector::PseudoClass)
+    {
+	switch (sel->pseudoType()) {
+            case CSSSelector::PseudoNot:
+                precomputeAttributeDependenciesAux(doc, sel->simpleSelector, isAncestor, true);
+                break;
+            default:
+                break;
+        }
+    }
     CSSSelector::Relation relation = sel->relation;
     sel = sel->tagHistory;
     if (!sel) return;
@@ -1021,7 +1031,7 @@
         //kdDebug() << "CSSOrderedRule::checkSelector" << endl;
         ElementImpl *elem = static_cast<ElementImpl *>(n);
 
-        if(!checkOneSelector(sel, elem, isAncestor)) return 0;
+        if(!checkOneSelector(sel, elem, isAncestor, true)) return 0;
         //kdDebug() << "CSSOrderedRule::checkSelector: passed" << endl;
         break;
     }
@@ -1054,7 +1064,7 @@
     return;
 }
 
-bool CSSStyleSelector::checkOneSelector(DOM::CSSSelector *sel, DOM::ElementImpl *e, bool isAncestor)
+bool CSSStyleSelector::checkOneSelector(DOM::CSSSelector *sel, DOM::ElementImpl *e, bool isAncestor, bool isSubSelector)
 {
     if(!e)
         return false;
@@ -1433,7 +1443,7 @@
         case CSSSelector::PseudoHover: {
 	    // If we're in quirks mode, then *:active should only match focusable elements, and never
 	    // unfocusable anchors.
-	    if (strictParsing || (sel->tag != anyQName && e->id() != ID_A) || e->isFocusable()) {
+	    if (strictParsing || ((sel->tag != anyQName || isSubSelector) && e->id() != ID_A) || e->isFocusable()) {
                 doc->dynamicDomRestyler().addDependency(element, e, HoverDependency);
 
                 if (e->hovered())
@@ -1443,7 +1453,7 @@
         }
 	case CSSSelector::PseudoActive:
 	    // If we're in quirks mode, then *:active should only match focusable elements
-	    if (strictParsing || (sel->tag != anyQName && e->id() != ID_A) || e->isFocusable()) {
+	    if (strictParsing || ((sel->tag != anyQName || isSubSelector) && e->id() != ID_A) || e->isFocusable()) {
                 doc->dynamicDomRestyler().addDependency(element, e, ActiveDependency);
 
 		if (e->active())
@@ -1487,10 +1497,8 @@
 
             if(langAttr.length() < langSel.length()) return false;
 
-            if (!strictParsing) {
-                langAttr = langAttr.lower();
-                langSel = langSel.lower();
-            }
+            langAttr = langAttr.lower();
+            langSel = langSel.lower();
 //             kdDebug(6080) << ":lang " << langAttr << "=" << langSel << "?" << endl;
             return (langAttr == langSel || langAttr.startsWith(langSel+"-"));
         }
@@ -1565,6 +1573,8 @@
 	case CSSSelector::PseudoSelection:
 	case CSSSelector::PseudoBefore:
 	case CSSSelector::PseudoAfter:
+	case CSSSelector::PseudoMarker:
+	case CSSSelector::PseudoReplaced:
 	    // Pseudo-elements can only apply to subject
 	    if ( e == element ) {
                 // Pseudo-elements has to be the last sub-selector on subject
@@ -1588,6 +1598,12 @@
                 case CSSSelector::PseudoAfter:
                     dynamicPseudo = RenderStyle::AFTER;
                     break;
+                case CSSSelector::PseudoMarker:
+                    dynamicPseudo = RenderStyle::MARKER;
+                    break;
+                case CSSSelector::PseudoReplaced:
+                    dynamicPseudo = RenderStyle::REPLACED;
+                    break;
                 default:
                     assert(false);
                 }
@@ -1864,7 +1880,7 @@
         CSSProperty *prop = values->at(i);
 	Source source = regular;
 
-	if( prop->m_bImportant ) source = important;
+	if( prop->m_important ) source = important;
 	if( prop->nonCSSHint ) source = NonCSSHint;
 
 	bool first = false;
@@ -2093,7 +2109,7 @@
 
 void CSSStyleSelector::applyRule( int id, DOM::CSSValueImpl *value )
 {
-//      kdDebug( 6080 ) << "applying property " << id << endl;
+//     kdDebug( 6080 ) << "applying property " << getPropertyName(id) << endl;
 
     CSSPrimitiveValueImpl *primitiveValue = 0;
     if(value->isPrimitiveValue()) primitiveValue = static_cast<CSSPrimitiveValueImpl *>(value);
@@ -2120,9 +2136,18 @@
     case CSS_PROP_BACKGROUND_ATTACHMENT:
         HANDLE_BACKGROUND_VALUE(backgroundAttachment, BackgroundAttachment, value)
         break;
+    case CSS_PROP__KHTML_BACKGROUND_CLIP:
+        HANDLE_BACKGROUND_VALUE(backgroundClip, BackgroundClip, value)
+        break;
+    case CSS_PROP__KHTML_BACKGROUND_ORIGIN:
+        HANDLE_BACKGROUND_VALUE(backgroundOrigin, BackgroundOrigin, value)
+        break;
     case CSS_PROP_BACKGROUND_REPEAT:
         HANDLE_BACKGROUND_VALUE(backgroundRepeat, BackgroundRepeat, value)
         break;
+    case CSS_PROP__KHTML_BACKGROUND_SIZE:
+        HANDLE_BACKGROUND_VALUE(backgroundSize, BackgroundSize, value)
+        break;
     case CSS_PROP_BORDER_COLLAPSE:
         HANDLE_INHERIT_AND_INITIAL(borderCollapse, BorderCollapse)
         if(!primitiveValue) break;
@@ -3142,10 +3167,11 @@
                 return;
         }
 
-        if(size < 1) return;
+        if (size < 0) return;
 
         // we never want to get smaller than the minimum font size to keep fonts readable
-        if(size < minFontSize ) size = minFontSize;
+        // do not however maximize zero as that is commonly used for fancy layouting purposes
+        if (size && size < minFontSize) size = minFontSize;
 
         //kdDebug( 6080 ) << "computed raw font size: " << size << endl;
 
@@ -3273,8 +3299,11 @@
     {
         // FIXME: In CSS3, it will be possible to inherit content.  In CSS2 it is not.  This
         // note is a reminder that eventually "inherit" needs to be supported.
-        if (!(style->styleType()==RenderStyle::BEFORE ||
-                style->styleType()==RenderStyle::AFTER))
+
+        // not allowed on non-generated pseudo-elements:
+        if ( style->styleType()==RenderStyle::FIRST_LETTER ||
+             style->styleType()==RenderStyle::FIRST_LINE ||
+             style->styleType()==RenderStyle::SELECTION )
             break;
 
         if (isInitial) {
@@ -3890,6 +3919,50 @@
     }
 }
 
+void CSSStyleSelector::mapBackgroundClip(BackgroundLayer* layer, CSSValueImpl* value)
+{
+    if (value->cssValueType() == CSSValue::CSS_INITIAL) {
+        layer->setBackgroundClip(RenderStyle::initialBackgroundClip());
+        return;
+    }
+
+    if (!value->isPrimitiveValue()) return;
+    CSSPrimitiveValueImpl* primitiveValue = static_cast<CSSPrimitiveValueImpl*>(value);
+    switch (primitiveValue->getIdent()) {
+        case CSS_VAL_BORDER:
+            layer->setBackgroundClip(BGBORDER);
+            break;
+        case CSS_VAL_PADDING:
+            layer->setBackgroundClip(BGPADDING);
+            break;
+        default: // CSS_VAL_CONTENT
+            layer->setBackgroundClip(BGCONTENT);
+            break;
+    }
+}
+
+void CSSStyleSelector::mapBackgroundOrigin(BackgroundLayer* layer, CSSValueImpl* value)
+{
+    if (value->cssValueType() == CSSValue::CSS_INITIAL) {
+        layer->setBackgroundOrigin(RenderStyle::initialBackgroundOrigin());
+        return;
+    }
+
+    if (!value->isPrimitiveValue()) return;
+    CSSPrimitiveValueImpl* primitiveValue = static_cast<CSSPrimitiveValueImpl*>(value);
+    switch (primitiveValue->getIdent()) {
+        case CSS_VAL_BORDER:
+            layer->setBackgroundOrigin(BGBORDER);
+            break;
+        case CSS_VAL_PADDING:
+            layer->setBackgroundOrigin(BGPADDING);
+            break;
+        default: // CSS_VAL_CONTENT
+            layer->setBackgroundOrigin(BGCONTENT);
+            break;
+    }
+}
+
 void CSSStyleSelector::mapBackgroundImage(BackgroundLayer* layer, DOM::CSSValueImpl* value)
 {
     if (value->cssValueType() == CSSValue::CSS_INITIAL) {
@@ -3929,6 +4002,57 @@
     }
 }
 
+
+void CSSStyleSelector::mapBackgroundSize(BackgroundLayer* layer, CSSValueImpl* value)
+{
+    LengthSize b = RenderStyle::initialBackgroundSize();
+
+    if (value->cssValueType() == CSSValue::CSS_INITIAL) {
+        layer->setBackgroundSize(b);
+        return;
+    }
+
+    if (!value->isPrimitiveValue())
+        return;
+
+    CSSPrimitiveValueImpl* primitiveValue = static_cast<CSSPrimitiveValueImpl*>(value);
+    PairImpl* pair = primitiveValue->getPairValue();
+    if (!pair)
+        return;
+
+    CSSPrimitiveValueImpl* first = static_cast<CSSPrimitiveValueImpl*>(pair->first());
+    CSSPrimitiveValueImpl* second = static_cast<CSSPrimitiveValueImpl*>(pair->second());
+
+    if (!first || !second)
+        return;
+
+    Length firstLength, secondLength;
+    int firstType = first->primitiveType();
+    int secondType = second->primitiveType();
+
+    if (firstType == CSSPrimitiveValue::CSS_UNKNOWN)
+        firstLength = Length(Variable);
+    else if (firstType > CSSPrimitiveValue::CSS_PERCENTAGE && firstType < CSSPrimitiveValue::CSS_DEG)
+        firstLength = Length(first->computeLength(style, paintDeviceMetrics), Fixed);
+    else if (firstType == CSSPrimitiveValue::CSS_PERCENTAGE)
+        firstLength = Length((int)first->floatValue(CSSPrimitiveValue::CSS_PERCENTAGE), Percent);
+    else
+        return;
+
+    if (secondType == CSSPrimitiveValue::CSS_UNKNOWN)
+        secondLength = Length(Variable);
+    else if (secondType > CSSPrimitiveValue::CSS_PERCENTAGE && secondType < CSSPrimitiveValue::CSS_DEG)
+        secondLength = Length(second->computeLength(style, paintDeviceMetrics), Fixed);
+    else if (secondType == CSSPrimitiveValue::CSS_PERCENTAGE)
+        secondLength = Length((int)second->floatValue(CSSPrimitiveValue::CSS_PERCENTAGE), Percent);
+    else
+        return;
+
+    b.width = firstLength;
+    b.height = secondLength;
+    layer->setBackgroundSize(b);
+}
+
 void CSSStyleSelector::mapBackgroundXPosition(BackgroundLayer* layer, DOM::CSSValueImpl* value)
 {
     if (value->cssValueType() == CSSValue::CSS_INITIAL) {
Index: khtml/css/cssproperties.h
===================================================================
--- khtml/css/cssproperties.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/css/cssproperties.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -15,123 +15,126 @@
 #define CSS_PROP_BACKGROUND_POSITION 5
 #define CSS_PROP_BACKGROUND_POSITION_X 6
 #define CSS_PROP_BACKGROUND_POSITION_Y 7
-#define CSS_PROP_BORDER_COLLAPSE 8
-#define CSS_PROP_BORDER_SPACING 9
-#define CSS_PROP__KHTML_BORDER_HORIZONTAL_SPACING 10
-#define CSS_PROP__KHTML_BORDER_VERTICAL_SPACING 11
-#define CSS_PROP_BORDER_TOP_COLOR 12
-#define CSS_PROP_BORDER_RIGHT_COLOR 13
-#define CSS_PROP_BORDER_BOTTOM_COLOR 14
-#define CSS_PROP_BORDER_LEFT_COLOR 15
-#define CSS_PROP_BORDER_TOP_STYLE 16
-#define CSS_PROP_BORDER_RIGHT_STYLE 17
-#define CSS_PROP_BORDER_BOTTOM_STYLE 18
-#define CSS_PROP_BORDER_LEFT_STYLE 19
-#define CSS_PROP_BORDER_TOP_WIDTH 20
-#define CSS_PROP_BORDER_RIGHT_WIDTH 21
-#define CSS_PROP_BORDER_BOTTOM_WIDTH 22
-#define CSS_PROP_BORDER_LEFT_WIDTH 23
-#define CSS_PROP_BOTTOM 24
-#define CSS_PROP_CAPTION_SIDE 25
-#define CSS_PROP_CLEAR 26
-#define CSS_PROP_CLIP 27
-#define CSS_PROP_COLOR 28
-#define CSS_PROP_CONTENT 29
-#define CSS_PROP_COUNTER_INCREMENT 30
-#define CSS_PROP_COUNTER_RESET 31
-#define CSS_PROP_CURSOR 32
-#define CSS_PROP_DIRECTION 33
-#define CSS_PROP_DISPLAY 34
-#define CSS_PROP_EMPTY_CELLS 35
-#define CSS_PROP_FLOAT 36
-#define CSS_PROP_FONT_FAMILY 37
-#define CSS_PROP_FONT_SIZE 38
-#define CSS_PROP_FONT_STYLE 39
-#define CSS_PROP_FONT_VARIANT 40
-#define CSS_PROP_FONT_WEIGHT 41
-#define CSS_PROP_HEIGHT 42
-#define CSS_PROP_LEFT 43
-#define CSS_PROP_LETTER_SPACING 44
-#define CSS_PROP_LINE_HEIGHT 45
-#define CSS_PROP_LIST_STYLE_IMAGE 46
-#define CSS_PROP_LIST_STYLE_POSITION 47
-#define CSS_PROP_LIST_STYLE_TYPE 48
-#define CSS_PROP_MARGIN_TOP 49
-#define CSS_PROP_MARGIN_RIGHT 50
-#define CSS_PROP_MARGIN_BOTTOM 51
-#define CSS_PROP_MARGIN_LEFT 52
-#define CSS_PROP__KHTML_MARGIN_START 53
-#define CSS_PROP__KHTML_MARQUEE 54
-#define CSS_PROP__KHTML_MARQUEE_DIRECTION 55
-#define CSS_PROP__KHTML_MARQUEE_INCREMENT 56
-#define CSS_PROP__KHTML_MARQUEE_REPETITION 57
-#define CSS_PROP__KHTML_MARQUEE_SPEED 58
-#define CSS_PROP__KHTML_MARQUEE_STYLE 59
-#define CSS_PROP_MAX_HEIGHT 60
-#define CSS_PROP_MAX_WIDTH 61
-#define CSS_PROP_MIN_HEIGHT 62
-#define CSS_PROP_MIN_WIDTH 63
-#define CSS_PROP_ORPHANS 64
-#define CSS_PROP_OPACITY 65
-#define CSS_PROP_OUTLINE_COLOR 66
-#define CSS_PROP_OUTLINE_OFFSET 67
-#define CSS_PROP_OUTLINE_STYLE 68
-#define CSS_PROP_OUTLINE_WIDTH 69
-#define CSS_PROP_OVERFLOW 70
-#define CSS_PROP_PADDING_TOP 71
-#define CSS_PROP_PADDING_RIGHT 72
-#define CSS_PROP_PADDING_BOTTOM 73
-#define CSS_PROP_PADDING_LEFT 74
-#define CSS_PROP__KHTML_PADDING_START 75
-#define CSS_PROP_PAGE_BREAK_AFTER 76
-#define CSS_PROP_PAGE_BREAK_BEFORE 77
-#define CSS_PROP_PAGE_BREAK_INSIDE 78
-#define CSS_PROP_POSITION 79
-#define CSS_PROP_QUOTES 80
-#define CSS_PROP_RIGHT 81
-#define CSS_PROP_SIZE 82
-#define CSS_PROP_TABLE_LAYOUT 83
-#define CSS_PROP_TEXT_ALIGN 84
-#define CSS_PROP_TEXT_DECORATION 85
-#define CSS_PROP_TEXT_INDENT 86
-#define CSS_PROP_TEXT_SHADOW 87
-#define CSS_PROP_TEXT_TRANSFORM 88
-#define CSS_PROP_TOP 89
-#define CSS_PROP_UNICODE_BIDI 90
-#define CSS_PROP_VERTICAL_ALIGN 91
-#define CSS_PROP_VISIBILITY 92
-#define CSS_PROP_WHITE_SPACE 93
-#define CSS_PROP_WIDOWS 94
-#define CSS_PROP_WIDTH 95
-#define CSS_PROP_WORD_SPACING 96
-#define CSS_PROP_Z_INDEX 97
-#define CSS_PROP_BACKGROUND 98
-#define CSS_PROP_BORDER 99
-#define CSS_PROP_BORDER_COLOR 100
-#define CSS_PROP_BORDER_STYLE 101
-#define CSS_PROP_BORDER_TOP 102
-#define CSS_PROP_BORDER_RIGHT 103
-#define CSS_PROP_BORDER_BOTTOM 104
-#define CSS_PROP_BORDER_LEFT 105
-#define CSS_PROP_BORDER_WIDTH 106
-#define CSS_PROP_BOX_SIZING 107
-#define CSS_PROP_FONT 108
-#define CSS_PROP_LIST_STYLE 109
-#define CSS_PROP_MARGIN 110
-#define CSS_PROP_OUTLINE 111
-#define CSS_PROP_PADDING 112
-#define CSS_PROP_SCROLLBAR_BASE_COLOR 113
-#define CSS_PROP_SCROLLBAR_FACE_COLOR 114
-#define CSS_PROP_SCROLLBAR_SHADOW_COLOR 115
-#define CSS_PROP_SCROLLBAR_HIGHLIGHT_COLOR 116
-#define CSS_PROP_SCROLLBAR_3DLIGHT_COLOR 117
-#define CSS_PROP_SCROLLBAR_DARKSHADOW_COLOR 118
-#define CSS_PROP_SCROLLBAR_TRACK_COLOR 119
-#define CSS_PROP_SCROLLBAR_ARROW_COLOR 120
-#define CSS_PROP__KHTML_FLOW_MODE 121
-#define CSS_PROP__KHTML_USER_INPUT 122
+#define CSS_PROP__KHTML_BACKGROUND_CLIP 8
+#define CSS_PROP__KHTML_BACKGROUND_ORIGIN 9
+#define CSS_PROP__KHTML_BACKGROUND_SIZE 10
+#define CSS_PROP_BORDER_COLLAPSE 11
+#define CSS_PROP_BORDER_SPACING 12
+#define CSS_PROP__KHTML_BORDER_HORIZONTAL_SPACING 13
+#define CSS_PROP__KHTML_BORDER_VERTICAL_SPACING 14
+#define CSS_PROP_BORDER_TOP_COLOR 15
+#define CSS_PROP_BORDER_RIGHT_COLOR 16
+#define CSS_PROP_BORDER_BOTTOM_COLOR 17
+#define CSS_PROP_BORDER_LEFT_COLOR 18
+#define CSS_PROP_BORDER_TOP_STYLE 19
+#define CSS_PROP_BORDER_RIGHT_STYLE 20
+#define CSS_PROP_BORDER_BOTTOM_STYLE 21
+#define CSS_PROP_BORDER_LEFT_STYLE 22
+#define CSS_PROP_BORDER_TOP_WIDTH 23
+#define CSS_PROP_BORDER_RIGHT_WIDTH 24
+#define CSS_PROP_BORDER_BOTTOM_WIDTH 25
+#define CSS_PROP_BORDER_LEFT_WIDTH 26
+#define CSS_PROP_BOTTOM 27
+#define CSS_PROP_CAPTION_SIDE 28
+#define CSS_PROP_CLEAR 29
+#define CSS_PROP_CLIP 30
+#define CSS_PROP_COLOR 31
+#define CSS_PROP_CONTENT 32
+#define CSS_PROP_COUNTER_INCREMENT 33
+#define CSS_PROP_COUNTER_RESET 34
+#define CSS_PROP_CURSOR 35
+#define CSS_PROP_DIRECTION 36
+#define CSS_PROP_DISPLAY 37
+#define CSS_PROP_EMPTY_CELLS 38
+#define CSS_PROP_FLOAT 39
+#define CSS_PROP_FONT_FAMILY 40
+#define CSS_PROP_FONT_SIZE 41
+#define CSS_PROP_FONT_STYLE 42
+#define CSS_PROP_FONT_VARIANT 43
+#define CSS_PROP_FONT_WEIGHT 44
+#define CSS_PROP_HEIGHT 45
+#define CSS_PROP_LEFT 46
+#define CSS_PROP_LETTER_SPACING 47
+#define CSS_PROP_LINE_HEIGHT 48
+#define CSS_PROP_LIST_STYLE_IMAGE 49
+#define CSS_PROP_LIST_STYLE_POSITION 50
+#define CSS_PROP_LIST_STYLE_TYPE 51
+#define CSS_PROP_MARGIN_TOP 52
+#define CSS_PROP_MARGIN_RIGHT 53
+#define CSS_PROP_MARGIN_BOTTOM 54
+#define CSS_PROP_MARGIN_LEFT 55
+#define CSS_PROP__KHTML_MARGIN_START 56
+#define CSS_PROP__KHTML_MARQUEE 57
+#define CSS_PROP__KHTML_MARQUEE_DIRECTION 58
+#define CSS_PROP__KHTML_MARQUEE_INCREMENT 59
+#define CSS_PROP__KHTML_MARQUEE_REPETITION 60
+#define CSS_PROP__KHTML_MARQUEE_SPEED 61
+#define CSS_PROP__KHTML_MARQUEE_STYLE 62
+#define CSS_PROP_MAX_HEIGHT 63
+#define CSS_PROP_MAX_WIDTH 64
+#define CSS_PROP_MIN_HEIGHT 65
+#define CSS_PROP_MIN_WIDTH 66
+#define CSS_PROP_ORPHANS 67
+#define CSS_PROP_OPACITY 68
+#define CSS_PROP_OUTLINE_COLOR 69
+#define CSS_PROP_OUTLINE_OFFSET 70
+#define CSS_PROP_OUTLINE_STYLE 71
+#define CSS_PROP_OUTLINE_WIDTH 72
+#define CSS_PROP_OVERFLOW 73
+#define CSS_PROP_PADDING_TOP 74
+#define CSS_PROP_PADDING_RIGHT 75
+#define CSS_PROP_PADDING_BOTTOM 76
+#define CSS_PROP_PADDING_LEFT 77
+#define CSS_PROP__KHTML_PADDING_START 78
+#define CSS_PROP_PAGE_BREAK_AFTER 79
+#define CSS_PROP_PAGE_BREAK_BEFORE 80
+#define CSS_PROP_PAGE_BREAK_INSIDE 81
+#define CSS_PROP_POSITION 82
+#define CSS_PROP_QUOTES 83
+#define CSS_PROP_RIGHT 84
+#define CSS_PROP_SIZE 85
+#define CSS_PROP_TABLE_LAYOUT 86
+#define CSS_PROP_TEXT_ALIGN 87
+#define CSS_PROP_TEXT_DECORATION 88
+#define CSS_PROP_TEXT_INDENT 89
+#define CSS_PROP_TEXT_SHADOW 90
+#define CSS_PROP_TEXT_TRANSFORM 91
+#define CSS_PROP_TOP 92
+#define CSS_PROP_UNICODE_BIDI 93
+#define CSS_PROP_VERTICAL_ALIGN 94
+#define CSS_PROP_VISIBILITY 95
+#define CSS_PROP_WHITE_SPACE 96
+#define CSS_PROP_WIDOWS 97
+#define CSS_PROP_WIDTH 98
+#define CSS_PROP_WORD_SPACING 99
+#define CSS_PROP_Z_INDEX 100
+#define CSS_PROP_BACKGROUND 101
+#define CSS_PROP_BORDER 102
+#define CSS_PROP_BORDER_COLOR 103
+#define CSS_PROP_BORDER_STYLE 104
+#define CSS_PROP_BORDER_TOP 105
+#define CSS_PROP_BORDER_RIGHT 106
+#define CSS_PROP_BORDER_BOTTOM 107
+#define CSS_PROP_BORDER_LEFT 108
+#define CSS_PROP_BORDER_WIDTH 109
+#define CSS_PROP_BOX_SIZING 110
+#define CSS_PROP_FONT 111
+#define CSS_PROP_LIST_STYLE 112
+#define CSS_PROP_MARGIN 113
+#define CSS_PROP_OUTLINE 114
+#define CSS_PROP_PADDING 115
+#define CSS_PROP_SCROLLBAR_BASE_COLOR 116
+#define CSS_PROP_SCROLLBAR_FACE_COLOR 117
+#define CSS_PROP_SCROLLBAR_SHADOW_COLOR 118
+#define CSS_PROP_SCROLLBAR_HIGHLIGHT_COLOR 119
+#define CSS_PROP_SCROLLBAR_3DLIGHT_COLOR 120
+#define CSS_PROP_SCROLLBAR_DARKSHADOW_COLOR 121
+#define CSS_PROP_SCROLLBAR_TRACK_COLOR 122
+#define CSS_PROP_SCROLLBAR_ARROW_COLOR 123
+#define CSS_PROP__KHTML_FLOW_MODE 124
+#define CSS_PROP__KHTML_USER_INPUT 125
 
 #define CSS_PROP_MAX CSS_PROP_Z_INDEX
-#define CSS_PROP_TOTAL 123
+#define CSS_PROP_TOTAL 126
 #endif
 
Index: khtml/css/cssparser.h
===================================================================
--- khtml/css/cssparser.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/css/cssparser.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -2,6 +2,7 @@
  * This file is part of the DOM implementation for KDE.
  *
  * Copyright (C) 2003 Lars Knoll (knoll@kde.org)
+ * Copyright (C) 2004, 2005, 2006 Apple Computer, Inc.
  *
  * This library is free software; you can redistribute it and/or
  * modify it under the terms of the GNU Library General Public
@@ -23,6 +24,7 @@
 
 #include <qstring.h>
 #include <qcolor.h>
+#include <qvaluevector.h>
 #include <dom/dom_string.h>
 
 namespace DOM {
@@ -78,16 +80,15 @@
 
     class ValueList {
     public:
-	ValueList();
+        ValueList() : m_current(0) { }
 	~ValueList();
-	void addValue( const Value &val );
-	Value *current() { return currentValue < numValues ? values + currentValue : 0; }
-	Value *next() { ++currentValue; return current(); }
-        bool isLast() const { return currentValue+1 >= numValues; }
-	Value *values;
-	int numValues;
-	int maxValues;
-	int currentValue;
+        void addValue(const Value& v) { m_values.append(v); }
+        unsigned int size() const { return m_values.size(); }
+        Value* current() { return m_current < m_values.size() ? &m_values[m_current] : 0; }
+        Value* next() { ++m_current; return current(); }
+    private:
+        QValueVector<Value> m_values;
+	unsigned int m_current;
     };
 
     class CSSParser
@@ -115,15 +116,16 @@
 	CSSStyleDeclarationImpl *createStyleDeclaration( CSSStyleRuleImpl *rule );
 	void clearProperties();
 
-	bool parseValue( int propId, bool important, int expected=1 );
-	bool parseShortHand( const int *properties, int numProperties, bool important );
-	bool parse4Values( const int *properties, bool important );
+	bool parseValue( int propId, bool important );
+	bool parseShortHand( int propId, const int *properties, int numProperties, bool important );
+	bool parse4Values( int propId, const int *properties, bool important );
 	bool parseContent( int propId, bool important );
 
         CSSValueImpl* parseBackgroundColor();
         CSSValueImpl* parseBackgroundImage();
         CSSValueImpl* parseBackgroundPositionXY(bool& xFound, bool& yFound);
         void parseBackgroundPosition(CSSValueImpl*& value1, CSSValueImpl*& value2);
+        CSSValueImpl* parseBackgroundSize();
 
         bool parseBackgroundProperty(int propId, int& propId1, int& propId2, CSSValueImpl*& retValue1, CSSValueImpl*& retValue2);
         bool parseBackgroundShorthand(bool important);
@@ -147,6 +149,7 @@
         // CSS3 Parsing Routines (for properties specific to CSS3)
         bool parseShadow(int propId, bool important);
 
+        bool parseBorderImage(int propId, bool important);
 
     public:
 	bool strict;
@@ -159,7 +162,11 @@
 	CSSProperty **parsedProperties;
 	int numParsedProperties;
 	int maxParsedProperties;
-	bool inParseShortHand;
+
+        int m_inParseShorthand;
+        int m_currentShorthand;
+        bool m_implicitShorthand;
+
 	static CSSParser *currentParser;
 
 	// tokenizer methods and data
@@ -172,6 +179,8 @@
 	int yyparse();
         void runParser(int length);
 
+        bool inShorthand() const { return m_inParseShorthand; }
+
 	unsigned short *data;
 	unsigned short *yytext;
 	unsigned short *yy_c_buf_p;
Index: khtml/css/css_valueimpl.h
===================================================================
--- khtml/css/css_valueimpl.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/css/css_valueimpl.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -2,7 +2,7 @@
  * This file is part of the DOM implementation for KDE.
  *
  * Copyright (C) 1999-2003 Lars Knoll (knoll@kde.org)
- *           (C) 2002 Apple Computer, Inc.
+ *           (C) 2004, 2005, 2006 Apple Computer, Inc.
  *           (C) 2005 Allan Sandfeld Jensen (kde@carewolf.com)
  *
  * This library is free software; you can redistribute it and/or
@@ -37,12 +37,14 @@
     class CachedImage;
 }
 
+
 namespace DOM {
 
 class CSSRuleImpl;
 class CSSValueImpl;
 class NodeImpl;
 class CounterImpl;
+class PairImpl;
 
 
 class CSSStyleDeclarationImpl : public StyleBaseImpl
@@ -162,6 +164,7 @@
     CSSPrimitiveValueImpl(CounterImpl *c);
     CSSPrimitiveValueImpl( RectImpl *r);
     CSSPrimitiveValueImpl(QRgb color);
+    CSSPrimitiveValueImpl(PairImpl *p);
 
     virtual ~CSSPrimitiveValueImpl();
 
@@ -207,6 +210,10 @@
 	return ( m_type != CSSPrimitiveValue::CSS_RGBCOLOR ? 0 : m_value.rgbcolor );
     }
 
+    PairImpl* getPairValue() const {
+        return (m_type != CSSPrimitiveValue::CSS_PAIR ? 0 : m_value.pair);
+    }
+
     virtual bool isPrimitiveValue() const { return true; }
     virtual unsigned short cssValueType() const;
 
@@ -226,6 +233,7 @@
 	CounterImpl *counter;
 	RectImpl *rect;
         QRgb rgbcolor;
+        PairImpl* pair;
     } m_value;
 };
 
@@ -277,6 +285,29 @@
     CSSPrimitiveValueImpl *m_left;
 };
 
+// A primitive value representing a pair.  This is useful for properties like border-radius, background-size/position,
+// and border-spacing (all of which are space-separated sets of two values).  At the moment we are only using it for
+// border-radius and background-size, but (FIXME) border-spacing and background-position could be converted over to use
+// it (eliminating some extra -webkit- internal properties).
+class PairImpl : public khtml::Shared<PairImpl> {
+public:
+    PairImpl() : m_first(0), m_second(0) { }
+    PairImpl(CSSPrimitiveValueImpl* first, CSSPrimitiveValueImpl* second)
+        : m_first(first), m_second(second) { if (first) first->ref(); if (second) second->ref(); }
+    virtual ~PairImpl();
+
+    CSSPrimitiveValueImpl* first() const { return m_first; }
+    CSSPrimitiveValueImpl* second() const { return m_second; }
+
+    void setFirst(CSSPrimitiveValueImpl* first);
+    void setSecond(CSSPrimitiveValueImpl* second);
+
+protected:
+    CSSPrimitiveValueImpl* m_first;
+    CSSPrimitiveValueImpl* m_second;
+};
+
+
 class CSSImageValueImpl : public CSSPrimitiveValueImpl, public khtml::CachedObjectClient
 {
 public:
@@ -384,14 +415,14 @@
     CSSProperty()
     {
 	m_id = -1;
-	m_bImportant = false;
+	m_important = false;
 	nonCSSHint = false;
         m_value = 0;
     }
     CSSProperty(const CSSProperty& o)
     {
         m_id = o.m_id;
-        m_bImportant = o.m_bImportant;
+        m_important = o.m_important;
         nonCSSHint = o.nonCSSHint;
         m_value = o.m_value;
         if (m_value) m_value->ref();
@@ -408,14 +439,18 @@
 	}
     }
 
+    int id() const { return m_id; }
+
+    bool isImportant() const { return m_important; }
+
     CSSValueImpl *value() const { return m_value; }
 
     DOM::DOMString cssText() const;
 
     // make sure the following fits in 4 bytes.
-    signed int  m_id 	: 29;
-    bool m_bImportant 	: 1;
-    bool nonCSSHint 	: 1;
+    signed int  m_id   : 29;
+    bool m_important   : 1;
+    bool nonCSSHint    : 1;
 protected:
     CSSValueImpl *m_value;
 };
Index: khtml/css/cssvalues.h
===================================================================
--- khtml/css/cssvalues.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/css/cssvalues.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -278,7 +278,10 @@
 #define CSS_VAL_SLIDE 267
 #define CSS_VAL_ALTERNATE 268
 #define CSS_VAL_UNFURL 269
+#define CSS_VAL_BORDER 270
+#define CSS_VAL_CONTENT 271
+#define CSS_VAL_PADDING 272
 
-#define CSS_VAL_TOTAL 270
+#define CSS_VAL_TOTAL 273
 #endif
 
Index: khtml/css/css_stylesheetimpl.cpp
===================================================================
--- khtml/css/css_stylesheetimpl.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/css/css_stylesheetimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -194,6 +194,8 @@
     // HIERARCHY_REQUEST_ERR: Raised if the rule cannot be inserted at the specified index e.g. if an
     //@import rule is inserted after a standard rule set or other at-rule.
     m_lstChildren->insert(index, r);
+    if (m_doc) 
+        m_doc->updateStyleSelector(true /*shallow*/);
     return index;
 }
 
@@ -211,6 +213,8 @@
         return;
     }
     b->deref();
+    if (m_doc)
+        m_doc->updateStyleSelector(true /*shallow*/);
 }
 
 void CSSStyleSheetImpl::addNamespace(CSSParser* p, const DOM::DOMString& prefix, const DOM::DOMString& uri)
Index: khtml/css/css_base.h
===================================================================
--- khtml/css/css_base.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/css/css_base.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -141,25 +141,30 @@
             PseudoNthOfType,
             PseudoNthLastOfType,
             PseudoOnlyOfType,
-            PseudoFirstLine,
-	    PseudoFirstLetter,
 	    PseudoLink,
 	    PseudoVisited,
 	    PseudoHover,
 	    PseudoFocus,
 	    PseudoActive,
             PseudoTarget,
-	    PseudoBefore,
-	    PseudoAfter,
             PseudoLang,
             PseudoNot,
             PseudoContains,
             PseudoRoot,
-            PseudoSelection,
             PseudoEnabled,
             PseudoDisabled,
             PseudoChecked,
-            PseudoIndeterminate
+            PseudoIndeterminate,
+// pseudo-elements:
+    // inherited:
+            PseudoFirstLine,
+            PseudoFirstLetter,
+            PseudoSelection,
+    // generated:
+            PseudoBefore,
+            PseudoAfter,
+            PseudoMarker,
+            PseudoReplaced
 	};
 
 	PseudoType pseudoType() const {
@@ -178,8 +183,8 @@
 	Relation relation     : 3;
 	mutable Match 	 match         : 4;
 	bool	nonCSSHint : 1;
-	unsigned int pseudoId : 3;
-	mutable PseudoType _pseudoType : 5;
+	unsigned int pseudoId : 4;
+	mutable PseudoType _pseudoType : 6;
 
     private:
 	void extractPseudoType() const;
Index: khtml/css/cssproperties.in
===================================================================
--- khtml/css/cssproperties.in	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/css/cssproperties.in	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -19,6 +19,10 @@
 # IE Extensions
 background-position-x
 background-position-y
+# CSS3 Extensions
+-khtml-background-clip
+-khtml-background-origin
+-khtml-background-size
 
 border-collapse
 border-spacing
Index: khtml/misc/loader_client.h
===================================================================
--- khtml/misc/loader_client.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/misc/loader_client.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -26,7 +26,7 @@
         // return whether we need manual update
         // don't ref() or deref() elements in setPixmap!!
 	virtual void setPixmap(const QPixmap &, const QRect&, CachedImage *);
-	virtual void setStyleSheet(const DOM::DOMString &/*url*/, const DOM::DOMString &/*sheet*/);
+	virtual void setStyleSheet(const DOM::DOMString &/*url*/, const DOM::DOMString &/*sheet*/, const DOM::DOMString &/*charset*/);
 	virtual void notifyFinished(CachedObject * /*finishedObj*/);
 	virtual void error(int err, const QString &text);
     };
Index: khtml/misc/loader.h
===================================================================
--- khtml/misc/loader.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/misc/loader.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -130,10 +130,14 @@
 	void setStatus(Status s) { m_status = s; }
 	Status status() const { return m_status; }
 
+        virtual void setCharset( const QString& /*charset*/ ) {}
+
         QTextCodec* codecForBuffer( const QString& charset, const QByteArray& buffer ) const;
 
 	int size() const { return m_size; }
 
+        bool isLoaded() const { return !m_loading; }
+
         bool free() const { return m_free; }
 
         KIO::CacheControl cachePolicy() const { return m_cachePolicy; }
@@ -203,6 +207,7 @@
 	virtual void error( int err, const char *text );
 
         virtual bool schedule() const { return true; }
+        void setCharsetHint( const QString& charset ) { m_charsetHint = charset; }
         void setCharset( const QString& charset ) { m_charset = charset; }
 
     protected:
@@ -210,6 +215,7 @@
 
 	DOM::DOMString m_sheet;
         QString m_charset;
+        QString m_charsetHint;
 	int m_err;
 	QString m_errText;
     };
@@ -255,11 +261,13 @@
 	virtual ~CachedImage();
 
 	const QPixmap &pixmap() const;
-	const QPixmap &tiled_pixmap(const QColor& bg);
+	const QPixmap &scaled_pixmap(int xWidth, int xHeight);
+	const QPixmap &tiled_pixmap(const QColor& bg, int xWidth = -1, int xHeight = -1);
 
         QSize pixmap_size() const;    // returns the size of the complete (i.e. when finished) loading
         QRect valid_rect() const;     // returns the rectangle of pixmap that has been loaded already
 
+        bool canRender() const { return !isErrorImage() && pixmap_size().width() > 0 && pixmap_size().height() > 0; }
         void ref(CachedObjectClient *consumer);
 	virtual void deref(CachedObjectClient *consumer);
 
@@ -305,8 +313,10 @@
 #endif
 	QMovie* m;
         QPixmap* p;
+	QPixmap* scaled;
 	QPixmap* bg;
         QRgb bgColor;
+        QSize bgSize;
         mutable QPixmap* pixPart;
 
         ImageSource* imgSource;
@@ -337,7 +347,7 @@
  	~DocLoader();
 
 	CachedImage *requestImage( const DOM::DOMString &url);
-	CachedCSSStyleSheet *requestStyleSheet( const DOM::DOMString &url, const QString& charset,
+	CachedCSSStyleSheet *requestStyleSheet( const DOM::DOMString &url, const QString& charsetHint,
 						const char *accept = "text/css", bool userSheet = false );
         CachedScript *requestScript( const DOM::DOMString &url, const QString& charset);
 
Index: khtml/misc/loader.cpp
===================================================================
--- khtml/misc/loader.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/misc/loader.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -182,6 +182,7 @@
     uchar* d = ( uchar* ) buffer.data();
     int s = buffer.size();
 
+    // BOM
     if ( s >= 3 &&
          d[0] == 0xef && d[1] == 0xbb && d[2] == 0xbf)
          return QTextCodec::codecForMib( 106 ); // UTF-8
@@ -190,6 +191,7 @@
                     (d[0] == 0xfe && d[1] == 0xff)))
         return QTextCodec::codecForMib( 1000 ); // UCS-2
 
+    // Link or @charset
     if(!charset.isEmpty())
     {
 	QTextCodec* c = KGlobal::charsets()->codecForName(charset);
@@ -200,7 +202,8 @@
         return c;
     }
 
-    return QTextCodec::codecForMib(4); // latin-1
+    // Default
+    return QTextCodec::codecForMib( 4 ); // latin 1
 }
 
 // -------------------------------------------------------------------------------------------
@@ -240,7 +243,7 @@
 	if (m_hadError)
 	    c->error( m_err, m_errText );
 	else
-	    c->setStyleSheet( m_url, m_sheet );
+	    c->setStyleSheet( m_url, m_sheet, m_charset );
     }
 }
 
@@ -250,7 +253,16 @@
     buffer.close();
     setSize(buffer.buffer().size());
 
-    QTextCodec* c = codecForBuffer( m_charset, buffer.buffer() );
+//     QString charset = checkCharset( buffer.buffer() );
+    QTextCodec* c = 0;
+    if (!m_charset.isEmpty()) {
+        c = KGlobal::charsets()->codecForName(m_charset);
+        if(c->mibEnum() == 11)  c = QTextCodec::codecForName("iso8859-8-i");
+    }
+    else {
+        c = codecForBuffer( m_charsetHint, buffer.buffer() );
+        m_charset = c->name();
+    }
     QString data = c->toUnicode( buffer.buffer().data(), m_size );
     // workaround Qt bugs
     m_sheet = static_cast<QChar>(data[0]) == QChar::byteOrderMark ? DOMString(data.mid( 1 ) ) : DOMString(data);
@@ -268,7 +280,7 @@
     // it() first increments, then returnes the current item.
     // this avoids skipping an item when setStyleSheet deletes the "current" one.
     for (QPtrDictIterator<CachedObjectClient> it( m_clients ); it.current();)
-        it()->setStyleSheet( m_url, m_sheet );
+        it()->setStyleSheet( m_url, m_sheet, m_charset );
 }
 
 
@@ -285,6 +297,28 @@
         it()->error( m_err, m_errText );
 }
 
+#if 0
+QString CachedCSSStyleSheet::checkCharset(const QByteArray& buffer ) const
+{
+    int s = buffer.size();
+    if (s <= 12) return m_charset;
+
+    // @charset has to be first or directly after BOM.
+    // CSS 2.1 says @charset should win over BOM, but since more browsers support BOM
+    // than @charset, we default to that.
+    const char* d = (const char*) buffer.data();
+    if (strncmp(d, "@charset \"",10) == 0)
+    {
+        // the string until "; is the charset name
+        char *p = strchr(d+10, '"');
+        if (p == 0) return m_charset;
+        QString charset = QString::fromAscii(d+10, p-(d+10));
+	return charset;
+    }
+    return m_charset;
+}
+#endif
+
 // -------------------------------------------------------------------------------------------
 
 CachedScript::CachedScript(DocLoader* dl, const DOMString &url, KIO::CacheControl _cachePolicy, const char*)
@@ -441,6 +475,7 @@
     p = 0;
     pixPart = 0;
     bg = 0;
+    scaled = 0;
     bgColor = qRgba( 0, 0, 0, 0xFF );
     typeChecked = false;
     isFullyTransparent = false;
@@ -489,10 +524,12 @@
 #define BGMINWIDTH      32
 #define BGMINHEIGHT     32
 
-const QPixmap &CachedImage::tiled_pixmap(const QColor& newc)
+const QPixmap &CachedImage::tiled_pixmap(const QColor& newc, int xWidth, int xHeight)
 {
     static QRgb bgTransparent = qRgba( 0, 0, 0, 0xFF );
-    if ( (bgColor != bgTransparent) && (bgColor != newc.rgb()) ) {
+    if ( ( (bgColor != bgTransparent) && (bgColor != newc.rgb()) ) ||
+         ( bgSize != QSize(xWidth, xHeight)) )
+    {
         delete bg; bg = 0;
     }
 
@@ -508,20 +545,30 @@
 
     bool isvalid = newc.isValid();
     QSize s(pixmap_size());
-    int w = r.width();
-    int h = r.height();
-    assert(s.width() == r.width() && s.height() == s.height());
+    int w = xWidth;
+    int h = xHeight;
+    if (w == -1) xWidth = w = s.width();
+    if (h == -1) xHeight = h = s.height();
 
     const QPixmap* src; //source for pretiling, if any
+
+    //See whether we should scale
+    if (xWidth != s.width() || xHeight != s.height()) {
+        src = &scaled_pixmap(xWidth, xHeight);
+        bgSize = QSize(xWidth, xHeight);
+    } else {
+        src = &r;
+        bgSize = QSize(-1,-1);
+    }
+
     //See whether we can - and should - pre-blend
     if (isvalid && (r.hasAlphaChannel() || r.mask() )) {
-        bg = new QPixmap(w, h, r.depth());
+        bg = new QPixmap(xWidth, xHeight, r.depth());
         bg->fill(newc);
-        bitBlt(bg, 0, 0, &r);
+        bitBlt(bg, 0, 0, src);
         bgColor = newc.rgb();
         src     = bg;
     } else {
-        src     = &r;
         bgColor = bgTransparent;
     }
 
@@ -529,23 +576,23 @@
     if ( w*h < 8192 )
     {
         if ( r.width() < BGMINWIDTH )
-            w = ((BGMINWIDTH-1) / s.width() + 1) * s.width();
+            w = ((BGMINWIDTH-1) / xWidth + 1) * xWidth;
         if ( r.height() < BGMINHEIGHT )
-            h = ((BGMINHEIGHT-1) / s.height() + 1) * s.height();
+            h = ((BGMINHEIGHT-1) / xHeight + 1) * xHeight;
     }
-    if ( w != r.width() || h != r.height() )
+    if ( w != xWidth  || h != xHeight )
     {
 //         kdDebug() << "pre-tiling " << s.width() << "," << s.height() << " to " << w << "," << h << endl;
         QPixmap* oldbg = bg;
         bg = new QPixmap(w, h, r.depth());
 
         //Tile horizontally on the first stripe
-        for (int x = 0; x < w; x += r.width())
-            copyBlt(bg, x, 0, src, 0, 0, r.width(), r.height());
+        for (int x = 0; x < w; x += xWidth)
+            copyBlt(bg, x, 0, src, 0, 0, xWidth, xHeight);
 
         //Copy first stripe down
-        for (int y = r.height(); y < h; y += r.height())
-            copyBlt(bg, 0, y, bg, 0, 0, w, r.height());
+        for (int y = xHeight; y < h; y += xHeight)
+            copyBlt(bg, 0, y, bg, 0, 0, w, xHeight);
 
         if ( src == oldbg )
             delete oldbg;
@@ -554,9 +601,30 @@
     if (bg)
         return *bg;
 
-    return r;
+    return *src;
 }
 
+const QPixmap &CachedImage::scaled_pixmap( int xWidth, int xHeight )
+{
+    if (scaled) {
+        if (scaled->width() == xWidth && scaled->height() == xHeight)
+            return *scaled;
+        delete scaled;
+    }
+    const QPixmap &r = pixmap();
+    if (r.isNull()) return r;
+
+//     kdDebug() << "scaling " << r.width() << "," << r.height() << " to " << xWidth << "," << xHeight << endl;
+
+    QImage image = r.convertToImage().smoothScale(xWidth, xHeight);
+
+    scaled = new QPixmap(xWidth, xHeight, r.depth());
+    scaled->convertFromImage(image);
+
+    return *scaled;
+}
+
+
 const QPixmap &CachedImage::pixmap( ) const
 {
     if(m_hadError)
@@ -734,7 +802,9 @@
     delete m;   m = 0;
     delete p;   p = 0;
     delete bg;  bg = 0;
+    delete scaled;  scaled = 0;
     bgColor = qRgba( 0, 0, 0, 0xff );
+    bgSize = QSize(-1,-1);
     delete pixPart; pixPart = 0;
 
     formatType = 0;
@@ -960,7 +1030,7 @@
 
     CachedCSSStyleSheet* s = Cache::requestObject<CachedCSSStyleSheet, CachedObject::CSSStyleSheet>( this, fullURL, accept );
     if ( s && !charset.isEmpty() ) {
-        s->setCharset( charset );
+        s->setCharsetHint( charset );
     }
     return s;
 }
@@ -1094,6 +1164,8 @@
   }
   else
   {
+      QString cs = j->queryMetaData("charset");
+      if (!cs.isEmpty()) r->object->setCharset(cs);
       r->object->data(r->m_buffer, true);
       emit requestDone( r->m_docLoader, r->object );
       time_t expireDate = j->queryMetaData("expire-date").toLong();
@@ -1274,10 +1346,34 @@
     cache->setAutoDelete( true );
 
 #ifndef NDEBUG
-    for (QDictIterator<CachedObject> it(*cache); it.current(); ++it)
-        assert(it.current()->canDelete());
-    for (freeList->first(); freeList->current(); freeList->next())
-        assert(freeList->current()->canDelete());
+    bool crash = false;
+    for (QDictIterator<CachedObject> it(*cache); it.current(); ++it) {
+        if (!it.current()->canDelete()) {
+            kdDebug( 6060 ) << " Object in cache still linked to" << endl;
+            kdDebug( 6060 ) << " -> URL: " << it.current()->url() << endl;
+            kdDebug( 6060 ) << " -> #clients: " << it.current()->count() << endl;
+            crash = true;
+//         assert(it.current()->canDelete());
+        }
+    }
+    for (freeList->first(); freeList->current(); freeList->next()) {
+        if (!freeList->current()->canDelete()) {
+            kdDebug( 6060 ) << " Object in freelist still linked to" << endl;
+            kdDebug( 6060 ) << " -> URL: " << freeList->current()->url() << endl;
+            kdDebug( 6060 ) << " -> #clients: " << freeList->current()->count() << endl;
+            crash = true;
+            /*
+            QPtrDictIterator<CachedObjectClient> it(freeList->current()->m_clients);
+            for(;it.current(); ++it) {
+                if (dynamic_cast<RenderObject*>(it.current())) {
+                    kdDebug( 6060 ) << " --> RenderObject" << endl;
+                } else
+                    kdDebug( 6060 ) << " --> Something else" << endl;
+            }*/
+        }
+//         assert(freeList->current()->canDelete());
+    }
+    assert(!crash);
 #endif
 
     delete cache; cache = 0;
@@ -1538,7 +1634,7 @@
 // --------------------------------------
 
 void CachedObjectClient::setPixmap(const QPixmap &, const QRect&, CachedImage *) {}
-void CachedObjectClient::setStyleSheet(const DOM::DOMString &/*url*/, const DOM::DOMString &/*sheet*/) {}
+void CachedObjectClient::setStyleSheet(const DOM::DOMString &/*url*/, const DOM::DOMString &/*sheet*/, const DOM::DOMString &/*charset*/) {}
 void CachedObjectClient::notifyFinished(CachedObject * /*finishedObj*/) {}
 void CachedObjectClient::error(int /*err*/, const QString &/*text*/) {}
 
Index: khtml/misc/khtmllayout.h
===================================================================
--- khtml/misc/khtmllayout.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/misc/khtmllayout.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -51,7 +51,9 @@
         { return _length == o._length; }
         bool operator!=(const Length& o) const
         { return _length != o._length; }
-
+        void setValue(LengthType t, int v) {
+            _length = 0; l.value = v; l.type = t; l.quirk = false;
+        }
 	/*
 	 * works only for Fixed and Percent, returns -1 otherwise
 	 */
Index: khtml/test_regression.cpp
===================================================================
--- khtml/test_regression.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/test_regression.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -31,6 +31,7 @@
 #include <signal.h>
 
 #include <kapplication.h>
+#include <kstandarddirs.h>
 #include <qimage.h>
 #include <qfile.h>
 #include "test_regression.h"
@@ -468,16 +469,21 @@
 
     if (args->isSet("xvfb"))
     {
-        if ( ::access( "/usr/X11R6/bin/Xvfb", X_OK ) ) {
-            fprintf( stderr, "ERROR: We need /usr/X11R6/bin/Xvfb to be installed for reliable results\n" );
+        QString xvfbPath = KStandardDirs::findExe("Xvfb");
+        if ( xvfbPath.isEmpty() ) {
+            fprintf( stderr, "ERROR: We need Xvfb to be installed for reliable results\n" );
             exit( 1 );
         }
+        
+        QCString xvfbPath8 = QFile::encodeName(xvfbPath);
 
         xvfb = fork();
         if ( !xvfb ) {
-            char buffer[1000];
-            sprintf( buffer, "%s/resources,/usr/X11R6/lib/X11/fonts/75dpi:unscaled,/usr/X11R6/lib/X11/fonts/misc:unscaled,/usr/X11R6/lib/X11/fonts/Type1,/usr/share/fonts/X11/misc,/usr/share/fonts/X11/75dpi:unscaled,/usr/share/fonts/X11/Type1", (const char *)baseDir );
-            execl( "/usr/X11R6/bin/Xvfb", "/usr/X11R6/bin/Xvfb", "-once", "-dpi", "100", "-screen", "0", "1024x768x16", "-ac", "-fp", buffer, ":47", (char*)NULL );
+            char buffer[2000];
+            sprintf( buffer, "%s/resources,/usr/X11R6/lib/X11/fonts/75dpi:unscaled,/usr/X11R6/lib/X11/fonts/misc:unscaled,/usr/X11R6/lib/X11/fonts/Type1,/usr/share/fonts/X11/misc,/usr/share/fonts/X11/75dpi:unscaled,/usr/share/fonts/X11/Type1,"
+            "/usr/lib/X11/fonts/75dpi:unscaled,/usr/lib/X11/fonts/misc:unscaled,/usr/lib/X11/fonts/Type1",
+             (const char *)baseDir );
+            execl( xvfbPath8.data(), xvfbPath8.data(), "-once", "-dpi", "100", "-screen", "0", "1024x768x16", "-ac", "-fp", buffer, ":47", (char*)NULL );
         }
 
         setenv( "DISPLAY", ":47", 1 );
Index: khtml/xml/dom_textimpl.cpp
===================================================================
--- khtml/xml/dom_textimpl.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/xml/dom_textimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -39,25 +39,7 @@
 
 static DOMString escapeHTML( const DOMString& in )
 {
-    //FIXME: this is rather slow
-    DOMString s;
-    for ( unsigned int i = 0; i < in.length(); ++i ) {
-        switch( in[i].latin1() ) {
-        case '&':
-            s += "&amp;";
-            break;
-        case '<':
-            s += "&lt;";
-            break;
-        case '>':
-            s += "&gt;";
-            break;
-        default:
-            s += DOMString( in[i] );
-        }
-    }
-
-    return s;
+    return in.implementation()->escapeHTML();
 }
 
 CharacterDataImpl::CharacterDataImpl(DocumentPtr *doc, DOMStringImpl* _text)
@@ -395,14 +377,13 @@
         return true;
     }
 
-    if (par->isInline()) {
+    RenderObject *prev = previousRenderer();
+    if (par->isInlineFlow()) {
         // <span><div/> <div/></span>
-        RenderObject *prev = previousRenderer();
-        if (prev && prev->isRenderBlock()) {
+        if (prev && !prev->isInline()) {
             return false;
         }
     } else {
-        RenderObject *prev = previousRenderer();
         if (par->isRenderBlock() && !par->childrenInline() && (!prev || !prev->isInline())) {
             return false;
         }
Index: khtml/xml/dom_nodeimpl.cpp
===================================================================
--- khtml/xml/dom_nodeimpl.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/xml/dom_nodeimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -788,6 +788,8 @@
 	ch = Inherit;
     else if ( *s1 == *s2 )
 	ch = NoChange;
+    else if (s1->useNormalContent() != s2->useNormalContent())
+        ch = Detach; // when we add generated content all children must be detached
     else if ( s1->inheritedNotEqual( s2 ) )
 	ch = Inherit;
 
@@ -800,6 +802,8 @@
         ch = NoInherit;
     if (ch == NoChange && pseudoDiff(s1, s2, khtml::RenderStyle::AFTER))
         ch = NoInherit;
+    if (ch == NoChange && pseudoDiff(s1, s2, khtml::RenderStyle::MARKER))
+        ch = NoInherit;
     if (ch == NoChange && pseudoDiff(s1, s2, khtml::RenderStyle::SELECTION))
         ch = NoInherit;
     if (ch == NoChange && pseudoDiff(s1, s2, khtml::RenderStyle::FIRST_LINE))
Index: khtml/xml/dom_elementimpl.cpp
===================================================================
--- khtml/xml/dom_elementimpl.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/xml/dom_elementimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -824,18 +824,22 @@
 
 DOMString ElementImpl::toString() const
 {
-    DOMString result = openTagStartToString();
+    QString result = openTagStartToString().string(); //Accumulate in QString, since DOMString can't append well.
 
     if (hasChildNodes()) {
 	result += ">";
 
 	for (NodeImpl *child = firstChild(); child != NULL; child = child->nextSibling()) {
-	    result += child->toString();
+	    DOMString kid = child->toString();
+	    result += QConstString(kid.unicode(), kid.length()).string();
 	}
 
 	result += "</";
-	result += tagName();
+	result += tagName().string();
 	result += ">";
+    } else if (result.length() == 1) {
+	// ensure we dont get results like < /> can happen when serialize document
+        result = "";
     } else {
 	result += " />";
     }
Index: khtml/xml/dom_xmlimpl.cpp
===================================================================
--- khtml/xml/dom_xmlimpl.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/xml/dom_xmlimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -430,12 +430,13 @@
     return m_sheet;
 }
 
-void ProcessingInstructionImpl::setStyleSheet(const DOM::DOMString &url, const DOM::DOMString &sheet)
+void ProcessingInstructionImpl::setStyleSheet(const DOM::DOMString &url, const DOM::DOMString &sheet, const DOM::DOMString &charset)
 {
     if (m_sheet)
 	m_sheet->deref();
     m_sheet = new CSSStyleSheetImpl(getDocument(), url);
     m_sheet->ref();
+    m_sheet->setCharset(charset);
     m_sheet->parseString(sheet);
     if (m_cachedSheet)
 	m_cachedSheet->deref(this);
Index: khtml/xml/dom_docimpl.cpp
===================================================================
--- khtml/xml/dom_docimpl.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/xml/dom_docimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -1976,7 +1976,7 @@
     if (exceptioncode) *exceptioncode = excode;
 }
 
-void DocumentImpl::updateStyleSelector()
+void DocumentImpl::updateStyleSelector(bool shallow)
 {
 //    kdDebug() << "PENDING " << m_pendingStylesheets << endl;
 
@@ -1984,7 +1984,10 @@
     if (m_pendingStylesheets > 0)
         return;
 
-    recalcStyleSelector();
+    if (shallow)
+        rebuildStyleSelector();
+    else
+        recalcStyleSelector();
     recalcStyle(Force);
 #if 0
 
@@ -2134,6 +2137,11 @@
     for (; it.current(); ++it)
 	it.current()->deref();
 
+    rebuildStyleSelector();
+}
+
+void DocumentImpl::rebuildStyleSelector()
+{
     // Create a new style selector
     delete m_styleSelector;
     QString usersheet = m_usersheet;
@@ -2375,7 +2383,7 @@
     dispatchHTMLEvent(EventImpl::LOAD_EVENT,false,false);
 }
 
-void DocumentImpl::setStyleSheet(const DOM::DOMString &url, const DOM::DOMString &sheet)
+void DocumentImpl::setStyleSheet(const DOM::DOMString &url, const DOM::DOMString &sheet, const DOM::DOMString &charset)
 {
     if (!m_hadLoadError) {
 	m_url = url.string();
Index: khtml/xml/dom_xmlimpl.h
===================================================================
--- khtml/xml/dom_xmlimpl.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/xml/dom_xmlimpl.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -150,7 +150,7 @@
     virtual bool childTypeAllowed( unsigned short type );
     StyleSheetImpl *sheet() const;
     void checkStyleSheet();
-    virtual void setStyleSheet(const DOM::DOMString &url, const DOM::DOMString &sheet);
+    virtual void setStyleSheet(const DOM::DOMString &url, const DOM::DOMString &sheet, const DOM::DOMString &charset);
     virtual void setStyleSheet(CSSStyleSheetImpl* sheet);
 
     virtual DOMString toString() const;
Index: khtml/xml/dom_stringimpl.cpp
===================================================================
--- khtml/xml/dom_stringimpl.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/xml/dom_stringimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -308,6 +308,11 @@
     str = str.simplifyWhiteSpace();
 
     len = str.contains(',') + 1;
+
+    // If we have no commas, we have no array.
+    if( len == 1 )
+        return 0L;
+
     khtml::Length* r = new khtml::Length[len];
 
     int i = 0;
@@ -365,9 +370,9 @@
     return c;
 }
 
-DOMStringImpl *DOMStringImpl::capitalize() const
+DOMStringImpl *DOMStringImpl::capitalize(bool noFirstCap) const
 {
-    bool canCapitalize=true;
+    bool canCapitalize= !noFirstCap;
     DOMStringImpl *c = new DOMStringImpl;
     if(!l) return c;
 
@@ -411,5 +416,45 @@
     return QConstString(s, i).string().toInt(ok);
 }
 
+static const unsigned short amp[] = {'&', 'a', 'm', 'p', ';'};
+static const unsigned short lt[] =  {'&', 'l', 't', ';'};
+static const unsigned short gt[] =  {'&', 'g', 't', ';'};
 
+DOMStringImpl *DOMStringImpl::escapeHTML()
+{
+    unsigned outL = 0;
+    for (unsigned int i = 0; i < l; ++i ) {
+        if ( s[i] == '&' )
+            outL += 5; //&amp;
+        else if (s[i] == '<' || s[i] == '>')
+            outL += 4; //&gt;/&lt;
+        else
+            ++outL;
+    }
+    if (outL == l)
+        return this;
 
+    
+    DOMStringImpl* toRet = new DOMStringImpl();
+    toRet->s = QT_ALLOC_QCHAR_VEC(outL);
+    toRet->l = outL;
+
+    unsigned outP = 0;
+    for (unsigned int i = 0; i < l; ++i ) {
+        if ( s[i] == '&' ) {
+            memcpy(&toRet->s[outP], amp, sizeof(amp));
+            outP += 5; 
+        } else if (s[i] == '<') {
+            memcpy(&toRet->s[outP], lt, sizeof(lt));
+            outP += 4;
+        } else if (s[i] == '>') {
+            memcpy(&toRet->s[outP], gt, sizeof(gt));
+            outP += 4;
+        } else {
+            toRet->s[outP] = s[i];
+            ++outP;
+        }
+    }
+    return toRet;
+}
+
Index: khtml/xml/dom_docimpl.h
===================================================================
--- khtml/xml/dom_docimpl.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/xml/dom_docimpl.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -258,10 +258,14 @@
      * <LINK>, <STYLE> or <BODY> elements, as well as processing instructions (XML documents only). A list is
      * constructed from these which is used to create the a new style selector which collates all of the stylesheets
      * found and is used to calculate the derived styles for all rendering objects.
+     *
+     * @param shallow If the stylesheet list for the document is unchanged, with only added or removed rules 
+     * in existing sheets, then set this argument to true for efficiency.
      */
-    void updateStyleSelector();
+    void updateStyleSelector(bool shallow=false);
 
     void recalcStyleSelector();
+    void rebuildStyleSelector();
 
     QString nextState();
 
@@ -436,7 +440,7 @@
     void load(const DOMString &uri);
     void loadXML(const DOMString &source);
     // from cachedObjectClient
-    void setStyleSheet(const DOM::DOMString &url, const DOM::DOMString &sheet);
+    void setStyleSheet(const DOM::DOMString &url, const DOM::DOMString &sheet, const DOM::DOMString &charset);
     void error(int err, const QString &text);
 
     typedef QMap<QString, ProcessingInstructionImpl*> LocalStyleRefs;
Index: khtml/xml/dom_stringimpl.h
===================================================================
--- khtml/xml/dom_stringimpl.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/xml/dom_stringimpl.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -74,6 +74,7 @@
         return new DOMStringImpl(s,l);
     };
 
+
     DOMStringImpl *substring(unsigned int pos, unsigned int len);
     DOMStringImpl *collapseWhiteSpace(bool preserveLF, bool preserveWS);
 
@@ -88,7 +89,8 @@
     bool isLower() const;
     DOMStringImpl *lower() const;
     DOMStringImpl *upper() const;
-    DOMStringImpl *capitalize() const;
+    DOMStringImpl *capitalize(bool noFirstCap=false) const;
+    DOMStringImpl *escapeHTML();
 
     QChar *unicode() const { return s; }
     uint length() const { return l; }
Index: khtml/khtmlpart_p.h
===================================================================
--- khtml/khtmlpart_p.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ khtml/khtmlpart_p.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -316,7 +316,7 @@
   KURLLabel* m_statusBarUALabel;
   KURLLabel* m_statusBarJSErrorLabel;
   KURLLabel* m_statusBarPopupLabel;
-  QPtrList<KHTMLPart> m_suppressedPopupOriginParts;
+  QValueList<QGuardedPtr<KHTMLPart> > m_suppressedPopupOriginParts;
   int m_openableSuppressedPopups;
   DOM::DocumentImpl *m_doc;
   khtml::Decoder *m_decoder;
Index: kresources/kresources_manager.desktop
===================================================================
--- kresources/kresources_manager.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kresources/kresources_manager.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -58,6 +58,7 @@
 Comment[vi]=Bộ quản lý tài nguyên KResource
 Comment[zh_CN]=KResource 管理器
 Comment[zh_HK]=KResource 管理員
+Comment[zh_TW]=KRsource 管理員
 
 [PropertyDef::X-KDE-ResourceFamily]
 Type=QString
Index: kresources/kresources.desktop
===================================================================
--- kresources/kresources.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kresources/kresources.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -66,6 +66,7 @@
 Name[vi]=Tài nguyên KDE
 Name[zh_CN]=KDE 资源
 Name[zh_HK]=KDE 資源
+Name[zh_TW]=KDE 資源組態
 
 Comment=Configure KDE Resources
 Comment[af]=Stel KDE Hulpbronne op
@@ -127,6 +128,7 @@
 Comment[vi]=Cấu hình các tài nguyên KDE.
 Comment[zh_CN]=配置 KDE 资源
 Comment[zh_HK]=設定 KDE 使用的資源
+Comment[zh_TW]=在此設定 KDE 的資源
 
 Keywords=resources,konnector resource,contact resource,calendar resource,notes resource,imap
 Keywords[af]=hulpbronne,konnector hulpbron,kontak hulpbron,kalender hulpbron, notas hulpbron, imap
Index: kjs/property_map.cpp
===================================================================
--- kjs/property_map.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kjs/property_map.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -63,6 +63,13 @@
     int sizeMask;
     int size;
     int keyCount;
+
+    // gets initialized in expand, an array that stores insert order of a particular hash
+    int *hashToIndex; // NOTE: is one based 1,2,3 etc..
+
+    // keeps trac on how many insertions we have made, cant use keyCount because delete a key in the middle messes things
+    int indexCount;
+
     PropertyMapHashTableEntry entries[1];
 };
 
@@ -102,6 +109,10 @@
         if (key)
 	  key->deref();
     }
+    // fredrik added to cleanup sortorder
+    if (_table)
+        delete [] _table->hashToIndex;
+
     free(_table);
 }
 
@@ -216,7 +227,9 @@
     assert(!name.isNull());
     assert(value != 0);
 
+#if DO_CONSISTENCY_CHECK // speed, why call a stub if we dont need to??
     checkConsistency();
+#endif
 
     UString::Rep *rep = name._ustring.rep;
 
@@ -244,10 +257,8 @@
         }
     }
 #endif
-
     if (!_table || _table->keyCount * 2 >= _table->size)
         expand();
-
     int i = hash(rep);
 #if DUMP_STATISTICS
     ++numProbes;
@@ -270,7 +281,13 @@
     _table->entries[i].attributes = attributes;
     ++_table->keyCount;
 
+    // store insert order
+    _table->indexCount++;
+    _table->hashToIndex[i] = _table->indexCount;
+
+#if DO_CONSISTENCY_CHECK// speed, why call a stub if we dont need to??
     checkConsistency();
+#endif
 }
 
 inline void PropertyMap::insert(UString::Rep *key, ValueImp *value, int attributes)
@@ -292,42 +309,97 @@
 
 void PropertyMap::expand()
 {
+#if DO_CONSISTENCY_CHECK// speed, why call a stub if we dont need to??
     checkConsistency();
+#endif
+    Table *oldTable = _table;
 
-    Table *oldTable = _table;
     int oldTableSize = oldTable ? oldTable->size : 0;
 
     int newTableSize = oldTableSize ? oldTableSize * 2 : 16;
-    _table = (Table *)calloc(1, sizeof(Table) + (newTableSize - 1) * sizeof(Entry) );
+
+    // Is this realy the best way? wouldnt it be easier to use new/delete on an array instead
+    // and do a pointer in Table to that array, that way we wouldnt need to delete the whole _table
+    // every time we need to expand
+    _table = (Table *)calloc(1, sizeof(Table) + ((newTableSize - 1) * sizeof(Entry)) );
+
+    int *p = new int[newTableSize];
+    for (int i = 0; i < newTableSize; i++)
+        p[i] = 0;
+
+    _table->hashToIndex = p;
+
     _table->size = newTableSize;
+
     _table->sizeMask = newTableSize - 1;
+
     _table->keyCount = oldTable ? oldTable->keyCount : 0;
 
+    _table->indexCount = oldTable ? oldTable->indexCount : 0;
+
 #if USE_SINGLE_ENTRY
     UString::Rep *key = _singleEntry.key;
     if (key) {
         insert(key, _singleEntry.value, _singleEntry.attributes);
-	_table->keyCount++;
+        _table->keyCount++;
         _singleEntry.key = 0;
+
+        // store sort order
+        // first get the id of newly inserted key, check for trashed hash, then store it
+        int k = hash(key);
+#if DUMP_STATISTICS
+    ++numProbes;
+    numCollisions += _table->entries[k].key && _table->entries[k].key != key;
+#endif
+        while (UString::Rep *newKey = _table->entries[k].key) {
+             if (key == newKey)
+                 break;
+             k = (k + 1) & _table->sizeMask;
+        }
+        _table->indexCount++;
+        _table->hashToIndex[k] = _table->indexCount;
     }
 #endif
 
     for (int i = 0; i != oldTableSize; ++i) {
         UString::Rep *key = oldTable->entries[i].key;
-        if (key)
+        if (key) {
             insert(key, oldTable->entries[i].value, oldTable->entries[i].attributes);
+
+            // store sort order
+            // first get the id of newly inserted key, check for trashed hash, then store it
+            int k = hash(key);
+#if DUMP_STATISTICS
+    ++numProbes;
+    numCollisions += _table->entries[k].key && _table->entries[k].key != key;
+#endif
+            while (UString::Rep *newKey = _table->entries[k].key) {
+                if (key == newKey)
+                    break;
+                k = (k + 1) & _table->sizeMask;
+            }
+            // store hashindex on the newly inserted entry
+            _table->hashToIndex[k] = oldTable->hashToIndex[i];
+        }
     }
 
+    if (oldTable){
+        delete [] oldTable->hashToIndex;
+    }
     free(oldTable);
 
+#if DO_CONSISTENCY_CHECK// speed, why call a stub if we dont need to??
     checkConsistency();
+#endif
 }
 
 void PropertyMap::remove(const Identifier &name)
 {
     assert(!name.isNull());
 
+#if DO_CONSISTENCY_CHECK// speed, why call a stub if we dont need to??
     checkConsistency();
+#endif
 
     UString::Rep *rep = name._ustring.rep;
 
@@ -356,6 +428,7 @@
             break;
         i = (i + 1) & _table->sizeMask;
     }
+
     if (!key)
         return;
 
@@ -371,11 +444,30 @@
         key = _table->entries[i].key;
         if (!key)
             break;
+
         _table->entries[i].key = 0;
+
         insert(key, _table->entries[i].value, _table->entries[i].attributes);
+
+        // store the index of the new hash
+        int k = hash(key);
+#if DUMP_STATISTICS
+    ++numProbes;
+    numCollisions += _table->entries[k].key && _table->entries[k].key != key;
+#endif
+        while (UString::Rep *newKey = _table->entries[k].key) {
+            if (key == newKey)
+                break;
+            k = (k + 1) & _table->sizeMask;
+        }
+
+        // store hashindex on the newly moved entry
+        _table->hashToIndex[k] = _table->hashToIndex[i];
     }
 
+#if DO_CONSISTENCY_CHECK// speed, why call a stub if we dont need to??
     checkConsistency();
+#endif
 }
 
 void PropertyMap::mark() const
@@ -411,15 +503,45 @@
         return;
     }
 
-    for (int i = 0; i != _table->size; ++i) {
-        UString::Rep *key = _table->entries[i].key;
-        if (key && !(_table->entries[i].attributes & DontEnum))
-            list.append(Reference(base, Identifier(key)));
+    // Allocate a buffer to use to sort the keys.
+    int indexSize = _table->indexCount + 1; // indexes is one based
+    UString::Rep **allKeys = new UString::Rep*[indexSize];
+
+    for (int i = 0; i < indexSize; i++)
+        allKeys[i] = NULL;
+
+    // push  valid hashes to the array allKeys, using insert order as index.
+    // we need to pass array hashes instead of pointers to keys, because we got
+    // memory corruption sometimes, seems that Identifier in below call deletes the key
+    int size = _table->size;
+    Entry *entries = _table->entries;
+    for (int i = 0; i != size; ++i) {
+        if (entries[i].key && !(entries[i].attributes & DontEnum)) {
+            int idx = _table->hashToIndex[i];
+            if (idx) {
+                allKeys[idx] = entries[i].key;
+            } else { // nonsorted key, failure
+                //cout<<"Error with in KJS property_map.addEnumerablesToReferenceList \nUnsorted key"<<endl;
+                assert(0==1); // allways throw error if get here
+            }
+        }
     }
+    // Put the keys of the sorted entries into the reference list.
+    for (int i = 0; i < indexSize; ++i) {
+        if (allKeys[i] != NULL){
+            list.append(Reference(base, Identifier(allKeys[i])));
+        }
+        allKeys[i] = NULL; // dont deallocate key by accident, when we delete allKeys
+    }
+
+    // Deallocate the buffer.
+    delete [] allKeys;
 }
 
 void PropertyMap::addSparseArrayPropertiesToReferenceList(ReferenceList &list, const Object &base) const
 {
+    // NOTE: I did'nt add sort in this method because It seems to be referenced in ArrayInstanceImp
+    // only and arrays are sorted by definition, dont need the extra overhead
     if (!_table) {
 #if USE_SINGLE_ENTRY
         UString::Rep *key = _singleEntry.key;
@@ -520,6 +642,7 @@
             i = (i + 1) & _table->sizeMask;
         }
         assert(i == j);
+        assert(_table->hashToIndex[i] > 0);
         count++;
     }
     assert(count == _table->keyCount);
Index: kjs/ustring.cpp
===================================================================
--- kjs/ustring.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kjs/ustring.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -131,18 +131,20 @@
 UChar UChar::toLower() const
 {
   // ### properly support unicode tolower
-  if (uc >= 256 || islower(uc))
+  if (uc >= 256)
     return *this;
 
-  return (unsigned char)tolower(uc);
+  // tolower is locale-dependent, don't use it.
+  return static_cast<unsigned char>( ( ( uc >= 'A' ) && ( uc <= 'Z' ) ) ? ( (int)uc + 'a' - 'A' ) : uc );
 }
 
 UChar UChar::toUpper() const
 {
-  if (uc >= 256 || isupper(uc))
+  if (uc >= 256)
     return *this;
 
-  return (unsigned char)toupper(uc);
+  // toupper is locale-dependent, don't use it.
+  return static_cast<unsigned char>( ( ( uc >= 'a' ) && ( uc <= 'z' ) ) ? ( (int)uc + 'A' - 'a' ) : uc );
 }
 
 UCharReference& UCharReference::operator=(UChar c)
Index: pics/hicolor/index.theme
===================================================================
--- pics/hicolor/index.theme	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ pics/hicolor/index.theme	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -106,6 +106,7 @@
 Comment[vi]=Sắc thái biểu tượng dự trữ
 Comment[zh_CN]=默认图标主题
 Comment[zh_HK]=後備高彩圖示主題
+Comment[zh_TW]=最後圖示主題
 DisplayDepth=32
 Example=exec
 LinkOverlay=link
Index: pics/crystalsvg/cr48-mime-bt.png
===================================================================
Cannot display: file marked as a binary type.
svn:mime-type = application/octet-stream

Property changes on: pics/crystalsvg/cr48-mime-bt.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Index: pics/crystalsvg/cr16-mime-bt.png
===================================================================
Cannot display: file marked as a binary type.
svn:mime-type = application/octet-stream

Property changes on: pics/crystalsvg/cr16-mime-bt.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Index: pics/crystalsvg/index.theme
===================================================================
--- pics/crystalsvg/index.theme	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ pics/crystalsvg/index.theme	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -78,6 +78,7 @@
 Comment[vi]=Sắc thái biểu tượng của Xưởng vẽ Thiết kế Everaldo.com
 Comment[zh_CN]=Everaldo 设计工作室制作的图标主题
 Comment[zh_HK]=由 Everaldo.com 提供的圖示主題
+Comment[zh_TW]=由 Everaldo.com Design Studio 所提供的圖示主題
 DisplayDepth=32
 
 Inherits=hicolor
Index: pics/crystalsvg/cr22-mime-bt.png
===================================================================
Cannot display: file marked as a binary type.
svn:mime-type = application/octet-stream

Property changes on: pics/crystalsvg/cr22-mime-bt.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Index: pics/crystalsvg/cr64-mime-bt.png
===================================================================
Cannot display: file marked as a binary type.
svn:mime-type = application/octet-stream

Property changes on: pics/crystalsvg/cr64-mime-bt.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Index: pics/crystalsvg/cr128-mime-bt.png
===================================================================
Cannot display: file marked as a binary type.
svn:mime-type = application/octet-stream

Property changes on: pics/crystalsvg/cr128-mime-bt.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Index: pics/crystalsvg/cr32-mime-bt.png
===================================================================
Cannot display: file marked as a binary type.
svn:mime-type = application/octet-stream

Property changes on: pics/crystalsvg/cr32-mime-bt.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Index: kdoctools/customization/de/entities/help-menu.docbook
===================================================================
--- kdoctools/customization/de/entities/help-menu.docbook	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kdoctools/customization/de/entities/help-menu.docbook	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -6,7 +6,7 @@
 <keycombo action="simul"><keycap>F1</keycap></keycombo>
 </shortcut>
 <guimenu>Hilfe</guimenu>
-<guimenuitem>Inhalt ...</guimenuitem>
+<guimenuitem>Handbuch zu &kappname;</guimenuitem>
 </menuchoice>
 </term>
 <listitem><para><action>Startet das Hilfe-System von KDE</action> mit der
Index: kdoctools/customization/ca/entities/underLGPL.docbook
===================================================================
--- kdoctools/customization/ca/entities/underLGPL.docbook	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kdoctools/customization/ca/entities/underLGPL.docbook	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -1,3 +1,3 @@
-<para>Aquest programa est llicenciat sota els termes de la
-<ulink url="common/lgpl-license.html">Llicncia Pblica Menys General
+<para>Aquest programa està llicenciat sota els termes de la
+<ulink url="common/lgpl-license.html">Llicència Pblica Menys General
 de GNU</ulink>.</para>
Index: kdoctools/customization/pt/user.entities
===================================================================
--- kdoctools/customization/pt/user.entities	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kdoctools/customization/pt/user.entities	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -39,3 +39,4 @@
 <!ENTITY kmenu  "menu <guimenu>K</guimenu>">
 <!ENTITY kinfocenter "<application>Centro de Informação do KDE</application>" >
 <!ENTITY ksystemlog "<application>KSystemLog</application>" >
+<!ENTITY kleopatra "<application>Kleopatra</application>" >
Index: kparts/part.h
===================================================================
--- kparts/part.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kparts/part.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -319,12 +319,15 @@
  * Base class for any "viewer" part.
  *
  * This class takes care of network transparency for you,
- * in the simplest way (synchronously).
+ * in the simplest way (downloading to a temporary file, then letting the part
+ * load from the temporary file).
  * To use the built-in network transparency, you only need to implement
  * openFile(), not openURL().
- * To prevent network transparency, or to implement it another way
- * (e.g. asynchronously), override openURL().
  *
+ * To implement network transparency differently (e.g. for progressive loading,
+ * like a web browser does for instance), or to prevent network transparency
+ * (but why would you do that?), you can override openURL().
+ *
  * KParts Application can use the signals to show feedback while the URL is being loaded.
  *
  * ReadOnlyPart handles the window caption by setting it to the current URL
@@ -369,7 +372,8 @@
 
 public slots:
   /**
-   * Only reimplement openURL if you don't want synchronous network transparency
+   * Only reimplement openURL if you don't want the network transparency support
+   * to download from the url into a temporary file (when the url isn't local).
    * Otherwise, reimplement openFile() only .
    *
    * If you reimplement it, don't forget to set the caption, usually with
Index: kdeprint/kdeprintd.desktop
===================================================================
--- kdeprint/kdeprintd.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kdeprint/kdeprintd.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -143,3 +143,4 @@
 Comment[vi]=Trình nền in cho môi trường KDE.
 Comment[zh_CN]=KDE 的打印守护进程
 Comment[zh_HK]=KDE 的列印伺服程式
+Comment[zh_TW]=KDE 的列印服務程式
Index: kdeprint/specials.desktop
===================================================================
--- kdeprint/specials.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kdeprint/specials.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -925,6 +925,7 @@
 Name[vi]=Gởi tập tin PDF trong thư
 Name[zh_CN]=邮寄 PDF 文件
 Name[zh_HK]=郵寄 PDF 文件
+Name[zh_TW]=郵寄 PDF 文件
 Require=exec:/ps2pdf,exec:/kmail
 
 [Printer 4]
Index: kdeui/kcolordialog.cpp
===================================================================
--- kdeui/kcolordialog.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kdeui/kcolordialog.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -626,6 +626,7 @@
 #ifdef X11_RGBFILE
     X11_RGBFILE,
 #endif
+	"/usr/share/X11/rgb.txt",
     "/usr/X11R6/lib/X11/rgb.txt",
     "/usr/openwin/lib/X11/rgb.txt", // for Solaris.
     0
Index: kdeui/kkeydialog.cpp
===================================================================
--- kdeui/kkeydialog.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kdeui/kkeydialog.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -1086,7 +1086,7 @@
 /*                                                                      */
 /************************************************************************/
 KKeyDialog::KKeyDialog( KKeyChooser::ActionType type, bool bAllowLetterShortcuts, QWidget *parent, const char* name )
-: KDialogBase( parent, name, true, i18n("Configure Shortcuts"), Default|Ok|Cancel, Ok )
+: KDialogBase( parent, name ? name : "kkeydialog", true, i18n("Configure Shortcuts"), Default|Ok|Cancel, Ok )
 {
 	m_pKeyChooser = new KKeyChooser( this, type, bAllowLetterShortcuts );
 	setMainWidget( m_pKeyChooser );
@@ -1098,7 +1098,7 @@
 }
 
 KKeyDialog::KKeyDialog( bool bAllowLetterShortcuts, QWidget *parent, const char* name )
-: KDialogBase( parent, name, true, i18n("Configure Shortcuts"), Default|Ok|Cancel, Ok )
+: KDialogBase( parent, name ? name : "kkeydialog", true, i18n("Configure Shortcuts"), Default|Ok|Cancel, Ok )
 {
 	m_pKeyChooser = new KKeyChooser( this, KKeyChooser::Application, bAllowLetterShortcuts );
 	setMainWidget( m_pKeyChooser );
Index: kdeui/kdetrayproxy/kdetrayproxy.desktop
===================================================================
--- kdeui/kdetrayproxy/kdetrayproxy.desktop	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kdeui/kdetrayproxy/kdetrayproxy.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -54,6 +54,7 @@
 Name[uk]=Модуль посередника для програм в системному лотку
 Name[vi]=Mô-đun ủy nhiệm khay KDE
 Name[zh_CN]=KDE 托盘代理模块
+Name[zh_TW]=KDE 系統匣代理模組
 Comment=Proxy enabling KDE systray applications to work without KWin
 Comment[af]=Proksie wat KDE 'systray' programme toelaat om sonder KWin te werk
 Comment[bg]=Модул, който позволява на програмите от КДЕ да работят в системния поднос с други мениджъри на прозорци
@@ -107,6 +108,7 @@
 Comment[uk]=Програма посередник, яка дозволяє працювати програмам для KDE, що використовують системний лоток, без KWin
 Comment[vi]=Bộ ủy nhiệm hiệu lực các ứng dụng khay hệ thống KDE hoạt động, không cần KWin.
 Comment[zh_CN]=允许 KDE 系统托盘应用程序在没有 KWin 的情况下工作
+Comment[zh_TW]=系統匣代理模組讓系統匣應用程式不必靠 KWin 運作
 ServiceTypes=KDEDModule
 X-KDE-ModuleType=Library
 X-KDE-Library=kdetrayproxy
Index: kdeui/klineedit.cpp
===================================================================
--- kdeui/klineedit.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kdeui/klineedit.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -26,6 +26,7 @@
 */
 
 #include <qclipboard.h>
+#include <qpainter.h>
 #include <qtimer.h>
 
 #include <kconfig.h>
@@ -93,6 +94,9 @@
     BackgroundMode bgMode;
     QString squeezedText;
     KCompletionBox *completionBox;
+
+    QString clickMessage;
+    bool drawClickMsg:1;
 };
 
 bool KLineEdit::KLineEditPrivate::backspacePerformsCompletion = false;
@@ -139,6 +143,8 @@
       d->previousHighlightedTextColor=p.color(QPalette::Normal,QColorGroup::HighlightedText);
     if ( !d->previousHighlightColor.isValid() )
       d->previousHighlightColor=p.color(QPalette::Normal,QColorGroup::Highlight);
+
+    d->drawClickMsg = false;
 }
 
 void KLineEdit::setCompletionMode( KGlobalSettings::Completion mode )
@@ -303,6 +309,9 @@
 
 void KLineEdit::setText( const QString& text )
 {
+    d->drawClickMsg = text.isEmpty() && !d->clickMessage.isEmpty();
+    update();
+
     if( d->enableSqueezedText && isReadOnly() )
     {
         d->squeezedText = text;
@@ -939,8 +948,25 @@
     }
 }
 
+void KLineEdit::drawContents( QPainter *p )
+{
+    QLineEdit::drawContents( p );
+
+    if ( d->drawClickMsg && !hasFocus() ) {
+        QPen tmp = p->pen();
+        p->setPen( palette().color( QPalette::Disabled, QColorGroup::Text ) );
+        QRect cr = contentsRect();
+
+        // Add two pixel margin on the left side
+        cr.rLeft() += 3;
+        p->drawText( cr, AlignAuto | AlignVCenter, d->clickMessage );
+        p->setPen( tmp );
+    }
+}
+
 void KLineEdit::dropEvent(QDropEvent *e)
 {
+    d->drawClickMsg = false;
     KURL::List urlList;
     if( d->handleURLDrops && KURLDrag::decode( e, urlList ) )
     {
@@ -1298,6 +1324,11 @@
 
 void KLineEdit::focusInEvent( QFocusEvent* ev)
 {
+    if ( d->drawClickMsg ) {
+        d->drawClickMsg = false;
+        update();
+    }
+
     // Don't selectAll() in QLineEdit::focusInEvent if selection exists
     if ( ev->reason() == QFocusEvent::Tab && inputMask().isNull() && hasSelectedText() )
         return;
@@ -1305,10 +1336,31 @@
     QLineEdit::focusInEvent(ev);
 }
 
+void KLineEdit::focusOutEvent( QFocusEvent* ev)
+{
+    if ( text().isEmpty() && !d->clickMessage.isEmpty() ) {
+        d->drawClickMsg = true;
+        update();
+    }
+    QLineEdit::focusOutEvent( ev );
+}
+
 bool KLineEdit::autoSuggest() const
 {
     return d->autoSuggest;
 }
 
+void KLineEdit::setClickMessage( const QString &msg )
+{
+    d->clickMessage = msg;
+    update();
+}
+
+QString KLineEdit::clickMessage() const
+{
+    return d->clickMessage;
+}
+
+
 void KLineEdit::virtual_hook( int id, void* data )
 { KCompletionBase::virtual_hook( id, data ); }
Index: kdeui/klistviewlineedit.h
===================================================================
--- kdeui/klistviewlineedit.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kdeui/klistviewlineedit.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -57,6 +57,9 @@
 protected slots:
 	void slotSelectionChanged();
 
+	/// @since 3.5.4
+	void slotItemRemoved(QListViewItem *i);
+
 };
 
 #endif
Index: kdeui/klistview.cpp
===================================================================
--- kdeui/klistview.cpp	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kdeui/klistview.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -179,6 +179,8 @@
         setFrame( false );
         hide();
         connect( parent, SIGNAL( selectionChanged() ), SLOT( slotSelectionChanged() ));
+        connect( parent, SIGNAL( itemRemoved( QListViewItem * ) ),
+                         SLOT( slotItemRemoved( QListViewItem * ) ));
 }
 
 KListViewLineEdit::~KListViewLineEdit()
@@ -407,7 +409,19 @@
     hide();
 }
 
+// if the current item was removed -> terminate.  Can't call terminate(false)
+// due to same reason as slotSelectionChanged().
+void KListViewLineEdit::slotItemRemoved(QListViewItem *i)
+{
+    if (currentItem() != i)
+        return;
 
+    item = 0;
+    col = 0;
+    hide();
+}
+
+
 KListView::KListView( QWidget *parent, const char *name )
   : QListView( parent, name ),
         d (new KListViewPrivate (this))
Index: kdeui/klineedit.h
===================================================================
--- kdeui/klineedit.h	(.../tags/KDE/3.5.3/kdelibs)	(revision 556696)
+++ kdeui/klineedit.h	(.../branches/KDE/3.5/kdelibs)	(revision 556696)
@@ -151,6 +151,8 @@
     Q_PROPERTY( bool urlDropsEnabled READ isURLDropsEnabled WRITE setURLDropsEnabled )
     Q_PROPERTY( bool trapEnterKeyEvent READ trapReturnKey WRITE setTrapReturnKey )
     Q_PROPERTY( bool enableSqueezedText READ isSqueezedTextEnabled WRITE setEnableSqueezedText )
+    // @since 3.5.4
+    Q_PROPERTY( QString clickMessage READ clickMessage WRITE setClickMessage )
 
 public:
 
@@ -326,6 +328,20 @@
     */
     void setCompletionBox( KCompletionBox *box );
 
+    /**
+     * This makes the line edit display a grayed-out hinting text as long as
+     * the user didn't enter any text. It is often used as indication about
+     * the purpose of the line edit.
+     * @since 3.5.4
+    */
+    void setClickMessage( const QString &msg );
+
+    /**
+     * @return the message set with setClickMessage
+     * @since 3.5.4
+    */
+    QString clickMessage() const;
+
 signals:
 
     /**
@@ -524,6 +540,13 @@
     virtual QPopupMenu *createPopupMenu();
 
     /**
+    * Re-implemented for internal reasons.  API not affected.
+    *
+    * See QFrame::drawContents().
+    */
+    virtual void drawContents( QPainter *p );
+
+    /**
     * Re-implemented to handle URI drops.
     *
     * See QLineEdit::dropEvent().
@@ -561,6 +584,13 @@
     virtual void focusInEvent( QFocusEvent* );
 
     /**
+    * Re-implemented for internal reasons.  API not affected.
+    *
+    * See QLineEdit::focusOutEvent().
+    */
+    virtual void focusOutEvent( QFocusEvent* );
+
+    /**
      * Whether in current state text should be auto-suggested
      * @since 3.4
     */

Property changes on: .
___________________________________________________________________
Name: svn:externals
   + admin https://svn.kde.org/home/kde/branches/KDE/3.5/kde-common/admin


