Index: kate/plugins/kdatatool/ktexteditor_kdatatool.desktop
===================================================================
--- kate/plugins/kdatatool/ktexteditor_kdatatool.desktop	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kate/plugins/kdatatool/ktexteditor_kdatatool.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -83,7 +83,7 @@
 Comment[cy]=Alluogi offer data fel theawrws a cywirydd sillafu (os maent wedi'u gosod)
 Comment[da]=Aktivér dataværktøjer som begrebsordbog og stavekontrol (hvis installeret)
 Comment[de]=Aktivierung von Dienstprogrammen wie Thesaurus und Rechtschreibprüfung (falls installiert)
-Comment[el]=Ενεργοποίηση εργαλειών δεδομένων όπως ο θησαυρός λέξεων και ο ορθογραφικός έλεγχος (εάν είναι εγκατεστημένα)
+Comment[el]=Ενεργοποίηση εργαλειών δεδομένων όπως ο θησαυρός λέξεων και ο ορθογραφικός έλεγχος (αν είναι εγκατεστημένα)
 Comment[eo]=Enŝaltu datumiloj kiel "thesaurus" kaj literumado (se instalita)
 Comment[es]=Activa herramientas como el thesaurus y el corrector ortográfico (si instalados)
 Comment[et]=Andmete tööriistad, näiteks thesaurus ja õigekirja kontroll
Index: kate/plugins/insertfile/ktexteditor_insertfile.desktop
===================================================================
--- kate/plugins/insertfile/ktexteditor_insertfile.desktop	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kate/plugins/insertfile/ktexteditor_insertfile.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -20,7 +20,7 @@
 Name[fa]=متصل‌کننده‌ی پرونده‌ی ورود KTextEditor
 Name[fi]=KTextEditorin 'Lisää tiedosto'-laajennus
 Name[fr]=Module externe du fichier d'insertion de KTextEditor
-Name[fy]=KTextEditor-plugin foar it ynfoegjen fan triemen
+Name[fy]=KTextEditor-plugin foar it ynfoegjen fan triemmen
 Name[ga]=Breiseán KTextEditor chun comhad a ionsá
 Name[gl]=Plugin de Inserzón de Arquivo de KTextEditor
 Name[he]=תוסף הוספת קובץ ל־KTextEditor
Index: kate/part/katedocument.cpp
===================================================================
--- kate/part/katedocument.cpp	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kate/part/katedocument.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -699,6 +699,10 @@
 
   bool replacetabs = ( config()->configFlags() & KateDocumentConfig::cfReplaceTabsDyn && ! m_isInUndo );
   uint tw = config()->tabWidth();
+  uint insertPosExpanded = insertPos;
+  KateTextLine::Ptr l = m_buffer->line( line );
+  if (l != 0)
+    insertPosExpanded = l->cursorX( insertPos, tw );
 
   for (uint pos = 0; pos < len; pos++)
   {
@@ -706,28 +710,30 @@
 
     if (ch == '\n')
     {
+      editInsertText (line, insertPos, buf);
+
       if ( !blockwise )
       {
-        editInsertText (line, insertPos, buf);
         editWrapLine (line, insertPos + buf.length());
+        insertPos = insertPosExpanded = 0;
       }
       else
       {
-        editInsertText (line, col, buf);
-
         if ( line == lastLine() )
-          editWrapLine (line, col + buf.length());
+          editWrapLine (line, insertPos + buf.length());
       }
 
       line++;
-      insertPos = 0;
       buf.truncate(0);
+      l = m_buffer->line( line );
+      if (l)
+        insertPosExpanded = l->cursorX( insertPos, tw );
     }
     else
     {
       if ( replacetabs && ch == '\t' )
       {
-        uint tr = tw - ( ((blockwise?col:insertPos)+buf.length())%tw ); //###
+        uint tr = tw - ( insertPosExpanded+buf.length() )%tw;
         for ( uint i=0; i < tr; i++ )
           buf += ' ';
       }
@@ -736,10 +742,7 @@
     }
   }
 
-  if ( !blockwise )
-    editInsertText (line, insertPos, buf);
-  else
-    editInsertText (line, col, buf);
+  editInsertText (line, insertPos, buf);
 
   editEnd ();
   emit textInserted(line,insertPos);
@@ -3097,29 +3100,7 @@
       if (pos < 0 || pos >= (int)colX)
       {
         // only spaces on left side of cursor
-        // search a line with less spaces
-        int y = line;
-        while (--y >= 0)
-        {
-          // this is save, y <= line, and line was already success
-          textLine = m_buffer->plainLine(y);
-
-          pos = textLine->firstChar();
-
-          if (pos >= 0)
-          {
-            pos = textLine->cursorX(pos, config()->tabWidth());
-            if (pos < (int)colX)
-            {
-              replaceWithOptimizedSpace(line, col, pos, config()->configFlags());
-              break;
-            }
-          }
-        }
-        if (y < 0) {
-          // FIXME: what shoud we do in this case?
-          removeText(line, 0, line, col+complement);
-        }
+        indent( view, line, -1);
       }
       else
         removeText(line, col-1, line, col+complement);
Index: kate/data/progress.xml
===================================================================
--- kate/data/progress.xml	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kate/data/progress.xml	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -1,6 +1,6 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <!DOCTYPE language SYSTEM "language.dtd">
-<language name="progress" version="1.08" kateversion="2.4" section="Database" extensions="*.p;*.w;*.i" author="Rares Stanciulescu (rstanciu@operamail.com)" license="GPL">
+<language name="progress" version="1.09" kateversion="2.4" section="Database" extensions="*.p;*.w;*.i;*.cls" author="Rares Stanciulescu (rstanciu@operamail.com)" license="GPL">
   
 <highlighting>
     
@@ -31,20 +31,11 @@
   <item> TEMP-TABLE </item>
   <item> BUFFER </item>
   <item> STREAM </item>
+  <item> SAX-WRITER </item>
   <item> MEMPTR </item>
 </list>
     
   <list  name="operators">
-    <item> + </item>
-    <item> - </item>
-    <item> * </item>
-    <item> / </item>
-    <item> = </item>
-    <item> &lt; </item>
-    <item> &gt; </item>
-    <item> &lt;= </item>
-    <item> &gt;= </item>
-    <item> &lt;&gt; </item>
     <item> AND </item>
     <item> OR </item>
     <item> NOT </item>
@@ -82,6 +73,8 @@
           
 <list name="phrases">
   <item> AS </item>
+  <item> WORD-INDEX </item>
+  <item> LIKE </item>
   <item> ALERT-BOX </item>
   <item> AT </item>
   <item> COLOR </item>
@@ -148,9 +141,17 @@
   <item> NO-ECHO </item>
   <item> NO-MAP </item>
   <item> PRIVATE </item>
+  <item> PUBLIC </item>
+  <item> PROTECTED </item>
 </list>
           
 <list name="functions">
+  <item> output-content-type </item>
+  <item> get-value </item>
+  <item> get-cgi </item>
+  <item> get-field </item>
+  <item> html-encode </item>
+  <item> url-encode </item>  
   <item> ABSOLUTE </item>
   <item> ACCUM </item>
   <item> ADD-INTERVAL </item>
@@ -577,6 +578,7 @@
   <item> DEFAULT-WINDOW </item>
   <item> ERROR-STATUS </item>
   <item> FILE-INFO </item>
+  <item> FIELD </item>
   <item> FOCUS </item>
   <item> FONT-TABLE </item>
   <item> LAST-EVENT </item>
@@ -611,7 +613,6 @@
   <item> HONORPROKEYS </item>
   <item> HONORRETURNKEY </item>
   <item> LEFT </item>
-  <item> NAME </item>
   <item> TOP </item>
   <item> WIDTH </item>
   <item> TAG </item>
@@ -934,7 +935,6 @@
   <item> MULTIPLE </item>
   <item> MULTITASKING-INTERVAL </item>
   <item> MUST-UNDERSTAND </item>
-  <item> NAME </item>
   <item> NAMESPACE-PREFIX </item>
   <item> NAMESPACE-URI </item>
   <item> NEEDS-APPSERVER-PROMPT </item>
@@ -1163,6 +1163,22 @@
   <item> XML-SUPPRESS-NAMESPACE-PROCESSING </item>
   <item> Y </item>
   <item> YEAR-OFFSET </item>
+  <item> WRITE-XMLSCHEMA </item>
+  <item> WRITE-XML </item>
+  <item> READ-XML </item>
+  <item> NESTED </item>
+  <item> XML-DATA-TYPE </item>
+  <item> XML-NODE-TYPE </item>
+  <item> FORMATTED </item>
+  <item> SET-OUTPUT-DESTINATION </item>
+  <item> START-DOCUMENT </item>
+  <item> START-ELEMENT </item>
+  <item> WRITE-CHARACTERS </item>
+  <item> END-ELEMENT </item>
+  <item> END-DOCUMENT </item>
+  <item> WRITE-DATA-ELEMENT </item>
+  <item> INSERT-ATTRIBUTE </item>
+  
 </list>
 
 <list name="methods">
@@ -1489,7 +1505,7 @@
     <DetectChar attribute="Comment" context="Identifier" char='"'/>
     <DetectChar attribute="String" context="#stay" char='"'/>
     <DetectChar attribute="String" context="#stay" char="'"/>
-    <AnyChar attribute="Symbol" context="#stay" String="{}[]()~:"/>
+    <AnyChar attribute="Symbol" context="#stay" String="+-*=/\?~{}[]():."/>
     
     <StringDetect attribute="Region Marker" context="#stay"
                   String="PROCEDURE" insensitive="TRUE"
@@ -1504,7 +1520,27 @@
     <StringDetect attribute="Region Marker" context="#stay"
                   String="END FUNCTION" insensitive="TRUE"
                   endRegion="F1" firstNonSpace="TRUE"/>
+
+    <StringDetect attribute="Region Marker" context="#stay"
+                  String="CLASS" insensitive="TRUE"
+                  beginRegion="C1" firstNonSpace="TRUE"/>
+    <StringDetect attribute="Region Marker" context="#stay"
+                  String="END CLASS" insensitive="TRUE"
+                  endRegion="C1" firstNonSpace="TRUE"/>
     
+    <StringDetect attribute="Region Marker" context="#stay"
+                  String="METHOD" insensitive="TRUE"
+                  beginRegion="M1" firstNonSpace="TRUE"/>
+    <StringDetect attribute="Region Marker" context="#stay"
+                  String="END METHOD" insensitive="TRUE"
+                  endRegion="M1" firstNonSpace="TRUE"/>    
+    <StringDetect attribute="Region Marker" context="#stay"
+                  String="CONSTRUCTOR" insensitive="TRUE"
+                  beginRegion="CN1" firstNonSpace="TRUE"/>
+    <StringDetect attribute="Region Marker" context="#stay"
+                  String="END CONSTRUCTOR" insensitive="TRUE"
+                  endRegion="CN1" firstNonSpace="TRUE"/>    
+    
     <StringDetect attribute="Function" context="#stay"
                   String="DO:" insensitive="TRUE"
                   beginRegion="L1" firstNonSpace="FALSE"/>
@@ -1521,6 +1557,7 @@
                   String="END" insensitive="TRUE"
                   endRegion="L1" firstNonSpace="TRUE"/>
     
+    
   </context>
   <context name="String" attribute="String" lineEndContext="#stay">
     <LineContinue attribute="String" context="#pop"/>
Index: kate/data/lua.xml
===================================================================
--- kate/data/lua.xml	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kate/data/lua.xml	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -1,6 +1,6 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <!DOCTYPE language SYSTEM "language.dtd">
-<language name="Lua" version="0.22" kateversion="2.3" section="Scripts" extensions="*.lua" mimetype="text/x-lua">
+<language name="Lua" version="0.23" kateversion="2.3" section="Scripts" extensions="*.lua" mimetype="text/x-lua">
   <highlighting>
     <list name="keywords">
       <item> and </item>
@@ -19,7 +19,7 @@
       <item> else </item>
       <item> or </item>
       <item> while </item>
-      <item> elsif </item>
+      <item> elseif </item>
       <item> in </item>
       <item> repeat </item>
     </list>
Index: kate/data/ada.xml
===================================================================
--- kate/data/ada.xml	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kate/data/ada.xml	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -73,14 +73,16 @@
       <context attribute="Normal Text" lineEndContext="#stay" name="Default">
         <RegExpr attribute="Keyword" context="#stay" String="if " insensitive="TRUE" beginRegion="Region1" firstNonSpace="true"/>
         <StringDetect attribute="Keyword" context="#stay" String="end if" insensitive="TRUE" endRegion="Region1"/>
-        <RegExpr attribute="Keyword" context="#stay" String="case " insensitive="TRUE" beginRegion="Region2" firstNonSpace="true"/>
-        <StringDetect attribute="Keyword" context="#stay" String="end case" insensitive="TRUE" endRegion="Region2"/>
         <RegExpr attribute="Keyword" context="#stay" String="\sloop\s+" insensitive="TRUE" beginRegion="Region3"/>
         <RegExpr attribute="Keyword" context="#stay" String="\sloop$" insensitive="TRUE" beginRegion="Region3"/>
         <StringDetect attribute="Keyword" context="#stay" String="end loop;" insensitive="TRUE" endRegion="Region3"/>
         <RegExpr attribute="Keyword" context="#stay" String="\sselect\s+" insensitive="TRUE" beginRegion="Region4"/>
         <RegExpr attribute="Keyword" context="#stay" String="\sselect$" insensitive="TRUE" beginRegion="Region4"/>
         <StringDetect attribute="Keyword" context="#stay" String="end select;" insensitive="TRUE" endRegion="Region4"/>
+        <RegExpr attribute="Keyword" context="#stay" String="\b(begin|case|record)\b" insensitive="true" beginRegion="Region5"/>
+        <RegExpr attribute="Keyword" context="#stay" String="\bend(?=((\{[^}]*(\}|$)|\(\*.*(\*\)|$))*)([.;\s]|$)|//|$)" insensitive="true" endRegion="Region5"/>
+        <StringDetect attribute="Region Marker" context="Region Marker" String="--  BEGIN" beginRegion="RegionMarker" firstNonSpace="true" />
+        <StringDetect attribute="Region Marker" context="Region Marker" String="--  END" endRegion="RegionMarker" firstNonSpace="true" />
         <keyword attribute="Keyword" context="#stay" String="keywords"/>
         <Float attribute="Float" context="#stay"/>
         <Int attribute="Decimal" context="#stay"/>
@@ -88,6 +90,7 @@
         <DetectChar attribute="String" context="String" char="&quot;"/>
         <Detect2Chars attribute="Comment" context="Comment" char="-" char1="-"/>
       </context>
+      <context attribute="Region Marker" lineEndContext="#pop" name="Region Marker"/>
       <context attribute="String" lineEndContext="#pop" name="String">
         <DetectChar attribute="String" context="#pop" char="&quot;"/>
       </context>
@@ -102,6 +105,7 @@
       <itemData name="Char"        defStyleNum="dsChar" />
       <itemData name="String"      defStyleNum="dsString" />
       <itemData name="Comment"     defStyleNum="dsComment" />
+      <itemData name="Region Marker" defStyleNum="dsRegionMarker" />
     </itemDatas>
   </highlighting>
   <general>
Index: kate/data/ruby.xml
===================================================================
--- kate/data/ruby.xml	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kate/data/ruby.xml	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -34,7 +34,7 @@
 -->
 
 <!-- Hold the "language" opening tag on a single line, as mentioned in "language.dtd". -->
-<language name="Ruby" version="1.17" kateversion="2.4" section="Scripts" extensions="*.rb;*.rxml" mimetype="application/x-ruby" author="Stefan Lang (langstefan@gmx.at), Sebastian Vuorinen (sebastian.vuorinen@helsinki.fi)" license="LGPL">
+<language name="Ruby" version="1.17" kateversion="2.4" section="Scripts" extensions="*.rb;*.rjs;*.rxml" mimetype="application/x-ruby" author="Stefan Lang (langstefan@gmx.at), Sebastian Vuorinen (sebastian.vuorinen@helsinki.fi)" license="LGPL">
 	
 	<highlighting>
 	
Index: kate/data/logtalk.xml
===================================================================
--- kate/data/logtalk.xml	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kate/data/logtalk.xml	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -1,7 +1,7 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <!DOCTYPE language SYSTEM "language.dtd">
 
-<language name="Logtalk" version="1.40" kateversion="2.4" section="Sources" extensions="*.lgt;*.config" mimetype="text/x-logtalk" author="Paulo Moura (pmoura@logtalk.org)" license="Artistic License 2.0">
+<language name="Logtalk" version="1.51" kateversion="2.4" section="Sources" extensions="*.lgt;*.config" mimetype="text/x-logtalk" author="Paulo Moura (pmoura@logtalk.org)" license="Artistic License 2.0">
 
 	<highlighting>
 
@@ -17,11 +17,11 @@
 				<!-- Reflection -->
 				<RegExpr String = "\b(current_predicate|predicate_property)(?=[(])" attribute = "Built-in" context = "#stay" />
 				<!-- DCGs -->
-				<RegExpr String = "\b(expand_term|phrase)(?=[(])" attribute = "Built-in" context = "#stay" />
+				<RegExpr String = "\b(expand_term|term_expansion|phrase)(?=[(])" attribute = "Built-in" context = "#stay" />
 				<!-- Entity -->
 				<RegExpr String = "\b(abolish|c(reate|urrent))_(object|protocol|category)(?=[(])" attribute = "Built-in" context = "#stay" />
 				<RegExpr String = "\b(object|protocol|category)_property(?=[(])" attribute = "Built-in" context = "#stay" />
-				<!-- Event handlers -->
+				<!-- Entity relations -->
 				<RegExpr String = "\bextends_(object|protocol)(?=[(])" attribute = "Built-in" context = "#stay" />
 				<RegExpr String = "\bimplements_protocol(?=[(])" attribute = "Built-in" context = "#stay" />
 				<RegExpr String = "\b(instantiates|specializes)_class(?=[(])" attribute = "Built-in" context = "#stay" />
@@ -48,7 +48,7 @@
 				<RegExpr String = "\b(rem|mod|abs|sign)(?=[(])" attribute = "Built-in" context = "#stay" />
 				<RegExpr String = "\bfloat(_(integer|fractional)_part)?(?=[(])" attribute = "Built-in" context = "#stay" />
 				<RegExpr String = "\b(floor|truncate|round|ceiling)(?=[(])" attribute = "Built-in" context = "#stay" />
-				<!-- Other arithemtic functors -->
+				<!-- Other arithmetic functors -->
 				<RegExpr String = "\b(cos|atan|exp|log|s(in|qrt))(?=[(])" attribute = "Built-in" context = "#stay" />
 				<!-- Term testing -->
 				<RegExpr String = "\b(var|atom(ic)?|integer|float|compound|n(onvar|umber))(?=[(])" attribute = "Built-in" context = "#stay" />
@@ -149,15 +149,16 @@
 				<!-- Entity directives -->
 				<RegExpr String = "\b(category|object|protocol)(?=[(])" attribute = "Directive" context = "entityrelations" beginRegion = "Entity"/>
 				<RegExpr String = "\bend_(category|object|protocol)[.]" attribute = "Directive" context = "#pop" endRegion = "Entity" />
+				<RegExpr String = "\bmodule(?=[(])" attribute = "Directive" context = "#pop"/>
  				<!-- Predicate scope directives -->
 				<RegExpr String = "\bp(ublic|r(otected|ivate))(?=[(])" attribute = "Directive" context = "#pop" />
 				<!-- Other directives -->
-				<RegExpr String = "\bencoding(?=[(])" attribute = "Directive" context = "#pop" />
+				<RegExpr String = "\be(ncoding|xport)(?=[(])" attribute = "Directive" context = "#pop" />
 			   	<RegExpr String = "\bin(fo|itialization)(?=[(])" attribute = "Directive" context = "#pop" />
 				<RegExpr String = "\bdynamic[.]" attribute = "Directive" context = "#pop" />
-				<RegExpr String = "\b(alias|d(ynamic|iscontiguous)|m(etapredicate|ode|ultifile))(?=[(])" attribute = "Directive" context = "#pop" />
+				<RegExpr String = "\b(alias|d(ynamic|iscontiguous)|meta_predicate|m(etapredicate|ode|ultifile))(?=[(])" attribute = "Directive" context = "#pop" />
 				<RegExpr String = "\bop(?=[(])" attribute = "Directive" context = "#pop" />
-				<RegExpr String = "\b(calls|uses)(?=[(])" attribute = "Directive" context = "#pop" />
+				<RegExpr String = "\b(calls|use(s|_module))(?=[(])" attribute = "Directive" context = "#pop" />
 			</context>
 
 			<context name = "entityrelations" attribute = "Normal" lineEndContext = "#stay" >
Index: kate/data/php.xml
===================================================================
--- kate/data/php.xml	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kate/data/php.xml	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -1,6 +1,12 @@
 <?xml version="1.0" encoding="UTF-8"?>
+<!--
+	Changes: version 1.25 -> 1.26
+	Date: 26/01/2006
+	Change author: Nicola Gigante
+		Added alternative syntax control structures and named logical operators (and or xor)
+-->
 <!DOCTYPE language SYSTEM "language.dtd">
-<language name="PHP/PHP" version="1.25" kateversion="2.4" section="Scripts" extensions="" priority="5" mimetype="" hidden="true">
+<language name="PHP/PHP" version="1.26" kateversion="2.4" section="Scripts" extensions="" priority="5" mimetype="" hidden="true">
   <highlighting>
     <list name="control structures">
       <item>as</item>
@@ -21,6 +27,11 @@
       <item>include</item>
       <item>require_once</item>
       <item>include_once</item>
+      <item>endif</item>
+      <item>endwhile</item>
+      <item>endfor</item>
+      <item>endforeach</item>
+      <item>endswitch</item>
     </list>
     <list name="keywords">
       <item> abstract </item>
@@ -42,6 +53,9 @@
       <item> public </item>
       <item> throw </item>
       <item> try </item>
+      <item> and </item>
+      <item> or </item>
+      <item> xor </item>
 	<item> var </item>
 	<item> __FILE__ </item>
 	<item> __LINE__ </item>
Index: kate/data/cpp.xml
===================================================================
--- kate/data/cpp.xml	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kate/data/cpp.xml	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -1,6 +1,6 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <!DOCTYPE language SYSTEM "language.dtd">
-<language name="C++" version="1.34" kateversion="2.4" section="Sources" extensions="*.cxx;*.cpp;*.cc;*.C;*.h;*.hh;*.H;*.hxx;*.hpp;*.hcc;*.moc" mimetype="text/x-c++src;text/x-c++hdr;text/x-chdr" priority="9">
+<language name="C++" version="1.36" kateversion="2.4" section="Sources" extensions="*.c++;*.cxx;*.cpp;*.cc;*.C;*.h;*.H;*.h++;*.hxx;*.hpp;*.hcc;*.moc" mimetype="text/x-c++src;text/x-c++hdr;text/x-chdr" priority="9">
   <highlighting>
     <list name="keywords">
       <item> asm </item>
@@ -31,6 +31,7 @@
       <item> private </item>
       <item> protected </item>
       <item> public </item>
+      <item> qobject_cast </item>
       <item> reinterpret_cast </item>
       <item> return </item>
       <item> sizeof </item>
@@ -79,6 +80,33 @@
       <item> Q_OVERRIDE </item>
       <item> Q_PROPERTY </item>
       <item> Q_SETS </item>
+      <item> Q_SIGNALS </item>
+      <item> Q_SLOTS </item>
+      <item> Q_FOREACH </item>
+      <item> Q_DECLARE_FLAGS </item>
+      <item> Q_INIT_RESOURCE </item>
+      <item> Q_CLEANUP_RESOURCE </item>
+      <item> Q_GLOBAL_STATIC </item>
+      <item> Q_GLOBAL_STATIC_WITH_ARGS </item>
+      <item> Q_DECLARE_TYPEINFO </item>
+      <item> Q_DECLARE_SHARED </item>
+      <item> Q_DECLARE_FLAGS </item>
+      <item> Q_DECLARE_OPERATORS_FOR_FLAGS </item>
+      <item> Q_FOREVER </item>
+      <item> Q_DECLARE_PRIVATE </item>
+      <item> Q_DECLARE_PUBLIC </item>
+      <item> Q_D </item>
+      <item> Q_Q </item>
+      <item> Q_DISABLE_COPY </item>
+      <item> Q_INTERFACES </item>
+      <item> Q_FLAGS </item>
+      <item> Q_SCRIPTABLE </item>
+      <item> Q_INVOKABLE </item>
+      <item> Q_GADGET </item>
+      <item> Q_ARG </item>
+      <item> Q_RETURN_ARG </item>
+      <item> Q_ASSERT </item>
+      <item> Q_ASSERT_X </item>
       <item> TRUE </item>
       <item> FALSE </item>
       <item> connect </item>
@@ -87,6 +115,7 @@
       <item> signals </item>
       <item> slots </item>
       <item> foreach </item>
+      <item> forever </item>
     </list>
     <list name="types">
       <item> auto </item>
Index: mimetypes/all.desktop
===================================================================
--- mimetypes/all.desktop	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ mimetypes/all.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -24,7 +24,7 @@
 Comment[fa]=تمام پرونده‌ها و پوشه‌ها
 Comment[fi]=Kaikki tiedostot ja kansiot
 Comment[fr]=Tous les fichiers et dossiers
-Comment[fy]=Alle Triemen en Mappen
+Comment[fy]=Alle Triemmen en Mappen
 Comment[ga]=Gach Comhad agus Comhadlann
 Comment[gl]=Todos os Arquivos e Cartafois
 Comment[he]=כל הקבצים והתיקיות
Index: mimetypes/image/x-djvu-2.desktop
===================================================================
--- mimetypes/image/x-djvu-2.desktop	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ mimetypes/image/x-djvu-2.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -7,6 +7,7 @@
 Comment=DjVu Document
 Comment[af]=DjVu Dokument
 Comment[bg]=Документ DjVu
+Comment[br]=Teul DjVu
 Comment[ca]=Document DjVu
 Comment[cs]=DjVu dokument
 Comment[da]=DjVU-dokument
Index: mimetypes/image/x-djvu.desktop
===================================================================
--- mimetypes/image/x-djvu.desktop	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ mimetypes/image/x-djvu.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -7,6 +7,7 @@
 Comment=DjVu Document
 Comment[af]=DjVu Dokument
 Comment[bg]=Документ DjVu
+Comment[br]=Teul DjVu
 Comment[ca]=Document DjVu
 Comment[cs]=DjVu dokument
 Comment[da]=DjVU-dokument
Index: mimetypes/image/x-raw.desktop
===================================================================
--- mimetypes/image/x-raw.desktop	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ mimetypes/image/x-raw.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -6,12 +6,14 @@
 Patterns=*.raw;*.RAW;*.dcr;*.DCR;*.dng;*.DNG;*.crw;*.CRW;*.cr2,*.CR2;*.nef;*.NEF;*.mrw;*.MRW;
 Comment=RAW Camera Image
 Comment[ca]=Fitxer de càmera RAW
+Comment[cs]=RAW soubor z fotoaparátu
 Comment[da]=Ubehandlet kamerabillede
 Comment[de]=Kamera-Bild im RAW-Format
 Comment[el]=RAW εικόνα κάμερας
 Comment[es]=Imagen RAW de cámara
 Comment[et]=Kaamera toorpilt
 Comment[eu]=RAW kamara fitxategia
+Comment[fi]=RAW-kameratiedosto
 Comment[fr]=Image RAW d'appareil photo
 Comment[fy]=RAW-fototastelôfbylding
 Comment[hu]=RAW-képfájl
@@ -27,6 +29,7 @@
 Comment[pt]=Imagem RAW da Máquina Fotográfica
 Comment[pt_BR]=Imagem RAW da Máquina Fotográfica
 Comment[ro]=Imagine foto brută
+Comment[sl]=Slika RAW s fotoaparata
 Comment[sr]=Сирова слика са камере
 Comment[sr@Latn]=Sirova slika sa kamere
 Comment[sv]=Obehandlad kamerafil
Index: mimetypes/allfiles.desktop
===================================================================
--- mimetypes/allfiles.desktop	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ mimetypes/allfiles.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -24,7 +24,7 @@
 Comment[fa]=تمام پرونده‌ها
 Comment[fi]=Kaikki tiedostot
 Comment[fr]=Tous les fichiers
-Comment[fy]=Alle triemen
+Comment[fy]=Alle triemmen
 Comment[ga]=Gach Comhad
 Comment[gl]=Todos os Arquivos
 Comment[he]=כל הקבצים
Index: mimetypes/application/vnd.oasis.opendocument.graphics-template.desktop
===================================================================
--- mimetypes/application/vnd.oasis.opendocument.graphics-template.desktop	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ mimetypes/application/vnd.oasis.opendocument.graphics-template.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -53,6 +53,7 @@
 Comment[tr]=OASIS OpenDocument Grafik Şablonu
 Comment[tt]=OASIS OpenDocument Sızımı öçen Ürçetmä
 Comment[uk]=Шаблон графічного зображення OASIS OpenDocument
+Comment[uz]=OASIS OpenDocument графика намунаси
 Comment[zh_CN]=OASIS OpenDocument 图形模板
 Comment[zh_HK]=OASIS OpenDocument 繪圖範本
 [Property::X-KDE-NativeExtension]
Index: mimetypes/application/mbox.desktop
===================================================================
--- mimetypes/application/mbox.desktop	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ mimetypes/application/mbox.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -4,6 +4,7 @@
 MimeType=application/mbox
 Patterns=
 Comment=MBOX Mail Folder
+Comment[br]=Renkell postel MBOX
 Comment[ca]=Carpeta de correu MBOX
 Comment[cs]=Složka pošty MBOX
 Comment[da]=MBOX mappe til e-mail
@@ -38,6 +39,7 @@
 Comment[sv]=Mbox-brevkorg
 Comment[tg]=MBOX Феҳристи Почта
 Comment[uk]=Поштова тека MBOX
+Comment[uz]=MBOX хат қутиси
 Comment[zh_CN]=MBOX 邮件文件夹
 
 [Property::X-KDE-text]
Index: mimetypes/text/x-diff.desktop
===================================================================
--- mimetypes/text/x-diff.desktop	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ mimetypes/text/x-diff.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -22,7 +22,7 @@
 Comment[fa]=اختلاف‌های میان پرونده‌ها
 Comment[fi]=Tiedostojen väliset erot
 Comment[fr]=Différences entre fichiers
-Comment[fy]=Ferskil tusken triemen
+Comment[fy]=Ferskil tusken triemmen
 Comment[ga]=Difríochtaí idir chomhaid
 Comment[gl]=Diferéncias Entre Arquivos
 Comment[he]=הבדלים בין קבצים
Index: mimetypes/text/x-bibtex.desktop
===================================================================
--- mimetypes/text/x-bibtex.desktop	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ mimetypes/text/x-bibtex.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -7,6 +7,7 @@
 Comment[be]=Бібліяграфічныя дадзеныя (Bibtex)
 Comment[bg]=Библиографични данни (Bibtex)
 Comment[bn]=গ্রন্থতালিকা (বিবটেক)
+Comment[br]=Levrlennadur roadoù (Bibtex)
 Comment[bs]=Bibliografski podaci (Bibtex)
 Comment[ca]=Dades bibliogràfiques (Bibtex)
 Comment[cs]=Bibliografická data (bibtex)
Index: mimetypes/text/x-katefilelist.desktop
===================================================================
--- mimetypes/text/x-katefilelist.desktop	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ mimetypes/text/x-katefilelist.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -20,7 +20,7 @@
 Comment[fa]=سیاهه‌ی پرونده (برای متصل‌کننده‌ی بارکننده‌ی سیاهه‌ی پرونده‌ی Kate)
 Comment[fi]=Tiedostolista (Kate-tiedostolistalisäosalle)
 Comment[fr]=Liste de fichiers (pour le chargeur de listes de fichiers de Kate)
-Comment[fy]=Triemenlist (foar de Kate-triemenplugin)
+Comment[fy]=Triemmenlist (foar de Kate-triemmenplugin)
 Comment[gl]=Lista de Arquivos (para o Plugin Carregador de Lista de Arquivos de Kate)
 Comment[he]=רשימת קבצים (עבור תוסף טעינת רשימות הקבצים של Kate)
 Comment[hi]=फ़ाइल सूची(के-एटीई फ़ाइल लिस्ट लोडर प्लगिन के लिए)
Index: kioslave/http/http.cc
===================================================================
--- kioslave/http/http.cc	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kioslave/http/http.cc	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -2712,6 +2712,7 @@
 
   QString dispositionType; // In case we get a Content-Disposition type
   QString dispositionFilename; // In case we get a Content-Disposition filename
+
   QString mediaValue;
   QString mediaAttribute;
 
@@ -3279,6 +3280,11 @@
                       << dispositionFilename<< endl;
       }
     }
+    else if(strncasecmp(buf, "Content-Language:", 17) == 0) {
+      QString language = QString::fromLatin1(trimLead(buf+17)).stripWhiteSpace();
+      if (!language.isEmpty())
+        setMetaData("content-language", language);
+    }
     else if (strncasecmp(buf, "Proxy-Connection:", 17) == 0)
     {
       if (strncasecmp(trimLead(buf + 17), "Close", 5) == 0)
Index: kinit/setproctitle.h
===================================================================
--- kinit/setproctitle.h	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kinit/setproctitle.h	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -71,8 +71,8 @@
 # define SPT_PADCHAR    '\0'    /* pad process title with nulls */
 #endif
 
-#if defined(__FreeBSD__) || defined(__NetBSD__) || defined(__OpenBSD__)
-# if defined(__NetBSD__)
+#if defined(__FreeBSD__) || defined(__NetBSD__) || defined(__OpenBSD__) || defined(__DragonFly__)
+# if defined(__NetBSD__) || defined(__DragonFly__)
 #  undef SPT_TYPE
 #  define SPT_TYPE      SPT_BUILTIN     /* setproctitle is in libc */
 # endif
Index: kimgio/psd.kimgio
===================================================================
--- kimgio/psd.kimgio	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kimgio/psd.kimgio	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -24,6 +24,7 @@
 Name[ja]=Adobe Photoshop 画像
 Name[km]= រូបភាព​របស់ Adobe Photoshop
 Name[lb]=Adobe-Photoshop-Bild
+Name[ms]=Imej Adobe Photoshop
 Name[nb]=Adobe Photoshop-bilde
 Name[nds]=Adobe-Photoshop-Bild
 Name[nl]=Adobe Photoshop-afbeelding
Index: kio/kio/global.cpp
===================================================================
--- kio/kio/global.cpp	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kio/kio/global.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -1438,7 +1438,11 @@
 
 #ifdef HAVE_GETMNTINFO
 
+#ifdef HAVE_STATFS
     struct statfs *mounted;
+#elif defined(HAVE_STATVFS)
+    struct statvfs *mounted;
+#endif
 
     int num_fs = getmntinfo(&mounted, MNT_NOWAIT);
 
@@ -1704,7 +1708,12 @@
 
 #ifdef HAVE_GETMNTINFO
 
+#ifdef HAVE_STATFS
     struct statfs *mounted;
+#elif defined(HAVE_STATVFS)
+    struct statvfs *mounted;
+#endif
+
     char    realpath_buffer[MAXPATHLEN];
 
     int num_fs = getmntinfo(&mounted, MNT_NOWAIT);
Index: kio/kio/yacc.y
===================================================================
--- kio/kio/yacc.y	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kio/kio/yacc.y	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -116,7 +116,7 @@
 
 void yyerror ( const char *s )  /* Called by yyparse on error */
 {
-    printf ("ERROR: %s\n", s);
+    KTraderParse_error( s );
 }
 
 void KTraderParse_mainParse( const char *_code )
Index: kio/kio/ktar.cpp
===================================================================
--- kio/kio/ktar.cpp	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kio/kio/ktar.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -301,10 +301,10 @@
             delete filterDev;
             return false;
         }
-        Q_LONG len;
-        while ( !filterDev->atEnd() ) {
+        Q_LONG len = -1;
+        while ( !filterDev->atEnd() && len != 0) {
             len = filterDev->readBlock(buffer.data(),buffer.size());
-            if ( len <= 0 ) { // corrupted archive
+            if ( len < 0 ) { // corrupted archive
                 delete filterDev;
                 return false;
             }
Index: kio/kio/krun.cpp
===================================================================
--- kio/kio/krun.cpp	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kio/kio/krun.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -660,8 +660,17 @@
   if ( mx1.expandMacrosShellQuote( exec ) && !mx1.hasUrls ) {
     Q_ASSERT( supportedProtocols.isEmpty() ); // huh? If you support protocols you need %u or %U...
   } else {
-    if ( supportedProtocols.isEmpty() ) // compat: assume KIO if not set
-      supportedProtocols.append( "KIO" );
+    if ( supportedProtocols.isEmpty() )
+    {
+      // compat mode: assume KIO if not set and it's a KDE app
+      QStringList categories = _service.property("Categories").toStringList();
+      if ( categories.find("KDE") != categories.end() )
+         supportedProtocols.append( "KIO" );
+      else { // if no KDE app, be a bit over-generic
+         supportedProtocols.append( "http");
+         supportedProtocols.append( "ftp");
+      }
+    }
   }
   kdDebug(7010) << "supportedProtocols:" << supportedProtocols << endl;
 
Index: kio/kio/ktraderparse.h
===================================================================
--- kio/kio/ktraderparse.h	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kio/kio/ktraderparse.h	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -1,21 +1,21 @@
 /* This file is part of the KDE project
    Copyright (C) 1998, 1999 Torben Weis <weis@kde.org>
- 
+
    This library is free software; you can redistribute it and/or
    modify it under the terms of the GNU Library General Public
    License as published by the Free Software Foundation; either
    version 2 of the License, or (at your option) any later version.
- 
+
    This library is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
    Library General Public License for more details.
- 
+
    You should have received a copy of the GNU Library General Public License
    along with this library; see the file COPYING.LIB.  If not, write to
    the Free Software Foundation, Inc., 51 Franklin Street, Fifth Floor,
    Boston, MA 02110-1301, USA.
-*/     
+*/
 
 #ifndef __parse_h__
 #define __parse_h__
@@ -23,7 +23,9 @@
 /*
  * Functions definition for yacc
  */
+void KTraderParse_mainParse( const char *_code );
 void KTraderParse_setParseTree( void *_ptr1 );
+void KTraderParse_error( const char* err );
 void* KTraderParse_newOR( void *_ptr1, void *_ptr2 );
 void* KTraderParse_newAND( void *_ptr1, void *_ptr2 );
 void* KTraderParse_newCMP( void *_ptr1, void *_ptr2, int _i );
Index: kio/kio/job.cpp
===================================================================
--- kio/kio/job.cpp	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kio/kio/job.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -2786,7 +2786,7 @@
     {
         m_conflictError = job->error();
         if ( (m_conflictError == ERR_DIR_ALREADY_EXIST)
-             || (m_conflictError == ERR_FILE_ALREADY_EXIST) )
+             || (m_conflictError == ERR_FILE_ALREADY_EXIST) ) // can't happen?
         {
             KURL oldURL = ((SimpleJob*)job)->url();
             // Should we skip automatically ?
@@ -3050,7 +3050,8 @@
             m_conflictError = job->error(); // save for later
             // Existing dest ?
             if ( ( m_conflictError == ERR_FILE_ALREADY_EXIST )
-                 || ( m_conflictError == ERR_DIR_ALREADY_EXIST ) )
+                 || ( m_conflictError == ERR_DIR_ALREADY_EXIST )
+                 || ( m_conflictError == ERR_IDENTICAL_FILES ) )
             {
                 subjobs.remove( job );
                 assert ( subjobs.isEmpty() );
@@ -3132,7 +3133,8 @@
         m_reportTimer->stop();
 
     if ( ( m_conflictError == ERR_FILE_ALREADY_EXIST )
-      || ( m_conflictError == ERR_DIR_ALREADY_EXIST ) )
+         || ( m_conflictError == ERR_DIR_ALREADY_EXIST )
+         || ( m_conflictError == ERR_IDENTICAL_FILES ) )
     {
         // Its modification time:
         time_t destmtime = (time_t)-1;
@@ -3161,6 +3163,7 @@
         // Offer overwrite only if the existing thing is a file
         // If src==dest, use "overwrite-itself"
         RenameDlg_Mode mode;
+        bool isDir = true;
 
         if( m_conflictError == ERR_DIR_ALREADY_EXIST )
             mode = (RenameDlg_Mode) 0;
@@ -3172,6 +3175,7 @@
                 mode = M_OVERWRITE_ITSELF;
             else
                 mode = M_OVERWRITE;
+            isDir = false;
         }
 
 	if ( m_bSingleFileCopy )
@@ -3179,7 +3183,7 @@
 	else
             mode = (RenameDlg_Mode) ( mode | M_MULTI | M_SKIP );
 
-        res = Observer::self()->open_RenameDlg( this, m_conflictError == ERR_FILE_ALREADY_EXIST ?
+        res = Observer::self()->open_RenameDlg( this, !isDir ?
                                 i18n("File Already Exists") : i18n("Already Exists as Folder"),
                                 (*it).uSource.url(),
                                 (*it).uDest.url(),
@@ -3602,7 +3606,9 @@
         // In that case it's the _same_ dir, we don't want to copy+del (data loss!)
         if ( m_currentSrcURL.isLocalFile() && m_currentSrcURL.url(-1) != dest.url(-1) &&
              m_currentSrcURL.url(-1).lower() == dest.url(-1).lower() &&
-             ( err == ERR_FILE_ALREADY_EXIST || err == ERR_DIR_ALREADY_EXIST ) )
+             ( err == ERR_FILE_ALREADY_EXIST ||
+               err == ERR_DIR_ALREADY_EXIST ||
+               err == ERR_IDENTICAL_FILES ) )
         {
             kdDebug(7007) << "Couldn't rename directly, dest already exists. Detected special case of lower/uppercase renaming in same dir, try with 2 rename calls" << endl;
             QCString _src( QFile::encodeName(m_currentSrcURL.path()) );
@@ -3643,7 +3649,9 @@
         Q_ASSERT( m_currentSrcURL == *m_currentStatSrc );
 
         // Existing dest?
-        if ( ( err == ERR_DIR_ALREADY_EXIST || err == ERR_FILE_ALREADY_EXIST )
+        if ( ( err == ERR_DIR_ALREADY_EXIST ||
+               err == ERR_FILE_ALREADY_EXIST ||
+               err == ERR_IDENTICAL_FILES )
              && isInteractive() )
         {
             if (m_reportTimer)
@@ -3693,7 +3701,7 @@
 
                 RenameDlg_Result r = Observer::self()->open_RenameDlg(
                     this,
-                    err == ERR_FILE_ALREADY_EXIST ? i18n("File Already Exists") : i18n("Already Exists as Folder"),
+                    err != ERR_DIR_ALREADY_EXIST ? i18n("File Already Exists") : i18n("Already Exists as Folder"),
                     m_currentSrcURL.url(),
                     dest.url(),
                     mode, newPath,
Index: kio/kio/ktraderparse.cpp
===================================================================
--- kio/kio/ktraderparse.cpp	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kio/kio/ktraderparse.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -25,26 +25,32 @@
 extern "C"
 {
 #include "ktraderparse.h"
-
-void KTraderParse_mainParse( const char *_code );
 }
 
 #include "ktraderparsetree.h"
+#include <kdebug.h>
 
 using namespace KIO;
 
 static ParseTreeBase::Ptr *pTree = 0;
+static const char* sCode = 0;
 
 ParseTreeBase::Ptr KIO::parseConstraints( const QString& _constr )
 {
-  KTraderParse_mainParse( _constr.ascii() );
+  QCString str = _constr.utf8();
+  sCode = str.data();
+  KTraderParse_mainParse( sCode );
+  sCode = 0;
   assert( pTree );
   return *pTree;
 }
 
 ParseTreeBase::Ptr KIO::parsePreferences( const QString& _prefs )
 {
-  KTraderParse_mainParse( _prefs.ascii() );
+  QCString str = _prefs.utf8();
+  sCode = str.data();
+  KTraderParse_mainParse( sCode );
+  sCode = 0;
   assert( pTree );
   return *pTree;
 }
@@ -52,10 +58,16 @@
 void KTraderParse_setParseTree( void *_ptr1 )
 {
   if ( !pTree )
-    pTree = new ParseTreeBase::Ptr; // ### leak
+    pTree = new ParseTreeBase::Ptr; // ### leak; should use KStaticDeleter
   *pTree = static_cast<ParseTreeBase*>( _ptr1 );
 }
 
+
+void KTraderParse_error( const char* err )
+{
+  kdWarning(7014) << "Parsing '" << sCode << "' gave " << err << endl;
+}
+
 void* KTraderParse_newOR( void *_ptr1, void *_ptr2 )
 {
   return new ParseTreeOR( (ParseTreeBase*)_ptr1, (ParseTreeBase*)_ptr2 );
Index: kio/kio/yacc.c
===================================================================
--- kio/kio/yacc.c	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kio/kio/yacc.c	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -1,7 +1,7 @@
-/* A Bison parser, made by GNU Bison 1.875.  */
+/* A Bison parser, made by GNU Bison 2.0.  */
 
 /* Skeleton parser for Yacc-like parsing with Bison,
-   Copyright (C) 1984, 1989, 1990, 2000, 2001, 2002 Free Software Foundation, Inc.
+   Copyright (C) 1984, 1989, 1990, 2000, 2001, 2002, 2003, 2004 Free Software Foundation, Inc.
 
    This program is free software; you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
@@ -15,8 +15,8 @@
 
    You should have received a copy of the GNU General Public License
    along with this program; if not, write to the Free Software
-   Foundation, Inc., 51 Franklin Street, Fifth Floor,
-   Boston, MA 02110-1301, USA.  */
+   Foundation, Inc., 59 Temple Place - Suite 330,
+   Boston, MA 02111-1307, USA.  */
 
 /* As a special exception, when this file is copied by Bison into a
    Bison output file, you may use that output file without restriction.
@@ -45,8 +45,7 @@
 /* Using locations.  */
 #define YYLSP_NEEDED 0
 
-/* If NAME_PREFIX is specified substitute the variables and functions
-   names.  */
+/* Substitute the variable and function names.  */
 #define yyparse kiotraderparse
 #define yylex   kiotraderlex
 #define yyerror kiotradererror
@@ -139,7 +138,7 @@
      char *name;
      void *ptr;
 } YYSTYPE;
-/* Line 191 of yacc.c.  */
+/* Line 190 of yacc.c.  */
 #line 143 "yacc.tab.c"
 # define yystype YYSTYPE /* obsolescent; will be withdrawn */
 # define YYSTYPE_IS_DECLARED 1
@@ -151,23 +150,26 @@
 /* Copy the second part of user declarations.  */
 
 
-/* Line 214 of yacc.c.  */
+/* Line 213 of yacc.c.  */
 #line 155 "yacc.tab.c"
 
 #if ! defined (yyoverflow) || YYERROR_VERBOSE
 
+# ifndef YYFREE
+#  define YYFREE free
+# endif
+# ifndef YYMALLOC
+#  define YYMALLOC malloc
+# endif
+
 /* The parser invokes alloca or malloc; define the necessary symbols.  */
 
-# if YYSTACK_USE_ALLOCA
-#  define YYSTACK_ALLOC alloca
-# else
-#  ifndef YYSTACK_USE_ALLOCA
-#   if defined (alloca) || defined (_ALLOCA_H)
+# ifdef YYSTACK_USE_ALLOCA
+#  if YYSTACK_USE_ALLOCA
+#   ifdef __GNUC__
+#    define YYSTACK_ALLOC __builtin_alloca
+#   else
 #    define YYSTACK_ALLOC alloca
-#   else
-#    ifdef __GNUC__
-#     define YYSTACK_ALLOC __builtin_alloca
-#    endif
 #   endif
 #  endif
 # endif
@@ -180,20 +182,20 @@
 #   include <stdlib.h> /* INFRINGES ON USER NAME SPACE */
 #   define YYSIZE_T size_t
 #  endif
-#  define YYSTACK_ALLOC malloc
-#  define YYSTACK_FREE free
+#  define YYSTACK_ALLOC YYMALLOC
+#  define YYSTACK_FREE YYFREE
 # endif
 #endif /* ! defined (yyoverflow) || YYERROR_VERBOSE */
 
 
 #if (! defined (yyoverflow) \
      && (! defined (__cplusplus) \
-	 || (YYSTYPE_IS_TRIVIAL)))
+	 || (defined (YYSTYPE_IS_TRIVIAL) && YYSTYPE_IS_TRIVIAL)))
 
 /* A type that is properly aligned for any stack member.  */
 union yyalloc
 {
-  short yyss;
+  short int yyss;
   YYSTYPE yyvs;
   };
 
@@ -203,13 +205,13 @@
 /* The size of an array large to enough to hold all stacks, each with
    N elements.  */
 # define YYSTACK_BYTES(N) \
-     ((N) * (sizeof (short) + sizeof (YYSTYPE))				\
+     ((N) * (sizeof (short int) + sizeof (YYSTYPE))			\
       + YYSTACK_GAP_MAXIMUM)
 
 /* Copy COUNT objects from FROM to TO.  The source and destination do
    not overlap.  */
 # ifndef YYCOPY
-#  if 1 < __GNUC__
+#  if defined (__GNUC__) && 1 < __GNUC__
 #   define YYCOPY(To, From, Count) \
       __builtin_memcpy (To, From, (Count) * sizeof (*(From)))
 #  else
@@ -245,7 +247,7 @@
 #if defined (__STDC__) || defined (__cplusplus)
    typedef signed char yysigned_char;
 #else
-   typedef short yysigned_char;
+   typedef short int yysigned_char;
 #endif
 
 /* YYFINAL -- State number of the termination state. */
@@ -344,11 +346,11 @@
    First, the terminals, then, starting at YYNTOKENS, nonterminals. */
 static const char *const yytname[] =
 {
-  "$end", "error", "$undefined", "NOT", "EQ", "NEQ", "LEQ", "GEQ", "LE", 
-  "GR", "OR", "AND", "TOKEN_IN", "EXIST", "MAX", "MIN", "VAL_BOOL", 
-  "VAL_STRING", "VAL_ID", "VAL_NUM", "VAL_FLOAT", "'~'", "'+'", "'-'", 
-  "'*'", "'/'", "'('", "')'", "$accept", "constraint", "bool", "bool_or", 
-  "bool_and", "bool_compare", "expr_in", "expr_twiddle", "expr", "term", 
+  "$end", "error", "$undefined", "NOT", "EQ", "NEQ", "LEQ", "GEQ", "LE",
+  "GR", "OR", "AND", "TOKEN_IN", "EXIST", "MAX", "MIN", "VAL_BOOL",
+  "VAL_STRING", "VAL_ID", "VAL_NUM", "VAL_FLOAT", "'~'", "'+'", "'-'",
+  "'*'", "'/'", "'('", "')'", "$accept", "constraint", "bool", "bool_or",
+  "bool_and", "bool_compare", "expr_in", "expr_twiddle", "expr", "term",
   "factor_non", "factor", 0
 };
 #endif
@@ -356,7 +358,7 @@
 # ifdef YYPRINT
 /* YYTOKNUM[YYLEX-NUM] -- Internal token number corresponding to
    token YYLEX-NUM.  */
-static const unsigned short yytoknum[] =
+static const unsigned short int yytoknum[] =
 {
        0,   256,   257,   258,   259,   260,   261,   262,   263,   264,
      265,   266,   267,   268,   269,   270,   271,   272,   273,   274,
@@ -482,7 +484,7 @@
 
 #define YYACCEPT	goto yyacceptlab
 #define YYABORT		goto yyabortlab
-#define YYERROR		goto yyerrlab1
+#define YYERROR		goto yyerrorlab
 
 
 /* Like YYERROR except do call yyerror.  This remains here temporarily
@@ -510,20 +512,53 @@
     }								\
 while (0)
 
+
 #define YYTERROR	1
 #define YYERRCODE	256
 
-/* YYLLOC_DEFAULT -- Compute the default location (before the actions
-   are run).  */
 
+/* YYLLOC_DEFAULT -- Set CURRENT to span from RHS[1] to RHS[N].
+   If N is 0, then set CURRENT to the empty location which ends
+   the previous symbol: RHS[0] (always defined).  */
+
+#define YYRHSLOC(Rhs, K) ((Rhs)[K])
 #ifndef YYLLOC_DEFAULT
-# define YYLLOC_DEFAULT(Current, Rhs, N)         \
-  Current.first_line   = Rhs[1].first_line;      \
-  Current.first_column = Rhs[1].first_column;    \
-  Current.last_line    = Rhs[N].last_line;       \
-  Current.last_column  = Rhs[N].last_column;
+# define YYLLOC_DEFAULT(Current, Rhs, N)				\
+    do									\
+      if (N)								\
+	{								\
+	  (Current).first_line   = YYRHSLOC (Rhs, 1).first_line;	\
+	  (Current).first_column = YYRHSLOC (Rhs, 1).first_column;	\
+	  (Current).last_line    = YYRHSLOC (Rhs, N).last_line;		\
+	  (Current).last_column  = YYRHSLOC (Rhs, N).last_column;	\
+	}								\
+      else								\
+	{								\
+	  (Current).first_line   = (Current).last_line   =		\
+	    YYRHSLOC (Rhs, 0).last_line;				\
+	  (Current).first_column = (Current).last_column =		\
+	    YYRHSLOC (Rhs, 0).last_column;				\
+	}								\
+    while (0)
 #endif
 
+
+/* YY_LOCATION_PRINT -- Print the location on the stream.
+   This macro was not mandated originally: define only if we know
+   we won't break user code: when these are the locations we know.  */
+
+#ifndef YY_LOCATION_PRINT
+# if YYLTYPE_IS_TRIVIAL
+#  define YY_LOCATION_PRINT(File, Loc)			\
+     fprintf (File, "%d.%d-%d.%d",			\
+              (Loc).first_line, (Loc).first_column,	\
+              (Loc).last_line,  (Loc).last_column)
+# else
+#  define YY_LOCATION_PRINT(File, Loc) ((void) 0)
+# endif
+#endif
+
+
 /* YYLEX -- calling `yylex' with the right arguments.  */
 
 #ifdef YYLEX_PARAM
@@ -546,36 +581,30 @@
     YYFPRINTF Args;				\
 } while (0)
 
-# define YYDSYMPRINT(Args)			\
-do {						\
-  if (yydebug)					\
-    yysymprint Args;				\
-} while (0)
-
-# define YYDSYMPRINTF(Title, Token, Value, Location)		\
+# define YY_SYMBOL_PRINT(Title, Type, Value, Location)		\
 do {								\
   if (yydebug)							\
     {								\
       YYFPRINTF (stderr, "%s ", Title);				\
       yysymprint (stderr, 					\
-                  Token, Value);	\
+                  Type, Value);	\
       YYFPRINTF (stderr, "\n");					\
     }								\
 } while (0)
 
 /*------------------------------------------------------------------.
 | yy_stack_print -- Print the state stack from its BOTTOM up to its |
-| TOP (cinluded).                                                   |
+| TOP (included).                                                   |
 `------------------------------------------------------------------*/
 
 #if defined (__STDC__) || defined (__cplusplus)
 static void
-yy_stack_print (short *bottom, short *top)
+yy_stack_print (short int *bottom, short int *top)
 #else
 static void
 yy_stack_print (bottom, top)
-    short *bottom;
-    short *top;
+    short int *bottom;
+    short int *top;
 #endif
 {
   YYFPRINTF (stderr, "Stack now");
@@ -605,9 +634,9 @@
 #endif
 {
   int yyi;
-  unsigned int yylineno = yyrline[yyrule];
+  unsigned int yylno = yyrline[yyrule];
   YYFPRINTF (stderr, "Reducing stack by rule %d (line %u), ",
-             yyrule - 1, yylineno);
+             yyrule - 1, yylno);
   /* Print the symbols being reduced, and their result.  */
   for (yyi = yyprhs[yyrule]; 0 <= yyrhs[yyi]; yyi++)
     YYFPRINTF (stderr, "%s ", yytname [yyrhs[yyi]]);
@@ -625,8 +654,7 @@
 int yydebug;
 #else /* !YYDEBUG */
 # define YYDPRINTF(Args)
-# define YYDSYMPRINT(Args)
-# define YYDSYMPRINTF(Title, Token, Value, Location)
+# define YY_SYMBOL_PRINT(Title, Type, Value, Location)
 # define YY_STACK_PRINT(Bottom, Top)
 # define YY_REDUCE_PRINT(Rule)
 #endif /* !YYDEBUG */
@@ -644,10 +672,6 @@
    SIZE_MAX < YYSTACK_BYTES (YYMAXDEPTH)
    evaluated with infinite-precision integer arithmetic.  */
 
-#if YYMAXDEPTH == 0
-# undef YYMAXDEPTH
-#endif
-
 #ifndef YYMAXDEPTH
 # define YYMAXDEPTH 10000
 #endif
@@ -729,15 +753,15 @@
   (void) yyvaluep;
 
   if (yytype < YYNTOKENS)
-    {
-      YYFPRINTF (yyoutput, "token %s (", yytname[yytype]);
-# ifdef YYPRINT
-      YYPRINT (yyoutput, yytoknum[yytype], *yyvaluep);
-# endif
-    }
+    YYFPRINTF (yyoutput, "token %s (", yytname[yytype]);
   else
     YYFPRINTF (yyoutput, "nterm %s (", yytname[yytype]);
 
+
+# ifdef YYPRINT
+  if (yytype < YYNTOKENS)
+    YYPRINT (yyoutput, yytoknum[yytype], *yyvaluep);
+# endif
   switch (yytype)
     {
       default:
@@ -753,10 +777,11 @@
 
 #if defined (__STDC__) || defined (__cplusplus)
 static void
-yydestruct (int yytype, YYSTYPE *yyvaluep)
+yydestruct (const char *yymsg, int yytype, YYSTYPE *yyvaluep)
 #else
 static void
-yydestruct (yytype, yyvaluep)
+yydestruct (yymsg, yytype, yyvaluep)
+    const char *yymsg;
     int yytype;
     YYSTYPE *yyvaluep;
 #endif
@@ -764,6 +789,10 @@
   /* Pacify ``unused variable'' warnings.  */
   (void) yyvaluep;
 
+  if (!yymsg)
+    yymsg = "Deleting";
+  YY_SYMBOL_PRINT (yymsg, yytype, yyvaluep, yylocationp);
+
   switch (yytype)
     {
 
@@ -791,10 +820,10 @@
 
 
 
-/* The lookahead symbol.  */
+/* The look-ahead symbol.  */
 int yychar;
 
-/* The semantic value of the lookahead symbol.  */
+/* The semantic value of the look-ahead symbol.  */
 YYSTYPE yylval;
 
 /* Number of syntax errors so far.  */
@@ -830,7 +859,7 @@
   int yyresult;
   /* Number of tokens to shift before error messages enabled.  */
   int yyerrstatus;
-  /* Lookahead token as an internal (translated) token number.  */
+  /* Look-ahead token as an internal (translated) token number.  */
   int yytoken = 0;
 
   /* Three stacks and their tools:
@@ -842,9 +871,9 @@
      to reallocate them elsewhere.  */
 
   /* The state stack.  */
-  short	yyssa[YYINITDEPTH];
-  short *yyss = yyssa;
-  register short *yyssp;
+  short int yyssa[YYINITDEPTH];
+  short int *yyss = yyssa;
+  register short int *yyssp;
 
   /* The semantic value stack.  */
   YYSTYPE yyvsa[YYINITDEPTH];
@@ -881,6 +910,9 @@
   yyssp = yyss;
   yyvsp = yyvs;
 
+
+  yyvsp[0] = yylval;
+
   goto yysetstate;
 
 /*------------------------------------------------------------.
@@ -906,7 +938,7 @@
 	   these so that the &'s don't force the real ones into
 	   memory.  */
 	YYSTYPE *yyvs1 = yyvs;
-	short *yyss1 = yyss;
+	short int *yyss1 = yyss;
 
 
 	/* Each stack pointer address is followed by the size of the
@@ -934,7 +966,7 @@
 	yystacksize = YYMAXDEPTH;
 
       {
-	short *yyss1 = yyss;
+	short int *yyss1 = yyss;
 	union yyalloc *yyptr =
 	  (union yyalloc *) YYSTACK_ALLOC (YYSTACK_BYTES (yystacksize));
 	if (! yyptr)
@@ -970,18 +1002,18 @@
 yybackup:
 
 /* Do appropriate processing given the current state.  */
-/* Read a lookahead token if we need one and don't already have one.  */
+/* Read a look-ahead token if we need one and don't already have one.  */
 /* yyresume: */
 
-  /* First try to decide what to do without reference to lookahead token.  */
+  /* First try to decide what to do without reference to look-ahead token.  */
 
   yyn = yypact[yystate];
   if (yyn == YYPACT_NINF)
     goto yydefault;
 
-  /* Not known => get a lookahead token if don't already have one.  */
+  /* Not known => get a look-ahead token if don't already have one.  */
 
-  /* YYCHAR is either YYEMPTY or YYEOF or a valid lookahead symbol.  */
+  /* YYCHAR is either YYEMPTY or YYEOF or a valid look-ahead symbol.  */
   if (yychar == YYEMPTY)
     {
       YYDPRINTF ((stderr, "Reading a token: "));
@@ -996,7 +1028,7 @@
   else
     {
       yytoken = YYTRANSLATE (yychar);
-      YYDSYMPRINTF ("Next token is", yytoken, &yylval, &yylloc);
+      YY_SYMBOL_PRINT ("Next token is", yytoken, &yylval, &yylloc);
     }
 
   /* If the proper action on seeing token YYTOKEN is to reduce or to
@@ -1016,8 +1048,8 @@
   if (yyn == YYFINAL)
     YYACCEPT;
 
-  /* Shift the lookahead token.  */
-  YYDPRINTF ((stderr, "Shifting token %s, ", yytname[yytoken]));
+  /* Shift the look-ahead token.  */
+  YY_SYMBOL_PRINT ("Shifting", yytoken, &yylval, &yylloc);
 
   /* Discard the token being shifted unless it is eof.  */
   if (yychar != YYEOF)
@@ -1073,179 +1105,179 @@
 
   case 3:
 #line 57 "yacc.y"
-    { KTraderParse_setParseTree( yyvsp[0].ptr ); ;}
+    { KTraderParse_setParseTree( (yyvsp[0].ptr) ); ;}
     break;
 
   case 4:
 #line 60 "yacc.y"
-    { yyval.ptr = yyvsp[0].ptr; ;}
+    { (yyval.ptr) = (yyvsp[0].ptr); ;}
     break;
 
   case 5:
 #line 63 "yacc.y"
-    { yyval.ptr = KTraderParse_newOR( yyvsp[-2].ptr, yyvsp[0].ptr ); ;}
+    { (yyval.ptr) = KTraderParse_newOR( (yyvsp[-2].ptr), (yyvsp[0].ptr) ); ;}
     break;
 
   case 6:
 #line 64 "yacc.y"
-    { yyval.ptr = yyvsp[0].ptr; ;}
+    { (yyval.ptr) = (yyvsp[0].ptr); ;}
     break;
 
   case 7:
 #line 67 "yacc.y"
-    { yyval.ptr = KTraderParse_newAND( yyvsp[-2].ptr, yyvsp[0].ptr ); ;}
+    { (yyval.ptr) = KTraderParse_newAND( (yyvsp[-2].ptr), (yyvsp[0].ptr) ); ;}
     break;
 
   case 8:
 #line 68 "yacc.y"
-    { yyval.ptr = yyvsp[0].ptr; ;}
+    { (yyval.ptr) = (yyvsp[0].ptr); ;}
     break;
 
   case 9:
 #line 71 "yacc.y"
-    { yyval.ptr = KTraderParse_newCMP( yyvsp[-2].ptr, yyvsp[0].ptr, 1 ); ;}
+    { (yyval.ptr) = KTraderParse_newCMP( (yyvsp[-2].ptr), (yyvsp[0].ptr), 1 ); ;}
     break;
 
   case 10:
 #line 72 "yacc.y"
-    { yyval.ptr = KTraderParse_newCMP( yyvsp[-2].ptr, yyvsp[0].ptr, 2 ); ;}
+    { (yyval.ptr) = KTraderParse_newCMP( (yyvsp[-2].ptr), (yyvsp[0].ptr), 2 ); ;}
     break;
 
   case 11:
 #line 73 "yacc.y"
-    { yyval.ptr = KTraderParse_newCMP( yyvsp[-2].ptr, yyvsp[0].ptr, 3 ); ;}
+    { (yyval.ptr) = KTraderParse_newCMP( (yyvsp[-2].ptr), (yyvsp[0].ptr), 3 ); ;}
     break;
 
   case 12:
 #line 74 "yacc.y"
-    { yyval.ptr = KTraderParse_newCMP( yyvsp[-2].ptr, yyvsp[0].ptr, 4 ); ;}
+    { (yyval.ptr) = KTraderParse_newCMP( (yyvsp[-2].ptr), (yyvsp[0].ptr), 4 ); ;}
     break;
 
   case 13:
 #line 75 "yacc.y"
-    { yyval.ptr = KTraderParse_newCMP( yyvsp[-2].ptr, yyvsp[0].ptr, 5 ); ;}
+    { (yyval.ptr) = KTraderParse_newCMP( (yyvsp[-2].ptr), (yyvsp[0].ptr), 5 ); ;}
     break;
 
   case 14:
 #line 76 "yacc.y"
-    { yyval.ptr = KTraderParse_newCMP( yyvsp[-2].ptr, yyvsp[0].ptr, 6 ); ;}
+    { (yyval.ptr) = KTraderParse_newCMP( (yyvsp[-2].ptr), (yyvsp[0].ptr), 6 ); ;}
     break;
 
   case 15:
 #line 77 "yacc.y"
-    { yyval.ptr = yyvsp[0].ptr; ;}
+    { (yyval.ptr) = (yyvsp[0].ptr); ;}
     break;
 
   case 16:
 #line 80 "yacc.y"
-    { yyval.ptr = KTraderParse_newIN( yyvsp[-2].ptr, KTraderParse_newID( yyvsp[0].name ) ); ;}
+    { (yyval.ptr) = KTraderParse_newIN( (yyvsp[-2].ptr), KTraderParse_newID( (yyvsp[0].name) ) ); ;}
     break;
 
   case 17:
 #line 81 "yacc.y"
-    { yyval.ptr = yyvsp[0].ptr; ;}
+    { (yyval.ptr) = (yyvsp[0].ptr); ;}
     break;
 
   case 18:
 #line 84 "yacc.y"
-    { yyval.ptr = KTraderParse_newMATCH( yyvsp[-2].ptr, yyvsp[0].ptr ); ;}
+    { (yyval.ptr) = KTraderParse_newMATCH( (yyvsp[-2].ptr), (yyvsp[0].ptr) ); ;}
     break;
 
   case 19:
 #line 85 "yacc.y"
-    { yyval.ptr = yyvsp[0].ptr; ;}
+    { (yyval.ptr) = (yyvsp[0].ptr); ;}
     break;
 
   case 20:
 #line 88 "yacc.y"
-    { yyval.ptr = KTraderParse_newCALC( yyvsp[-2].ptr, yyvsp[0].ptr, 1 ); ;}
+    { (yyval.ptr) = KTraderParse_newCALC( (yyvsp[-2].ptr), (yyvsp[0].ptr), 1 ); ;}
     break;
 
   case 21:
 #line 89 "yacc.y"
-    { yyval.ptr = KTraderParse_newCALC( yyvsp[-2].ptr, yyvsp[0].ptr, 2 ); ;}
+    { (yyval.ptr) = KTraderParse_newCALC( (yyvsp[-2].ptr), (yyvsp[0].ptr), 2 ); ;}
     break;
 
   case 22:
 #line 90 "yacc.y"
-    { yyval.ptr = yyvsp[0].ptr; ;}
+    { (yyval.ptr) = (yyvsp[0].ptr); ;}
     break;
 
   case 23:
 #line 93 "yacc.y"
-    { yyval.ptr = KTraderParse_newCALC( yyvsp[-2].ptr, yyvsp[0].ptr, 3 ); ;}
+    { (yyval.ptr) = KTraderParse_newCALC( (yyvsp[-2].ptr), (yyvsp[0].ptr), 3 ); ;}
     break;
 
   case 24:
 #line 94 "yacc.y"
-    { yyval.ptr = KTraderParse_newCALC( yyvsp[-2].ptr, yyvsp[0].ptr, 4 ); ;}
+    { (yyval.ptr) = KTraderParse_newCALC( (yyvsp[-2].ptr), (yyvsp[0].ptr), 4 ); ;}
     break;
 
   case 25:
 #line 95 "yacc.y"
-    { yyval.ptr = yyvsp[0].ptr; ;}
+    { (yyval.ptr) = (yyvsp[0].ptr); ;}
     break;
 
   case 26:
 #line 98 "yacc.y"
-    { yyval.ptr = KTraderParse_newNOT( yyvsp[0].ptr ); ;}
+    { (yyval.ptr) = KTraderParse_newNOT( (yyvsp[0].ptr) ); ;}
     break;
 
   case 27:
 #line 99 "yacc.y"
-    { yyval.ptr = yyvsp[0].ptr; ;}
+    { (yyval.ptr) = (yyvsp[0].ptr); ;}
     break;
 
   case 28:
 #line 102 "yacc.y"
-    { yyval.ptr = KTraderParse_newBRACKETS( yyvsp[-1].ptr ); ;}
+    { (yyval.ptr) = KTraderParse_newBRACKETS( (yyvsp[-1].ptr) ); ;}
     break;
 
   case 29:
 #line 103 "yacc.y"
-    { yyval.ptr = KTraderParse_newEXIST( yyvsp[0].name ); ;}
+    { (yyval.ptr) = KTraderParse_newEXIST( (yyvsp[0].name) ); ;}
     break;
 
   case 30:
 #line 104 "yacc.y"
-    { yyval.ptr = KTraderParse_newID( yyvsp[0].name ); ;}
+    { (yyval.ptr) = KTraderParse_newID( (yyvsp[0].name) ); ;}
     break;
 
   case 31:
 #line 105 "yacc.y"
-    { yyval.ptr = KTraderParse_newNUM( yyvsp[0].vali ); ;}
+    { (yyval.ptr) = KTraderParse_newNUM( (yyvsp[0].vali) ); ;}
     break;
 
   case 32:
 #line 106 "yacc.y"
-    { yyval.ptr = KTraderParse_newFLOAT( yyvsp[0].vald ); ;}
+    { (yyval.ptr) = KTraderParse_newFLOAT( (yyvsp[0].vald) ); ;}
     break;
 
   case 33:
 #line 107 "yacc.y"
-    { yyval.ptr = KTraderParse_newSTRING( yyvsp[0].name ); ;}
+    { (yyval.ptr) = KTraderParse_newSTRING( (yyvsp[0].name) ); ;}
     break;
 
   case 34:
 #line 108 "yacc.y"
-    { yyval.ptr = KTraderParse_newBOOL( yyvsp[0].valb ); ;}
+    { (yyval.ptr) = KTraderParse_newBOOL( (yyvsp[0].valb) ); ;}
     break;
 
   case 35:
 #line 109 "yacc.y"
-    { yyval.ptr = KTraderParse_newMAX2( yyvsp[0].name ); ;}
+    { (yyval.ptr) = KTraderParse_newMAX2( (yyvsp[0].name) ); ;}
     break;
 
   case 36:
 #line 110 "yacc.y"
-    { yyval.ptr = KTraderParse_newMIN2( yyvsp[0].name ); ;}
+    { (yyval.ptr) = KTraderParse_newMIN2( (yyvsp[0].name) ); ;}
     break;
 
 
     }
 
-/* Line 999 of yacc.c.  */
-#line 1248 "yacc.tab.c"
+/* Line 1037 of yacc.c.  */
+#line 1281 "yacc.tab.c"
 
   yyvsp -= yylen;
   yyssp -= yylen;
@@ -1286,18 +1318,33 @@
 	{
 	  YYSIZE_T yysize = 0;
 	  int yytype = YYTRANSLATE (yychar);
+	  const char* yyprefix;
 	  char *yymsg;
-	  int yyx, yycount;
+	  int yyx;
 
-	  yycount = 0;
 	  /* Start YYX at -YYN if negative to avoid negative indexes in
 	     YYCHECK.  */
-	  for (yyx = yyn < 0 ? -yyn : 0;
-	       yyx < (int) (sizeof (yytname) / sizeof (char *)); yyx++)
+	  int yyxbegin = yyn < 0 ? -yyn : 0;
+
+	  /* Stay within bounds of both yycheck and yytname.  */
+	  int yychecklim = YYLAST - yyn;
+	  int yyxend = yychecklim < YYNTOKENS ? yychecklim : YYNTOKENS;
+	  int yycount = 0;
+
+	  yyprefix = ", expecting ";
+	  for (yyx = yyxbegin; yyx < yyxend; ++yyx)
 	    if (yycheck[yyx + yyn] == yyx && yyx != YYTERROR)
-	      yysize += yystrlen (yytname[yyx]) + 15, yycount++;
-	  yysize += yystrlen ("syntax error, unexpected ") + 1;
-	  yysize += yystrlen (yytname[yytype]);
+	      {
+		yysize += yystrlen (yyprefix) + yystrlen (yytname [yyx]);
+		yycount += 1;
+		if (yycount == 5)
+		  {
+		    yysize = 0;
+		    break;
+		  }
+	      }
+	  yysize += (sizeof ("syntax error, unexpected ")
+		     + yystrlen (yytname[yytype]));
 	  yymsg = (char *) YYSTACK_ALLOC (yysize);
 	  if (yymsg != 0)
 	    {
@@ -1306,16 +1353,13 @@
 
 	      if (yycount < 5)
 		{
-		  yycount = 0;
-		  for (yyx = yyn < 0 ? -yyn : 0;
-		       yyx < (int) (sizeof (yytname) / sizeof (char *));
-		       yyx++)
+		  yyprefix = ", expecting ";
+		  for (yyx = yyxbegin; yyx < yyxend; ++yyx)
 		    if (yycheck[yyx + yyn] == yyx && yyx != YYTERROR)
 		      {
-			const char *yyq = ! yycount ? ", expecting " : " or ";
-			yyp = yystpcpy (yyp, yyq);
+			yyp = yystpcpy (yyp, yyprefix);
 			yyp = yystpcpy (yyp, yytname[yyx]);
-			yycount++;
+			yyprefix = " or ";
 		      }
 		}
 	      yyerror (yymsg);
@@ -1333,38 +1377,57 @@
 
   if (yyerrstatus == 3)
     {
-      /* If just tried and failed to reuse lookahead token after an
+      /* If just tried and failed to reuse look-ahead token after an
 	 error, discard it.  */
 
-      /* Return failure if at end of input.  */
-      if (yychar == YYEOF)
+      if (yychar <= YYEOF)
         {
-	  /* Pop the error token.  */
-          YYPOPSTACK;
-	  /* Pop the rest of the stack.  */
-	  while (yyss < yyssp)
-	    {
-	      YYDSYMPRINTF ("Error: popping", yystos[*yyssp], yyvsp, yylsp);
-	      yydestruct (yystos[*yyssp], yyvsp);
-	      YYPOPSTACK;
-	    }
-	  YYABORT;
+          /* If at end of input, pop the error token,
+	     then the rest of the stack, then return failure.  */
+	  if (yychar == YYEOF)
+	     for (;;)
+	       {
+
+		 YYPOPSTACK;
+		 if (yyssp == yyss)
+		   YYABORT;
+		 yydestruct ("Error: popping",
+                             yystos[*yyssp], yyvsp);
+	       }
         }
-
-      YYDSYMPRINTF ("Error: discarding", yytoken, &yylval, &yylloc);
-      yydestruct (yytoken, &yylval);
-      yychar = YYEMPTY;
-
+      else
+	{
+	  yydestruct ("Error: discarding", yytoken, &yylval);
+	  yychar = YYEMPTY;
+	}
     }
 
-  /* Else will try to reuse lookahead token after shifting the error
+  /* Else will try to reuse look-ahead token after shifting the error
      token.  */
   goto yyerrlab1;
 
 
-/*----------------------------------------------------.
-| yyerrlab1 -- error raised explicitly by an action.  |
-`----------------------------------------------------*/
+/*---------------------------------------------------.
+| yyerrorlab -- error raised explicitly by YYERROR.  |
+`---------------------------------------------------*/
+yyerrorlab:
+
+#ifdef __GNUC__
+  /* Pacify GCC when the user code never invokes YYERROR and the label
+     yyerrorlab therefore never appears in user code.  */
+  if (0)
+     goto yyerrorlab;
+#endif
+
+yyvsp -= yylen;
+  yyssp -= yylen;
+  yystate = *yyssp;
+  goto yyerrlab1;
+
+
+/*-------------------------------------------------------------.
+| yyerrlab1 -- common code for both syntax error and YYERROR.  |
+`-------------------------------------------------------------*/
 yyerrlab1:
   yyerrstatus = 3;	/* Each real token shifted decrements this.  */
 
@@ -1386,22 +1449,22 @@
       if (yyssp == yyss)
 	YYABORT;
 
-      YYDSYMPRINTF ("Error: popping", yystos[*yyssp], yyvsp, yylsp);
-      yydestruct (yystos[yystate], yyvsp);
-      yyvsp--;
-      yystate = *--yyssp;
 
+      yydestruct ("Error: popping", yystos[yystate], yyvsp);
+      YYPOPSTACK;
+      yystate = *yyssp;
       YY_STACK_PRINT (yyss, yyssp);
     }
 
   if (yyn == YYFINAL)
     YYACCEPT;
 
-  YYDPRINTF ((stderr, "Shifting error token, "));
-
   *++yyvsp = yylval;
 
 
+  /* Shift the error token. */
+  YY_SYMBOL_PRINT ("Shifting", yystos[yyn], yyvsp, yylsp);
+
   yystate = yyn;
   goto yynewstate;
 
@@ -1417,6 +1480,9 @@
 | yyabortlab -- YYABORT comes here.  |
 `-----------------------------------*/
 yyabortlab:
+  yydestruct ("Error: discarding lookahead",
+              yytoken, &yylval);
+  yychar = YYEMPTY;
   yyresult = 1;
   goto yyreturn;
 
@@ -1439,12 +1505,12 @@
 }
 
 
-#line 56 "yacc.y"
+#line 115 "yacc.y"
 
 
 void yyerror ( const char *s )  /* Called by yyparse on error */
 {
-    printf ("ERROR: %s\n", s);
+    KTraderParse_error( s );
 }
 
 void KTraderParse_mainParse( const char *_code )
Index: kio/tests/kdirwatchunittest.cpp
===================================================================
--- kio/tests/kdirwatchunittest.cpp	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kio/tests/kdirwatchunittest.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -88,6 +88,17 @@
             m_lastSignal == alert);
 }
 
+void KDirWatchTest::remove_file (const QString& file)
+{
+  ::unlink (QFile::encodeName(file));
+}
+
+void KDirWatchTest::touch_file (const QString& file)
+{
+  QFile f(file);
+  f.open(IO_WriteOnly);
+}
+
 KUNITTEST_MODULE ( kunittest_kdirwatch, "KDirWatchTest" )
 KUNITTEST_MODULE_REGISTER_TESTER (KDirWatchTest)
 
@@ -112,6 +123,10 @@
     VERIFY_NOTHING();
     dir->mkdir ("does");
     VERIFY_DIRTY (m_workingDir);
+    touch_file (m_workingDir + "/file");
+    VERIFY_DIRTY (m_workingDir + "/file");
+    VERIFY_NOTHING ();
+    remove_file (m_workingDir + "/file");
     d->addDir (m_workingDir + "/does/not/exist");
     d->removeDir (m_workingDir);
     VERIFY_NOTHING();
Index: kio/tests/kdirwatchunittest.h
===================================================================
--- kio/tests/kdirwatchunittest.h	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kio/tests/kdirwatchunittest.h	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -54,6 +54,9 @@
   /* verify that deleted got emitted */
   void VERIFY_DELETED (const QString&);
 
+  void touch_file (const QString& file);
+  void remove_file (const QString& file);
+
   QString  m_lastSignal;
   QString m_workingDir;
   KDirWatch* d;
Index: kabc/plugins/file/resourcefile.cpp
===================================================================
--- kabc/plugins/file/resourcefile.cpp	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kabc/plugins/file/resourcefile.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -2,6 +2,7 @@
     This file is part of libkabc.
 
     Copyright (c) 2001,2003 Cornelius Schumacher <schumacher@kde.org>
+    Copyright (c) 2006 Tom Abers <tomalbers@kde.nl>
 
     This library is free software; you can redistribute it and/or
     modify it under the terms of the GNU Library General Public
@@ -37,6 +38,9 @@
 #include <ksavefile.h>
 #include <kstandarddirs.h>
 #include <ktempfile.h>
+#include <kurl.h>
+#include <jobclasses.h>
+#include <kio/netaccess.h>
 
 #include "formatfactory.h"
 #include "resourcefileconfig.h"
@@ -189,9 +193,31 @@
 
     if ( file.size() == 0 ) {
       file.close();
+      kdDebug() << "File size is zero. Evaluating backups" << endl;
+      for (int i=0; i!=20; i++)
+      {
+        QFile backup( mFileName + "__" + QString::number(i) );
+        kdDebug() << "Evaluating" << backup.name() << " size: " << backup.size() << endl;
+        if ( backup.size() != 0 )
+        {
+          kdDebug() << "Restoring backup " << i << endl;
+          KURL src, dest;
+          src.setPath( mFileName + "__" + QString::number(i) );
+          dest.setPath( mFileName );
+          
+          KIO::DeleteJob* job = KIO::del( dest, false, false ); 
+          KIO::NetAccess::synchronousRun( job, 0);
+          
+          KIO::CopyJob* job2 = KIO::copy( src, dest, false ); 
+          KIO::NetAccess::synchronousRun( job2, 0);
+
+          backup.close();
+          return true; 
+        }
+        backup.close();
+      }
       return true;
     }
-
     bool ok = mFormat->checkFormat( &file );
     file.close();
 
@@ -307,8 +333,28 @@
     return false;
   }
 
-  // create backup file
-  QString extension = "_" + QString::number( QDate::currentDate().dayOfWeek() );
+  // Only do the logrotate dance when the __0 file is not 0 bytes.
+  QFile file( mFileName + "__0" );
+  if ( file.size() != 0 ) {
+    KURL last;
+    last.setPath( mFileName + "__20" );
+    kdDebug() << "deleting " << last << endl;
+    KIO::DeleteJob* job = KIO::del( last, false, false ); 
+    KIO::NetAccess::synchronousRun( job, 0);
+
+    for (int i=19; i>=0; i--)
+    {
+      KURL src, dest;
+      src.setPath( mFileName + "__" + QString::number(i) );
+      dest.setPath( mFileName + "__" + QString::number(i+1) );
+      kdDebug() << "moving " << src << " -> " << dest << endl;
+      KIO::SimpleJob* job = KIO::rename( src, dest, false ); 
+      KIO::NetAccess::synchronousRun( job, 0);
+    }
+  } else
+    kdDebug() << "Not starting logrotate __0 is 0 bytes." << endl;
+  
+  QString extension = "__0";
   (void) KSaveFile::backupFile( mFileName, QString::null /*directory*/,
                                 extension );
 
Index: kabc/Makefile.am
===================================================================
--- kabc/Makefile.am	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kabc/Makefile.am	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -2,7 +2,7 @@
 
 # Make sure $(all_includes) remains last!
 INCLUDES = -I$(top_builddir)/kabc -I$(top_srcdir)/kabc -I$(top_srcdir)/kab \
-           -I$(srcdir)/vcardparser/ -I$(srcdir)/vcard/include \
+           -I$(srcdir)/vcard/include -I$(srcdir)/vcardparser/ \
            -I$(srcdir)/vcard/include/generated \
            -I$(srcdir)/vcardparser $(all_includes)
 
Index: kwallet/backend/sha1.cc
===================================================================
--- kwallet/backend/sha1.cc	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kwallet/backend/sha1.cc	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -23,6 +23,9 @@
 #ifdef HAVE_SYS_TYPES_H
 #include <sys/types.h>
 #endif
+#ifdef HAVE_STDINT_H
+#include <stdint.h> /* For uintXX_t on OSX */
+#endif
 #ifdef HAVE_SYS_BITYPES_H
 #include <sys/bitypes.h> /* For uintXX_t on Tru64 */
 #endif
Index: kdesu/su.cpp
===================================================================
--- kdesu/su.cpp	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kdesu/su.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -75,6 +75,11 @@
 
     QCStringList args;
 
+#ifdef Q_OS_DARWIN
+    args += "-c";
+    args += "staff";
+#endif
+
     if ((m_Scheduler != SchedNormal) || (m_Priority > 50))
         args += "root";
     else
@@ -82,7 +87,9 @@
     
     args += "-c";
     args += QCString(__KDE_BINDIR) + "/kdesu_stub";
+#ifndef Q_OS_DARWIN
     args += "-";
+#endif
 
     QCString command = __PATH_SU;
     if (::access(__PATH_SU, X_OK) != 0)
Index: kdecore/kmountpoint.cpp
===================================================================
--- kdecore/kmountpoint.cpp	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kdecore/kmountpoint.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -226,7 +226,11 @@
 
 #ifdef HAVE_GETMNTINFO
 
+#ifdef HAVE_STATFS
     struct statfs *mounted;
+#elif defined(HAVE_STATVFS)
+    struct statvfs *mounted;
+#endif
 
     int num_fs = getmntinfo(&mounted, MNT_NOWAIT);
 
Index: kdecore/eventsrc
===================================================================
--- kdecore/eventsrc	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kdecore/eventsrc	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -619,7 +619,7 @@
 Name[fi]=Ei voitu avata tiedostoa
 Name[fo]=Kann ikki opna fíla
 Name[fr]=Impossible d'ouvrir un fichier
-Name[fy]=Kin it triem net iepenje
+Name[fy]=Kin de triem net iepenje
 Name[ga]=Ní Féidir an Comhad a Oscailt
 Name[gl]=Non se pode abrir a arquivo
 Name[he]=אין אפשרות לפתוח קובץ
Index: kdecore/kprocess.cpp
===================================================================
--- kdecore/kprocess.cpp	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kdecore/kprocess.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -355,8 +355,6 @@
   if (pipe(fd))
      fd[0] = fd[1] = -1; // Pipe failed.. continue
 
-  QApplication::flushX();
-
   // we don't use vfork() because
   // - it has unclear semantics and is not standardized
   // - we do way too much magic in the child
@@ -768,7 +766,7 @@
     d->shell = shell;
   else
 // #ifdef NON_FREE // ... as they ship non-POSIX /bin/sh
-#if !defined(__linux__) && !defined(__FreeBSD__) && !defined(__NetBSD__) && !defined(__OpenBSD__) && !defined(__GNU__)
+#if !defined(__linux__) && !defined(__FreeBSD__) && !defined(__NetBSD__) && !defined(__OpenBSD__) && !defined(__GNU__) && !defined(__DragonFly__)
   // Solaris POSIX ...
   if (!access( "/usr/xpg4/bin/sh", X_OK ))
     d->shell = "/usr/xpg4/bin/sh";
Index: kdecore/all_languages.desktop
===================================================================
--- kdecore/all_languages.desktop	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kdecore/all_languages.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -2895,6 +2895,7 @@
 Name[tr]=Galik
 Name[tt]=Galça
 Name[uk]=Гальська
+Name[uz]=Галикча
 Name[wa]=Gayel
 Name[zh_CN]=盖尔语
 Name[zh_HK]=蓋爾語
@@ -8444,6 +8445,7 @@
 Name[sv]=Latinsk serbiska
 Name[tg]=Сербӣ (Лотинӣ)
 Name[uk]=Сербська (латинь)
+Name[uz]=Сербча (Лотин)
 Name[zh_CN]=塞尔维亚语(拉丁)
 [ss]
 Name=Swati
@@ -10303,6 +10305,7 @@
 Name[sv]=Kinesiska (Hong Kong)
 Name[tg]=Хитоӣ (Гонконг)
 Name[uk]=Китайська (Гонконг)
+Name[uz]=Хитойча (Гонгконг)
 Name[zh_CN]=繁体中文(香港)
 [zh_TW]
 Name=Chinese Traditional
Index: kdecore/kapplication.cpp
===================================================================
--- kdecore/kapplication.cpp	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kdecore/kapplication.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -960,14 +960,13 @@
 static int my_system (const char *command) {
    int pid, status;
 
-   QApplication::flushX();
    pid = fork();
    if (pid == -1)
       return -1;
    if (pid == 0) {
       const char* shell = "/bin/sh";
       execl(shell, shell, "-c", command, (void *)0);
-      ::exit(127);
+      ::_exit(127);
    }
    do {
       if (waitpid(pid, &status, 0) == -1) {
Index: kdecore/kpty.cpp
===================================================================
--- kdecore/kpty.cpp	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kdecore/kpty.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -95,7 +95,7 @@
 # endif
 #endif
 
-#if defined (__FreeBSD__) || defined (__NetBSD__) || defined (__OpenBSD__) || defined (__bsdi__) || defined(__APPLE__)
+#if defined (__FreeBSD__) || defined (__NetBSD__) || defined (__OpenBSD__) || defined (__bsdi__) || defined(__APPLE__) || defined (__DragonFly__)
 # define _tcgetattr(fd, ttmode) ioctl(fd, TIOCGETA, (char *)ttmode)
 #else
 # if defined(_HPUX_SOURCE) || defined(__Lynx__) || defined (__CYGWIN__)
@@ -105,7 +105,7 @@
 # endif
 #endif
 
-#if defined (__FreeBSD__) || defined (__NetBSD__) || defined (__OpenBSD__) || defined (__bsdi__) || defined(__APPLE__)
+#if defined (__FreeBSD__) || defined (__NetBSD__) || defined (__OpenBSD__) || defined (__bsdi__) || defined(__APPLE__) || defined (__DragonFly__)
 # define _tcsetattr(fd, ttmode) ioctl(fd, TIOCSETA, (char *)ttmode)
 #else
 # if defined(_HPUX_SOURCE) || defined(__CYGWIN__)
Index: khtml/khtml_part.cpp
===================================================================
--- khtml/khtml_part.cpp	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ khtml/khtml_part.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -1595,7 +1595,6 @@
 
     d->m_pageServices = d->m_job->queryMetaData("PageServices");
     d->m_pageReferrer = d->m_job->queryMetaData("referrer");
-
     d->m_bSecurityInQuestion = false;
     d->m_ssl_in_use = (d->m_job->queryMetaData("ssl_in_use") == "TRUE");
 
@@ -1638,6 +1637,7 @@
     if ( !qData.isEmpty() && !d->m_haveEncoding ) // only use information if the user didn't override the settings
        d->m_encoding = qData;
 
+
     // Support for http-refresh
     qData = d->m_job->queryMetaData("http-refresh");
     if( !qData.isEmpty())
@@ -1651,6 +1651,11 @@
       d->m_doc->setBaseURL(KURL( d->m_doc->completeURL(baseURL) ));
     */
 
+    // Support for Content-Language
+    QString language = d->m_job->queryMetaData("content-language");
+    if (!language.isEmpty())
+        d->m_doc->setContentLanguage(language);
+
     if ( !m_url.isLocalFile() ) {
         // Support for http last-modified
         d->m_lastModified = d->m_job->queryMetaData("modified");
@@ -3966,10 +3971,10 @@
     return true;
   }
 
-  //If we're asked to open up an anchor in the current URL, in current window, 
-  //merely gotoanchor, and do not reload the new page. Note that this does 
+  //If we're asked to open up an anchor in the current URL, in current window,
+  //merely gotoanchor, and do not reload the new page. Note that this does
   //not apply if the URL is the same page, but without a ref
-  if (cURL.hasRef() && (!hasTarget || target == "_self")) 
+  if (cURL.hasRef() && (!hasTarget || target == "_self"))
   {
     KURL curUrl = this->url();
     if (urlcmp(cURL.url(), curUrl.url(),
@@ -3977,7 +3982,7 @@
               true))  // don't care if the ref changes!
     {
       m_url = cURL;
-      emit d->m_extension->openURLNotify();      
+      emit d->m_extension->openURLNotify();
       if ( !gotoAnchor( m_url.encodedHtmlRef()) )
         gotoAnchor( m_url.htmlRef() );
       emit d->m_extension->setLocationBarURL( m_url.prettyURL() );
@@ -5956,9 +5961,9 @@
         if (n->isText()) {
             khtml::RenderText* const textRenderer = static_cast<khtml::RenderText *>(n);
             const khtml::InlineTextBoxArray &runs = textRenderer->inlineTextBoxes();
-	    const unsigned lim = runs.count();
+            const unsigned lim = runs.count();
             for (unsigned i = 0; i != lim; ++i) {
-                if (runs[i]->m_y == y) {
+                if (runs[i]->m_y == y && textRenderer->element()) {
                     startNode = textRenderer->element();
                     startOffset = runs[i]->m_start;
                     return true;
@@ -5999,7 +6004,7 @@
             khtml::RenderText* const textRenderer =  static_cast<khtml::RenderText *>(n);
             const khtml::InlineTextBoxArray &runs = textRenderer->inlineTextBoxes();
             for (int i = (int)runs.count()-1; i >= 0; --i) {
-                if (runs[i]->m_y == y) {
+                if (runs[i]->m_y == y && textRenderer->element()) {
                     endNode = textRenderer->element();
                     endOffset = runs[i]->m_start + runs[i]->m_len;
                     return true;
Index: khtml/html/htmltokenizer.cpp
===================================================================
--- khtml/html/htmltokenizer.cpp	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ khtml/html/htmltokenizer.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -7,7 +7,8 @@
               (C) 1999 Lars Knoll (knoll@kde.org)
               (C) 1999 Antti Koivisto (koivisto@kde.org)
               (C) 2001-2003 Dirk Mueller (mueller@kde.org)
-              (C) 2002 Apple Computer, Inc.
+              (C) 2004 Apple Computer, Inc.
+              (C) 2006 Germain Garand (germain@ebooksfrance.org)
 
     This library is free software; you can redistribute it and/or
     modify it under the terms of the GNU Library General Public
@@ -90,38 +91,36 @@
 #define fixUpChar(x) \
             switch ((x).unicode()) \
             { \
-            /* ALL of these should be changed to Unicode SOON */ \
             case 0x80: (x) = 0x20ac; break; \
-            case 0x82: (x) = ',';    break; \
+            case 0x82: (x) = 0x201a;    break; \
             case 0x83: (x) = 0x0192; break; \
-            case 0x84: (x) = '"';    break; \
+            case 0x84: (x) = 0x201e;    break; \
             case 0x85: (x) = 0x2026; break; \
             case 0x86: (x) = 0x2020; break; \
             case 0x87: (x) = 0x2021; break; \
             case 0x88: (x) = 0x02C6; break; \
             case 0x89: (x) = 0x2030; break; \
             case 0x8A: (x) = 0x0160; break; \
-            case 0x8b: (x) = '<';    break; \
+            case 0x8b: (x) = 0x2039;    break; \
             case 0x8C: (x) = 0x0152; break; \
             case 0x8E: (x) = 0x017D; break; \
-            case 0x91: (x) = '\'';   break; \
-            case 0x92: (x) = '\'';   break; \
-            case 0x93: (x) = '"';    break; \
-            case 0x94: (x) = '"';    break; \
-            case 0x95: (x) = '*';    break; \
-            case 0x96: (x) = '-';    break; \
-            case 0x97: (x) = '-';    break; \
-            case 0x98: (x) = '~';    break; \
+            case 0x91: (x) = 0x2018;   break; \
+            case 0x92: (x) = 0x2019;   break; \
+            case 0x93: (x) = 0x201C;    break; \
+            case 0x94: (x) = 0X201D;    break; \
+            case 0x95: (x) = 0x2022;    break; \
+            case 0x96: (x) = 0x2013;    break; \
+            case 0x97: (x) = 0x2014;    break; \
+            case 0x98: (x) = 0x02DC;    break; \
             case 0x99: (x) = 0x2122; break; \
             case 0x9A: (x) = 0x0161; break; \
-            case 0x9b: (x) = '>';    break; \
+            case 0x9b: (x) = 0x203A;    break; \
             case 0x9C: (x) = 0x0153; break; \
             case 0x9E: (x) = 0x017E; break; \
             case 0x9F: (x) = 0x0178; break; \
             default: break; \
             }
 #endif
-
 // ----------------------------------------------------------------------------
 
 HTMLTokenizer::HTMLTokenizer(DOM::DocumentPtr *_doc, KHTMLView *_view)
@@ -387,27 +386,30 @@
     currToken.tid = ID_SCRIPT + ID_CLOSE_TAG;
     processToken();
 
-    TokenizerString prependingSrc;
+    // Scripts following a frameset element should not be executed or even loaded in the case of extern scripts.
+    bool followingFrameset = (parser->doc()->body() && parser->doc()->body()->id() == ID_FRAMESET);
+    bool deferredScript = false;
 
-    if ( !parser->skipMode() ) {
+    if ( !parser->skipMode() && !followingFrameset) {
         CachedScript* cs = 0;
 
         // forget what we just got, load from src url instead
         if ( !currentScriptSrc.isEmpty() &&
-             (cs = parser->doc()->docLoader()->requestScript(currentScriptSrc, scriptSrcCharset) ))
+             (cs = parser->doc()->docLoader()->requestScript(currentScriptSrc, scriptSrcCharset) )) {
             cachedScript.enqueue(cs);
+        }
 
         if (cs) {
-            pendingSrc.prepend(src);
+            pendingQueue.push(src);
+            uint scriptCount = cachedScript.count();
             setSrc(TokenizerString());
             scriptCodeSize = scriptCodeResync = 0;
             cs->ref(this);
+            if (cachedScript.count() == scriptCount)
+                deferredScript = true;
         }
         else if (currentScriptSrc.isEmpty() && view && javascript ) {
-            if ( !m_executingScript )
-                pendingSrc.prepend(src);
-            else
-                prependingSrc = src;
+            pendingQueue.push(src);
             setSrc(TokenizerString());
             scriptCodeSize = scriptCodeResync = 0;
             scriptExecution( exScript, QString::null, tagStartLineno /*scriptStartLineno*/ );
@@ -417,12 +419,17 @@
     script = false;
     scriptCodeSize = scriptCodeResync = 0;
 
+    if (parser->skipMode() || followingFrameset)
+        return;
+
     if ( !m_executingScript && cachedScript.isEmpty() ) {
-        // kdDebug( 6036 ) << "adding pending Output to parsed string" << endl;
-        src.append(pendingSrc);
-        pendingSrc.clear();
-    } else if ( !prependingSrc.isEmpty() )
-        write( prependingSrc, false );
+        src.append(pendingQueue.pop());
+    } else if ( cachedScript.isEmpty() ) {
+        write( pendingQueue.pop(), false );
+    } else if ( !deferredScript && pendingQueue.count() > 1) {
+       TokenizerString t = pendingQueue.pop();
+       pendingQueue.top().prepend( t );
+    }
 }
 
 void HTMLTokenizer::scriptExecution( const QString& str, const QString& scriptURL,
@@ -1294,10 +1301,14 @@
     if ( !buffer )
         return;
 
-    if ( ( m_executingScript && appendData ) ||
-         ( !m_executingScript && cachedScript.count() ) ) {
+    if ( ( m_executingScript && appendData ) || cachedScript.count() ) {
         // don't parse; we will do this later
-        pendingSrc.append(str);
+        if (pendingQueue.isEmpty())
+            pendingQueue.push(str);
+        else if (appendData)
+            pendingQueue.bottom().append(str);
+        else
+            pendingQueue.top().append(str);
         return;
     }
 
@@ -1705,9 +1716,9 @@
     assert(!cachedScript.isEmpty());
     bool done = false;
     while (!done && cachedScript.head()->isLoaded()) {
-#ifdef TOKEN_DEBUG
+
         kdDebug( 6036 ) << "Finished loading an external script" << endl;
-#endif
+
         CachedScript* cs = cachedScript.dequeue();
         DOMString scriptSource = cs->script();
 #ifdef TOKEN_DEBUG
@@ -1725,12 +1736,16 @@
         done = cachedScript.isEmpty();
 
         // 'script' is true when we are called synchronously from
-        // parseScript(). In that case parseScript() will take care
+        // scriptHandler(). In that case scriptHandler() will take care
         // of 'scriptOutput'.
         if ( !script ) {
-            TokenizerString rest = pendingSrc;
-            pendingSrc.clear();
-            write(rest, false);
+            if (pendingQueue.count() > 1) {
+               TokenizerString t = pendingQueue.pop();
+               pendingQueue.top().prepend( t );
+            }
+            if (done) {
+                write(pendingQueue.pop(), false);
+            }
             // we might be deleted at this point, do not
             // access any members.
         }
Index: khtml/html/html_formimpl.cpp
===================================================================
--- khtml/html/html_formimpl.cpp	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ khtml/html/html_formimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -630,7 +630,9 @@
                     // otherwise we might have a potential security problem
                     // by saving passwords under wrong lookup key.
 
-                    getDocument()->view()->part()->saveToWallet(key, m_walletMap);
+                    if (view->part()) {
+                        view->part()->saveToWallet(key, m_walletMap);
+                    }
                 } else if ( savePassword == KDialogBase::No ) {
                     view->addNonPasswordStorableSite(formUrl.host());
                 }
Index: khtml/html/htmltokenizer.h
===================================================================
--- khtml/html/htmltokenizer.h	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ khtml/html/htmltokenizer.h	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -317,7 +317,7 @@
     QString scriptSrcCharset;
     bool javascript;
     // the HTML code we will parse after the external script we are waiting for has loaded
-    TokenizerString pendingSrc;
+    TokenizerQueue pendingQueue;
     // true if we are executing a script while parsing a document. This causes the parsing of
     // the output of the script to be postponed until after the script has finished executing
     int m_executingScript;
Index: khtml/kjserrordlg.ui
===================================================================
--- khtml/kjserrordlg.ui	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ khtml/kjserrordlg.ui	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -86,7 +86,7 @@
                 <enum>RichText</enum>
             </property>
         </widget>
-        <widget class="KActiveLabel" row="0" column="0" rowspan="1" colspan="3">
+        <widget class="KSqueezedTextLabel" row="0" column="0" rowspan="1" colspan="3">
             <property name="name">
                 <cstring>_url</cstring>
             </property>
@@ -117,7 +117,7 @@
 </tabstops>
 <includes>
     <include location="global" impldecl="in declaration">kdialog.h</include>
-    <include location="global" impldecl="in declaration">kactivelabel.h</include>
+    <include location="global" impldecl="in declaration">ksqueezedtextlabel.h</include>
 </includes>
 <slots>
     <slot>init()</slot>
Index: khtml/rendering/render_object.cpp
===================================================================
--- khtml/rendering/render_object.cpp	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ khtml/rendering/render_object.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -2109,19 +2109,21 @@
                 n = n->previousSibling();
             }
             if (sibling->isReset())
+            {
                 if (last != sibling)
                     sibling->insertAfter(i, last);
                 else
                     sibling->insertAfter(i, 0);
-            else
+            }
+            else if (last->parent())
                 last->parent()->insertAfter(i, last);
         }
-        else {
+        else if (parent()) {
             // Nothing found among siblings, let our parent search
             last = parent()->getCounter(counter, false);
             if (last->isReset())
                 last->insertAfter(i, 0);
-            else
+            else if (last->parent())
                 last->parent()->insertAfter(i, last);
         }
     }
Index: khtml/rendering/render_text.cpp
===================================================================
--- khtml/rendering/render_text.cpp	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ khtml/rendering/render_text.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -307,12 +307,12 @@
     }
     if ( _x > _tx + m_x + m_width ) {
 	// to the right
-	return m_reversed ? SelectionPointBeforeInLine : SelectionPointAfterInLine;
+	return  SelectionPointAfterInLine;
     }
 
     // The Y matches, check if we're on the left
     if ( _x < _tx + m_x ) {
-        return m_reversed ? SelectionPointAfterInLine : SelectionPointBeforeInLine;
+        return SelectionPointBeforeInLine;
     }
 
     // consider spacing for justified text
Index: khtml/rendering/render_box.cpp
===================================================================
--- khtml/rendering/render_box.cpp	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ khtml/rendering/render_box.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -687,16 +687,12 @@
         Q_ASSERT(p);
         while( p->isInline() && !p->isReplaced() )
             p = p->parent();
-        int off = 0;
-        if (!p->hasOverflowClip());
-            off = p->negativeOverflowWidth();
+        int off = p->hasOverflowClip() ? 0 : p->negativeOverflowWidth();
         p->repaintRectangle( -ow - off, -ow, p->effectiveWidth()+ow*2, p->effectiveHeight()+ow*2, immediate);
     }
     else
     {
-        int off = 0;
-        if (!hasOverflowClip());
-            off = negativeOverflowWidth();
+        int off = hasOverflowClip() ? 0 : negativeOverflowWidth();
         repaintRectangle( -ow - off, -ow, effectiveWidth()+ow*2, effectiveHeight()+ow*2, immediate);
     }
 }
Index: khtml/rendering/render_block.cpp
===================================================================
--- khtml/rendering/render_block.cpp	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ khtml/rendering/render_block.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -176,6 +176,11 @@
         firstLetter->setIsAnonymous( true );
         firstLetterContainer->addChild(firstLetter, firstLetterContainer->firstChild());
 
+        // if this object is the result of a :begin, then the text may have not been
+        // generated yet if it is a counter
+        if (textObj->recalcMinMax())
+            textObj->recalcMinMaxWidths();
+
         // The original string is going to be either a generated content string or a DOM node's
         // string.  We want the original string before it got transformed in case first-letter has
         // no text-transform or a different text-transform applied to it.
@@ -187,11 +192,13 @@
             oldText->ref();
             unsigned int length = 0;
             while ( length < oldText->l &&
-                    ( (oldText->s+length)->isSpace() || (oldText->s+length)->isPunct() ) )
+                    ( (oldText->s+length)->isSpace() || (oldText->s+length)->isPunct()) )
                 length++;
             if ( length < oldText->l && 
                     !( (oldText->s+length)->isSpace() || (oldText->s+length)->isPunct() ))
                 length++;
+            while ( length < oldText->l && (oldText->s+length)->isMark() )
+                length++;
             RenderTextFragment* remainingText =
                 new (renderArena()) RenderTextFragment(textObj->node(), oldText, length, oldText->l-length);
             remainingText->setIsAnonymous( textObj->isAnonymous() );
@@ -2244,8 +2251,10 @@
 
     int offset = m_y;
     if (parentHasFloats)
+    {
         addOverHangingFloats( static_cast<RenderBlock *>( parent() ),
                               parent()->borderLeft() + parent()->paddingLeft(), offset, false );
+    }
 
     int xoffset = 0;
     if (prev) {
@@ -2275,10 +2284,24 @@
     // Prevent floats from being added to the canvas by the root element, e.g., <html>.
     if ( !flow->m_floatingObjects || (child && flow->isRoot()) )
         return;
+        
+    // if I am clear of my floats, don't add them
+    // the CSS spec also mentions that child floats
+    // are not cleared.
+    if (!child && style()->clear() == CBOTH)
+    {
+        return;
+    }
 
     QPtrListIterator<FloatingObject> it(*flow->m_floatingObjects);
     FloatingObject *r;
     for ( ; (r = it.current()); ++it ) {
+    
+        if (!child && r->type == FloatingObject::FloatLeft && style()->clear() == CLEFT )
+            continue;
+        if (!child && r->type == FloatingObject::FloatRight && style()->clear() == CRIGHT )
+            continue;
+            
         if ( ( !child && r->endY > offset ) ||
              ( child && flow->yPos() + r->endY > height() ) ) {
             if (child && !r->crossedLayer) {
Index: khtml/ChangeLog
===================================================================
--- khtml/ChangeLog	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ khtml/ChangeLog	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -1,3 +1,12 @@
+2006-03-25  Germain Garand  <germain@ebooksfrance.org>
+
+        Scope: fix handling of nested/external scripts in the tokenizer (#91701) 
+
+        * misc/stringit.h (TokenizerQueue): a LIFO stack of TokenizerStrings
+        * html/htmltokenizer.{h,cpp} (scriptHandler/write/notifyFinished): use a TokenizerQueue to store
+        postponed fragments while executing/loading scripts.
+        (fixUpChar): unrelated - fill in missing unicode replacements.
+
 2006-03-20  Dirk Mueller <mueller@kde.org>
 
 	* misc/loader.cpp: fix pixmap leak in tiled_pixmap()
@@ -2,20 +11,27 @@
 
+2006-03-20  Allan Sandfeld Jensen <kde@carewolf.com>
+
+        Improve the CSS :lang() selector to match clarified specification
+
+        * khtml_part.cpp: parse HTTP content-language
+        * xml/dom_docimpl.cpp: parse HTTP-EQUIV content-language
+        * css/cssstyleselector.cpp: match :lang() against parents and ultimately the document
+
 2006-03-07  Germain Garand  <germain@ebooksfrance.org>
 
         Scope: relayout/repaint/widget masks fixes. Refine stacking context exploration. Optimise.
 
-        * khtmlview.cpp (reset/timerEvent): remove obsolete code checking validity of visible widgets list.
-        (drawContents): use widget geometry rather than the RenderWidget's rect (fixes widget borders not being updated)
+        * khtmlview.cpp (drawContents): use widget geometry rather than the RenderWidget's rect (fixes widget borders not being updated)
         Check if widget is in the dirty rect before doing any work.
 
         * rendering/render_block.cpp (layoutBlockChildren): I meant !child->isPositioned() here, not isPositioned(). No need to
-        dirty positioned children as this is handled by the containing block chain through layoutPositionedObjects 
+        dirty positioned children as this is handled by the containing block chain through layoutPositionedObjects
         (layoutPositionedObjects): always relayout fixed objects.
 
         * rendering/render_canvas.cpp (layout): check canvas dimensions and call layoutBlock directly with relayoutChildren boolean.
-        
-        * rendering/render_layer.{h,cpp} (paintedRegion): constrain our shape to the visibleRect. Use convertToLayerCoords to get a correct 
-        visibleFlowRegion (updateWidgetMasks): don't forget to update the mask if it reverts to none at all. 
 
-        * rendering/render_object.{h,cpp} (containingBlock): for relpos inlines, return the nearest block (skipping to next containingBlock gives 
+        * rendering/render_layer.{h,cpp} (paintedRegion): constrain our shape to the visibleRect. Use convertToLayerCoords to get a correct
+        visibleFlowRegion (updateWidgetMasks): don't forget to update the mask if it reverts to none at all.
+
+        * rendering/render_object.{h,cpp} (containingBlock): for relpos inlines, return the nearest block (skipping to next containingBlock gives
         stalled layout flags problems - #121653). (updateWidgetMasks): mask the content box, not the border box.
@@ -31,7 +47,7 @@
 	* link not accessable with negative text-indent (#96275)
 	* Wrong :hover effect with negative text-indent (#90510)
 	* text not selectable if it has a negative text-indent
-	
+
 2006-03-05  Charles Samuels  <charles@kde.org>
         * javascript timeouts that cross a midnight boundary shall not occur early
 
@@ -39,7 +55,7 @@
 
         get iframes, objects and some other overlaid widgets to obey their stacking context (#31121)
 
-        * khtmlview.cpp: mask widgets more precisely (i.e. allow layers to paint over overlaid widgets, 
+        * khtmlview.cpp: mask widgets more precisely (i.e. allow layers to paint over overlaid widgets,
         when they ought to).
 
         * rendering/render_canvas.{cpp,h}: update widget masks after pos child layout/positioning;
@@ -49,7 +65,7 @@
         childs. We'll apply that mask later to widgets that are under our aegis.
 
         * rendering/render_object.{cpp,h} (visibleFlowRegion): helper for calculation of broad region we want to mask in flows.
-        (updateWidgetMasks): walk our children looking for widgets suitable to masking. Apply our enclosingLayer's mask, 
+        (updateWidgetMasks): walk our children looking for widgets suitable to masking. Apply our enclosingLayer's mask,
         transformis transformandi.
 
         * rendering/render_replaced.cpp: overlaid widgets must advertise their existence to the enclosing layer.
@@ -64,22 +80,22 @@
         * css/css_ruleimpl.cpp (selectorText): handle of multiple, comma-separated selectors
 
 2006-02-28  Germain Garand  <germain@ebooksfrance.org>
-         
+
         Common-case style selection optimisation inspired from WebCore.
 
         * css/css_base.cpp/.h: add 'Class' to possible matching modes
         * css/cssstyleselector.cpp: treat 'Class' extra, not anymore as an ordinary List.
-        * css/parser.cpp/y: use 'Class' matching mode 
+        * css/parser.cpp/y: use 'Class' matching mode
         * html/html_elementimpl.cpp: when parsing ATTR_CLASS, set a boolean to remember if it is or not a class list.
         * xml/dom_elementimpl.{cpp,h}: add m_hasClassList boolean + setter/getter
 
 2006-02-28  Germain Garand  <germain@ebooksfrance.org>
 
         * rendering/render_object.cpp (dirtyFormattingContext): be more efficient with inlineflow objects.
-        * rendering/render_block.cpp (layoutBlockChildren): be more efficient with regard to positioned objects relayout. 
-        Merge WC margin-collapse regression fix (WC/#3508). 
+        * rendering/render_block.cpp (layoutBlockChildren): be more efficient with regard to positioned objects relayout.
+        Merge WC margin-collapse regression fix (WC/#3508).
         (layoutPositionedObjects) Objects with staticX() need a relayout too.
-        * rendering/render_canvas.cpp (layout): no need to relayout positioned objects here. This would mark entire branches of the tree 
+        * rendering/render_canvas.cpp (layout): no need to relayout positioned objects here. This would mark entire branches of the tree
         as needing a layout, thus stalling update requests in those branches (#116626)
 
 2006-01-14  Allan Sandfeld Jensen <kde@carewolf.com>
Index: khtml/css/cssstyleselector.h
===================================================================
--- khtml/css/cssstyleselector.h	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ khtml/css/cssstyleselector.h	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -126,7 +126,7 @@
         KDE_EXPORT static void clear();
         static void reparseConfiguration();
 
-	static void loadDefaultStyle(const KHTMLSettings *s = 0);
+	static void loadDefaultStyle(const KHTMLSettings *s, DOM::DocumentImpl *doc);
 
 	RenderStyle *styleForElement(DOM::ElementImpl *e);
 
@@ -184,7 +184,7 @@
 public:
 
     private:
-        void init(const KHTMLSettings* settings);
+        void init(const KHTMLSettings* settings, DOM::DocumentImpl* doc);
 
         void mapBackgroundAttachment(BackgroundLayer* layer, DOM::CSSValueImpl* value);
         void mapBackgroundImage(BackgroundLayer* layer, DOM::CSSValueImpl* value);
Index: khtml/css/cssstyleselector.cpp
===================================================================
--- khtml/css/cssstyleselector.cpp	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ khtml/css/cssstyleselector.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -191,7 +191,7 @@
 {
     KHTMLView* view = doc->view();
 
-    init(view ? view->part()->settings() : 0);
+    init(view ? view->part()->settings() : 0, doc);
 
     strictParsing = _strictParsing;
     m_medium = view ? view->mediaType() : QString("all");
@@ -249,7 +249,7 @@
 
 CSSStyleSelector::CSSStyleSelector( CSSStyleSheetImpl *sheet )
 {
-    init(0L);
+    init(0L, 0L);
 
     KHTMLView *view = sheet->doc()->view();
     m_medium = view ? view->mediaType() : "screen";
@@ -258,7 +258,7 @@
     authorStyle->append( sheet, m_medium );
 }
 
-void CSSStyleSelector::init(const KHTMLSettings* _settings)
+void CSSStyleSelector::init(const KHTMLSettings* _settings, DocumentImpl* doc)
 {
     element = 0;
     settings = _settings;
@@ -267,7 +267,7 @@
     pseudoProps = (CSSOrderedProperty **)malloc(128*sizeof(CSSOrderedProperty *));
     propsToApplySize = 128;
     pseudoPropsSize = 128;
-    if(!s_defaultStyle) loadDefaultStyle(settings);
+    if(!s_defaultStyle) loadDefaultStyle(settings, doc);
 
     defaultStyle = s_defaultStyle;
     defaultPrintStyle = s_defaultPrintStyle;
@@ -291,7 +291,7 @@
     authorStyle->append( sheet, m_medium );
 }
 
-void CSSStyleSelector::loadDefaultStyle(const KHTMLSettings *s)
+void CSSStyleSelector::loadDefaultStyle(const KHTMLSettings *s, DocumentImpl *doc)
 {
     if(s_defaultStyle) return;
 
@@ -310,7 +310,7 @@
 	    style += s->settingsToCSS();
 	DOMString str(style);
 
-	s_defaultSheet = new DOM::CSSStyleSheetImpl((DOM::CSSStyleSheetImpl * ) 0);
+	s_defaultSheet = new DOM::CSSStyleSheetImpl(doc);
 	s_defaultSheet->parseString( str );
 
 	// Collect only strict-mode rules.
@@ -333,7 +333,7 @@
 	QString style = QString::fromLatin1( file.data() );
 	DOMString str(style);
 
-	s_quirksSheet = new DOM::CSSStyleSheetImpl((DOM::CSSStyleSheetImpl * ) 0);
+	s_quirksSheet = new DOM::CSSStyleSheetImpl(doc);
 	s_quirksSheet->parseString( str );
 
 	// Collect only quirks-mode rules.
@@ -1076,7 +1076,7 @@
                     return false;
                return true;
             }
-            // no break    
+            // no break
         case CSSSelector::List:
         {
             if (sel->match != CSSSelector::Class) {
@@ -1408,7 +1408,20 @@
             break;
         case CSSSelector::PseudoLang: {
             DOMString value = e->getAttribute(ATTR_LANG);
-            if (value.isNull()) return false;
+            // The LANG attribute is inherited like a property
+            NodeImpl *n = e->parent();;
+            while (n && value.isEmpty()) {
+                if (n->isElementNode()) {
+                    // ### check xml:lang attribute in XML and XHTML documents
+                    value = static_cast<ElementImpl*>(n)->getAttribute(ATTR_LANG);
+                } else
+                if (n->isDocumentNode()) {
+                    value = static_cast<DocumentImpl*>(n)->contentLanguage();
+                }
+                n = n->parent();
+            }
+            if (value.isEmpty()) return false;
+
             QString langAttr = value.string();
             QString langSel = sel->string_arg.string();
 
Index: khtml/css/css_stylesheetimpl.cpp
===================================================================
--- khtml/css/css_stylesheetimpl.cpp	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ khtml/css/css_stylesheetimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -216,10 +216,13 @@
 
     m_namespaces = new CSSNamespace(prefix, uri, m_namespaces);
 
-    if (prefix.isEmpty())
+    if (prefix.isEmpty()) {
+        Q_ASSERT(m_doc != 0);
+
         // Set the default namespace on the parser so that selectors that omit namespace info will
         // be able to pick it up easily.
         p->defaultNamespace = m_doc->getId(NodeImpl::NamespaceId, uri.implementation(), false, false, &exceptioncode);
+    }
 }
 
 void CSSStyleSheetImpl::determineNamespace(Q_UINT32& id, const DOM::DOMString& prefix)
@@ -236,9 +239,12 @@
     else {
         int exceptioncode = 0;
         CSSNamespace* ns = m_namespaces->namespaceForPrefix(prefix);
-        if (ns)
+        if (ns) {
+            Q_ASSERT(m_doc != 0);
+
             // Look up the id for this namespace URI.
             id = makeId(m_doc->getId(NodeImpl::NamespaceId, ns->uri().implementation(), false, false, &exceptioncode), localNamePart(id));
+        }
     }
 }
 
Index: khtml/misc/stringit.h
===================================================================
--- khtml/misc/stringit.h	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ khtml/misc/stringit.h	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -113,6 +113,11 @@
     TokenizerString() : m_currentChar(0), m_lines(0), m_composite(false) {}
     TokenizerString(const QChar *str, int length) : m_currentString(str, length), m_currentChar(m_currentString.m_current), m_lines(0), m_composite(false) {}
     TokenizerString(const QString &str) : m_currentString(str), m_currentChar(m_currentString.m_current), m_lines(0), m_composite(false) {}
+    TokenizerString(const TokenizerString &o) : m_pushedChar1(o.m_pushedChar1), m_pushedChar2(o.m_pushedChar2),
+                                                m_currentString(o.m_currentString), m_substrings(o.m_substrings),
+                                                m_lines(o.m_lines), m_composite(o.m_composite) { 
+        m_currentChar = m_pushedChar1.isNull() ? m_currentString.m_current : &m_pushedChar1; 
+    } 
 
     void clear();
 
@@ -173,6 +178,25 @@
 
 };
 
+
+class TokenizerQueue : public QValueList<TokenizerString>
+{
+
+public:
+    TokenizerQueue() {}
+    ~TokenizerQueue() {}
+    void  push( const TokenizerString &t ) { prepend(t); }
+    TokenizerString pop() {
+        if (isEmpty()) 
+            return TokenizerString();
+        TokenizerString t(first());
+        remove( begin() );
+        return t;
+    }
+    TokenizerString& top() { return first(); }
+    TokenizerString& bottom() { return last(); }
+};
+
 }
 
 #endif
Index: khtml/khtmlview.h
===================================================================
--- khtml/khtmlview.h	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ khtml/khtmlview.h	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -171,6 +171,10 @@
 
 
 signals:
+    /**
+     * This signal is used for internal layouting. Don't use it to check if rendering finished.
+     * Use @ref KHTMLPart completed() signal instead.
+     */
     void finishedLayout();
     void cleared();
     void zoomView( int );
Index: khtml/xml/dom2_eventsimpl.cpp
===================================================================
--- khtml/xml/dom2_eventsimpl.cpp	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ khtml/xml/dom2_eventsimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -499,14 +499,14 @@
     }
 
     L toLeft(R r) {
-        typename QMap<R,L>::iterator i = m_rToL.find(r);
+        QMapIterator<R,L> i( m_rToL.find(r) );
         if (i != m_rToL.end())
             return *i;
         return L();
     }
 
     R toRight(L l) {
-        typename QMap<L,R>::iterator i = m_lToR.find(l);
+        QMapIterator<L,R> i = m_lToR.find(l);
         if (i != m_lToR.end())
             return *i;
         return R();
@@ -775,7 +775,7 @@
     if (keyIdentifierArg.length() == 1) {
         //Likely to be normal unicode id, unless it's one of the few
         //special values.
-        unsigned short code = keyIdentifierArg.unicode()[0].unicode();
+        unsigned short code = keyIdentifierArg.unicode()[0];
         if (code > 0x20 && code != 0x7F)
             keyVal = code;
     }
@@ -789,7 +789,7 @@
             modifiersList.string().stripWhiteSpace().simplifyWhiteSpace());
 
     unsigned modifiers = 0;
-    for (QStringList::iterator i = mods.begin(); i != mods.end(); ++i)
+    for (QStringList::Iterator i = mods.begin(); i != mods.end(); ++i)
         if (unsigned mask = keyModifiersToCode()->toRight((*i).latin1()))
             modifiers |= mask;
 
Index: khtml/xml/dom_docimpl.cpp
===================================================================
--- khtml/xml/dom_docimpl.cpp	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ khtml/xml/dom_docimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -173,7 +173,7 @@
     if (doc->doctype() && dtype)
         doc->doctype()->copyFrom(*dtype);
 
-    // the document must be created empty if all parameters are null 
+    // the document must be created empty if all parameters are null
     // (or empty for qName/nsURI as a tolerance) - see DOM 3 Core.
     if (dtype || !qualifiedName.isEmpty() || !namespaceURI.isEmpty()) {
         ElementImpl *element = doc->createElementNS(namespaceURI,qualifiedName);
@@ -610,7 +610,7 @@
 
     ElementMappingCache::ItemInfo* info = m_getElementByIdCache.get(stringKey);
 
-    if (!info) 
+    if (!info)
         return 0;
 
     //See if cache has an unambiguous answer.
@@ -1656,6 +1656,9 @@
         m_preferredStylesheetSet = content;
         updateStyleSelector();
     }
+    else if (strcasecmp(equiv, "content-language") == 0) {
+        m_contentLanguage = content.string();
+    }
 }
 
 bool DocumentImpl::prepareMouseEvent( bool readonly, int _x, int _y, MouseEvent *ev )
Index: khtml/xml/dom_docimpl.h
===================================================================
--- khtml/xml/dom_docimpl.h	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ khtml/xml/dom_docimpl.h	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -530,6 +530,9 @@
         return m_getElementByIdCache;
     }
 
+    QString contentLanguage() const { return m_contentLanguage; }
+    void setContentLanguage(const QString& cl) { m_contentLanguage = cl; }
+
 signals:
     void finishedParsing();
 
@@ -551,6 +554,8 @@
     QString m_printSheet;
     QStringList m_availableSheets;
 
+    QString m_contentLanguage;
+
     // Track the number of currently loading top-level stylesheets.  Sheets
     // loaded using the @import directive are not included in this count.
     // We use this count of pending sheets to detect when we can begin attaching
Index: pics/hicolor/index.theme
===================================================================
--- pics/hicolor/index.theme	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ pics/hicolor/index.theme	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -100,6 +100,7 @@
 Comment[uk]=Основна тема піктограм
 Comment[zh_CN]=默认图标主题
 Comment[zh_HK]=後備高彩圖示主題
+Inherits=kdeclassic,crystalsvg
 DisplayDepth=32
 Example=exec
 LinkOverlay=link
@@ -115,7 +116,7 @@
 SmallSizes=16
 PanelDefault=32
 PanelSizes=16,22,32,48
-Hidden=true
+Hidden=false
 Directories=192x192/apps,128x128/actions,128x128/apps,128x128/devices,128x128/filesystems,128x128/mimetypes,96x96/actions,96x96/apps,96x96/devices,96x96/filesystems,96x96/mimetypes,72x72/apps,64x64/actions,64x64/apps,64x64/devices,64x64/filesystems,64x64/mimetypes,48x48/actions,48x48/apps,48x48/devices,48x48/filesystems,48x48/mimetypes,36x36/apps,32x32/actions,32x32/apps,32x32/devices,32x32/filesystems,32x32/mimetypes,24x24/apps,22x22/actions,22x22/apps,22x22/devices,22x22/filesystems,22x22/mimetypes,16x16/actions,16x16/apps,16x16/devices,16x16/filesystems,16x16/mimetypes,scalable/actions,scalable/apps,scalable/devices,scalable/filesystems,scalable/mimetypes,16x16/stock/chart,16x16/stock/code,16x16/stock/data,16x16/stock/document,16x16/stock/form,16x16/stock/generic,16x16/stock/image,16x16/stock/io,16x16/stock/media,16x16/stock/navigation,16x16/stock/net,16x16/stock/object,16x16/stock/table,16x16/stock/text,24x24/stock/chart,24x24/stock/code,24x24/stock/data,24x24/stock/document,24x24/stock/form,24x24/stock/generic,24x24/stock/image,24x24/stock/io,24x24/stock/media,24x24/stock/navigation,24x24/stock/net,24x24/stock/object,24x24/stock/table,24x24/stock/text,32x32/stock/chart,32x32/stock/code,32x32/stock/data,32x32/stock/document,32x32/stock/form,32x32/stock/generic,32x32/stock/image,32x32/stock/io,32x32/stock/media,32x32/stock/navigation,32x32/stock/net,32x32/stock/object,32x32/stock/table,32x32/stock/text,36x36/stock/chart,36x36/stock/code,36x36/stock/data,36x36/stock/document,36x36/stock/form,36x36/stock/generic,36x36/stock/image,36x36/stock/io,36x36/stock/media,36x36/stock/navigation,36x36/stock/net,36x36/stock/object,36x36/stock/table,36x36/stock/text,48x48/stock/chart,48x48/stock/code,48x48/stock/data,48x48/stock/document,48x48/stock/form,48x48/stock/generic,48x48/stock/image,48x48/stock/io,48x48/stock/media,48x48/stock/navigation,48x48/stock/net,48x48/stock/object,48x48/stock/table,48x48/stock/text
 
 [16x16/actions]
Index: pics/crystalsvg/cr16-action-tab_new_bg.png
===================================================================
Cannot display: file marked as a binary type.
svn:mime-type = application/octet-stream

Property changes on: pics/crystalsvg/cr16-action-tab_new_bg.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Index: pics/crystalsvg/cr16-action-tab_remove.png
===================================================================
Cannot display: file marked as a binary type.
svn:mime-type = image/png
Index: pics/crystalsvg/cr16-action-tab_remove_other.png
===================================================================
Cannot display: file marked as a binary type.
svn:mime-type = application/octet-stream

Property changes on: pics/crystalsvg/cr16-action-tab_remove_other.png
___________________________________________________________________
Name: svn:mime-type
   + application/octet-stream

Index: pics/crystalsvg/cr16-action-tab_new.png
===================================================================
Cannot display: file marked as a binary type.
svn:mime-type = image/png
Index: kdoctools/customization/da/lang.entities
===================================================================
--- kdoctools/customization/da/lang.entities	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kdoctools/customization/da/lang.entities	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -12,6 +12,8 @@
 <!-- Licence links -->
 <!ENTITY underGPL           PUBLIC "-//KDE//DOCUMENT GPL Licence Declaration//DA"
   "entities/underGPL.docbook"                       ><!-- level: para -->
+<!ENTITY underLGPL          PUBLIC "-//KDE//DOCUMENT LGPL Licence Declaration//DA"
+  "entities/underLGPL.docbook"                       ><!-- level: para -->
 <!ENTITY underFDL           PUBLIC "-//KDE//DOCUMENT FDL Licence Declaration//DA"
   "entities/underFDL.docbook"                       ><!-- level: para -->
 <!ENTITY underBSDLicense    PUBLIC "-//KDE//DOCUMENT BSD Licence Declaration//DA"
Index: kdoctools/customization/da/catalog
===================================================================
--- kdoctools/customization/da/catalog	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kdoctools/customization/da/catalog	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -16,6 +16,8 @@
        "common/fdl-translated"
 PUBLIC "-//KDE//DOCUMENT GPL Licence Declaration//DA"
        "entities/underGPL.docbook" 
+PUBLIC "-//KDE//DOCUMENT LGPL Licence Declaration//DA"
+       "entities/underLGPL.docbook"
 PUBLIC "-//KDE//DOCUMENT FDL Licence Declaration//DA"
        "entities/underFDL.docbook"
 PUBLIC "-//KDE//DOCUMENT BSD Licence Declaration//DA"
Index: kdoctools/customization/ca/user.entities
===================================================================
--- kdoctools/customization/ca/user.entities	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kdoctools/customization/ca/user.entities	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -29,8 +29,17 @@
 <!ENTITY kmenu	"Menú <guimenu>K</guimenu>">
 <!ENTITY BER	"botó <mousebutton>esquerra</mousebutton> del ratolí"><!-- English: &LMB; -->
 <!ENTITY BMR	"botó <mousebutton>mig</mousebutton> del ratolí"><!-- English: &MMB; -->
-<!ENTITY SO	"sistema operatiu"><!-- English: &OS; -->
+<!ENTITY SO		"sistema operatiu"><!-- English: &OS; -->
 <!ENTITY BDR	"botó <mousebutton>dret</mousebutton> del ratolí"><!-- English: &RMB; -->
 <!ENTITY Maj	"<keycap>Majús.</keycap>"><!-- English: &Shift; -->
 <!ENTITY safatasistema	"<application>safata del sistema</application>"><!-- English: &systemtray; -->
 <!ENTITY Tab	"<keycap>Tabulador</keycap>">
+
+<!-- ROLES OF TRANSLATORS -->
+<!ENTITY traductor.Antoni.Bella		'<othercredit role="translator"><firstname>Antoni</firstname><surname>Bella</surname><affiliation><address><email>bella5@teleline.es</email></address></affiliation><contrib>Traductor</contrib></othercredit>'>
+<!ENTITY revisor.Antoni.Bella		'<othercredit role="reviewer"><firstname>Antoni</firstname><surname>Bella</surname><affiliation><address><email>bella5@teleline.es</email></address></affiliation><contrib>Revisor</contrib></othercredit>'>
+
+<!-- CREDITS FOR TRANSLATORS -->
+<!-- Seguir el següent format '<para>Traductor/Revisor de la documentació: &credits.Nom.Cognom;</para>' -->
+<!ENTITY credits.Antoni.Bella		'Antoni Bella <email>bella5@teleline.es</email>'>
+
Index: kdoctools/customization/it/entities/underLGPL.docbook
===================================================================
--- kdoctools/customization/it/entities/underLGPL.docbook	(.../tags/KDE/3.5.2/kdelibs)	(revision 0)
+++ kdoctools/customization/it/entities/underLGPL.docbook	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -0,0 +1,2 @@
+<para>Questo programma è concesso in licenza sotto i termini della <ulink
+url="common/gpl-license.html">GNU Lesser General Public License</ulink>.</para>
\ No newline at end of file
Index: kdoctools/customization/it/lang.entities
===================================================================
--- kdoctools/customization/it/lang.entities	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kdoctools/customization/it/lang.entities	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -12,6 +12,8 @@
 <!-- Licence links -->
 <!ENTITY underGPL           PUBLIC "-//KDE//DOCUMENT GPL Licence Declaration//IT"
   "entities/underGPL.docbook"                       ><!-- level: para -->
+<!ENTITY underLGPL           PUBLIC "-//KDE//DOCUMENT LGPL Licence Declaration//IT"
+  "entities/underLGPL.docbook"                       ><!-- level: para -->
 <!ENTITY underFDL           PUBLIC "-//KDE//DOCUMENT FDL Licence Declaration//IT"
   "entities/underFDL.docbook"                       ><!-- level: para -->
 <!ENTITY underBSDLicense    PUBLIC "-//KDE//DOCUMENT BSD Licence Declaration//IT"
Index: kdoctools/customization/it/catalog
===================================================================
--- kdoctools/customization/it/catalog	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kdoctools/customization/it/catalog	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -16,6 +16,8 @@
        "common/fdl-translated"
 PUBLIC "-//KDE//DOCUMENT GPL Licence Declaration//IT"
        "entities/underGPL.docbook" 
+PUBLIC "-//KDE//DOCUMENT LGPL Licence Declaration//IT"
+       "entities/underLGPL.docbook" 
 PUBLIC "-//KDE//DOCUMENT FDL Licence Declaration//IT"
        "entities/underFDL.docbook"
 PUBLIC "-//KDE//DOCUMENT BSD Licence Declaration//IT"
Index: kded/khostname.cpp
===================================================================
--- kded/khostname.cpp	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kded/khostname.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -155,7 +155,11 @@
          continue;
 
       QCString newNetId = newName+netId.mid(i);
+      QCString oldNetId = netId.left(i);
 
+      if(oldNetId != oldName)
+         continue;
+
       cmd = "xauth remove "+KProcess::quote(netId);
       system(QFile::encodeName(cmd));
       cmd = "xauth add ";
Index: kdeprint/filters/enscript.desktop
===================================================================
--- kdeprint/filters/enscript.desktop	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kdeprint/filters/enscript.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -23,7 +23,7 @@
 Comment[bn]=enscript টেক্সট ফিল্টার
 Comment[br]=Sil skrid Enscript
 Comment[bs]=Enscript tekst filter
-Comment[ca]=Filtre de texts enscript
+Comment[ca]=Filtre de text enscript
 Comment[cs]=Textový filtr Enscript
 Comment[cy]=Hidl Testun Enscript
 Comment[da]=Enscript-tekstfilter
Index: kdeprint/ext/ext.print
===================================================================
--- kdeprint/ext/ext.print	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kdeprint/ext/ext.print	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -6,7 +6,7 @@
 Comment[az]=Xarici Proqram Vasitəsilə Çap Et (ümumi)
 Comment[bn]=বহিঃস্থ প্রোগ্রামের (generic) সাহায্যে ছাপানো হোক
 Comment[bs]=Štampajte pomoću eksternog programa (generic)
-Comment[ca]=Imprimeix mitjançant un programa extern (genèric)
+Comment[ca]=Impressió mitjançant un programa extern (genèric)
 Comment[cs]=Tisk pomocí externího programu (obecné)
 Comment[cy]=Argraffu drwy Raglen Allanol (cyffredinol)
 Comment[da]=Udskriv gennem et eksternt program (generisk)
Index: configure.in.in
===================================================================
--- configure.in.in	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ configure.in.in	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -162,7 +162,7 @@
 AC_CHECK_MKSTEMPS
 AC_CHECK_MKSTEMP
 AC_CHECK_MKDTEMP
-AC_CHECK_FUNCS(strtoll socket seteuid setegid strfmon stpcpy gettimeofday readdir_r setpriority)
+AC_CHECK_FUNCS(strtoll socket seteuid setegid strfmon stpcpy gettimeofday readdir_r setpriority statvfs statfs)
 
 AH_BOTTOM([
 /* provide a definition for a 32 bit entity, usable as a typedef, possibly
@@ -306,7 +306,10 @@
    CXXFLAGS="$CXXFLAGS $USE_RTTI"
 fi
 
-rgb_file="$x_libraries/X11/rgb.txt"
+AC_ARG_WITH([rgbfile],
+  AC_HELP_STRING([--with-rgbfile=path], [Define custom path for rgb.txt. (default: \$(x11libdir)/X11/rgb.txt)]),
+  [rgb_file=$withval], [rgb_file="$x_libraries/X11/rgb.txt"])
+
 AC_DEFINE_UNQUOTED(X11_RGBFILE, "$rgb_file", [where rgb.txt is in])
 
 AC_MSG_CHECKING([for Compiler version])
Index: kdeui/kprogress.cpp
===================================================================
--- kdeui/kprogress.cpp	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kdeui/kprogress.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -216,7 +216,6 @@
 
     show();
     kapp->processEvents();
-    mShown = true;
 }
 
 void KProgressDialog::slotCancel()
@@ -394,6 +393,13 @@
     }
 }
 
+void KProgressDialog::show()
+{
+    KDialogBase::show();
+    mShown = true;
+}
+
+
 void KProgress::virtual_hook( int, void* )
 { /*BASE::virtual_hook( id, data );*/ }
 
Index: kdeui/kmessagebox.cpp
===================================================================
--- kdeui/kmessagebox.cpp	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kdeui/kmessagebox.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -82,7 +82,7 @@
         break;
     }
 
-   QPixmap ret = KApplication::kApplication()->iconLoader()->loadIcon(icon_name, KIcon::NoGroup, KIcon::SizeMedium, KIcon::DefaultState, 0, true);
+   QPixmap ret = KGlobal::iconLoader()->loadIcon(icon_name, KIcon::NoGroup, KIcon::SizeMedium, KIcon::DefaultState, 0, true);
 
    if (ret.isNull())
        return QMessageBox::standardIcon(icon);
Index: kdeui/kprogress.h
===================================================================
--- kdeui/kprogress.h	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ kdeui/kprogress.h	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -361,6 +361,11 @@
          */
         int  minimumDuration() const;
 
+ 	/**
+	 * Reimplemented for internal reasons, the API is not affected.
+	 */
+        virtual void show();
+
     protected slots:
         void slotAutoShow();
         void slotAutoActions(int percentage);
Index: libkmid/sndcard.h
===================================================================
--- libkmid/sndcard.h	(.../tags/KDE/3.5.2/kdelibs)	(revision 526003)
+++ libkmid/sndcard.h	(.../branches/KDE/3.5/kdelibs)	(revision 526003)
@@ -31,9 +31,12 @@
  
 #ifdef HAVE_SYS_SOUNDCARD_H
  #include <sys/soundcard.h>
- #define HAVE_OSS_SUPPORT
 #elif defined(HAVE_MACHINE_SOUNDCARD_H)
  #include <machine/soundcard.h>
+#endif
+
+/* Check for OSS MIDI API */
+#if defined(SNDCTL_SEQ_NRSYNTHS) && defined(CTL_MAIN_VOLUME)
  #define HAVE_OSS_SUPPORT
 #else
  #undef HAVE_OSS_SUPPORT

Property changes on: .
___________________________________________________________________
Name: svn:externals
   + admin https://svn.kde.org/home/kde/branches/KDE/3.5/kde-common/admin


