Index: interfaces/kspeech/kspeech.h
===================================================================
--- interfaces/kspeech/kspeech.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ interfaces/kspeech/kspeech.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -371,10 +371,11 @@
  *
  * A Talker Code consists of a series of XML tags and attributes.
  * An example of a full Talker Code with all attributes specified is
- *
+ * \code
  *   <voice lang="en" name="kal" gender="male"/>
  *   <prosody volume="soft" rate="fast"/>
  *   <kttsd synthesizer="Festival" />
+ * \endcode
  *
  * (The @e voice and @e prosody tags are adapted from the W3C Speech Synthesis
  * Markup Language (SSML) and Java Speech Markup Language (JSML).
Index: interfaces/kmediaplayer/kfileaudiopreview/kfileaudiopreview.cpp
===================================================================
--- interfaces/kmediaplayer/kfileaudiopreview/kfileaudiopreview.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ interfaces/kmediaplayer/kfileaudiopreview/kfileaudiopreview.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -21,8 +21,10 @@
 {
 protected:
     virtual QObject *createObject( QObject *parent, const char *name,
-                           const char *, const QStringList & )
+                           const char *className, const QStringList & args)
     {
+        Q_UNUSED(className);
+        Q_UNUSED(args);
         return new KFileAudioPreview( dynamic_cast<QWidget*>( parent ), name );
     }
 };
Index: kmdi/kmdi/mainwindow.h
===================================================================
--- kmdi/kmdi/mainwindow.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kmdi/kmdi/mainwindow.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -107,6 +107,10 @@
      * as toplevel and stay-on-top on the application's main widget.
      * @param pWnd widget for the toolview
      * @param pos docking position
+     * @param pTargetWnd
+     * @param percent
+     * @param tabToolTip
+     * @param tabCaption
      * @return created toolview
      */
     KMDI::ToolViewAccessor *addToolWindow( QWidget* pWnd, KDockWidget::DockPosition pos = KDockWidget::DockNone, QWidget* pTargetWnd = 0L, int percent = 50, const QString& tabToolTip = 0, const QString& tabCaption = 0);
Index: kmdi/kmdi/dockcontainer.h
===================================================================
--- kmdi/kmdi/dockcontainer.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kmdi/kmdi/dockcontainer.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -50,7 +50,7 @@
     /**
      * Add a widget to this container.
      * \param w the KDockWidget object to add
-     * \TODO Remove the extra parameters that we don't use?
+     * \todo Remove the extra parameters that we don't use?
      */
     virtual void insertWidget (KDockWidget *w, QPixmap, const QString &, int &);
 
@@ -63,7 +63,7 @@
     /**
      * Set a tooltip for a widget
      *
-     * \TODO Actually implement it? Right now, it looks just it
+     * \todo Actually implement it? Right now, it looks just it
      * does exactly nothing
      */
     virtual void setToolTip (KDockWidget *, QString &);
Index: kate/plugins/autobookmarker/autobookmarker.cpp
===================================================================
--- kate/plugins/autobookmarker/autobookmarker.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kate/plugins/autobookmarker/autobookmarker.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -364,12 +364,12 @@
 {
   QString text = i18n("Select the MimeTypes for this pattern.\nPlease note that this will automatically edit the associated file extensions as well.");
   QStringList list = QStringList::split( QRegExp("\\s*;\\s*"), leMimeTypes->text() );
-  KMimeTypeChooserDialog *d = new KMimeTypeChooserDialog( i18n("Select Mime Types"), text, list, "text", this );
-  if ( d->exec() == KDialogBase::Accepted ) {
+  KMimeTypeChooserDialog d( i18n("Select Mime Types"), text, list, "text", this );
+  if ( d.exec() == KDialogBase::Accepted ) {
     // do some checking, warn user if mime types or patterns are removed.
     // if the lists are empty, and the fields not, warn.
-    leFileMask->setText(d->chooser()->patterns().join("; "));
-    leMimeTypes->setText(d->chooser()->mimeTypes().join("; "));
+    leFileMask->setText(d.chooser()->patterns().join("; "));
+    leMimeTypes->setText(d.chooser()->mimeTypes().join("; "));
   }
 }
 //END
Index: kate/part/katecodecompletion.cpp
===================================================================
--- kate/part/katecodecompletion.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kate/part/katecodecompletion.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -56,7 +56,6 @@
   public:
     /**
       @short Create a new CCListBox
-      @param view The KateView, CCListBox is displayed in
     */
     KateCCListBox (QWidget* parent = 0, const char* name = 0, WFlags f = 0):QListBox(parent, name, f)
     {
Index: kate/part/katefactory.h
===================================================================
--- kate/part/katefactory.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kate/part/katefactory.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -75,6 +75,7 @@
      * @param widgetName widget name
      * @param parent QObject parent
      * @param name object name
+     * @param classname class parent
      * @param args additional arguments
      * @return constructed part object
      */
Index: kate/part/katefiletype.cpp
===================================================================
--- kate/part/katefiletype.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kate/part/katefiletype.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -503,12 +503,12 @@
 
   QString text = i18n("Select the MimeTypes you want for this file type.\nPlease note that this will automatically edit the associated file extensions as well.");
   QStringList list = QStringList::split( QRegExp("\\s*;\\s*"), mimetypes->text() );
-  KMimeTypeChooserDialog *d = new KMimeTypeChooserDialog( i18n("Select Mime Types"), text, list, "text", this );
-  if ( d->exec() == KDialogBase::Accepted ) {
+  KMimeTypeChooserDialog d( i18n("Select Mime Types"), text, list, "text", this );
+  if ( d.exec() == KDialogBase::Accepted ) {
     // do some checking, warn user if mime types or patterns are removed.
     // if the lists are empty, and the fields not, warn.
-    wildcards->setText( d->chooser()->patterns().join(";") );
-    mimetypes->setText( d->chooser()->mimeTypes().join(";") );
+    wildcards->setText( d.chooser()->patterns().join(";") );
+    mimetypes->setText( d.chooser()->mimeTypes().join(";") );
   }
 }
 //END KateFileTypeConfigTab
Index: kate/part/katejscript.cpp
===================================================================
--- kate/part/katejscript.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kate/part/katejscript.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -360,7 +360,7 @@
 
 const KJS::ClassInfo KateJSDocument::info = { "KateJSDocument", 0, 0, 0 };
 
-Value KateJSDocumentProtoFunc::call(KJS::ExecState *exec, KJS::Object &thisObj, const KJS::List &args)
+KJS::Value KJS::KateJSDocumentProtoFunc::call(KJS::ExecState *exec, KJS::Object &thisObj, const KJS::List &args)
 {
   KJS_CHECK_THIS( KateJSDocument, thisObj );
 
@@ -523,7 +523,7 @@
 
 const KJS::ClassInfo KateJSView::info = { "KateJSView", 0, &KateJSViewTable, 0 };
 
-Value KateJSViewProtoFunc::call(KJS::ExecState *exec, KJS::Object &thisObj, const KJS::List &args)
+KJS::Value KJS::KateJSViewProtoFunc::call(KJS::ExecState *exec, KJS::Object &thisObj, const KJS::List &args)
 {
   KJS_CHECK_THIS( KateJSView, thisObj );
 
@@ -834,7 +834,7 @@
 
 const KJS::ClassInfo KateJSIndenter::info = { "KateJSIndenter", 0, &KateJSIndenterTable, 0 };
 
-Value KateJSIndenterProtoFunc::call(KJS::ExecState *exec, KJS::Object &thisObj, const KJS::List &args)
+KJS::Value KJS::KateJSIndenterProtoFunc::call(KJS::ExecState *exec, KJS::Object &thisObj, const KJS::List &args)
 {
   KJS_CHECK_THIS( KateJSIndenter, thisObj );
 
Index: kate/part/kateview.h
===================================================================
--- kate/part/kateview.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kate/part/kateview.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -286,8 +286,8 @@
         { return getDoc()->textLine( cursorLine() ); }
     QString currentWord()
         { return m_doc->getWord( m_viewInternal->getCursor() ); }
-    void insertText( const QString& text )
-        { getDoc()->insertText( cursorLine(), cursorColumnReal(), text ); }
+    void insertText( const QString& mark )
+        { getDoc()->insertText( cursorLine(), cursorColumnReal(), mark ); }
     bool canDiscard();
     int tabWidth()                { return m_doc->config()->tabWidth(); }
     void setTabWidth( int w )     { m_doc->config()->setTabWidth(w);  }
@@ -380,6 +380,7 @@
     void find( const QString&, long, bool add=true ); ///< proxy for KateSearch
     void replace();
     void replace( const QString&, const QString &, long ); ///< proxy for KateSearch
+    /** Highly confusing but KateSearch::findAgain() is backwards too. */
     void findAgain( bool back );
     void findAgain()              { findAgain( false );          }
     void findPrev()               { findAgain( true );           }
Index: kate/part/katedocument.h
===================================================================
--- kate/part/katedocument.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kate/part/katedocument.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -264,6 +264,7 @@
      * @p removeLine is true, @p length is ignored (eg not needed).
      * @param line line number
      * @param removeLine if true, force to remove the next line
+     * @param length length of the line
      * @return true on success
      */
     bool editUnWrapLine ( uint line, bool removeLine = true, uint length = 0 );
@@ -557,7 +558,7 @@
 
     bool saveFile ();
 
-    void setReadWrite ( bool rw = true );
+    void setReadWrite ( bool readwrite = true );
 
     void setModified( bool m );
 
Index: kate/part/katedocument.cpp
===================================================================
--- kate/part/katedocument.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kate/part/katedocument.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -4688,9 +4688,9 @@
         else
           m_config->setIndentationMode( KateAutoIndent::modeNumber( val) );
       }
-      else if ( var == "word-wrap-column" && n > 0  && checkIntValue( val, &n ) ) // uint, but hard word wrap at 0 will be no fun ;)
+      else if ( var == "word-wrap-column" && checkIntValue( val, &n ) && n > 0 ) // uint, but hard word wrap at 0 will be no fun ;)
         m_config->setWordWrapAt( n );
-      else if ( var == "undo-steps"  && n >= 0  && checkIntValue( val, &n ) )
+      else if ( var == "undo-steps" && checkIntValue( val, &n ) && n >= 0 )
         setUndoSteps( n );
 
       // STRING SETTINGS
Index: kate/part/kateautoindent.h
===================================================================
--- kate/part/kateautoindent.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kate/part/kateautoindent.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -349,7 +349,7 @@
     KateCSmartIndent (KateDocument *doc);
     ~KateCSmartIndent ();
 
-    virtual void processNewline (KateDocCursor &begin, bool needContinue);
+    virtual void processNewline (KateDocCursor &cur, bool needContinue);
     virtual void processChar (QChar c);
 
     virtual void processLine (KateDocCursor &line);
@@ -380,7 +380,7 @@
     KatePythonIndent (KateDocument *doc);
     ~KatePythonIndent ();
 
-    virtual void processNewline (KateDocCursor &begin, bool needContinue);
+    virtual void processNewline (KateDocCursor &cur, bool needContinue);
 
     virtual uint modeNumber () const { return KateDocumentConfig::imPythonStyle; };
 
@@ -402,7 +402,7 @@
     ~KateXmlIndent ();
 
     virtual uint modeNumber () const { return KateDocumentConfig::imXmlStyle; }
-    virtual void processNewline (KateDocCursor &begin, bool needContinue);
+    virtual void processNewline (KateDocCursor &cur, bool needContinue);
     virtual void processChar (QChar c);
     virtual void processLine (KateDocCursor &line);
     virtual bool canProcessLine() const { return true; }
@@ -544,7 +544,7 @@
     KateScriptIndent( KateDocument *doc );
     ~KateScriptIndent();
 
-    virtual void processNewline( KateDocCursor &begin, bool needContinue );
+    virtual void processNewline( KateDocCursor &cur, bool needContinue );
     virtual void processChar( QChar c );
 
     virtual void processLine (KateDocCursor &line);
Index: kate/part/kateviewhelpers.cpp
===================================================================
--- kate/part/kateviewhelpers.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kate/part/kateviewhelpers.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -277,7 +277,7 @@
   public:
     KateCmdLineFlagCompletion() {;}
 
-    QString makeCompletion( const QString & s )
+    QString makeCompletion( const QString & string )
     {
       return QString::null;
     }
Index: kate/part/katefactory.cpp
===================================================================
--- kate/part/katefactory.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kate/part/katefactory.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -52,6 +52,7 @@
      * @param widgetName widget name
      * @param parent QObject parent
      * @param name object name
+     * @param classname class name
      * @param args additional arguments
      * @return constructed part object
      */
Index: kate/part/katesearch.h
===================================================================
--- kate/part/katesearch.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kate/part/katesearch.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -223,7 +223,7 @@
     bool help(class Kate::View *, const QString &, QString &);
     QStringList cmds();
     bool wantsToProcessText( const QString &/*cmdname*/ );
-    void processText( Kate::View *, const QString& );
+    void processText( Kate::View *view, const QString& text );
 
   private:
     /**
Index: kate/part/kateautoindent.cpp
===================================================================
--- kate/part/kateautoindent.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kate/part/kateautoindent.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -714,6 +714,7 @@
   int parenCount = 0;  // Possibly in a multiline for stmt.  Used to skip ';' ...
   bool found = false;
   bool isSpecial = false;
+  bool potentialAnchorSeen = false;
 
   //kdDebug(13030) << "calcIndent begin line:" << begin.line() << " col:" << begin.col() << endl;
 
@@ -733,7 +734,7 @@
       {
         QChar tc = textLine->getChar (pos);
         if ((tc == ';' || tc == ':' || tc == ',') && otherAnchor == -1 && parenCount <= 0)
-          otherAnchor = pos;
+          otherAnchor = pos, potentialAnchorSeen = true;
         else if (tc == ')')
           parenCount++;
         else if (tc == '(')
@@ -742,7 +743,7 @@
           openCount--;
         else if (tc == '{')
         {
-          openCount++;
+          openCount++, potentialAnchorSeen = true;
           if (openCount == 1)
             break;
         }
@@ -826,7 +827,7 @@
   }
 
   // treat beginning of document as anchor position
-  if (cur.line() == 0 && cur.col() == 0)
+  if (cur.line() == 0 && cur.col() == 0 && potentialAnchorSeen)
     found = true;
 
   if (!found)
Index: kate/part/katedialogs.cpp
===================================================================
--- kate/part/katedialogs.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kate/part/katedialogs.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -1423,13 +1423,13 @@
 {
   QString text = i18n("Select the MimeTypes you want highlighted using the '%1' syntax highlight rules.\nPlease note that this will automatically edit the associated file extensions as well.").arg( hlCombo->currentText() );
   QStringList list = QStringList::split( QRegExp("\\s*;\\s*"), mimetypes->text() );
-  KMimeTypeChooserDialog *d = new KMimeTypeChooserDialog( i18n("Select Mime Types"), text, list, "text", this );
+  KMimeTypeChooserDialog d( i18n("Select Mime Types"), text, list, "text", this );
 
-  if ( d->exec() == KDialogBase::Accepted ) {
+  if ( d.exec() == KDialogBase::Accepted ) {
     // do some checking, warn user if mime types or patterns are removed.
     // if the lists are empty, and the fields not, warn.
-    wildcards->setText(d->chooser()->patterns().join(";"));
-    mimetypes->setText(d->chooser()->mimeTypes().join(";"));
+    wildcards->setText(d.chooser()->patterns().join(";"));
+    mimetypes->setText(d.chooser()->mimeTypes().join(";"));
   }
 }
 //END KateHlConfigPage
Index: kab/qconfigDB.h
===================================================================
--- kab/qconfigDB.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kab/qconfigDB.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -199,7 +199,7 @@
   bool save(QTextStream& file, int count); 
   /**
    * Get the value for the key as a string. 
-   * \a key is the key to search for, \value is a reference to the object
+   * \a key is the key to search for, \a value is a reference to the object
    * the value for the key is assigned to.
    */
   bool get(const QCString& key, QCString& value) const;
@@ -226,7 +226,7 @@
   // ---------------
   /**
    * Get the value for the key as a long integer. 
-   * \a key is the key to search for, \value is a reference to the object
+   * \a key is the key to search for, \a value is a reference to the object
    * the value for the key is assigned to.
    */
   bool get(const QCString&, long&) const;
@@ -243,7 +243,7 @@
    * This will probably be not fast, but this methods are not suited to save 
    * large amounts of data. For saving anything else than UNICODE strings,
    * no such conversion is needed.
-   * \a key is the key to search for, \value is a reference to the object
+   * \a key is the key to search for, \a value is a reference to the object
    * the value for the key is assigned to.
    */
   bool get(const QCString&, QString&) const;
@@ -256,7 +256,7 @@
   // ---------------
   /**
    * Get the value for the key as a double. 
-   * \a key is the key to search for, \value is a reference to the object
+   * \a key is the key to search for, \a value is a reference to the object
    * the value for the key is assigned to.
    */
   bool get(const QCString&, double&) const;
@@ -269,7 +269,7 @@
   // ---------------
   /**
    * Get the value for the key as a boolean value. 
-   * \a key is the key to search for, \value is a reference to the object
+   * \a key is the key to search for, \a value is a reference to the object
    * the value for the key is assigned to.
    */
   bool get(const QCString&, bool&) const;
@@ -282,7 +282,7 @@
   // ---------------
   /**
    * Get the value for the key as a list of strings. 
-   * \a key is the key to search for, \value is a reference to the object
+   * \a key is the key to search for, \a value is a reference to the object
    * the value for the key is assigned to.
    */
   bool get(const QCString&, list<QCString>&) const;
@@ -295,7 +295,7 @@
   // --------------
   /**
    * Get the value for the key as a QStrList. 
-   * \a key is the key to search for, \value is a reference to the object
+   * \a key is the key to search for, \a value is a reference to the object
    * the value for the key is assigned to.
    */
   bool get(const QCString&, QStrList&) const;
@@ -310,7 +310,7 @@
    * Get the value for the key as a QStringList. Beware of the difference -
    * a QStringList is a list of QString objects, while QStrList handles
    * char* like objects.
-   * \a key is the key to search for, \value is a reference to the object
+   * \a key is the key to search for, \a value is a reference to the object
    * the value for the key is assigned to.
    */
   bool get(const QCString&, QStringList&) const;
@@ -323,7 +323,7 @@
   // --------------
   /**
    * Get the value for the key as a list of long integers. 
-   * \a key is the key to search for, \value is a reference to the object
+   * \a key is the key to search for, \a value is a reference to the object
    * the value for the key is assigned to.
    */
   bool get(const QCString&, list<long>&) const;
@@ -336,7 +336,7 @@
   // --------------
   /**
    * Get the value for the key as a list of integers. 
-   * \a key is the key to search for, \value is a reference to the object
+   * \a key is the key to search for, \a value is a reference to the object
    * the value for the key is assigned to.
    */
   bool get(const QCString&, list<int>&) const;
@@ -370,7 +370,7 @@
   // --------------
   /**
    * Get the value for the key as a list of doubles. 
-   * \a key is the key to search for, \value is a reference to the object
+   * \a key is the key to search for, \a value is a reference to the object
    * the value for the key is assigned to.
    */
   bool get(const QCString&, list<double>&) const;
@@ -612,7 +612,7 @@
   /**
    * Save the file. 
    * \a header will be the comment in the first line of the file.
-   * If \a force is \tt true, a file opened read-only will be switched
+   * If \a force is \c true, a file opened read-only will be switched
    * to read and write mode and back after saving. 
    * @see ::setFileName
    */
@@ -688,7 +688,7 @@
   static void CleanLockFiles(int);
   /**
    * Lock the current file.
-   * Locking is done by creating a file <filename>.lock. 
+   * Locking is done by creating a file \<filename\> lock. 
    * QConfigDB-objects will reject opening a file for reading and 
    * writing if a lockfile for the  filename exists.
    */
Index: kab/addressbook.h
===================================================================
--- kab/addressbook.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kab/addressbook.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -178,7 +178,7 @@
  *  your mainwindow (or whereever). (The toolbar is not implemented by now). <BR>
  *  Some parts of the AddressBook widget are \e interactive, that means they are
  *  displayed as transparent KURLLabels that react when the user clicks on it.
- *  These interactive parts have to be enabled by calling #setInteractiveMode.
+ *  These interactive parts have to be enabled by calling setInteractiveMode().
  */
 class AddressBook : public QFrame
 {
@@ -266,26 +266,26 @@
    *  specific address of this person is part of an object of the member list
    *  \c addresses referenced in the next paragraph. <BR>
    *  The keys defined directly in the entry sections are: <DL>
-   *  <DD> "title" The title of that person. </DD>
-   *  <DD> "rank" A possible military rank of that person. </DD>
-   *  <DD> "fn" The formatted name. If it is not empty, it replaces the
+   *  <DT>title<DT><DD> The title of that person. </DD>
+   *  <DT>rank<DT><DD>A possible military rank of that person. </DD>
+   *  <DT>fn<DT><DD>The formatted name. If it is not empty, it replaces the
    *       standard combination of the other name fields in the address
    *       display. </DD>
-   *  <DD> "nameprefix" A possible name prefix. </DD>
-   *  <DD> "firstname" The first name. </DD>
-   *  <DD> "middlename" The middle name. </DD>
-   *  <DD> "lastname" The last name. </DD>
-   *  <DD> "birthday" The birthday (a QDate). </DD>
-   *  <DD> "comment" A free form comment. </DD>
-   *  <DD> "talk" The talk addresses (a string list). </DD>
-   *  <DD> "emails" The email addresses (a string list). </DD>
-   *  <DD> "keywords" A list of free-form keywords. </DD>
-   *  <DD> "telephone" A list of telephone numbers in a special format. </DD>
-   *  <DD> "URLs" A list of internet addresses. </DD>
-   *  <DD> "user_1" The first user-declared data field. </DD>
-   *  <DD> "user_2" The second user-declared data field. </DD>
-   *  <DD> "user_3" The third user-declared data field. </DD>
-   *  <DD> "user_4" The fourth user-declared data field. </DD>
+   *  <DT>nameprefix<DT><DD>A possible name prefix. </DD>
+   *  <DT>firstname<DT><DD>The first name. </DD>
+   *  <DT>middlename<DT><DD>The middle name. </DD>
+   *  <DT>lastname<DT><DD>The last name. </DD>
+   *  <DT>birthday<DT><DD>The birthday (a QDate). </DD>
+   *  <DT>comment<DT><DD>A free form comment. </DD>
+   *  <DT>talk<DT><DD>The talk addresses (a string list). </DD>
+   *  <DT>emails<DT><DD>The email addresses (a string list). </DD>
+   *  <DT>keywords<DT><DD>A list of free-form keywords. </DD>
+   *  <DT>telephone<DT><DD>A list of telephone numbers in a special format. </DD>
+   *  <DT>URLs<DT><DD>A list of internet addresses. </DD>
+   *  <DT>user_1<DT><DD>The first user-declared data field. </DD>
+   *  <DT>user_2<DT><DD>The second user-declared data field. </DD>
+   *  <DT>user_3<DT><DD>The third user-declared data field. </DD>
+   *  <DT>user_4<DT><DD>The fourth user-declared data field. </DD>
    *  </DL>
    *  See the next section for a description of the addresses subsections.
    * 
@@ -295,18 +295,18 @@
    *  in the order they are inserted, their keys are the numbers of
    *  inserting converted to a string. <BR>
    *  The keys defined in an address subsection are: <DL>
-   *  <DD> "headline" A headline shown for the address. </DD>
-   *  <DD> "position" The position of the person. </DD>
-   *  <DD> "org" The organization. </DD>
-   *  <DD> "orgunit" The organizational unit. </DD>
-   *  <DD> "orgsubunit" The organizational subunit. </DD>
-   *  <DD> "role" The role of the person. </DD>
-   *  <DD> "deliverylabel" A label for delivering to this address. </DD>
-   *  <DD> "address" The street, house no., flat etc line. </DD>
-   *  <DD> "zip" A zip or postal code. </DD>
-   *  <DD> "town" The town the person lives in in this address. </DD>
-   *  <DD> "country" The country for federal states. </DD>
-   *  <DD> "state" The state for federal states. </DD>
+   *  <DT>headline</DT><DD> A headline shown for the address. </DD>
+   *  <DT>position</DT><DD> The position of the person. </DD>
+   *  <DT>org</DT><DD> The organization. </DD>
+   *  <DT>orgunit</DT><DD> The organizational unit. </DD>
+   *  <DT>orgsubunit</DT><DD> The organizational subunit. </DD>
+   *  <DT>role</DT><DD> The role of the person. </DD>
+   *  <DT>deliverylabel</DT><DD> A label for delivering to this address. </DD>
+   *  <DT>address</DT><DD> The street, house no., flat etc line. </DD>
+   *  <DT>zip</DT><DD> A zip or postal code. </DD>
+   *  <DT>town</DT><DD> The town the person lives in in this address. </DD>
+   *  <DT>country</DT><DD> The country for federal states. </DD>
+   *  <DT>state</DT><DD> The state for federal states. </DD>
    *  </DL>
    *
    *  \par The local configuration section
@@ -315,10 +315,10 @@
    *  with. These settings are called the local configuration. The settings
    *  are stored in the \c config section of the local file. The following
    *  keys are declared in this section: <DL>
-   *  <DD> "user_1" The \e name of the first user-declared field. </DD>
-   *  <DD> "user_2" The \e name of the second user-declared field. </DD>
-   *  <DD> "user_3" The \e name of the third user-declared field. </DD>
-   *  <DD> "user_4" The \e name of the fourth user-declared field. </DD>
+   *  <DT>user_1</DT><DD>The \e name of the first user-declared field. </DD>
+   *  <DT>user_2</DT><DD>The \e name of the second user-declared field. </DD>
+   *  <DT>user_3</DT><DD>The \e name of the third user-declared field. </DD>
+   *  <DT>user_4</DT><DD>The \e name of the fourth user-declared field. </DD>
    *  </DL>
    *  More fields will surely follow.
    **/
Index: kab/kabapi.h
===================================================================
--- kab/kabapi.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kab/kabapi.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -77,6 +77,7 @@
    * without failures. Thus you have to call init before you can
    * use the database.
    * @param parent The QWidget pointer to the parent widget.
+   * @param name The widgets name (used for debugging)
    */
   KabAPI(QWidget* parent=0, const char* name=0);
   /**
@@ -166,7 +167,7 @@
    * for example, nearly similar email addresses. Empty parts of the
    * entry are not considered as criteria.
    * @short This method delivers the closest matches to the given entry.
-   * @param name The name, containing "." for abbreviations.
+   * @param pattern The pattern, containing "." for abbreviations.
    * @param entries Reference to a list of entries where matches are stored.
    * @param max Maximum number of returned entries.
    * @return NoError if an entry is found or NoEntry.
Index: arts/kde/kplayobject.h
===================================================================
--- arts/kde/kplayobject.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ arts/kde/kplayobject.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -37,7 +37,7 @@
 
 	/**
 	  * Sets the internal Arts::PlayObject
-	  * to @playObject
+	  * to @a playObject
 	  */
 	void setObject(Arts::PlayObject playObject);
 	
Index: arts/knotify/knotify.desktop
===================================================================
--- arts/knotify/knotify.desktop	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ arts/knotify/knotify.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -68,7 +68,7 @@
 Comment[ms]=Daemon Pemberitahuan KDE
 Comment[mt]=Daemon tan-notifika KDE
 Comment[nb]=KDE Varslings-nisse
-Comment[nds]=KDE-Dämoon för't Bescheed geven
+Comment[nds]=KDE-Dämoon för Bescheden
 Comment[nl]=KDE's systeemnotificatieprogramma
 Comment[nn]=KDE-varselnisse
 Comment[nso]=Daemon ya Tsebiso ya KDE
Index: mimetypes/application/x-mplayer2.desktop
===================================================================
--- mimetypes/application/x-mplayer2.desktop	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ mimetypes/application/x-mplayer2.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -15,6 +15,7 @@
 Comment[es]=Formator de medios de Microsoft
 Comment[et]=Microsoft Media
 Comment[fa]=قالب میکروسافت ورد
+Comment[fi]=Microsoft Media
 Comment[fr]=Format Microsoft Media
 Comment[hr]=Microsoft Media oblik
 Comment[hu]=Microsoft Media-fájl
Index: kioslave/file/file.h
===================================================================
--- kioslave/file/file.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kioslave/file/file.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -48,10 +48,10 @@
   virtual ~FileProtocol() { }
 
   virtual void get( const KURL& url );
-  virtual void put( const KURL& url, int _mode,
-		    bool _overwrite, bool _resume );
+  virtual void put( const KURL& url, int permissions,
+		    bool overwrite, bool resume );
   virtual void copy( const KURL &src, const KURL &dest,
-                     int mode, bool overwrite );
+                     int permissions, bool overwrite );
   virtual void rename( const KURL &src, const KURL &dest,
                        bool overwrite );
   virtual void symlink( const QString &target, const KURL &dest,
Index: kioslave/http/http.h
===================================================================
--- kioslave/http/http.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kioslave/http/http.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -190,16 +190,16 @@
   virtual void slave_status();
 
   virtual void get( const KURL& url );
-  virtual void put( const KURL& url, int _mode, bool overwrite,
-                    bool _resume );
+  virtual void put( const KURL& url, int permissions, bool overwrite,
+                    bool resume );
 
 //----------------- Re-implemented methods for WebDAV -----------
   virtual void listDir( const KURL& url );
-  virtual void mkdir( const KURL& url, int _permissions );
+  virtual void mkdir( const KURL& url, int permissions );
 
   virtual void rename( const KURL& src, const KURL& dest, bool overwrite );
-  virtual void copy( const KURL& src, const KURL& dest, int _permissions, bool overwrite );
-  virtual void del( const KURL& url, bool _isfile );
+  virtual void copy( const KURL& src, const KURL& dest, int permissions, bool overwrite );
+  virtual void del( const KURL& url, bool isfile );
 
   // ask the host whether it supports WebDAV & cache this info
   bool davHostOk();
Index: kioslave/ftp/ftp.h
===================================================================
--- kioslave/ftp/ftp.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kioslave/ftp/ftp.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -260,7 +260,7 @@
 
   virtual void listDir( const KURL & url );
   virtual void mkdir( const KURL & url, int permissions );
-  virtual void rename( const KURL & src, const KURL & dst, bool overwrite );
+  virtual void rename( const KURL & src, const KURL & dest, bool overwrite );
   virtual void del( const KURL & url, bool isfile );
   virtual void chmod( const KURL & url, int permissions );
 
Index: kioslave/gzip/kgzipfilter.cpp
===================================================================
--- kioslave/gzip/kgzipfilter.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kioslave/gzip/kgzipfilter.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -38,8 +38,12 @@
 public:
     KGzipFilterFactory() : KLibFactory() {}
     ~KGzipFilterFactory(){}
-    QObject *createObject( QObject *, const char *, const char*, const QStringList & )
+    QObject *createObject( QObject *parent, const char *name, const char*className, const QStringList & args )
     {
+        Q_UNUSED(parent);
+        Q_UNUSED(name);
+        Q_UNUSED(className);
+        Q_UNUSED(args);
         return new KGzipFilter;
     }
 };
Index: kio/kio/slavebase.cpp
===================================================================
--- kio/kio/slavebase.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kio/kio/slavebase.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -85,21 +85,22 @@
 
    QStringList groupList() const { return QStringList(); }
 
-   QMap<QString,QString> entryMap(const QString &) const
-      { return QMap<QString,QString>(); }
+   QMap<QString,QString> entryMap(const QString &group) const
+      { Q_UNUSED(group); return QMap<QString,QString>(); }
 
    void reparseConfiguration() { }
 
-   KEntryMap internalEntryMap( const QString &) const { return KEntryMap(); }
+   KEntryMap internalEntryMap( const QString &pGroup) const { Q_UNUSED(pGroup); return KEntryMap(); }
 
    KEntryMap internalEntryMap() const { return KEntryMap(); }
 
-   void putData(const KEntryKey &, const KEntry&, bool) { }
+   void putData(const KEntryKey &_key, const KEntry&_data, bool _checkGroup) 
+   { Q_UNUSED(_key); Q_UNUSED(_data); Q_UNUSED(_checkGroup); }
 
-   KEntry lookupData(const KEntryKey &key) const
+   KEntry lookupData(const KEntryKey &_key) const
    {
      KEntry entry;
-     QString value = slave->metaData(key.c_key);
+     QString value = slave->metaData(_key.c_key);
      if (!value.isNull())
         entry.mValue = value.utf8();
      return entry;
Index: kio/kio/defaultprogress.h
===================================================================
--- kio/kio/defaultprogress.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kio/kio/defaultprogress.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -48,7 +48,7 @@
   /**
    * Creates a new default progress dialog.
    * @param parent the parent of the dialog (or 0 for top-level)
-   * @param the name of the dialog, can be 0
+   * @param name the name of the dialog, can be 0
    * @since 3.1
    */
   DefaultProgress( QWidget* parent, const char* name = 0 );
@@ -62,16 +62,16 @@
                                     unsigned long totalFiles );
 
 public slots:
-  virtual void slotTotalSize( KIO::Job*, KIO::filesize_t size );
-  virtual void slotTotalFiles( KIO::Job*, unsigned long files );
-  virtual void slotTotalDirs( KIO::Job*, unsigned long dirs );
+  virtual void slotTotalSize( KIO::Job *job, KIO::filesize_t size );
+  virtual void slotTotalFiles( KIO::Job *job, unsigned long files );
+  virtual void slotTotalDirs( KIO::Job *job, unsigned long dirs );
 
-  virtual void slotProcessedSize( KIO::Job*, KIO::filesize_t bytes );
-  virtual void slotProcessedFiles( KIO::Job*, unsigned long files );
-  virtual void slotProcessedDirs( KIO::Job*, unsigned long dirs );
+  virtual void slotProcessedSize( KIO::Job *job, KIO::filesize_t bytes );
+  virtual void slotProcessedFiles( KIO::Job *job, unsigned long files );
+  virtual void slotProcessedDirs( KIO::Job *job, unsigned long dirs );
 
-  virtual void slotSpeed( KIO::Job*, unsigned long speed );
-  virtual void slotPercent( KIO::Job*, unsigned long percent );
+  virtual void slotSpeed( KIO::Job *job, unsigned long speed );
+  virtual void slotPercent( KIO::Job *job, unsigned long percent );
   /**
    * Called to set an information message.
    * @param job the KIO::Job
@@ -79,38 +79,38 @@
    */
   virtual void slotInfoMessage( KIO::Job *job, const QString & msg );
 
-  virtual void slotCopying( KIO::Job*, const KURL& src, const KURL& dest );
-  virtual void slotMoving( KIO::Job*, const KURL& src, const KURL& dest );
-  virtual void slotDeleting( KIO::Job*, const KURL& url );
+  virtual void slotCopying( KIO::Job* job, const KURL& src, const KURL& dest );
+  virtual void slotMoving( KIO::Job* job, const KURL& src, const KURL& dest );
+  virtual void slotDeleting( KIO::Job* job, const KURL& url );
   /**
    * Called when the job is transferring.
    * @param job the KIO::Job
    * @param url the url to transfer
    * @since 3.1
    */
-  void slotTransferring( KIO::Job*, const KURL& url );
-  virtual void slotCreatingDir( KIO::Job*, const KURL& dir );
+  void slotTransferring( KIO::Job* job, const KURL& url );
+  virtual void slotCreatingDir( KIO::Job* job, const KURL& dir );
   /**
    * Called when the job is requesting a stat.
    * @param job the KIO::Job
    * @param dir the dir to stat
    * @since 3.1
    */
-  virtual void slotStating( KIO::Job*, const KURL& dir );
+  virtual void slotStating( KIO::Job* job, const KURL& dir );
   /**
    * Called when the job is mounting.
    * @param job the KIO::Job
    * @param dev the device to mount
    * @param point the mount point
    */
-  virtual void slotMounting( KIO::Job*, const QString & dev, const QString & point );
+  virtual void slotMounting( KIO::Job* job, const QString & dev, const QString & point );
   /**
    * Called when the job is unmounting.
    * @param job the KIO::Job
    * @param point the mount point
    */
-  virtual void slotUnmounting( KIO::Job*, const QString & point );
-  virtual void slotCanResume( KIO::Job*, KIO::filesize_t );
+  virtual void slotUnmounting( KIO::Job* job, const QString & point );
+  virtual void slotCanResume( KIO::Job* job, KIO::filesize_t from);
 
   /**
    * Called when the job is cleaned.
Index: kio/kio/slavebase.h
===================================================================
--- kio/kio/slavebase.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kio/kio/slavebase.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -395,7 +395,7 @@
      *
      * @see canResume()
      */
-    virtual void put( const KURL& url, int permissions, bool overwrite, bool /*resume*/ );
+    virtual void put( const KURL& url, int permissions, bool overwrite, bool resume );
 
     /**
      * Finds all details for one file or directory.
Index: kio/kio/job.cpp
===================================================================
--- kio/kio/job.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kio/kio/job.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -410,15 +410,6 @@
   : Job(showProgressInfo), m_slave(0), m_packedArgs(packedArgs),
     m_url(url), m_command(command), m_totalSize(0)
 {
-    if (!m_url.isValid())
-    {
-        m_error = ERR_MALFORMED_URL;
-        m_errorText = m_url.url();
-        QTimer::singleShot(0, this, SLOT(slotFinished()) );
-        return;
-    }
-
-
     if (m_url.hasSubURL())
     {
        KURL::List list = KURL::split(m_url);
@@ -430,6 +421,15 @@
     }
 
     Scheduler::doJob(this);
+
+    if (!m_url.isValid())
+    {
+        kdDebug() << "ERR_MALFORMED_URL" << endl;
+        m_error = ERR_MALFORMED_URL;
+        m_errorText = m_url.url();
+        QTimer::singleShot(0, this, SLOT(slotFinished()) );
+        return;
+    }
 }
 
 void SimpleJob::kill( bool quietly )
Index: kio/kio/kservice.cpp
===================================================================
--- kio/kio/kservice.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kio/kio/kservice.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -447,19 +447,21 @@
 
    QStringList groupList() const { return QStringList(); }
 
-   QMap<QString,QString> entryMap(const QString &) const
-      { return QMap<QString,QString>(); }
+   QMap<QString,QString> entryMap(const QString &group) const
+      { Q_UNUSED(group); return QMap<QString,QString>(); }
 
    void reparseConfiguration() { }
 
-   KEntryMap internalEntryMap( const QString &) const { return KEntryMap(); }
+   KEntryMap internalEntryMap( const QString &pGroup) const 
+   { Q_UNUSED(pGroup); return KEntryMap(); }
 
    KEntryMap internalEntryMap() const { return KEntryMap(); }
 
-   void putData(const KEntryKey &, const KEntry&, bool) { }
+   void putData(const KEntryKey &_key, const KEntry& _data, bool _checkGroup) 
+   { Q_UNUSED(_key); Q_UNUSED(_data); Q_UNUSED(_checkGroup); }
 
-   KEntry lookupData(const KEntryKey &) const
-   { KEntry entry; entry.mValue = value; return entry; }
+   KEntry lookupData(const KEntryKey &_key) const
+   { Q_UNUSED(_key); KEntry entry; entry.mValue = value; return entry; }
 protected:
    QString key;
    QCString value;
Index: kio/kio/kscan.h
===================================================================
--- kio/kio/kscan.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kio/kio/kscan.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -339,7 +339,7 @@
     KOCRDialogFactory( QObject *parent=0, const char *name=0 );
 
     virtual QObject* createObject( QObject* parent = 0, const char* name = 0,
-                                   const char* classname = "QObject",
+                                   const char* className = "QObject",
                                    const QStringList &args = QStringList() );
 
 
Index: kio/kfile/kfiletreeview.h
===================================================================
--- kio/kfile/kfiletreeview.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kio/kfile/kfiletreeview.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -214,9 +214,9 @@
    // The drop event allows to differentiate between move and copy
    void dropped( QWidget*, QDropEvent*, KURL::List&, KURL& );
 
-   void dropped( QDropEvent *, QListViewItem * );
+   void dropped( QDropEvent *e, QListViewItem * after);
    void dropped(KFileTreeView *, QDropEvent *, QListViewItem *);
-   void dropped(QDropEvent *, QListViewItem *, QListViewItem *);
+   void dropped(QDropEvent *e, QListViewItem * parent, QListViewItem * after);
    void dropped(KFileTreeView *, QDropEvent *, QListViewItem *, QListViewItem *);
 
 protected:
Index: kio/kfile/kurlrequester.cpp
===================================================================
--- kio/kfile/kurlrequester.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kio/kfile/kurlrequester.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -306,7 +306,7 @@
     emit urlSelected( d->url() );
 }
 
-void KURLRequester::setMode(unsigned int mode)
+void KURLRequester::setMode(uint mode)
 {
     Q_ASSERT( (mode & KFile::Files) == 0 );
     d->fileDialogMode = mode;
Index: kio/misc/uiserver.h
===================================================================
--- kio/misc/uiserver.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kio/misc/uiserver.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -276,6 +276,7 @@
 
   /**
    * Popup a message box.
+   * @param id The message identifier.
    * @param type type of message box: QuestionYesNo, WarningYesNo, WarningContinueCancel...
    *   This enum is defined in slavebase.h, it currently is:
    *   QuestionYesNo = 1, WarningYesNo = 2, WarningContinueCancel = 3,
Index: kio/kssl/ksslcsessioncache.h
===================================================================
--- kio/kssl/ksslcsessioncache.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kio/kssl/ksslcsessioncache.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -31,14 +31,14 @@
 
     /**
      * Store a SSL session (client side only)
-     * @param url URL the key belongs to. Method, host and port are used
+     * @param kurl URL the key belongs to. Method, host and port are used
      * @param session QString representing session to store
      */
     static void putSessionForURL(const KURL &kurl, const QString &session);
 
     /**
      * Retrieve a SSL session (client side only)
-     * @param url URL the key belongs to
+     * @param kurl URL the key belongs to
      * @return if a key can be found, QString::null otherwise
      */
     static QString getSessionForURL(const KURL &kurl);
Index: kio/kssl/ksmimecrypto.h
===================================================================
--- kio/kssl/ksmimecrypto.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kio/kssl/ksmimecrypto.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -85,7 +85,7 @@
      * Does not check certificates for validity!
      * @param signedText signed message block
      * @param clearText cleartext of signed message
-     * @foundCerts certificates found in this mesasge
+     * @param foundCerts certificates found in this mesasge
      * @return 0 on success
      */
     rc checkOpaqueSignature(const QByteArray &signedText,
@@ -101,7 +101,7 @@
      * @param clearText MIME representation of message to encrypt
      * @param cipherText returned encrypted message
      * @param algorithm encryption algorithm
-     * @recip recipient certificates
+     * @param recip recipient certificates
      * @return 0 on success
      */
     rc encryptMessage(const QCString &clearText,
Index: kabc/vcard21parser.h
===================================================================
--- kabc/vcard21parser.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kabc/vcard21parser.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -204,8 +204,8 @@
   friend class VCardLineX;
 
 public:
-  VCard21ParserImpl() {  };
-  virtual ~VCard21ParserImpl() {  };
+  VCard21ParserImpl();
+  virtual ~VCard21ParserImpl();
   static VCard21ParserImpl *parseVCard(const QString& vc, int *err = NULL);
   QString getValue(const QString& name, const QString& qualifier);
   QString getValue(const QString& name);
Index: kabc/plugins/sql/resourcesql.h
===================================================================
--- kabc/plugins/sql/resourcesql.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kabc/plugins/sql/resourcesql.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -43,7 +43,7 @@
   Ticket *requestSaveTicket();
 
   bool load();
-  bool save( Ticket * );
+  bool save( Ticket * ticket );
 
   QString identifier() const;
 
Index: kabc/plugins/ldapkio/resourceldapkio.h
===================================================================
--- kabc/plugins/ldapkio/resourceldapkio.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kabc/plugins/ldapkio/resourceldapkio.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -57,8 +57,8 @@
 
     virtual bool load();
     virtual bool asyncLoad();
-    virtual bool save( Ticket * );
-    virtual bool asyncSave( Ticket * );
+    virtual bool save( Ticket * ticket );
+    virtual bool asyncSave( Ticket * ticket );
 
     virtual void removeAddressee( const Addressee& addr );
 
Index: kabc/vcard21parser.cpp
===================================================================
--- kabc/vcard21parser.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kabc/vcard21parser.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -208,17 +208,17 @@
 KABC::Addressee VCard21Parser::readFromString( const QString &data)
 {
   KABC::Addressee addressee;
-  VCard21ParserImpl *mVCard = VCard21ParserImpl::parseVCard(data);
+  VCard21ParserImpl *vCard = VCard21ParserImpl::parseVCard(data);
   QString tmpStr;
 
   // Check if parsing failed
-  if (mVCard == 0)
+  if (vCard == 0)
   {
      kdDebug() << "Parsing failed" << endl;
      return addressee;
   }
   //set the addressees name and formated name
-  QStringList tmpList = mVCard->getValues(VCARD_N);
+  QStringList tmpList = vCard->getValues(VCARD_N);
   QString formattedName = "";
   if (tmpList.count() > 0)
     addressee.setFamilyName(tmpList[0]);
@@ -231,38 +231,38 @@
   if (tmpList.count() > 4)
     addressee.setSuffix(tmpList[4]);
 
-  tmpStr = (mVCard->getValue(VCARD_FN));
+  tmpStr = (vCard->getValue(VCARD_FN));
   if (!tmpStr.isEmpty())
     addressee.setFormattedName(tmpStr);
 
   //set the addressee's nick name
-  tmpStr = mVCard->getValue(VCARD_NICKNAME);
+  tmpStr = vCard->getValue(VCARD_NICKNAME);
   addressee.setNickName(tmpStr);
   //set the addressee's organization
-  tmpStr = mVCard->getValue(VCARD_ORG);
+  tmpStr = vCard->getValue(VCARD_ORG);
   addressee.setOrganization(tmpStr);
   //set the addressee's title
-  tmpStr = mVCard->getValue(VCARD_TITLE);
+  tmpStr = vCard->getValue(VCARD_TITLE);
   addressee.setTitle(tmpStr);
   //set the addressee's email - we can only deal with two.  The preferenced one and one other.
-  tmpStr = mVCard->getValue(VCARD_EMAIL, VCARD_EMAIL_INTERNET);
+  tmpStr = vCard->getValue(VCARD_EMAIL, VCARD_EMAIL_INTERNET);
   addressee.insertEmail(tmpStr, false);
-  tmpStr = mVCard->getValue(VCARD_EMAIL,VCARD_EMAIL_PREF);
+  tmpStr = vCard->getValue(VCARD_EMAIL,VCARD_EMAIL_PREF);
   addressee.insertEmail(tmpStr, true);
   //set the addressee's url
-  tmpStr = mVCard->getValue(VCARD_URL);
-  if (tmpStr.isEmpty()) tmpStr = mVCard->getValue(VCARD_URL, VCARD_ADR_WORK);
-  if (tmpStr.isEmpty()) tmpStr = mVCard->getValue(VCARD_URL, VCARD_ADR_HOME);
+  tmpStr = vCard->getValue(VCARD_URL);
+  if (tmpStr.isEmpty()) tmpStr = vCard->getValue(VCARD_URL, VCARD_ADR_WORK);
+  if (tmpStr.isEmpty()) tmpStr = vCard->getValue(VCARD_URL, VCARD_ADR_HOME);
   if (!tmpStr.isEmpty()) {
     addressee.setUrl(KURL(tmpStr));
   }
 
   //set the addressee's birthday
-  tmpStr = mVCard->getValue(VCARD_BDAY);
+  tmpStr = vCard->getValue(VCARD_BDAY);
   addressee.setBirthday(VCardStringToDate(tmpStr));
 
   //set the addressee's phone numbers
-  for ( QValueListIterator<VCardLineX> i = mVCard->_vcdata->begin();i != mVCard->_vcdata->end(); ++i ) {
+  for ( QValueListIterator<VCardLineX> i = vCard->_vcdata->begin();i != vCard->_vcdata->end(); ++i ) {
     if ( (*i).name == VCARD_TEL ) {
       int type = 0;
       if ( (*i).qualified ) {
@@ -300,7 +300,7 @@
   }
 
   //set the addressee's addresses
-  for ( QValueListIterator<VCardLineX> i = mVCard->_vcdata->begin();i != mVCard->_vcdata->end(); ++i ) {
+  for ( QValueListIterator<VCardLineX> i = vCard->_vcdata->begin();i != vCard->_vcdata->end(); ++i ) {
     if ( (*i).name == VCARD_ADR ) {
       int type = 0;
       if ( (*i).qualified ) {
@@ -324,7 +324,7 @@
   }
 
   //set the addressee's delivery label
-  tmpStr = mVCard->getValue(VCARD_LABEL);
+  tmpStr = vCard->getValue(VCARD_LABEL);
   if (!tmpStr.isEmpty()) {
     tmpStr.replace("\r\n","\n");
     Address tmpAddress;
@@ -333,17 +333,17 @@
   }
 
   //set the addressee's notes
-  tmpStr = mVCard->getValue(VCARD_NOTE);
+  tmpStr = vCard->getValue(VCARD_NOTE);
   tmpStr.replace("\r\n","\n");
   addressee.setNote(tmpStr);
 
   //set the addressee's timezone
-  tmpStr = mVCard->getValue(VCARD_TZ);
+  tmpStr = vCard->getValue(VCARD_TZ);
   TimeZone tmpZone(tmpStr.toInt());
   addressee.setTimeZone(tmpZone);
 
   //set the addressee's geographical position
-  tmpList = mVCard->getValues(VCARD_GEO);
+  tmpList = vCard->getValues(VCARD_GEO);
   if (tmpList.count()==2)
   {
     tmpStr = tmpList[0];
@@ -355,13 +355,15 @@
   }
 
   //set the last revision date
-  tmpStr = mVCard->getValue(VCARD_REV);
+  tmpStr = vCard->getValue(VCARD_REV);
   addressee.setRevision(VCardStringToDate(tmpStr));
 
   //set the role of the addressee
-  tmpStr = mVCard->getValue(VCARD_ROLE);
+  tmpStr = vCard->getValue(VCARD_ROLE);
   addressee.setRole(tmpStr);
 
+  delete vCard;
+
   return addressee;
 }
 
@@ -396,10 +398,10 @@
   int _err = 0;
   int _state = VC_STATE_BEGIN;
 
-  QValueList<VCardLineX> *_vcdata;
+  QValueList<VCardLineX> *vcdata;
   QValueList<QString> lines;
 
-  _vcdata = new QValueList<VCardLineX>;
+  vcdata = new QValueList<VCardLineX>;
 
   lines = QStringList::split( QRegExp( "[\x0d\x0a]" ), vc );
 
@@ -505,7 +507,7 @@
     }
 
     // add to vector
-    _vcdata->append( _vcl );
+    vcdata->append( _vcl );
   }
 
   // errors to check at the last minute (exit state related)
@@ -524,18 +526,29 @@
     *err = _err;
 
   if ( _err != 0 ) {
-    delete _vcdata;
+    delete vcdata;
     return 0;
   }
 
-  return new VCard21ParserImpl( _vcdata );
+  return new VCard21ParserImpl( vcdata );
 }
 
-VCard21ParserImpl::VCard21ParserImpl(QValueList<VCardLineX> *_vcd) : _vcdata(_vcd)
+VCard21ParserImpl::VCard21ParserImpl()
+  : _vcdata( 0 )
 {
 }
 
+VCard21ParserImpl::VCard21ParserImpl(QValueList<VCardLineX> *_vcd)
+  : _vcdata(_vcd)
+{
+}
 
+VCard21ParserImpl::~VCard21ParserImpl()
+{
+  delete _vcdata;
+  _vcdata = 0;
+}
+
 QString VCard21ParserImpl::getValue(const QString& name, const QString& qualifier)
 {
   QString failed;
Index: kabc/sortmode.h
===================================================================
--- kabc/sortmode.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kabc/sortmode.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -66,6 +66,7 @@
       Creates a NameSortMethod with the specified name type.
 
       @param type The name type.
+      @param ascending true for ascending sort, false for descending.
      */
     NameSortMode( NameType type, bool ascending = true );
 
@@ -91,6 +92,7 @@
       Creates a FieldSortMethod with the specified field.
 
       @param field The field.
+      @param ascending true for ascending sort, false for descending.
      */
     FieldSortMode( KABC::Field *field, bool ascending = true );
 
Index: kabc/sound.h
===================================================================
--- kabc/sound.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kabc/sound.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -51,7 +51,7 @@
  *      }
  *      KAudioPlayer::play( tmpFile ); 
  *    }
- *  \code
+ *  \endcode
  *       
  *  Unfortunetly KAudioPlayer::play is ASync, so to delete the temporary file, the best you can really do is set a timer.
  *
Index: kabc/field.h
===================================================================
--- kabc/field.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kabc/field.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -97,7 +97,7 @@
   virtual bool isCustom();
 
   /**
-   * Returns, if the field is equal with @param field.
+   * Returns, if the field is equal with @a field.
    */
   virtual bool equals( Field *field );
 
Index: kcert/kcertpart.h
===================================================================
--- kcert/kcertpart.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kcert/kcertpart.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -73,7 +73,7 @@
 	    const QStringList &args = QStringList() );
   virtual ~KCertPart();
 
-  virtual void setReadWrite(bool rw);
+  virtual void setReadWrite(bool readwrite);
 
   static KAboutData *createAboutData();
 
Index: kdesu/process.h
===================================================================
--- kdesu/process.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kdesu/process.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -119,7 +119,7 @@
      */
     int pid() {return m_Pid;};
 
-public /* static */:
+public: /* static */
     /*
     ** This is a collection of static functions that can be
     ** used for process control inside kdesu. I'd suggest 
@@ -127,7 +127,7 @@
     ** nicer Qt based ways to do what you want.
     */
 
-    /*
+    /**
     ** Wait @p ms miliseconds (ie. 1/10th of a second is 100ms),
     ** using @p fd as a filedescriptor to wait on. Returns
     ** select(2)'s result, which is -1 on error, 0 on timeout,
@@ -139,14 +139,14 @@
     static int waitMS(int fd,int ms);
 
 
-    /*
+    /**
     ** Basic check for the existence of @p pid.
     ** Returns true iff @p pid is an extant process,
     ** (one you could kill - see man kill(2) for signal 0).
     */
     static bool checkPid(pid_t pid);
 
-    /*
+    /**
     ** Check process exit status for process @p pid.
     ** On error (no child, no exit), return -1.
     ** If child @p pid has exited, return its exit status,
Index: kspell2/plugins/aspell/kspell_aspellclient.h
===================================================================
--- kspell2/plugins/aspell/kspell_aspellclient.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kspell2/plugins/aspell/kspell_aspellclient.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -1,4 +1,4 @@
-/**
+/*
  * kspell_aspellclient.h
  *
  * Copyright (C)  2003  Zack Rusin <zack@kde.org>
Index: kspell2/plugins/aspell/kspell_aspellclient.cpp
===================================================================
--- kspell2/plugins/aspell/kspell_aspellclient.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kspell2/plugins/aspell/kspell_aspellclient.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -1,4 +1,4 @@
-/**
+/*
  * kspell_aspellclient.cpp
  *
  * Copyright (C)  2003  Zack Rusin <zack@kde.org>
Index: kspell2/plugins/ispell/kspell_ispellclient.cpp
===================================================================
--- kspell2/plugins/ispell/kspell_ispellclient.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kspell2/plugins/ispell/kspell_ispellclient.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -1,4 +1,4 @@
-/**
+/*
  * kspell_aspellclient.cpp
  *
  * Copyright (C)  2003  Zack Rusin <zack@kde.org>
Index: kspell2/plugins/ispell/kspell_ispellclient.h
===================================================================
--- kspell2/plugins/ispell/kspell_ispellclient.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kspell2/plugins/ispell/kspell_ispellclient.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -1,4 +1,4 @@
-/**
+/*
  * kspell_ispellclient.h
  *
  * Copyright (C)  2003  Zack Rusin <zack@kde.org>
Index: kspell2/settings.cpp
===================================================================
--- kspell2/settings.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kspell2/settings.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -1,5 +1,5 @@
 // -*- Mode: C++; c-basic-offset: 4; indent-tabs-mode: nil; -*-
-/**
+/*
  * settings.cpp
  *
  * Copyright (C)  2003  Zack Rusin <zack@kde.org>
Index: kspell2/threadevents.h
===================================================================
--- kspell2/threadevents.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kspell2/threadevents.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -1,4 +1,4 @@
-/**
+/*
  * threadevents.h
  *
  * Copyright (C)  2004  Zack Rusin <zack@kde.org>
Index: kspell2/dictionary.h
===================================================================
--- kspell2/dictionary.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kspell2/dictionary.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -1,5 +1,5 @@
 // -*- Mode: C++; c-basic-offset: 4; indent-tabs-mode: nil; -*-
-/**
+/*
  * dictionary.h
  *
  * Copyright (C)  2004  Zack Rusin <zack@kde.org>
Index: kspell2/backgroundengine.h
===================================================================
--- kspell2/backgroundengine.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kspell2/backgroundengine.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -1,4 +1,4 @@
-/**
+/*
  * backgroundengine.h
  *
  * Copyright (C)  2004  Zack Rusin <zack@kde.org>
Index: kspell2/client.cpp
===================================================================
--- kspell2/client.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kspell2/client.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -1,5 +1,5 @@
 // -*- Mode: C++; c-basic-offset: 4; indent-tabs-mode: nil; -*-
-/**
+/*
  * client.cpp
  *
  * Copyright (C)  2003  Zack Rusin <zack@kde.org>
Index: kspell2/defaultdictionary.h
===================================================================
--- kspell2/defaultdictionary.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kspell2/defaultdictionary.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -1,4 +1,4 @@
-/**
+/*
  * defaultdictionary.h
  *
  * Copyright (C)  2004  Zack Rusin <zack@kde.org>
Index: kspell2/client.h
===================================================================
--- kspell2/client.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kspell2/client.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -1,5 +1,5 @@
 // -*- Mode: C++; c-basic-offset: 4; indent-tabs-mode: nil; -*-
-/**
+/*
  * client.cpp
  *
  * Copyright (C)  2003  Zack Rusin <zack@kde.org>
@@ -28,16 +28,16 @@
 
 #include <kdelibs_export.h>
 
-/**
- * The fact that this class inherits from QObject makes me
- * hugely unhappy. The reason for as of writting is that
- * I don't really feel like writting my own KLibFactory
- * that would load anything else then QObject derivatives.
- */
 namespace KSpell2
 {
     class Dictionary;
 
+    /**
+     * The fact that this class inherits from QObject makes me
+     * hugely unhappy. The reason for as of writting is that
+     * I don't really feel like writting my own KLibFactory
+     * that would load anything else then QObject derivatives.
+     */
     class KDE_EXPORT Client : public QObject
     {
         Q_OBJECT
Index: kspell2/filter.cpp
===================================================================
--- kspell2/filter.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kspell2/filter.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -1,5 +1,5 @@
 // -*- Mode: C++; c-basic-offset: 4; indent-tabs-mode: nil; -*-
-/**
+/*
  * filter.cpp
  *
  * Copyright (C)  2004  Zack Rusin <zack@kde.org>
Index: kspell2/filter.h
===================================================================
--- kspell2/filter.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kspell2/filter.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -1,5 +1,5 @@
 // -*- Mode: C++; c-basic-offset: 4; indent-tabs-mode: nil; -*-
-/**
+/*
  * filter.h
  *
  * Copyright (C)  2004  Zack Rusin <zack@kde.org>
Index: kspell2/ui/configwidget.h
===================================================================
--- kspell2/ui/configwidget.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kspell2/ui/configwidget.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -1,4 +1,4 @@
-/**
+/*
  * configwidget.h
  *
  * Copyright (C)  2004  Zack Rusin <zack@kde.org>
Index: kspell2/ui/highlighter.cpp
===================================================================
--- kspell2/ui/highlighter.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kspell2/ui/highlighter.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -1,4 +1,4 @@
-/**
+/*
  * highlighter.cpp
  *
  * Copyright (C)  2004  Zack Rusin <zack@kde.org>
Index: kspell2/ui/dialog.cpp
===================================================================
--- kspell2/ui/dialog.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kspell2/ui/dialog.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -1,4 +1,4 @@
-/**
+/*
  * dialog.cpp
  *
  * Copyright (C)  2003  Zack Rusin <zack@kde.org>
Index: kspell2/ui/highlighter.h
===================================================================
--- kspell2/ui/highlighter.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kspell2/ui/highlighter.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -1,4 +1,4 @@
-/**
+/*
  * highlighter.h
  *
  * Copyright (C)  2004  Zack Rusin <zack@kde.org>
Index: kspell2/ui/dialog.h
===================================================================
--- kspell2/ui/dialog.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kspell2/ui/dialog.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -1,5 +1,5 @@
 // -*- Mode: C++; c-basic-offset: 4; indent-tabs-mode: nil; -*-
-/**
+/*
  * dialog.h
  *
  * Copyright (C)  2003  Zack Rusin <zack@kde.org>
Index: kspell2/ui/configdialog.cpp
===================================================================
--- kspell2/ui/configdialog.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kspell2/ui/configdialog.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -1,4 +1,4 @@
-/**
+/*
  * configdialog.cpp
  *
  * Copyright (C)  2004  Zack Rusin <zack@kde.org>
Index: kspell2/ui/configwidget.cpp
===================================================================
--- kspell2/ui/configwidget.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kspell2/ui/configwidget.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -1,4 +1,4 @@
-/**
+/*
  * configwidget.cpp
  *
  * Copyright (C)  2004  Zack Rusin <zack@kde.org>
Index: kspell2/ui/configdialog.h
===================================================================
--- kspell2/ui/configdialog.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kspell2/ui/configdialog.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -1,4 +1,4 @@
-/**
+/*
  * configdialog.h
  *
  * Copyright (C)  2004  Zack Rusin <zack@kde.org>
Index: kdecore/kglobalaccel_mac.h
===================================================================
--- kdecore/kglobalaccel_mac.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kdecore/kglobalaccel_mac.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -14,16 +14,16 @@
     {}
 
     // reimplemented pure virtuals
-    void setEnabled( bool )
-    {}
-    bool emitSignal( Signal )
-    { return false; }
-    bool connectKey( KAccelAction&, const KKeyServer::Key& )
-    { return false; }
-    bool connectKey( const KKeyServer::Key& )
-    { return false; }
-    bool disconnectKey( KAccelAction&, const KKeyServer::Key& )
-    { return false; }
+    void setEnabled( bool bEnabled )
+    { Q_UNUSED(bEnabled); }
+    bool emitSignal( Signal signal )
+    { Q_UNUSED(signal); return false; }
+    bool connectKey( KAccelAction& action, const KKeyServer::Key& key)
+    { Q_UNUSED(action); Q_UNUSED(key); return false; }
+    bool connectKey( const KKeyServer::Key& key)
+    { Q_UNUSED(key); return false; }
+    bool disconnectKey( KAccelAction&, const KKeyServer::Key& key)
+    { Q_UNUSED(key); return false; }
     bool disconnectKey( const KKeyServer::Key& )
     { return false; }
 };
Index: kdecore/kstandarddirs.cpp
===================================================================
--- kdecore/kstandarddirs.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kdecore/kstandarddirs.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -441,7 +441,7 @@
     }
 
 #ifndef NDEBUG
-    if(false && type != "locale")
+    if(false && strcmp(type, "locale"))
       kdDebug() << "KStdDirs::findResDir(): can't find \"" << filename << "\" in type \"" << type << "\"." << endl;
 #endif
 
@@ -690,7 +690,7 @@
 
     /* If the path contains symlinks, get the real name */
     if (realpath( QFile::encodeName(dirname).data(), realpath_buffer) != 0) {
-        // succes, use result from realpath
+        // success, use result from realpath
         int len = strlen(realpath_buffer);
         realpath_buffer[len] = '/';
         realpath_buffer[len+1] = 0;
@@ -708,7 +708,7 @@
 
     /* If the path contains symlinks, get the real name */
     if (realpath( QFile::encodeName(filename).data(), realpath_buffer) != 0) {
-        // succes, use result from realpath
+        // success, use result from realpath
         return QFile::decodeName(realpath_buffer);
     }
 
@@ -1287,6 +1287,7 @@
            kdedirList.append(kdedir);
         }
     }
+
 #ifndef Q_OS_WIN //no default KDEDIR on win32 defined
     kdedirList.append(KDEDIR);
 #endif
Index: kdecore/kglobalaccel_emb.h
===================================================================
--- kdecore/kglobalaccel_emb.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kdecore/kglobalaccel_emb.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -9,7 +9,7 @@
 public:
 	KGlobalAccelPrivate();
 
-	virtual void setEnabled( bool );
+	virtual void setEnabled( bool bEnabled );
 
 	virtual bool connectKey( KAccelAction&, KKeySequence );
 	virtual bool disconnectKey( KAccelAction&, KKeySequence );
Index: kdecore/kaccelprivate.h
===================================================================
--- kdecore/kaccelprivate.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kdecore/kaccelprivate.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -21,17 +21,17 @@
 
 	KAccelPrivate( KAccel* pParent, QWidget* pWatch );
 
-	virtual void setEnabled( bool );
+	virtual void setEnabled( bool bEnabled );
 
 	bool setEnabled( const QString& sAction, bool bEnable );
 
 	virtual bool removeAction( const QString& sAction );
 
-	virtual bool emitSignal( KAccelBase::Signal );
-	virtual bool connectKey( KAccelAction&, const KKeyServer::Key& );
-	virtual bool connectKey( const KKeyServer::Key& );
-	virtual bool disconnectKey( KAccelAction&, const KKeyServer::Key& );
-	virtual bool disconnectKey( const KKeyServer::Key& );
+	virtual bool emitSignal( KAccelBase::Signal signal );
+	virtual bool connectKey( KAccelAction& action, const KKeyServer::Key& key );
+	virtual bool connectKey( const KKeyServer::Key& key );
+	virtual bool disconnectKey( KAccelAction& action, const KKeyServer::Key& key );
+	virtual bool disconnectKey( const KKeyServer::Key& key );
 
  signals:
 	void menuItemActivated();
Index: kdecore/kglobalaccel_x11.h
===================================================================
--- kdecore/kglobalaccel_x11.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kdecore/kglobalaccel_x11.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -38,13 +38,13 @@
 	KGlobalAccelPrivate();
 	virtual ~KGlobalAccelPrivate();
 
-	virtual void setEnabled( bool );
+	virtual void setEnabled( bool bEnabled );
 
-	virtual bool emitSignal( Signal );
-	virtual bool connectKey( KAccelAction&, const KKeyServer::Key& );
-	virtual bool connectKey( const KKeyServer::Key& );
-	virtual bool disconnectKey( KAccelAction&, const KKeyServer::Key& );
-	virtual bool disconnectKey( const KKeyServer::Key& );
+	virtual bool emitSignal( Signal signal );
+	virtual bool connectKey( KAccelAction& action, const KKeyServer::Key& key );
+	virtual bool connectKey( const KKeyServer::Key& key );
+	virtual bool disconnectKey( KAccelAction& action, const KKeyServer::Key& key );
+	virtual bool disconnectKey( const KKeyServer::Key& key );
 
  protected:
 	/**
Index: kdecore/kglobalaccel_win.h
===================================================================
--- kdecore/kglobalaccel_win.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kdecore/kglobalaccel_win.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -38,13 +38,13 @@
 	KGlobalAccelPrivate();
 	virtual ~KGlobalAccelPrivate();
 
-	virtual void setEnabled( bool );
+	virtual void setEnabled( bool bEnabled );
 
-	virtual bool emitSignal( Signal );
-	virtual bool connectKey( KAccelAction&, const KKeyServer::Key& );
-	virtual bool connectKey( const KKeyServer::Key& );
-	virtual bool disconnectKey( KAccelAction&, const KKeyServer::Key& );
-	virtual bool disconnectKey( const KKeyServer::Key& );
+	virtual bool emitSignal( Signal signal );
+	virtual bool connectKey( KAccelAction& action, const KKeyServer::Key& key );
+	virtual bool connectKey( const KKeyServer::Key& key );
+	virtual bool disconnectKey( KAccelAction& action, const KKeyServer::Key& key );
+	virtual bool disconnectKey( const KKeyServer::Key& key );
 
  protected:
 
Index: kdecore/kconfigbase.h
===================================================================
--- kdecore/kconfigbase.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kdecore/kconfigbase.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -2133,7 +2133,7 @@
   bool groupIsImmutable() const;
 
    // The following functions are reimplemented:
-   virtual void setDirty(bool b);
+   virtual void setDirty(bool _bDirty);
    virtual void putData(const KEntryKey &_key, const KEntry &_data, bool _checkGroup = true);
    virtual KEntry lookupData(const KEntryKey &_key) const;
    virtual void sync();
Index: kdecore/all_languages.desktop
===================================================================
--- kdecore/all_languages.desktop	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kdecore/all_languages.desktop	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -6303,7 +6303,7 @@
 Name[lv]=Lejas sakšu
 Name[mk]=Долносаксонски
 Name[nb]=Lavgermansk
-Name[nds]=Neddersass'sch
+Name[nds]=Plattdüütsch
 Name[nl]=Nedersaksisch
 Name[nn]=Låggermansk
 Name[pa]=ਲੋਅ ਸਾਕੋਨ
Index: kdecore/kwin.h
===================================================================
--- kdecore/kwin.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kdecore/kwin.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -394,7 +394,7 @@
      * Convenience function to set the current viewport to @p viewport.
      * See NETRootInfo.
      * @param desktop the number of the new desktop
-     * @param desktop the number of the new viewport
+     * @param viewport the position of the new viewport
      * @since 3.5.5
      */
     static void setCurrentDesktopViewport( int desktop, QPoint viewport );
Index: kdecore/kstartupinfo.cpp
===================================================================
--- kdecore/kstartupinfo.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kdecore/kstartupinfo.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -146,7 +146,7 @@
         d->wm_module = NULL;
     connect( &d->msgs, SIGNAL( gotMessage( const QString& )), SLOT( got_message( const QString& )));
 #endif
-    d->cleanup = new QTimer( this );
+    d->cleanup = new QTimer( this, "cleanup" );
     connect( d->cleanup, SIGNAL( timeout()), SLOT( startups_cleanup()));
     }
 
Index: kdecore/kstartupinfo.h
===================================================================
--- kdecore/kstartupinfo.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kdecore/kstartupinfo.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -175,7 +175,7 @@
         static bool sendStartup( const KStartupInfoId& id, const KStartupInfoData& data );
 
 	/**
-	 * Like sendStartup , uses dpy instead of qt_x11display() for sending the info.
+	 * Like sendStartup , uses dpy instead of qt_xdisplay() for sending the info.
 	 * @param dpy the display of the application. Note that the name field
          * in data is required.
 	 * @param id the id of the application
@@ -198,7 +198,7 @@
         static bool sendChange( const KStartupInfoId& id, const KStartupInfoData& data );
 
 	/**
-	 * Like sendChange , uses dpy instead of qt_x11display() for sending the info.
+	 * Like sendChange , uses dpy instead of qt_xdisplay() for sending the info.
 	 * @param dpy the display of the application.
 	 * @param id the id of the application
 	 * @param data the application's data
@@ -215,7 +215,7 @@
         static bool sendFinish( const KStartupInfoId& id );
 
 	/**
-	 * Like sendFinish , uses dpy instead of qt_x11display() for sending the info.
+	 * Like sendFinish , uses dpy instead of qt_xdisplay() for sending the info.
 	 * @param dpy the display of the application.
 	 * @param id the id of the application
 	 * @return true if successful, false otherwise
@@ -232,7 +232,7 @@
         static bool sendFinish( const KStartupInfoId& id, const KStartupInfoData& data );
 
 	/**
-	 * Like sendFinish , uses dpy instead of qt_x11display() for sending the info.
+	 * Like sendFinish , uses dpy instead of qt_xdisplay() for sending the info.
 	 * @param dpy the display of the application.
 	 * @param id the id of the application
 	 * @param data the application's data
Index: khtml/html/htmltokenizer.cpp
===================================================================
--- khtml/html/htmltokenizer.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/html/htmltokenizer.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -123,7 +123,7 @@
 #endif
 // ----------------------------------------------------------------------------
 
-HTMLTokenizer::HTMLTokenizer(DOM::DocumentPtr *_doc, KHTMLView *_view)
+HTMLTokenizer::HTMLTokenizer(DOM::DocumentImpl *_doc, KHTMLView *_view)
 {
     view = _view;
     buffer = 0;
@@ -138,7 +138,7 @@
     reset();
 }
 
-HTMLTokenizer::HTMLTokenizer(DOM::DocumentPtr *_doc, DOM::DocumentFragmentImpl *i)
+HTMLTokenizer::HTMLTokenizer(DOM::DocumentImpl *_doc, DOM::DocumentFragmentImpl *i)
 {
     view = 0;
     buffer = 0;
@@ -966,7 +966,7 @@
                     }
                     else {
                         DOMString v("");
-                        currToken.addAttribute(parser->docPtr()->document(), buffer, attrName, v);
+                        currToken.addAttribute(parser->docPtr(), buffer, attrName, v);
                         dest = buffer;
                         tag = SearchAttribute;
                     }
@@ -1021,7 +1021,7 @@
                         while(dest > buffer+1 && (*(dest-1) == '\n' || *(dest-1) == '\r'))
                             dest--; // remove trailing newlines
                         DOMString v(buffer+1, dest-buffer-1);
-                        currToken.addAttribute(parser->docPtr()->document(), buffer, attrName, v);
+                        currToken.addAttribute(parser->docPtr(), buffer, attrName, v);
 
                         dest = buffer;
                         tag = SearchAttribute;
@@ -1057,7 +1057,7 @@
                     if ( curchar <= ' ' || curchar == '>' )
                     {
                         DOMString v(buffer+1, dest-buffer-1);
-                        currToken.addAttribute(parser->docPtr()->document(), buffer, attrName, v);
+                        currToken.addAttribute(parser->docPtr(), buffer, attrName, v);
                         dest = buffer;
                         tag = SearchAttribute;
                         break;
Index: khtml/html/html_blockimpl.cpp
===================================================================
--- khtml/html/html_blockimpl.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/html/html_blockimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -159,7 +159,7 @@
  // WinIE uses 60ms as the minimum delay by default.
 const int defaultMinimumDelay = 60;
 
-HTMLMarqueeElementImpl::HTMLMarqueeElementImpl(DocumentPtr *doc)
+HTMLMarqueeElementImpl::HTMLMarqueeElementImpl(DocumentImpl *doc)
 : HTMLElementImpl(doc),
   m_minimumDelay(defaultMinimumDelay)
 {
@@ -256,7 +256,7 @@
 
 // ------------------------------------------------------------------------
 
-HTMLLayerElementImpl::HTMLLayerElementImpl(DocumentPtr *doc, ushort _tagid)
+HTMLLayerElementImpl::HTMLLayerElementImpl(DocumentImpl *doc, ushort _tagid)
     : HTMLDivElementImpl( doc, _tagid )
 {
     transparent = fixed = false;
Index: khtml/html/html_miscimpl.cpp
===================================================================
--- khtml/html/html_miscimpl.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/html/html_miscimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -34,7 +34,7 @@
 
 #include <kdebug.h>
 
-HTMLBaseFontElementImpl::HTMLBaseFontElementImpl(DocumentPtr *doc)
+HTMLBaseFontElementImpl::HTMLBaseFontElementImpl(DocumentImpl *doc)
     : HTMLElementImpl(doc)
 {
 }
Index: khtml/html/html_elementimpl.h
===================================================================
--- khtml/html/html_elementimpl.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/html/html_elementimpl.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -35,7 +35,7 @@
 class HTMLElementImpl : public ElementImpl
 {
 public:
-    HTMLElementImpl(DocumentPtr *doc);
+    HTMLElementImpl(DocumentImpl *doc);
 
     virtual ~HTMLElementImpl();
 
@@ -74,7 +74,7 @@
 class HTMLGenericElementImpl : public HTMLElementImpl
 {
 public:
-    HTMLGenericElementImpl(DocumentPtr *doc, ushort i);
+    HTMLGenericElementImpl(DocumentImpl *doc, ushort i);
 
     virtual ~HTMLGenericElementImpl();
 
Index: khtml/html/html_headimpl.cpp
===================================================================
--- khtml/html/html_headimpl.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/html/html_headimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -323,7 +323,7 @@
 
 // -------------------------------------------------------------------------
 
-HTMLScriptElementImpl::HTMLScriptElementImpl(DocumentPtr *doc)
+HTMLScriptElementImpl::HTMLScriptElementImpl(DocumentImpl *doc)
     : HTMLElementImpl(doc), m_cachedScript(0), m_createdByParser(false), m_evaluated(false)
 {
 }
Index: khtml/html/html_formimpl.cpp
===================================================================
--- khtml/html/html_formimpl.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/html/html_formimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -72,7 +72,7 @@
 using namespace DOM;
 using namespace khtml;
 
-HTMLFormElementImpl::HTMLFormElementImpl(DocumentPtr *doc, bool implicit)
+HTMLFormElementImpl::HTMLFormElementImpl(DocumentImpl *doc, bool implicit)
     : HTMLElementImpl(doc)
 {
     m_implicit = implicit;
@@ -788,7 +788,7 @@
 
 // -------------------------------------------------------------------------
 
-HTMLGenericFormElementImpl::HTMLGenericFormElementImpl(DocumentPtr *doc, HTMLFormElementImpl *f)
+HTMLGenericFormElementImpl::HTMLGenericFormElementImpl(DocumentImpl *doc, HTMLFormElementImpl *f)
     : HTMLElementImpl(doc)
 {
     m_disabled = m_readOnly = false;
@@ -1064,7 +1064,7 @@
 
 // -------------------------------------------------------------------------
 
-HTMLButtonElementImpl::HTMLButtonElementImpl(DocumentPtr *doc, HTMLFormElementImpl *f)
+HTMLButtonElementImpl::HTMLButtonElementImpl(DocumentImpl *doc, HTMLFormElementImpl *f)
     : HTMLGenericFormElementImpl(doc, f)
 {
     m_clicked = false;
@@ -1177,7 +1177,7 @@
 
 // -------------------------------------------------------------------------
 
-HTMLFieldSetElementImpl::HTMLFieldSetElementImpl(DocumentPtr *doc, HTMLFormElementImpl *f)
+HTMLFieldSetElementImpl::HTMLFieldSetElementImpl(DocumentImpl *doc, HTMLFormElementImpl *f)
     : HTMLGenericFormElementImpl(doc, f)
 {
 }
@@ -1214,7 +1214,7 @@
 
 // -------------------------------------------------------------------------
 
-HTMLInputElementImpl::HTMLInputElementImpl(DocumentPtr *doc, HTMLFormElementImpl *f)
+HTMLInputElementImpl::HTMLInputElementImpl(DocumentImpl *doc, HTMLFormElementImpl *f)
     : HTMLGenericFormElementImpl(doc, f)
 {
     m_type = TEXT;
@@ -1861,7 +1861,7 @@
 
 // -------------------------------------------------------------------------
 
-HTMLLabelElementImpl::HTMLLabelElementImpl(DocumentPtr *doc)
+HTMLLabelElementImpl::HTMLLabelElementImpl(DocumentImpl *doc)
     : HTMLGenericFormElementImpl(doc)
 {
 }
@@ -1930,7 +1930,7 @@
 
 // -------------------------------------------------------------------------
 
-HTMLLegendElementImpl::HTMLLegendElementImpl(DocumentPtr *doc, HTMLFormElementImpl *f)
+HTMLLegendElementImpl::HTMLLegendElementImpl(DocumentImpl *doc, HTMLFormElementImpl *f)
     : HTMLGenericFormElementImpl(doc, f)
 {
 }
@@ -1972,7 +1972,7 @@
 
 // -------------------------------------------------------------------------
 
-HTMLSelectElementImpl::HTMLSelectElementImpl(DocumentPtr *doc, HTMLFormElementImpl *f)
+HTMLSelectElementImpl::HTMLSelectElementImpl(DocumentImpl *doc, HTMLFormElementImpl *f)
     : HTMLGenericFormElementImpl(doc, f)
 {
     m_multiple = false;
@@ -2460,7 +2460,7 @@
 
 // -------------------------------------------------------------------------
 
-HTMLKeygenElementImpl::HTMLKeygenElementImpl(DocumentPtr* doc, HTMLFormElementImpl* f)
+HTMLKeygenElementImpl::HTMLKeygenElementImpl(DocumentImpl* doc, HTMLFormElementImpl* f)
     : HTMLSelectElementImpl(doc, f)
 {
     const QStringList keys = KSSLKeyGen::supportedKeySizes();
@@ -2469,7 +2469,7 @@
     for ( ; i != iEnd; ++i) {
         HTMLOptionElementImpl* const o = new HTMLOptionElementImpl(doc, form());
         addChild(o);
-        o->addChild(doc->document()->createTextNode(DOMString(*i).implementation()));
+        o->addChild(doc->createTextNode(DOMString(*i).implementation()));
     }
 }
 
@@ -2519,7 +2519,7 @@
 
 // -------------------------------------------------------------------------
 
-HTMLOptionElementImpl::HTMLOptionElementImpl(DocumentPtr *doc, HTMLFormElementImpl *f)
+HTMLOptionElementImpl::HTMLOptionElementImpl(DocumentImpl *doc, HTMLFormElementImpl *f)
     : HTMLGenericFormElementImpl(doc, f)
 {
     m_selected = false;
@@ -2622,7 +2622,7 @@
 
 // -------------------------------------------------------------------------
 
-HTMLTextAreaElementImpl::HTMLTextAreaElementImpl(DocumentPtr *doc, HTMLFormElementImpl *f)
+HTMLTextAreaElementImpl::HTMLTextAreaElementImpl(DocumentImpl *doc, HTMLFormElementImpl *f)
     : HTMLGenericFormElementImpl(doc, f)
 {
     // DTD requires rows & cols be specified, but we will provide reasonable defaults
@@ -2921,7 +2921,7 @@
 
 // -------------------------------------------------------------------------
 
-HTMLIsIndexElementImpl::HTMLIsIndexElementImpl(DocumentPtr *doc, HTMLFormElementImpl *f)
+HTMLIsIndexElementImpl::HTMLIsIndexElementImpl(DocumentImpl *doc, HTMLFormElementImpl *f)
     : HTMLInputElementImpl(doc, f)
 {
     m_type = TEXT;
Index: khtml/html/html_objectimpl.cpp
===================================================================
--- khtml/html/html_objectimpl.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/html/html_objectimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -48,7 +48,7 @@
 using namespace khtml;
 
 // -------------------------------------------------------------------------
-HTMLObjectBaseElementImpl::HTMLObjectBaseElementImpl(DocumentPtr *doc)
+HTMLObjectBaseElementImpl::HTMLObjectBaseElementImpl(DocumentImpl *doc)
     : HTMLElementImpl(doc)
 {
     needWidgetUpdate = false;
@@ -217,7 +217,7 @@
 
 // -------------------------------------------------------------------------
 
-HTMLAppletElementImpl::HTMLAppletElementImpl(DocumentPtr *doc)
+HTMLAppletElementImpl::HTMLAppletElementImpl(DocumentImpl *doc)
   : HTMLObjectBaseElementImpl(doc)
 {
     serviceType = "application/x-java-applet";
@@ -283,7 +283,7 @@
 
 // -------------------------------------------------------------------------
 
-HTMLEmbedElementImpl::HTMLEmbedElementImpl(DocumentPtr *doc)
+HTMLEmbedElementImpl::HTMLEmbedElementImpl(DocumentImpl *doc)
     : HTMLObjectBaseElementImpl(doc)
 {
 }
@@ -358,7 +358,7 @@
 
 // -------------------------------------------------------------------------
 
-HTMLObjectElementImpl::HTMLObjectElementImpl(DocumentPtr *doc)
+HTMLObjectElementImpl::HTMLObjectElementImpl(DocumentImpl *doc)
     : HTMLObjectBaseElementImpl(doc)
 {
 }
Index: khtml/html/html_baseimpl.cpp
===================================================================
--- khtml/html/html_baseimpl.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/html/html_baseimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -48,7 +48,7 @@
 using namespace DOM;
 using namespace khtml;
 
-HTMLBodyElementImpl::HTMLBodyElementImpl(DocumentPtr *doc)
+HTMLBodyElementImpl::HTMLBodyElementImpl(DocumentImpl *doc)
     : HTMLElementImpl(doc),
     m_bgSet( false ), m_fgSet( false )
 {
@@ -233,7 +233,7 @@
 
 // -------------------------------------------------------------------------
 
-HTMLFrameElementImpl::HTMLFrameElementImpl(DocumentPtr *doc)
+HTMLFrameElementImpl::HTMLFrameElementImpl(DocumentImpl *doc)
     : HTMLElementImpl(doc)
 {
     frameBorder = true;
@@ -430,7 +430,7 @@
 
 // -------------------------------------------------------------------------
 
-HTMLFrameSetElementImpl::HTMLFrameSetElementImpl(DocumentPtr *doc)
+HTMLFrameSetElementImpl::HTMLFrameSetElementImpl(DocumentImpl *doc)
     : HTMLElementImpl(doc)
 {
     // default value for rows and cols...
@@ -590,7 +590,7 @@
 
 // -------------------------------------------------------------------------
 
-HTMLIFrameElementImpl::HTMLIFrameElementImpl(DocumentPtr *doc) : HTMLFrameElementImpl(doc)
+HTMLIFrameElementImpl::HTMLIFrameElementImpl(DocumentImpl *doc) : HTMLFrameElementImpl(doc)
 {
     frameBorder = false;
     marginWidth = 0;
Index: khtml/html/htmlparser.h
===================================================================
--- khtml/html/htmlparser.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/html/htmlparser.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -48,7 +48,7 @@
 
 namespace DOM {
     class HTMLDocumentImpl;
-    class DocumentPtr;
+    class DocumentImpl;
     class HTMLElementImpl;
     class NodeImpl;
     class HTMLFormElementImpl;
@@ -68,8 +68,8 @@
 class KHTMLParser
 {
 public:
-    KHTMLParser( KHTMLView *w, DOM::DocumentPtr *i );
-    KHTMLParser( DOM::DocumentFragmentImpl *frag, DOM::DocumentPtr *doc );
+    KHTMLParser( KHTMLView *w, DOM::DocumentImpl *i );
+    KHTMLParser( DOM::DocumentFragmentImpl *frag, DOM::DocumentImpl *doc );
     virtual ~KHTMLParser();
 
     /**
@@ -86,13 +86,13 @@
     bool noSpaces() const { return (inSelect || !m_inline  || !inBody); }
     bool selectMode() const { return inSelect; }
 
-    DOM::HTMLDocumentImpl *doc() const { return static_cast<DOM::HTMLDocumentImpl *>(document->document()); }
-    DOM::DocumentPtr *docPtr() const { return document; }
+    DOM::HTMLDocumentImpl *doc() const { return static_cast<DOM::HTMLDocumentImpl *>(document); }
+    DOM::DocumentImpl *docPtr() const { return document; }
 
 protected:
 
     KHTMLView *HTMLWidget;
-    DOM::DocumentPtr *document;
+    DOM::DocumentImpl *document;
 
     /*
      * generate an element from the token
Index: khtml/html/html_listimpl.h
===================================================================
--- khtml/html/html_listimpl.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/html/html_listimpl.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -37,7 +37,7 @@
 class HTMLUListElementImpl : public HTMLElementImpl
 {
 public:
-    HTMLUListElementImpl(DocumentPtr *doc) : HTMLElementImpl(doc) {}
+    HTMLUListElementImpl(DocumentImpl *doc) : HTMLElementImpl(doc) {}
 
     virtual Id id() const;
 
@@ -51,7 +51,7 @@
 class HTMLDirectoryElementImpl : public HTMLElementImpl
 {
 public:
-    HTMLDirectoryElementImpl(DocumentPtr *doc) : HTMLElementImpl(doc) {}
+    HTMLDirectoryElementImpl(DocumentImpl *doc) : HTMLElementImpl(doc) {}
 
     virtual Id id() const;
 };
@@ -61,7 +61,7 @@
 class HTMLMenuElementImpl : public HTMLElementImpl
 {
 public:
-    HTMLMenuElementImpl(DocumentPtr *doc) : HTMLElementImpl(doc) {}
+    HTMLMenuElementImpl(DocumentImpl *doc) : HTMLElementImpl(doc) {}
     virtual ~HTMLMenuElementImpl() {}
 
     virtual Id id() const;
@@ -72,7 +72,7 @@
 class HTMLOListElementImpl : public HTMLUListElementImpl
 {
 public:
-    HTMLOListElementImpl(DocumentPtr *doc)
+    HTMLOListElementImpl(DocumentImpl *doc)
         : HTMLUListElementImpl(doc), _start(1) {}
 
     virtual Id id() const;
@@ -88,7 +88,7 @@
 class HTMLLIElementImpl : public HTMLElementImpl
 {
 public:
-    HTMLLIElementImpl(DocumentPtr *doc)
+    HTMLLIElementImpl(DocumentImpl *doc)
         : HTMLElementImpl(doc) {}
 
     virtual Id id() const;
@@ -101,7 +101,7 @@
 class HTMLDListElementImpl : public HTMLElementImpl
 {
 public:
-    HTMLDListElementImpl(DocumentPtr *doc) : HTMLElementImpl(doc) {}
+    HTMLDListElementImpl(DocumentImpl *doc) : HTMLElementImpl(doc) {}
     virtual ~HTMLDListElementImpl() {}
 
     virtual Id id() const;
Index: khtml/html/html_imageimpl.cpp
===================================================================
--- khtml/html/html_imageimpl.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/html/html_imageimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -52,7 +52,7 @@
 
 // -------------------------------------------------------------------------
 
-HTMLImageElementImpl::HTMLImageElementImpl(DocumentPtr *doc, HTMLFormElementImpl *f)
+HTMLImageElementImpl::HTMLImageElementImpl(DocumentImpl *doc, HTMLFormElementImpl *f)
     : HTMLElementImpl(doc), ismap(false), loadEventSent(true), m_image(0), m_form(f)
 {
     if (m_form)
@@ -343,7 +343,7 @@
 
 // -------------------------------------------------------------------------
 
-HTMLMapElementImpl::HTMLMapElementImpl(DocumentPtr *doc)
+HTMLMapElementImpl::HTMLMapElementImpl(DocumentImpl *doc)
     : HTMLElementImpl(doc)
 {
 }
@@ -435,7 +435,7 @@
 
 // -------------------------------------------------------------------------
 
-HTMLAreaElementImpl::HTMLAreaElementImpl(DocumentPtr *doc)
+HTMLAreaElementImpl::HTMLAreaElementImpl(DocumentImpl *doc)
     : HTMLAnchorElementImpl(doc)
 {
     m_coords=0;
Index: khtml/html/html_inlineimpl.h
===================================================================
--- khtml/html/html_inlineimpl.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/html/html_inlineimpl.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -33,7 +33,7 @@
 class HTMLAnchorElementImpl : public HTMLElementImpl
 {
 public:
-    HTMLAnchorElementImpl(DocumentPtr *doc)
+    HTMLAnchorElementImpl(DocumentImpl *doc)
         : HTMLElementImpl(doc), m_hasTarget(false) {}
 
     virtual bool isFocusable() const { return m_hasAnchor; }
@@ -50,7 +50,7 @@
 class HTMLBRElementImpl : public HTMLElementImpl
 {
 public:
-    HTMLBRElementImpl(DocumentPtr *doc)
+    HTMLBRElementImpl(DocumentImpl *doc)
         : HTMLElementImpl(doc) {}
 
     virtual Id id() const;
@@ -63,7 +63,7 @@
 class HTMLFontElementImpl : public HTMLElementImpl
 {
 public:
-    HTMLFontElementImpl(DocumentPtr *doc)
+    HTMLFontElementImpl(DocumentImpl *doc)
         : HTMLElementImpl(doc) {}
 
     virtual Id id() const;
Index: khtml/html/html_elementimpl.cpp
===================================================================
--- khtml/html/html_elementimpl.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/html/html_elementimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -56,10 +56,10 @@
 using namespace DOM;
 using namespace khtml;
 
-HTMLElementImpl::HTMLElementImpl(DocumentPtr *doc)
+HTMLElementImpl::HTMLElementImpl(DocumentImpl *doc)
     : ElementImpl( doc )
 {
-    m_htmlCompat = doc && doc->document() ? doc->document()->htmlMode() != DocumentImpl::XHtml : false;
+    m_htmlCompat = doc && doc->htmlMode() != DocumentImpl::XHtml;
 }
 
 HTMLElementImpl::~HTMLElementImpl()
@@ -663,7 +663,7 @@
 }
 
 // -------------------------------------------------------------------------
-HTMLGenericElementImpl::HTMLGenericElementImpl(DocumentPtr *doc, ushort i)
+HTMLGenericElementImpl::HTMLGenericElementImpl(DocumentImpl *doc, ushort i)
     : HTMLElementImpl(doc)
 {
     _id = i;
Index: khtml/html/html_tableimpl.h
===================================================================
--- khtml/html/html_tableimpl.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/html/html_tableimpl.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -53,7 +53,7 @@
 
 {
 public:
-    HTMLTablePartElementImpl(DocumentPtr *doc)
+    HTMLTablePartElementImpl(DocumentImpl *doc)
         : HTMLElementImpl(doc)
         { }
 
@@ -65,7 +65,7 @@
 class HTMLTableSectionElementImpl : public HTMLTablePartElementImpl
 {
 public:
-    HTMLTableSectionElementImpl(DocumentPtr *doc, ushort tagid, bool implicit);
+    HTMLTableSectionElementImpl(DocumentImpl *doc, ushort tagid, bool implicit);
 
     ~HTMLTableSectionElementImpl();
 
@@ -85,7 +85,7 @@
 class HTMLTableRowElementImpl : public HTMLTablePartElementImpl
 {
 public:
-    HTMLTableRowElementImpl(DocumentPtr *doc)
+    HTMLTableRowElementImpl(DocumentImpl *doc)
         : HTMLTablePartElementImpl(doc) {}
 
     virtual Id id() const;
@@ -105,7 +105,7 @@
 class HTMLTableCellElementImpl : public HTMLTablePartElementImpl
 {
 public:
-    HTMLTableCellElementImpl(DocumentPtr *doc, int tagId);
+    HTMLTableCellElementImpl(DocumentImpl *doc, int tagId);
     ~HTMLTableCellElementImpl();
 
     long cellIndex() const;
@@ -138,7 +138,7 @@
 class HTMLTableColElementImpl : public HTMLTablePartElementImpl
 {
 public:
-    HTMLTableColElementImpl(DocumentPtr *doc, ushort i);
+    HTMLTableColElementImpl(DocumentImpl *doc, ushort i);
 
     virtual Id id() const;
 
@@ -163,7 +163,7 @@
 class HTMLTableCaptionElementImpl : public HTMLTablePartElementImpl
 {
 public:
-    HTMLTableCaptionElementImpl(DocumentPtr *doc)
+    HTMLTableCaptionElementImpl(DocumentImpl *doc)
         : HTMLTablePartElementImpl(doc) {}
 
     virtual Id id() const;
@@ -249,7 +249,7 @@
         Box    = 0x0f
     };
 
-    HTMLTableElementImpl(DocumentPtr *doc);
+    HTMLTableElementImpl(DocumentImpl *doc);
     ~HTMLTableElementImpl();
 
     virtual Id id() const;
Index: khtml/html/htmltokenizer.h
===================================================================
--- khtml/html/htmltokenizer.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/html/htmltokenizer.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -44,7 +44,7 @@
 class KHTMLView;
 
 namespace DOM {
-    class DocumentPtr;
+    class DocumentImpl;
     class DocumentFragmentImpl;
 }
 
@@ -122,8 +122,8 @@
 {
     friend class KHTMLParser;
 public:
-    HTMLTokenizer(DOM::DocumentPtr *, KHTMLView * = 0);
-    HTMLTokenizer(DOM::DocumentPtr *, DOM::DocumentFragmentImpl *frag);
+    HTMLTokenizer(DOM::DocumentImpl *, KHTMLView * = 0);
+    HTMLTokenizer(DOM::DocumentImpl *, DOM::DocumentFragmentImpl *frag);
     virtual ~HTMLTokenizer();
 
     void begin();
Index: khtml/html/html_blockimpl.h
===================================================================
--- khtml/html/html_blockimpl.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/html/html_blockimpl.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -36,7 +36,7 @@
 class HTMLDivElementImpl : public HTMLGenericElementImpl
 {
 public:
-    HTMLDivElementImpl(DocumentPtr *doc, ushort _tagid)
+    HTMLDivElementImpl(DocumentImpl *doc, ushort _tagid)
         : HTMLGenericElementImpl(doc, _tagid) {}
 
     virtual void parseAttribute(AttributeImpl *token);
@@ -47,7 +47,7 @@
 class HTMLHRElementImpl : public HTMLElementImpl
 {
 public:
-    HTMLHRElementImpl(DocumentPtr *doc)
+    HTMLHRElementImpl(DocumentImpl *doc)
         : HTMLElementImpl(doc) {}
 
     virtual NodeImpl::Id id() const;
@@ -60,7 +60,7 @@
 class HTMLPreElementImpl : public HTMLGenericElementImpl
 {
 public:
-    HTMLPreElementImpl(DocumentPtr *doc, ushort _tagid)
+    HTMLPreElementImpl(DocumentImpl *doc, ushort _tagid)
         : HTMLGenericElementImpl(doc, _tagid) {}
 
     long width() const;
@@ -72,7 +72,7 @@
 class HTMLMarqueeElementImpl : public HTMLElementImpl
 {
 public:
-    HTMLMarqueeElementImpl(DocumentPtr *doc);
+    HTMLMarqueeElementImpl(DocumentImpl *doc);
 
     virtual NodeImpl::Id id() const;
     virtual void parseAttribute(AttributeImpl *token);
@@ -88,7 +88,7 @@
 class HTMLLayerElementImpl : public HTMLDivElementImpl
 {
 public:
-    HTMLLayerElementImpl( DocumentPtr *doc, ushort _tagid );
+    HTMLLayerElementImpl( DocumentImpl *doc, ushort _tagid );
 
     virtual void parseAttribute(AttributeImpl *);
     virtual NodeImpl *addChild(NodeImpl *child);
Index: khtml/html/html_miscimpl.h
===================================================================
--- khtml/html/html_miscimpl.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/html/html_miscimpl.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -36,7 +36,7 @@
 class HTMLBaseFontElementImpl : public HTMLElementImpl
 {
 public:
-    HTMLBaseFontElementImpl(DocumentPtr *doc);
+    HTMLBaseFontElementImpl(DocumentImpl *doc);
 
     ~HTMLBaseFontElementImpl();
 
Index: khtml/html/html_headimpl.h
===================================================================
--- khtml/html/html_headimpl.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/html/html_headimpl.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -46,7 +46,7 @@
 class HTMLBaseElementImpl : public HTMLElementImpl
 {
 public:
-    HTMLBaseElementImpl(DocumentPtr *doc)
+    HTMLBaseElementImpl(DocumentImpl *doc)
         : HTMLElementImpl(doc) {}
 
     DOMString href() const { return m_href; }
@@ -71,7 +71,7 @@
 class HTMLLinkElementImpl : public khtml::CachedObjectClient, public HTMLElementImpl
 {
 public:
-    HTMLLinkElementImpl(DocumentPtr *doc)
+    HTMLLinkElementImpl(DocumentImpl *doc)
         : HTMLElementImpl(doc), m_cachedSheet(0), m_sheet(0), m_isDisabled(false),
 	m_loading(false), m_alternate(false), m_isCSSSheet(false) {}
 
@@ -119,7 +119,7 @@
 class HTMLMetaElementImpl : public HTMLElementImpl
 {
 public:
-    HTMLMetaElementImpl(DocumentPtr *doc)
+    HTMLMetaElementImpl(DocumentImpl *doc)
         : HTMLElementImpl(doc) {}
 
     virtual Id id() const;
@@ -138,7 +138,7 @@
 class HTMLScriptElementImpl : public HTMLElementImpl, public khtml::CachedObjectClient
 {
 public:
-    HTMLScriptElementImpl(DocumentPtr *doc);
+    HTMLScriptElementImpl(DocumentImpl *doc);
     ~HTMLScriptElementImpl();
 
     virtual void insertedIntoDocument();
@@ -185,7 +185,7 @@
 class HTMLStyleElementImpl : public HTMLElementImpl
 {
 public:
-    HTMLStyleElementImpl(DocumentPtr *doc)
+    HTMLStyleElementImpl(DocumentImpl *doc)
         : HTMLElementImpl(doc), m_sheet(0), m_loading(false) {}
     ~HTMLStyleElementImpl();
 
@@ -214,7 +214,7 @@
 class HTMLTitleElementImpl : public HTMLElementImpl
 {
 public:
-    HTMLTitleElementImpl(DocumentPtr *doc)
+    HTMLTitleElementImpl(DocumentImpl *doc)
         : HTMLElementImpl(doc) {}
 
     DOMString text();
Index: khtml/html/html_formimpl.h
===================================================================
--- khtml/html/html_formimpl.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/html/html_formimpl.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -65,7 +65,7 @@
 class HTMLFormElementImpl : public HTMLElementImpl
 {
 public:
-    HTMLFormElementImpl(DocumentPtr *doc, bool implicit);
+    HTMLFormElementImpl(DocumentImpl *doc, bool implicit);
     virtual ~HTMLFormElementImpl();
 
     virtual Id id() const;
@@ -137,7 +137,7 @@
     friend class khtml::RenderFormElement;
 
 public:
-    HTMLGenericFormElementImpl(DocumentPtr *doc, HTMLFormElementImpl *f = 0);
+    HTMLGenericFormElementImpl(DocumentImpl *doc, HTMLFormElementImpl *f = 0);
     virtual ~HTMLGenericFormElementImpl();
 
     HTMLFormElementImpl *form() { return m_form; }
@@ -189,7 +189,7 @@
 class HTMLButtonElementImpl : public HTMLGenericFormElementImpl
 {
 public:
-    HTMLButtonElementImpl(DocumentPtr *doc, HTMLFormElementImpl *f = 0);
+    HTMLButtonElementImpl(DocumentImpl *doc, HTMLFormElementImpl *f = 0);
 
     virtual ~HTMLButtonElementImpl();
 
@@ -227,7 +227,7 @@
 class HTMLFieldSetElementImpl : public HTMLGenericFormElementImpl
 {
 public:
-    HTMLFieldSetElementImpl(DocumentPtr *doc, HTMLFormElementImpl *f = 0);
+    HTMLFieldSetElementImpl(DocumentImpl *doc, HTMLFormElementImpl *f = 0);
 
     virtual ~HTMLFieldSetElementImpl();
 
@@ -261,7 +261,7 @@
         BUTTON
     };
 
-    HTMLInputElementImpl(DocumentPtr *doc, HTMLFormElementImpl *f = 0);
+    HTMLInputElementImpl(DocumentImpl *doc, HTMLFormElementImpl *f = 0);
     virtual ~HTMLInputElementImpl();
 
     virtual Id id() const;
@@ -289,7 +289,7 @@
 
     virtual bool maintainsState() { return true; }
     virtual QString state();
-    virtual void restoreState(const QString &);
+    virtual void restoreState(const QString &state);
 
     void select();
     void click();
@@ -345,7 +345,7 @@
 class HTMLLabelElementImpl : public HTMLGenericFormElementImpl
 {
 public:
-    HTMLLabelElementImpl(DocumentPtr *doc);
+    HTMLLabelElementImpl(DocumentImpl *doc);
     virtual ~HTMLLabelElementImpl();
 
     virtual Id id() const;
@@ -364,7 +364,7 @@
 class HTMLLegendElementImpl : public HTMLGenericFormElementImpl
 {
 public:
-    HTMLLegendElementImpl(DocumentPtr *doc, HTMLFormElementImpl *f = 0);
+    HTMLLegendElementImpl(DocumentImpl *doc, HTMLFormElementImpl *f = 0);
     virtual ~HTMLLegendElementImpl();
 
     virtual Id id() const;
@@ -380,7 +380,7 @@
     friend class khtml::RenderSelect;
 
 public:
-    HTMLSelectElementImpl(DocumentPtr *doc, HTMLFormElementImpl *f = 0);
+    HTMLSelectElementImpl(DocumentImpl *doc, HTMLFormElementImpl *f = 0);
     ~HTMLSelectElementImpl();
 
     virtual Id id() const;
@@ -410,7 +410,7 @@
 
     virtual bool maintainsState() { return true; }
     virtual QString state();
-    virtual void restoreState(const QString &);
+    virtual void restoreState(const QString &state);
 
     virtual NodeImpl *insertBefore ( NodeImpl *newChild, NodeImpl *refChild, int &exceptioncode );
     virtual void      replaceChild ( NodeImpl *newChild, NodeImpl *oldChild, int &exceptioncode );
@@ -457,7 +457,7 @@
 class HTMLKeygenElementImpl : public HTMLSelectElementImpl
 {
 public:
-    HTMLKeygenElementImpl(DocumentPtr *doc, HTMLFormElementImpl *f = 0);
+    HTMLKeygenElementImpl(DocumentImpl *doc, HTMLFormElementImpl *f = 0);
 
     virtual Id id() const;
 
@@ -479,7 +479,7 @@
 class HTMLOptGroupElementImpl : public HTMLGenericFormElementImpl
 {
 public:
-    HTMLOptGroupElementImpl(DocumentPtr *doc, HTMLFormElementImpl *f = 0)
+    HTMLOptGroupElementImpl(DocumentImpl *doc, HTMLFormElementImpl *f = 0)
         : HTMLGenericFormElementImpl(doc, f) {}
 
     virtual Id id() const;
@@ -494,7 +494,7 @@
     friend class DOM::HTMLSelectElementImpl;
 
 public:
-    HTMLOptionElementImpl(DocumentPtr *doc, HTMLFormElementImpl *f = 0);
+    HTMLOptionElementImpl(DocumentImpl *doc, HTMLFormElementImpl *f = 0);
 
     virtual Id id() const;
 
@@ -530,7 +530,7 @@
         ta_Physical
     };
 
-    HTMLTextAreaElementImpl(DocumentPtr *doc, HTMLFormElementImpl *f = 0);
+    HTMLTextAreaElementImpl(DocumentImpl *doc, HTMLFormElementImpl *f = 0);
     ~HTMLTextAreaElementImpl();
 
     virtual Id id() const;
@@ -547,7 +547,7 @@
 
     virtual bool maintainsState() { return true; }
     virtual QString state();
-    virtual void restoreState(const QString &);
+    virtual void restoreState(const QString &state);
 
     void select (  );
 
@@ -588,7 +588,7 @@
 class HTMLIsIndexElementImpl : public HTMLInputElementImpl
 {
 public:
-    HTMLIsIndexElementImpl(DocumentPtr *doc, HTMLFormElementImpl *f = 0);
+    HTMLIsIndexElementImpl(DocumentImpl *doc, HTMLFormElementImpl *f = 0);
     ~HTMLIsIndexElementImpl();
 
     virtual Id id() const;
Index: khtml/html/htmlparser.cpp
===================================================================
--- khtml/html/htmlparser.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/html/htmlparser.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -125,7 +125,7 @@
  *
  */
 
-KHTMLParser::KHTMLParser( KHTMLView *_parent, DocumentPtr *doc)
+KHTMLParser::KHTMLParser( KHTMLView *_parent, DocumentImpl *doc)
 {
     //kdDebug( 6035 ) << "parser constructor" << endl;
 #if SPEED_DEBUG > 0
@@ -134,7 +134,6 @@
 
     HTMLWidget    = _parent;
     document      = doc;
-    document->ref();
 
     blockStack = 0;
     current = 0;
@@ -145,11 +144,10 @@
     reset();
 }
 
-KHTMLParser::KHTMLParser( DOM::DocumentFragmentImpl *i, DocumentPtr *doc )
+KHTMLParser::KHTMLParser( DOM::DocumentFragmentImpl *i, DocumentImpl *doc )
 {
     HTMLWidget = 0;
     document = doc;
-    document->ref();
 
     forbiddenTag = new ushort[ID_CLOSE_TAG+1];
 
@@ -173,15 +171,13 @@
 
     if (current) current->deref();
 
-    document->deref();
-
     delete [] forbiddenTag;
     delete isindex;
 }
 
 void KHTMLParser::reset()
 {
-    setCurrent ( document->document() );
+    setCurrent ( document );
 
     freeBlock();
 
@@ -230,7 +226,7 @@
 
     // holy shit. apparently some sites use </br> instead of <br>
     // be compatible with IE and NS
-    if(t->tid == ID_BR+ID_CLOSE_TAG && document->document()->inCompatMode())
+    if(t->tid == ID_BR+ID_CLOSE_TAG && document->inCompatMode())
         t->tid -= ID_CLOSE_TAG;
 
     if(t->tid > ID_CLOSE_TAG)
@@ -349,8 +345,8 @@
             if(!n->attached() && HTMLWidget)
                 n->attach();
             if (n->maintainsState()) {
-                document->document()->registerMaintainsState(n);
-                QString state(document->document()->nextState());
+                document->registerMaintainsState(n);
+                QString state(document->nextState());
                 if (!state.isNull()) n->restoreState(state);
             }
             n->close();
@@ -886,8 +882,8 @@
             // we can't implement that behavior now because it could cause too many
             // regressions and the headaches are not worth the work as long as there is
             // no site actually relying on that detail (Dirk)
-            if (static_cast<HTMLDocumentImpl*>(document->document())->body())
-                static_cast<HTMLDocumentImpl*>(document->document())->body()
+            if (static_cast<HTMLDocumentImpl*>(document)->body())
+                static_cast<HTMLDocumentImpl*>(document)->body()
                     ->addCSSProperty(CSS_PROP_DISPLAY, CSS_VAL_NONE);
             inBody = false;
         }
@@ -1631,9 +1627,9 @@
 
 #if SPEED_DEBUG < 1
     if((Elem->node != current)) {
-        if (current->maintainsState() && document->document()){
-            document->document()->registerMaintainsState(current);
-            QString state(document->document()->nextState());
+        if (current->maintainsState() && document){
+            document->registerMaintainsState(current);
+            QString state(document->nextState());
             if (!state.isNull()) current->restoreState(state);
         }
         current->close();
Index: khtml/html/html_objectimpl.h
===================================================================
--- khtml/html/html_objectimpl.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/html/html_objectimpl.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -40,7 +40,7 @@
 {
     Q_OBJECT
 public:
-    HTMLObjectBaseElementImpl(DocumentPtr *doc);
+    HTMLObjectBaseElementImpl(DocumentImpl *doc);
 
     virtual void parseAttribute(AttributeImpl *attr);
     virtual void attach();
@@ -72,7 +72,7 @@
 class HTMLAppletElementImpl : public HTMLObjectBaseElementImpl
 {
 public:
-    HTMLAppletElementImpl(DocumentPtr *doc);
+    HTMLAppletElementImpl(DocumentImpl *doc);
 
     ~HTMLAppletElementImpl();
 
@@ -89,7 +89,7 @@
 class HTMLEmbedElementImpl : public HTMLObjectBaseElementImpl
 {
 public:
-    HTMLEmbedElementImpl(DocumentPtr *doc);
+    HTMLEmbedElementImpl(DocumentImpl *doc);
     ~HTMLEmbedElementImpl();
 
     virtual Id id() const;
@@ -106,7 +106,7 @@
 class HTMLObjectElementImpl : public HTMLObjectBaseElementImpl
 {
 public:
-    HTMLObjectElementImpl(DocumentPtr *doc);
+    HTMLObjectElementImpl(DocumentImpl *doc);
 
     ~HTMLObjectElementImpl();
 
@@ -127,7 +127,7 @@
 {
     friend class HTMLAppletElementImpl;
 public:
-    HTMLParamElementImpl(DocumentPtr* _doc) : HTMLElementImpl(_doc) {}
+    HTMLParamElementImpl(DocumentImpl* _doc) : HTMLElementImpl(_doc) {}
 
     virtual Id id() const;
 
Index: khtml/html/html_baseimpl.h
===================================================================
--- khtml/html/html_baseimpl.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/html/html_baseimpl.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -53,7 +53,7 @@
 class HTMLBodyElementImpl : public HTMLElementImpl
 {
 public:
-    HTMLBodyElementImpl(DocumentPtr *doc);
+    HTMLBodyElementImpl(DocumentImpl *doc);
     ~HTMLBodyElementImpl();
 
     virtual Id id() const;
@@ -80,7 +80,7 @@
     friend class khtml::RenderPartObject;
 
 public:
-    HTMLFrameElementImpl(DocumentPtr *doc);
+    HTMLFrameElementImpl(DocumentImpl *doc);
 
     ~HTMLFrameElementImpl();
 
@@ -116,7 +116,7 @@
 {
     friend class khtml::RenderFrameSet;
 public:
-    HTMLFrameSetElementImpl(DocumentPtr *doc);
+    HTMLFrameSetElementImpl(DocumentImpl *doc);
 
     ~HTMLFrameSetElementImpl();
 
@@ -159,7 +159,7 @@
 class HTMLHeadElementImpl : public HTMLElementImpl
 {
 public:
-    HTMLHeadElementImpl(DocumentPtr *doc)
+    HTMLHeadElementImpl(DocumentImpl *doc)
         : HTMLElementImpl(doc) {}
 
     virtual Id id() const;
@@ -170,7 +170,7 @@
 class HTMLHtmlElementImpl : public HTMLElementImpl
 {
 public:
-    HTMLHtmlElementImpl(DocumentPtr *doc)
+    HTMLHtmlElementImpl(DocumentImpl *doc)
         : HTMLElementImpl(doc) {}
 
     virtual Id id() const;
@@ -182,7 +182,7 @@
 class HTMLIFrameElementImpl : public HTMLFrameElementImpl
 {
 public:
-    HTMLIFrameElementImpl(DocumentPtr *doc);
+    HTMLIFrameElementImpl(DocumentImpl *doc);
 
     ~HTMLIFrameElementImpl();
 
Index: khtml/html/html_tableimpl.cpp
===================================================================
--- khtml/html/html_tableimpl.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/html/html_tableimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -48,7 +48,7 @@
 using namespace khtml;
 using namespace DOM;
 
-HTMLTableElementImpl::HTMLTableElementImpl(DocumentPtr *doc)
+HTMLTableElementImpl::HTMLTableElementImpl(DocumentImpl *doc)
   : HTMLElementImpl(doc)
 {
     rules = None;
@@ -661,7 +661,7 @@
 
 // -------------------------------------------------------------------------
 
-HTMLTableSectionElementImpl::HTMLTableSectionElementImpl(DocumentPtr *doc,
+HTMLTableSectionElementImpl::HTMLTableSectionElementImpl(DocumentImpl *doc,
                                                          ushort tagid, bool implicit)
     : HTMLTablePartElementImpl(doc)
 {
@@ -833,7 +833,7 @@
 
 // -------------------------------------------------------------------------
 
-HTMLTableCellElementImpl::HTMLTableCellElementImpl(DocumentPtr *doc, int tag)
+HTMLTableCellElementImpl::HTMLTableCellElementImpl(DocumentImpl *doc, int tag)
   : HTMLTablePartElementImpl(doc)
 {
   _col = -1;
@@ -930,7 +930,7 @@
 
 // -------------------------------------------------------------------------
 
-HTMLTableColElementImpl::HTMLTableColElementImpl(DocumentPtr *doc, ushort i)
+HTMLTableColElementImpl::HTMLTableColElementImpl(DocumentImpl *doc, ushort i)
     : HTMLTablePartElementImpl(doc)
 {
     _id = i;
Index: khtml/html/html_imageimpl.h
===================================================================
--- khtml/html/html_imageimpl.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/html/html_imageimpl.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -40,7 +40,7 @@
 {
     friend class HTMLFormElementImpl;
 public:
-    HTMLImageElementImpl(DocumentPtr *doc, HTMLFormElementImpl *f = 0);
+    HTMLImageElementImpl(DocumentImpl *doc, HTMLFormElementImpl *f = 0);
     ~HTMLImageElementImpl();
 
     virtual Id id() const;
@@ -95,7 +95,7 @@
 
     enum Shape { Default, Poly, Rect, Circle, Unknown };
 
-    HTMLAreaElementImpl(DocumentPtr *doc);
+    HTMLAreaElementImpl(DocumentImpl *doc);
     ~HTMLAreaElementImpl();
 
     virtual Id id() const;
@@ -127,7 +127,7 @@
 class HTMLMapElementImpl : public HTMLElementImpl
 {
 public:
-    HTMLMapElementImpl(DocumentPtr *doc);
+    HTMLMapElementImpl(DocumentImpl *doc);
 
     ~HTMLMapElementImpl();
 
Index: khtml/ecma/kjs_navigator.cpp
===================================================================
--- khtml/ecma/kjs_navigator.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/ecma/kjs_navigator.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -46,7 +46,7 @@
     // Its ctor and dtor take care of the refcounting on the static lists.
     class PluginBase : public ObjectImp {
     public:
-        PluginBase(ExecState *exec);
+        PluginBase(ExecState *exec, bool loadPluginInfo);
         virtual ~PluginBase();
 
         struct MimeClassInfo;
@@ -76,30 +76,40 @@
 
     class Plugins : public PluginBase {
     public:
-        Plugins(ExecState *exec) : PluginBase(exec) {};
+        Plugins(ExecState *exec, bool pluginsEnabled)
+          : PluginBase(exec, pluginsEnabled),
+            m_pluginsEnabled(pluginsEnabled) {};
         virtual Value get(ExecState *exec, const Identifier &propertyName) const;
         Value getValueProperty(ExecState *exec, int token) const;
         virtual const ClassInfo* classInfo() const { return &info; }
         static const ClassInfo info;
         Value pluginByName( ExecState* exec, const QString& name ) const;
+        bool pluginsEnabled() const { return m_pluginsEnabled; };
+    private:
+        bool m_pluginsEnabled;
     };
 
 
     class MimeTypes : public PluginBase {
     public:
-        MimeTypes(ExecState *exec) : PluginBase(exec) { };
+        MimeTypes(ExecState *exec, bool pluginsEnabled)
+          : PluginBase(exec, pluginsEnabled),
+            m_pluginsEnabled(pluginsEnabled) {};
         virtual Value get(ExecState *exec, const Identifier &propertyName) const;
         virtual const ClassInfo* classInfo() const { return &info; }
         static const ClassInfo info;
         Value getValueProperty(ExecState *exec, int token) const;
         Value mimeTypeByName( ExecState* exec, const QString& name ) const;
+        bool pluginsEnabled() const { return m_pluginsEnabled; };
+    private:
+        bool m_pluginsEnabled;
     };
 
 
     class Plugin : public PluginBase {
     public:
         Plugin( ExecState *exec, PluginBase::PluginInfo *info )
-          : PluginBase( exec )
+          : PluginBase( exec, true )
         { m_info = info; };
         virtual Value get(ExecState *exec, const Identifier &propertyName) const;
         virtual const ClassInfo* classInfo() const { return &info; }
@@ -115,7 +125,7 @@
     class MimeType : public PluginBase {
     public:
         MimeType( ExecState *exec, PluginBase::MimeClassInfo *info )
-          : PluginBase( exec )
+          : PluginBase( exec, true )
         { m_info = info; };
         virtual Value get(ExecState *exec, const Identifier &propertyName) const;
         virtual const ClassInfo* classInfo() const { return &info; }
@@ -259,9 +269,9 @@
       return String("x86");
   }
   case _Plugins:
-    return Value(new Plugins(exec));
+    return Value(new Plugins(exec, m_part->pluginsEnabled()));
   case _MimeTypes:
-    return Value(new MimeTypes(exec));
+    return Value(new MimeTypes(exec, m_part->pluginsEnabled()));
   case CookieEnabled:
     return Boolean(true); /// ##### FIXME
   default:
@@ -272,20 +282,15 @@
 
 /*******************************************************************/
 
-PluginBase::PluginBase(ExecState *exec)
+PluginBase::PluginBase(ExecState *exec, bool loadPluginInfo)
   : ObjectImp(exec->interpreter()->builtinObjectPrototype() )
 {
-    if ( !plugins ) {
+    if ( loadPluginInfo && !plugins ) {
         plugins = new QPtrList<PluginInfo>;
         mimes = new QPtrList<MimeClassInfo>;
         plugins->setAutoDelete( true );
         mimes->setAutoDelete( true );
 
-        // FIXME: add domain support here
-        KConfig kc("konquerorrc", true);
-        if (!KConfigGroup(&kc, "Java/JavaScript Settings").readBoolEntry("EnablePlugins", true))
-            return; // plugins disabled
-
         // read in using KTrader
         KTrader::OfferList offers = KTrader::self()->query("Browser/View");
         KTrader::OfferList::iterator it;
@@ -378,25 +383,31 @@
 #ifdef KJS_VERBOSE
   kdDebug(6070) << "Plugins::get " << propertyName.qstring() << endl;
 #endif
-  if ( propertyName == lengthPropertyName )
-    return Number(plugins->count());
+  if (!pluginsEnabled()) {
+    if (propertyName == lengthPropertyName )
+      return Number(0);
+  } else {
+    if ( propertyName == lengthPropertyName )
+      return Number(plugins->count());
 
-  // plugins[#]
-  bool ok;
-  unsigned int i = propertyName.toULong(&ok);
-  if( ok && i<plugins->count() )
-    return Value( new Plugin( exec, plugins->at(i) ) );
+    // plugins[#]
+    bool ok;
+    unsigned int i = propertyName.toULong(&ok);
+    if( ok && i<plugins->count() )
+      return Value( new Plugin( exec, plugins->at(i) ) );
 
-  // plugin[name]
-  Value val = pluginByName( exec, propertyName.qstring() );
-  if (!val.isA(UndefinedType))
-    return val;
+    // plugin[name]
+    Value val = pluginByName( exec, propertyName.qstring() );
+    if (!val.isA(UndefinedType))
+      return val;
+  }
 
   return lookupGet<PluginsFunc,Plugins,ObjectImp>(exec,propertyName,&PluginsTable,this);
 }
 
 Value Plugins::pluginByName( ExecState* exec, const QString& name ) const
 {
+  Q_ASSERT(plugins);
   for ( PluginInfo *pl = plugins->first(); pl!=0; pl = plugins->next() ) {
     if ( pl->name == name )
       return Value( new Plugin( exec, pl ) );
@@ -414,26 +425,30 @@
 {
   KJS_CHECK_THIS( KJS::Plugins, thisObj );
   KJS::Plugins* base = static_cast<KJS::Plugins *>(thisObj.imp());
-  switch( id ) {
-  case Plugins_Refresh:
-    return Undefined(); //## TODO
-  case Plugins_Item:
-  {
-    bool ok;
-    unsigned int i = args[0].toString(exec).toArrayIndex(&ok);
-    if( ok && i<base->plugins->count() )
-      return Value( new Plugin( exec, base->plugins->at(i) ) );
-    return Undefined();
+  if (!base->pluginsEnabled()) {
+    if (id == Plugins_Refresh || //## TODO
+        id == Plugins_Item ||
+        id == Plugins_NamedItem)
+      return Undefined();
+  } else {
+    switch( id ) {
+    case Plugins_Refresh:
+      return Undefined(); //## TODO
+    case Plugins_Item:
+    {
+      bool ok;
+      unsigned int i = args[0].toString(exec).toArrayIndex(&ok);
+      if( ok && i<base->plugins->count() )
+        return Value( new Plugin( exec, base->plugins->at(i) ) );
+      return Undefined();
+    }
+    case Plugins_NamedItem:
+      UString s = args[0].toString(exec);
+      return base->pluginByName( exec, s.qstring() );
+    }
   }
-  case Plugins_NamedItem:
-  {
-    UString s = args[0].toString(exec);
-    return base->pluginByName( exec, s.qstring() );
-  }
-  default:
-    kdDebug(6070) << "WARNING: Unhandled token in PluginsFunc::tryCall : " << id << endl;
-    return Undefined();
-  }
+  kdDebug(6070) << "WARNING: Unhandled token in PluginsFunc::tryCall : " << id << endl;
+  return Undefined();
 }
 
 /*******************************************************************/
@@ -453,19 +468,24 @@
 #ifdef KJS_VERBOSE
   kdDebug(6070) << "MimeTypes::get " << propertyName.qstring() << endl;
 #endif
-  if( propertyName==lengthPropertyName )
-    return Number( mimes->count() );
+  if (!pluginsEnabled()) {
+    if (propertyName == lengthPropertyName )
+        return Number(0);
+  } else {
+    if( propertyName==lengthPropertyName )
+      return Number( mimes->count() );
 
-  // mimeTypes[#]
-  bool ok;
-  unsigned int i = propertyName.toULong(&ok);
-  if( ok && i<mimes->count() )
-    return Value( new MimeType( exec, mimes->at(i) ) );
+    // mimeTypes[#]
+    bool ok;
+    unsigned int i = propertyName.toULong(&ok);
+    if( ok && i<mimes->count() )
+      return Value( new MimeType( exec, mimes->at(i) ) );
 
-  // mimeTypes[name]
-  Value val = mimeTypeByName( exec, propertyName.qstring() );
-  if (!val.isA(UndefinedType))
-    return val;
+    // mimeTypes[name]
+    Value val = mimeTypeByName( exec, propertyName.qstring() );
+    if (!val.isA(UndefinedType))
+      return val;
+  }
 
   return lookupGet<MimeTypesFunc,MimeTypes,ObjectImp>(exec,propertyName,&MimeTypesTable,this);
 }
@@ -473,6 +493,7 @@
 Value MimeTypes::mimeTypeByName( ExecState* exec, const QString& name ) const
 {
   //kdDebug(6070) << "MimeTypes[" << name << "]" << endl;
+  Q_ASSERT(mimes);
   for ( MimeClassInfo *m = mimes->first(); m!=0; m = mimes->next() ) {
     if ( m->type == name )
       return Value( new MimeType( exec, m ) );
@@ -490,24 +511,27 @@
 {
   KJS_CHECK_THIS( KJS::MimeTypes, thisObj );
   KJS::MimeTypes* base = static_cast<KJS::MimeTypes *>(thisObj.imp());
-  switch( id ) {
-  case MimeTypes_Item:
-  {
-    bool ok;
-    unsigned int i = args[0].toString(exec).toArrayIndex(&ok);
-    if( ok && i<base->mimes->count() )
-      return Value( new MimeType( exec, base->mimes->at(i) ) );
-    return Undefined();
+  if (!base->pluginsEnabled()) {
+    if (id == MimeTypes_Item ||
+        id == MimeTypes_NamedItem)
+      return Undefined();
+  } else {
+    switch( id ) {
+    case MimeTypes_Item:
+    {
+      bool ok;
+      unsigned int i = args[0].toString(exec).toArrayIndex(&ok);
+      if( ok && i<base->mimes->count() )
+        return Value( new MimeType( exec, base->mimes->at(i) ) );
+      return Undefined();
+    }
+    case MimeTypes_NamedItem:
+      UString s = args[0].toString(exec);
+      return base->mimeTypeByName( exec, s.qstring() );
+    }
   }
-  case MimeTypes_NamedItem:
-  {
-    UString s = args[0].toString(exec);
-    return base->mimeTypeByName( exec, s.qstring() );
-  }
-  default:
-    kdDebug(6070) << "WARNING: Unhandled token in MimeTypesFunc::tryCall : " << id << endl;
-    return Undefined();
-  }
+  kdDebug(6070) << "WARNING: Unhandled token in MimeTypesFunc::tryCall : " << id << endl;
+  return Undefined();
 }
 
 /************************************************************************/
Index: khtml/ecma/kjs_range.cpp
===================================================================
--- khtml/ecma/kjs_range.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/ecma/kjs_range.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -1,3 +1,4 @@
+
 // -*- c-basic-offset: 2 -*-
 /*
  *  This file is part of the KDE libraries
@@ -23,7 +24,7 @@
 #include "kjs_range.lut.h"
 #include <kdebug.h>
 
-using namespace KJS;
+namespace KJS {
 
 // -------------------------------------------------------------------------
 
@@ -59,9 +60,9 @@
   createContextualFragment  DOMRange::CreateContextualFragment  DontDelete|Function 1
 @end
 */
-DEFINE_PROTOTYPE("DOMRange",DOMRangeProto)
+KJS_DEFINE_PROTOTYPE(DOMRangeProto)
 IMPLEMENT_PROTOFUNC_DOM(DOMRangeProtoFunc)
-IMPLEMENT_PROTOTYPE(DOMRangeProto,DOMRangeProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("DOMRange",DOMRangeProto,DOMRangeProtoFunc)
 
 DOMRange::DOMRange(ExecState *exec, DOM::Range r)
  : DOMObject(DOMRangeProto::self(exec)), range(r) {}
@@ -183,7 +184,7 @@
   return result;
 }
 
-Value KJS::getDOMRange(ExecState *exec, DOM::Range r)
+Value getDOMRange(ExecState *exec, DOM::Range r)
 {
   return cacheDOMObject<DOM::Range, KJS::DOMRange>(exec, r);
 }
@@ -213,13 +214,13 @@
   return Number(token);
 }
 
-Value KJS::getRangeConstructor(ExecState *exec)
+Value getRangeConstructor(ExecState *exec)
 {
   return cacheGlobalObject<RangeConstructor>(exec, "[[range.constructor]]");
 }
 
 
-DOM::Range KJS::toRange(const Value& val)
+DOM::Range toRange(const Value& val)
 {
   Object obj = Object::dynamicCast(val);
   if (!obj.isValid() || !obj.inherits(&DOMRange::info))
@@ -228,3 +229,5 @@
   const DOMRange *dobj = static_cast<const DOMRange*>(obj.imp());
   return dobj->toRange();
 }
+
+} //namespace KJS
Index: khtml/ecma/kjs_events.h
===================================================================
--- khtml/ecma/kjs_events.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/ecma/kjs_events.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -35,7 +35,9 @@
   public:
     /**
      * @param _listener the function object, that will be called when the event is emitted
+     * @param _compareListenerImp Compare Listener implementation.
      * @param _win Window object, for memory management and caching.
+     * @param _html \c true if it is HTML. 
      * Never create a JSEventListener directly, use Window::getJSEventListener.
      */
     JSEventListener(Object _listener, ObjectImp *_compareListenerImp, const Object &_win, bool _html = false);
Index: khtml/ecma/kjs_binding.h
===================================================================
--- khtml/ecma/kjs_binding.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/ecma/kjs_binding.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -245,10 +245,53 @@
     else
       thisObj->putValueProperty(exec, entry->value, value, attr);
   }
+  
+// Versions of prototype functions that properly support instanceof,
+// and are compatible with trunk.
+#define KJS_DEFINE_PROTOTYPE_IMP(ClassProto,ProtoCode) \
+  class ClassProto : public ObjectImp { \
+  friend Object cacheGlobalObject<ClassProto>(ExecState *exec, const Identifier &propertyName); \
+  public: \
+    static Object self(ExecState *exec); \
+    virtual const ClassInfo *classInfo() const { return &info; } \
+    static const ClassInfo info; \
+    Value get(ExecState *exec, const Identifier &propertyName) const; \
+  protected: \
+    ClassProto( ExecState *exec ) \
+      : ObjectImp( ProtoCode ) {} \
+    \
+    static Identifier* s_name; \
+    static Identifier* name(); \
+  };
 
+#define KJS_DEFINE_PROTOTYPE(ClassProto) \
+        KJS_DEFINE_PROTOTYPE_IMP(ClassProto, exec->interpreter()->builtinObjectPrototype())
+
+#define KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(ClassProto, ClassProtoProto) \
+            KJS_DEFINE_PROTOTYPE_IMP(ClassProto, ClassProtoProto::self(exec))
+
+//### this doesn't implement hasProperty, but stuff in lookup.h didn't 
+//either (just did the forward)
+#define KJS_IMPLEMENT_PROTOTYPE(ClassName, ClassProto, ClassFunc) \
+    const ClassInfo ClassProto::info = { ClassName, 0, &ClassProto##Table, 0 }; \
+    Identifier* ClassProto::s_name = 0; \
+    Object ClassProto::self(ExecState *exec) \
+    { \
+      return cacheGlobalObject<ClassProto>(exec, *name()); \
+    } \
+    Value ClassProto::get(ExecState *exec, const Identifier &propertyName) const \
+    { \
+      /*fprintf( stderr, "%sProto::get(%s) [in macro, no parent]\n", info.className, propertyName.ascii());*/ \
+      return lookupGetFunction<ClassFunc,ObjectImp>(exec, propertyName, &ClassProto##Table, this ); \
+    } \
+    Identifier* ClassProto::name() \
+    { \
+      if (!s_name) s_name = new Identifier("[[" ClassName ".prototype]]"); \
+      return s_name; \
+    } 
+    
   // Modified version of IMPLEMENT_PROTOFUNC, to use DOMFunction and tryCall
 #define IMPLEMENT_PROTOFUNC_DOM(ClassFunc) \
-  namespace KJS { \
   class ClassFunc : public DOMFunction { \
   public: \
     ClassFunc(ExecState *exec, int i, int len) \
@@ -260,8 +303,7 @@
     virtual Value tryCall(ExecState *exec, Object &thisObj, const List &args); \
   private: \
     int id; \
-  }; \
-  }
+  }; 
 
   Value getLiveConnectValue(KParts::LiveConnectExtension *lc, const QString & name, const int type, const QString & value, int id);
 
@@ -294,26 +336,49 @@
 #define IMPLEMENT_PSEUDO_CONSTRUCTOR_WITH_PARENT(Class,ClassName,ProtoClass,ParentProtoClass) \
     IMPLEMENT_PSEUDO_CONSTRUCTOR_IMP(Class,ClassName,ProtoClass,ParentProtoClass::self(exec))
 
-// This is used to implement a constant table. Can be used as a prototype
-#define CREATE_CONSTANT_TABLE(Class,ClassName) \
+// This declares a constant table, which merely maps everything in its 
+// table to its token value. Can be used as a prototype
+#define DEFINE_CONSTANT_TABLE(Class) \
    class Class : public DOMObject { \
    public: \
-     Class(ExecState *exec): DOMObject(exec->interpreter()->builtinObjectPrototype()) {} \
-     virtual Value tryGet(ExecState *exec, const Identifier &propertyName) const { \
+     Class(ExecState *exec): DOMObject(exec->lexicalInterpreter()->builtinObjectPrototype()) {} \
+     \
+     virtual Value tryGet(ExecState *exec, const Identifier &propertyName) const;\
+     Value  getValueProperty(ExecState * /*exec*/, int token) const; \
+     virtual const ClassInfo* classInfo() const { return &info; } \
+     static const ClassInfo info; \
+     static Object self(ExecState *exec);\
+     static Identifier* s_name; \
+     static Identifier* name(); \
+   };
+
+// Emits an implementation of a constant table 
+#define IMPLEMENT_CONSTANT_TABLE(Class,ClassName) \
+    Value Class::tryGet(ExecState *exec, const Identifier &propertyName) const { \
         return DOMObjectLookupGetValue<Class, DOMObject>(exec, propertyName, &Class##Table, this);\
-     } \
-     Value getValueProperty(ExecState * /*exec*/, int token) const { \
+    } \
+    Value Class::getValueProperty(ExecState * /*exec*/, int token) const { \
         /* We use the token as the value to return directly*/ \
         return Number((unsigned int)token); \
-     }  \
-     virtual const ClassInfo* classInfo() const { return &info; } \
-     static const ClassInfo info; \
-     static Object self(ExecState *exec) { \
-        return Object(cacheGlobalObject<Class>(exec, "[[" ClassName ".constant_table]]")); \
-     } \
-   }; \
-   const ClassInfo Class::info = { ClassName, 0, &Class##Table, 0 };
+    }  \
+    Object Class::self(ExecState *exec) { \
+        return cacheGlobalObject<Class>(exec, *name()); \
+    } \
+    Identifier* Class::s_name = 0; \
+    Identifier* Class::name() { \
+        if (!s_name) s_name = new Identifier("[[" ClassName ".constant_table]]"); \
+        return s_name; \
+    } \
+    const ClassInfo Class::info = { ClassName, 0, &Class##Table, 0 };
 
+   
+// Hide some of the stuff in lookup.h..
+#undef PUBLIC_DEFINE_PROTOTYPE
+#undef DEFINE_PROTOTYPE
+#undef IMPLEMENT_PROTOTYPE
+#undef PUBLIC_IMPLEMENT_PROTOTYPE
+#undef IMPLEMENT_PROTOTYPE_WITH_PARENT
+
 } // namespace
 
 #endif
Index: khtml/ecma/kjs_dom.cpp
===================================================================
--- khtml/ecma/kjs_dom.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/ecma/kjs_dom.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -43,7 +43,7 @@
 #include "kjs_dom.lut.h"
 #include "khtmlpart_p.h"
 
-using namespace KJS;
+namespace KJS {
 
 // -------------------------------------------------------------------------
 /* Source for DOMNodeConstantsTable.
@@ -62,7 +62,7 @@
   NOTATION_NODE     DOM::Node::NOTATION_NODE        DontDelete|ReadOnly
 @end
 */
-CREATE_CONSTANT_TABLE(DOMNodeConstants,"DOMNodeConstants")
+IMPLEMENT_CONSTANT_TABLE(DOMNodeConstants,"DOMNodeConstants")
 // -------------------------------------------------------------------------
 /* Source for DOMNodeProtoTable.
 @begin DOMNodeProtoTable 13
@@ -87,9 +87,8 @@
   item          DOMNode::Item           DontDelete|Function 1
 @end
 */
-DEFINE_PROTOTYPE("DOMNode",DOMNodeProto)
 IMPLEMENT_PROTOFUNC_DOM(DOMNodeProtoFunc)
-IMPLEMENT_PROTOTYPE_WITH_PARENT(DOMNodeProto,DOMNodeProtoFunc,DOMNodeConstants)
+KJS_IMPLEMENT_PROTOTYPE("DOMNode", DOMNodeProto, DOMNodeProtoFunc)
 
 const ClassInfo DOMNode::info = { "Node", 0, &DOMNodeTable, 0 };
 
@@ -633,10 +632,11 @@
   namedItem	DOMNodeList::NamedItem		DontDelete|Function 1
 @end
 */
-DEFINE_PROTOTYPE("DOMNodeList", DOMNodeListProto)
+KJS_DEFINE_PROTOTYPE(DOMNodeListProto)
 IMPLEMENT_PROTOFUNC_DOM(DOMNodeListProtoFunc)
-IMPLEMENT_PROTOTYPE(DOMNodeListProto,DOMNodeListProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("DOMNodeList", DOMNodeListProto, DOMNodeListProtoFunc)
 
+
 const ClassInfo DOMNodeList::info = { "NodeList", 0, 0, 0 };
 
 DOMNodeList::DOMNodeList(ExecState *exec, const DOM::NodeList& l)
@@ -795,6 +795,7 @@
 
 // -------------------------------------------------------------------------
 
+//### FIXME: link to the node prototype.
 const ClassInfo DOMAttr::info = { "Attr", &DOMNode::info, &DOMAttrTable, 0 };
 
 /* Source for DOMAttrTable.
@@ -878,8 +879,7 @@
 @end
 */
 IMPLEMENT_PROTOFUNC_DOM(DOMDocumentProtoFunc)
-PUBLIC_IMPLEMENT_PROTOTYPE_WITH_PARENT(DOMDocumentProto, "DOMDocument", DOMDocumentProtoFunc, DOMNodeProto)
-
+KJS_IMPLEMENT_PROTOTYPE("DOMDocument", DOMDocumentProto, DOMDocumentProtoFunc)
 IMPLEMENT_PSEUDO_CONSTRUCTOR(DocumentPseudoCtor, "Document", DOMDocumentProto)
 
 const ClassInfo DOMDocument::info = { "Document", &DOMNode::info, &DOMDocumentTable, 0 };
@@ -1127,9 +1127,8 @@
   hasAttributeNS	DOMElement::HasAttributeNS	DontDelete|Function 2
 @end
 */
-DEFINE_PROTOTYPE("DOMElement",DOMElementProto)
 IMPLEMENT_PROTOFUNC_DOM(DOMElementProtoFunc)
-IMPLEMENT_PROTOTYPE_WITH_PARENT(DOMElementProto,DOMElementProtoFunc,DOMNodeProto)
+KJS_IMPLEMENT_PROTOTYPE("DOMElement", DOMElementProto, DOMElementProtoFunc)
 
 IMPLEMENT_PSEUDO_CONSTRUCTOR(ElementPseudoCtor, "Element", DOMElementProto)
 
@@ -1241,9 +1240,9 @@
   createHTMLDocument    DOMDOMImplementation::CreateHTMLDocument        DontDelete|Function 1
 @end
 */
-DEFINE_PROTOTYPE("DOMImplementation",DOMDOMImplementationProto)
+KJS_DEFINE_PROTOTYPE(DOMDOMImplementationProto)
 IMPLEMENT_PROTOFUNC_DOM(DOMDOMImplementationProtoFunc)
-IMPLEMENT_PROTOTYPE(DOMDOMImplementationProto,DOMDOMImplementationProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("DOMImplementation", DOMDOMImplementationProto, DOMDOMImplementationProtoFunc)
 
 const ClassInfo DOMDOMImplementation::info = { "DOMImplementation", 0, 0, 0 };
 
@@ -1352,9 +1351,9 @@
   length		DOMNamedNodeMap::Length			DontDelete|Function 1
 @end
 */
-DEFINE_PROTOTYPE("NamedNodeMap", DOMNamedNodeMapProto)
+KJS_DEFINE_PROTOTYPE(DOMNamedNodeMapProto)
 IMPLEMENT_PROTOFUNC_DOM(DOMNamedNodeMapProtoFunc)
-IMPLEMENT_PROTOTYPE(DOMNamedNodeMapProto,DOMNamedNodeMapProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("NamedNodeMap", DOMNamedNodeMapProto, DOMNamedNodeMapProtoFunc)
 
 const ClassInfo DOMNamedNodeMap::info = { "NamedNodeMap", 0, &DOMNamedNodeMapTable, 0 };
 
@@ -1415,7 +1414,7 @@
 }
 
 // -------------------------------------------------------------------------
-
+//### FIXME: proto
 const ClassInfo DOMProcessingInstruction::info = { "ProcessingInstruction", &DOMNode::info, &DOMProcessingInstructionTable, 0 };
 
 /* Source for DOMProcessingInstructionTable.
@@ -1515,7 +1514,7 @@
 
 // -------------------------------------------------------------------------
 
-bool KJS::checkNodeSecurity(ExecState *exec, const DOM::Node& n)
+bool checkNodeSecurity(ExecState *exec, const DOM::Node& n)
 {
   // Check to see if the currently executing interpreter is allowed to access the specified node
   if (n.isNull())
@@ -1527,7 +1526,7 @@
   return true;
 }
 
-Value KJS::getDOMNode(ExecState *exec, const DOM::Node& n)
+Value getDOMNode(ExecState *exec, const DOM::Node& n)
 {
   DOMObject *ret = 0;
   if (n.isNull())
@@ -1585,17 +1584,17 @@
   return Value(ret);
 }
 
-Value KJS::getDOMNamedNodeMap(ExecState *exec, const DOM::NamedNodeMap& m)
+Value getDOMNamedNodeMap(ExecState *exec, const DOM::NamedNodeMap& m)
 {
   return Value(cacheDOMObject<DOM::NamedNodeMap, KJS::DOMNamedNodeMap>(exec, m));
 }
 
-Value KJS::getDOMNodeList(ExecState *exec, const DOM::NodeList& l)
+Value getDOMNodeList(ExecState *exec, const DOM::NodeList& l)
 {
   return Value(cacheDOMObject<DOM::NodeList, KJS::DOMNodeList>(exec, l));
 }
 
-Value KJS::getDOMDOMImplementation(ExecState *exec, const DOM::DOMImplementation& i)
+Value getDOMDOMImplementation(ExecState *exec, const DOM::DOMImplementation& i)
 {
   return Value(cacheDOMObject<DOM::DOMImplementation, KJS::DOMDOMImplementation>(exec, i));
 }
@@ -1679,7 +1678,7 @@
 #endif
 }
 
-Object KJS::getDOMExceptionConstructor(ExecState *exec)
+Object getDOMExceptionConstructor(ExecState *exec)
 {
   return cacheGlobalObject<DOMExceptionConstructor>(exec, "[[DOMException.constructor]]");
 }
@@ -1735,9 +1734,9 @@
   replaceData	DOMCharacterData::ReplaceData	DontDelete|Function 2
 @end
 */
-DEFINE_PROTOTYPE("DOMCharacterData",DOMCharacterDataProto)
+KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(DOMCharacterDataProto, DOMNodeProto)
 IMPLEMENT_PROTOFUNC_DOM(DOMCharacterDataProtoFunc)
-IMPLEMENT_PROTOTYPE_WITH_PARENT(DOMCharacterDataProto,DOMCharacterDataProtoFunc, DOMNodeProto)
+KJS_IMPLEMENT_PROTOTYPE("DOMCharacterData", DOMCharacterDataProto, DOMCharacterDataProtoFunc)
 
 DOMCharacterData::DOMCharacterData(ExecState *exec, const DOM::CharacterData& d)
  : DOMNode(DOMCharacterDataProto::self(exec), d) {}
@@ -1812,9 +1811,9 @@
   splitText	DOMText::SplitText	DontDelete|Function 1
 @end
 */
-DEFINE_PROTOTYPE("DOMText",DOMTextProto)
+KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(DOMTextProto, DOMCharacterDataProto)
 IMPLEMENT_PROTOFUNC_DOM(DOMTextProtoFunc)
-IMPLEMENT_PROTOTYPE_WITH_PARENT(DOMTextProto,DOMTextProtoFunc,DOMCharacterDataProto)
+KJS_IMPLEMENT_PROTOTYPE("DOMText", DOMTextProto, DOMTextProtoFunc)
 
 DOMText::DOMText(ExecState *exec, const DOM::Text& t)
   : DOMCharacterData(DOMTextProto::self(exec), t) { }
@@ -1839,3 +1838,5 @@
   }
   return Undefined();
 }
+
+}
Index: khtml/ecma/xmlserializer.cpp
===================================================================
--- khtml/ecma/xmlserializer.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/ecma/xmlserializer.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -27,7 +27,6 @@
 
 #include <kdebug.h>
 
-using namespace KJS;
 
 ////////////////////// XMLSerializer Object ////////////////////////
 
@@ -36,12 +35,13 @@
   serializeToString XMLSerializer::SerializeToString DontDelete|Function 1
 @end
 */
-DEFINE_PROTOTYPE("XMLSerializer",XMLSerializerProto)
-IMPLEMENT_PROTOFUNC_DOM(XMLSerializerProtoFunc)
-IMPLEMENT_PROTOTYPE(XMLSerializerProto,XMLSerializerProtoFunc)
 
 namespace KJS {
 
+KJS_DEFINE_PROTOTYPE(XMLSerializerProto)
+IMPLEMENT_PROTOFUNC_DOM(XMLSerializerProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("XMLSerializer", XMLSerializerProto, XMLSerializerProtoFunc)
+
 XMLSerializerConstructorImp::XMLSerializerConstructorImp(ExecState *)
     : ObjectImp()
 {
Index: khtml/ecma/kjs_css.cpp
===================================================================
--- khtml/ecma/kjs_css.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/ecma/kjs_css.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -28,9 +28,11 @@
 #include <css/css_base.h>
 #include "kjs_dom.h"
 
-using namespace KJS;
+
 #include <kdebug.h>
 
+namespace KJS {
+
 static QString cssPropertyName( const Identifier &p, bool& hadPixelPrefix )
 {
     QString prop = p.qstring();
@@ -76,9 +78,9 @@
   parentRule		DOMCSSStyleDeclaration::ParentRule	DontDelete|ReadOnly
 @end
 */
-DEFINE_PROTOTYPE("DOMCSSStyleDeclaration", DOMCSSStyleDeclarationProto)
+KJS_DEFINE_PROTOTYPE(DOMCSSStyleDeclarationProto)
 IMPLEMENT_PROTOFUNC_DOM(DOMCSSStyleDeclarationProtoFunc)
-IMPLEMENT_PROTOTYPE(DOMCSSStyleDeclarationProto, DOMCSSStyleDeclarationProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("DOMCSSStyleDeclaration", DOMCSSStyleDeclarationProto, DOMCSSStyleDeclarationProtoFunc)
 
 IMPLEMENT_PSEUDO_CONSTRUCTOR(CSSStyleDeclarationPseudoCtor, "DOMCSSStyleDeclaration",DOMCSSStyleDeclarationProto)
 
@@ -224,7 +226,7 @@
   }
 }
 
-Value KJS::getDOMCSSStyleDeclaration(ExecState *exec, const DOM::CSSStyleDeclaration& s)
+Value getDOMCSSStyleDeclaration(ExecState *exec, const DOM::CSSStyleDeclaration& s)
 {
   return cacheDOMObject<DOM::CSSStyleDeclaration, KJS::DOMCSSStyleDeclaration>(exec, s);
 }
@@ -289,7 +291,7 @@
     DOMObject::tryPut(exec, propertyName, value, attr);
 }
 
-Value KJS::getDOMStyleSheet(ExecState *exec, const DOM::StyleSheet& ss)
+Value getDOMStyleSheet(ExecState *exec, const DOM::StyleSheet& ss)
 {
   DOMObject *ret;
   if (ss.isNull())
@@ -406,7 +408,7 @@
   return Undefined();
 }
 
-Value KJS::getDOMStyleSheetList(ExecState *exec, const DOM::StyleSheetList& ssl, const DOM::Document& doc)
+Value getDOMStyleSheetList(ExecState *exec, const DOM::StyleSheetList& ssl, const DOM::Document& doc)
 {
   // Can't use the cacheDOMObject macro because of the doc argument
   DOMObject *ret;
@@ -446,9 +448,9 @@
   appendMedium	DOMMediaList::AppendMedium	DontDelete|Function 1
 @end
 */
-DEFINE_PROTOTYPE("DOMMediaList", DOMMediaListProto)
+KJS_DEFINE_PROTOTYPE(DOMMediaListProto)
 IMPLEMENT_PROTOFUNC_DOM(DOMMediaListProtoFunc)
-IMPLEMENT_PROTOTYPE(DOMMediaListProto, DOMMediaListProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("DOMMediaList", DOMMediaListProto, DOMMediaListProtoFunc)
 
 DOMMediaList::DOMMediaList(ExecState *exec, const DOM::MediaList& ml)
   : DOMObject(DOMMediaListProto::self(exec)), mediaList(ml) { }
@@ -481,7 +483,7 @@
     DOMObject::tryPut(exec, propertyName, value, attr);
 }
 
-Value KJS::getDOMMediaList(ExecState *exec, const DOM::MediaList& ml)
+Value getDOMMediaList(ExecState *exec, const DOM::MediaList& ml)
 {
   return cacheDOMObject<DOM::MediaList, KJS::DOMMediaList>(exec, ml);
 }
@@ -523,9 +525,9 @@
   removeRule	DOMCSSStyleSheet::RemoveRule	DontDelete|Function 1
 @end
 */
-DEFINE_PROTOTYPE("DOMCSSStyleSheet",DOMCSSStyleSheetProto)
+KJS_DEFINE_PROTOTYPE(DOMCSSStyleSheetProto)
 IMPLEMENT_PROTOFUNC_DOM(DOMCSSStyleSheetProtoFunc)
-IMPLEMENT_PROTOTYPE(DOMCSSStyleSheetProto,DOMCSSStyleSheetProtoFunc) // warning, use _WITH_PARENT if DOMStyleSheet gets a proto
+KJS_IMPLEMENT_PROTOTYPE("DOMCSSStyleSheet",DOMCSSStyleSheetProto,DOMCSSStyleSheetProtoFunc) // warning, use _WITH_PARENT if DOMStyleSheet gets a proto
 
 DOMCSSStyleSheet::DOMCSSStyleSheet(ExecState *exec, const DOM::CSSStyleSheet& ss)
   : DOMStyleSheet(DOMCSSStyleSheetProto::self(exec),ss) { }
@@ -625,7 +627,7 @@
   }
 }
 
-Value KJS::getDOMCSSRuleList(ExecState *exec, const DOM::CSSRuleList& rl)
+Value getDOMCSSRuleList(ExecState *exec, const DOM::CSSRuleList& rl)
 {
   return cacheDOMObject<DOM::CSSRuleList, KJS::DOMCSSRuleList>(exec, rl);
 }
@@ -832,7 +834,7 @@
   return Undefined();
 }
 
-Value KJS::getDOMCSSRule(ExecState *exec, const DOM::CSSRule& r)
+Value getDOMCSSRule(ExecState *exec, const DOM::CSSRule& r)
 {
   return cacheDOMObject<DOM::CSSRule, KJS::DOMCSSRule>(exec, r);
 }
@@ -840,7 +842,7 @@
 // -------------------------------------------------------------------------
 
 
-DOM::CSSRule KJS::toCSSRule(const Value& val)
+DOM::CSSRule toCSSRule(const Value& val)
 {
   Object obj = Object::dynamicCast(val);
   if (!obj.isValid() || !obj.inherits(&DOMCSSRule::info))
@@ -896,7 +898,7 @@
   return Value();
 }
 
-Value KJS::getCSSRuleConstructor(ExecState *exec)
+Value getCSSRuleConstructor(ExecState *exec)
 {
   return cacheGlobalObject<CSSRuleConstructor>( exec, "[[cssRule.constructor]]" );
 }
@@ -939,7 +941,7 @@
     DOMObject::tryPut(exec, propertyName, value, attr);
 }
 
-Value KJS::getDOMCSSValue(ExecState *exec, const DOM::CSSValue& v)
+Value getDOMCSSValue(ExecState *exec, const DOM::CSSValue& v)
 {
   DOMObject *ret;
   if (v.isNull())
@@ -996,7 +998,7 @@
   return Value();
 }
 
-Value KJS::getCSSValueConstructor(ExecState *exec)
+Value getCSSValueConstructor(ExecState *exec)
 {
   return cacheGlobalObject<CSSValueConstructor>( exec, "[[cssValue.constructor]]" );
 }
@@ -1018,9 +1020,9 @@
   getRGBColorValue	DOMCSSPrimitiveValue::GetRGBColorValue	DontDelete|Function 0
 @end
 */
-DEFINE_PROTOTYPE("DOMCSSPrimitiveValue",DOMCSSPrimitiveValueProto)
+KJS_DEFINE_PROTOTYPE(DOMCSSPrimitiveValueProto)
 IMPLEMENT_PROTOFUNC_DOM(DOMCSSPrimitiveValueProtoFunc)
-IMPLEMENT_PROTOTYPE(DOMCSSPrimitiveValueProto,DOMCSSPrimitiveValueProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("DOMCSSPrimitiveValue",DOMCSSPrimitiveValueProto,DOMCSSPrimitiveValueProtoFunc)
 
 DOMCSSPrimitiveValue::DOMCSSPrimitiveValue(ExecState *exec, const DOM::CSSPrimitiveValue& v)
   : DOMCSSValue(DOMCSSPrimitiveValueProto::self(exec), v) { }
@@ -1104,7 +1106,7 @@
   return Number(token);
 }
 
-Value KJS::getCSSPrimitiveValueConstructor(ExecState *exec)
+Value getCSSPrimitiveValueConstructor(ExecState *exec)
 {
   return cacheGlobalObject<CSSPrimitiveValueConstructor>( exec, "[[cssPrimitiveValue.constructor]]" );
 }
@@ -1197,7 +1199,7 @@
   }
 }
 
-Value KJS::getDOMRGBColor(ExecState *exec, const DOM::RGBColor& c)
+Value getDOMRGBColor(ExecState *exec, const DOM::RGBColor& c)
 {
   // ### implement equals for RGBColor since they're not refcounted objects
   return Value(new DOMRGBColor(exec, c));
@@ -1247,7 +1249,7 @@
   }
 }
 
-Value KJS::getDOMRect(ExecState *exec, const DOM::Rect& r)
+Value getDOMRect(ExecState *exec, const DOM::Rect& r)
 {
   return cacheDOMObject<DOM::Rect, KJS::DOMRect>(exec, r);
 }
@@ -1292,7 +1294,9 @@
   }
 }
 
-Value KJS::getDOMCounter(ExecState *exec, const DOM::Counter& c)
+Value getDOMCounter(ExecState *exec, const DOM::Counter& c)
 {
   return cacheDOMObject<DOM::Counter, KJS::DOMCounter>(exec, c);
 }
+
+} //namespace KJS
Index: khtml/ecma/xmlhttprequest.cpp
===================================================================
--- khtml/ecma/xmlhttprequest.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/ecma/xmlhttprequest.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -50,9 +50,10 @@
                             "delete,head,trace,put,propfind,proppatch,"\
                             "mkcol,lock,unlock,options,via"
 
-using namespace KJS;
 using khtml::Decoder;
 
+namespace KJS {
+
 ////////////////////// XMLHttpRequest Object ////////////////////////
 
 /* Source for XMLHttpRequestProtoTable.
@@ -65,11 +66,10 @@
   setRequestHeader	XMLHttpRequest::SetRequestHeader	DontDelete|Function 2
 @end
 */
-DEFINE_PROTOTYPE("XMLHttpRequest",XMLHttpRequestProto)
+KJS_DEFINE_PROTOTYPE(XMLHttpRequestProto)
 IMPLEMENT_PROTOFUNC_DOM(XMLHttpRequestProtoFunc)
-IMPLEMENT_PROTOTYPE(XMLHttpRequestProto,XMLHttpRequestProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("XMLHttpRequest", XMLHttpRequestProto,XMLHttpRequestProtoFunc)
 
-namespace KJS {
 
 XMLHttpRequestQObject::XMLHttpRequestQObject(XMLHttpRequest *_jsObject)
 {
@@ -761,4 +761,5 @@
 
 } // end namespace
 
+
 #include "xmlhttprequest.moc"
Index: khtml/ecma/kjs_traversal.cpp
===================================================================
--- khtml/ecma/kjs_traversal.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/ecma/kjs_traversal.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -28,7 +28,7 @@
 #include <khtml_part.h>
 #include <kdebug.h>
 
-using namespace KJS;
+namespace KJS {
 
 // -------------------------------------------------------------------------
 
@@ -46,9 +46,9 @@
   detach	DOMNodeIterator::Detach		DontDelete|Function 0
 @end
 */
-DEFINE_PROTOTYPE("DOMNodeIterator",DOMNodeIteratorProto)
+KJS_DEFINE_PROTOTYPE(DOMNodeIteratorProto)
 IMPLEMENT_PROTOFUNC_DOM(DOMNodeIteratorProtoFunc)
-IMPLEMENT_PROTOTYPE(DOMNodeIteratorProto,DOMNodeIteratorProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("DOMNodeIterator", DOMNodeIteratorProto,DOMNodeIteratorProtoFunc)
 
 DOMNodeIterator::DOMNodeIterator(ExecState *exec, DOM::NodeIterator ni)
   : DOMObject(DOMNodeIteratorProto::self(exec)), nodeIterator(ni) {}
@@ -97,7 +97,7 @@
   return Undefined();
 }
 
-Value KJS::getDOMNodeIterator(ExecState *exec, DOM::NodeIterator ni)
+Value getDOMNodeIterator(ExecState *exec, DOM::NodeIterator ni)
 {
   return cacheDOMObject<DOM::NodeIterator, DOMNodeIterator>(exec, ni);
 }
@@ -143,7 +143,7 @@
   return Number(token);
 }
 
-Value KJS::getNodeFilterConstructor(ExecState *exec)
+Value getNodeFilterConstructor(ExecState *exec)
 {
   return cacheGlobalObject<NodeFilterConstructor>(exec, "[[nodeFilter.constructor]]");
 }
@@ -156,9 +156,9 @@
   acceptNode	DOMNodeFilter::AcceptNode	DontDelete|Function 0
 @end
 */
-DEFINE_PROTOTYPE("DOMNodeFilter",DOMNodeFilterProto)
+KJS_DEFINE_PROTOTYPE(DOMNodeFilterProto)
 IMPLEMENT_PROTOFUNC_DOM(DOMNodeFilterProtoFunc)
-IMPLEMENT_PROTOTYPE(DOMNodeFilterProto,DOMNodeFilterProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("DOMNodeFilter",DOMNodeFilterProto,DOMNodeFilterProtoFunc)
 
 DOMNodeFilter::DOMNodeFilter(ExecState *exec, DOM::NodeFilter nf)
   : DOMObject(DOMNodeFilterProto::self(exec)), nodeFilter(nf) {}
@@ -179,7 +179,7 @@
   return Undefined();
 }
 
-Value KJS::getDOMNodeFilter(ExecState *exec, DOM::NodeFilter nf)
+Value getDOMNodeFilter(ExecState *exec, DOM::NodeFilter nf)
 {
   return cacheDOMObject<DOM::NodeFilter, DOMNodeFilter>(exec, nf);
 }
@@ -205,9 +205,9 @@
   nextNode	DOMTreeWalker::NextNode		DontDelete|Function 0
 @end
 */
-DEFINE_PROTOTYPE("DOMTreeWalker",DOMTreeWalkerProto)
+KJS_DEFINE_PROTOTYPE(DOMTreeWalkerProto)
 IMPLEMENT_PROTOFUNC_DOM(DOMTreeWalkerProtoFunc)
-IMPLEMENT_PROTOTYPE(DOMTreeWalkerProto,DOMTreeWalkerProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("DOMTreeWalker", DOMTreeWalkerProto,DOMTreeWalkerProtoFunc)
 
 DOMTreeWalker::DOMTreeWalker(ExecState *exec, DOM::TreeWalker tw)
   : DOMObject(DOMTreeWalkerProto::self(exec)), treeWalker(tw) {}
@@ -275,12 +275,12 @@
   return Undefined();
 }
 
-Value KJS::getDOMTreeWalker(ExecState *exec, DOM::TreeWalker tw)
+Value getDOMTreeWalker(ExecState *exec, DOM::TreeWalker tw)
 {
   return cacheDOMObject<DOM::TreeWalker, DOMTreeWalker>(exec, tw);
 }
 
-DOM::NodeFilter KJS::toNodeFilter(const Value& val)
+DOM::NodeFilter toNodeFilter(const Value& val)
 {
   Object obj = Object::dynamicCast(val);
   if (!obj.isValid() || !obj.inherits(&DOMNodeFilter::info))
@@ -302,7 +302,7 @@
 
 short JSNodeFilter::acceptNode(const DOM::Node &n)
 {
-  KHTMLView *view = static_cast<DOM::DocumentImpl *>( n.handle()->docPtr()->document() )->view();
+  KHTMLView *view = static_cast<DOM::DocumentImpl *>( n.handle()->docPtr() )->view();
   if (!view)
       return DOM::NodeFilter::FILTER_REJECT;
 
@@ -323,3 +323,5 @@
 
   return DOM::NodeFilter::FILTER_REJECT;
 }
+
+} //namespace KJS
Index: khtml/ecma/kjs_html.cpp
===================================================================
--- khtml/ecma/kjs_html.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/ecma/kjs_html.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -62,11 +62,11 @@
 
 #include <kdebug.h>
 
-using namespace KJS;
+namespace KJS {
 
-DEFINE_PROTOTYPE("HTMLDocument",HTMLDocumentProto)
+KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(HTMLDocumentProto, DOMDocumentProto)
 IMPLEMENT_PROTOFUNC_DOM(HTMLDocFunction)
-IMPLEMENT_PROTOTYPE_WITH_PARENT(HTMLDocumentProto,HTMLDocFunction,DOMDocumentProto)
+KJS_IMPLEMENT_PROTOTYPE("HTMLDocument", HTMLDocumentProto, HTMLDocFunction)
 
 IMPLEMENT_PSEUDO_CONSTRUCTOR(HTMLDocumentPseudoCtor, "HTMLDocument", HTMLDocumentProto)
 
@@ -3082,9 +3082,9 @@
   tags		HTMLCollection::Tags		DontDelete|Function 1
 @end
 */
-DEFINE_PROTOTYPE("HTMLCollection", HTMLCollectionProto)
+KJS_DEFINE_PROTOTYPE(HTMLCollectionProto)
 IMPLEMENT_PROTOFUNC_DOM(HTMLCollectionProtoFunc)
-IMPLEMENT_PROTOTYPE(HTMLCollectionProto,HTMLCollectionProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("HTMLCollection", HTMLCollectionProto,HTMLCollectionProtoFunc)
 
 const ClassInfo KJS::HTMLCollection::info = { "HTMLCollection", 0, 0, 0 };
 
@@ -3340,9 +3340,9 @@
   add		HTMLSelectCollection::Add		DontDelete|Function 2
 @end
 */
-DEFINE_PROTOTYPE("HTMLOptionsCollection", HTMLSelectCollectionProto)
+KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(HTMLSelectCollectionProto, HTMLCollectionProto)
 IMPLEMENT_PROTOFUNC_DOM(HTMLSelectCollectionProtoFunc)
-IMPLEMENT_PROTOTYPE_WITH_PARENT(HTMLSelectCollectionProto,HTMLSelectCollectionProtoFunc,HTMLCollectionProto)
+KJS_IMPLEMENT_PROTOTYPE("HTMLOptionsCollection",  HTMLSelectCollectionProto, HTMLSelectCollectionProtoFunc)
 
 const ClassInfo KJS::HTMLSelectCollection::info = { "HTMLOptionsCollection", &HTMLCollection::info, 0, 0 };
 
@@ -3561,7 +3561,7 @@
   return Object::dynamicCast(getDOMNode(exec,image));
 }
 
-Value KJS::getHTMLCollection(ExecState *exec, const DOM::HTMLCollection& c, bool hide)
+Value getHTMLCollection(ExecState *exec, const DOM::HTMLCollection& c, bool hide)
 {
   Value coll = cacheDOMObject<DOM::HTMLCollection, KJS::HTMLCollection>(exec, c);
   if (hide) {
@@ -3571,7 +3571,7 @@
   return coll;
 }
 
-Value KJS::getSelectHTMLCollection(ExecState *exec, const DOM::HTMLCollection& c, const DOM::HTMLSelectElement& e)
+Value getSelectHTMLCollection(ExecState *exec, const DOM::HTMLCollection& c, const DOM::HTMLSelectElement& e)
 {
   DOMObject *ret;
   if (c.isNull())
@@ -3585,3 +3585,5 @@
     return Value(ret);
   }
 }
+
+} //namespace KJS
Index: khtml/ecma/kjs_events.cpp
===================================================================
--- khtml/ecma/kjs_events.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/ecma/kjs_events.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -34,9 +34,10 @@
 
 #include <kdebug.h>
 
-using namespace KJS;
 using namespace DOM;
 
+namespace KJS {
+
 // -------------------------------------------------------------------------
 
 JSEventListener::JSEventListener(Object _listener, ObjectImp *_compareListenerImp, const Object &_win, bool _html)
@@ -243,9 +244,9 @@
   initEvent		DOMEvent::InitEvent		DontDelete|Function 3
 @end
 */
-DEFINE_PROTOTYPE("DOMEvent", DOMEventProto)
+KJS_DEFINE_PROTOTYPE(DOMEventProto)
 IMPLEMENT_PROTOFUNC_DOM(DOMEventProtoFunc)
-IMPLEMENT_PROTOTYPE(DOMEventProto, DOMEventProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("DOMEvent", DOMEventProto, DOMEventProtoFunc)
 
 DOMEvent::DOMEvent(ExecState *exec, DOM::Event e)
   : DOMObject(DOMEventProto::self(exec)), event(e) { }
@@ -344,7 +345,7 @@
   return Undefined();
 }
 
-Value KJS::getDOMEvent(ExecState *exec, DOM::Event e)
+Value getDOMEvent(ExecState *exec, DOM::Event e)
 {
   DOM::EventImpl *ei = e.handle();
   if (!ei)
@@ -371,7 +372,7 @@
   return Value(ret);
 }
 
-DOM::Event KJS::toEvent(const Value& val)
+DOM::Event toEvent(const Value& val)
 {
   Object obj = Object::dynamicCast(val);
   if (!obj.isValid() || !obj.inherits(&DOMEvent::info))
@@ -406,7 +407,8 @@
   CHANGE        32768               DontDelete|ReadOnly
 @end
 */
-CREATE_CONSTANT_TABLE(EventConstants, "EventConstants")
+DEFINE_CONSTANT_TABLE(EventConstants)
+IMPLEMENT_CONSTANT_TABLE(EventConstants, "EventConstants")
 
 IMPLEMENT_PSEUDO_CONSTRUCTOR_WITH_PARENT(EventConstructor, "EventConstructor", DOMEventProto, EventConstants)
 // -------------------------------------------------------------------------
@@ -434,7 +436,7 @@
   return Number(token);
 }
 
-Value KJS::getEventExceptionConstructor(ExecState *exec)
+Value getEventExceptionConstructor(ExecState *exec)
 {
   return cacheGlobalObject<EventExceptionConstructor>(exec, "[[eventException.constructor]]");
 }
@@ -458,9 +460,9 @@
   initUIEvent	DOMUIEvent::InitUIEvent	DontDelete|Function 5
 @end
 */
-DEFINE_PROTOTYPE("DOMUIEvent",DOMUIEventProto)
+KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(DOMUIEventProto, DOMEventProto)
 IMPLEMENT_PROTOFUNC_DOM(DOMUIEventProtoFunc)
-IMPLEMENT_PROTOTYPE_WITH_PARENT(DOMUIEventProto,DOMUIEventProtoFunc,DOMEventProto)
+KJS_IMPLEMENT_PROTOTYPE("DOMUIEvent", DOMUIEventProto, DOMUIEventProtoFunc)
 
 DOMUIEvent::DOMUIEvent(ExecState *exec, DOM::UIEvent ue) :
   DOMEvent(DOMUIEventProto::self(exec), ue) {}
@@ -556,9 +558,9 @@
   initMouseEvent	DOMMouseEvent::InitMouseEvent	DontDelete|Function 15
 @end
 */
-DEFINE_PROTOTYPE("DOMMouseEvent",DOMMouseEventProto)
+KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(DOMMouseEventProto, DOMUIEventProto)
 IMPLEMENT_PROTOFUNC_DOM(DOMMouseEventProtoFunc)
-IMPLEMENT_PROTOTYPE_WITH_PARENT(DOMMouseEventProto,DOMMouseEventProtoFunc,DOMUIEventProto)
+KJS_IMPLEMENT_PROTOTYPE("DOMMouseEvent", DOMMouseEventProto, DOMMouseEventProtoFunc)
 
 DOMMouseEvent::DOMMouseEvent(ExecState *exec, DOM::MouseEvent me) :
   DOMUIEvent(DOMMouseEventProto::self(exec), me) {}
@@ -602,7 +604,7 @@
     if ( rend ) {
       int xPos, yPos;
       if ( rend->absolutePosition( xPos, yPos ) ) {
-        kdDebug() << "DOMMouseEvent::getValueProperty rend=" << rend << "  xPos=" << xPos << "  yPos=" << yPos << endl;
+        //kdDebug() << "DOMMouseEvent::getValueProperty rend=" << rend << "  xPos=" << xPos << "  yPos=" << yPos << endl;
         x -= xPos;
         y -= yPos;
       }
@@ -744,9 +746,9 @@
   # Missing: initTextEventNS
 @end
 */
-DEFINE_PROTOTYPE("DOMTextEvent",DOMTextEventProto)
+KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(DOMTextEventProto, DOMUIEventProto) //Note: no proto in KeyBase
 IMPLEMENT_PROTOFUNC_DOM(DOMTextEventProtoFunc)
-IMPLEMENT_PROTOTYPE_WITH_PARENT(DOMTextEventProto,DOMTextEventProtoFunc,DOMUIEventProto) //Note: no proto in KeyBase
+KJS_IMPLEMENT_PROTOTYPE("DOMTextEvent", DOMTextEventProto, DOMTextEventProtoFunc)
 
 DOMTextEvent::DOMTextEvent(ExecState *exec, DOM::TextEvent ke) :
   DOMKeyEventBase(DOMTextEventProto::self(exec), ke) {}
@@ -804,9 +806,9 @@
   getModifierState      DOMKeyboardEvent::GetModifierState      DontDelete|Function 1
 @end
 */
-DEFINE_PROTOTYPE("DOMKeyboardEvent",DOMKeyboardEventProto)
+KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(DOMKeyboardEventProto, DOMUIEventProto) //Note: no proto in KeyBase
 IMPLEMENT_PROTOFUNC_DOM(DOMKeyboardEventProtoFunc)
-IMPLEMENT_PROTOTYPE_WITH_PARENT(DOMKeyboardEventProto,DOMKeyboardEventProtoFunc,DOMUIEventProto) //Note: no proto in KeyBase
+KJS_IMPLEMENT_PROTOTYPE("DOMKeyboardEvent", DOMKeyboardEventProto, DOMKeyboardEventProtoFunc)
 
 DOMKeyboardEvent::DOMKeyboardEvent(ExecState *exec, DOM::TextEvent ke) :
   DOMKeyEventBase(DOMKeyboardEventProto::self(exec), ke) {}
@@ -882,7 +884,7 @@
   return Number(token);
 }
 
-Value KJS::getKeyboardEventConstructor(ExecState *exec)
+Value getKeyboardEventConstructor(ExecState *exec)
 {
   return cacheGlobalObject<KeyboardEventConstructor>(exec, "[[keyboardEvent.constructor]]");
 }
@@ -913,7 +915,7 @@
   return Number(token);
 }
 
-Value KJS::getMutationEventConstructor(ExecState *exec)
+Value getMutationEventConstructor(ExecState *exec)
 {
   return cacheGlobalObject<MutationEventConstructor>(exec, "[[mutationEvent.constructor]]");
 }
@@ -933,9 +935,9 @@
   initMutationEvent	DOMMutationEvent::InitMutationEvent	DontDelete|Function 8
 @end
 */
-DEFINE_PROTOTYPE("DOMMutationEvent",DOMMutationEventProto)
+KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(DOMMutationEventProto, DOMEventProto)
 IMPLEMENT_PROTOFUNC_DOM(DOMMutationEventProtoFunc)
-IMPLEMENT_PROTOTYPE_WITH_PARENT(DOMMutationEventProto,DOMMutationEventProtoFunc,DOMEventProto)
+KJS_IMPLEMENT_PROTOTYPE("DOMMutationEvent", DOMMutationEventProto, DOMMutationEventProtoFunc)
 
 DOMMutationEvent::DOMMutationEvent(ExecState *exec, DOM::MutationEvent me) :
   DOMEvent(DOMMutationEventProto::self(exec), me) {}
@@ -986,3 +988,5 @@
   }
   return Undefined();
 }
+
+} //namespace KJS
Index: khtml/ecma/kjs_window.cpp
===================================================================
--- khtml/ecma/kjs_window.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/ecma/kjs_window.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -130,7 +130,7 @@
 #include "rendering/render_replaced.h"
 
 ////////////////////// Screen Object ////////////////////////
-
+namespace KJS {
 // table for screen object
 /*
 @begin ScreenTable 7
@@ -2734,5 +2734,6 @@
 
 #endif
 /////////////////////////////////////////////////////////////////////////////
+} //namespace KJS
 
 #include "kjs_window.moc"
Index: khtml/ecma/kjs_dom.h
===================================================================
--- khtml/ecma/kjs_dom.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/ecma/kjs_dom.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -29,7 +29,6 @@
 
 #include "ecma/kjs_binding.h"
 
-PUBLIC_DEFINE_PROTOTYPE("DOMDocument", DOMDocumentProto)
 
 namespace KJS {
 
@@ -74,6 +73,10 @@
     DOM::Node node;
   };
 
+  DEFINE_CONSTANT_TABLE(DOMNodeConstants)
+  KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(DOMNodeProto, DOMNodeConstants)
+  DEFINE_PSEUDO_CONSTRUCTOR(NodeConstructor)
+
   class DOMNodeList : public DOMObject {
   public:
     DOMNodeList(ExecState *, const DOM::NodeList& l);
@@ -118,6 +121,8 @@
            CreateEvent, StyleSheets, GetOverrideStyle, Abort, Load, LoadXML,
            PreferredStylesheetSet, SelectedStylesheetSet, ReadyState, Async };
   };
+  
+  KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(DOMDocumentProto, DOMNodeProto)
 
   DEFINE_PSEUDO_CONSTRUCTOR(DocumentPseudoCtor)
 
@@ -149,7 +154,8 @@
            GetAttributeNS, SetAttributeNS, RemoveAttributeNS, GetAttributeNodeNS,
            SetAttributeNodeNS, GetElementsByTagNameNS, HasAttribute, HasAttributeNS };
   };
-
+  
+  KJS_DEFINE_PROTOTYPE_WITH_PROTOTYPE(DOMElementProto, DOMNodeProto)
   DEFINE_PSEUDO_CONSTRUCTOR(ElementPseudoCtor)
 
   class DOMDOMImplementation : public DOMObject {
@@ -229,8 +235,6 @@
     enum { PublicId, SystemId, NotationName };
   };
 
-  DEFINE_PSEUDO_CONSTRUCTOR(NodeConstructor)
-
   // Constructor for DOMException - constructor stuff not implemented yet
   class DOMExceptionConstructor : public DOMObject {
   public:
@@ -278,7 +282,7 @@
     enum { Data, Length,
            SubstringData, AppendData, InsertData, DeleteData, ReplaceData };
   };
-
+  
   class DOMText : public DOMCharacterData {
   public:
     DOMText(ExecState *exec, const DOM::Text& t);
Index: khtml/ecma/domparser.cpp
===================================================================
--- khtml/ecma/domparser.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/ecma/domparser.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -38,13 +38,13 @@
 @end
 */
 
-using namespace KJS;
 
-DEFINE_PROTOTYPE("DOMParser",DOMParserProto)
+namespace KJS {
+
+KJS_DEFINE_PROTOTYPE(DOMParserProto)
 IMPLEMENT_PROTOFUNC_DOM(DOMParserProtoFunc)
-IMPLEMENT_PROTOTYPE(DOMParserProto,DOMParserProtoFunc)
+KJS_IMPLEMENT_PROTOTYPE("DOMParser", DOMParserProto, DOMParserProtoFunc)
 
-namespace KJS {
 
 DOMParserConstructorImp::DOMParserConstructorImp(ExecState *, DOM::DocumentImpl *d)
     : doc(d)
Index: khtml/rendering/render_style.cpp
===================================================================
--- khtml/rendering/render_style.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/rendering/render_style.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -658,7 +658,7 @@
     if (noninherited_flags.f._styleType==NOPSEUDO)
         for (ps = pseudoStyle; ps; ps = ps->pseudoStyle)
             if (ps->noninherited_flags.f._styleType==pid)
-		break;
+                break;
     return ps;
 }
 
Index: khtml/rendering/table_layout.cpp
===================================================================
--- khtml/rendering/table_layout.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/rendering/table_layout.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -233,7 +233,10 @@
     // unlimited.
 
     int bs = table->bordersPaddingAndSpacing();
-    int tableWidth = table->style()->width().isFixed() ? table->style()->width().value() - bs : 0;
+    int tableWidth = 0;
+    if (table->style()->width().isFixed()) {
+        tableWidth = table->calcBoxWidth(table->style()->width().value());
+    }
 
     int mw = calcWidthArray() + bs;
     table->m_minWidth = kMin( kMax( mw, tableWidth ), 0x7fff );
@@ -599,7 +602,8 @@
 
     Length tw = table->style()->width();
     if ( tw.isFixed() && tw.value() > 0 ) {
-	minWidth = kMax( minWidth, int( tw.value() ) );
+        int width = table->calcBoxWidth(tw.value());
+        minWidth = kMax( minWidth, width );
 	maxWidth = minWidth;
     }
 
Index: khtml/rendering/render_table.h
===================================================================
--- khtml/rendering/render_table.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/rendering/render_table.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -73,6 +73,10 @@
     int borderRight() const;
     int borderTop() const;
     int borderBottom() const;
+    int paddingLeft() const { return collapseBorders() ? 0 : RenderBlock::paddingLeft(); }
+    int paddingRight() const { return collapseBorders() ? 0 : RenderBlock::paddingRight(); }
+    int paddingTop() const { return collapseBorders() ? 0 : RenderBlock::paddingTop(); }
+    int paddingBottom() const { return collapseBorders() ? 0 : RenderBlock::paddingBottom(); }
 
     const QColor &bgColor() const { return style()->backgroundColor(); }
 
@@ -244,6 +248,11 @@
     virtual int leftmostPosition(bool includeOverflowInterior, bool includeSelf) const;
     virtual int highestPosition(bool includeOverflowInterior, bool includeSelf) const;
 
+    int borderLeft() const { return table()->collapseBorders() ? 0 : RenderBox::borderLeft(); }
+    int borderRight() const { return table()->collapseBorders() ? 0 : RenderBox::borderRight(); }
+    int borderTop() const { return table()->collapseBorders() ? 0 : RenderBox::borderTop(); }
+    int borderBottom() const { return table()->collapseBorders() ? 0 : RenderBox::borderBottom(); }
+
     virtual void paint( PaintInfo& i, int tx, int ty);
 
     int numRows() const { return grid.size(); }
Index: khtml/rendering/render_table.cpp
===================================================================
--- khtml/rendering/render_table.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/rendering/render_table.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -233,27 +233,33 @@
     RenderBlock *cb = containingBlock();
     int availableWidth = cb->contentWidth();
 
-    // Subtract minimum margins
-    availableWidth -= style()->marginLeft().minWidth(cb->contentWidth());
-    availableWidth -= style()->marginRight().minWidth(cb->contentWidth());
-
     LengthType widthType = style()->width().type();
     if(widthType > Relative && style()->width().value() > 0) {
 	// Percent or fixed table
-        m_width = style()->width().minWidth( availableWidth );
+        m_width = calcBoxWidth(style()->width().minWidth( availableWidth ));
         if(m_minWidth > m_width) m_width = m_minWidth;
     } else {
-        m_width = KMIN(short( availableWidth ), short(m_maxWidth));
+        // Subtract out any fixed margins from our available width for auto width tables.
+        int marginTotal = 0;
+        if (!style()->marginLeft().isVariable())
+            marginTotal += style()->marginLeft().width(availableWidth);
+        if (!style()->marginRight().isVariable())
+            marginTotal += style()->marginRight().width(availableWidth);
+
+        // Subtract out our margins to get the available content width.
+        int availContentWidth = kMax(0, availableWidth - marginTotal);
+
+        // Ensure we aren't bigger than our max width or smaller than our min width.
+        m_width = kMin(availContentWidth, m_maxWidth);
     }
 
     // restrict width to what we really have
     // EXCEPT percent tables, which are still calculated as above
-
     availableWidth = cb->lineWidth( m_y );
     if ( widthType != Percent )
-        m_width = KMIN( short( availableWidth ), m_width );
+        m_width = kMin( short( availableWidth ), m_width );
 
-    m_width = KMAX (m_width, m_minWidth);
+    m_width = kMax (m_width, m_minWidth);
 
     // Finally, with our true width determined, compute our margins for real.
     m_marginRight=0;
Index: khtml/rendering/render_box.cpp
===================================================================
--- khtml/rendering/render_box.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/rendering/render_box.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -568,24 +568,26 @@
             calculateBackgroundSize(bgLayer, scaledImageWidth, scaledImageHeight);
             EBackgroundRepeat bgr = bgLayer->backgroundRepeat();
 
-            if( (bgr == NO_REPEAT || bgr == REPEAT_Y) && pw > scaledImageWidth ) {
-                cw = scaledImageWidth;
-                cx = vr.x() + bgLayer->backgroundXPosition().minWidth(pw - scaledImageWidth);
+            int xPosition = bgLayer->backgroundXPosition().minWidth(pw-scaledImageWidth);
+            if (bgr == NO_REPEAT || bgr == REPEAT_Y) {
+                cw = kMin(scaledImageWidth, pw - xPosition);
+                cx = vr.x() + xPosition;
             } else {
                 cw = pw;
                 cx = vr.x();
                 if (scaledImageWidth > 0)
-                    sx = scaledImageWidth - bgLayer->backgroundXPosition().minWidth(pw - scaledImageWidth) % scaledImageWidth;
+                    sx = scaledImageWidth - xPosition % scaledImageWidth;
             }
 
-            if( (bgr == NO_REPEAT || bgr == REPEAT_X) && ph > scaledImageHeight ) {
-                ch = scaledImageHeight;
-                cy = vr.y() + bgLayer->backgroundYPosition().minWidth(ph - scaledImageHeight);
+            int yPosition = bgLayer->backgroundYPosition().minWidth(ph-scaledImageHeight);
+            if (bgr == NO_REPEAT || bgr == REPEAT_X) {
+                ch = kMin(scaledImageHeight, ph - yPosition);
+                cy = vr.y() + yPosition;
             } else {
                 ch = ph;
                 cy = vr.y();
                 if (scaledImageHeight > 0)
-                    sy = scaledImageHeight - bgLayer->backgroundYPosition().minWidth(ph - scaledImageHeight) % scaledImageHeight;
+                    sy = scaledImageHeight - yPosition % scaledImageHeight;
             }
 
             QRect fix(cx, cy, cw, ch);
@@ -1709,10 +1711,6 @@
 
     height += bordersPlusPadding;
 
-    // If our natural/content height exceeds the new height once we've set it, then we
-    // need to make sure to update overflow to track the spillout.
-    if (m_height > height && isRenderBlock())
-        static_cast<RenderBlock*>(this)->setOverflowHeight(m_height);
     // Set final height value.
     m_height = height;
 }
Index: khtml/rendering/render_block.cpp
===================================================================
--- khtml/rendering/render_block.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/rendering/render_block.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -224,7 +224,7 @@
         if(oldText->l >= 1) {
             oldText->ref();
             // begin: we need skip leading whitespace so that RenderBlock::findNextLineBreak
-            // won't think we're continuing from a previous run 
+            // won't think we're continuing from a previous run
             unsigned int begin = 0; // the position that first-letter begins
             unsigned int length = 0; // the position that "the rest" begins
             while ( length < oldText->l && (oldText->s+length)->isSpace() )
@@ -711,7 +711,7 @@
     int toAdd = borderBottom() + paddingBottom();
     if (m_layer && style()->scrollsOverflow() && style()->height().isVariable())
         toAdd += m_layer->horizontalScrollbarHeight();
-    if ( hasOverhangingFloats() && !style()->scrollsOverflow() && (isFloatingOrPositioned() || flowAroundFloats()) )
+    if ( hasOverhangingFloats() && (isFloatingOrPositioned() || flowAroundFloats()) )
         m_overflowHeight = m_height = floatBottom() + toAdd;
 
     int oldHeight = m_height;
@@ -930,7 +930,7 @@
         RenderObject* compactChild = compactInfo.compact();
         if (compactChild->height() > child->height())
             m_height += compactChild->height() - child->height();
-    } 
+    }
 }
 
 void RenderBlock::insertCompactIfNeeded(RenderObject* child, CompactInfo& compactInfo)
Index: khtml/khtml_ext.h
===================================================================
--- khtml/khtml_ext.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/khtml_ext.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -160,7 +160,7 @@
             const char *slot, QObject *parent, const char *name );
     virtual ~KHTMLZoomFactorAction();
 
-    virtual int plug( QWidget *w, int index );
+    virtual int plug( QWidget *widget, int index );
 
 private slots:
     void slotActivated( int );
Index: khtml/css/css_renderstyledeclarationimpl.h
===================================================================
--- khtml/css/css_renderstyledeclarationimpl.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/css/css_renderstyledeclarationimpl.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -1,4 +1,4 @@
-/**
+/*
  * css_renderstyleimpl.h
  *
  * Copyright (C)  2004  Zack Rusin <zack@kde.org>
Index: khtml/css/css_renderstyledeclarationimpl.cpp
===================================================================
--- khtml/css/css_renderstyledeclarationimpl.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/css/css_renderstyledeclarationimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -330,12 +330,12 @@
 RenderStyleDeclarationImpl::RenderStyleDeclarationImpl( DOM::NodeImpl *node )
     : CSSStyleDeclarationImpl(0), m_node(node)
 {
-    kdDebug() << "Render Style Declaration created" << endl;
+    //kdDebug() << "Render Style Declaration created" << endl;
 }
 
 RenderStyleDeclarationImpl::~RenderStyleDeclarationImpl()
 {
-    kdDebug() << "Render Style Declaration destroyed" << endl;
+    //kdDebug() << "Render Style Declaration destroyed" << endl;
 }
 
 DOM::DOMString RenderStyleDeclarationImpl::cssText() const
Index: khtml/css/cssstyleselector.cpp
===================================================================
--- khtml/css/cssstyleselector.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/css/cssstyleselector.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -1084,30 +1084,29 @@
 
     if(sel->attr)
     {
+        // attributes are always case-sensitive in XHTML
+        // attributes are sometimes case-sensitive in HTML Strict
+        // ### for now we only treat id and class selector as case-sensitive in HTML strict
+        bool caseSensitive = e->getDocument()->htmlMode() == DocumentImpl::XHtml;
+        bool caseSensitive_alt = strictParsing || caseSensitive;
+
         DOMStringImpl* value = e->getAttributeImpl(sel->attr);
         if(!value) return false; // attribute is not set
 
         switch(sel->match)
         {
-        case CSSSelector::Exact:
-            /* attribute values are case insensitive in all HTML modes,
-               even in the strict ones */
-            if ( e->getDocument()->htmlMode() != DocumentImpl::XHtml ) {
-                if ( strcasecmp(sel->value, value) )
-                    return false;
-            } else {
-                if ( strcmp(sel->value, value) )
-                    return false;
-            }
+        case CSSSelector::Set:
+            // True if we make it this far
             break;
         case CSSSelector::Id:
-	    if( (strictParsing && strcmp(sel->value, value) ) ||
-                (!strictParsing && strcasecmp(sel->value, value)))
-                return false;
+            caseSensitive = caseSensitive_alt;
+            // no break
+        case CSSSelector::Exact:
+            return (caseSensitive && !strcmp(sel->value, value)) ||
+                   (!caseSensitive && !strcasecmp(sel->value, value));
             break;
-        case CSSSelector::Set:
-            break;
         case CSSSelector::Class:
+            caseSensitive = caseSensitive_alt;
             // no break
         case CSSSelector::List:
         {
@@ -1118,8 +1117,8 @@
             // Selector string may not contain spaces
             if ((sel->attr != ATTR_CLASS || e->hasClassList()) && sel->value.find(' ') != -1) return false;
             if (sel_len == val_len)
-                return (strictParsing && !strcmp(sel->value, value)) ||
-		       (!strictParsing && !strcasecmp(sel->value, value));
+                return (caseSensitive && !strcmp(sel->value, value)) ||
+		       (!caseSensitive && !strcasecmp(sel->value, value));
             // else the value is longer and can be a list
             if ( sel->match == CSSSelector::Class && !e->hasClassList() ) return false;
 
@@ -1131,7 +1130,7 @@
 
             int pos = 0;
             for ( ;; ) {
-                pos = val_str.string().find(sel_str.string(), pos, strictParsing);
+                pos = val_str.string().find(sel_str.string(), pos, caseSensitive);
                 if ( pos == -1 ) return false;
                 if ( pos == 0 || val_uc[pos-1].isSpace() ) {
                     int endpos = pos + sel_len;
@@ -1147,21 +1146,21 @@
             //kdDebug( 6080 ) << "checking for contains match" << endl;
             QConstString val_str(value->unicode(), value->length());
             QConstString sel_str(sel->value.unicode(), sel->value.length());
-            return val_str.string().contains(sel_str.string());
+            return val_str.string().contains(sel_str.string(), caseSensitive);
         }
         case CSSSelector::Begin:
         {
             //kdDebug( 6080 ) << "checking for beginswith match" << endl;
             QConstString val_str(value->unicode(), value->length());
             QConstString sel_str(sel->value.unicode(), sel->value.length());
-            return val_str.string().startsWith(sel_str.string());
+            return val_str.string().startsWith(sel_str.string(), caseSensitive);
         }
         case CSSSelector::End:
         {
             //kdDebug( 6080 ) << "checking for endswith match" << endl;
             QConstString val_str(value->unicode(), value->length());
             QConstString sel_str(sel->value.unicode(), sel->value.length());
-            return val_str.string().endsWith(sel_str.string());
+            return val_str.string().endsWith(sel_str.string(), caseSensitive);
         }
         case CSSSelector::Hyphen:
         {
@@ -1172,7 +1171,7 @@
             const QString& selStr = sel_str.string();
             if(str.length() < selStr.length()) return false;
             // Check if str begins with selStr:
-            if(str.find(selStr, 0, strictParsing) != 0) return false;
+            if(str.find(selStr, 0, caseSensitive) != 0) return false;
             // It does. Check for exact match or following '-':
             if(str.length() != selStr.length()
                 && str[selStr.length()] != '-') return false;
Index: khtml/misc/shared.h
===================================================================
--- khtml/misc/shared.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/misc/shared.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -1,3 +1,26 @@
+/*
+ * This file is part of the DOM implementation for KDE.
+ * Copyright (C) 2005, 2006 Apple Computer, Inc.
+ * Copyright (C) 2002 Lars Knoll
+ *
+ * This library is free software; you can redistribute it and/or
+ * modify it under the terms of the GNU Library General Public
+ * License as published by the Free Software Foundation; either
+ * version 2 of the License, or (at your option) any later version.
+ *
+ * This library is distributed in the hope that it will be useful,
+ * but WITHOUT ANY WARRANTY; without even the implied warranty of
+ * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
+ * Library General Public License for more details.
+ *
+ * You should have received a copy of the GNU Library General Public License
+ * along with this library; see the file COPYING.LIB.  If not, write to
+ * the Free Software Foundation, Inc., 59 Temple Place - Suite 330,
+ * Boston, MA 02111-1307, USA.
+ *
+ */
+
+
 #ifndef SHARED_H
 #define SHARED_H
 
@@ -30,12 +53,14 @@
     TreeShared() { _ref = 0; m_parent = 0; /*counter++;*/ }
     TreeShared( type *parent ) { _ref=0; m_parent = parent; /*counter++;*/ }
     ~TreeShared() { /*counter--;*/ }
+    
+    virtual void removedLastRef() { delete static_cast<type*>(this); }
 
     void ref() { _ref++;  }
     void deref() {
 	if(_ref) _ref--;
 	if(!_ref && !m_parent) {
-	    delete static_cast<type *>(this);
+	    removedLastRef();
 	}
     }
     bool hasOneRef() { //kdDebug(300) << "ref=" << _ref << endl;
@@ -109,6 +134,95 @@
 template <class T, class U> inline SharedPtr<T> static_pointer_cast(const SharedPtr<U> &p) { return SharedPtr<T>(static_cast<T *>(p.get())); }
 template <class T, class U> inline SharedPtr<T> const_pointer_cast(const SharedPtr<U> &p) { return SharedPtr<T>(const_cast<T *>(p.get())); }
 
+//A special pointer for nodes keeping track of the document,
+//which helps distinguish back links from them to it, in order to break 
+//cycles
+template <class T> class DocPtr {
+public:
+    DocPtr() : m_ptr(0) {}
+    DocPtr(T *ptr) : m_ptr(ptr) { if (ptr) ptr->selfOnlyRef(); }
+    DocPtr(const DocPtr &o) : m_ptr(o.m_ptr) { if (T *ptr = m_ptr) ptr->selfOnlyRef(); }
+    ~DocPtr() { if (T *ptr = m_ptr) ptr->selfOnlyDeref(); }
+    
+    template <class U> DocPtr(const DocPtr<U> &o) : m_ptr(o.get()) { if (T *ptr = m_ptr) ptr->selfOnlyRef(); }
+    
+    void resetSkippingRef(T *o) { m_ptr = o; }
+    
+    T *get() const { return m_ptr; }
+    
+    T &operator*() const { return *m_ptr; }
+    T *operator->() const { return m_ptr; }
+    
+    bool operator!() const { return !m_ptr; }
+
+    // this type conversion operator allows implicit conversion to
+    // bool but not to other integer types
+    
+    typedef T * (DocPtr::*UnspecifiedBoolType)() const;
+    operator UnspecifiedBoolType() const
+    {
+        return m_ptr ? &DocPtr::get : 0;
+    }
+    
+    DocPtr &operator=(const DocPtr &);
+    DocPtr &operator=(T *);
+    
+ private:
+    T *m_ptr;
+};
+
+template <class T> DocPtr<T> &DocPtr<T>::operator=(const DocPtr<T> &o) 
+{
+    T *optr = o.m_ptr;
+    if (optr)
+        optr->selfOnlyRef();
+    if (T *ptr = m_ptr)
+        ptr->selfOnlyDeref();
+    m_ptr = optr;
+        return *this;
+}
+
+template <class T> inline DocPtr<T> &DocPtr<T>::operator=(T *optr)
+{
+    if (optr)
+        optr->selfOnlyRef();
+    if (T *ptr = m_ptr)
+        ptr->selfOnlyDeref();
+    m_ptr = optr;
+    return *this;
+}
+
+template <class T> inline bool operator==(const DocPtr<T> &a, const DocPtr<T> &b) 
+{ 
+    return a.get() == b.get(); 
+}
+
+template <class T> inline bool operator==(const DocPtr<T> &a, const T *b) 
+{ 
+    return a.get() == b; 
+}
+
+template <class T> inline bool operator==(const T *a, const DocPtr<T> &b) 
+{
+    return a == b.get(); 
+}
+
+template <class T> inline bool operator!=(const DocPtr<T> &a, const DocPtr<T> &b) 
+{ 
+    return a.get() != b.get(); 
+}
+
+template <class T> inline bool operator!=(const DocPtr<T> &a, const T *b)
+{
+    return a.get() != b; 
+}
+
+template <class T> inline bool operator!=(const T *a, const DocPtr<T> &b) 
+{ 
+    return a != b.get(); 
+}
+
+
 } // namespace
 
 #endif
Index: khtml/xml/dom2_rangeimpl.cpp
===================================================================
--- khtml/xml/dom2_rangeimpl.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/xml/dom2_rangeimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -35,20 +35,20 @@
 using namespace DOM;
 
 
-RangeImpl::RangeImpl(DocumentPtr *_ownerDocument)
+RangeImpl::RangeImpl(DocumentImpl *_ownerDocument)
 {
     m_ownerDocument = _ownerDocument;
     m_ownerDocument->ref();
-    m_startContainer = _ownerDocument->document();
+    m_startContainer = _ownerDocument;
     m_startContainer->ref();
-    m_endContainer = _ownerDocument->document();
+    m_endContainer = _ownerDocument;
     m_endContainer->ref();
     m_startOffset = 0;
     m_endOffset = 0;
     m_detached = false;
 }
 
-RangeImpl::RangeImpl(DocumentPtr *_ownerDocument,
+RangeImpl::RangeImpl(DocumentImpl *_ownerDocument,
               NodeImpl *_startContainer, long _startOffset,
               NodeImpl *_endContainer, long _endOffset)
 {
@@ -161,7 +161,7 @@
         return;
     }
 
-    if (refNode->getDocument() != m_ownerDocument->document()) {
+    if (refNode->getDocument() != m_ownerDocument) {
         exceptioncode = DOMException::WRONG_DOCUMENT_ERR;
         return;
     }
@@ -199,7 +199,7 @@
         return;
     }
 
-    if (refNode->getDocument() != m_ownerDocument->document()) {
+    if (refNode->getDocument() != m_ownerDocument) {
         exceptioncode = DOMException::WRONG_DOCUMENT_ERR;
         return;
     }
@@ -1270,7 +1270,7 @@
         return;
     }
 
-    if (refNode->getDocument() != m_ownerDocument->document()) {
+    if (refNode->getDocument() != m_ownerDocument) {
         exceptioncode = DOMException::WRONG_DOCUMENT_ERR;
         return;
     }
@@ -1294,7 +1294,7 @@
         return;
     }
 
-    if (refNode->getDocument() != m_ownerDocument->document()) {
+    if (refNode->getDocument() != m_ownerDocument) {
         exceptioncode = DOMException::WRONG_DOCUMENT_ERR;
         return;
     }
@@ -1318,7 +1318,7 @@
         return;
     }
 
-    if (refNode->getDocument() != m_ownerDocument->document()) {
+    if (refNode->getDocument() != m_ownerDocument) {
         exceptioncode = DOMException::WRONG_DOCUMENT_ERR;
         return;
     }
@@ -1527,7 +1527,7 @@
         return;
     }
 
-    if (refNode->getDocument() != m_ownerDocument->document()) {
+    if (refNode->getDocument() != m_ownerDocument) {
         exceptioncode = DOMException::WRONG_DOCUMENT_ERR;
         return;
     }
Index: khtml/xml/xml_tokenizer.h
===================================================================
--- khtml/xml/xml_tokenizer.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/xml/xml_tokenizer.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -42,7 +42,7 @@
     class DocumentImpl;
     class NodeImpl;
     class HTMLScriptElementImpl;
-    class DocumentPtr;
+    class DocumentImpl;
     class HTMLScriptElementImpl;
 }
 
@@ -51,7 +51,7 @@
 class XMLHandler : public QXmlDefaultHandler
 {
 public:
-    XMLHandler(DOM::DocumentPtr *_doc, KHTMLView *_view);
+    XMLHandler(DOM::DocumentImpl *_doc, KHTMLView *_view);
     virtual ~XMLHandler();
 
     // return the error protocol if parsing failed
@@ -100,7 +100,7 @@
     DOM::NodeImpl *currentNode() const;
 private:
     QString errorProt;
-    DOM::DocumentPtr *m_doc;
+    DOM::DocumentImpl *m_doc;
     KHTMLView *m_view;
     QPtrStack<DOM::NodeImpl> m_nodes;
     DOM::NodeImpl *m_rootNode;
@@ -162,7 +162,7 @@
 class XMLTokenizer : public Tokenizer, public khtml::CachedObjectClient
 {
 public:
-    XMLTokenizer(DOM::DocumentPtr *, KHTMLView * = 0);
+    XMLTokenizer(DOM::DocumentImpl *, KHTMLView * = 0);
     virtual ~XMLTokenizer();
     virtual void begin();
     virtual void write( const TokenizerString &str, bool );
@@ -177,7 +177,7 @@
     virtual bool isExecutingScript() const { return false; }
 
 protected:
-    DOM::DocumentPtr *m_doc;
+    DOM::DocumentImpl *m_doc;
     KHTMLView *m_view;
 
     void executeScripts();
Index: khtml/xml/dom2_rangeimpl.h
===================================================================
--- khtml/xml/dom2_rangeimpl.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/xml/dom2_rangeimpl.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -35,8 +35,8 @@
 {
     friend class DocumentImpl;
 public:
-    RangeImpl(DocumentPtr *_ownerDocument);
-    RangeImpl(DocumentPtr *_ownerDocument,
+    RangeImpl(DocumentImpl *_ownerDocument);
+    RangeImpl(DocumentImpl *_ownerDocument,
               NodeImpl *_startContainer, long _startOffset,
               NodeImpl *_endContainer, long _endOffset);
 
@@ -105,7 +105,7 @@
     bool readOnly() { return false; }
 
 protected:
-    DocumentPtr *m_ownerDocument;
+    DocumentImpl *m_ownerDocument;
     NodeImpl *m_startContainer;
     unsigned long m_startOffset;
     NodeImpl *m_endContainer;
Index: khtml/xml/dom_textimpl.cpp
===================================================================
--- khtml/xml/dom_textimpl.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/xml/dom_textimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -42,7 +42,7 @@
     return in.implementation()->escapeHTML();
 }
 
-CharacterDataImpl::CharacterDataImpl(DocumentPtr *doc, DOMStringImpl* _text)
+CharacterDataImpl::CharacterDataImpl(DocumentImpl *doc, DOMStringImpl* _text)
     : NodeImpl(doc)
 {
     str = _text ? _text : new DOMStringImpl(0, 0);
Index: khtml/xml/dom_nodeimpl.cpp
===================================================================
--- khtml/xml/dom_nodeimpl.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/xml/dom_nodeimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -1,4 +1,4 @@
-/**
+/*
  * This file is part of the DOM implementation for KDE.
  *
  * Copyright (C) 1999 Lars Knoll (knoll@kde.org)
@@ -54,8 +54,8 @@
 using namespace DOM;
 using namespace khtml;
 
-NodeImpl::NodeImpl(DocumentPtr *doc)
-    : document(doc),
+NodeImpl::NodeImpl(DocumentImpl *doc)
+    : m_document(doc),
       m_previous(0),
       m_next(0),
       m_render(0),
@@ -77,16 +77,12 @@
       m_hasClassList( false ),
       m_hasClass( false )
 {
-    if (document)
-        document->ref();
 }
 
 NodeImpl::~NodeImpl()
 {
     if (m_render)
         detach();
-    if (document)
-        document->deref();
     if (m_previous)
         m_previous->setNextSibling(0);
     if (m_next)
@@ -341,7 +337,7 @@
     evt->setTarget(this);
 
     // Since event handling code could cause this object to be deleted, grab a reference to the view now
-    KHTMLView *view = document->document()->view();
+    KHTMLView *view = getDocument()->view();
 
     dispatchGenericEvent( evt, exceptioncode );
 
@@ -407,7 +403,7 @@
     }
 
     // copy this over into a local variable, as the following deref() calls might cause this to be deleted.
-    DocumentPtr *doc = document;
+    DocumentImpl *doc = m_document.get();
     doc->ref();
 
     // deref all nodes in chain
@@ -436,20 +432,20 @@
     EventImpl* const evt = new EventImpl(static_cast<EventImpl::EventId>(_id),canBubbleArg,cancelableArg);
     evt->setTarget( 0 );
     evt->ref();
-    DocumentPtr *doc = document;
+    DocumentImpl *doc = getDocument();
     doc->ref();
     dispatchGenericEvent( evt, exceptioncode );
-    if (!evt->defaultPrevented() && doc->document())
-	doc->document()->defaultEventHandler(evt);
+    if (!evt->defaultPrevented() && doc)
+	doc->defaultEventHandler(evt);
 
-    if (_id == EventImpl::LOAD_EVENT && !evt->propagationStopped() && doc->document()) {
+    if (_id == EventImpl::LOAD_EVENT && !evt->propagationStopped() && doc) {
         // For onload events, send them to the enclosing frame only.
         // This is a DOM extension and is independent of bubbling/capturing rules of
         // the DOM.  You send the event only to the enclosing frame.  It does not
         // bubble through the parent document.
-        DOM::ElementImpl* elt = doc->document()->ownerElement();
+        DOM::ElementImpl* elt = doc->ownerElement();
         if (elt && (elt->getDocument()->domain().isNull() ||
-                    elt->getDocument()->domain() == doc->document()->domain())) {
+                    elt->getDocument()->domain() == doc->domain())) {
             // We also do a security check, since we don't want to allow the enclosing
             // iframe to see loads of child documents in other domains.
             evt->setCurrentTarget(elt);
@@ -1852,10 +1848,10 @@
 
 // ----------------------------------------------------------------------------
 
-GenericRONamedNodeMapImpl::GenericRONamedNodeMapImpl(DocumentPtr* doc)
+GenericRONamedNodeMapImpl::GenericRONamedNodeMapImpl(DocumentImpl* doc)
     : NamedNodeMapImpl()
 {
-    m_doc = doc->document();
+    m_doc = doc;
     m_contents = new QPtrList<NodeImpl>;
 }
 
Index: khtml/xml/dom_elementimpl.cpp
===================================================================
--- khtml/xml/dom_elementimpl.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/xml/dom_elementimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -57,7 +57,7 @@
 using namespace DOM;
 using namespace khtml;
 
-AttrImpl::AttrImpl(ElementImpl* element, DocumentPtr* docPtr, NodeImpl::Id attrId,
+AttrImpl::AttrImpl(ElementImpl* element, DocumentImpl* docPtr, NodeImpl::Id attrId,
 		   DOMStringImpl *value, DOMStringImpl *prefix)
     : NodeBaseImpl(docPtr),
       m_element(element),
@@ -277,12 +277,12 @@
     }
 }
 
-AttrImpl *AttributeImpl::createAttr(ElementImpl *element, DocumentPtr *docPtr)
+AttrImpl *AttributeImpl::createAttr(ElementImpl *element, DocumentImpl *docPtr)
 {
     if (m_attrId) {
 	AttrImpl *attr = new AttrImpl(element,docPtr,m_attrId,m_data.value);
         if (!attr) return 0;
-        attr->setHTMLCompat( docPtr->document()->htmlMode() != DocumentImpl::XHtml );
+        attr->setHTMLCompat( docPtr->htmlMode() != DocumentImpl::XHtml );
 	m_data.value->deref();
 	m_data.attr = attr;
 	m_data.attr->ref();
@@ -305,7 +305,7 @@
 
 // -------------------------------------------------------------------------
 
-ElementImpl::ElementImpl(DocumentPtr *doc)
+ElementImpl::ElementImpl(DocumentImpl *doc)
     : NodeBaseImpl(doc)
 {
     namedAttrMap = 0;
@@ -883,14 +883,14 @@
 
 // -------------------------------------------------------------------------
 
-XMLElementImpl::XMLElementImpl(DocumentPtr *doc, NodeImpl::Id id)
+XMLElementImpl::XMLElementImpl(DocumentImpl *doc, NodeImpl::Id id)
     : ElementImpl(doc)
 {
     // Called from createElement(). In this case localName, prefix, and namespaceURI all need to be null.
     m_id = id;
 }
 
-XMLElementImpl::XMLElementImpl(DocumentPtr *doc, NodeImpl::Id id, DOMStringImpl *_prefix)
+XMLElementImpl::XMLElementImpl(DocumentImpl *doc, NodeImpl::Id id, DOMStringImpl *_prefix)
     : ElementImpl(doc)
 {
     // Called from createElementNS()
Index: khtml/xml/dom_textimpl.h
===================================================================
--- khtml/xml/dom_textimpl.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/xml/dom_textimpl.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -37,8 +37,8 @@
 class CharacterDataImpl : public NodeImpl
 {
 public:
-    CharacterDataImpl(DocumentPtr *doc, DOMStringImpl* _text);
-    CharacterDataImpl(DocumentPtr *doc)
+    CharacterDataImpl(DocumentImpl *doc, DOMStringImpl* _text);
+    CharacterDataImpl(DocumentImpl *doc)
         : NodeImpl(doc), str(0) {}
 
     virtual ~CharacterDataImpl();
@@ -83,9 +83,9 @@
 class CommentImpl : public CharacterDataImpl
 {
 public:
-    CommentImpl(DocumentPtr *doc, DOMStringImpl* _text)
+    CommentImpl(DocumentImpl *doc, DOMStringImpl* _text)
         : CharacterDataImpl(doc, _text) {}
-    CommentImpl(DocumentPtr *doc)
+    CommentImpl(DocumentImpl *doc)
         : CharacterDataImpl(doc) {}
     // DOM methods overridden from  parent classes
     virtual DOMString nodeName() const;
@@ -105,9 +105,9 @@
 class TextImpl : public CharacterDataImpl
 {
 public:
-    TextImpl(DocumentPtr *impl, DOMStringImpl* _text)
+    TextImpl(DocumentImpl *impl, DOMStringImpl* _text)
         : CharacterDataImpl(impl, _text) {}
-    TextImpl(DocumentPtr *impl)
+    TextImpl(DocumentImpl *impl)
         : CharacterDataImpl(impl) {}
 
     // DOM methods & attributes for CharacterData
@@ -147,9 +147,9 @@
 class CDATASectionImpl : public TextImpl
 {
 public:
-    CDATASectionImpl(DocumentPtr *impl, DOMStringImpl* _text)
+    CDATASectionImpl(DocumentImpl *impl, DOMStringImpl* _text)
         : TextImpl(impl, _text) {}
-    CDATASectionImpl(DocumentPtr *impl)
+    CDATASectionImpl(DocumentImpl *impl)
         : TextImpl(impl) {}
 
     // DOM methods overridden from  parent classes
Index: khtml/xml/dom_nodeimpl.h
===================================================================
--- khtml/xml/dom_nodeimpl.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/xml/dom_nodeimpl.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -58,18 +58,6 @@
 class RegisteredEventListener;
 class EventImpl;
 
-class DocumentPtr : public khtml::Shared<DocumentPtr>
-{
-public:
-    DocumentImpl *document() const { return doc; }
-private:
-    DocumentPtr() { doc = 0; }
-    friend class DocumentImpl;
-    friend class DOMImplementationImpl;
-
-    DocumentImpl *doc;
-};
-
 struct RegisteredListenerList {
     RegisteredListenerList() : listeners(0)
     {}
@@ -114,7 +102,7 @@
 {
     friend class DocumentImpl;
 public:
-    NodeImpl(DocumentPtr *doc);
+    NodeImpl(DocumentImpl *doc);
     virtual ~NodeImpl();
 
     // DOM methods & attributes for Node
@@ -272,7 +260,7 @@
     unsigned long nodeIndex() const;
     // Returns the document that this node is associated with. This is guaranteed to always be non-null, as opposed to
     // DOM's ownerDocument() which is null for Document nodes (and sometimes DocumentType nodes).
-    DocumentImpl* getDocument() const { return document->document(); }
+    DocumentImpl* getDocument() const { return m_document.get(); }
 
     void addEventListener(int id, EventListener *listener, const bool useCapture);
     void removeEventListener(int id, EventListener *listener, bool useCapture);
@@ -323,7 +311,7 @@
      */
     NodeImpl *traversePreviousNode() const;
 
-    DocumentPtr *docPtr() const { return document; }
+    DocumentImpl *docPtr() const { return m_document.get(); }
 
     khtml::RenderObject *renderer() const { return m_render; }
     khtml::RenderObject *nextRenderer();
@@ -447,10 +435,21 @@
      * @param found          When this is set to true, don't print anymore but closing tags.
      * @return An html formatted string for this node and its children between the selectionStart and selectionEnd.
      */
-    virtual DOMString selectionToString(NodeImpl * /*selectionStart*/, NodeImpl * /*selectionEnd*/, int /*startOffset*/, int /*endOffset*/, bool &/*found*/) const { return toString(); }
+    virtual DOMString selectionToString(NodeImpl * selectionStart, 
+                                        NodeImpl * selectionEnd, 
+                                        int startOffset, 
+                                        int endOffset, 
+                                        bool &found) const 
+    { Q_UNUSED(selectionStart);
+      Q_UNUSED(selectionEnd);
+      Q_UNUSED(startOffset);
+      Q_UNUSED(endOffset);
+      Q_UNUSED(found);
+      return toString(); 
+    }
 
 private: // members
-    DocumentPtr *document;
+    khtml::DocPtr<DocumentImpl> m_document;
     NodeImpl *m_previous;
     NodeImpl *m_next;
 protected:
@@ -483,7 +482,7 @@
 class NodeBaseImpl : public NodeImpl
 {
 public:
-    NodeBaseImpl(DocumentPtr *doc)
+    NodeBaseImpl(DocumentImpl *doc)
         : NodeImpl(doc), _first(0), _last(0) {}
     virtual ~NodeBaseImpl();
 
@@ -699,7 +698,7 @@
 class GenericRONamedNodeMapImpl : public NamedNodeMapImpl
 {
 public:
-    GenericRONamedNodeMapImpl(DocumentPtr* doc);
+    GenericRONamedNodeMapImpl(DocumentImpl* doc);
     virtual ~GenericRONamedNodeMapImpl();
 
     // DOM methods & attributes for NamedNodeMap
Index: khtml/xml/dom_elementimpl.h
===================================================================
--- khtml/xml/dom_elementimpl.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/xml/dom_elementimpl.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -53,7 +53,7 @@
     friend class NamedAttrMapImpl;
 
 public:
-    AttrImpl(ElementImpl* element, DocumentPtr* docPtr, NodeImpl::Id attrId,
+    AttrImpl(ElementImpl* element, DocumentImpl* docPtr, NodeImpl::Id attrId,
 	     DOMStringImpl *value, DOMStringImpl *prefix = 0);
     ~AttrImpl();
 
@@ -121,7 +121,7 @@
     DOMString name() { return m_attrId ? DOMString() : m_data.attr->name(); }
 
     void setValue(DOMStringImpl *value, ElementImpl *element);
-    AttrImpl *createAttr(ElementImpl *element, DocumentPtr *docPtr);
+    AttrImpl *createAttr(ElementImpl *element, DocumentImpl *docPtr);
     void free();
 
     NodeImpl::Id m_attrId;
@@ -139,7 +139,7 @@
     friend class NodeImpl;
     friend class khtml::CSSStyleSelector;
 public:
-    ElementImpl(DocumentPtr *doc);
+    ElementImpl(DocumentImpl *doc);
     ~ElementImpl();
 
     DOMString getAttribute( NodeImpl::Id id, bool nsAware = 0, const DOMString& qName = DOMString() ) const;
@@ -259,8 +259,8 @@
 {
 
 public:
-    XMLElementImpl(DocumentPtr *doc, NodeImpl::Id id);
-    XMLElementImpl(DocumentPtr *doc, NodeImpl::Id id, DOMStringImpl *_qualifiedName);
+    XMLElementImpl(DocumentImpl *doc, NodeImpl::Id id);
+    XMLElementImpl(DocumentImpl *doc, NodeImpl::Id id, DOMStringImpl *_qualifiedName);
     ~XMLElementImpl();
 
     // DOM methods overridden from  parent classes
Index: khtml/xml/dom_xmlimpl.cpp
===================================================================
--- khtml/xml/dom_xmlimpl.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/xml/dom_xmlimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -29,7 +29,7 @@
 
 using namespace DOM;
 
-EntityImpl::EntityImpl(DocumentPtr *doc) : NodeBaseImpl(doc)
+EntityImpl::EntityImpl(DocumentImpl *doc) : NodeBaseImpl(doc)
 {
     m_publicId = 0;
     m_systemId = 0;
@@ -37,7 +37,7 @@
     m_name = 0;
 }
 
-EntityImpl::EntityImpl(DocumentPtr *doc, DOMString _name) : NodeBaseImpl(doc)
+EntityImpl::EntityImpl(DocumentImpl *doc, DOMString _name) : NodeBaseImpl(doc)
 {
     m_publicId = 0;
     m_systemId = 0;
@@ -47,7 +47,7 @@
         m_name->ref();
 }
 
-EntityImpl::EntityImpl(DocumentPtr *doc, DOMString _publicId, DOMString _systemId, DOMString _notationName) : NodeBaseImpl(doc)
+EntityImpl::EntityImpl(DocumentImpl *doc, DOMString _publicId, DOMString _systemId, DOMString _notationName) : NodeBaseImpl(doc)
 {
     m_publicId = _publicId.implementation();
     if (m_publicId)
@@ -156,12 +156,12 @@
 
 // -------------------------------------------------------------------------
 
-EntityReferenceImpl::EntityReferenceImpl(DocumentPtr *doc) : NodeBaseImpl(doc)
+EntityReferenceImpl::EntityReferenceImpl(DocumentImpl *doc) : NodeBaseImpl(doc)
 {
     m_entityName = 0;
 }
 
-EntityReferenceImpl::EntityReferenceImpl(DocumentPtr *doc, DOMStringImpl *_entityName) : NodeBaseImpl(doc)
+EntityReferenceImpl::EntityReferenceImpl(DocumentImpl *doc, DOMStringImpl *_entityName) : NodeBaseImpl(doc)
 {
     m_entityName = _entityName;
     if (m_entityName)
@@ -222,14 +222,14 @@
 
 // -------------------------------------------------------------------------
 
-NotationImpl::NotationImpl(DocumentPtr *doc) : NodeBaseImpl(doc)
+NotationImpl::NotationImpl(DocumentImpl *doc) : NodeBaseImpl(doc)
 {
     m_publicId = 0;
     m_systemId = 0;
     m_name = 0;
 }
 
-NotationImpl::NotationImpl(DocumentPtr *doc, DOMString _name, DOMString _publicId, DOMString _systemId) : NodeBaseImpl(doc)
+NotationImpl::NotationImpl(DocumentImpl *doc, DOMString _name, DOMString _publicId, DOMString _systemId) : NodeBaseImpl(doc)
 {
     m_name = _name.implementation();
     if (m_name)
@@ -290,7 +290,7 @@
 // ### need a way of updating these properly whenever child nodes of the processing instruction
 // change or are added/removed
 
-ProcessingInstructionImpl::ProcessingInstructionImpl(DocumentPtr *doc) : NodeBaseImpl(doc)
+ProcessingInstructionImpl::ProcessingInstructionImpl(DocumentImpl *doc) : NodeBaseImpl(doc)
 {
     m_target = 0;
     m_data = 0;
@@ -299,7 +299,7 @@
     m_cachedSheet = 0;
 }
 
-ProcessingInstructionImpl::ProcessingInstructionImpl(DocumentPtr *doc, DOMString _target, DOMString _data) : NodeBaseImpl(doc)
+ProcessingInstructionImpl::ProcessingInstructionImpl(DocumentImpl *doc, DOMString _target, DOMString _data) : NodeBaseImpl(doc)
 {
     m_target = _target.implementation();
     if (m_target)
Index: khtml/xml/dom_docimpl.cpp
===================================================================
--- khtml/xml/dom_docimpl.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/xml/dom_docimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -290,10 +290,12 @@
 
 // KHTMLView might be 0
 DocumentImpl::DocumentImpl(DOMImplementationImpl *_implementation, KHTMLView *v)
-    : NodeBaseImpl( new DocumentPtr() ), m_domtree_version(0), m_counterDict(257),
+    : NodeBaseImpl( 0 ), m_domtree_version(0), m_counterDict(257),
       m_imageLoadEventTimer(0)
 {
-    document->doc = this;
+    m_document.resetSkippingRef(this); //Make getDocument return us..
+    m_selfOnlyRefCount = 0;
+
     m_paintDeviceMetrics = 0;
     m_paintDevice = 0;
     m_decoderMibEnum = 0;
@@ -319,7 +321,7 @@
 
     // ### this should be created during parsing a <!DOCTYPE>
     // not during construction. Not sure who added that and why (Dirk)
-    m_doctype = new DocumentTypeImpl(_implementation, document,
+    m_doctype = new DocumentTypeImpl(_implementation, getDocument(),
                                      DOMString() /* qualifiedName */,
                                      DOMString() /* publicId */,
                                      DOMString() /* systemId */);
@@ -365,8 +367,60 @@
     m_dynamicDomRestyler = new khtml::DynamicDomRestyler();
 }
 
+void DocumentImpl::removedLastRef()
+{
+    if (m_selfOnlyRefCount) {
+        /* In this case, the only references to us are from children,
+           so we have a cycle. We'll try to break it by disconnecting the
+           children from us; this sucks/is wrong, but it's pretty much 
+           the best we can do without tracing. 
+
+           Of course, if dumping the children causes the refcount from them to 
+           drop to 0 we can get killed right here, so better hold
+           a temporary reference, too
+        */
+        DocPtr<DocumentImpl> guard(this);
+
+        // we must make sure not to be retaining any of our children through
+        // these extra pointers or we will create a reference cycle
+        if (m_doctype) {
+            m_doctype->deref(); 
+            m_doctype = 0;
+        }
+        
+        if (m_cssTarget) {
+            m_cssTarget->deref();
+            m_cssTarget = 0;
+        }
+
+        if (m_focusNode) {
+            m_focusNode->deref();
+            m_focusNode = 0;
+        }
+
+        if (m_hoverNode) {
+            m_hoverNode->deref();
+            m_hoverNode = 0;
+        }
+        
+        if (m_activeNode) {
+            m_activeNode->deref();
+            m_activeNode = 0;
+        }
+
+        removeChildren();
+
+        delete m_tokenizer;
+        m_tokenizer = 0;
+    } else {
+        delete this;
+    }
+}
+
 DocumentImpl::~DocumentImpl()
 {
+    //Important: if you need to remove stuff here,
+    //you may also have to fix removedLastRef() above - M.O.
     assert( !m_render );
 
     QIntDictIterator<NodeListImpl::Cache> it(m_nodeListCache);
@@ -378,7 +432,7 @@
     if (changedDocuments && m_docChanged)
         changedDocuments->remove(this);
     delete m_tokenizer;
-    document->doc = 0;
+    m_document.resetSkippingRef(0);
     delete m_styleSelector;
     delete m_docLoader;
     if (m_elemSheet )  m_elemSheet->deref();
@@ -400,6 +454,8 @@
         m_focusNode->deref();
     if ( m_hoverNode )
         m_hoverNode->deref();
+    if (m_activeNode)
+        m_activeNode->deref();
 
     m_renderArena.reset();
 
@@ -433,7 +489,7 @@
     if ( pExceptioncode && *pExceptioncode )
         return 0;
 
-    XMLElementImpl* e = new XMLElementImpl( document, id );
+    XMLElementImpl* e = new XMLElementImpl( getDocument(), id );
     e->setHTMLCompat( htmlMode() != XHtml ); // Not a real HTML element, but inside an html-compat doc all tags are uppercase.
     return e;
 }
@@ -444,7 +500,7 @@
                   false /* allocate */, isHTMLDocument(), pExceptioncode);
     if ( pExceptioncode && *pExceptioncode )
         return 0;
-    AttrImpl* attr = new AttrImpl( 0, document, id, DOMString("").implementation());
+    AttrImpl* attr = new AttrImpl( 0, getDocument(), id, DOMString("").implementation());
     attr->setHTMLCompat( htmlMode() != XHtml );
     return attr;
 }
@@ -545,10 +601,12 @@
 	result = createComment(static_cast<CommentImpl*>(importedNode)->string());
 	deep = false;
     }
+    else if (importedNode->nodeType() == Node::DOCUMENT_FRAGMENT_NODE)
+	result = createDocumentFragment();
     else
 	exceptioncode = DOMException::NOT_SUPPORTED_ERR;
 	
-    //### FIXME: This should handle DocumentFragment, Attributes, and a few other things
+    //### FIXME: This should handle Attributes, and a few other things
 
     if(deep && result)
     {
@@ -589,7 +647,7 @@
     if (!e) {
         Id id = getId(NodeImpl::ElementId, _namespaceURI.implementation(), prefix.implementation(),
                       localName.implementation(), false, false /*HTML already looked up*/);
-        e = new XMLElementImpl( document, id, prefix.implementation() );
+        e = new XMLElementImpl( getDocument(), id, prefix.implementation() );
     }
 
     return e;
@@ -608,7 +666,7 @@
     splitPrefixLocalName(_qualifiedName.implementation(), prefix, localName, colonPos);
     Id id = getId(NodeImpl::AttributeId, _namespaceURI.implementation(), prefix.implementation(),
                   localName.implementation(), false, true /*lookupHTML*/);
-    AttrImpl* attr = new AttrImpl(0, document, id, DOMString("").implementation(),
+    AttrImpl* attr = new AttrImpl(0, getDocument(), id, DOMString("").implementation(),
                          prefix.implementation());
     attr->setHTMLCompat( _namespaceURI.isNull() && htmlMode() != XHtml );
     return attr;
@@ -2642,7 +2700,7 @@
 
 // ----------------------------------------------------------------------------
 
-DocumentFragmentImpl::DocumentFragmentImpl(DocumentPtr *doc) : NodeBaseImpl(doc)
+DocumentFragmentImpl::DocumentFragmentImpl(DocumentImpl *doc) : NodeBaseImpl(doc)
 {
 }
 
@@ -2700,7 +2758,7 @@
 
 // ----------------------------------------------------------------------------
 
-DocumentTypeImpl::DocumentTypeImpl(DOMImplementationImpl *implementation, DocumentPtr *doc,
+DocumentTypeImpl::DocumentTypeImpl(DOMImplementationImpl *implementation, DocumentImpl *doc,
                                    const DOMString &qualifiedName, const DOMString &publicId,
                                    const DOMString &systemId)
     : NodeImpl(doc), m_implementation(implementation),
Index: khtml/xml/dom_xmlimpl.h
===================================================================
--- khtml/xml/dom_xmlimpl.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/xml/dom_xmlimpl.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -42,9 +42,9 @@
 class EntityImpl : public NodeBaseImpl
 {
 public:
-    EntityImpl(DocumentPtr *doc);
-    EntityImpl(DocumentPtr *doc, DOMString _name);
-    EntityImpl(DocumentPtr *doc, DOMString _publicId, DOMString _systemId, DOMString _notationName);
+    EntityImpl(DocumentImpl *doc);
+    EntityImpl(DocumentImpl *doc, DOMString _name);
+    EntityImpl(DocumentImpl *doc, DOMString _publicId, DOMString _systemId, DOMString _notationName);
     virtual ~EntityImpl();
 
     // DOM methods & attributes for Entity
@@ -76,8 +76,8 @@
 class EntityReferenceImpl : public NodeBaseImpl
 {
 public:
-    EntityReferenceImpl(DocumentPtr *doc);
-    EntityReferenceImpl(DocumentPtr *doc, DOMStringImpl *_entityName);
+    EntityReferenceImpl(DocumentImpl *doc);
+    EntityReferenceImpl(DocumentImpl *doc, DOMStringImpl *_entityName);
     virtual ~EntityReferenceImpl();
 
     // DOM methods overridden from  parent classes
@@ -98,8 +98,8 @@
 class NotationImpl : public NodeBaseImpl
 {
 public:
-    NotationImpl(DocumentPtr *doc);
-    NotationImpl(DocumentPtr *doc, DOMString _name, DOMString _publicId, DOMString _systemId);
+    NotationImpl(DocumentImpl *doc);
+    NotationImpl(DocumentImpl *doc, DOMString _name, DOMString _publicId, DOMString _systemId);
     virtual ~NotationImpl();
 
     // DOM methods & attributes for Notation
@@ -126,8 +126,8 @@
 class ProcessingInstructionImpl : public NodeBaseImpl, private khtml::CachedObjectClient
 {
 public:
-    ProcessingInstructionImpl(DocumentPtr *doc);
-    ProcessingInstructionImpl(DocumentPtr *doc, DOMString _target, DOMString _data);
+    ProcessingInstructionImpl(DocumentImpl *doc);
+    ProcessingInstructionImpl(DocumentImpl *doc, DOMString _target, DOMString _data);
     virtual ~ProcessingInstructionImpl();
 
     // DOM methods & attributes for Notation
Index: khtml/xml/dom_stringimpl.cpp
===================================================================
--- khtml/xml/dom_stringimpl.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/xml/dom_stringimpl.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -87,7 +87,7 @@
     }
 }
 
-void DOMStringImpl::insert(DOMStringImpl *str, uint pos)
+void DOMStringImpl::insert(DOMStringImpl *str, unsigned int pos)
 {
     if(pos > l)
     {
@@ -119,7 +119,7 @@
     l = len;
 }
 
-void DOMStringImpl::remove(uint pos, int len)
+void DOMStringImpl::remove(unsigned int pos, int len)
 {
   if(pos >= l ) return;
   if(pos+len > l)
@@ -134,7 +134,7 @@
   l = newLen;
 }
 
-DOMStringImpl *DOMStringImpl::split(uint pos)
+DOMStringImpl *DOMStringImpl::split(unsigned int pos)
 {
   if( pos >=l ) return new DOMStringImpl();
 
@@ -144,7 +144,7 @@
   return str;
 }
 
-DOMStringImpl *DOMStringImpl::substring(uint pos, uint len)
+DOMStringImpl *DOMStringImpl::substring(unsigned int pos, unsigned int len)
 {
   if( pos >=l ) return new DOMStringImpl();
   if(pos+len > l)
Index: khtml/xml/xml_tokenizer.cpp
===================================================================
--- khtml/xml/xml_tokenizer.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/xml/xml_tokenizer.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -91,18 +91,16 @@
     m_finished = finished;
 }
 
-XMLHandler::XMLHandler(DocumentPtr *_doc, KHTMLView *_view)
+XMLHandler::XMLHandler(DocumentImpl *_doc, KHTMLView *_view)
     : errorLine(0)
 {
     m_doc = _doc;
-    if ( m_doc ) m_doc->ref();
     m_view = _view;
-    pushNode( _doc->document() );
+    pushNode( _doc );
 }
 
 XMLHandler::~XMLHandler()
 {
-    if ( m_doc ) m_doc->deref();
 }
 
 void XMLHandler::pushNode( NodeImpl *node )
@@ -176,7 +174,7 @@
     else
         // No namespace declared, default to the no namespace
         nsURI = DOMString("");
-    ElementImpl *newElement = m_doc->document()->createElementNS(nsURI,qName);
+    ElementImpl *newElement = m_doc->createElementNS(nsURI,qName);
     if (!newElement)
         return false;
     int i;
@@ -207,7 +205,7 @@
             break;
     }
     if (attached) {
-        if (m_view && !newElement->attached() && !m_doc->document()->hasPendingSheets())
+        if (m_view && !newElement->attached() && !m_doc->hasPendingSheets())
             newElement->attach();
         pushNode( newElement );
         return true;
@@ -245,9 +243,9 @@
     if (currentNode()->nodeType() == Node::TEXT_NODE)
         exitText();
 
-    NodeImpl *newNode = m_doc->document()->createCDATASection(new DOMStringImpl(""));
+    NodeImpl *newNode = m_doc->createCDATASection(new DOMStringImpl(""));
     if (currentNode()->addChild(newNode)) {
-        if (m_view && !newNode->attached() && !m_doc->document()->hasPendingSheets())
+        if (m_view && !newNode->attached() && !m_doc->hasPendingSheets())
             newNode->attach();
         pushNode( newNode );
         return true;
@@ -291,7 +289,7 @@
     if (currentNode()->nodeType() == Node::TEXT_NODE)
         exitText();
     // ### handle exceptions
-    currentNode()->addChild(m_doc->document()->createComment(new DOMStringImpl(ch.unicode(), ch.length())));
+    currentNode()->addChild(m_doc->createComment(new DOMStringImpl(ch.unicode(), ch.length())));
     return true;
 }
 
@@ -301,7 +299,7 @@
         exitText();
     // ### handle exceptions
     ProcessingInstructionImpl *pi =
-        m_doc->document()->createProcessingInstruction(target, new DOMStringImpl(data.unicode(), data.length()));
+        m_doc->createProcessingInstruction(target, new DOMStringImpl(data.unicode(), data.length()));
     currentNode()->addChild(pi);
     pi->checkStyleSheet();
     return true;
@@ -330,7 +328,7 @@
 
 bool XMLHandler::enterText()
 {
-    NodeImpl *newNode = m_doc->document()->createTextNode("");
+    NodeImpl *newNode = m_doc->createTextNode("");
     if (currentNode()->addChild(newNode)) {
         pushNode( newNode );
         return true;
@@ -343,7 +341,7 @@
 
 void XMLHandler::exitText()
 {
-    if ( m_view && !currentNode()->attached() && !m_doc->document()->hasPendingSheets() )
+    if ( m_view && !currentNode()->attached() && !m_doc->hasPendingSheets() )
         currentNode()->attach();
     popNode();
 }
@@ -366,9 +364,9 @@
 {
     EntityImpl *e = new EntityImpl(m_doc,name);
     // ### further parse entities inside the value and add them as separate nodes (or entityreferences)?
-    e->addChild(m_doc->document()->createTextNode(new DOMStringImpl(value.unicode(), value.length())));
-     if (m_doc->document()->doctype())
-         static_cast<GenericRONamedNodeMapImpl*>(m_doc->document()->doctype()->entities())->addNode(e);
+    e->addChild(m_doc->createTextNode(new DOMStringImpl(value.unicode(), value.length())));
+     if (m_doc->doctype())
+         static_cast<GenericRONamedNodeMapImpl*>(m_doc->doctype()->entities())->addNode(e);
     return true;
 }
 
@@ -392,11 +390,10 @@
 
 //------------------------------------------------------------------------------
 
-XMLTokenizer::XMLTokenizer(DOM::DocumentPtr *_doc, KHTMLView *_view)
+XMLTokenizer::XMLTokenizer(DOM::DocumentImpl *_doc, KHTMLView *_view)
     : m_handler(_doc,_view)
 {
     m_doc = _doc;
-    if ( m_doc ) m_doc->ref();
     m_view = _view;
     m_scriptsIt = 0;
     m_cachedScript = 0;
@@ -411,7 +408,6 @@
 
 XMLTokenizer::~XMLTokenizer()
 {
-    if (m_doc) m_doc->deref();
     if (m_scriptsIt)
         delete m_scriptsIt;
     if (m_cachedScript)
@@ -457,8 +453,8 @@
 
         // Clear the document
         int exceptioncode = 0;
-        while (m_doc->document()->hasChildNodes())
-            static_cast<NodeImpl*>(m_doc->document())->removeChild(m_doc->document()->firstChild(),exceptioncode);
+        while (m_doc->hasChildNodes())
+            static_cast<NodeImpl*>(m_doc)->removeChild(m_doc->firstChild(),exceptioncode);
 
         QString line, errorLocPtr;
         if ( m_handler.errorLine ) {
@@ -474,7 +470,7 @@
         }
 
         // Create elements for display
-        DocumentImpl *doc = m_doc->document();
+        DocumentImpl *doc = m_doc;
         NodeImpl *html = doc->createElementNS(XHTML_NAMESPACE,"html");
         NodeImpl   *body = doc->createElementNS(XHTML_NAMESPACE,"body");
         NodeImpl     *h1 = doc->createElementNS(XHTML_NAMESPACE,"h1");
@@ -512,15 +508,15 @@
         if ( pre ) pre->close();
         body->close();
 
-        m_doc->document()->recalcStyle( NodeImpl::Inherit );
-        m_doc->document()->updateRendering();
+        m_doc->recalcStyle( NodeImpl::Inherit );
+        m_doc->updateRendering();
 
         end();
     }
     else {
         // Parsing was successful. Now locate all html <script> tags in the document and execute them
         // one by one
-        addScripts(m_doc->document());
+        addScripts(m_doc);
         m_scriptsIt = new QPtrListIterator<HTMLScriptElementImpl>(m_scripts);
         executeScripts();
     }
@@ -553,7 +549,7 @@
 
         if (!scriptSrc.isEmpty()) {
             // we have a src attribute
-            m_cachedScript = m_doc->document()->docLoader()->requestScript(scriptSrc, charset);
+            m_cachedScript = m_doc->docLoader()->requestScript(scriptSrc, charset);
             ++(*m_scriptsIt);
             if (m_cachedScript) {
                 m_cachedScript->ref(this); // will call executeScripts() again if already cached
@@ -583,7 +579,7 @@
 
     // All scripts have finished executing, so calculate the style for the document and close
     // the last element
-    m_doc->document()->updateStyleSelector();
+    m_doc->updateStyleSelector();
 
     // We are now finished parsing
     end();
Index: khtml/xml/dom_docimpl.h
===================================================================
--- khtml/xml/dom_docimpl.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/xml/dom_docimpl.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -234,12 +234,12 @@
 
     /**
      * This method returns true if all top-level stylesheets have loaded (including
-     * any @imports that they may be loading).
+     * any \@imports that they may be loading).
      */
     bool haveStylesheetsLoaded() { return m_pendingStylesheets <= 0 || m_ignorePendingStylesheets; }
 
     /**
-     * Increments the number of pending sheets.  The <link> elements
+     * Increments the number of pending sheets.  The \<link\> elements
      * invoke this to add themselves to the loading list.
      */
     void addPendingSheet() { m_pendingStylesheets++; }
@@ -254,8 +254,8 @@
      * Called when one or more stylesheets in the document may have been added, removed or changed.
      *
      * Creates a new style selector and assign it to this document. This is done by iterating through all nodes in
-     * document (or those before <BODY> in a HTML document), searching for stylesheets. Stylesheets can be contained in
-     * <LINK>, <STYLE> or <BODY> elements, as well as processing instructions (XML documents only). A list is
+     * document (or those before \<BODY\> in a HTML document), searching for stylesheets. Stylesheets can be contained in
+     * \<LINK\>, \<STYLE\> or \<BODY\> elements, as well as processing instructions (XML documents only). A list is
      * constructed from these which is used to create the a new style selector which collates all of the stylesheets
      * found and is used to calculate the derived styles for all rendering objects.
      *
@@ -673,12 +673,29 @@
     khtml::SharedPtr<khtml::RenderArena> m_renderArena;
 private:
     mutable DOMString m_domain;
+    int m_selfOnlyRefCount;
+public:
+    // Nodes belonging to this document hold "self-only" references -
+    // these are enough to keep the document from being destroyed, but
+    // not enough to keep it from removing its children. This allows a
+    // node that outlives its document to still have a valid document
+    // pointer without introducing reference cycles
+
+    void selfOnlyRef() { ++m_selfOnlyRefCount; }
+    void selfOnlyDeref() {
+        --m_selfOnlyRefCount;
+        if (!m_selfOnlyRefCount && !refCount())
+            delete this;
+    }
+    
+    // This is called when our last outside reference dies
+    virtual void removedLastRef();
 };
 
 class DocumentFragmentImpl : public NodeBaseImpl
 {
 public:
-    DocumentFragmentImpl(DocumentPtr *doc);
+    DocumentFragmentImpl(DocumentImpl *doc);
     DocumentFragmentImpl(const DocumentFragmentImpl &other);
 
     // DOM methods overridden from  parent classes
@@ -696,7 +713,7 @@
 class DocumentTypeImpl : public NodeImpl
 {
 public:
-    DocumentTypeImpl(DOMImplementationImpl *_implementation, DocumentPtr *doc,
+    DocumentTypeImpl(DOMImplementationImpl *_implementation, DocumentImpl *doc,
                      const DOMString &qualifiedName, const DOMString &publicId,
                      const DOMString &systemId);
     ~DocumentTypeImpl();
Index: khtml/Makefile.am
===================================================================
--- khtml/Makefile.am	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ khtml/Makefile.am	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -125,7 +125,8 @@
 testregression_LDADD = libkhtml.la
 
 DOXYGEN_REFERENCES = kdecore kdeui kio kdefx kparts
-DOXYGEN_EXCLUDE =  test*.* html rendering xml misc pics test 
+DOXYGEN_EXCLUDE =  test*.* css ecma html java kmultipart misc pics rendering test xml
+
 include ../admin/Doxyfile.am
 
 .PHONY: parser
Index: kresources/resource.h
===================================================================
--- kresources/resource.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kresources/resource.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -389,9 +389,13 @@
     virtual ConfigWidget *configWidget( QWidget *parent ) = 0;
 
   protected:
-    virtual QObject* createObject( QObject *, const char *, const char *,
-                                   const QStringList & )
+    virtual QObject* createObject( QObject *parent, const char *name, const char *className,
+                                   const QStringList & args)
     {
+      Q_UNUSED(parent);
+      Q_UNUSED(name);
+      Q_UNUSED(className);
+      Q_UNUSED(args);
       return 0;
     }
 };
Index: kjs/operations.h
===================================================================
--- kjs/operations.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kjs/operations.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -55,6 +55,9 @@
   /**
    * Additive operator. Either performs an addition or substraction of v1
    * and v2.
+   * @param exec execution state.
+   * @param v1 First operand.
+   * @param v2 Second operand.
    * @param oper '+' or '-' for an addition or substraction, respectively.
    * @return The result of the operation.
    */
@@ -62,6 +65,9 @@
   /**
    * Multiplicative operator. Either multiplies/divides v1 and v2 or
    * calculates the remainder from an division.
+   * @param exec execution state.
+   * @param v1 First operand.
+   * @param v2 Second operand.
    * @param oper '*', '/' or '%' for a multiplication, division or
    * modulo operation.
    * @return The result of the operation.
Index: kjs/lookup.h
===================================================================
--- kjs/lookup.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kjs/lookup.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -160,10 +160,10 @@
    * unknown property).
    *
    * Template arguments:
-   * @param FuncImp the class which implements this object's functions
-   * @param ThisImp the class of "this". It must implement the getValueProperty(exec,token) method,
-   * for non-function properties.
-   * @param ParentImp the class of the parent, to propagate the lookup.
+   *   - @c FuncImp the class which implements this object's functions
+   *   - @c ThisImp the class of "this". It must implement the 
+   *        getValueProperty(exec,token) method, for non-function properties.
+   *   - @c ParentImp the class of the parent, to propagate the lookup.
    *
    * Method arguments:
    * @param exec execution state, as usual
Index: kdoctools/customization/pt-BR/entities/help-menu.docbook
===================================================================
--- kdoctools/customization/pt-BR/entities/help-menu.docbook	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kdoctools/customization/pt-BR/entities/help-menu.docbook	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -28,10 +28,10 @@
 <varlistentry>
 <term><menuchoice>
 <guimenu>Ajuda</guimenu>
-<guimenuitem>Reportar Erro...</guimenuitem>
+<guimenuitem>Relatar Falha...</guimenuitem>
 </menuchoice></term>
-<listitem><para><action>Abre a janela para Reportar Erros</action> onde pode 
-relatar um erro ou <quote>sugerir</quote> uma funcionalidade.</para></listitem>
+<listitem><para><action>Abre a janela para Reportar Falhas</action> onde você pode 
+relatar uma falha ou <quote>sugerir</quote> uma funcionalidade.</para></listitem>
 </varlistentry>
 
 <varlistentry>
@@ -39,7 +39,7 @@
 <guimenu>Ajuda</guimenu>
 <guimenuitem>Sobre o &kappname;</guimenuitem>
 </menuchoice></term>
-<listitem><para><action>Isto irá mostrar a versão e as informações do autor.</action></para></listitem>
+<listitem><para><action>Isto irá mostrar a versão da aplicação e as informações do autor.</action></para></listitem>
 </varlistentry>
 
 <varlistentry>
Index: kdoctools/customization/pt-BR/entities/install-intro.docbook
===================================================================
--- kdoctools/customization/pt-BR/entities/install-intro.docbook	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kdoctools/customization/pt-BR/entities/install-intro.docbook	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -1,4 +1,4 @@
 <!-- requires that packagename is defined in the documentation prologue -->
-<para>&kappname; faz parte do projeto &kde; &kde-http;.</para>
+<para>O &kappname; faz parte do projeto &kde; &kde-http;.</para>
 
-<para>&kappname; pode ser encontrado no pacote &package; no site &FTP; principal do projeto &kde; &kde-ftp;.</para>
+<para>O &kappname; pode ser encontrado no pacote &package; no servidor &FTP; principal do projeto &kde; &kde-ftp;.</para>
Index: kdeprint/tools/escputil/escpwidget.cpp
===================================================================
--- kdeprint/tools/escputil/escpwidget.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kdeprint/tools/escputil/escpwidget.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -39,8 +39,9 @@
 public:
 	EscpFactory(QObject *parent = 0, const char *name = 0) : KLibFactory(parent, name) {}
 protected:
-	QObject* createObject(QObject *parent = 0, const char *name = 0, const char * /*classname*/ = "QObject", const QStringList& args = QStringList())
+	QObject* createObject(QObject *parent = 0, const char *name = 0, const char * className = "QObject", const QStringList& args = QStringList())
 	{
+               Q_UNUSED(className);
 		KDialogBase	*dlg = new KDialogBase(static_cast<QWidget*>(parent), name, true, i18n("EPSON InkJet Printer Utilities"), KDialogBase::Close);
 		EscpWidget	*w = new EscpWidget(dlg);
 		if (args.count() > 0)
Index: kdeprint/cups/kmcupsmanager.cpp
===================================================================
--- kdeprint/cups/kmcupsmanager.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kdeprint/cups/kmcupsmanager.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -920,7 +920,7 @@
 	kdDebug(500) << "Checking for update possible" << endl;
 	delete m_socket;
         m_socket = new KNetwork::KBufferedSocket;
-	m_socket->setTimeout( 1 );
+	m_socket->setTimeout( 1500 );
 	connect( m_socket, SIGNAL( connected(const KResolverEntry&) ), 
                 SLOT( slotConnectionSuccess() ) );
 	connect( m_socket, SIGNAL( gotError( int ) ), SLOT( slotConnectionFailed( int ) ) );
@@ -958,7 +958,7 @@
 
 void KMCupsManager::slotAsyncConnect()
 {
-	kdDebug(500) << "Starting async connect" << endl;
+	kdDebug(500) << "Starting async connect to " << CupsInfos::self()->hostaddr() << endl;
 	//m_socket->startAsyncConnect();
         if (CupsInfos::self()->host().startsWith("/"))
             m_socket->connect( QString(), CupsInfos::self()->host());
Index: kdeprint/lpd/kmlpdfactory.h
===================================================================
--- kdeprint/lpd/kmlpdfactory.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kdeprint/lpd/kmlpdfactory.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -29,7 +29,7 @@
 	virtual ~KLpdFactory();
 
 protected:
-	QObject* createObject(QObject *parent = 0, const char *name = 0, const char *classname = "QObject", const QStringList& args = QStringList());
+	QObject* createObject(QObject *parent = 0, const char *name = 0, const char *className = "QObject", const QStringList& args = QStringList());
 };
 
 #endif
Index: kdeprint/tests/richpage.h
===================================================================
--- kdeprint/tests/richpage.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kdeprint/tests/richpage.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -12,8 +12,8 @@
 	RichPage(QWidget *parent = 0, const char *name = 0);
 	~RichPage();
 
-	void setOptions(const QMap<QString,QString>& options);
-	void getOptions(QMap<QString,QString>& options, bool incldef = false);
+	void setOptions(const QMap<QString,QString>& opts);
+	void getOptions(QMap<QString,QString>& opts, bool incldef = false);
 
 private:
 	QSpinBox	*margin_;
Index: kdeprint/management/kiconselectaction.h
===================================================================
--- kdeprint/management/kiconselectaction.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kdeprint/management/kiconselectaction.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -35,7 +35,7 @@
 
 public slots:
 	virtual void setItems(const QStringList& lst, const QStringList& iconlst);
-	virtual void setCurrentItem(int);
+	virtual void setCurrentItem(int index);
 
 protected:
 	void createPopupMenu();
Index: kdeprint/kpdriverpage.h
===================================================================
--- kdeprint/kpdriverpage.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kdeprint/kpdriverpage.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -30,7 +30,7 @@
 	KPDriverPage(KMPrinter *p, DrMain *d = 0, QWidget *parent = 0, const char *name = 0);
 	~KPDriverPage();
 
-	bool isValid(QString&);
+	bool isValid(QString& msg);
 	void setOptions(const QMap<QString,QString>& opts);
 	void getOptions(QMap<QString,QString>& opts, bool incldef = false);
 
Index: kdeui/kactionclasses.h
===================================================================
--- kdeui/kactionclasses.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kdeui/kactionclasses.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -940,7 +940,7 @@
         return currentText();
     }
 
-    int plug( QWidget*, int index = -1 );
+    int plug( QWidget*widget, int index = -1 );
 
 public slots:
     void setFont( const QString &family );
Index: kdeui/kactionshortcutlist.h
===================================================================
--- kdeui/kactionshortcutlist.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kdeui/kactionshortcutlist.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -16,13 +16,13 @@
 	virtual ~KActionShortcutList();
 
 	virtual uint count() const;
-	virtual QString name( uint i ) const;
-	virtual QString label( uint ) const;
-	virtual QString whatsThis( uint ) const;
-	virtual const KShortcut& shortcut( uint ) const;
-	virtual const KShortcut& shortcutDefault( uint ) const;
-	virtual bool isConfigurable( uint ) const;
-	virtual bool setShortcut( uint, const KShortcut& );
+	virtual QString name( uint index ) const;
+	virtual QString label( uint index ) const;
+	virtual QString whatsThis( uint index ) const;
+	virtual const KShortcut& shortcut( uint index ) const;
+	virtual const KShortcut& shortcutDefault( uint index ) const;
+	virtual bool isConfigurable( uint index ) const;
+	virtual bool setShortcut( uint index, const KShortcut& shortcut );
 
 	virtual const KInstance* instance() const;
 
@@ -54,13 +54,13 @@
 	virtual ~KActionPtrShortcutList();
 
 	virtual uint count() const;
-	virtual QString name( uint i ) const;
-	virtual QString label( uint ) const;
-	virtual QString whatsThis( uint ) const;
-	virtual const KShortcut& shortcut( uint ) const;
-	virtual const KShortcut& shortcutDefault( uint ) const;
-	virtual bool isConfigurable( uint ) const;
-	virtual bool setShortcut( uint, const KShortcut& );
+	virtual QString name( uint index ) const;
+	virtual QString label( uint index ) const;
+	virtual QString whatsThis( uint index ) const;
+	virtual const KShortcut& shortcut( uint index ) const;
+	virtual const KShortcut& shortcutDefault( uint index ) const;
+	virtual bool isConfigurable( uint index ) const;
+	virtual bool setShortcut( uint index, const KShortcut& shortcut);
 
 	virtual QVariant getOther( Other, uint index ) const;
 	virtual bool setOther( Other, uint index, QVariant );
Index: kdeui/kpanelappmenu.h
===================================================================
--- kdeui/kpanelappmenu.h	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kdeui/kpanelappmenu.h	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -80,7 +80,7 @@
      * @internal
      */
     bool process(const QCString &fun, const QByteArray &data,
-		 QCString &replyType, QByteArray &reply);
+		 QCString &replyType, QByteArray &replyData);
 
 signals:
     /**
Index: kdeui/kedittoolbar.cpp
===================================================================
--- kdeui/kedittoolbar.cpp	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ kdeui/kedittoolbar.cpp	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -208,7 +208,7 @@
 {
 public:
     /**
-     *
+     * @param instance The instance.
      * @param collection In a non-KParts application, this is the collection passed
      * to the KEditToolbar constructor.
      * In a KParts application we let create a KXMLGUIClient create a dummy one,
Index: libkmid/voiceman.cc
===================================================================
--- libkmid/voiceman.cc	(.../tags/KDE/3.5.5/kdelibs)	(revision 595981)
+++ libkmid/voiceman.cc	(.../branches/KDE/3.5/kdelibs)	(revision 595981)
@@ -83,11 +83,8 @@
   LastVoice=NULL;
   LastnotusedVoice=NULL;
 
-  if (VoiceList!=NULL) 
-  {
-    delete VoiceList;
-    VoiceList=NULL;
-  }
+  delete [] VoiceList;
+  VoiceList=NULL;
 
   delete searcher_aid;
 }

Property changes on: .
___________________________________________________________________
Name: svn:externals
   + admin https://svn.kde.org/home/kde/branches/KDE/3.5/kde-common/admin


